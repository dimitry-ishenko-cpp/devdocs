<h1>Lock your swarm to protect its encryption key</h1>

<p>The Raft logs used by swarm managers are encrypted on disk by default. This at-rest encryption protects your service’s configuration and data from attackers who gain access to the encrypted Raft logs. One of the reasons this feature was introduced was in support of the <a href="../secrets/index.html">Docker secrets</a> feature.</p> <p>When Docker restarts, both the TLS key used to encrypt communication among swarm nodes, and the key used to encrypt and decrypt Raft logs on disk, are loaded into each manager node’s memory. Docker has the ability to protect the mutual TLS encryption key and the key used to encrypt and decrypt Raft logs at rest, by allowing you to take ownership of these keys and to require manual unlocking of your managers. This feature is called <em>autolock</em>.</p> <p>When Docker restarts, you must <a href="#unlock-a-swarm">unlock the swarm</a> first, using a <em>key encryption key</em> generated by Docker when the swarm was locked. You can rotate this key encryption key at any time.</p> <blockquote> <p><strong>Note</strong>: You don’t need to unlock the swarm when a new node joins the swarm, because the key is propagated to it over mutual TLS.</p> </blockquote> <h2 id="initialize-a-swarm-with-autolocking-enabled">Initialize a swarm with autolocking enabled</h2> <p>When you initialize a new swarm, you can use the <code class="language-plaintext highlighter-rouge">--autolock</code> flag to enable autolocking of swarm manager nodes when Docker restarts.</p> <div class="highlight"><pre class="highlight" data-language="">$ docker swarm init --autolock

Swarm initialized: current node (k1q27tfyx9rncpixhk69sa61v) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join \
    --token SWMTKN-1-0j52ln6hxjpxk2wgk917abcnxywj3xed0y8vi1e5m9t3uttrtu-7bnxvvlz2mrcpfonjuztmtts9 \
    172.31.46.109:2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.

To unlock a swarm manager after it restarts, run the `docker swarm unlock`
command and provide the following key:

    SWMKEY-1-WuYH/IX284+lRcXuoVf38viIDK3HJEKY13MIHX+tTt8
</pre></div> <p>Store the key in a safe place, such as in a password manager.</p> <p>When Docker restarts, you need to <a href="#unlock-a-swarm">unlock the swarm</a>. A locked swarm causes an error like the following when you try to start or restart a service:</p> <div class="highlight"><pre class="highlight" data-language="">$ sudo service docker restart

$ docker service ls

Error response from daemon: Swarm is encrypted and needs to be unlocked before it can be used. Use "docker swarm unlock" to unlock it.
</pre></div> <h2 id="enable-or-disable-autolock-on-an-existing-swarm">Enable or disable autolock on an existing swarm</h2> <p>To enable autolock on an existing swarm, set the <code class="language-plaintext highlighter-rouge">autolock</code> flag to <code class="language-plaintext highlighter-rouge">true</code>.</p> <div class="highlight"><pre class="highlight" data-language="">$ docker swarm update --autolock=true

Swarm updated.
To unlock a swarm manager after it restarts, run the `docker swarm unlock`
command and provide the following key:

    SWMKEY-1-+MrE8NgAyKj5r3NcR4FiQMdgu+7W72urH0EZeSmP/0Y

Please remember to store this key in a password manager, since without it you
will not be able to restart the manager.
</pre></div> <p>To disable autolock, set <code class="language-plaintext highlighter-rouge">--autolock</code> to <code class="language-plaintext highlighter-rouge">false</code>. The mutual TLS key and the encryption key used to read and write Raft logs are stored unencrypted on disk. There is a trade-off between the risk of storing the encryption key unencrypted at rest and the convenience of restarting a swarm without needing to unlock each manager.</p> <div class="highlight"><pre class="highlight" data-language="">$ docker swarm update --autolock=false
</pre></div> <p>Keep the unlock key around for a short time after disabling autolocking, in case a manager goes down while it is still configured to lock using the old key.</p> <h2 id="unlock-a-swarm">Unlock a swarm</h2> <p>To unlock a locked swarm, use <code class="language-plaintext highlighter-rouge">docker swarm unlock</code>.</p> <div class="highlight"><pre class="highlight" data-language="">$ docker swarm unlock

Please enter unlock key:
</pre></div> <p>Enter the encryption key that was generated and shown in the command output when you locked the swarm or rotated the key, and the swarm unlocks.</p> <h2 id="view-the-current-unlock-key-for-a-running-swarm">View the current unlock key for a running swarm</h2> <p>Consider a situation where your swarm is running as expected, then a manager node becomes unavailable. You troubleshoot the problem and bring the physical node back online, but you need to unlock the manager by providing the unlock key to read the encrypted credentials and Raft logs.</p> <p>If the key has not been rotated since the node left the swarm, and you have a quorum of functional manager nodes in the swarm, you can view the current unlock key using <code class="language-plaintext highlighter-rouge">docker swarm unlock-key</code> without any arguments.</p> <div class="highlight"><pre class="highlight" data-language="">$ docker swarm unlock-key

To unlock a swarm manager after it restarts, run the `docker swarm unlock`
command and provide the following key:

    SWMKEY-1-8jDgbUNlJtUe5P/lcr9IXGVxqZpZUXPzd+qzcGp4ZYA

Please remember to store this key in a password manager, since without it you
will not be able to restart the manager.
</pre></div> <p>If the key was rotated after the swarm node became unavailable and you do not have a record of the previous key, you may need to force the manager to leave the swarm and join it back to the swarm as a new manager.</p> <h2 id="rotate-the-unlock-key">Rotate the unlock key</h2> <p>You should rotate the locked swarm’s unlock key on a regular schedule.</p> <div class="highlight"><pre class="highlight" data-language="">$ docker swarm unlock-key --rotate

Successfully rotated manager unlock key.

To unlock a swarm manager after it restarts, run the `docker swarm unlock`
command and provide the following key:

    SWMKEY-1-8jDgbUNlJtUe5P/lcr9IXGVxqZpZUXPzd+qzcGp4ZYA

Please remember to store this key in a password manager, since without it you
will not be able to restart the manager.
</pre></div> <blockquote class="warning"> <p><strong>Warning</strong>: When you rotate the unlock key, keep a record of the old key around for a few minutes, so that if a manager goes down before it gets the new key, it may still be unlocked with the old one.</p> </blockquote> 
<p><a href="https://docs.docker.com/search/?q=swarm">swarm</a>, <a href="https://docs.docker.com/search/?q=manager">manager</a>, <a href="https://docs.docker.com/search/?q=lock">lock</a>, <a href="https://docs.docker.com/search/?q=unlock">unlock</a>, <a href="https://docs.docker.com/search/?q=autolock">autolock</a>, <a href="https://docs.docker.com/search/?q=encryption">encryption</a></p>
<div class="_attribution">
  <p class="_attribution-p">
    &copy; 2019 Docker, Inc.<br>Licensed under the Apache License, Version 2.0.<br>Docker and the Docker logo are trademarks or registered trademarks of Docker, Inc. in the United States and/or other countries.<br>Docker, Inc. and other parties may also have trademark rights in other terms used herein.<br>
    <a href="https://docs.docker.com/engine/swarm/swarm_manager_locking/" class="_attribution-link">https://docs.docker.com/engine/swarm/swarm_manager_locking/</a>
  </p>
</div>
