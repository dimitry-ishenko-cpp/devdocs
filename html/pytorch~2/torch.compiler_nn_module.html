<h1 id="pytorch-2-0-nnmodule-support">PyTorch 2.0 NNModule Support</h1> <p><strong>Author</strong>: <a class="reference external" href="https://github.com/wconstab">Will Constable</a></p> <p><code>torch.compile</code> has special handling for torch.nn.Module objects, tracing them differently than it traces arbitrary python classes, with the intent of producing faster code by making assumptions about the structure.</p> <p>This doc describes some of the tradeoffs or edge cases that come up due to this specialization.</p>  <h2 id="nnmodule-hooks-support">NNModule Hooks Support</h2> <p>Previously, <code>torch.compile</code> had no support for hooks on nn.Modules, and if hooks were registered they would simply be ignored in the compiled program. Indeed many users do not use nn.Module hooks at all, or only use them for debug workflows, but there are valid use cases for composing nn.Module hooks with <code>torch.compile</code>.</p> <p>Hooks that are orchestrated via nn.Module.__call__ implementation include <code>_forward_pre_hooks</code>, <code>forward_hooks</code>, <code>_backward_pre_hooks</code>, and <code>_backward_hooks</code>, and will be referred to as ‘call hooks’. These hooks are partially supported by <code>torch.compile</code> with limitations described below.</p> <p>Another category of hooks includes <code>_state_dict_hooks</code> and its <code>pre</code> and <code>load_</code> variants, and are still unsupported by <code>torch.compile</code>.</p>  <h3 id="nn-module-call-hooks-usage-and-limitations">
<code>nn.Module.__call__</code> Hooks Usage and limitations</h3> <p>By default, <code>torch.compile</code> will trace the contents of <code>nn.Module.__call__</code> which means it will encounter and run forward/pre-forward hooks. If you install hooks before calling <code>torch.compile</code> and then do not remove or alter the hooks later, your use case should be supported by default.</p> <p>Backward/Pre-backward hooks are generally also supported, with similar caveats: currently graph-breaks in dynamo occur when accessing backward_hooks dicts, which is probably avoiable with some work. Graph-breaks also impact the timing of firing backward hooks, since graph-segments are run as autograd-functions which produce all their grads at the same time. Assuming it were possible for dynamo to not graph-break on the presence of backward-hooks, we would still expect the backward hooks for a series of modules to all fire together after the whole compiled graph’s backward ran.</p> <p><strong>hooks on ‘allowed modules’</strong> <code>torch.compile</code> treats common modules such as torch.conv, as well as modules that are difficult to trace, specially by allowing them to be called opaquely in the dynamo graph instead of traced into by dynamo. For such modules, hooks currently trigger a graph-break so that the affected modules run outside of dynamo. Depending on the model, this could introduce a significant performance regression, and additional work is required to improve this support.</p> <p><strong>skip_nnmodule_hook_guards</strong> By default, <code>torch._dynamo.config.skip_nnmodule_hook_guards</code> is set to True, meaning no guards will be installed on each nn.Module hook dictionary, improving runtime by reducing guard execution time, at the cost of not noticing if any hook dict is changed after compilation.</p> <p>If you want to be able to remove or modify hooks after compilation and have <code>torch.compile</code> react appropriately (by recompiling), then you need to set <code>skip_nnmodule_hook_guards=False</code> and expect a runtime penalty for the added guards.</p> <p>TODO: confirm if backward/pre_backward hooks are working or not and document accordingly</p>   <h3 id="state-dict-hooks">state_dict Hooks</h3> <p>State dict hooks have not yet been supported in <code>torch.compile</code>.</p> <p>TODO: warn_once if graph-breaking on hooks. warn_once to point to this doc if hooks are present.</p><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2024, PyTorch Contributors<br>PyTorch has a BSD-style license, as found in the <a href="https://github.com/pytorch/pytorch/blob/main/LICENSE">LICENSE</a> file.<br>
    <a href="https://pytorch.org/docs/2.1/torch.compiler_nn_module.html" class="_attribution-link">https://pytorch.org/docs/2.1/torch.compiler_nn_module.html</a>
  </p>
</div>
