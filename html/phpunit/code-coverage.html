<h1>Code Coverage</h1> <blockquote> <div>
<p><em>Wikipedia</em>:</p> <p>In computer science, code coverage is a measure used to describe the degree to which the source code of a program is tested by a particular test suite. A program with high code coverage has been more thoroughly tested and has a lower chance of containing software bugs than a program with low code coverage.</p> </div>
</blockquote> <p>In this chapter you will learn all about PHPUnit’s code coverage functionality that provides an insight into what parts of the production code are executed when the tests are run. It makes use of the <a class="reference external" href="https://github.com/sebastianbergmann/php-code-coverage">php-code-coverage</a> library, which in turn leverages the code coverage functionality provided by the <a class="reference external" href="https://github.com/krakjoe/pcov">PCOV</a> or <a class="reference external" href="https://xdebug.org/">Xdebug</a> extensions for PHP.</p> <div class="admonition-note admonition"> <p class="admonition-title">Note</p> <p>If you see a warning while running tests that no code coverage driver is available, it means that you are using the PHP CLI binary (<code class="docutils literal notranslate"><span class="pre">php</span></code>) and do not have PCOV or Xdebug loaded.</p> </div> <div class="admonition-note admonition"> <p class="admonition-title">Note</p> <p>When you want to use Xdebug for the collection of code coverage data then you have to activate Xdebug’s <a class="reference external" href="https://xdebug.org/docs/code_coverage#mode">coverage</a> mode.</p> </div> <p>PHPUnit can generate a code coverage report in HTML format as well as XML-based logfiles with code coverage information in various formats (Clover, Cobertura, Crap4J, PHPUnit). Code coverage information can also be reported as text (and printed to STDOUT) and exported as PHP code for further processing.</p> <p>Please refer to <a class="reference internal" href="textui.html#textui"><span class="std std-ref">The Command-Line Test Runner</span></a> for a list of command-line options that control code coverage functionality as well as <a class="reference internal" href="configuration.html#appendixes-configuration-source"><span class="std std-ref">The &lt;source&gt; Element</span></a> and <a class="reference internal" href="configuration.html#appendixes-configuration-coverage"><span class="std std-ref">The &lt;coverage&gt; Element</span></a> for the relevant configuration settings for reporting code coverage.</p> <section id="software-metrics-for-code-coverage"> <h2>Software Metrics for Code Coverage<a class="headerlink" href="#software-metrics-for-code-coverage" title="Permalink to this heading"></a>
</h2> <p>Various software metrics exist to measure code coverage:</p> <p><em>Line Coverage</em></p> <blockquote> <div>
<p>The <em>Line Coverage</em> software metric measures whether each executable line was executed.</p> </div>
</blockquote> <p><em>Branch Coverage</em></p> <blockquote> <div>
<p>The <em>Branch Coverage</em> software metric measures whether the boolean expression of each control structure evaluated to both <code class="docutils literal notranslate"><span class="pre">true</span></code> and <code class="docutils literal notranslate"><span class="pre">false</span></code> while running the test suite.</p> </div>
</blockquote> <p><em>Path Coverage</em></p> <blockquote> <div>
<p>The <em>Path Coverage</em> software metric measures whether each of the possible execution paths in a function or method has been followed while running the test suite. An execution path is a unique sequence of branches from the entry of the function or method to its exit.</p> </div>
</blockquote> <p><em>Function and Method Coverage</em></p> <blockquote> <div>
<p>The <em>Function and Method Coverage</em> software metric measures whether each function or method has been invoked. php-code-coverage only considers a function or method as covered when all of its executable lines are covered.</p> </div>
</blockquote> <p><em>Class and Trait Coverage</em></p> <blockquote> <div>
<p>The <em>Class and Trait Coverage</em> software metric measures whether each method of a class or trait is covered. php-code-coverage only considers a class or trait as covered when all of its methods are covered.</p> </div>
</blockquote> <p><em>Change Risk Anti-Patterns (CRAP) Index</em></p> <blockquote> <div>
<p>The <em>Change Risk Anti-Patterns (CRAP) Index</em> is calculated based on the cyclomatic complexity and code coverage of a unit of code. Code that is not too complex and has an adequate test coverage will have a low CRAP index. The CRAP index can be lowered by writing tests and by refactoring the code to lower its complexity.</p> </div>
</blockquote> <p>The library used by PHPUnit supports all code coverage software metrics listed above. To report branch coverage and path coverage, code coverage data has to be collected using Xdebug as PCOV only supports line coverage.</p> </section> <section id="including-files"> <h2>Including Files<a class="headerlink" href="#including-files" title="Permalink to this heading"></a>
</h2> <p>It is mandatory to configure which source code files you consider your own and therefore want to be included in the code coverage report. As other features of PHPUnit also need to know which source code files you consider your own, it is best practice to configure this in the XML configuration file (see <a class="reference internal" href="configuration.html#appendixes-configuration-source-include"><span class="std std-ref">The &lt;include&gt; Element</span></a>). Alternatively, you may use the <code class="docutils literal notranslate"><span class="pre">--coverage-filter</span></code> <a class="reference internal" href="textui.html#textui-command-line-options"><span class="std std-ref">command-line</span></a> option.</p> <p>The <code class="docutils literal notranslate"><span class="pre">includeUncoveredFiles</span></code> configuration setting is available to configure how the filter is used:</p> <ul class="simple"> <li><p><code class="docutils literal notranslate"><span class="pre">includeUncoveredFiles="true"</span></code> (default) means that all files are included in the code coverage report even if not a single line of code of such a file is executed</p></li> <li><p><code class="docutils literal notranslate"><span class="pre">includeUncoveredFiles="false"</span></code> means that only files that have at least one line of executed code are included in the code coverage report</p></li> </ul> <p>In order to get a complete and honest code coverage report, it is highly recommended to use the default setting.</p> </section> <section id="targeting-units-of-code"> <h2>Targeting Units of Code<a class="headerlink" href="#targeting-units-of-code" title="Permalink to this heading"></a>
</h2> <p>The <code class="docutils literal notranslate"><span class="pre">PHPUnit\Framework\Attributes\CoversClass</span></code>, <code class="docutils literal notranslate"><span class="pre">PHPUnit\Framework\Attributes\CoversMethod</span></code>, and <code class="docutils literal notranslate"><span class="pre">PHPUnit\Framework\Attributes\CoversFunction</span></code> attributes can be used in the test code to specify which units of code a test class intends to cover.</p> <p>When these attributes are used on a test case class, code coverage information is only collected for the listed units of code when the test methods of this test case class are executed.</p> <p><a class="reference internal" href="#code-coverage-targeting-units-of-code-examples-invoicetest-php"><span class="std std-numref">Example 7.1</span></a> shows an example.</p> <div class="literal-block-wrapper docutils container" id="code-coverage-targeting-units-of-code-examples-invoicetest-php"> <div class="code-block-caption">
<span class="caption-number">Example 7.1 </span><span class="caption-text">Test class that specifies which class it wants to cover</span><a class="headerlink" href="#code-coverage-targeting-units-of-code-examples-invoicetest-php" title="Permalink to this code"></a>
</div> <div class="highlight-php notranslate">
<div class="highlight"><pre class="highlight" data-language="php"><span class="o">&lt;?</span><span class="nx">php</span> <span class="k">declare</span><span class="p">(</span><span class="nx">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
<span class="k">use</span> <span class="nx">PHPUnit\Framework\Attributes\CoversClass</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">PHPUnit\Framework\Attributes\UsesClass</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">PHPUnit\Framework\TestCase</span><span class="p">;</span>

<span class="p">#[</span><span class="nd">CoversClass</span><span class="p">(</span><span class="nx">Invoice</span><span class="o">::</span><span class="na">class</span><span class="p">)]</span>
<span class="p">#[</span><span class="nd">UsesClass</span><span class="p">(</span><span class="nx">Money</span><span class="o">::</span><span class="na">class</span><span class="p">)]</span>
<span class="k">final</span> <span class="k">class</span> <span class="nc">InvoiceTest</span> <span class="k">extends</span> <span class="nx">TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testAmountInitiallyIsEmpty</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="k">new</span> <span class="nx">Money</span><span class="p">,</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Invoice</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">amount</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div> </div> </div> <p>The <code class="docutils literal notranslate"><span class="pre">PHPUnit\Framework\Attributes\UsesClass</span></code>, <code class="docutils literal notranslate"><span class="pre">PHPUnit\Framework\Attributes\UsesMethod</span></code>, and <code class="docutils literal notranslate"><span class="pre">PHPUnit\Framework\Attributes\UsesFunction</span></code> attributes can be used to specify units of code that should be ignored for code coverage, but which are allowed to be used by the code that is covered. This is explained in the section on <a class="reference internal" href="risky-tests.html#risky-tests-unintentionally-covered-code"><span class="std std-ref">unintentionally covered code</span></a>.</p> <p>In the example shown above, the <code class="docutils literal notranslate"><span class="pre">#[CoversClass(Invoice::class)]</span></code> attribute tells PHPUnit that the tests of this test case class intend to cover the code of the <code class="docutils literal notranslate"><span class="pre">Invoice</span></code> class. When the tests of this test case class are run, only code coverage information for the <code class="docutils literal notranslate"><span class="pre">Invoice</span></code> class will be processed and code coverage information for all other code that may also be run while these tests are running will be ignored.</p> <p>In the example shown above, the <code class="docutils literal notranslate"><span class="pre">#[UsesClass(Money::class)]</span></code> attribute tells PHPUnit that it is expected and allowed that code from the <code class="docutils literal notranslate"><span class="pre">Money</span></code> class is also run while the tests of this test case class are run. This is important when it comes to considering a test risky when it runs code that is not expected to be run.</p> <p>As it is technically not possible to test a subclass in isolation from its base class(es), the <code class="docutils literal notranslate"><span class="pre">#[CoversClass]</span></code> and <code class="docutils literal notranslate"><span class="pre">#[UsesClass]</span></code> attributes consider the class whose name has been specified as well as all of its parent classes, if it has any.</p> <p>The <code class="docutils literal notranslate"><span class="pre">PHPUnit\Framework\Attributes\CoversNothing</span></code> attribute can be used to specify that tests should not contribute to code coverage at all. This can be helpful when writing integration tests and to make sure you only generate code coverage with smaller tests.</p> <div class="literal-block-wrapper docutils container" id="code-coverage-targeting-units-of-code-examples-guestbookintegrationtest-php"> <div class="code-block-caption">
<span class="caption-number">Example 7.2 </span><span class="caption-text">A test that specifies that it does not want to contribute to code coverage</span><a class="headerlink" href="#code-coverage-targeting-units-of-code-examples-guestbookintegrationtest-php" title="Permalink to this code"></a>
</div> <div class="highlight-php notranslate">
<div class="highlight"><pre class="highlight" data-language="php"><span class="o">&lt;?</span><span class="nx">php</span> <span class="k">declare</span><span class="p">(</span><span class="nx">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
<span class="k">use</span> <span class="nx">PHPUnit\Framework\Attributes\CoversNothing</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">PHPUnit\Framework\TestCase</span><span class="p">;</span>

<span class="p">#[</span><span class="nd">CoversNothing</span><span class="p">]</span>
<span class="k">final</span> <span class="k">class</span> <span class="nc">IntegrationTest</span> <span class="k">extends</span> <span class="nx">TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testRegisteredUserCanLogIn</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div> </div> </div> </section> <section id="ignoring-code-blocks"> <h2>Ignoring Code Blocks<a class="headerlink" href="#ignoring-code-blocks" title="Permalink to this heading"></a>
</h2> <p>Sometimes you have units of code, or even just individual lines of code, that you cannot test and that you may want to ignore during code coverage analysis. PHPUnit lets you do this using the <code class="docutils literal notranslate"><span class="pre">@codeCoverageIgnore</span></code>, <code class="docutils literal notranslate"><span class="pre">@codeCoverageIgnoreStart</span></code>, and <code class="docutils literal notranslate"><span class="pre">@codeCoverageIgnoreEnd</span></code> annotations that can be used in code comments in production code:</p> <div class="literal-block-wrapper docutils container" id="code-coverage-ignoring-code-blocks-examples-example-php"> <div class="code-block-caption">
<span class="caption-number">Example 7.3 </span><span class="caption-text">Using the <code class="docutils literal notranslate"><span class="pre">@codeCoverageIgnore</span></code>, <code class="docutils literal notranslate"><span class="pre">@codeCoverageIgnoreStart</span></code>, and <code class="docutils literal notranslate"><span class="pre">@codeCoverageIgnoreEnd</span></code> annotations</span><a class="headerlink" href="#code-coverage-ignoring-code-blocks-examples-example-php" title="Permalink to this code"></a>
</div> <div class="highlight-php notranslate">
<div class="highlight"><pre class="highlight" data-language="php"><span class="o">&lt;?</span><span class="nx">php</span> <span class="k">declare</span><span class="p">(</span><span class="nx">strict_types</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
<span class="sd">/**</span>
<span class="sd"> * @codeCoverageIgnore</span>
<span class="sd"> */</span>
<span class="k">final</span> <span class="k">class</span> <span class="nc">Foo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">bar</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">final</span> <span class="k">class</span> <span class="nc">Bar</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @codeCoverageIgnore</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">foo</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// @codeCoverageIgnoreStart</span>
    <span class="k">print</span> <span class="s1">'*'</span><span class="p">;</span>
    <span class="c1">// @codeCoverageIgnoreEnd</span>
<span class="p">}</span>

<span class="k">exit</span><span class="p">;</span> <span class="c1">// @codeCoverageIgnore</span>
</pre></div> </div> </div> <p>In the example shown above, the <code class="docutils literal notranslate"><span class="pre">@codeCoverageIgnore</span></code> annotation is used to ignore all code of the <code class="docutils literal notranslate"><span class="pre">Foo</span></code> class, all code of the <code class="docutils literal notranslate"><span class="pre">Bar::foo()</span></code> method, and the single line of code with the <code class="docutils literal notranslate"><span class="pre">exit;</span></code> statement. The line with the <code class="docutils literal notranslate"><span class="pre">print</span> <span class="pre">'*';</span></code> statement is ignored using <code class="docutils literal notranslate"><span class="pre">//</span> <span class="pre">@codeCoverageIgnoreStart</span></code> and <code class="docutils literal notranslate"><span class="pre">//</span> <span class="pre">@codeCoverageIgnoreEnd</span></code>.</p> </section><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2005&ndash;2025 Sebastian Bergmann<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>
    <a href="https://docs.phpunit.de/en/12.0/code-coverage.html" class="_attribution-link">https://docs.phpunit.de/en/12.0/code-coverage.html</a>
  </p>
</div>
