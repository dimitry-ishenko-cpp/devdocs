<h1 id="image-feature-detection">Feature Detection</h1> <p>Wagtail has the ability to automatically detect faces and features inside your images and crop the images to those features.</p> <p>Feature detection uses third-party tools to detect faces/features in an image when the image is uploaded. The detected features are stored internally as a focal point in the <code>focal_point_{x, y, width, height}</code> fields on the <code>Image</code> model. These fields are used by the <code>fill</code> image filter when an image is rendered in a template to crop the image.</p> <section id="installation"> <h2>Installation</h2> <p>Two third-party tools are known to work with Wagtail: One based on <a class="reference external" href="https://opencv.org/">OpenCV</a> for general feature detection and one based on <a class="reference external" href="https://github.com/torchbox/rustface-py/">Rustface</a> for face detection.</p> <section id="opencv-on-debian-ubuntu"> <h3>OpenCV on Debian/Ubuntu</h3> <p>Feature detection requires <a class="reference external" href="https://opencv.org/">OpenCV</a> which can be a bit tricky to install as it’s not currently pip-installable.</p> <p>There is more than one way to install these components, but in each case you will need to test that both OpenCV itself <em>and</em> the Python interface have been correctly installed.</p> <section id="install-opencv-python"> <h4>Install <code>opencv-python</code>
</h4> <p><a class="reference external" href="https://pypi.org/project/opencv-python/">opencv-python</a> is available on PyPI. It includes a Python interface to OpenCV, as well as the statically-built OpenCV binaries themselves.</p> <p>To install:</p> <pre data-language="sh">pip install opencv-python
</pre> <p>Depending on what else is installed on your system, this may be all that is required. On lighter-weight Linux systems, you may need to identify and install missing system libraries (for example, a slim version of Debian Stretch requires <code>libsm6 libxrender1 libxext6</code> to be installed with <code>apt</code>).</p> </section> <section id="install-a-system-level-package"> <h4>Install a system-level package</h4> <p>A system-level package can take care of all of the required components. Check what is available for your operating system. For example, <a class="reference external" href="https://packages.debian.org/stretch/python-opencv">python-opencv</a> is available for Debian; it installs OpenCV itself, and sets up Python bindings.</p> <p>However, it may make incorrect assumptions about how you’re using Python (for example, which version you’re using) - test as described below.</p> </section> <section id="testing-the-installation"> <h4>Testing the installation</h4> <p>Test the installation:</p> <pre data-language="python">python3
&gt;&gt;&gt; import cv2
</pre> <p>An error such as:</p> <pre data-language="python">ImportError: libSM.so.6: cannot open shared object file: No such file or directory
</pre> <p>indicates that a required system library (in this case <code>libsm6</code>) has not been installed.</p> <p>On the other hand,</p> <pre data-language="python">ModuleNotFoundError: No module named 'cv2'
</pre> <p>means that the Python components have not been set up correctly in your Python environment.</p> <p>If you don’t get an import error, installation has probably been successful.</p> </section> </section> <section id="rustface"> <h3>Rustface</h3> <p><a class="reference external" href="https://github.com/torchbox/rustface-py/">Rustface</a> is Python library with prebuilt wheel files provided for Linux and macOS. Although implemented in Rust it is pip-installable:</p> <pre data-language="sh">pip install wheel
pip install rustface
</pre> <section id="registering-with-willow"> <h4>Registering with Willow</h4> <p>Rustface provides a plug-in that needs to be registered with <a class="reference external" href="https://github.com/wagtail/Willow">Willow</a>.</p> <p>This should be done somewhere that gets run on application startup:</p> <pre data-language="python">from willow.registry import registry
import rustface.willow

registry.register_plugin(rustface.willow)
</pre> <p>For example, in an app’s <a class="reference external" href="https://docs.djangoproject.com/en/2.2/ref/applications/#django.apps.AppConfig.ready">AppConfig.ready</a>.</p> </section> </section> </section> <section id="cropping"> <h2>Cropping</h2> <p>The face detection algorithm produces a focal area that is tightly cropped to the face rather than the whole head.</p> <p>For images with a single face this can be okay in some cases (thumbnails for example), it might be overly tight for “headshots”. Image renditions can encompass more of the head by reducing the crop percentage (<code>-c&lt;percentage&gt;</code>), at the end of the resize-rule, down to as low as 0%:</p> <pre data-language="markup">{% image page.photo fill-200x200-c0 %}
</pre> </section> <section id="switching-on-feature-detection-in-wagtail"> <h2>Switching on feature detection in Wagtail</h2> <p>Once installed, you need to set the <code>WAGTAILIMAGES_FEATURE_DETECTION_ENABLED</code> setting to <code>True</code> to automatically detect faces/features whenever a new image is uploaded in to Wagtail or when an image without a focal point is saved (this is done via a pre-save signal handler):</p> <pre data-language="python"># settings.py

WAGTAILIMAGES_FEATURE_DETECTION_ENABLED = True
</pre> </section> <section id="manually-running-feature-detection"> <h2>Manually running feature detection</h2> <p>If you already have images in your Wagtail site and would like to run feature detection on them, or you want to apply feature detection selectively when the <code>WAGTAILIMAGES_FEATURE_DETECTION_ENABLED</code> is set to <code>False</code> you can run it manually using the <code>get_suggested_focal_point()</code> method on the <code>Image</code> model.</p> <p>For example, you can manually run feature detection on all images by running the following code in the python shell:</p> <pre data-language="python">from wagtail.images import get_image_model

Image = get_image_model()

for image in Image.objects.all():
    if not image.has_focal_point():
        image.set_focal_point(image.get_suggested_focal_point())
        image.save()
</pre> </section><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2014-present Torchbox Ltd and individual contributors.<br>All rights are reserved.<br>Licensed under the BSD License.<br>
    <a href="https://docs.wagtail.org/en/stable/advanced_topics/images/feature_detection.html" class="_attribution-link">https://docs.wagtail.org/en/stable/advanced_topics/images/feature_detection.html</a>
  </p>
</div>
