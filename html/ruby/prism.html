<h1 id="module-Prism" class="anchor-link module"> module Prism </h1> <section class="description"> <p>The <a href="prism.html"><code>Prism</code></a> Ruby parser.</p> <p>“Parsing Ruby is suddenly manageable!”</p> <pre>- You, hopefully</pre> <p>This file is generated by the templates/template.rb script and should not be modified manually. See templates/lib/prism/compiler.rb.erb if you are looking to modify the template</p> <p>This file is generated by the templates/template.rb script and should not be modified manually. See templates/lib/prism/dispatcher.rb.erb if you are looking to modify the template</p> <p>This file is generated by the templates/template.rb script and should not be modified manually. See templates/lib/prism/dsl.rb.erb if you are looking to modify the template</p> <p>This file is generated by the templates/template.rb script and should not be modified manually. See templates/lib/prism/inspect_visitor.rb.erb if you are looking to modify the template</p> <p>This file is generated by the templates/template.rb script and should not be modified manually. See templates/lib/prism/mutation_compiler.rb.erb if you are looking to modify the template</p> <p>This file is generated by the templates/template.rb script and should not be modified manually. See templates/lib/prism/node.rb.erb if you are looking to modify the template</p> <p>Here we are reopening the prism module to provide methods on nodes that aren’t templated and are meant as convenience methods.</p> <p>typed: ignore</p> <p>This file is generated by the templates/template.rb script and should not be modified manually. See templates/lib/prism/reflection.rb.erb if you are looking to modify the template</p> <p>This file is generated by the templates/template.rb script and should not be modified manually. See templates/lib/prism/visitor.rb.erb if you are looking to modify the template</p> </section> <section id="5Buntitled-5D" class="documentation-section anchor-link"> <section class="constants-list"> <header> <h3>Constants</h3> </header> <dl> <dt id="BACKEND">BACKEND </dt>
<dd> <p>The C extension is the default backend on CRuby.</p> </dd>
<dt id="VERSION">VERSION </dt>
<dd> <p>The version constant is set by reading the result of calling pm_version.</p> </dd>
</dl> </section> <section id="public-class-5Buntitled-5D-method-details" class="method-section anchor-link"> <header> <h3>Public Class Methods</h3> </header> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-dump"> <a href="#method-c-dump" title="Link to this method"> <span class="method-name">dump</span> <span class="method-args">(source, **options)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="dump-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 229
def dump(source, **options)
  LibRubyParser::PrismString.with_string(source) { |string| dump_common(string, options) }
end</pre> </div>  <p>Mirror the <a href="prism.html#method-c-dump"><code>Prism.dump</code></a> API by using the serialization API.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-dump_file"> <a href="#method-c-dump_file" title="Link to this method"> <span class="method-name">dump_file</span> <span class="method-args">(filepath, **options)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="dump_file-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 234
def dump_file(filepath, **options)
  options[:filepath] = filepath
  LibRubyParser::PrismString.with_file(filepath) { |string| dump_common(string, options) }
end</pre> </div>  <p>Mirror the <a href="prism.html#method-c-dump_file"><code>Prism.dump_file</code></a> API by using the serialization API.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-lex"> <a href="#method-c-lex" title="Link to this method"> <span class="method-name">lex</span> <span class="method-args">(code, **options)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="lex-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 240
def lex(code, **options)
  LibRubyParser::PrismString.with_string(code) { |string| lex_common(string, code, options) }
end</pre> </div>  <p>Mirror the <a href="prism.html#method-c-lex"><code>Prism.lex</code></a> API by using the serialization API.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-lex_compat"> <a href="#method-c-lex_compat" title="Link to this method"> <span class="method-callseq"> Prism::lex_compat(source, **options) → LexCompat::Result </span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="lex_compat-source"> <pre class="ruby" data-language="ruby"># File lib/prism.rb, line 47
def self.lex_compat(source, **options)
  LexCompat.new(source, **options).result # steep:ignore
end</pre> </div>  <p>Returns a parse result whose value is an array of tokens that closely resembles the return value of <a href="ripper.html#method-c-lex"><code>Ripper::lex</code></a>. The main difference is that the ‘:on_sp` token is not emitted.</p> <p>For supported options, see <a href="prism.html#method-c-parse"><code>Prism::parse</code></a>.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-lex_file"> <a href="#method-c-lex_file" title="Link to this method"> <span class="method-name">lex_file</span> <span class="method-args">(filepath, **options)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="lex_file-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 245
def lex_file(filepath, **options)
  options[:filepath] = filepath
  LibRubyParser::PrismString.with_file(filepath) { |string| lex_common(string, string.read, options) }
end</pre> </div>  <p>Mirror the <a href="prism.html#method-c-lex_file"><code>Prism.lex_file</code></a> API by using the serialization API.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-lex_ripper"> <a href="#method-c-lex_ripper" title="Link to this method"> <span class="method-callseq"> Prism::lex_ripper(source) → Array </span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="lex_ripper-source"> <pre class="ruby" data-language="ruby"># File lib/prism.rb, line 57
def self.lex_ripper(source)
  LexRipper.new(source).result # steep:ignore
end</pre> </div>  <p>This lexes with the <a href="ripper.html"><code>Ripper</code></a> lex. It drops any space events but otherwise returns the same tokens. Raises <a href="syntaxerror.html"><code>SyntaxError</code></a> if the syntax in source is invalid.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-load"> <a href="#method-c-load" title="Link to this method"> <span class="method-callseq"> Prism::load(source, serialized) → ParseResult </span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="load-source"> <pre class="ruby" data-language="ruby"># File lib/prism.rb, line 65
def self.load(source, serialized)
  Serialize.load(source, serialized)
end</pre> </div>  <p>Load the serialized AST using the source as a reference into a tree.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-parse"> <a href="#method-c-parse" title="Link to this method"> <span class="method-name">parse</span> <span class="method-args">(code, **options)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="parse-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 251
def parse(code, **options)
  LibRubyParser::PrismString.with_string(code) { |string| parse_common(string, code, options) }
end</pre> </div>  <p>Mirror the <a href="prism.html#method-c-parse"><code>Prism.parse</code></a> API by using the serialization API.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-parse_comments"> <a href="#method-c-parse_comments" title="Link to this method"> <span class="method-name">parse_comments</span> <span class="method-args">(code, **options)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="parse_comments-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 287
def parse_comments(code, **options)
  LibRubyParser::PrismString.with_string(code) { |string| parse_comments_common(string, code, options) }
end</pre> </div>  <p>Mirror the <a href="prism.html#method-c-parse_comments"><code>Prism.parse_comments</code></a> API by using the serialization API.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-parse_failure-3F"> <a href="#method-c-parse_failure-3F" title="Link to this method"> <span class="method-name">parse_failure?</span> <span class="method-args">(code, **options)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="parse_failure-3F-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 316
def parse_failure?(code, **options)
  !parse_success?(code, **options)
end</pre> </div>  <p>Mirror the <a href="prism.html#method-c-parse_failure-3F"><code>Prism.parse_failure?</code></a> API by using the serialization API.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-parse_file"> <a href="#method-c-parse_file" title="Link to this method"> <span class="method-name">parse_file</span> <span class="method-args">(filepath, **options)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="parse_file-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 258
def parse_file(filepath, **options)
  options[:filepath] = filepath
  LibRubyParser::PrismString.with_file(filepath) { |string| parse_common(string, string.read, options) }
end</pre> </div>  <p>Mirror the <a href="prism.html#method-c-parse_file"><code>Prism.parse_file</code></a> API by using the serialization API. This uses native strings instead of Ruby strings because it allows us to use mmap when it is available.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-parse_file_comments"> <a href="#method-c-parse_file_comments" title="Link to this method"> <span class="method-name">parse_file_comments</span> <span class="method-args">(filepath, **options)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="parse_file_comments-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 294
def parse_file_comments(filepath, **options)
  options[:filepath] = filepath
  LibRubyParser::PrismString.with_file(filepath) { |string| parse_comments_common(string, string.read, options) }
end</pre> </div>  <p>Mirror the <a href="prism.html#method-c-parse_file_comments"><code>Prism.parse_file_comments</code></a> API by using the serialization API. This uses native strings instead of Ruby strings because it allows us to use mmap when it is available.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-parse_file_failure-3F"> <a href="#method-c-parse_file_failure-3F" title="Link to this method"> <span class="method-name">parse_file_failure?</span> <span class="method-args">(filepath, **options)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="parse_file_failure-3F-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 327
def parse_file_failure?(filepath, **options)
  !parse_file_success?(filepath, **options)
end</pre> </div>  <p>Mirror the <a href="prism.html#method-c-parse_file_failure-3F"><code>Prism.parse_file_failure?</code></a> API by using the serialization API.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-parse_file_success-3F"> <a href="#method-c-parse_file_success-3F" title="Link to this method"> <span class="method-name">parse_file_success?</span> <span class="method-args">(filepath, **options)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="parse_file_success-3F-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 321
def parse_file_success?(filepath, **options)
  options[:filepath] = filepath
  LibRubyParser::PrismString.with_file(filepath) { |string| parse_file_success_common(string, options) }
end</pre> </div>  <p>Mirror the <a href="prism.html#method-c-parse_file_success-3F"><code>Prism.parse_file_success?</code></a> API by using the serialization API.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-parse_lex"> <a href="#method-c-parse_lex" title="Link to this method"> <span class="method-name">parse_lex</span> <span class="method-args">(code, **options)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="parse_lex-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 300
def parse_lex(code, **options)
  LibRubyParser::PrismString.with_string(code) { |string| parse_lex_common(string, code, options) }
end</pre> </div>  <p>Mirror the <a href="prism.html#method-c-parse_lex"><code>Prism.parse_lex</code></a> API by using the serialization API.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-parse_lex_file"> <a href="#method-c-parse_lex_file" title="Link to this method"> <span class="method-name">parse_lex_file</span> <span class="method-args">(filepath, **options)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="parse_lex_file-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 305
def parse_lex_file(filepath, **options)
  options[:filepath] = filepath
  LibRubyParser::PrismString.with_file(filepath) { |string| parse_lex_common(string, string.read, options) }
end</pre> </div>  <p>Mirror the <a href="prism.html#method-c-parse_lex_file"><code>Prism.parse_lex_file</code></a> API by using the serialization API.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-parse_stream"> <a href="#method-c-parse_stream" title="Link to this method"> <span class="method-name">parse_stream</span> <span class="method-args">(stream, **options)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="parse_stream-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 264
def parse_stream(stream, **options)
  LibRubyParser::PrismBuffer.with do |buffer|
    source = +""
    callback = -&gt; (string, size, _) {
      raise "Expected size to be &gt;= 0, got: #{size}" if size &lt;= 0

      if !(line = stream.gets(size - 1)).nil?
        source &lt;&lt; line
        string.write_string("#{line}\x00", line.bytesize + 1)
      end
    }

    # In the pm_serialize_parse_stream function it accepts a pointer to the
    # IO object as a void* and then passes it through to the callback as the
    # third argument, but it never touches it itself. As such, since we have
    # access to the IO object already through the closure of the lambda, we
    # can pass a null pointer here and not worry.
    LibRubyParser.pm_serialize_parse_stream(buffer.pointer, nil, callback, dump_options(options))
    Prism.load(source, buffer.read)
  end
end</pre> </div>  <p>Mirror the <a href="prism.html#method-c-parse_stream"><code>Prism.parse_stream</code></a> API by using the serialization API.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-parse_success-3F"> <a href="#method-c-parse_success-3F" title="Link to this method"> <span class="method-name">parse_success?</span> <span class="method-args">(code, **options)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="parse_success-3F-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 311
def parse_success?(code, **options)
  LibRubyParser::PrismString.with_string(code) { |string| parse_file_success_common(string, options) }
end</pre> </div>  <p>Mirror the <a href="prism.html#method-c-parse_success-3F"><code>Prism.parse_success?</code></a> API by using the serialization API.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-profile"> <a href="#method-c-profile" title="Link to this method"> <span class="method-name">profile</span> <span class="method-args">(source, **options)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="profile-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 332
def profile(source, **options)
  LibRubyParser::PrismString.with_string(source) do |string|
    LibRubyParser::PrismBuffer.with do |buffer|
      LibRubyParser.pm_serialize_parse(buffer.pointer, string.pointer, string.length, dump_options(options))
      nil
    end
  end
end</pre> </div>  <p>Mirror the <a href="prism.html#method-c-profile"><code>Prism.profile</code></a> API by using the serialization API.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-profile_file"> <a href="#method-c-profile_file" title="Link to this method"> <span class="method-name">profile_file</span> <span class="method-args">(filepath, **options)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="profile_file-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 342
def profile_file(filepath, **options)
  LibRubyParser::PrismString.with_file(filepath) do |string|
    LibRubyParser::PrismBuffer.with do |buffer|
      options[:filepath] = filepath
      LibRubyParser.pm_serialize_parse(buffer.pointer, string.pointer, string.length, dump_options(options))
      nil
    end
  end
end</pre> </div>  <p>Mirror the <a href="prism.html#method-c-profile_file"><code>Prism.profile_file</code></a> API by using the serialization API.</p> </div> </div> </section> <section id="private-class-5Buntitled-5D-method-details" class="method-section anchor-link"> <header> <h3>Private Class Methods</h3> </header> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-dump_options"> <a href="#method-c-dump_options" title="Link to this method"> <span class="method-name">dump_options</span> <span class="method-args">(options)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="dump_options-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 441
def dump_options(options)
  template = +""
  values = []

  template &lt;&lt; "L"
  if (filepath = options[:filepath])
    values.push(filepath.bytesize, filepath.b)
    template &lt;&lt; "A*"
  else
    values &lt;&lt; 0
  end

  template &lt;&lt; "l"
  values &lt;&lt; options.fetch(:line, 1)

  template &lt;&lt; "L"
  if (encoding = options[:encoding])
    name = encoding.is_a?(Encoding) ? encoding.name : encoding
    values.push(name.bytesize, name.b)
    template &lt;&lt; "A*"
  else
    values &lt;&lt; 0
  end

  template &lt;&lt; "C"
  values &lt;&lt; (options.fetch(:frozen_string_literal, false) ? 1 : 0)

  template &lt;&lt; "C"
  values &lt;&lt; dump_options_command_line(options)

  template &lt;&lt; "C"
  values &lt;&lt; dump_options_version(options[:version])

  template &lt;&lt; "C"
  values &lt;&lt; (options[:encoding] == false ? 1 : 0)

  template &lt;&lt; "C"
  values &lt;&lt; (options.fetch(:main_script, false) ? 1 : 0)

  template &lt;&lt; "C"
  values &lt;&lt; (options.fetch(:partial_script, false) ? 1 : 0)

  template &lt;&lt; "L"
  if (scopes = options[:scopes])
    values &lt;&lt; scopes.length

    scopes.each do |scope|
      template &lt;&lt; "L"
      values &lt;&lt; scope.length

      scope.each do |local|
        name = local.name
        template &lt;&lt; "L"
        values &lt;&lt; name.bytesize

        template &lt;&lt; "A*"
        values &lt;&lt; name.b
      end
    end
  else
    values &lt;&lt; 0
  end

  values.pack(template)
end</pre> </div>  <p>Convert the given options into a serialized options string.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-dump_options_command_line"> <a href="#method-c-dump_options_command_line" title="Link to this method"> <span class="method-name">dump_options_command_line</span> <span class="method-args">(options)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="dump_options_command_line-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 409
def dump_options_command_line(options)
  command_line = options.fetch(:command_line, "")
  raise ArgumentError, "command_line must be a string" unless command_line.is_a?(String)

  command_line.each_char.inject(0) do |value, char|
    case char
    when "a" then value | 0b000001
    when "e" then value | 0b000010
    when "l" then value | 0b000100
    when "n" then value | 0b001000
    when "p" then value | 0b010000
    when "x" then value | 0b100000
    else raise ArgumentError, "invalid command_line option: #{char}"
    end
  end
end</pre> </div>  <p>Return the value that should be dumped for the command_line option.</p> </div> </div> <div class="method-detail anchor-link "> <div class="method-header"> <div class="method-heading" id="method-c-dump_options_version"> <a href="#method-c-dump_options_version" title="Link to this method"> <span class="method-name">dump_options_version</span> <span class="method-args">(version)</span> </a> </div> </div> <div class="method-controls"> <details class="method-source-toggle"> <summary>Source</summary> </details> </div> <div class="method-description">
<div class="method-source-code" id="dump_options_version-source"> <pre class="ruby" data-language="ruby"># File lib/prism/ffi.rb, line 427
def dump_options_version(version)
  case version
  when nil, "latest"
    0
  when /\A3\.3(\.\d+)?\z/
    1
  when /\A3\.4(\.\d+)?\z/
    0
  else
    raise ArgumentError, "invalid version: #{version}"
  end
end</pre> </div>  <p>Return the value that should be dumped for the version option.</p> </div> </div> </section> </section><div class="_attribution">
  <p class="_attribution-p">
    Ruby Core &copy; 1993&ndash;2024 Yukihiro Matsumoto<br>Licensed under the Ruby License.<br>Ruby Standard Library &copy; contributors<br>Licensed under their own licenses.<br>
    
  </p>
</div>
