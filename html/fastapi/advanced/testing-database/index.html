<h1 id="testing-a-database">Testing a Database</h1> <div class="admonition info"> <p class="admonition-title">Info</p> <p>These docs are about to be updated. ðŸŽ‰</p> <p>The current version assumes Pydantic v1, and SQLAlchemy versions less than 2.0.</p> <p>The new docs will include Pydantic v2 and will use <a href="https://sqlmodel.tiangolo.com/" class="external-link" target="_blank">SQLModel</a> (which is also based on SQLAlchemy) once it is updated to use Pydantic v2 as well.</p> </div> <p>You can use the same dependency overrides from <a class="internal-link" href="../testing-dependencies/index.html" target="_blank">Testing Dependencies with Overrides</a> to alter a database for testing.</p> <p>You could want to set up a different database for testing, rollback the data after the tests, pre-fill it with some testing data, etc.</p> <p>The main idea is exactly the same you saw in that previous chapter.</p> <h2 id="add-tests-for-the-sql-app">Add tests for the SQL app</h2> <p>Let's update the example from <a class="internal-link" href="../../tutorial/sql-databases/index.html" target="_blank">SQL (Relational) Databases</a> to use a testing database.</p> <p>All the app code is the same, you can go back to that chapter check how it was.</p> <p>The only changes here are in the new testing file.</p> <p>Your normal dependency <code>get_db()</code> would return a database session.</p> <p>In the test, you could use a dependency override to return your <em>custom</em> database session instead of the one that would be used normally.</p> <p>In this example we'll create a temporary database only for the tests.</p> <h2 id="file-structure">File structure</h2> <p>We create a new file at <code>sql_app/tests/test_sql_app.py</code>.</p> <p>So the new file structure looks like:</p> <div class="highlight"><pre class="language-python" data-language="python">.
â””â”€â”€ sql_app
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ crud.py
    â”œâ”€â”€ database.py
    â”œâ”€â”€ main.py
    â”œâ”€â”€ models.py
    â”œâ”€â”€ schemas.py
    â””â”€â”€ tests
        â”œâ”€â”€ __init__.py
        â””â”€â”€ test_sql_app.py
</pre></div> <h2 id="create-the-new-database-session">Create the new database session</h2> <p>First, we create a new database session with the new database.</p> <p>We'll use an in-memory database that persists during the tests instead of the local file <code>sql_app.db</code>.</p> <p>But the rest of the session code is more or less the same, we just copy it.</p> <div class="highlight"><pre class="language-python" data-language="python">from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import StaticPool

from ..database import Base
from ..main import app, get_db

SQLALCHEMY_DATABASE_URL = "sqlite://"

engine = create_engine(
    SQLALCHEMY_DATABASE_URL,
    connect_args={"check_same_thread": False},
    poolclass=StaticPool,
)
TestingSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)


Base.metadata.create_all(bind=engine)


def override_get_db():
    try:
        db = TestingSessionLocal()
        yield db
    finally:
        db.close()


app.dependency_overrides[get_db] = override_get_db

client = TestClient(app)


def test_create_user():
    response = client.post(
        "/users/",
        json={"email": "deadpool@example.com", "password": "chimichangas4life"},
    )
    assert response.status_code == 200, response.text
    data = response.json()
    assert data["email"] == "deadpool@example.com"
    assert "id" in data
    user_id = data["id"]

    response = client.get(f"/users/{user_id}")
    assert response.status_code == 200, response.text
    data = response.json()
    assert data["email"] == "deadpool@example.com"
    assert data["id"] == user_id
</pre></div> <div class="admonition tip"> <p class="admonition-title">Tip</p> <p>You could reduce duplication in that code by putting it in a function and using it from both <code>database.py</code> and <code>tests/test_sql_app.py</code>.</p> <p>For simplicity and to focus on the specific testing code, we are just copying it.</p> </div> <h2 id="create-the-database">Create the database</h2> <p>Because now we are going to use a new database in a new file, we need to make sure we create the database with:</p> <div class="highlight"><pre class="language-python" data-language="python">Base.metadata.create_all(bind=engine)
</pre></div> <p>That is normally called in <code>main.py</code>, but the line in <code>main.py</code> uses the database file <code>sql_app.db</code>, and we need to make sure we create <code>test.db</code> for the tests.</p> <p>So we add that line here, with the new file.</p> <div class="highlight"><pre class="language-python" data-language="python">from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import StaticPool

from ..database import Base
from ..main import app, get_db

SQLALCHEMY_DATABASE_URL = "sqlite://"

engine = create_engine(
    SQLALCHEMY_DATABASE_URL,
    connect_args={"check_same_thread": False},
    poolclass=StaticPool,
)
TestingSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)


Base.metadata.create_all(bind=engine)


def override_get_db():
    try:
        db = TestingSessionLocal()
        yield db
    finally:
        db.close()


app.dependency_overrides[get_db] = override_get_db

client = TestClient(app)


def test_create_user():
    response = client.post(
        "/users/",
        json={"email": "deadpool@example.com", "password": "chimichangas4life"},
    )
    assert response.status_code == 200, response.text
    data = response.json()
    assert data["email"] == "deadpool@example.com"
    assert "id" in data
    user_id = data["id"]

    response = client.get(f"/users/{user_id}")
    assert response.status_code == 200, response.text
    data = response.json()
    assert data["email"] == "deadpool@example.com"
    assert data["id"] == user_id
</pre></div> <h2 id="dependency-override">Dependency override</h2> <p>Now we create the dependency override and add it to the overrides for our app.</p> <div class="highlight"><pre class="language-python" data-language="python">from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import StaticPool

from ..database import Base
from ..main import app, get_db

SQLALCHEMY_DATABASE_URL = "sqlite://"

engine = create_engine(
    SQLALCHEMY_DATABASE_URL,
    connect_args={"check_same_thread": False},
    poolclass=StaticPool,
)
TestingSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)


Base.metadata.create_all(bind=engine)


def override_get_db():
    try:
        db = TestingSessionLocal()
        yield db
    finally:
        db.close()


app.dependency_overrides[get_db] = override_get_db

client = TestClient(app)


def test_create_user():
    response = client.post(
        "/users/",
        json={"email": "deadpool@example.com", "password": "chimichangas4life"},
    )
    assert response.status_code == 200, response.text
    data = response.json()
    assert data["email"] == "deadpool@example.com"
    assert "id" in data
    user_id = data["id"]

    response = client.get(f"/users/{user_id}")
    assert response.status_code == 200, response.text
    data = response.json()
    assert data["email"] == "deadpool@example.com"
    assert data["id"] == user_id
</pre></div> <div class="admonition tip"> <p class="admonition-title">Tip</p> <p>The code for <code>override_get_db()</code> is almost exactly the same as for <code>get_db()</code>, but in <code>override_get_db()</code> we use the <code>TestingSessionLocal</code> for the testing database instead.</p> </div> <h2 id="test-the-app">Test the app</h2> <p>Then we can just test the app as normally.</p> <div class="highlight"><pre class="language-python" data-language="python">from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import StaticPool

from ..database import Base
from ..main import app, get_db

SQLALCHEMY_DATABASE_URL = "sqlite://"

engine = create_engine(
    SQLALCHEMY_DATABASE_URL,
    connect_args={"check_same_thread": False},
    poolclass=StaticPool,
)
TestingSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)


Base.metadata.create_all(bind=engine)


def override_get_db():
    try:
        db = TestingSessionLocal()
        yield db
    finally:
        db.close()


app.dependency_overrides[get_db] = override_get_db

client = TestClient(app)


def test_create_user():
    response = client.post(
        "/users/",
        json={"email": "deadpool@example.com", "password": "chimichangas4life"},
    )
    assert response.status_code == 200, response.text
    data = response.json()
    assert data["email"] == "deadpool@example.com"
    assert "id" in data
    user_id = data["id"]

    response = client.get(f"/users/{user_id}")
    assert response.status_code == 200, response.text
    data = response.json()
    assert data["email"] == "deadpool@example.com"
    assert data["id"] == user_id
</pre></div> <p>And all the modifications we made in the database during the tests will be in the <code>test.db</code> database instead of the main <code>sql_app.db</code>.</p><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2018 SebastiÃ¡n RamÃ­rez<br>Licensed under the MIT License.<br>
    <a href="https://fastapi.tiangolo.com/advanced/testing-database/" class="_attribution-link">https://fastapi.tiangolo.com/advanced/testing-database/</a>
  </p>
</div>
