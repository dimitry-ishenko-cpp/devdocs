<h1 id="testing-dependencies-with-overrides">Testing Dependencies with Overrides</h1> <h2 id="overriding-dependencies-during-testing">Overriding dependencies during testing</h2> <p>There are some scenarios where you might want to override a dependency during testing.</p> <p>You don't want the original dependency to run (nor any of the sub-dependencies it might have).</p> <p>Instead, you want to provide a different dependency that will be used only during tests (possibly only some specific tests), and will provide a value that can be used where the value of the original dependency was used.</p> <h3 id="use-cases-external-service">Use cases: external service</h3> <p>An example could be that you have an external authentication provider that you need to call.</p> <p>You send it a token and it returns an authenticated user.</p> <p>This provider might be charging you per request, and calling it might take some extra time than if you had a fixed mock user for tests.</p> <p>You probably want to test the external provider once, but not necessarily call it for every test that runs.</p> <p>In this case, you can override the dependency that calls that provider, and use a custom dependency that returns a mock user, only for your tests.</p> <h3 id="use-the-appdependency_overrides-attribute">Use the <code>app.dependency_overrides</code> attribute</h3> <p>For these cases, your <strong>FastAPI</strong> application has an attribute <code>app.dependency_overrides</code>, it is a simple <code>dict</code>.</p> <p>To override a dependency for testing, you put as a key the original dependency (a function), and as the value, your dependency override (another function).</p> <p>And then <strong>FastAPI</strong> will call that override instead of the original dependency.</p> <div class="tabbed-set tabbed-alternate" data-tabs="1:1"> <div class="tabbed-content"> <div class="tabbed-block">
<label for="__tabbed_1_1">Python 3.10+</label> <div class="highlight"><pre class="language-python" data-language="python">from typing import Annotated

from fastapi import Depends, FastAPI
from fastapi.testclient import TestClient

app = FastAPI()


async def common_parameters(q: str | None = None, skip: int = 0, limit: int = 100):
    return {"q": q, "skip": skip, "limit": limit}


@app.get("/items/")
async def read_items(commons: Annotated[dict, Depends(common_parameters)]):
    return {"message": "Hello Items!", "params": commons}


@app.get("/users/")
async def read_users(commons: Annotated[dict, Depends(common_parameters)]):
    return {"message": "Hello Users!", "params": commons}


client = TestClient(app)


async def override_dependency(q: str | None = None):
    return {"q": q, "skip": 5, "limit": 10}


app.dependency_overrides[common_parameters] = override_dependency


def test_override_in_items():
    response = client.get("/items/")
    assert response.status_code == 200
    assert response.json() == {
        "message": "Hello Items!",
        "params": {"q": None, "skip": 5, "limit": 10},
    }


def test_override_in_items_with_q():
    response = client.get("/items/?q=foo")
    assert response.status_code == 200
    assert response.json() == {
        "message": "Hello Items!",
        "params": {"q": "foo", "skip": 5, "limit": 10},
    }


def test_override_in_items_with_params():
    response = client.get("/items/?q=foo&amp;skip=100&amp;limit=200")
    assert response.status_code == 200
    assert response.json() == {
        "message": "Hello Items!",
        "params": {"q": "foo", "skip": 5, "limit": 10},
    }
</pre></div> </div> </div> </div> <details> <summary>ðŸ¤“ Other versions and variants</summary> <div class="tabbed-set tabbed-alternate" data-tabs="2:4"> <div class="tabbed-content"> <div class="tabbed-block">
<label for="__tabbed_2_1">Python 3.9+</label> <div class="highlight"><pre class="language-python" data-language="python">from typing import Annotated, Union

from fastapi import Depends, FastAPI
from fastapi.testclient import TestClient

app = FastAPI()


async def common_parameters(
    q: Union[str, None] = None, skip: int = 0, limit: int = 100
):
    return {"q": q, "skip": skip, "limit": limit}


@app.get("/items/")
async def read_items(commons: Annotated[dict, Depends(common_parameters)]):
    return {"message": "Hello Items!", "params": commons}


@app.get("/users/")
async def read_users(commons: Annotated[dict, Depends(common_parameters)]):
    return {"message": "Hello Users!", "params": commons}


client = TestClient(app)


async def override_dependency(q: Union[str, None] = None):
    return {"q": q, "skip": 5, "limit": 10}


app.dependency_overrides[common_parameters] = override_dependency


def test_override_in_items():
    response = client.get("/items/")
    assert response.status_code == 200
    assert response.json() == {
        "message": "Hello Items!",
        "params": {"q": None, "skip": 5, "limit": 10},
    }


def test_override_in_items_with_q():
    response = client.get("/items/?q=foo")
    assert response.status_code == 200
    assert response.json() == {
        "message": "Hello Items!",
        "params": {"q": "foo", "skip": 5, "limit": 10},
    }


def test_override_in_items_with_params():
    response = client.get("/items/?q=foo&amp;skip=100&amp;limit=200")
    assert response.status_code == 200
    assert response.json() == {
        "message": "Hello Items!",
        "params": {"q": "foo", "skip": 5, "limit": 10},
    }
</pre></div> </div> <div class="tabbed-block">
<label for="__tabbed_2_2">Python 3.8+</label> <div class="highlight"><pre class="language-python" data-language="python">from typing import Union

from fastapi import Depends, FastAPI
from fastapi.testclient import TestClient
from typing_extensions import Annotated

app = FastAPI()


async def common_parameters(
    q: Union[str, None] = None, skip: int = 0, limit: int = 100
):
    return {"q": q, "skip": skip, "limit": limit}


@app.get("/items/")
async def read_items(commons: Annotated[dict, Depends(common_parameters)]):
    return {"message": "Hello Items!", "params": commons}


@app.get("/users/")
async def read_users(commons: Annotated[dict, Depends(common_parameters)]):
    return {"message": "Hello Users!", "params": commons}


client = TestClient(app)


async def override_dependency(q: Union[str, None] = None):
    return {"q": q, "skip": 5, "limit": 10}


app.dependency_overrides[common_parameters] = override_dependency


def test_override_in_items():
    response = client.get("/items/")
    assert response.status_code == 200
    assert response.json() == {
        "message": "Hello Items!",
        "params": {"q": None, "skip": 5, "limit": 10},
    }


def test_override_in_items_with_q():
    response = client.get("/items/?q=foo")
    assert response.status_code == 200
    assert response.json() == {
        "message": "Hello Items!",
        "params": {"q": "foo", "skip": 5, "limit": 10},
    }


def test_override_in_items_with_params():
    response = client.get("/items/?q=foo&amp;skip=100&amp;limit=200")
    assert response.status_code == 200
    assert response.json() == {
        "message": "Hello Items!",
        "params": {"q": "foo", "skip": 5, "limit": 10},
    }
</pre></div> </div> <div class="tabbed-block">
<label for="__tabbed_2_3">Python 3.10+ - non-Annotated</label> <div class="admonition tip"> <p class="admonition-title">Tip</p> <p>Prefer to use the <code>Annotated</code> version if possible.</p> </div> <div class="highlight"><pre class="language-python" data-language="python">from fastapi import Depends, FastAPI
from fastapi.testclient import TestClient

app = FastAPI()


async def common_parameters(q: str | None = None, skip: int = 0, limit: int = 100):
    return {"q": q, "skip": skip, "limit": limit}


@app.get("/items/")
async def read_items(commons: dict = Depends(common_parameters)):
    return {"message": "Hello Items!", "params": commons}


@app.get("/users/")
async def read_users(commons: dict = Depends(common_parameters)):
    return {"message": "Hello Users!", "params": commons}


client = TestClient(app)


async def override_dependency(q: str | None = None):
    return {"q": q, "skip": 5, "limit": 10}


app.dependency_overrides[common_parameters] = override_dependency


def test_override_in_items():
    response = client.get("/items/")
    assert response.status_code == 200
    assert response.json() == {
        "message": "Hello Items!",
        "params": {"q": None, "skip": 5, "limit": 10},
    }


def test_override_in_items_with_q():
    response = client.get("/items/?q=foo")
    assert response.status_code == 200
    assert response.json() == {
        "message": "Hello Items!",
        "params": {"q": "foo", "skip": 5, "limit": 10},
    }


def test_override_in_items_with_params():
    response = client.get("/items/?q=foo&amp;skip=100&amp;limit=200")
    assert response.status_code == 200
    assert response.json() == {
        "message": "Hello Items!",
        "params": {"q": "foo", "skip": 5, "limit": 10},
    }
</pre></div> </div> <div class="tabbed-block">
<label for="__tabbed_2_4">Python 3.8+ - non-Annotated</label> <div class="admonition tip"> <p class="admonition-title">Tip</p> <p>Prefer to use the <code>Annotated</code> version if possible.</p> </div> <div class="highlight"><pre class="language-python" data-language="python">from typing import Union

from fastapi import Depends, FastAPI
from fastapi.testclient import TestClient

app = FastAPI()


async def common_parameters(
    q: Union[str, None] = None, skip: int = 0, limit: int = 100
):
    return {"q": q, "skip": skip, "limit": limit}


@app.get("/items/")
async def read_items(commons: dict = Depends(common_parameters)):
    return {"message": "Hello Items!", "params": commons}


@app.get("/users/")
async def read_users(commons: dict = Depends(common_parameters)):
    return {"message": "Hello Users!", "params": commons}


client = TestClient(app)


async def override_dependency(q: Union[str, None] = None):
    return {"q": q, "skip": 5, "limit": 10}


app.dependency_overrides[common_parameters] = override_dependency


def test_override_in_items():
    response = client.get("/items/")
    assert response.status_code == 200
    assert response.json() == {
        "message": "Hello Items!",
        "params": {"q": None, "skip": 5, "limit": 10},
    }


def test_override_in_items_with_q():
    response = client.get("/items/?q=foo")
    assert response.status_code == 200
    assert response.json() == {
        "message": "Hello Items!",
        "params": {"q": "foo", "skip": 5, "limit": 10},
    }


def test_override_in_items_with_params():
    response = client.get("/items/?q=foo&amp;skip=100&amp;limit=200")
    assert response.status_code == 200
    assert response.json() == {
        "message": "Hello Items!",
        "params": {"q": "foo", "skip": 5, "limit": 10},
    }
</pre></div> </div> </div> </div> </details> <div class="admonition tip"> <p class="admonition-title">Tip</p> <p>You can set a dependency override for a dependency used anywhere in your <strong>FastAPI</strong> application.</p> <p>The original dependency could be used in a <em>path operation function</em>, a <em>path operation decorator</em> (when you don't use the return value), a <code>.include_router()</code> call, etc.</p> <p>FastAPI will still be able to override it.</p> </div> <p>Then you can reset your overrides (remove them) by setting <code>app.dependency_overrides</code> to be an empty <code>dict</code>:</p> <div class="highlight"><pre class="language-python" data-language="python">app.dependency_overrides = {}
</pre></div> <div class="admonition tip"> <p class="admonition-title">Tip</p> <p>If you want to override a dependency only during some tests, you can set the override at the beginning of the test (inside the test function) and reset it at the end (at the end of the test function).</p> </div> <form class="md-feedback" name="feedback" hidden> <fieldset> <legend class="md-feedback__title"> Was this page helpful? </legend> <div class="md-feedback__inner">  <div class="md-feedback__note"> <div data-md-value="1" hidden> Thanks for your feedback! </div> <div data-md-value="0" hidden> Thanks for your feedback! </div> </div> </div> </fieldset> </form><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2018 SebastiÃ¡n RamÃ­rez<br>Licensed under the MIT License.<br>
    <a href="https://fastapi.tiangolo.com/advanced/testing-dependencies/" class="_attribution-link">https://fastapi.tiangolo.com/advanced/testing-dependencies/</a>
  </p>
</div>
