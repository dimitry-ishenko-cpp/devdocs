<h1 id="_top" class="astro-556cgime">Astro DB</h1> <div class="content-panel astro-ayt3hsza"> <div class="sl-container astro-ayt3hsza"> <div class="sl-markdown-content astro-klj6ju3r"> <p>Astro DB is a fully-managed SQL database designed exclusively for Astro. Develop locally or connect to a hosted database managed on our <a href="#astro-studio">Astro Studio</a> platform.</p> <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="installation">Installation</h2></div> <p>Add Astro DB to a new or existing Astro project (requires <code dir="auto">astro@4.5</code> or later) with the <a href="../integrations-guide/db/index.html"><code dir="auto">@astrojs/db</code> integration</a> (<code dir="auto">v0.8.1</code> or later). Astro includes a built-in <code dir="auto">astro add</code> command to automate this setup process for you.</p> <starlight-tabs data-sync-key="package-managers" class="astro-tx2opqu5"> <div class="tablist-wrapper not-content astro-tx2opqu5"> <ul role="tablist" class="astro-tx2opqu5"> <li role="presentation" class="tab astro-tx2opqu5"> <a role="tab" href="#tab-panel-139" id="tab-139" aria-selected="true" tabindex="0" class="astro-tx2opqu5"> npm </a> </li>
<li role="presentation" class="tab astro-tx2opqu5"> <a role="tab" href="#tab-panel-140" id="tab-140" aria-selected="false" tabindex="-1" class="astro-tx2opqu5"> pnpm </a> </li>
<li role="presentation" class="tab astro-tx2opqu5"> <a role="tab" href="#tab-panel-141" id="tab-141" aria-selected="false" tabindex="-1" class="astro-tx2opqu5"> Yarn </a> </li> </ul> </div> <section id="tab-panel-139" aria-labelledby="tab-139" role="tabpanel"> <div class="expressive-code">
<div class="_pre-heading">
<span class="sr-only">Terminal window</span>
</div>
<pre data-language="sh">npx astro add db</pre>

</div> </section> <section id="tab-panel-140" aria-labelledby="tab-140" role="tabpanel" hidden> <div class="expressive-code">
<div class="_pre-heading">
<span class="sr-only">Terminal window</span>
</div>
<pre data-language="sh">pnpm astro add db</pre>

</div> </section> <section id="tab-panel-141" aria-labelledby="tab-141" role="tabpanel" hidden> <div class="expressive-code">
<div class="_pre-heading">
<span class="sr-only">Terminal window</span>
</div>
<pre data-language="sh">yarn astro add db</pre>

</div> </section> </starlight-tabs>  <p>If you prefer, you can <a href="../integrations-guide/db/index.html#manual-installation">install <code dir="auto">@astrojs/db</code> manually</a> instead.</p> <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="define-your-database">Define your database</h2></div> <p>Astro DB is a complete solution to configuring, developing and querying your data. A local database is created whenever you run <code dir="auto">astro dev</code>, using LibSQL to manage your data without the need for Docker or a network connection.</p> <p>Installing <code dir="auto">@astrojs/db</code> with the <code dir="auto">astro add</code> command will create a <code dir="auto">db/config.ts</code> file in your project where you will define your databases tables:</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">db/config.ts</span></div>
<pre data-language="ts">import { defineDb } from 'astro:db';


export default defineDb({
  tables: { },
})</pre>

</div> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="tables">Tables</h3></div> <p>Data in Astro DB is stored using SQL tables. Tables structure your data into rows and columns, where columns enforce the type of each row value.</p> <p>When you define a table, Astro will generate a TypeScript interface to query that table from your project. The result is full TypeScript support when you access your data with property autocompletion and type-checking.</p> <p>To configure a database table, import and use the <code dir="auto">defineTable()</code> and <code dir="auto">column</code> utilities from <code dir="auto">astro:db</code>.</p> <p>This example configures a <code dir="auto">Comment</code> table with required text columns for <code dir="auto">author</code> and <code dir="auto">body</code>. Then, make it available to your project through the <code dir="auto">defineDb()</code> export.</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">db/config.ts</span></div>
<pre data-language="ts">import { defineDb, defineTable, column } from 'astro:db';


const Comment = defineTable({
  columns: {
    author: column.text(),
    body: column.text(),
  }
})


export default defineDb({
  tables: { Comment },
})</pre>

</div> <div class="read-more astro-szj46hnz">  <span class="astro-szj46hnz">See the <a href="../integrations-guide/db/index.html#table-configuration-reference">table configuration reference</a> for a complete reference of table options.</span> </div> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="columns">Columns</h3></div> <p>Astro DB supports the following column types:</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">db/config.ts</span></div>
<pre data-language="ts">import { defineTable, column } from 'astro:db';


const Comment = defineTable({
  columns: {
    // A string of text.
    author: column.text(),
    // A whole integer value.
    likes: column.number(),
    // A true or false value.
    flagged: column.boolean(),
    // Date/time values queried as JavaScript Date objects.
    published: column.date(),
    // An untyped JSON object.
    metadata: column.json(),
  }
});</pre>

</div> <div class="read-more astro-szj46hnz">  <span class="astro-szj46hnz">See the <a href="../integrations-guide/db/index.html#table-configuration-reference">table columns reference</a> for more details.</span> </div> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="table-references">Table References</h3></div> <p>Relationships between tables are a common pattern in database design. For example, a <code dir="auto">Blog</code> table may be closely related to other tables of <code dir="auto">Comment</code>, <code dir="auto">Author</code>, and <code dir="auto">Category</code>.</p> <p>You can define these relations between tables and save them into your database schema using <strong>reference columns</strong>. To establish a relationship, you will need:</p> <ul> <li>An <strong>identifier column</strong> on the referenced table. This is usually an <code dir="auto">id</code> column with the <code dir="auto">primaryKey</code> property.</li> <li>A column on the base table to <strong>store the referenced <code dir="auto">id</code></strong>. This uses the <code dir="auto">references</code> property to establish a relationship.</li> </ul> <p>This example shows a <code dir="auto">Comment</code> table’s <code dir="auto">authorId</code> column referencing an <code dir="auto">Author</code> table’s <code dir="auto">id</code> column.</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">db/config.ts</span></div>
<pre data-language="ts">const Author = defineTable({
  columns: {
    id: column.number({ primaryKey: true }),
    name: column.text(),
  }
});


const Comment = defineTable({
  columns: {
    authorId: column.number({ references: () =&gt; Author.columns.id }),
    body: column.text(),
  }
});</pre>

</div> <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="seed-your-database">Seed your database</h2></div> <p>In development, Astro will use your DB config to generate local types according to your schemas. These will be generated fresh each time the dev server is started, and will allow you to query and work with the shape of your data with type safety and autocompletion.</p> <p>To seed development data for testing and debugging into your Astro project, create a <code dir="auto">db/seed.ts</code> file. Import both the <code dir="auto">db</code> object and any configured table from <code dir="auto">astro:db</code>. Use the <code dir="auto">db.insert()</code> function to provide an array of table row data objects.</p> <p>The following example defines two rows of development data for a <code dir="auto">Comment</code> table:</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">db/seed.ts</span></div>
<pre data-language="ts">import { db, Comment } from 'astro:db';


export default async function() {
  await db.insert(Author).values([
    { id: 1, name: "Kasim" },
    { id: 2, name: "Mina" },
  ]);


  await db.insert(Comment).values([
    { authorId: 1, body: 'Hope you like Astro DB!' },
    { authorId: 2, body: 'Enjoy!'},
  ])
}</pre>

</div> <p>Your development server will automatically restart your database whenever this file changes, regenerating your types and seeding your development data from <code dir="auto">seed.ts</code>.</p> <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="query-your-database">Query your database</h2></div> <p>You can query your database from any <a href="../../basics/astro-pages/index.html#astro-pages">Astro page</a> or <a href="../endpoints/index.html">endpoint</a> in your project using the provided <code dir="auto">db</code> ORM and query builder.</p> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="drizzle-orm">Drizzle ORM</h3></div> <div class="expressive-code">

<pre data-language="plaintext">import { db } from 'astro:db';</pre>

</div> <p>Astro DB includes a built-in <a href="https://orm.drizzle.team/">Drizzle ORM</a> client. There is no setup or manual configuration required to use the client. The Astro DB <code dir="auto">db</code> client is automatically configured to talk to your database (local or remote) when you run Astro. It uses your exact database schema definition for type-safe SQL queries with TypeScript errors when you reference a column or table that doesn’t exist.</p> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="select">Select</h3></div> <p>The following example selects all rows of a <code dir="auto">Comment</code> table. This returns the complete array of seeded development data from <code dir="auto">db/seed.ts</code> which is then available for use in your page template:</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">src/pages/index.astro</span></div>
<pre data-language="astro">---
import { db, Comment } from 'astro:db';


const comments = await db.select().from(Comment);
---


&lt;h2&gt;Comments&lt;/h2&gt;


{
  comments.map(({ author, body }) =&gt; (
    &lt;article&gt;
      &lt;p&gt;Author: {author}&lt;/p&gt;
      &lt;p&gt;{body}&lt;/p&gt;
    &lt;/article&gt;
  ))
}</pre>

</div> <div class="read-more astro-szj46hnz">  <span class="astro-szj46hnz">See the <a href="https://orm.drizzle.team/docs/select">Drizzle <code dir="auto">select()</code> API reference</a> for a complete overview.</span> </div> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="insert">Insert</h3></div> <p>To accept user input, such as handling form requests and inserting data into your remote hosted database, configure your Astro project for <a href="../../basics/rendering-modes/index.html#on-demand-rendered">on-demand rendering</a> and <a href="../server-side-rendering/index.html#official-adapters">add an SSR adapter</a> for your deployment environment.</p> <p>This example inserts a row into a <code dir="auto">Comment</code> table based on a parsed form POST request:</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">src/pages/index.astro</span></div>
<pre data-language="astro">---
import { db, Comment } from 'astro:db';


if (Astro.request.method === 'POST') {
  // parse form data
  const formData = await Astro.request.formData();
  const author = formData.get('author');
  const content = formData.get('content');
  if (typeof author === 'string' &amp;&amp; typeof content === 'string') {
    // insert form data into the Comment table
    await db.insert(Comment).values({ author, content });
  }
}


// render the new list of comments on each request
const comments = await db.select().from(Comment);
---


&lt;form method="POST" style="display: grid"&gt;
  &lt;label for="author"&gt;Author&lt;/label&gt;
  &lt;input id="author" name="author" /&gt;


  &lt;label for="content"&gt;Content&lt;/label&gt;
  &lt;textarea id="content" name="content"&gt;&lt;/textarea&gt;


  &lt;button type="submit"&gt;Submit&lt;/button&gt;
&lt;/form&gt;


&lt;!--render `comments`--&gt;</pre>

</div> <p>You can also query your database from an API endpoint. This example deletes a row from a <code dir="auto">Comment</code> table by the <code dir="auto">id</code> param:</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">src/pages/api/comments/[id].ts</span></div>
<pre data-language="ts">import type { APIRoute } from "astro";
import { db, Comment, eq } from 'astro:db';


export const DELETE: APIRoute = async (ctx) =&gt; {
  await db.delete(Comment).where(eq(Comment.id, ctx.params.id ));
  return new Response(null, { status: 204 });
}</pre>

</div> <div class="read-more astro-szj46hnz">  <span class="astro-szj46hnz"><p>See the <a href="https://orm.drizzle.team/docs/insert">Drizzle <code dir="auto">insert()</code> API reference</a> for a complete overview.</p></span> </div> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="filtering">Filtering</h3></div> <p>To query for table results by a specific property, use <a href="https://orm.drizzle.team/docs/select#partial-select">Drizzle options for partial selects</a>. For example, add <a href="https://orm.drizzle.team/docs/select#filtering">a <code dir="auto">.where()</code> call</a> to your <code dir="auto">select()</code> query and pass the comparison you want to make.</p> <p>The following example queries for all rows in a <code dir="auto">Comment</code> table that contain the phrase “Astro DB.” Use <a href="https://orm.drizzle.team/docs/operators#like">the <code dir="auto">like()</code> operator</a> to check if a phrase is present within the <code dir="auto">body</code>:</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">src/pages/index.astro</span></div>
<pre data-language="astro">---
import { db, Comment, like } from 'astro:db';


const comments = await db.select().from(Comment).where(
    like(Comment.body, '%Astro DB%')
);
---</pre>

</div> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="drizzle-utilities">Drizzle utilities</h3></div> <p>All Drizzle utilities for building queries are exposed from the <code dir="auto">astro:db</code> module. This includes:</p> <ul> <li>
<a href="https://orm.drizzle.team/docs/operators">Filter operators</a> like <code dir="auto">eq()</code> and <code dir="auto">gt()</code>
</li> <li>
<a href="https://orm.drizzle.team/docs/select#aggregations-helpers">Aggregation helpers</a> like <code dir="auto">count()</code>
</li> <li>
<a href="https://orm.drizzle.team/docs/sql">The <code dir="auto">sql</code> helper</a> for writing raw SQL queries</li> </ul> <div class="expressive-code">

<pre data-language="ts">import { eq, gt, count, sql } from 'astro:db';</pre>

</div> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="relationships">Relationships</h3></div> <p>You can query related data from multiple tables using a SQL join. To create a join query, extend your <code dir="auto">db.select()</code> statement with a join operator. Each function accepts a table to join with and a condition to match rows between the two tables.</p> <p>This example uses an <code dir="auto">innerJoin()</code> function to join <code dir="auto">Comment</code> authors with their related <code dir="auto">Author</code> information based on the <code dir="auto">authorId</code> column. This returns an array of objects with each <code dir="auto">Author</code> and <code dir="auto">Comment</code> row as top-level properties:</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">src/pages/index.astro</span></div>
<pre data-language="astro">---
import { db, eq, Comment, Author } from 'astro:db';


const comments = await db.select()
  .from(Comment)
  .innerJoin(Author, eq(Comment.authorId, Author.id));
---


&lt;h2&gt;Comments&lt;/h2&gt;


{
  comments.map(({ Author, Comment }) =&gt; (
    &lt;article&gt;
      &lt;p&gt;Author: {Author.name}&lt;/p&gt;
      &lt;p&gt;{Comment.body}&lt;/p&gt;
    &lt;/article&gt;
  ))
}</pre>

</div> <div class="read-more astro-szj46hnz">  <span class="astro-szj46hnz"><p>See the <a href="https://orm.drizzle.team/docs/joins#join-types">Drizzle join reference</a> for all available join operators and config options.</p></span> </div> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="batch-transactions">Batch Transactions</h3></div> <p>All remote database queries are made as a network request. You may need to “batch” queries together into a single transaction when making a large number of queries, or to have automatic rollbacks if any query fails.</p> <p>This example seeds multiple rows in a single request using the <code dir="auto">db.batch()</code> method:</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">db/seed.ts</span></div>
<pre data-language="ts">import { db, Author, Comment } from 'astro:db';


export default async function () {
  const queries = [];
  // Seed 100 sample comments into your remote database
  // with a single network request.
  for (let i = 0; i &lt; 100; i++) {
    queries.push(db.insert(Comment).values({ body: `Test comment ${i}` }));
  }
  await db.batch(queries);
}</pre>

</div> <div class="read-more astro-szj46hnz">  <span class="astro-szj46hnz"><p>See the <a href="https://orm.drizzle.team/docs/batch-api">Drizzle <code dir="auto">db.batch()</code></a> docs for more details.</p></span> </div> <div class="studio-tag-wrapper level-h2 astro-4tqpgtcp"> <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="astro-studio">Astro Studio</h2></div> <span class="studio-tag astro-4tqpgtcp">  <span class="astro-4tqpgtcp">Studio feature</span> </span> </div> <p>Astro DB can connect to the Astro Studio platform to quickly add a hosted database to your project. You can view, manage and deploy new hosted databases all from the Astro Studio dashboard.</p> <p>The <a href="http://studio.astro.build">Astro Studio web portal</a> allows you to connect to and manage your remote hosted Astro DB databases through a web interface or using <a href="../../reference/cli-reference/index.html#astro-studio-cli">CLI commands</a>.</p> <p>From your Studio dashboard, you have access to account management, help articles and a support message console.</p> <p>Visit <a href="http://studio.astro.build">Astro Studio</a> to sign up or log in.</p> <div class="studio-tag-wrapper level-h3 astro-4tqpgtcp"> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="create-a-new-studio-project">Create a new Studio project</h3></div> <span class="studio-tag astro-4tqpgtcp">  <span class="astro-4tqpgtcp">Studio feature</span> </span> </div> <p>There are two ways to create a project in Astro Studio:</p> <ol> <li> <p><a href="https://studio.astro.build"><strong>Use the Astro Studio web UI</strong></a> to create from a new or existing GitHub repository.</p> <p>To get started, click the “create project” button in the header and follow the instructions. Astro Studio will connect to your GitHub repository and create a new hosted database for your project.</p> </li> <li> <p><strong>Use the Astro Studio CLI</strong> to create from any local Astro project. You can run the following commands to get started:</p> <starlight-tabs data-sync-key="package-managers" class="astro-tx2opqu5"> <div class="tablist-wrapper not-content astro-tx2opqu5"> <ul role="tablist" class="astro-tx2opqu5"> <li role="presentation" class="tab astro-tx2opqu5"> <a role="tab" href="#tab-panel-142" id="tab-142" aria-selected="true" tabindex="0" class="astro-tx2opqu5"> npm </a> </li>
<li role="presentation" class="tab astro-tx2opqu5"> <a role="tab" href="#tab-panel-143" id="tab-143" aria-selected="false" tabindex="-1" class="astro-tx2opqu5"> pnpm </a> </li>
<li role="presentation" class="tab astro-tx2opqu5"> <a role="tab" href="#tab-panel-144" id="tab-144" aria-selected="false" tabindex="-1" class="astro-tx2opqu5"> Yarn </a> </li> </ul> </div> <section id="tab-panel-142" aria-labelledby="tab-142" role="tabpanel"> <div class="expressive-code">
<div class="_pre-heading">
<span class="sr-only">Terminal window</span>
</div>
<pre data-language="shell"># Log in to Astro Studio with your GitHub account
npx astro login


# Link to a new project by following the prompts
npx astro link


# (Optional) Push your local db configuration to the remote database
npx astro db push</pre>

</div> </section> <section id="tab-panel-143" aria-labelledby="tab-143" role="tabpanel" hidden> <div class="expressive-code">
<div class="_pre-heading">
<span class="sr-only">Terminal window</span>
</div>
<pre data-language="shell"># Log in to Astro Studio with your GitHub account
pnpm astro login


# Link to a new project by following the prompts
pnpm astro link


# (Optional) Push your local db configuration to the remote database
pnpm astro db push</pre>

</div> </section> <section id="tab-panel-144" aria-labelledby="tab-144" role="tabpanel" hidden> <div class="expressive-code">
<div class="_pre-heading">
<span class="sr-only">Terminal window</span>
</div>
<pre data-language="shell"># Log in to Astro Studio with your GitHub account
yarn astro login


# Link to a new project by following the prompts
yarn astro link


# (Optional) Push your local db configuration to the remote database
yarn astro db push</pre>

</div> </section> </starlight-tabs> <p>Once you are logged in and linked successfully, you can run all Astro DB commands to manage your remote database.</p> <div class="read-more astro-szj46hnz">  <span class="astro-szj46hnz">See <a href="../integrations-guide/db/index.html#astro-db-cli-reference">the Astro DB CLI reference</a> for all available commands.</span> </div> </li> </ol> <div class="studio-tag-wrapper level-h3 astro-4tqpgtcp"> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="deploy-with-a-studio-connection">Deploy with a Studio connection</h3></div> <span class="studio-tag astro-4tqpgtcp">  <span class="astro-4tqpgtcp">Studio feature</span> </span> </div> <p>You can deploy your Astro DB project with a live connection to your Studio database. This is possible with any deployment platform using static builds or an <a href="../server-side-rendering/index.html">SSR adapter</a>.</p> <p>First, configure your build command to connect with Studio using the <code dir="auto">--remote</code> flag. This example applies the flag to a <code dir="auto">"build"</code> script in your project’s <code dir="auto">package.json</code>. If your deployment platform accepts a build command, ensure this is set to <code dir="auto">npm run build</code>.</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">package.json</span></div>
<pre data-language="json">{
  "scripts": {
    "build": "astro build --remote"
  }
}</pre>

</div> <div class="studio-tag-wrapper level-h4 astro-4tqpgtcp"> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="create-a-studio-app-token">Create a Studio app token</h4></div> <span class="studio-tag astro-4tqpgtcp">  <span class="astro-4tqpgtcp">Studio feature</span> </span> </div> <p>You need to create an app token to access your Studio database from a production deploy. You can create an app token from your Studio project dashboard by navigating to the <strong>Settings</strong> tab and selecting <strong>Tokens</strong>.</p> <p>Copy the generated token and apply as an environment variable / environment secret in your deployment platform using the name <code dir="auto">ASTRO_STUDIO_APP_TOKEN</code>.</p> <div class="studio-tag-wrapper level-h3 astro-4tqpgtcp"> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="set-up-the-github-ci-action">Set up the GitHub CI Action</h3></div> <span class="studio-tag astro-4tqpgtcp">  <span class="astro-4tqpgtcp">Studio feature</span> </span> </div> <p>You can automatically push schema changes to your Studio database with the Studio CI action. This verifies changes can be made safely, and keeps your configuration up-to-date whenever you merge to <code dir="auto">main</code>.</p> <p><a href="https://docs.github.com/en/actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-a-repository">Follow GitHub’s documentation</a> to configure a new secret in your repository with the name <code dir="auto">ASTRO_STUDIO_APP_TOKEN</code> and your Studio app token as the value for the secret.</p> <p>Once your secret is configured, create a new GitHub Actions workflow file in your project’s <code dir="auto">.github/workflows</code> directory to checkout the repository and install Node.js as steps, and use the <code dir="auto">withastro/action-studio</code> action to sync schema changes.</p> <p>The action will run <code dir="auto">astro db verify</code> on all <a href="https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows">event triggers</a> to ensure schema changes can be applied safely. If you add the <strong><a href="https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#push">push</a></strong> trigger specifically, the action will push those changes to your Studio database.</p> <p>This example GitHub Action <code dir="auto">_studio.yml</code> pushes changes whenever the <code dir="auto">main</code> branch is updated:</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">.github/workflows/_studio.yml</span></div>
<pre data-language="yaml">name: Astro Studio


env:
  ASTRO_STUDIO_APP_TOKEN: ${{secrets.ASTRO_STUDIO_APP_TOKEN }}


on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, reopened, synchronize]


jobs:
  DB:
    permissions:
      contents: read
      actions: read
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: jaid/action-npm-install@v1.2.1
      - uses: withastro/action-studio@main</pre>

</div> <div class="studio-tag-wrapper level-h3 astro-4tqpgtcp"> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="pushing-table-schemas">Pushing table schemas</h3></div> <span class="studio-tag astro-4tqpgtcp">  <span class="astro-4tqpgtcp">Studio feature</span> </span> </div> <p>Your table schema will change over time as your project grows. You can safely test configuration changes locally and push to your Studio database when you deploy.</p> <p>When <a href="#astro-studio">creating a Studio project from the dashboard</a>, you will have the option to create a GitHub CI action. This will automatically migrate schema changes when merging with your repository’s main branch.</p> <p>You can also push your local schema changes to Astro Studio via the CLI using the <code dir="auto">astro db push --remote</code> command:</p> <starlight-tabs data-sync-key="package-managers" class="astro-tx2opqu5"> <div class="tablist-wrapper not-content astro-tx2opqu5"> <ul role="tablist" class="astro-tx2opqu5"> <li role="presentation" class="tab astro-tx2opqu5"> <a role="tab" href="#tab-panel-145" id="tab-145" aria-selected="true" tabindex="0" class="astro-tx2opqu5"> npm </a> </li>
<li role="presentation" class="tab astro-tx2opqu5"> <a role="tab" href="#tab-panel-146" id="tab-146" aria-selected="false" tabindex="-1" class="astro-tx2opqu5"> pnpm </a> </li>
<li role="presentation" class="tab astro-tx2opqu5"> <a role="tab" href="#tab-panel-147" id="tab-147" aria-selected="false" tabindex="-1" class="astro-tx2opqu5"> Yarn </a> </li> </ul> </div> <section id="tab-panel-145" aria-labelledby="tab-145" role="tabpanel"> <div class="expressive-code">
<div class="_pre-heading">
<span class="sr-only">Terminal window</span>
</div>
<pre data-language="sh">npm run astro db push --remote</pre>

</div> </section> <section id="tab-panel-146" aria-labelledby="tab-146" role="tabpanel" hidden> <div class="expressive-code">
<div class="_pre-heading">
<span class="sr-only">Terminal window</span>
</div>
<pre data-language="sh">pnpm astro db push --remote</pre>

</div> </section> <section id="tab-panel-147" aria-labelledby="tab-147" role="tabpanel" hidden> <div class="expressive-code">
<div class="_pre-heading">
<span class="sr-only">Terminal window</span>
</div>
<pre data-language="sh">yarn astro db push --remote</pre>

</div> </section> </starlight-tabs> <p>This command will verify that your local changes can be made without data loss and, if necessary, suggest how to safely make changes to your schema in order to resolve conflicts.</p> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="pushing-breaking-schema-changes">Pushing breaking schema changes</h4></div> <aside aria-label="Caution" class="starlight-aside starlight-aside--caution"><p class="starlight-aside__title" aria-hidden="true">Caution</p>
<section class="starlight-aside__content"><p><strong>This will destroy your database</strong>. Only perform this command if you do not need your production data.</p></section></aside> <p>If you must change your table schema in a way that is incompatible with your existing data hosted at Astro Studio, you will need to reset your production database.</p> <p>To push a table schema update that includes a breaking change, add the <code dir="auto">--force-reset</code> flag to reset all production data:</p> <starlight-tabs data-sync-key="package-managers" class="astro-tx2opqu5"> <div class="tablist-wrapper not-content astro-tx2opqu5"> <ul role="tablist" class="astro-tx2opqu5"> <li role="presentation" class="tab astro-tx2opqu5"> <a role="tab" href="#tab-panel-148" id="tab-148" aria-selected="true" tabindex="0" class="astro-tx2opqu5"> npm </a> </li>
<li role="presentation" class="tab astro-tx2opqu5"> <a role="tab" href="#tab-panel-149" id="tab-149" aria-selected="false" tabindex="-1" class="astro-tx2opqu5"> pnpm </a> </li>
<li role="presentation" class="tab astro-tx2opqu5"> <a role="tab" href="#tab-panel-150" id="tab-150" aria-selected="false" tabindex="-1" class="astro-tx2opqu5"> Yarn </a> </li> </ul> </div> <section id="tab-panel-148" aria-labelledby="tab-148" role="tabpanel"> <div class="expressive-code">
<div class="_pre-heading">
<span class="sr-only">Terminal window</span>
</div>
<pre data-language="sh">npm run astro db push --remote --force-reset</pre>

</div> </section> <section id="tab-panel-149" aria-labelledby="tab-149" role="tabpanel" hidden> <div class="expressive-code">
<div class="_pre-heading">
<span class="sr-only">Terminal window</span>
</div>
<pre data-language="sh">pnpm astro db push --remote --force-reset</pre>

</div> </section> <section id="tab-panel-150" aria-labelledby="tab-150" role="tabpanel" hidden> <div class="expressive-code">
<div class="_pre-heading">
<span class="sr-only">Terminal window</span>
</div>
<pre data-language="sh">yarn astro db push --remote --force-reset</pre>

</div> </section> </starlight-tabs> <div class="studio-tag-wrapper level-h3 astro-4tqpgtcp"> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="renaming-tables">Renaming tables</h3></div> <span class="studio-tag astro-4tqpgtcp">  <span class="astro-4tqpgtcp">Studio feature</span> </span> </div> <p>It is possible to rename a table after pushing your schema to Astro Studio.</p> <p>If you <strong>do not have any important production data</strong>, then you can <a href="#pushing-breaking-schema-changes">reset your database</a> using the <code dir="auto">--force-reset</code> flag. This flag will drop all of the tables in the database and create new ones so that it matches your current schema exactly.</p> <p>To rename a table while preserving your production data, you must perform a series of non-breaking changes to push your local schema to Astro studio safely.</p> <p>The following example renames a table from <code dir="auto">Comment</code> to <code dir="auto">Feedback</code>:</p> <ol role="list" class="sl-steps"> <li> <p>In your database config file, add the <code dir="auto">deprecated: true</code> property to the table you want to rename:</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">db/config.ts</span></div>
<pre data-language="ts">const Comment = defineTable({
  deprecated: true,
  columns: {
    author: column.text(),
    body: column.text(),
  }
});</pre>

</div> </li> <li> <p>Add a new table schema (matching the existing table’s properties exactly) with the new name:</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">db/config.ts</span></div>
<pre data-language="ts">const Comment = defineTable({
  deprecated: true,
  columns: {
    author: column.text(),
    body: column.text(),
  }
});


const Feedback = defineTable({
  columns: {
    author: column.text(),
    body: column.text(),
  }
});</pre>

</div> </li> <li> <p><a href="#pushing-table-schemas">Push to Astro Studio</a> with <code dir="auto">astro db push --remote</code>. This will add the new table and mark the old as deprecated.</p> </li> <li> <p>Update any of your local project code to use the new table instead of the old table. You might need to migrate data to the new table as well.</p> </li> <li> <p>Once you are confident that the old table is no longer used in your project, you can remove the schema from your <code dir="auto">config.ts</code>:</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">db/config.ts</span></div>
<pre data-language="ts">const Comment = defineTable({
  deprecated: true,
  columns: {
    author: column.text(),
    body: column.text(),
  }
});


const Feedback = defineTable({
  columns: {
    author: column.text(),
    body: column.text(),
  }
});</pre>

</div> </li> <li> <p>Push to Astro Studio again with <code dir="auto">astro db push --remote</code>. The old table will be dropped, leaving only the new, renamed table.</p> </li> </ol> <div class="studio-tag-wrapper level-h3 astro-4tqpgtcp"> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="pushing-data">Pushing data</h3></div> <span class="studio-tag astro-4tqpgtcp">  <span class="astro-4tqpgtcp">Studio feature</span> </span> </div> <p>You may need to push data to your Studio database for seeding or data migrations. You can author a <code dir="auto">.ts</code> file with the <code dir="auto">astro:db</code> module to write type-safe queries. Then, execute the file against your Studio database using the command <code dir="auto">astro db execute &lt;file-path&gt; --remote</code>:</p> <p>The following Comments can be seeded using the command <code dir="auto">astro db execute db/seed.ts --remote</code>:</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">db/seed.ts</span></div>
<pre data-language="ts">import { Comment } from 'astro:db';


export default async function () {
  await db.insert(Comment).values([
    { authorId: 1, body: 'Hope you like Astro DB!' },
    { authorId: 2, body: 'Enjoy!' },
  ])
}</pre>

</div> <div class="read-more astro-szj46hnz">  <span class="astro-szj46hnz"><p>See the <a href="../integrations-guide/db/index.html#astro-db-cli-reference">CLI reference</a> for a complete list of commands.</p></span> </div> <div class="studio-tag-wrapper level-h3 astro-4tqpgtcp"> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="connect-to-astro-studio">Connect to Astro Studio</h3></div> <span class="studio-tag astro-4tqpgtcp">  <span class="astro-4tqpgtcp">Studio feature</span> </span> </div> <p>By default, Astro will use a local database file whenever you run the <code dir="auto">dev</code> or <code dir="auto">build</code> commands. Tables are recreated from scratch when each command is run, and development seed data will be inserted.</p> <p>To connect to your hosted Studio database, you can add the <code dir="auto">--remote</code> flag. Use this flag for production deploys to have both readable and writable access to your Studio database. This will allow you to <a href="#insert">accept and persist user data</a>.</p> <div class="expressive-code">
<div class="_pre-heading">
<span class="sr-only">Terminal window</span>
</div>
<pre data-language="bash"># Build with a remote connection
astro build --remote


# Develop with a remote connection
astro dev --remote</pre>

</div> <aside aria-label="Caution" class="starlight-aside starlight-aside--caution"><p class="starlight-aside__title" aria-hidden="true">Caution</p>
<section class="starlight-aside__content"><p>Be careful using <code dir="auto">--remote</code> in development. This will connect to a live production database, and all inserts, updates, or deletions will be persisted.</p></section></aside> <p>To use a remote connection, you will need an app token to authenticate with Studio. Visit the Studio dashboard for token creation and setup instructions.</p> <div class="read-more astro-szj46hnz">  <span class="astro-szj46hnz"><p>When you’re ready to deploy, see our <a href="#deploy-with-a-studio-connection">Deploy with a Studio Connection guide</a>.</p></span> </div> <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="building-astro-db-integrations">Building Astro DB integrations</h2></div> <p><a href="../../reference/integrations-reference/index.html">Astro integrations</a> can extend user projects with additional Astro DB tables and seed data.</p> <p>Use the <code dir="auto">extendDb()</code> method in the <code dir="auto">astro:db:setup</code> hook to register additional Astro DB config and seed files. The <code dir="auto">defineDbIntegration()</code> helper provides TypeScript support and auto-complete for the <code dir="auto">astro:db:setup</code> hook.</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">my-integration/index.ts</span></div>
<pre data-language="js">import { defineDbIntegration } from '@astrojs/db/utils';


export default function MyIntegration() {
  return defineDbIntegration({
    name: 'my-astro-db-powered-integration',
    hooks: {
      'astro:db:setup': ({ extendDb }) =&gt; {
        extendDb({
          configEntrypoint: '@astronaut/my-package/config',
          seedEntrypoint: '@astronaut/my-package/seed',
        });
      },
      // Other integration hooks...
    },
  });
}</pre>

</div> <p>Integration <a href="#define-your-database">config</a> and <a href="#seed-your-database">seed</a> files follow the same format as their user-defined equivalents.</p> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="type-safe-operations-in-integrations">Type safe operations in integrations</h3></div> <p>While working on integrations, you may not be able to benefit from Astro’s generated table types exported from <code dir="auto">astro:db</code>. For full type safety, use the <code dir="auto">asDrizzleTable()</code> utility to create a table reference object you can use for database operations.</p> <p>For example, given an integration setting up the following <code dir="auto">Pets</code> database table:</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">my-integration/config.ts</span></div>
<pre data-language="js">import { defineDb, defineTable, column } from 'astro:db';


export const Pets = defineTable({
  columns: {
    name: column.text(),
    species: column.text(),
  },
});


export default defineDb({ tables: { Pets } });</pre>

</div> <p>The seed file can import <code dir="auto">Pets</code> and use <code dir="auto">asDrizzleTable()</code> to insert rows into your table with type checking:</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">my-integration/seed.ts</span></div>
<pre data-language="js">import { asDrizzleTable } from '@astrojs/db/utils';
import { db } from 'astro:db';
import { Pets } from './config';


export default async function() {
  const typeSafePets = asDrizzleTable('Pets', Pets);


  await db.insert(typeSafePets).values([
    { name: 'Palomita', species: 'cat' },
    { name: 'Pan', species: 'dog' },
  ]);
}</pre>

</div> <p>The value returned by <code dir="auto">asDrizzleTable('Pets', Pets)</code> is equivalent to <code dir="auto">import { Pets } from 'astro:db'</code>, but is available even when Astro’s type generation can’t run. You can use it in any integration code that needs to query or insert into the database.</p> <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="self-hosted-production-deployment">Self-hosted production deployment</h2></div> <p>If you deploy your site to a self-managed host such as a <a href="https://en.wikipedia.org/wiki/Virtual_private_server">virtual private server</a>, you can choose to use a database file instead of connecting to a database hosted at Astro Studio.</p> <aside aria-label="Caution" class="starlight-aside starlight-aside--caution"><p class="starlight-aside__title" aria-hidden="true">Caution</p>
<section class="starlight-aside__content"><p>Using a database file is an advanced feature, and care should be taken when deploying to prevent overriding your database and losing your production data.</p>
<p>Additionally, this method will not work in serverless deployments, as the file system is not persisted in those environments.</p>
<p>For a fully managed solution, <a href="#astro-studio">connect to databases hosted on the Astro Studio platform</a> instead.</p></section></aside> <p>If you are comfortable with the risks, and can manage deployment yourself, you can use a database file instead of connecting to Studio.</p> <p>Set the <code dir="auto">ASTRO_DATABASE_FILE</code> environment variable to a path pointing to your <code dir="auto">.db</code> file within the host environment during your build:</p> <div class="expressive-code">
<div class="_pre-heading">
<span class="sr-only">Terminal window</span>
</div>
<pre data-language="shell">ASTRO_DATABASE_FILE=/srv/files/database.db astro build</pre>

</div> <p>The build will statically compile with this path as your production database. When you deploy and launch your server it will connect to the file at this path on the production host.</p> <p>Additionally, <a href="#pushing-table-schemas">pushing any table schema changes</a> (also known as “schema migrations”) must be managed manually using this environment variable.</p> <aside aria-label="Danger" class="starlight-aside starlight-aside--danger"><p class="starlight-aside__title" aria-hidden="true">Danger</p>
<section class="starlight-aside__content"><p>If you override your <code dir="auto">.db</code> file on deployment, you will lose your production data. Follow the deployment method process for your host carefully to prevent data loss.</p></section></aside> <span id="docsearch-lvl0" hidden class="astro-klj6ju3r">Learn</span> </div>   </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2021 Fred K. Schott<br>Licensed under the MIT License.<br>
    <a href="https://docs.astro.build/en/guides/astro-db/" class="_attribution-link">https://docs.astro.build/en/guides/astro-db/</a>
  </p>
</div>
