<h1 id="_top" class="astro-556cgime">Upgrade to Astro v4</h1> <div class="content-panel astro-ayt3hsza"> <div class="sl-container astro-ayt3hsza"> <div class="sl-markdown-content astro-klj6ju3r"> <p>This guide will help you migrate from Astro v3 to Astro v4.</p> <p>Need to upgrade an older project to v3? See our <a href="../v3/index.html">older migration guide</a>.</p> <p>Need to see the v3 docs? Visit this <a href="https://docs-git-v3-docs-unmaintained-astrodotbuild.vercel.app/">older version of the docs site (unmaintained v3.6 snapshot)</a>.</p> <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="upgrade-astro">Upgrade Astro</h2></div> <p>Update your project’s version of Astro and all official integrations to the latest versions using your package manager.</p> <starlight-tabs data-sync-key="package-managers" class="astro-tx2opqu5"> <div class="tablist-wrapper not-content astro-tx2opqu5"> <ul role="tablist" class="astro-tx2opqu5"> <li role="presentation" class="tab astro-tx2opqu5"> <a role="tab" href="#tab-panel-492" id="tab-492" aria-selected="true" tabindex="0" class="astro-tx2opqu5"> npm </a> </li>
<li role="presentation" class="tab astro-tx2opqu5"> <a role="tab" href="#tab-panel-493" id="tab-493" aria-selected="false" tabindex="-1" class="astro-tx2opqu5"> pnpm </a> </li>
<li role="presentation" class="tab astro-tx2opqu5"> <a role="tab" href="#tab-panel-494" id="tab-494" aria-selected="false" tabindex="-1" class="astro-tx2opqu5"> Yarn </a> </li> </ul> </div> <section id="tab-panel-492" aria-labelledby="tab-492" role="tabpanel"> <div class="expressive-code">
<div class="_pre-heading">
<span class="sr-only">Terminal window</span>
</div>
<pre data-language="shell"># Upgrade Astro and official integrations together
npx @astrojs/upgrade</pre>

</div> </section> <section id="tab-panel-493" aria-labelledby="tab-493" role="tabpanel" hidden> <div class="expressive-code">
<div class="_pre-heading">
<span class="sr-only">Terminal window</span>
</div>
<pre data-language="shell"># Upgrade Astro and official integrations together
pnpm dlx @astrojs/upgrade</pre>

</div> </section> <section id="tab-panel-494" aria-labelledby="tab-494" role="tabpanel" hidden> <div class="expressive-code">
<div class="_pre-heading">
<span class="sr-only">Terminal window</span>
</div>
<pre data-language="shell"># Upgrade Astro and official integrations together
yarn dlx @astrojs/upgrade</pre>

</div> </section> </starlight-tabs>  <p>You can also <a href="../../integrations-guide/index.html#manual-upgrading">upgrade your Astro integrations manually</a> if needed, and you may also need to upgrade other dependencies in your project.</p> <aside aria-label="Need to continue?" class="starlight-aside starlight-aside--note"><p class="starlight-aside__title" aria-hidden="true">Need to continue?</p>
<section class="starlight-aside__content"><p>After upgrading Astro to the latest version, you may not need to make any changes to your project at all!</p>
<p>But, if you notice errors or unexpected behavior, please check below for what has changed that might need updating in your project.</p></section></aside> <p>Astro v4.0 includes <a href="#breaking-changes">potentially breaking changes</a>, as well as the <a href="#previously-deprecated-features-now-removed">removal of some previously deprecated features</a>.</p> <p>If your project doesn’t work as expected after upgrading to v4.0, check this guide for an overview of all breaking changes and instructions on how to update your codebase.</p> <p>See <a href="https://github.com/withastro/astro/blob/main/packages/astro/CHANGELOG.md">the changelog</a> for full release notes.</p> <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="astro-v40-experimental-flags-removed">Astro v4.0 Experimental Flags Removed</h2></div> <p>Remove the <code dir="auto">devOverlay</code> experimental flag and move any <code dir="auto">i18n</code> config to the top level in <code dir="auto">astro.config.mjs</code>:</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">astro.config.mjs</span></div>
<pre data-language="js">import { defineConfig } from 'astro/config';


export default defineConfig({
  experimental: {
    devOverlay: true,
    i18n: {
      defaultLocale: "en",
      locales: ["en", "fr", "pt-br", "es"],
    }
  },
  i18n: {
    defaultLocale: "en",
    locales: ["en", "fr", "pt-br", "es"],
  },
})</pre>

</div> <p>These configurations, <code dir="auto">i18n</code> and the renamed <code dir="auto">devToolbar</code>, are now available in Astro v4.0.</p> <p>Read more about these two exciting features and more in <a href="https://astro.build/blog/astro-4/">the v4.0 Blog post</a>!</p> <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="upgrades">Upgrades</h2></div> <p>Any major upgrades to Astro’s dependencies may cause breaking changes in your project.</p> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="upgraded-vite-50">Upgraded: Vite 5.0</h3></div> <p>In Astro v3.0, Vite 4 was used as the development server and production bundler.</p> <p>Astro v4.0 upgrades from Vite 4 to Vite 5.</p> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="what-should-i-do">What should I do?</h4></div> <p>If you are using Vite-specific plugins, configuration, or APIs, check the <a href="https://vitejs.dev/guide/migration">Vite migration guide</a> for their breaking changes and upgrade your project as needed. There are no breaking changes to Astro itself.</p> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="upgraded-unified-remark-and-rehype-dependencies">Upgraded: unified, remark, and rehype dependencies</h3></div> <p>In Astro v3.x, unified v10 and its related compatible remark/rehype packages were used to process Markdown and MDX.</p> <p>Astro v4.0 upgrades <a href="https://github.com/unifiedjs/unified/releases/tag/11.0.0">unified to v11</a> and the other remark/rehype packages to the latest version.</p> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="what-should-i-do-1">What should I do?</h4></div> <p>If you used custom remark/rehype packages, update all of them to the latest version using your package manager to ensure they support unified v11. The packages you are using can be found in <code dir="auto">astro.config.mjs</code>.</p> <p>There should not be any significant breaking changes if you use actively updated packages, but some packages may not yet be compatible with unified v11. Visually inspect your Markdown/MDX pages before deploying to ensure your site is functioning as intended.</p> <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="breaking-changes">Breaking Changes</h2></div> <p>The following changes are considered breaking changes in Astro. Breaking changes may or may not provide temporary backwards compatibility, and all documentation is updated to refer to only the current, supported code.</p> <p>If you need to refer to the documentation for a v3.x project, you can browse this <a href="https://docs-git-v3-docs-unmaintained-astrodotbuild.vercel.app/">(unmaintained) snapshot of the docs from before v4.0 was released</a>.</p> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="renamed-entrypoint-integrations-api">Renamed: <code dir="auto">entrypoint</code> (Integrations API)</h3></div> <p>In Astro v3.x, the property of the <code dir="auto">injectRoute</code> integrations API that specified the route entry point was named <code dir="auto">entryPoint</code>.</p> <p>Astro v4.0 renames this property to <code dir="auto">entrypoint</code> to be consistent with other Astro APIs. The <code dir="auto">entryPoint</code> property is deprecated but will continue to work and logs a warning prompting you to update your code.</p> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="what-should-i-do-2">What should I do?</h4></div> <p>If you have integrations that use the <code dir="auto">injectRoute</code> API, rename the <code dir="auto">entryPoint</code> property to <code dir="auto">entrypoint</code>. If you’re a library author who wants to support both Astro 3 and 4, you can specify both <code dir="auto">entryPoint</code> and <code dir="auto">entrypoint</code>, in which case, a warning will not be logged.</p> <div class="expressive-code">

<pre data-language="js">injectRoute({
  pattern: '/fancy-dashboard',
  entryPoint: '@fancy/dashboard/dashboard.astro'
  entrypoint: '@fancy/dashboard/dashboard.astro'
});</pre>

</div> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="changed-apprender-signature-in-integrations-api">Changed: <code dir="auto">app.render</code> signature in Integrations API</h3></div> <p>In Astro v3.0, the <code dir="auto">app.render()</code> method accepted <code dir="auto">routeData</code> and <code dir="auto">locals</code> as separate, optional arguments.</p> <p>Astro v4.0 changes the <code dir="auto">app.render()</code> signature. These two properties are now available in a single object. Both the object and these two properties are still optional.</p> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="what-should-i-do-3">What should I do?</h4></div> <p>If you are maintaining an adapter, the current signature will continue to work until the next major version. To migrate to the new signature, pass <code dir="auto">routeData</code> and <code dir="auto">locals</code> as properties of an object instead of as multiple independent arguments.</p> <div class="expressive-code">

<pre data-language="js">app.render(request, routeData, locals)
app.render(request, { routeData, locals })</pre>

</div> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="changed-adapters-must-now-specify-supported-features">Changed: adapters must now specify supported features</h3></div> <p>In Astro v3.x, adapters were not required to specify the features they support.</p> <p>Astro v4.0 requires adapters to pass the <code dir="auto">supportedAstroFeatures{}</code> property to specify a list of features they support. This property is no longer optional.</p> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="what-should-i-do-4">What should I do?</h4></div> <p>Adapter authors need to pass the <code dir="auto">supportedAstroFeatures{}</code> option to specify a list of features they support.</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">my-adapter.mjs</span></div>
<pre data-language="js">export default function createIntegration() {
  return {
    name: '@matthewp/my-adapter',
    hooks: {
      'astro:config:done': ({ setAdapter }) =&gt; {
        setAdapter({
          name: '@matthewp/my-adapter',
          serverEntrypoint: '@matthewp/my-adapter/server.js',
          supportedAstroFeatures: {
              staticOutput: 'stable'
          }
        });
      },
    },
  };
}</pre>

</div> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="removed-shiki-language-path-property">Removed: Shiki language <code dir="auto">path</code> property</h3></div> <p>In Astro v3.x, a Shiki language passed to <code dir="auto">markdown.shikiConfig.langs</code> was automatically converted to a Shikiji-compatible language. Shikiji is the internal tooling used by Astro for syntax highlighting.</p> <p>Astro v4.0 removes support for the <code dir="auto">path</code> property of a Shiki language, which was confusing to configure. It is replaced by an import which can be passed to <code dir="auto">langs</code> directly.</p> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="what-should-i-do-5">What should I do?</h4></div> <p>The language JSON file should be imported and passed to the option instead.</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">astro.config.js</span></div>
<pre data-language="js"> import customLang from './custom.tmLanguage.json'


export default defineConfig({
  markdown: {
    shikiConfig: {
      langs: [
       { path: '../../custom.tmLanguage.json' },
       customLang,
      ],
    },
  },
})</pre>

</div> <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="deprecated">Deprecated</h2></div> <p>The following deprecated features are no longer supported and are no longer documented. Please update your project accordingly.</p> <p>Some deprecated features may temporarily continue to function until they are completely removed. Others may silently have no effect, or throw an error prompting you to update your code.</p> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="deprecated-handleforms-for-view-transitions-submit-events">Deprecated: <code dir="auto">handleForms</code> for View Transitions <code dir="auto">submit</code> events</h3></div> <p>In Astro v3.x, projects using the <code dir="auto">&lt;ViewTransitions /&gt;</code> component were required to opt-in to handling <code dir="auto">submit</code> events for <code dir="auto">form</code> elements. This was done by passing a <code dir="auto">handleForms</code> prop.</p> <p>Astro v4.0 handles <code dir="auto">submit</code> events for <code dir="auto">form</code> elements by default when <code dir="auto">&lt;ViewTransitions /&gt;</code> are used. The <code dir="auto">handleForms</code> prop has been deprecated and no longer has any effect.</p> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="what-should-i-do-6">What should I do?</h4></div> <p>Remove the <code dir="auto">handleForms</code> property from your <code dir="auto">ViewTransitions</code> component. It is no longer necessary.</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">src/pages/index.astro</span></div>
<pre data-language="astro">---
import { ViewTransitions } from "astro:transitions";
---
&lt;html&gt;
  &lt;head&gt;
    &lt;ViewTransitions handleForms /&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;!-- stuff here --&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre>

</div> <p>To opt out of <code dir="auto">submit</code> event handling, add the <code dir="auto">data-astro-reload</code> attribute to relevant <code dir="auto">form</code> elements.</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">src/components/Form.astro</span></div>
<pre data-language="astro">&lt;form action="/contact" data-astro-reload&gt;
  &lt;!-- --&gt;
&lt;/form&gt;</pre>

</div> <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="previously-deprecated-features-now-removed">Previously deprecated features now removed</h2></div> <p>The following deprecated features have now been entirely removed from the code base and can no longer be used. Some of these features may have continued to work in your project even after deprecation. Others may have silently had no effect.</p> <p>Projects now containing these removed features will be unable to build, and there will no longer be any supporting documentation prompting you to remove these features.</p> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="removed-returning-simple-objects-from-endpoints">Removed: returning simple objects from endpoints</h3></div> <p>In Astro v3.x, returning simple objects from endpoints was deprecated, but was still supported to maintain compatibility with Astro v2. A <code dir="auto">ResponseWithEncoding</code> utility was also provided to ease the migration.</p> <p>Astro v4.0 removes support for simple objects and requires endpoints to always return a <code dir="auto">Response</code>. The <code dir="auto">ResponseWithEncoding</code> utility is also removed in favor of a proper <code dir="auto">Response</code> type.</p> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="what-should-i-do-7">What should I do?</h4></div> <p>Update your endpoints to return a <code dir="auto">Response</code> object directly.</p> <div class="expressive-code">

<pre data-language="ts">export async function GET() {
  return { body: { "title": "Bob's blog" }};
  return new Response(JSON.stringify({ "title": "Bob's blog" }));
}</pre>

</div> <p>To remove usage of <code dir="auto">ResponseWithEncoding</code>, refactor your code to use an <code dir="auto">ArrayBuffer</code> instead:</p> <div class="expressive-code">

<pre data-language="ts">export async function GET() {
  const file = await fs.readFile('./bob.png');
  return new ResponseWithEncoding(file.toString('binary'), undefined, 'binary');
  return new Response(file.buffer);
}</pre>

</div> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="removed-buildsplit-and-buildexcludemiddleware">Removed: <code dir="auto">build.split</code> and <code dir="auto">build.excludeMiddleware</code>
</h3></div> <p>In Astro v3.0, <code dir="auto">build.split</code> and <code dir="auto">build.excludeMiddleware</code> build config options were deprecated and replaced with <a href="../../../reference/adapter-reference/index.html#adapter-features">adapter configuration options</a> to perform the same tasks.</p> <p>Astro v4.0 removes these properties entirely.</p> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="what-should-i-do-8">What should I do?</h4></div> <p>If you are using the deprecated <code dir="auto">build.split</code> or <code dir="auto">build.excludeMiddleware</code>, you must now remove them as these no longer exist.</p> <p>Please see the v3 migration guide to <a href="../v3/index.html#deprecated-buildexcludemiddleware-and-buildsplit">update these deprecated middleware properties</a> with adapter configurations.</p> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="removed-astrorequestparams">Removed: <code dir="auto">Astro.request.params</code>
</h3></div> <p>In Astro v3.0, the <code dir="auto">Astro.request.params</code> API was deprecated, but preserved for backwards compatibility.</p> <p>Astro v4.0 removes this option entirely.</p> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="what-should-i-do-9">What should I do?</h4></div> <p>Update all occurrences to <a href="../../../reference/api-reference/index.html#astroparams"><code dir="auto">Astro.params</code></a>, which is the supported replacement.</p> <div class="expressive-code">

<pre data-language="astro">const { id } = Astro.request.params;
const { id } = Astro.params;</pre>

</div> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="removed-markdowndrafts">Removed: <code dir="auto">markdown.drafts</code>
</h3></div> <p>In Astro v3.0, using <code dir="auto">markdown.drafts</code> to control the building of draft posts was deprecated.</p> <p>Astro v4.0 removes this option entirely.</p> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="what-should-i-do-10">What should I do?</h4></div> <p>If you are using the deprecated <code dir="auto">markdown.drafts</code>, you must now remove it as it no longer exists.</p> <p>To continue to mark some pages in your project as drafts, <a href="../../content-collections/index.html#migrating-from-file-based-routing">migrate to content collections</a> and <a href="../../content-collections/index.html#filtering-collection-queries">manually filter out pages</a> with the <code dir="auto">draft: true</code> frontmatter property instead.</p> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="removed-getheaders">Removed: <code dir="auto">getHeaders()</code>
</h3></div> <p>In Astro v3.0, the <code dir="auto">getHeaders()</code> Markdown export was deprecated and replaced with <code dir="auto">getHeadings()</code>.</p> <p>Astro v4.0 removes this option entirely.</p> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="what-should-i-do-11">What should I do?</h4></div> <p>If you are using the deprecated <code dir="auto">getHeaders()</code>, you must now remove it as it no longer exists. Replace any instances with <code dir="auto">getHeadings()</code>, which is the supported replacement.</p> <div class="expressive-code">

<pre data-language="js">const posts = await Astro.glob('../content/blog/*.mdx');
const firstPostHeadings = posts.at(0).getHeaders();
const firstPostHeadings = posts.at(0).getHeadings();</pre>

</div> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="removed-using-rss-in-getstaticpaths">Removed: using <code dir="auto">rss</code> in <code dir="auto">getStaticPaths()</code>
</h3></div> <p>In Astro v3.0, using the deprecated <code dir="auto">rss</code> helper in <code dir="auto">getStaticPaths()</code> would throw an error.</p> <p>Astro v4.0 removes this helper entirely.</p> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="what-should-i-do-12">What should I do?</h4></div> <p>If you are using the unsupported method for generating RSS feeds, you must now use the <a href="../../rss/index.html"><code dir="auto">@astrojs/rss</code> integration</a> for a complete RSS setup.</p> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="removed-lowercase-http-method-names">Removed: lowercase HTTP method names</h3></div> <p>In Astro v3.0, using lowercase HTTP request method names (<code dir="auto">get</code>, <code dir="auto">post</code>, <code dir="auto">put</code>, <code dir="auto">all</code>, <code dir="auto">del</code>) was deprecated.</p> <p>Astro v4.0 removes support for lowercase names entirely. All HTTP request methods must now be written using uppercase.</p> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="what-should-i-do-13">What should I do?</h4></div> <p>If you are using the deprecated lowercase names, you must now replace them with their uppercase equivalents.</p> <p>Please see the v3 migration guide <a href="../v3/index.html#changed-http-request-methods-case">for guidance using uppercase HTTP request methods</a>.</p> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="removed-301-redirects-when-missing-a-base-prefix">Removed: 301 redirects when missing a <code dir="auto">base</code> prefix</h3></div> <p>In Astro v3.x, the Astro preview server returned a 301 redirect when accessing public directory assets without a base path.</p> <p>Astro v4.0 returns a 404 status without a base path prefix for public directory assets when the preview server is running, matching the behavior of the dev server.</p> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="what-should-i-do-14">What should I do?</h4></div> <p>When using the Astro preview server, all of your static asset imports and URLs from the public directory must have <a href="../../../reference/configuration-reference/index.html#base">the base value</a> prefixed to the path.</p> <p>The following example shows the <code dir="auto">src</code> attribute required to display an image from the public folder when <code dir="auto">base: '/docs'</code> is configured:</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">src/pages/index.astro</span></div>
<pre data-language="astro">// To access public/images/my-image.png:


&lt;img src="/docs/images/my-image.png" alt=""&gt;</pre>

</div> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="removed-astroclient-image-auto-conversion">Removed: <code dir="auto">astro/client-image</code> auto-conversion</h3></div> <p>In Astro v3.x, the <code dir="auto">astro/client-image</code> type (used for the deprecated image integration) was removed but was auto-converted to the default Astro type <code dir="auto">astro/client</code> if found in your <code dir="auto">env.d.ts</code> file.</p> <p>Astro v4.0 ignores <code dir="auto">astro/client-image</code> and will no longer update <code dir="auto">env.d.ts</code> for you automatically.</p> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="what-should-i-do-15">What should I do?</h4></div> <p>If you had types configured for <code dir="auto">@astrojs/image</code> in <code dir="auto">src/env.d.ts</code> and upgrading to v3.0 did not automatically convert the type for you, replace the <code dir="auto">astro/client-image</code> type manually with <code dir="auto">astro/client</code>.</p> <div class="expressive-code">
<div class="_pre-heading"><span class="title">src/env.d.ts</span></div>
<pre data-language="ts">  /// &lt;reference types="astro/client-image" /&gt;
  /// &lt;reference types="astro/client" /&gt;</pre>

</div> <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="community-resources">Community Resources</h2></div> <p>Know a good resource for Astro v4.0? <a href="https://github.com/withastro/docs/edit/main/src/content/docs/en/guides/upgrade-to/v4.mdx">Edit this page</a> and add a link below!</p> <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="known-issues">Known Issues</h2></div> <p>Please check <a href="https://github.com/withastro/astro/issues/">Astro’s issues on GitHub</a> for any reported issues, or to file an issue yourself.</p> <span id="docsearch-lvl0" hidden class="astro-klj6ju3r">Upgrade Guides</span> </div>   </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2021 Fred K. Schott<br>Licensed under the MIT License.<br>
    <a href="https://docs.astro.build/en/guides/upgrade-to/v4/" class="_attribution-link">https://docs.astro.build/en/guides/upgrade-to/v4/</a>
  </p>
</div>
