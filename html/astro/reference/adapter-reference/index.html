<h1 class="content-title astro-j75b3yus" id="overview">Astro Adapter API</h1> <p>Astro is designed to make it easy to deploy to any cloud provider for SSR (server-side rendering). This ability is provided by <strong>adapters</strong>, which are <a href="../integrations-reference/index.html">integrations</a>. See the <a href="../../guides/server-side-rendering/index.html#adding-an-adapter">SSR guide</a> to learn how to use an existing adapter.</p> <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="what-is-an-adapter">What is an adapter</h2></div> <p>An adapter is a special kind of <a href="../integrations-reference/index.html">integration</a> that provides an entrypoint for server-side rendering. An adapter does two things:</p> <ul> <li>Implements host-specific APIs for handling requests.</li> <li>Configures the build according to host conventions.</li> </ul> <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="building-an-adapter">Building an Adapter</h2></div> <p>An adapter is an <a href="../integrations-reference/index.html">integration</a> and can do anything that an integration can do.</p> <p>An adapter <strong>must</strong> call the <code>setAdapter</code> API in the <code>astro:config:done</code> hook like so:</p> <div class="expressive-code ec ec-s1gwf">
<div class="_pre-heading"><span class="title">my-adapter.mjs</span></div>


</div> <p>The object passed into <code>setAdapter</code> is defined as:</p>  <p>The properties are:</p> <ul> <li>
<strong>name</strong>: A unique name for your adapter, used for logging.</li> <li>
<strong>serverEntrypoint</strong>: The entrypoint for server-side rendering.</li> <li>
<strong>exports</strong>: An array of named exports when used in conjunction with <code>createExports</code> (explained below).</li> <li>
<strong>adapterFeatures</strong>: An object that enables specific features that must be supported by the adapter. These features will change the built output, and the adapter must implement the proper logic to handle the different output.</li> <li>
<strong>supportedAstroFeatures</strong>: A map of Astro built-in features. This allows Astro to determine which features an adapter is unable or unwilling to support so appropriate error messages can be provided.</li> </ul> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="server-entrypoint">Server Entrypoint</h3></div> <p>Astro’s adapter API attempts to work with any type of host, and gives a flexible way to conform to the host APIs.</p> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="exports">Exports</h4></div> <p>Some serverless hosts expect you to export a function, such as <code>handler</code>:</p> <div class="expressive-code ec ec-s1gwf">
<div class="_pre-heading"><span class="title">...</span></div>


</div> <p>With the adapter API you achieve this by implementing <code>createExports</code> in your <code>serverEntrypoint</code>:</p>  <p>And then in your integration, where you call <code>setAdapter</code>, provide this name in <code>exports</code>:</p> <div class="expressive-code ec ec-s1gwf">
<div class="_pre-heading"><span class="title">my-adapter.mjs</span></div>


</div> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="start">Start</h4></div> <p>Some hosts expect you to <em>start</em> the server yourselves, for example by listening to a port. For these types of hosts, the adapter API allows you to export a <code>start</code> function which will be called when the bundle script is run.</p>  <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="astroapp"><code>astro/app</code></h4></div> <p>This module is used for rendering pages that have been prebuilt through <code>astro build</code>. Astro uses the standard <a href="https://developer.mozilla.org/en-US/docs/Web/API/Request">Request</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/API/Response">Response</a> objects. Hosts that have a different API for request/response should convert to these types in their adapter.</p>  <p>The following methods are provided:</p> <div tabindex="-1" class="heading-wrapper level-h5"><h5 id="apprenderrequest-routedata-locals"><code>app.render(request, routeData, locals)</code></h5></div> <p>This method calls the Astro page that matches the request, renders it, and returns a Promise to a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Response">Response</a> object. This also works for API routes that do not render pages.</p>  <p>The method accepts a mandatory <code>request</code> argument, and two other optional arguments: <a href="../integrations-reference/index.html#routedata-type-reference"><code>routeData</code></a> and <a href="../../guides/middleware/index.html#locals"><code>locals</code></a>.</p> <p>Provide a value for <code>routeData</code> if you already know the route to render. Doing so will bypass the internal call to <a href="#appmatchrequest"><code>app.match</code></a> to determine the route to render.</p> <p>When used, <code>locals</code> must be the third argument passed. You can pass <code>undefined</code> for <code>routeData</code> if you are not targeting a specific route.</p> <p>The example below reads a header named <code>x-private-header</code>, attempts to parse it as an object and pass it to <code>locals</code>, which can then be passed to any <a href="../../guides/middleware/index.html">middleware function</a>.</p>  <div tabindex="-1" class="heading-wrapper level-h5"><h5 id="appmatchrequest"><code>app.match(request)</code></h5></div> <p>This method is used to determine if a request is matched by the Astro app’s routing rules.</p>  <p>You can usually call <code>app.render(request)</code> without using <code>.match</code> because Astro handles 404s if you provide a <code>404.astro</code> file. Use <code>app.match(request)</code> if you want to handle 404s in a different way.</p> <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="allow-installation-via-astro-add">Allow installation via <code>astro add</code>
</h2></div> <p><a href="../cli-reference/index.html#astro-add">The <code>astro add</code> command</a> allows users to easily add integrations and adapters to their project. If you want <em>your</em> adapter to be installable with this tool, <strong>add <code>astro-adapter</code> to the <code>keywords</code> field in your <code>package.json</code></strong>:</p>  <p>Once you <a href="https://docs.npmjs.com/cli/v8/commands/npm-publish">publish your adapter to npm</a>, running <code>astro add example</code> will install your package with any peer dependencies specified in your <code>package.json</code>. We will also instruct users to update their project config manually.</p> <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="astro-features">Astro features</h2></div> <span> <strong>Added in:</strong> <code>astro@3.0.0</code> </span> <p>Astro features are a way for an adapter to tell Astro whether they are able to support a feature, and also the adapter’s level of support.</p> <p>When using these properties, Astro will:</p> <ul> <li>run specific validation;</li> <li>emit contextual to the logs;</li> </ul> <p>These operations are run based on the features supported or not supported, their level of support, and the configuration that the user uses.</p> <p>The following configuration tells Astro that this adapter has experimental support for assets, but the adapter is not compatible with the built-in services Sharp and Squoosh:</p> <div class="expressive-code ec ec-s1gwf">
<div class="_pre-heading"><span class="title">my-adapter.mjs</span></div>


</div> <p>Astro will log a <strong>warning</strong> to the terminal:</p>  <p>and an error if the service used for assets is not compatible with the adapter:</p>  <div tabindex="-1" class="heading-wrapper level-h2"><h2 id="adapter-features">Adapter features</h2></div> <p>A set of features that changes the output of the emitted files. When an adapter opts in to these features, they will get additional information inside specific hooks.</p> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="functionperroute"><code>functionPerRoute</code></h3></div> <p>This is a feature that is enabled when using SSR only. By default, Astro emits a single <code>entry.mjs</code> file, which is responsible for emitting the rendered page on each request.</p> <p>When <code>functionPerRoute</code> is <code>true</code>, Astro will instead create a separate file for each route defined in the project.</p> <p>Each file emitted will only render one page. The pages will be emitted inside a <code>dist/pages/</code> directory (or under a <code>/pages/</code> directory in the directory specified for <a href="../configuration-reference/index.html#outdir"><code>outDir</code></a>), and the emitted files will keep the same file paths of the <code>src/pages/</code> directory.</p> <p>The files inside the <code>pages/</code> directory of the build will mirror the directory structure of your page files in <code>src/pages/</code>, for example:</p> <docs-file-tree><ul><li class="directory" data-filetype="dir"><details open><summary><span class="tree-entry"><span class=""><span><span class="sr-only">Directory</span></span>dist/ </span> </span></summary><ul><li class="directory" data-filetype="dir"><details open><summary><span class="tree-entry"><span class=""><span><span class="sr-only">Directory</span></span>pages/ </span> </span></summary><ul>
<li class="directory" data-filetype="dir"><details open><summary><span class="tree-entry"><span class=""><span><span class="sr-only">Directory</span></span>blog/ </span> </span></summary><ul>
<li class="file" data-filetype="mjs"><span class="tree-entry"><span class="">entry._slug_.astro.mjs</span> </span></li>
<li class="file" data-filetype="mjs"><span class="tree-entry"><span class="">entry.about.astro.mjs</span> </span></li>
</ul></details></li>
<li class="file" data-filetype="mjs"><span class="tree-entry"><span class="">entry.index.astro.mjs</span> </span></li>
</ul></details></li></ul></details></li></ul></docs-file-tree> <p>Enable the feature by passing <code>true</code> to the adapter.</p> <div class="expressive-code ec ec-s1gwf">
<div class="_pre-heading"><span class="title">my-adapter.mjs</span></div>


</div> <p>Then, consume the hook <a href="../integrations-reference/index.html#astrobuildssr"><code>astro:build:ssr</code></a>, which will give you an <code>entryPoints</code> object that maps a page route to the physical file emitted after the build.</p> <div class="expressive-code ec ec-s1gwf">
<div class="_pre-heading"><span class="title">my-adapter.mjs</span></div>


</div> <aside class="content caution astro-duqfclob" aria-label="Caution"> <p class="title astro-duqfclob" aria-hidden="true">  Caution </p> <section class="astro-duqfclob"> <p>The <code>entryFile</code> is of type <code>URL</code> and represents the physical path of the file in the file system. This means that the paths change based on the OS where the code runs.</p> </section> </aside> <div tabindex="-1" class="heading-wrapper level-h4"><h4 id="serverless-environments">Serverless environments</h4></div> <p>Setting <code>functionPerRoute: true</code> in a serverless environment creates a JavaScript file (handler) for each route. A handler might have different names based on your hosting platform: lambda, function, page, etc.</p> <p>Each of these routes is subject to a <a href="https://azure.microsoft.com/en-us/blog/understanding-serverless-cold-start/">cold start</a> when the handler runs, which may cause some delay. This delay is influenced by different factors.</p> <p>With <code>functionPerRoute: false</code>, there is only one single handler in charge of rendering all your routes. When this handler is first triggered, you will be subject to a cold start. Then, all other routes should function without delay. However, you will lose the benefit of code splitting that <code>functionPerRoute: true</code> provides.</p> <aside class="content note astro-duqfclob" aria-label="Note"> <p class="title astro-duqfclob" aria-hidden="true">  Note </p> <section class="astro-duqfclob"> <p>It’s important that you understand your hosting platform, and how it works, in order to choose the appropriate <code>functionPerRoute</code> configuration for your project.</p> </section> </aside> <div tabindex="-1" class="heading-wrapper level-h3"><h3 id="edgemiddleware"><code>edgeMiddleware</code></h3></div> <p>Defines whether any SSR middleware code will be bundled when built.</p> <p>When enabled, this prevents middleware code from being bundled and imported by all pages during the build:</p> <div class="expressive-code ec ec-s1gwf">
<div class="_pre-heading"><span class="title">my-adapter.mjs</span></div>


</div> <p>Then, consume the hook <a href="../integrations-reference/index.html#astrobuildssr"><code>astro:build:ssr</code></a>, which will give you a <code>middlewareEntryPoint</code>, an <code>URL</code> to the physical file on the file system.</p> <div class="expressive-code ec ec-s1gwf">
<div class="_pre-heading"><span class="title">my-adapter.mjs</span></div>


</div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2021 Fred K. Schott<br>Licensed under the MIT License.<br>
    <a href="https://docs.astro.build/en/reference/adapter-reference/" class="_attribution-link">https://docs.astro.build/en/reference/adapter-reference/</a>
  </p>
</div>
