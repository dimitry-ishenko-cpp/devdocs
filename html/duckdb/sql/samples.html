<h1 class="title">Samples</h1>  <p>Samples are used to randomly select a subset of a dataset.</p> <h3 id="examples"> <a style="text-decoration: none;" href="#examples">Examples</a> </h3> <p>Select a sample of 5 rows from <code class="language-plaintext highlighter-rouge">tbl</code> using reservoir sampling:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM tbl
USING SAMPLE 5;</pre> <p>Select a sample of 10% of the table using system sampling (cluster sampling):</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM tbl
USING SAMPLE 10%;</pre> <p>Select a sample of 10% of the table using bernoulli sampling:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM tbl
USING SAMPLE 10 PERCENT (bernoulli);</pre> <p>Select a sample of 50 rows of the table using reservoir sampling with a fixed seed (100):</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM tbl
USING SAMPLE reservoir(50 ROWS)
REPEATABLE (100);</pre> <p>Select a sample of 20% of the table using system sampling with a fixed seed (377):</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM tbl
USING SAMPLE 20% (system, 377);</pre> <p>Select a sample of 20% of <code class="language-plaintext highlighter-rouge">tbl</code> <strong>before</strong> the join with <code class="language-plaintext highlighter-rouge">tbl2</code>:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM tbl TABLESAMPLE reservoir(20%), tbl2
WHERE tbl.i = tbl2.i;</pre> <p>Select a sample of 20% of <code class="language-plaintext highlighter-rouge">tbl</code> <strong>after</strong> the join with <code class="language-plaintext highlighter-rouge">tbl2</code>:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM tbl, tbl2
WHERE tbl.i = tbl2.i
USING SAMPLE reservoir(20%);</pre> <h3 id="syntax"> <a style="text-decoration: none;" href="#syntax">Syntax</a> </h3>  <p>Samples allow you to randomly extract a subset of a dataset. Samples are useful for exploring a dataset faster, as often you might not be interested in the exact answers to queries, but only in rough indications of what the data looks like and what is in the data. Samples allow you to get approximate answers to queries faster, as they reduce the amount of data that needs to pass through the query engine.</p> <p>DuckDB supports three different types of sampling methods: <code class="language-plaintext highlighter-rouge">reservoir</code>, <code class="language-plaintext highlighter-rouge">bernoulli</code> and <code class="language-plaintext highlighter-rouge">system</code>. By default, DuckDB uses <code class="language-plaintext highlighter-rouge">reservoir</code> sampling when an exact number of rows is sampled, and <code class="language-plaintext highlighter-rouge">system</code> sampling when a percentage is specified. The sampling methods are described in detail below.</p> <p>Samples require a <em>sample size</em>, which is an indication of how many elements will be sampled from the total population. Samples can either be given as a percentage (<code class="language-plaintext highlighter-rouge">10%</code>) or as a fixed number of rows (<code class="language-plaintext highlighter-rouge">10 rows</code>). All three sampling methods support sampling over a percentage, but <strong>only</strong> reservoir sampling supports sampling a fixed number of rows.</p> <p>Samples are probablistic, that is to say, samples can be different between runs <em>unless</em> the seed is specifically specified. Specifying the seed <em>only</em> guarantees that the sample is the same if multi-threading is not enabled (i.e., <code class="language-plaintext highlighter-rouge">SET threads = 1</code>). In the case of multiple threads running over a sample, samples are not necessarily consistent even with a fixed seed.</p> <h3 id="reservoir"> <a style="text-decoration: none;" href="#reservoir"><code class="language-plaintext highlighter-rouge">reservoir</code></a> </h3> <p>Reservoir sampling is a stream sampling technique that selects a random sample by keeping a <em>reservoir</em> of size equal to the sample size, and randomly replacing elements as more elements come in. Reservoir sampling allows us to specify <em>exactly</em> how many elements we want in the resulting sample (by selecting the size of the reservoir). As a result, reservoir sampling <em>always</em> outputs the same amount of elements, unlike system and bernoulli sampling.</p> <p>Reservoir sampling is only recommended for small sample sizes, and is not recommended for use with percentages. That is because reservoir sampling needs to materialize the entire sample and randomly replace tuples within the materialized sample. The larger the sample size, the higher the performance hit incurred by this process.</p> <p>Reservoir sampling also incurs an additional performance penalty when multi-processing is used, since the reservoir is to be shared amongst the different threads to ensure unbiased sampling. This is not a big problem when the reservoir is very small, but becomes costly when the sample is large.</p> <blockquote> <p>Bestpractice Avoid using reservoir sampling with large sample sizes if possible. Reservoir sampling requires the entire sample to be materialized in memory.</p> </blockquote> <h3 id="bernoulli"> <a style="text-decoration: none;" href="#bernoulli"><code class="language-plaintext highlighter-rouge">bernoulli</code></a> </h3> <p>Bernoulli sampling can only be used when a sampling percentage is specified. It is rather straightforward: every tuple in the underlying table is included with a chance equal to the specified percentage. As a result, bernoulli sampling can return a different number of tuples even if the same percentage is specified. The amount of rows will generally be more or less equal to the specified percentage of the table, but there will be some variance.</p> <p>Because bernoulli sampling is completely independent (there is no shared state), there is no penalty for using bernoulli sampling together with multiple threads.</p> <h3 id="system"> <a style="text-decoration: none;" href="#system"><code class="language-plaintext highlighter-rouge">system</code></a> </h3> <p>System sampling is a variant of bernoulli sampling with one crucial difference: every <em>vector</em> is included with a chance equal to the sampling percentage. This is a form of cluster sampling. System sampling is more efficient than bernoulli sampling, as no per-tuple selections have to be performed. There is almost no extra overhead for using system sampling, whereas bernoulli sampling can add additional cost as it has to perform random number generation for every single tuple.</p> <p>System sampling is not suitable for smaller data sets as the granularity of the sampling is on the order of ~1000 tuples. That means that if system sampling is used for small data sets (e.g., 100 rows) either all the data will be filtered out, or all the data will be included.</p> <h2 id="table-samples"> <a style="text-decoration: none;" href="#table-samples">Table Samples</a> </h2> <p>The <code class="language-plaintext highlighter-rouge">TABLESAMPLE</code> and <code class="language-plaintext highlighter-rouge">USING SAMPLE</code> clauses are identical in terms of syntax and effect, with one important difference: tablesamples sample directly from the table for which they are specified, whereas the sample clause samples after the entire from clause has been resolved. This is relevant when there are joins present in the query plan.</p> <p>The <code class="language-plaintext highlighter-rouge">TABLESAMPLE</code> clause is essentially equivalent to creating a subquery with the <code class="language-plaintext highlighter-rouge">USING SAMPLE</code> clause, i.e., the following two queries are identical:</p> <p>Sample 20% of <code class="language-plaintext highlighter-rouge">tbl</code> <strong>before</strong> the join:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT * FROM tbl TABLESAMPLE reservoir(20%), tbl2 WHERE tbl.i = tbl2.i;</pre> <p>Sample 20% of <code class="language-plaintext highlighter-rouge">tbl</code> <strong>before</strong> the join:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM (SELECT * FROM tbl USING SAMPLE reservoir(20%)) tbl, tbl2
WHERE tbl.i = tbl2.i;</pre> <p>Sample 20% <strong>after</strong> the join (i.e., sample 20% of the join result):</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM tbl, tbl2
WHERE tbl.i = tbl2.i
USING SAMPLE reservoir(20%);</pre><div class="_attribution">
  <p class="_attribution-p">
    &copy; Copyright 2018&ndash;2024 Stichting DuckDB Foundation<br>Licensed under the MIT License.<br>
    <a href="https://duckdb.org/docs/sql/samples.html" class="_attribution-link">https://duckdb.org/docs/sql/samples.html</a>
  </p>
</div>
