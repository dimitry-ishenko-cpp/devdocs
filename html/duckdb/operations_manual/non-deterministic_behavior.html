<h1 class="title">Non-Deterministic Behavior</h1>  <p>Several operators in DuckDB exhibit non-deterministic behavior. Most notably, SQL uses set semantics, which allows results to be returned in a different order. DuckDB exploits this to improve performance, particularly when performing multi-threaded query execution. Other factors, such as using different compilers, operating systems, and hardware architectures, can also cause changes in ordering. This page documents the cases where non-determinism is an <em>expected behavior</em>. If you would like to make your queries determinisic, see the <a href="#working-around-non-determinism">“Working Around Non-Determinism” section</a>.</p> <h2 id="set-semantics"> <a style="text-decoration: none;" href="#set-semantics">Set Semantics</a> </h2> <p>One of the most common sources of non-determinism is the set semantics used by SQL. E.g., if you run the following query repeatedly, you may get two different results:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM (
    SELECT 'A' AS x
    UNION
    SELECT 'B' AS x
);</pre> <p>Both results <code class="language-plaintext highlighter-rouge">A</code>, <code class="language-plaintext highlighter-rouge">B</code> and <code class="language-plaintext highlighter-rouge">B</code>, <code class="language-plaintext highlighter-rouge">A</code> are correct.</p> <h2 id="different-results-on-different-platforms-array_distinct"> <a style="text-decoration: none;" href="#different-results-on-different-platforms-array_distinct">Different Results on Different Platforms: <code class="language-plaintext highlighter-rouge">array_distinct</code></a> </h2> <p>The <code class="language-plaintext highlighter-rouge">array_distinct</code> function may return results <a href="https://github.com/duckdb/duckdb/issues/13746">in a different order on different platforms</a>:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT array_distinct(['A', 'A', 'B', NULL, NULL]) AS arr;</pre> <p>For this query, both <code class="language-plaintext highlighter-rouge">[A, B]</code> and <code class="language-plaintext highlighter-rouge">[B, A]</code> are valid results.</p> <h2 id="floating-point-aggregate-operations-with-multi-threading"> <a style="text-decoration: none;" href="#floating-point-aggregate-operations-with-multi-threading">Floating-Point Aggregate Operations with Multi-Threading</a> </h2> <p>Floating-point inaccuracies may produce different results when run in a multi-threaded configurations: For example, <a href="https://github.com/duckdb/duckdb/issues/13763"><code class="language-plaintext highlighter-rouge">stddev</code> and <code class="language-plaintext highlighter-rouge">corr</code> may produce non-deterministic results</a>:</p> <pre class="language-sql highlighter-rouge" data-language="sql">CREATE TABLE tbl AS
    SELECT 'ABCDEFG'[floor(random() * 7 + 1)::INT] AS s, 3.7 AS x, i AS y
    FROM range(1, 1_000_000) r(i);

SELECT s, stddev(x) AS standard_deviation, corr(x, y) AS correlation FROM tbl
GROUP BY s
ORDER BY s;</pre> <p>The expected standard deviations and correlations from this query are 0 for all values of <code class="language-plaintext highlighter-rouge">s</code>. However, when executed on multiple threads, the query may return small numbers (<code class="language-plaintext highlighter-rouge">0 &lt;= z &lt; 10e-16</code>) due to floating-point inaccuracies.</p> <h2 id="working-around-non-determinism"> <a style="text-decoration: none;" href="#working-around-non-determinism">Working Around Non-Determinism</a> </h2> <p>For the majority of use cases, non-determinism is not causing any issues. However, there are some cases where deterministic results are desirable. In these cases, try the following workarounds:</p> <ol> <li> <p>Limit the number of threads to prevent non-determinism introduced by multi-threading.</p> <pre class="language-sql highlighter-rouge" data-language="sql">SET threads = 1;</pre> </li> <li> <p>Enforce ordering. For example, you can use the <a href="../sql/query_syntax/orderby.html#order-by-all.html"><code class="language-plaintext highlighter-rouge">ORDER BY ALL</code> clause</a>:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM (
    SELECT 'A' AS x
    UNION
    SELECT 'B' AS x
)
ORDER BY ALL;</pre> <p>You can also sort lists using <a href="../sql/functions/list.html#list_sortlist.html"><code class="language-plaintext highlighter-rouge">list_sort</code></a>:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT list_sort(array_distinct(['A', 'A', 'B', NULL, NULL])) AS i
ORDER BY i;</pre> <p>It's also possible to introduce a <a href="http://localhost:8000/2024/08/19/duckdb-tricks-part-1.html#shuffling-data">deterministic shuffling</a>.</p> </li> </ol><div class="_attribution">
  <p class="_attribution-p">
    &copy; Copyright 2018&ndash;2024 Stichting DuckDB Foundation<br>Licensed under the MIT License.<br>
    <a href="https://duckdb.org/docs/operations_manual/non-deterministic_behavior.html" class="_attribution-link">https://duckdb.org/docs/operations_manual/non-deterministic_behavior.html</a>
  </p>
</div>
