<h1 class="title">AsOf Join</h1>  <h2 id="what-is-an-asof-join"> <a style="text-decoration: none;" href="#what-is-an-asof-join">What is an AsOf Join?</a> </h2> <p>Time series data is not always perfectly aligned. Clocks may be slightly off, or there may be a delay between cause and effect. This can make connecting two sets of ordered data challenging. AsOf joins are a tool for solving this and other similar problems.</p> <p>One of the problems that AsOf joins are used to solve is finding the value of a varying property at a specific point in time. This use case is so common that it is where the name came from:</p> <p><em>Give me the value of the property <strong>as of this time</strong></em>.</p> <p>More generally, however, AsOf joins embody some common temporal analytic semantics, which can be cumbersome and slow to implement in standard SQL.</p> <h2 id="portfolio-example-data-set"> <a style="text-decoration: none;" href="#portfolio-example-data-set">Portfolio Example Data Set</a> </h2> <p>Let's start with a concrete example. Suppose we have a table of stock <a href="http://localhost:8000/data/prices.csv"><code class="language-plaintext highlighter-rouge">prices</code></a> with timestamps:</p>  <table> <thead> <tr> <th style="text-align: left">ticker</th> <th style="text-align: left">when</th> <th style="text-align: right">price</th> </tr> </thead> <tbody> <tr> <td style="text-align: left">APPL</td> <td style="text-align: left">2001-01-01 00:00:00</td> <td style="text-align: right">1</td> </tr> <tr> <td style="text-align: left">APPL</td> <td style="text-align: left">2001-01-01 00:01:00</td> <td style="text-align: right">2</td> </tr> <tr> <td style="text-align: left">APPL</td> <td style="text-align: left">2001-01-01 00:02:00</td> <td style="text-align: right">3</td> </tr> <tr> <td style="text-align: left">MSFT</td> <td style="text-align: left">2001-01-01 00:00:00</td> <td style="text-align: right">1</td> </tr> <tr> <td style="text-align: left">MSFT</td> <td style="text-align: left">2001-01-01 00:01:00</td> <td style="text-align: right">2</td> </tr> <tr> <td style="text-align: left">MSFT</td> <td style="text-align: left">2001-01-01 00:02:00</td> <td style="text-align: right">3</td> </tr> <tr> <td style="text-align: left">GOOG</td> <td style="text-align: left">2001-01-01 00:00:00</td> <td style="text-align: right">1</td> </tr> <tr> <td style="text-align: left">GOOG</td> <td style="text-align: left">2001-01-01 00:01:00</td> <td style="text-align: right">2</td> </tr> <tr> <td style="text-align: left">GOOG</td> <td style="text-align: left">2001-01-01 00:02:00</td> <td style="text-align: right">3</td> </tr> </tbody> </table> <p>We have another table containing portfolio <a href="http://localhost:8000/data/holdings.csv"><code class="language-plaintext highlighter-rouge">holdings</code></a> at various points in time:</p>  <table> <thead> <tr> <th style="text-align: left">ticker</th> <th style="text-align: left">when</th> <th style="text-align: right">shares</th> </tr> </thead> <tbody> <tr> <td style="text-align: left">APPL</td> <td style="text-align: left">2000-12-31 23:59:30</td> <td style="text-align: right">5.16</td> </tr> <tr> <td style="text-align: left">APPL</td> <td style="text-align: left">2001-01-01 00:00:30</td> <td style="text-align: right">2.94</td> </tr> <tr> <td style="text-align: left">APPL</td> <td style="text-align: left">2001-01-01 00:01:30</td> <td style="text-align: right">24.13</td> </tr> <tr> <td style="text-align: left">GOOG</td> <td style="text-align: left">2000-12-31 23:59:30</td> <td style="text-align: right">9.33</td> </tr> <tr> <td style="text-align: left">GOOG</td> <td style="text-align: left">2001-01-01 00:00:30</td> <td style="text-align: right">23.45</td> </tr> <tr> <td style="text-align: left">GOOG</td> <td style="text-align: left">2001-01-01 00:01:30</td> <td style="text-align: right">10.58</td> </tr> <tr> <td style="text-align: left">DATA</td> <td style="text-align: left">2000-12-31 23:59:30</td> <td style="text-align: right">6.65</td> </tr> <tr> <td style="text-align: left">DATA</td> <td style="text-align: left">2001-01-01 00:00:30</td> <td style="text-align: right">17.95</td> </tr> <tr> <td style="text-align: left">DATA</td> <td style="text-align: left">2001-01-01 00:01:30</td> <td style="text-align: right">18.37</td> </tr> </tbody> </table> <p>To load these tables to DuckDB, run:</p> <pre class="language-sql highlighter-rouge" data-language="sql">CREATE TABLE prices AS FROM 'https://duckdb.org/data/prices.csv';
CREATE TABLE holdings AS FROM 'https://duckdb.org/data/holdings.csv';</pre> <h2 id="inner-asof-joins"> <a style="text-decoration: none;" href="#inner-asof-joins">Inner AsOf Joins</a> </h2> <p>We can compute the value of each holding at that point in time by finding the most recent price before the holding's timestamp by using an AsOf Join:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT h.ticker, h.when, price * shares AS value
FROM holdings h
ASOF JOIN prices p
       ON h.ticker = p.ticker
      AND h.when &gt;= p.when;</pre> <p>This attaches the value of the holding at that time to each row:</p>  <table> <thead> <tr> <th style="text-align: left">ticker</th> <th style="text-align: left">when</th> <th style="text-align: right">value</th> </tr> </thead> <tbody> <tr> <td style="text-align: left">APPL</td> <td style="text-align: left">2001-01-01 00:00:30</td> <td style="text-align: right">2.94</td> </tr> <tr> <td style="text-align: left">APPL</td> <td style="text-align: left">2001-01-01 00:01:30</td> <td style="text-align: right">48.26</td> </tr> <tr> <td style="text-align: left">GOOG</td> <td style="text-align: left">2001-01-01 00:00:30</td> <td style="text-align: right">23.45</td> </tr> <tr> <td style="text-align: left">GOOG</td> <td style="text-align: left">2001-01-01 00:01:30</td> <td style="text-align: right">21.16</td> </tr> </tbody> </table> <p>It essentially executes a function defined by looking up nearby values in the <code class="language-plaintext highlighter-rouge">prices</code> table. Note also that missing <code class="language-plaintext highlighter-rouge">ticker</code> values do not have a match and don't appear in the output.</p> <h2 id="outer-asof-joins"> <a style="text-decoration: none;" href="#outer-asof-joins">Outer AsOf Joins</a> </h2> <p>Because AsOf produces at most one match from the right hand side, the left side table will not grow as a result of the join, but it could shrink if there are missing times on the right. To handle this situation, you can use an <em>outer</em> AsOf Join:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT h.ticker, h.when, price * shares AS value
FROM holdings h
ASOF LEFT JOIN prices p
            ON h.ticker = p.ticker
           AND h.when &gt;= p.when
ORDER BY ALL;</pre> <p>As you might expect, this will produce <code class="language-plaintext highlighter-rouge">NULL</code> prices and values instead of dropping left side rows when there is no ticker or the time is before the prices begin.</p>  <table> <thead> <tr> <th style="text-align: left">ticker</th> <th style="text-align: left">when</th> <th style="text-align: right">value</th> </tr> </thead> <tbody> <tr> <td style="text-align: left">APPL</td> <td style="text-align: left">2000-12-31 23:59:30</td> <td style="text-align: right"> </td> </tr> <tr> <td style="text-align: left">APPL</td> <td style="text-align: left">2001-01-01 00:00:30</td> <td style="text-align: right">2.94</td> </tr> <tr> <td style="text-align: left">APPL</td> <td style="text-align: left">2001-01-01 00:01:30</td> <td style="text-align: right">48.26</td> </tr> <tr> <td style="text-align: left">GOOG</td> <td style="text-align: left">2000-12-31 23:59:30</td> <td style="text-align: right"> </td> </tr> <tr> <td style="text-align: left">GOOG</td> <td style="text-align: left">2001-01-01 00:00:30</td> <td style="text-align: right">23.45</td> </tr> <tr> <td style="text-align: left">GOOG</td> <td style="text-align: left">2001-01-01 00:01:30</td> <td style="text-align: right">21.16</td> </tr> <tr> <td style="text-align: left">DATA</td> <td style="text-align: left">2000-12-31 23:59:30</td> <td style="text-align: right"> </td> </tr> <tr> <td style="text-align: left">DATA</td> <td style="text-align: left">2001-01-01 00:00:30</td> <td style="text-align: right"> </td> </tr> <tr> <td style="text-align: left">DATA</td> <td style="text-align: left">2001-01-01 00:01:30</td> <td style="text-align: right"> </td> </tr> </tbody> </table> <h2 id="asof-joins-with-the-using-keyword"> <a style="text-decoration: none;" href="#asof-joins-with-the-using-keyword">AsOf Joins with the <code class="language-plaintext highlighter-rouge">USING</code> Keyword</a> </h2> <p>So far we have been explicit about specifying the conditions for AsOf, but SQL also has a simplified join condition syntax for the common case where the column names are the same in both tables. This syntax uses the <code class="language-plaintext highlighter-rouge">USING</code> keyword to list the fields that should be compared for equality. AsOf also supports this syntax, but with two restrictions:</p> <ul> <li>The last field is the inequality</li> <li>The inequality is <code class="language-plaintext highlighter-rouge">&gt;=</code> (the most common case)</li> </ul> <p>Our first query can then be written as:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT ticker, h.when, price * shares AS value
FROM holdings h
ASOF JOIN prices p USING (ticker, "when");</pre> <h3 id="clarification-on-column-selection-with-using-in-asof-joins"> <a style="text-decoration: none;" href="#clarification-on-column-selection-with-using-in-asof-joins">Clarification on Column Selection with <code class="language-plaintext highlighter-rouge">USING</code> in ASOF Joins</a> </h3> <p>When you use the <code class="language-plaintext highlighter-rouge">USING</code> keyword in a join, the columns specified in the <code class="language-plaintext highlighter-rouge">USING</code> clause are merged in the result set. This means that if you run:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM holdings h
ASOF JOIN prices p USING (ticker, "when");</pre> <p>You will get back only the columns <code class="language-plaintext highlighter-rouge">h.ticker, h.when, h.shares, p.price</code>. The columns <code class="language-plaintext highlighter-rouge">ticker</code> and <code class="language-plaintext highlighter-rouge">when</code> will appear only once, with <code class="language-plaintext highlighter-rouge">ticker</code> and <code class="language-plaintext highlighter-rouge">when</code> coming from the left table (holdings).</p> <p>This behavior is fine for the <code class="language-plaintext highlighter-rouge">ticker</code> column because the value is the same in both tables. However, for the <code class="language-plaintext highlighter-rouge">when</code> column, the values might differ between the two tables due to the <code class="language-plaintext highlighter-rouge">&gt;=</code> condition used in the AsOf join. The AsOf join is designed to match each row in the left table (<code class="language-plaintext highlighter-rouge">holdings</code>) with the nearest preceding row in the right table (<code class="language-plaintext highlighter-rouge">prices</code>) based on the <code class="language-plaintext highlighter-rouge">when</code> column.</p> <p>If you want to retrieve the <code class="language-plaintext highlighter-rouge">when</code> column from both tables to see both timestamps, you need to list the columns explicitly rather than relying on <code class="language-plaintext highlighter-rouge">*</code>, like so:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT h.ticker, h.when AS holdings_when, p.when AS prices_when, h.shares, p.price
FROM holdings h
ASOF JOIN prices p USING (ticker, "when");</pre> <p>This ensures that you get the complete information from both tables, avoiding any potential confusion caused by the default behavior of the <code class="language-plaintext highlighter-rouge">USING</code> keyword.</p> <h2 id="see-also"> <a style="text-decoration: none;" href="#see-also">See Also</a> </h2> <p>For implementation details, see the <a href="http://localhost:8000/2023/09/15/asof-joins-fuzzy-temporal-lookups">blog post “DuckDB's AsOf joins: Fuzzy Temporal Lookups”</a>.</p><div class="_attribution">
  <p class="_attribution-p">
    &copy; Copyright 2018&ndash;2024 Stichting DuckDB Foundation<br>Licensed under the MIT License.<br>
    <a href="https://duckdb.org/docs/guides/sql_features/asof_join.html" class="_attribution-link">https://duckdb.org/docs/guides/sql_features/asof_join.html</a>
  </p>
</div>
