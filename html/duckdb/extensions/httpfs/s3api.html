<h1 class="title">S3 API Support</h1>  <p>The <code class="language-plaintext highlighter-rouge">httpfs</code> extension supports reading/writing/<a href="#globbing">globbing</a> files on object storage servers using the S3 API. S3 offers a standard API to read and write to remote files (while regular http servers, predating S3, do not offer a common write API). DuckDB conforms to the S3 API, that is now common among industry storage providers.</p> <h2 id="platforms"> <a style="text-decoration: none;" href="#platforms">Platforms</a> </h2> <p>The <code class="language-plaintext highlighter-rouge">httpfs</code> filesystem is tested with <a href="https://aws.amazon.com/s3/">AWS S3</a>, <a href="https://min.io/">Minio</a>, <a href="https://cloud.google.com/storage/docs/interoperability">Google Cloud</a>, and <a href="https://docs.lakefs.io/integrations/duckdb.html">lakeFS</a>. Other services that implement the S3 API (such as <a href="https://www.cloudflare.com/en-gb/developer-platform/r2/">Cloudflare R2</a>) should also work, but not all features may be supported.</p> <p>The following table shows which parts of the S3 API are required for each <code class="language-plaintext highlighter-rouge">httpfs</code> feature.</p>  <table> <thead> <tr> <th style="text-align: left">Feature</th> <th style="text-align: left">Required S3 API features</th> </tr> </thead> <tbody> <tr> <td style="text-align: left">Public file reads</td> <td style="text-align: left">HTTP Range requests</td> </tr> <tr> <td style="text-align: left">Private file reads</td> <td style="text-align: left">Secret key or session token authentication</td> </tr> <tr> <td style="text-align: left">File glob</td> <td style="text-align: left"><a href="https://docs.aws.amazon.com/AmazonS3/latest/API/API_ListObjectsV2.html">ListObjectV2</a></td> </tr> <tr> <td style="text-align: left">File writes</td> <td style="text-align: left"><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/mpuoverview.html">Multipart upload</a></td> </tr> </tbody> </table> <h2 id="configuration-and-authentication"> <a style="text-decoration: none;" href="#configuration-and-authentication">Configuration and Authentication</a> </h2> <p>The preferred way to configure and authenticate to S3 endpoints is to use <a href="../../sql/statements/create_secret.html">secrets</a>. Multiple secret providers are available.</p> <blockquote> <p>Deprecated Prior to version 0.10.0, DuckDB did not have a <a href="../../sql/statements/create_secret.html">Secrets manager</a>. Hence, the configuration of and authentication to S3 endpoints was handled via variables. See the <a href="s3api_legacy_authentication.html">legacy authentication scheme for the S3 API</a>.</p> </blockquote> <h3 id="config-provider"> <a style="text-decoration: none;" href="#config-provider"><code class="language-plaintext highlighter-rouge">CONFIG</code> Provider</a> </h3> <p>The default provider, <code class="language-plaintext highlighter-rouge">CONFIG</code> (i.e., user-configured), allows access to the S3 bucket by manually providing a key. For example:</p> <pre class="language-sql highlighter-rouge" data-language="sql">CREATE SECRET secret1 (
    TYPE S3,
    KEY_ID 'AKIAIOSFODNN7EXAMPLE',
    SECRET 'wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY',
    REGION 'us-east-1'
);</pre> <blockquote> <p>Tip If you get an IO Error (<code class="language-plaintext highlighter-rouge">Connection error for HTTP HEAD</code>), configure the endpoint explicitly via <code class="language-plaintext highlighter-rouge">ENDPOINT 's3.⟨your-region⟩.amazonaws.com'</code>.</p> </blockquote> <p>Now, to query using the above secret, simply query any <code class="language-plaintext highlighter-rouge">s3://</code> prefixed file:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM 's3://my-bucket/file.parquet';</pre> <h3 id="credential_chain-provider"> <a style="text-decoration: none;" href="#credential_chain-provider"><code class="language-plaintext highlighter-rouge">CREDENTIAL_CHAIN</code> Provider</a> </h3> <p>The <code class="language-plaintext highlighter-rouge">CREDENTIAL_CHAIN</code> provider allows automatically fetching credentials using mechanisms provided by the AWS SDK. For example, to use the AWS SDK default provider:</p> <pre class="language-sql highlighter-rouge" data-language="sql">CREATE SECRET secret2 (
    TYPE S3,
    PROVIDER CREDENTIAL_CHAIN
);</pre> <p>Again, to query a file using the above secret, simply query any <code class="language-plaintext highlighter-rouge">s3://</code> prefixed file.</p> <p>DuckDB also allows specifying a specific chain using the <code class="language-plaintext highlighter-rouge">CHAIN</code> keyword. This takes a semicolon-separated list (<code class="language-plaintext highlighter-rouge">a;b;c</code>) of providers that will be tried in order. For example:</p> <pre class="language-sql highlighter-rouge" data-language="sql">CREATE SECRET secret3 (
    TYPE S3,
    PROVIDER CREDENTIAL_CHAIN,
    CHAIN 'env;config'
);</pre> <p>The possible values for <code class="language-plaintext highlighter-rouge">CHAIN</code> are the following:</p> <ul> <li><a href="https://sdk.amazonaws.com/cpp/api/LATEST/aws-cpp-sdk-core/html/class_aws_1_1_auth_1_1_profile_config_file_a_w_s_credentials_provider.html"><code class="language-plaintext highlighter-rouge">config</code></a></li> <li><a href="https://sdk.amazonaws.com/cpp/api/LATEST/aws-cpp-sdk-core/html/class_aws_1_1_auth_1_1_s_t_s_assume_role_web_identity_credentials_provider.html"><code class="language-plaintext highlighter-rouge">sts</code></a></li> <li><a href="https://sdk.amazonaws.com/cpp/api/LATEST/aws-cpp-sdk-core/html/class_aws_1_1_auth_1_1_s_s_o_credentials_provider.html"><code class="language-plaintext highlighter-rouge">sso</code></a></li> <li><a href="https://sdk.amazonaws.com/cpp/api/LATEST/aws-cpp-sdk-core/html/class_aws_1_1_auth_1_1_environment_a_w_s_credentials_provider.html"><code class="language-plaintext highlighter-rouge">env</code></a></li> <li><a href="https://sdk.amazonaws.com/cpp/api/LATEST/aws-cpp-sdk-core/html/class_aws_1_1_auth_1_1_instance_profile_credentials_provider.html"><code class="language-plaintext highlighter-rouge">instance</code></a></li> <li><a href="https://sdk.amazonaws.com/cpp/api/LATEST/aws-cpp-sdk-core/html/class_aws_1_1_auth_1_1_process_credentials_provider.html"><code class="language-plaintext highlighter-rouge">process</code></a></li> </ul> <p>The <code class="language-plaintext highlighter-rouge">CREDENTIAL_CHAIN</code> provider also allows overriding the automatically fetched config. For example, to automatically load credentials, and then override the region, run:</p> <pre class="language-sql highlighter-rouge" data-language="sql">CREATE SECRET secret4 (
    TYPE S3,
    PROVIDER CREDENTIAL_CHAIN,
    CHAIN 'config',
    REGION 'eu-west-1'
);</pre> <h3 id="overview-of-s3-secret-parameters"> <a style="text-decoration: none;" href="#overview-of-s3-secret-parameters">Overview of S3 Secret Parameters</a> </h3> <p>Below is a complete list of the supported parameters that can be used for both the <code class="language-plaintext highlighter-rouge">CONFIG</code> and <code class="language-plaintext highlighter-rouge">CREDENTIAL_CHAIN</code> providers:</p> <table> <thead> <tr> <th style="text-align: left">Name</th> <th style="text-align: left">Description</th> <th style="text-align: left">Secret</th> <th style="text-align: left">Type</th> <th style="text-align: left">Default</th> </tr> </thead> <tbody> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">KEY_ID</code></td> <td style="text-align: left">The ID of the key to use</td> <td style="text-align: left">
<code class="language-plaintext highlighter-rouge">S3</code>, <code class="language-plaintext highlighter-rouge">GCS</code>, <code class="language-plaintext highlighter-rouge">R2</code>
</td> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">STRING</code></td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">SECRET</code></td> <td style="text-align: left">The secret of the key to use</td> <td style="text-align: left">
<code class="language-plaintext highlighter-rouge">S3</code>, <code class="language-plaintext highlighter-rouge">GCS</code>, <code class="language-plaintext highlighter-rouge">R2</code>
</td> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">STRING</code></td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">REGION</code></td> <td style="text-align: left">The region for which to authenticate (should match the region of the bucket to query)</td> <td style="text-align: left">
<code class="language-plaintext highlighter-rouge">S3</code>, <code class="language-plaintext highlighter-rouge">GCS</code>, <code class="language-plaintext highlighter-rouge">R2</code>
</td> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">STRING</code></td> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">us-east-1</code></td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">SESSION_TOKEN</code></td> <td style="text-align: left">Optionally, a session token can be passed to use temporary credentials</td> <td style="text-align: left">
<code class="language-plaintext highlighter-rouge">S3</code>, <code class="language-plaintext highlighter-rouge">GCS</code>, <code class="language-plaintext highlighter-rouge">R2</code>
</td> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">STRING</code></td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">ENDPOINT</code></td> <td style="text-align: left">Specify a custom S3 endpoint</td> <td style="text-align: left">
<code class="language-plaintext highlighter-rouge">S3</code>, <code class="language-plaintext highlighter-rouge">GCS</code>, <code class="language-plaintext highlighter-rouge">R2</code>
</td> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">STRING</code></td> <td style="text-align: left">
<code class="language-plaintext highlighter-rouge">s3.amazonaws.com</code> for <code class="language-plaintext highlighter-rouge">S3</code>,</td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">URL_STYLE</code></td> <td style="text-align: left">Either <code class="language-plaintext highlighter-rouge">vhost</code> or <code class="language-plaintext highlighter-rouge">path</code>
</td> <td style="text-align: left">
<code class="language-plaintext highlighter-rouge">S3</code>, <code class="language-plaintext highlighter-rouge">GCS</code>, <code class="language-plaintext highlighter-rouge">R2</code>
</td> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">STRING</code></td> <td style="text-align: left">
<code class="language-plaintext highlighter-rouge">vhost</code> for <code class="language-plaintext highlighter-rouge">S3</code>, <code class="language-plaintext highlighter-rouge">path</code> for <code class="language-plaintext highlighter-rouge">R2</code> and <code class="language-plaintext highlighter-rouge">GCS</code>
</td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">USE_SSL</code></td> <td style="text-align: left">Whether to use HTTPS or HTTP</td> <td style="text-align: left">
<code class="language-plaintext highlighter-rouge">S3</code>, <code class="language-plaintext highlighter-rouge">GCS</code>, <code class="language-plaintext highlighter-rouge">R2</code>
</td> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">BOOLEAN</code></td> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">true</code></td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">URL_COMPATIBILITY_MODE</code></td> <td style="text-align: left">Can help when urls contain problematic characters.</td> <td style="text-align: left">
<code class="language-plaintext highlighter-rouge">S3</code>, <code class="language-plaintext highlighter-rouge">GCS</code>, <code class="language-plaintext highlighter-rouge">R2</code>
</td> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">BOOLEAN</code></td> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">true</code></td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">ACCOUNT_ID</code></td> <td style="text-align: left">The R2 account ID to use for generating the endpoint url</td> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">R2</code></td> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">STRING</code></td> <td style="text-align: left">-</td> </tr> </tbody> </table> <h3 id="platform-specific-secret-types"> <a style="text-decoration: none;" href="#platform-specific-secret-types">Platform-Specific Secret Types</a> </h3> <h4 id="r2-secrets"> <a style="text-decoration: none;" href="#r2-secrets">R2 Secrets</a> </h4> <p>While <a href="https://www.cloudflare.com/developer-platform/r2">Cloudflare R2</a> uses the regular S3 API, DuckDB has a special Secret type, <code class="language-plaintext highlighter-rouge">R2</code>, to make configuring it a bit simpler:</p> <pre class="language-sql highlighter-rouge" data-language="sql">CREATE SECRET secret5 (
    TYPE R2,
    KEY_ID 'AKIAIOSFODNN7EXAMPLE',
    SECRET 'wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY',
    ACCOUNT_ID 'my_account_id'
);</pre> <p>Note the addition of the <code class="language-plaintext highlighter-rouge">ACCOUNT_ID</code> which is used to generate to correct endpoint url for you. Also note that for <code class="language-plaintext highlighter-rouge">R2</code> Secrets can also use both the <code class="language-plaintext highlighter-rouge">CONFIG</code> and <code class="language-plaintext highlighter-rouge">CREDENTIAL_CHAIN</code> providers. Finally, <code class="language-plaintext highlighter-rouge">R2</code> secrets are only available when using urls starting with <code class="language-plaintext highlighter-rouge">r2://</code>, for example:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM read_parquet('r2://some/file/that/uses/r2/secret/file.parquet');</pre> <h4 id="gcs-secrets"> <a style="text-decoration: none;" href="#gcs-secrets">GCS Secrets</a> </h4> <p>While <a href="https://cloud.google.com/storage">Google Cloud Storage</a> is accessed by DuckDB using the S3 API, DuckDB has a special Secret type, <code class="language-plaintext highlighter-rouge">GCS</code>, to make configuring it a bit simpler:</p> <pre class="language-sql highlighter-rouge" data-language="sql">CREATE SECRET secret6 (
    TYPE GCS,
    KEY_ID 'my_key',
    SECRET 'my_secret'
);</pre> <p>Note that the above secret, will automatically have the correct Google Cloud Storage endpoint configured. Also note that for <code class="language-plaintext highlighter-rouge">GCS</code> Secrets can also use both the <code class="language-plaintext highlighter-rouge">CONFIG</code> and <code class="language-plaintext highlighter-rouge">CREDENTIAL_CHAIN</code> providers. Finally, <code class="language-plaintext highlighter-rouge">GCS</code> secrets are only available when using urls starting with <code class="language-plaintext highlighter-rouge">gcs://</code> or <code class="language-plaintext highlighter-rouge">gs://</code>, for example:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM read_parquet('gcs://some/file/that/uses/gcs/secret/file.parquet');</pre> <h2 id="reading"> <a style="text-decoration: none;" href="#reading">Reading</a> </h2> <p>Reading files from S3 is now as simple as:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM 's3://bucket/file.extension';</pre> <h3 id="partial-reading"> <a style="text-decoration: none;" href="#partial-reading">Partial Reading</a> </h3> <p>The <code class="language-plaintext highlighter-rouge">httpfs</code> extension supports <a href="https#partial-reading.html">partial reading</a> from S3 buckets.</p> <h3 id="reading-multiple-files"> <a style="text-decoration: none;" href="#reading-multiple-files">Reading Multiple Files</a> </h3> <p>Multiple files are also possible, for example:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM read_parquet([
    's3://bucket/file1.parquet',
    's3://bucket/file2.parquet'
]);</pre> <h3 id="globbing"> <a style="text-decoration: none;" href="#globbing">Globbing</a> </h3> <p>File <a href="../../sql/functions/pattern_matching.html#globbing.html">globbing</a> is implemented using the ListObjectV2 API call and allows to use filesystem-like glob patterns to match multiple files, for example:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM read_parquet('s3://bucket/*.parquet');</pre> <p>This query matches all files in the root of the bucket with the <a href="../../data/parquet/overview.html">Parquet extension</a>.</p> <p>Several features for matching are supported, such as <code class="language-plaintext highlighter-rouge">*</code> to match any number of any character, <code class="language-plaintext highlighter-rouge">?</code> for any single character or <code class="language-plaintext highlighter-rouge">[0-9]</code> for a single character in a range of characters:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT count(*) FROM read_parquet('s3://bucket/folder*/100?/t[0-9].parquet');</pre> <p>A useful feature when using globs is the <code class="language-plaintext highlighter-rouge">filename</code> option, which adds a column named <code class="language-plaintext highlighter-rouge">filename</code> that encodes the file that a particular row originated from:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM read_parquet('s3://bucket/*.parquet', filename = true);</pre> <p>could for example result in:</p>  <table> <thead> <tr> <th style="text-align: left">column_a</th> <th style="text-align: left">column_b</th> <th style="text-align: left">filename</th> </tr> </thead> <tbody> <tr> <td style="text-align: left">1</td> <td style="text-align: left">examplevalue1</td> <td style="text-align: left">s3://bucket/file1.parquet</td> </tr> <tr> <td style="text-align: left">2</td> <td style="text-align: left">examplevalue1</td> <td style="text-align: left">s3://bucket/file2.parquet</td> </tr> </tbody> </table> <h3 id="hive-partitioning"> <a style="text-decoration: none;" href="#hive-partitioning">Hive Partitioning</a> </h3> <p>DuckDB also offers support for the <a href="../../data/partitioning/hive_partitioning.html">Hive partitioning scheme</a>, which is available when using HTTP(S) and S3 endpoints.</p> <h2 id="writing"> <a style="text-decoration: none;" href="#writing">Writing</a> </h2> <p>Writing to S3 uses the multipart upload API. This allows DuckDB to robustly upload files at high speed. Writing to S3 works for both CSV and Parquet:</p> <pre class="language-sql highlighter-rouge" data-language="sql">COPY table_name TO 's3://bucket/file.extension';</pre> <p>Partitioned copy to S3 also works:</p> <pre class="language-sql highlighter-rouge" data-language="sql">COPY table TO 's3://my-bucket/partitioned' (
    FORMAT PARQUET,
    PARTITION_BY (part_col_a, part_col_b)
);</pre> <p>An automatic check is performed for existing files/directories, which is currently quite conservative (and on S3 will add a bit of latency). To disable this check and force writing, an <code class="language-plaintext highlighter-rouge">OVERWRITE_OR_IGNORE</code> flag is added:</p> <pre class="language-sql highlighter-rouge" data-language="sql">COPY table TO 's3://my-bucket/partitioned' (
    FORMAT PARQUET,
    PARTITION_BY (part_col_a, part_col_b),
    OVERWRITE_OR_IGNORE true
);</pre> <p>The naming scheme of the written files looks like this:</p> <pre class="language-text highlighter-rouge" data-language="text">s3://my-bucket/partitioned/part_col_a=⟨val⟩/part_col_b=⟨val⟩/data_⟨thread_number⟩.parquet</pre> <h3 id="configuration"> <a style="text-decoration: none;" href="#configuration">Configuration</a> </h3> <p>Some additional configuration options exist for the S3 upload, though the default values should suffice for most use cases.</p>  <table> <thead> <tr> <th style="text-align: left">Name</th> <th style="text-align: left">Description</th> </tr> </thead> <tbody> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">s3_uploader_max_parts_per_file</code></td> <td style="text-align: left">used for part size calculation, see <a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/qfacts.html">AWS docs</a>
</td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">s3_uploader_max_filesize</code></td> <td style="text-align: left">used for part size calculation, see <a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/qfacts.html">AWS docs</a>
</td> </tr> <tr> <td style="text-align: left"><code class="language-plaintext highlighter-rouge">s3_uploader_thread_limit</code></td> <td style="text-align: left">maximum number of uploader threads</td> </tr> </tbody> </table><div class="_attribution">
  <p class="_attribution-p">
    &copy; Copyright 2018&ndash;2024 Stichting DuckDB Foundation<br>Licensed under the MIT License.<br>
    <a href="https://duckdb.org/docs/extensions/httpfs/s3api.html" class="_attribution-link">https://duckdb.org/docs/extensions/httpfs/s3api.html</a>
  </p>
</div>
