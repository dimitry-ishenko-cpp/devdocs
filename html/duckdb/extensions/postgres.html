<h1 class="title">PostgreSQL Extension</h1>  <p>The <code class="language-plaintext highlighter-rouge">postgres</code> extension allows DuckDB to directly read and write data from a running PostgreSQL database instance. The data can be queried directly from the underlying PostgreSQL database. Data can be loaded from PostgreSQL tables into DuckDB tables, or vice versa. See the <a href="http://localhost:8000/2022/09/30/postgres-scanner.html">official announcement</a> for implementation details and background.</p> <h2 id="installing-and-loading"> <a style="text-decoration: none;" href="#installing-and-loading">Installing and Loading</a> </h2> <p>The <code class="language-plaintext highlighter-rouge">postgres</code> extension will be transparently <a href="overview.html#autoloading-extensions.html">autoloaded</a> on first use from the official extension repository. If you would like to install and load it manually, run:</p> <pre class="language-sql highlighter-rouge" data-language="sql">INSTALL postgres;
LOAD postgres;</pre> <h2 id="connecting"> <a style="text-decoration: none;" href="#connecting">Connecting</a> </h2> <p>To make a PostgreSQL database accessible to DuckDB, use the <code class="language-plaintext highlighter-rouge">ATTACH</code> command with the <code class="language-plaintext highlighter-rouge">POSTGRES</code> or <code class="language-plaintext highlighter-rouge">POSTGRES_SCANNER</code> type.</p> <p>To connect to the <code class="language-plaintext highlighter-rouge">public</code> schema of the PostgreSQL instance running on localhost in read-write mode, run:</p> <pre class="language-sql highlighter-rouge" data-language="sql">ATTACH '' AS postgres_db (TYPE POSTGRES);</pre> <p>To connect to the PostgreSQL instance with the given parameters in read-only mode, run:</p> <pre class="language-sql highlighter-rouge" data-language="sql">ATTACH 'dbname=postgres user=postgres host=127.0.0.1' AS db (TYPE POSTGRES, READ_ONLY);</pre> <p>By default, all schemas are attached. When working with large instances, it can be useful to only attach a specific schema. This can be accomplished using the <code class="language-plaintext highlighter-rouge">SCHEMA</code> command.</p> <pre class="language-sql highlighter-rouge" data-language="sql">ATTACH 'dbname=postgres user=postgres host=127.0.0.1' AS db (TYPE POSTGRES, SCHEMA 'public');</pre> <h3 id="configuration"> <a style="text-decoration: none;" href="#configuration">Configuration</a> </h3> <p>The <code class="language-plaintext highlighter-rouge">ATTACH</code> command takes as input either a <a href="https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNSTRING"><code class="language-plaintext highlighter-rouge">libpq</code> connection string</a> or a <a href="https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNSTRING-URIS">PostgreSQL URI</a>.</p> <p>Below are some example connection strings and commonly used parameters. A full list of available parameters can be found in the <a href="https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-PARAMKEYWORDS">PostgreSQL documentation</a>.</p> <pre class="language-text highlighter-rouge" data-language="text">dbname=postgresscanner
host=localhost port=5432 dbname=mydb connect_timeout=10</pre> <table> <thead> <tr> <th>Name</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">dbname</code></td> <td>Database name</td> <td>[user]</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">host</code></td> <td>Name of host to connect to</td> <td><code class="language-plaintext highlighter-rouge">localhost</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">hostaddr</code></td> <td>Host IP address</td> <td><code class="language-plaintext highlighter-rouge">localhost</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">passfile</code></td> <td>Name of file passwords are stored in</td> <td><code class="language-plaintext highlighter-rouge">~/.pgpass</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">password</code></td> <td>PostgreSQL password</td> <td>(empty)</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">port</code></td> <td>Port number</td> <td><code class="language-plaintext highlighter-rouge">5432</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">user</code></td> <td>PostgreSQL user name</td> <td>current user</td> </tr> </tbody> </table> <p>An example URI is <code class="language-plaintext highlighter-rouge">postgresql://username@hostname/dbname</code>.</p> <h3 id="configuring-via-secrets"> <a style="text-decoration: none;" href="#configuring-via-secrets">Configuring via Secrets</a> </h3> <p>PostgreSQL connection information can also be specified with <a href="../configuration/secrets_manager.html">secrets</a>. The following syntax can be used to create a secret.</p> <pre class="language-sql highlighter-rouge" data-language="sql">CREATE SECRET (
    TYPE POSTGRES,
    HOST '127.0.0.1',
    PORT 5432,
    DATABASE postgres,
    USER 'postgres',
    PASSWORD ''
);</pre> <p>The information from the secret will be used when <code class="language-plaintext highlighter-rouge">ATTACH</code> is called. We can leave the Postgres connection string empty to use all of the information stored in the secret.</p> <pre class="language-sql highlighter-rouge" data-language="sql">ATTACH '' AS postgres_db (TYPE POSTGRES);</pre> <p>We can use the Postgres connection string to override individual options. For example, to connect to a different database while still using the same credentials, we can override only the database name in the following manner.</p> <pre class="language-sql highlighter-rouge" data-language="sql">ATTACH 'dbname=my_other_db' AS postgres_db (TYPE POSTGRES);</pre> <p>By default, created secrets are temporary. Secrets can be persisted using the <a href="../configuration/secrets_manager.html#persistent-secrets.html"><code class="language-plaintext highlighter-rouge">CREATE PERSISTENT SECRET</code> command</a>. Persistent secrets can be used across sessions.</p> <h4 id="managing-multiple-secrets"> <a style="text-decoration: none;" href="#managing-multiple-secrets">Managing Multiple Secrets</a> </h4> <p>Named secrets can be used to manage connections to multiple Postgres database instances. Secrets can be given a name upon creation.</p> <pre class="language-sql highlighter-rouge" data-language="sql">CREATE SECRET postgres_secret_one (
    TYPE POSTGRES,
    HOST '127.0.0.1',
    PORT 5432,
    DATABASE postgres,
    USER 'postgres',
    PASSWORD ''
);</pre> <p>The secret can then be explicitly referenced using the <code class="language-plaintext highlighter-rouge">SECRET</code> parameter in the <code class="language-plaintext highlighter-rouge">ATTACH</code>.</p> <pre class="language-sql highlighter-rouge" data-language="sql">ATTACH '' AS postgres_db_one (TYPE POSTGRES, SECRET postgres_secret_one);</pre> <h3 id="configuring-via-environment-variables"> <a style="text-decoration: none;" href="#configuring-via-environment-variables">Configuring via Environment Variables</a> </h3> <p>PostgreSQL connection information can also be specified with <a href="https://www.postgresql.org/docs/current/libpq-envars.html">environment variables</a>. This can be useful in a production environment where the connection information is managed externally and passed in to the environment.</p> <pre class="language-bash highlighter-rouge" data-language="bash">export PGPASSWORD="secret"
export PGHOST=localhost
export PGUSER=owner
export PGDATABASE=mydatabase</pre> <p>Then, to connect, start the <code class="language-plaintext highlighter-rouge">duckdb</code> process and run:</p> <pre class="language-sql highlighter-rouge" data-language="sql">ATTACH '' AS p (TYPE POSTGRES);</pre> <h2 id="usage"> <a style="text-decoration: none;" href="#usage">Usage</a> </h2> <p>The tables in the PostgreSQL database can be read as if they were normal DuckDB tables, but the underlying data is read directly from PostgreSQL at query time.</p> <pre class="language-sql highlighter-rouge" data-language="sql">SHOW ALL TABLES;</pre>  <table> <thead> <tr> <th>name</th> </tr> </thead> <tbody> <tr> <td>uuids</td> </tr> </tbody> </table> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT * FROM uuids;</pre>  <table> <thead> <tr> <th>u</th> </tr> </thead> <tbody> <tr> <td>6d3d2541-710b-4bde-b3af-4711738636bf</td> </tr> <tr> <td>NULL</td> </tr> <tr> <td>00000000-0000-0000-0000-000000000001</td> </tr> <tr> <td>ffffffff-ffff-ffff-ffff-ffffffffffff</td> </tr> </tbody> </table> <p>It might be desirable to create a copy of the PostgreSQL databases in DuckDB to prevent the system from re-reading the tables from PostgreSQL continuously, particularly for large tables.</p> <p>Data can be copied over from PostgreSQL to DuckDB using standard SQL, for example:</p> <pre class="language-sql highlighter-rouge" data-language="sql">CREATE TABLE duckdb_table AS FROM postgres_db.postgres_tbl;</pre> <h2 id="writing-data-to-postgresql"> <a style="text-decoration: none;" href="#writing-data-to-postgresql">Writing Data to PostgreSQL</a> </h2> <p>In addition to reading data from PostgreSQL, the extension allows you to create tables, ingest data into PostgreSQL and make other modifications to a PostgreSQL database using standard SQL queries.</p> <p>This allows you to use DuckDB to, for example, export data that is stored in a PostgreSQL database to Parquet, or read data from a Parquet file into PostgreSQL.</p> <p>Below is a brief example of how to create a new table in PostgreSQL and load data into it.</p> <pre class="language-sql highlighter-rouge" data-language="sql">ATTACH 'dbname=postgresscanner' AS postgres_db (TYPE POSTGRES);
CREATE TABLE postgres_db.tbl (id INTEGER, name VARCHAR);
INSERT INTO postgres_db.tbl VALUES (42, 'DuckDB');</pre> <p>Many operations on PostgreSQL tables are supported. All these operations directly modify the PostgreSQL database, and the result of subsequent operations can then be read using PostgreSQL. Note that if modifications are not desired, <code class="language-plaintext highlighter-rouge">ATTACH</code> can be run with the <code class="language-plaintext highlighter-rouge">READ_ONLY</code> property which prevents making modifications to the underlying database. For example:</p> <pre class="language-sql highlighter-rouge" data-language="sql">ATTACH 'dbname=postgresscanner' AS postgres_db (TYPE POSTGRES, READ_ONLY);</pre> <p>Below is a list of supported operations.</p> <h3 id="create-table"> <a style="text-decoration: none;" href="#create-table"><code class="language-plaintext highlighter-rouge">CREATE TABLE</code></a> </h3> <pre class="language-sql highlighter-rouge" data-language="sql">CREATE TABLE postgres_db.tbl (id INTEGER, name VARCHAR);</pre> <h3 id="insert-into"> <a style="text-decoration: none;" href="#insert-into"><code class="language-plaintext highlighter-rouge">INSERT INTO</code></a> </h3> <pre class="language-sql highlighter-rouge" data-language="sql">INSERT INTO postgres_db.tbl VALUES (42, 'DuckDB');</pre> <h3 id="select"> <a style="text-decoration: none;" href="#select"><code class="language-plaintext highlighter-rouge">SELECT</code></a> </h3> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT * FROM postgres_db.tbl;</pre> <table> <thead> <tr> <th style="text-align: right">id</th> <th>name</th> </tr> </thead> <tbody> <tr> <td style="text-align: right">42</td> <td>DuckDB</td> </tr> </tbody> </table> <h3 id="copy"> <a style="text-decoration: none;" href="#copy"><code class="language-plaintext highlighter-rouge">COPY</code></a> </h3> <p>You can copy tables back and forth between PostgreSQL and DuckDB:</p> <pre class="language-sql highlighter-rouge" data-language="sql">COPY postgres_db.tbl TO 'data.parquet';
COPY postgres_db.tbl FROM 'data.parquet';</pre> <p>These copies use <a href="https://www.postgresql.org/docs/current/sql-copy.html">PostgreSQL binary wire encoding</a>. DuckDB can also write data using this encoding to a file which you can then load into PostgreSQL using a client of your choosing if you would like to do your own connection management:</p> <pre class="language-sql highlighter-rouge" data-language="sql">COPY 'data.parquet' TO 'pg.bin' WITH (FORMAT POSTGRES_BINARY);</pre> <p>The file produced will be the equivalent of copying the file to PostgreSQL using DuckDB and then dumping it from PostgreSQL using <code class="language-plaintext highlighter-rouge">psql</code> or another client:</p> <p>DuckDB:</p> <pre class="language-sql highlighter-rouge" data-language="sql">COPY postgres_db.tbl FROM 'data.parquet';</pre> <p>PostgreSQL:</p> <pre class="language-sql highlighter-rouge" data-language="sql">\copy tbl TO 'data.bin' WITH (FORMAT BINARY);</pre> <p>You may also create a full copy of the database using the <a href="../sql/statements/copy.html#copy-from-database--to.html"><code class="language-plaintext highlighter-rouge">COPY FROM DATABASE</code> statement</a>:</p> <pre class="language-sql highlighter-rouge" data-language="sql">COPY FROM DATABASE postgres_db TO my_duckdb_db;</pre> <h3 id="update"> <a style="text-decoration: none;" href="#update"><code class="language-plaintext highlighter-rouge">UPDATE</code></a> </h3> <pre class="language-sql highlighter-rouge" data-language="sql">UPDATE postgres_db.tbl
SET name = 'Woohoo'
WHERE id = 42;</pre> <h3 id="delete"> <a style="text-decoration: none;" href="#delete"><code class="language-plaintext highlighter-rouge">DELETE</code></a> </h3> <pre class="language-sql highlighter-rouge" data-language="sql">DELETE FROM postgres_db.tbl
WHERE id = 42;</pre> <h3 id="alter-table"> <a style="text-decoration: none;" href="#alter-table"><code class="language-plaintext highlighter-rouge">ALTER TABLE</code></a> </h3> <pre class="language-sql highlighter-rouge" data-language="sql">ALTER TABLE postgres_db.tbl
ADD COLUMN k INTEGER;</pre> <h3 id="drop-table"> <a style="text-decoration: none;" href="#drop-table"><code class="language-plaintext highlighter-rouge">DROP TABLE</code></a> </h3> <pre class="language-sql highlighter-rouge" data-language="sql">DROP TABLE postgres_db.tbl;</pre> <h3 id="create-view"> <a style="text-decoration: none;" href="#create-view"><code class="language-plaintext highlighter-rouge">CREATE VIEW</code></a> </h3> <pre class="language-sql highlighter-rouge" data-language="sql">CREATE VIEW postgres_db.v1 AS SELECT 42;</pre> <h3 id="create-schema--drop-schema"> <a style="text-decoration: none;" href="#create-schema--drop-schema"><code class="language-plaintext highlighter-rouge">CREATE SCHEMA</code> / <code class="language-plaintext highlighter-rouge">DROP SCHEMA</code></a> </h3> <pre class="language-sql highlighter-rouge" data-language="sql">CREATE SCHEMA postgres_db.s1;
CREATE TABLE postgres_db.s1.integers (i INTEGER);
INSERT INTO postgres_db.s1.integers VALUES (42);
SELECT * FROM postgres_db.s1.integers;</pre> <table> <thead> <tr> <th style="text-align: right">i</th> </tr> </thead> <tbody> <tr> <td style="text-align: right">42</td> </tr> </tbody> </table> <pre class="language-sql highlighter-rouge" data-language="sql">DROP SCHEMA postgres_db.s1;</pre> <h2 id="detach"> <a style="text-decoration: none;" href="#detach"><code class="language-plaintext highlighter-rouge">DETACH</code></a> </h2> <pre class="language-sql highlighter-rouge" data-language="sql">DETACH postgres_db;</pre> <h3 id="transactions"> <a style="text-decoration: none;" href="#transactions">Transactions</a> </h3> <pre class="language-sql highlighter-rouge" data-language="sql">CREATE TABLE postgres_db.tmp (i INTEGER);
BEGIN;
INSERT INTO postgres_db.tmp VALUES (42);
SELECT * FROM postgres_db.tmp;</pre> <p>This returns:</p> <table> <thead> <tr> <th style="text-align: right">i</th> </tr> </thead> <tbody> <tr> <td style="text-align: right">42</td> </tr> </tbody> </table> <pre class="language-sql highlighter-rouge" data-language="sql">ROLLBACK;
SELECT * FROM postgres_db.tmp;</pre> <p>This returns an empty table.</p> <h2 id="running-sql-queries-in-postgresql"> <a style="text-decoration: none;" href="#running-sql-queries-in-postgresql">Running SQL Queries in PostgreSQL</a> </h2> <h3 id="the-postgres_query-table-function"> <a style="text-decoration: none;" href="#the-postgres_query-table-function">The <code class="language-plaintext highlighter-rouge">postgres_query</code> Table Function</a> </h3> <p>The <code class="language-plaintext highlighter-rouge">postgres_query</code> table function allows you to run arbitrary read queries within an attached database. <code class="language-plaintext highlighter-rouge">postgres_query</code> takes the name of the attached PostgreSQL database to execute the query in, as well as the SQL query to execute. The result of the query is returned. Single-quote strings are escaped by repeating the single quote twice.</p> <pre class="language-sql highlighter-rouge" data-language="sql">postgres_query(attached_database::VARCHAR, query::VARCHAR)</pre> <p>For example:</p> <pre class="language-sql highlighter-rouge" data-language="sql">ATTACH 'dbname=postgresscanner' AS postgres_db (TYPE POSTGRES);
SELECT * FROM postgres_query('postgres_db', 'SELECT * FROM cars LIMIT 3');</pre>  <table> <thead> <tr> <th>brand</th> <th>model</th> <th>color</th> </tr> </thead> <tbody> <tr> <td>Ferrari</td> <td>Testarossa</td> <td>red</td> </tr> <tr> <td>Aston Martin</td> <td>DB2</td> <td>blue</td> </tr> <tr> <td>Bentley</td> <td>Mulsanne</td> <td>gray</td> </tr> </tbody> </table> <h3 id="the-postgres_execute-function"> <a style="text-decoration: none;" href="#the-postgres_execute-function">The <code class="language-plaintext highlighter-rouge">postgres_execute</code> Function</a> </h3> <p>The <code class="language-plaintext highlighter-rouge">postgres_execute</code> function allows running arbitrary queries within PostgreSQL, including statements that update the schema and content of the database.</p> <pre class="language-sql highlighter-rouge" data-language="sql">ATTACH 'dbname=postgresscanner' AS postgres_db (TYPE POSTGRES);
CALL postgres_execute('postgres_db', 'CREATE TABLE my_table (i INTEGER)');</pre> <h2 id="settings"> <a style="text-decoration: none;" href="#settings">Settings</a> </h2> <p>The extension exposes the following configuration parameters.</p> <table> <thead> <tr> <th>Name</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">pg_array_as_varchar</code></td> <td>Read PostgreSQL arrays as varchar - enables reading mixed dimensional arrays</td> <td><code class="language-plaintext highlighter-rouge">false</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">pg_connection_cache</code></td> <td>Whether or not to use the connection cache</td> <td><code class="language-plaintext highlighter-rouge">true</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">pg_connection_limit</code></td> <td>The maximum amount of concurrent PostgreSQL connections</td> <td><code class="language-plaintext highlighter-rouge">64</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">pg_debug_show_queries</code></td> <td>DEBUG SETTING: print all queries sent to PostgreSQL to stdout</td> <td><code class="language-plaintext highlighter-rouge">false</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">pg_experimental_filter_pushdown</code></td> <td>Whether or not to use filter pushdown (currently experimental)</td> <td><code class="language-plaintext highlighter-rouge">false</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">pg_pages_per_task</code></td> <td>The amount of pages per task</td> <td><code class="language-plaintext highlighter-rouge">1000</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">pg_use_binary_copy</code></td> <td>Whether or not to use BINARY copy to read data</td> <td><code class="language-plaintext highlighter-rouge">true</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">pg_null_byte_replacement</code></td> <td>When writing NULL bytes to Postgres, replace them with the given character</td> <td><code class="language-plaintext highlighter-rouge">NULL</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">pg_use_ctid_scan</code></td> <td>Whether or not to parallelize scanning using table ctids</td> <td><code class="language-plaintext highlighter-rouge">true</code></td> </tr> </tbody> </table> <h2 id="schema-cache"> <a style="text-decoration: none;" href="#schema-cache">Schema Cache</a> </h2> <p>To avoid having to continuously fetch schema data from PostgreSQL, DuckDB keeps schema information – such as the names of tables, their columns, etc. – cached. If changes are made to the schema through a different connection to the PostgreSQL instance, such as new columns being added to a table, the cached schema information might be outdated. In this case, the function <code class="language-plaintext highlighter-rouge">pg_clear_cache</code> can be executed to clear the internal caches.</p> <pre class="language-sql highlighter-rouge" data-language="sql">CALL pg_clear_cache();</pre> <blockquote> <p>Deprecated The old <code class="language-plaintext highlighter-rouge">postgres_attach</code> function is deprecated. It is recommended to switch over to the new <code class="language-plaintext highlighter-rouge">ATTACH</code> syntax.</p> </blockquote><div class="_attribution">
  <p class="_attribution-p">
    &copy; Copyright 2018&ndash;2024 Stichting DuckDB Foundation<br>Licensed under the MIT License.<br>
    <a href="https://duckdb.org/docs/extensions/postgres.html" class="_attribution-link">https://duckdb.org/docs/extensions/postgres.html</a>
  </p>
</div>
