<h1 class="title">Parquet Tips</h1>  <p>Below is a collection of tips to help when dealing with Parquet files.</p> <h2 id="tips-for-reading-parquet-files"> <a style="text-decoration: none;" href="#tips-for-reading-parquet-files">Tips for Reading Parquet Files</a> </h2> <h3 id="use-union_by_name-when-loading-files-with-different-schemas"> <a style="text-decoration: none;" href="#use-union_by_name-when-loading-files-with-different-schemas">Use <code class="language-plaintext highlighter-rouge">union_by_name</code> When Loading Files with Different Schemas</a> </h3> <p>The <code class="language-plaintext highlighter-rouge">union_by_name</code> option can be used to unify the schema of files that have different or missing columns. For files that do not have certain columns, <code class="language-plaintext highlighter-rouge">NULL</code> values are filled in:</p> <pre class="language-sql highlighter-rouge" data-language="sql">SELECT *
FROM read_parquet('flights*.parquet', union_by_name = true);</pre> <h2 id="tips-for-writing-parquet-files"> <a style="text-decoration: none;" href="#tips-for-writing-parquet-files">Tips for Writing Parquet Files</a> </h2> <p>Using a <a href="../multiple_files/overview.html#glob-syntax.html">glob pattern</a> upon read or a <a href="../partitioning/hive_partitioning.html">Hive partitioning</a> structure are good ways to transparently handle multiple files.</p> <h3 id="enabling-per_thread_output"> <a style="text-decoration: none;" href="#enabling-per_thread_output">Enabling <code class="language-plaintext highlighter-rouge">PER_THREAD_OUTPUT</code></a> </h3> <p>If the final number of Parquet files is not important, writing one file per thread can significantly improve performance:</p> <pre class="language-sql highlighter-rouge" data-language="sql">COPY
    (FROM generate_series(10_000_000))
    TO 'test.parquet'
    (FORMAT PARQUET, PER_THREAD_OUTPUT);</pre> <h3 id="selecting-a-row_group_size"> <a style="text-decoration: none;" href="#selecting-a-row_group_size">Selecting a <code class="language-plaintext highlighter-rouge">ROW_GROUP_SIZE</code></a> </h3> <p>The <code class="language-plaintext highlighter-rouge">ROW_GROUP_SIZE</code> parameter specifies the minimum number of rows in a Parquet row group, with a minimum value equal to DuckDB's vector size, 2,048, and a default of 122,880. A Parquet row group is a partition of rows, consisting of a column chunk for each column in the dataset.</p> <p>Compression algorithms are only applied per row group, so the larger the row group size, the more opportunities to compress the data. DuckDB can read Parquet row groups in parallel even within the same file and uses predicate pushdown to only scan the row groups whose metadata ranges match the <code class="language-plaintext highlighter-rouge">WHERE</code> clause of the query. However there is some overhead associated with reading the metadata in each group. A good approach would be to ensure that within each file, the total number of row groups is at least as large as the number of CPU threads used to query that file. More row groups beyond the thread count would improve the speed of highly selective queries, but slow down queries that must scan the whole file like aggregations.</p> <p>To write a query to a Parquet file with a different row group size, run:</p> <pre class="language-sql highlighter-rouge" data-language="sql">COPY
    (FROM generate_series(100_000))
    TO 'row-groups.parquet'
    (FORMAT PARQUET, ROW_GROUP_SIZE 100_000);</pre> <h3 id="the-row_groups_per_file-option"> <a style="text-decoration: none;" href="#the-row_groups_per_file-option">The <code class="language-plaintext highlighter-rouge">ROW_GROUPS_PER_FILE</code> Option</a> </h3> <p>The <code class="language-plaintext highlighter-rouge">ROW_GROUPS_PER_FILE</code> parameter creates a new Parquet file if the current one has a specified number of row groups.</p> <pre class="language-sql highlighter-rouge" data-language="sql">COPY
    (FROM generate_series(100_000))
    TO 'output-directory'
    (FORMAT PARQUET, ROW_GROUP_SIZE 20_000, ROW_GROUPS_PER_FILE 2);</pre> <blockquote> <p>If multiple threads are active, the number of row groups in a file may slightly exceed the specified number of row groups to limit the amount of locking – similarly to the behaviour of <a href="../../sql/statements/copy.html#copy--to-options"><code class="language-plaintext highlighter-rouge">FILE_SIZE_BYTES</code></a>. However, if <code class="language-plaintext highlighter-rouge">PER_THREAD_OUTPUT</code> is set, only one thread writes to each file, and it becomes accurate again.</p> </blockquote> <p>See the <a href="../../guides/performance/file_formats.html#parquet-file-sizes.html">Performance Guide on “File Formats”</a> for more tips.</p><div class="_attribution">
  <p class="_attribution-p">
    &copy; Copyright 2018&ndash;2024 Stichting DuckDB Foundation<br>Licensed under the MIT License.<br>
    <a href="https://duckdb.org/docs/data/parquet/tips.html" class="_attribution-link">https://duckdb.org/docs/data/parquet/tips.html</a>
  </p>
</div>
