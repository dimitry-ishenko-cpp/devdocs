<h1>Configuring MariaDB Replication between Two MariaDB Galera Clusters</h1> <div> <div class="node creole"> <div class="answer formatted">  <p><a href="../high-availability-performance-tuning-mariadb-replication/index.html">MariaDB replication</a> can be used to replication between two <a href="../galera-cluster/index.html">MariaDB Galera Clusters</a>. This article will discuss how to do that.</p> <h2 class="anchored_heading" id="configuring-the-clusters">Configuring the Clusters</h2> <p>Before we set up replication, we need to ensure that the clusters are configured properly. This involves the following steps:</p> <ul start="1"><li>Set <code><a href="../replication-and-binary-log-system-variables/index.html#log_slave_updates">log_slave_updates=ON</a></code> on all nodes in both clusters. See <a href="../configuring-mariadb-galera-cluster/index.html#writing-replicated-write-sets-to-the-binary-log">Configuring MariaDB Galera Cluster: Writing Replicated Write Sets to the Binary Log</a> and <a href="../using-mariadb-replication-with-mariadb-galera-cluster-using-mariadb-replica/index.html#configuring-a-cluster-node-as-a-replication-master">Using MariaDB Replication with MariaDB Galera Cluster: Configuring a Cluster Node as a Replication Master</a> for more information on why this is important. This is also needed to <a href="../using-mariadb-gtids-with-mariadb-galera-cluster/index.html#enabling-wsrep-gtid-mode">enable wsrep GTID mode</a>. </li></ul> <ul start="1"><li>Set <code><a href="../replication-and-binary-log-system-variables/index.html#server_id">server_id</a></code> to the same value on all nodes in a given cluster, but be sure to use a different value in each cluster. See <a href="../using-mariadb-replication-with-mariadb-galera-cluster-using-mariadb-replica/index.html#setting-server_id-on-cluster-nodes">Using MariaDB Replication with MariaDB Galera Cluster: Setting server_id on Cluster Nodes</a> for more information on what this means. </li></ul> <h3 class="anchored_heading" id="configuring-wsrep-gtid-mode">Configuring Wsrep GTID Mode</h3> <p>If you want to use <a href="../gtid/index.html">GTID</a> replication, then you also need to configure some things to <a href="../using-mariadb-gtids-with-mariadb-galera-cluster/index.html#enabling-wsrep-gtid-mode">enable wsrep GTID mode</a>. For example:</p> <ul start="1"><li>
<code><a href="../galera-cluster-system-variables/index.html#wsrep_gtid_mode">wsrep_gtid_mode=ON</a></code> needs to be set on all nodes in each cluster. </li></ul> <ul start="1"><li>
<code><a href="../galera-cluster-system-variables/index.html#wsrep_gtid_domain_id">wsrep_gtid_domain_id</a></code> needs to be set to the same value on all nodes in a given cluster, so that each cluster node uses the same domain when assigning <a href="../gtid/index.html">GTIDs</a> for Galera Cluster's write sets. Each cluster should have this set to a different value, so that each cluster uses different domains when assigning <a href="../gtid/index.html">GTIDs</a> for their write sets. </li></ul> <ul start="1"><li>
<code><a href="../replication-and-binary-log-system-variables/index.html#log_slave_updates">log_slave_updates</a></code> needs to be enabled on all nodes in the cluster. See <a href="https://jira.mariadb.org/browse/MDEV-9855">MDEV-9855</a> about that. </li></ul> <ul start="1"><li>
<code><a href="../replication-and-binary-log-server-system-variables/index.html#log_bin">log_bin</a></code> needs to be set to the same path on all nodes in the cluster. See <a href="https://jira.mariadb.org/browse/MDEV-9856">MDEV-9856</a> about that. </li></ul> <p>And as an extra safety measure:</p> <ul start="1"><li>
<code><a href="../gtid/index.html#gtid_domain_id">gtid_domain_id</a></code> should be set to a different value on all nodes in a given cluster, and each of these values should be different than the configured <code><a href="../galera-cluster-system-variables/index.html#wsrep_gtid_domain_id">wsrep_gtid_domain_id</a></code> value. This is to prevent a node from using the same domain used for Galera Cluster's write sets when assigning <a href="../gtid/index.html">GTIDs</a> for non-Galera transactions, such as DDL executed with <code><a href="../galera-cluster-system-variables/index.html#wsrep_sst_method">wsrep_sst_method=RSU</a></code> set or DML executed with <code><a href="../galera-cluster-system-variables/index.html#wsrep_on">wsrep_on=OFF</a></code> set. </li></ul> <h2 class="anchored_heading" id="setting-up-replication">Setting up Replication</h2> <p>Our process to set up replication is going to be similar to the process described at <a href="../setting-up-a-replication-slave-with-mariabackup/index.html">Setting up a Replication Slave with Mariabackup</a>, but it will be modified a bit to work in this context.</p> <h3 class="anchored_heading" id="start-the-first-cluster">Start the First Cluster</h3> <p>The very first step is to start the nodes in the first cluster. The first node will have to be <a href="../getting-started-with-mariadb-galera-cluster/index.html#bootstrapping-a-new-cluster">bootstrapped</a>. The other nodes can be <a href="../starting-and-stopping-mariadb-starting-and-stopping-mariadb/index.html">started normally</a>.</p> <p>Once the nodes are started, you need to pick a specific node that will act as the replication primary for the second cluster.</p> <h3 class="anchored_heading" id="backup-the-database-on-the-first-clusters-primary-node-and-prepare-it">Backup the Database on the First Cluster's Primary Node and Prepare It</h3> <p>The first step is to simply take and prepare a fresh <a href="../full-backup-and-restore-with-mariabackup/index.html">full backup</a> of the node that you have chosen to be the replication primary. For example:</p> <pre class="fixed" data-language="sql">$ mariabackup --backup \
   --target-dir=/var/mariadb/backup/ \
   --user=mariabackup --password=mypassword
</pre>
<p>And then you would prepare the backup as you normally would. For example:</p> <pre class="fixed" data-language="sql">$ mariabackup --prepare \
   --target-dir=/var/mariadb/backup/ 
</pre>
<h3 class="anchored_heading" id="copy-the-backup-to-the-second-clusters-replica">Copy the Backup to the Second Cluster's Replica</h3> <p>Once the backup is done and prepared, you can copy it to the node in the second cluster that will be acting as replica. For example:</p> <pre class="fixed" data-language="sql">$ rsync -avrP /var/mariadb/backup c2dbserver:/var/mariadb/backup
</pre>
<h3 class="anchored_heading" id="restore-the-backup-on-the-second-clusters-replica">Restore the Backup on the Second Cluster's Replica</h3> <p>At this point, you can restore the backup to the <a href="../server-system-variables/index.html#datadir">datadir</a>, as you normally would. For example:</p> <pre class="fixed" data-language="sql">$ mariabackup --copy-back \
   --target-dir=/var/mariadb/backup/
</pre>
<p>And adjusting file permissions, if necessary:</p> <pre class="fixed" data-language="sql">$ chown -R mysql:mysql /var/lib/mysql/
</pre>
<h3 class="anchored_heading" id="bootstrap-the-second-clusters-replica">Bootstrap the Second Cluster's Replica</h3> <p>Now that the backup has been restored to the second cluster's replica, you can start the server by <a href="../getting-started-with-mariadb-galera-cluster/index.html#bootstrapping-a-new-cluster">bootstrapping</a> the node.</p> <h3 class="anchored_heading" id="create-a-replication-user-on-the-first-clusters-primary">Create a Replication User on the First Cluster's Primary</h3> <p>Before the second cluster's replica can begin replicating from the first cluster's primary, you need to <a href="../create-user/index.html">create a user account</a> on the primary that the replica can use to connect, and you need to <a href="../grant/index.html">grant</a> the user account the <a href="../grant/index.html#global-privileges">REPLICATION SLAVE</a> privilege. For example:</p> <pre class="fixed" data-language="sql">CREATE USER 'repl'@'c2dbserver1' IDENTIFIED BY 'password';
GRANT REPLICATION SLAVE ON *.*  TO 'repl'@'c2dbserver1';
</pre>
<h3 class="anchored_heading" id="start-replication-on-the-second-clusters-replica">Start Replication on the Second Cluster's Replica</h3> <p>At this point, you need to get the replication coordinates of the primary from the original backup.</p> <p>The coordinates will be in the <a href="../files-created-by-mariabackup/index.html#xtrabackup_binlog_info">xtrabackup_binlog_info</a> file.</p> <p>Mariabackup dumps replication coordinates in two forms: <a href="../gtid/index.html">GTID strings</a> and <a href="../binary-log/index.html">binary log</a> file and position coordinates, like the ones you would normally see from <a href="../show-master-status/index.html">SHOW MASTER STATUS</a> output. In this case, it is probably better to use the <a href="../gtid/index.html">GTID</a> coordinates.</p> <p>For example:</p> <pre class="fixed" data-language="sql">mariadb-bin.000096 568 0-1-2
</pre>
<p>Regardless of the coordinates you use, you will have to set up the primary connection using <a href="../change-master-to/index.html">CHANGE MASTER TO</a> and then start the replication threads with <a href="../start-slave/index.html">START SLAVE</a>.</p> <h4 class="anchored_heading" id="gtids">GTIDs</h4> <p>If you want to use GTIDs, then you will have to first set <a href="../gtid/index.html#gtid_slave_pos">gtid_slave_pos</a> to the <a href="../gtid/index.html">GTID</a> coordinates that we pulled from the <a href="../files-created-by-mariabackup/index.html#xtrabackup_binlog_info">xtrabackup_binlog_info</a> file, and we would set <code>MASTER_USE_GTID=slave_pos</code> in the <a href="../change-master-to/index.html">CHANGE MASTER TO</a> command. For example:</p> <pre class="fixed" data-language="sql">SET GLOBAL gtid_slave_pos = "0-1-2";
CHANGE MASTER TO 
   MASTER_HOST="c1dbserver1", 
   MASTER_PORT=3310, 
   MASTER_USER="repl",  
   MASTER_PASSWORD="password", 
   MASTER_USE_GTID=slave_pos;
START SLAVE;
</pre>
<h4 class="anchored_heading" id="file-and-position">File and Position</h4> <p>If you want to use the <a href="../binary-log/index.html">binary log</a> file and position coordinates, then you would set <code>MASTER_LOG_FILE</code> and <code>MASTER_LOG_POS</code> in the <a href="../change-master-to/index.html">CHANGE MASTER TO</a> command to the file and position coordinates that we pulled the <a href="../files-created-by-mariabackup/index.html#xtrabackup_binlog_info">xtrabackup_binlog_info</a> file. For example:</p> <pre class="fixed" data-language="sql">CHANGE MASTER TO 
   MASTER_HOST="c1dbserver1", 
   MASTER_PORT=3310, 
   MASTER_USER="repl",  
   MASTER_PASSWORD="password", 
   MASTER_LOG_FILE='mariadb-bin.000096',
   MASTER_LOG_POS=568,
START SLAVE;
</pre>
<h3 class="anchored_heading" id="check-the-status-of-the-second-clusters-replica">Check the Status of the Second Cluster's Replica</h3> <p>You should be done setting up the replica now, so you should check its status with <a href="../show-slave-status/index.html">SHOW SLAVE STATUS</a>. For example:</p> <pre class="fixed" data-language="sql">SHOW SLAVE STATUS\G
</pre>
<h3 class="anchored_heading" id="start-the-second-cluster">Start the Second Cluster</h3> <p>If the replica is replicating normally, then the next step would be to <a href="../starting-and-stopping-mariadb-starting-and-stopping-mariadb/index.html">start the MariaDB Server process</a> on the other nodes in the second cluster.</p> <p>Now that the second cluster is up, ensure that it does not start accepting writes yet if you want to set up <a href="../replication-overview/index.html#ring-replication">circular replication</a> between the two clusters.</p> <h2 class="anchored_heading" id="setting-up-circular-replication">Setting up Circular Replication</h2> <p>You can also set up <a href="../replication-overview/index.html#ring-replication">circular replication</a> between the two clusters, which means that the second cluster replicates from the first cluster, and the first cluster also replicates from the second cluster.</p> <h3 class="anchored_heading" id="create-a-replication-user-on-the-second-clusters-primary">Create a Replication User on the Second Cluster's Primary</h3> <p>Before circular replication can begin, you also need to <a href="../create-user/index.html">create a user account</a> on the second cluster's primary that the first cluster's replica can use to connect, and you need to <a href="../grant/index.html">grant</a> the user account the <a href="../grant/index.html#global-privileges">REPLICATION SLAVE</a> privilege. For example:</p> <pre class="fixed" data-language="sql">CREATE USER 'repl'@'c1dbserver1' IDENTIFIED BY 'password';
GRANT REPLICATION SLAVE ON *.*  TO 'repl'@'c1dbserver1';
</pre>
<h3 class="anchored_heading" id="start-circular-replication-on-the-first-cluster">Start Circular Replication on the First Cluster</h3> <p>How this is done would depend on whether you want to use the <a href="../gtid/index.html">GTID</a> coordinates or the <a href="../binary-log/index.html">binary log</a> file and position coordinates.</p> <p>Regardless, you need to ensure that the second cluster is not accepting any writes other than those that it replicates from the first cluster at this stage.</p> <h4 class="anchored_heading" id="gtids">GTIDs</h4> <p>To get the GTID coordinates on the second cluster, you can check <code><a href="../gtid/index.html#gtid_current_pos">gtid_current_pos</a></code> by executing:</p> <pre class="fixed" data-language="sql">SHOW GLOBAL VARIABLES LIKE 'gtid_current_pos';
</pre>
<p>Then on the first cluster, you can set up replication by setting <a href="../gtid/index.html#gtid_slave_pos">gtid_slave_pos</a> to the GTID that was returned and then executing <a href="../change-master-to/index.html">CHANGE MASTER TO</a>:</p> <pre class="fixed" data-language="sql">SET GLOBAL gtid_slave_pos = "0-1-2";
CHANGE MASTER TO 
   MASTER_HOST="c2dbserver1", 
   MASTER_PORT=3310, 
   MASTER_USER="repl",  
   MASTER_PASSWORD="password", 
   MASTER_USE_GTID=slave_pos;
START SLAVE;
</pre>
<h4 class="anchored_heading" id="file-and-position">File and Position</h4> <p>To get the <a href="../binary-log/index.html">binary log</a> file and position coordinates on the second cluster, you can execute <a href="../show-master-status/index.html">SHOW MASTER STATUS</a>:</p> <pre class="fixed" data-language="sql">SHOW MASTER STATUS
</pre>
<p>Then on the first cluster, you would set <code>master_log_file</code> and <code>master_log_pos</code> in the <a href="../change-master-to/index.html">CHANGE MASTER TO</a> command. For example:</p> <pre class="fixed" data-language="sql">CHANGE MASTER TO 
   MASTER_HOST="c2dbserver1", 
   MASTER_PORT=3310, 
   MASTER_USER="repl",  
   MASTER_PASSWORD="password", 
   MASTER_LOG_FILE='mariadb-bin.000096',
   MASTER_LOG_POS=568;
START SLAVE;
</pre>
<h3 class="anchored_heading" id="check-the-status-of-the-circular-replication">Check the Status of the Circular Replication</h3> <p>You should be done setting up the circular replication on the node in the first cluster now, so you should check its status with <a href="../show-slave-status/index.html">SHOW SLAVE STATUS</a>. For example:</p> <pre class="fixed" data-language="sql">SHOW SLAVE STATUS\G
</pre> </div>     </div> <div id="content_disclaimer" class="graybox"> Content reproduced on this site is the property of its respective owners, and this content is not reviewed in advance by MariaDB. The views, information and opinions expressed by this content do not necessarily represent those of MariaDB or any other party. </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2023 MariaDB<br>Licensed under the Creative Commons Attribution 3.0 Unported License and the GNU Free Documentation License.<br>
    <a href="https://mariadb.com/kb/en/configuring-mariadb-replication-between-two-mariadb-galera-clusters/" class="_attribution-link">https://mariadb.com/kb/en/configuring-mariadb-replication-between-two-mariadb-galera-clusters/</a>
  </p>
</div>
