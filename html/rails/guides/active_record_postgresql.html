<h1>Active Record and PostgreSQL</h1>
<div class="_simple"> <p>This guide covers PostgreSQL specific usage of Active Record.</p>
<p>After reading this guide, you will know:</p> <ul> <li>How to use PostgreSQL's datatypes.</li> <li>How to use UUID primary keys.</li> <li>How to include non-key columns in indexes.</li> <li>How to use deferrable foreign keys.</li> <li>How to use unique constraints.</li> <li>How to implement exclusion constraints.</li> <li>How to implement full text search with PostgreSQL.</li> <li>How to back your Active Record models with database views.</li> </ul>  <h2 class="chapter">  Chapters </h2> <ol class="chapters"> <li>
<a href="#datatypes">Datatypes</a> <ul> <li><a href="#bytea">Bytea</a></li> <li><a href="#array">Array</a></li> <li><a href="#hstore">Hstore</a></li> <li><a href="#json-and-jsonb">JSON and JSONB</a></li> <li><a href="#range-types">Range Types</a></li> <li><a href="#composite-types">Composite Types</a></li> <li><a href="#enumerated-types">Enumerated Types</a></li> <li><a href="#uuid">UUID</a></li> <li><a href="#bit-string-types">Bit String Types</a></li> <li><a href="#network-address-types">Network Address Types</a></li> <li><a href="#geometric-types">Geometric Types</a></li> <li><a href="#interval">Interval</a></li> </ul>
</li> <li><a href="#uuid-primary-keys">UUID Primary Keys</a></li> <li>
<a href="#indexing">Indexing</a> <ul> <li><a href="#include">Include</a></li> </ul>
</li> <li><a href="#generated-columns">Generated Columns</a></li> <li><a href="#deferrable-foreign-keys">Deferrable Foreign Keys</a></li> <li><a href="#unique-constraint">Unique Constraint</a></li> <li><a href="#exclusion-constraints">Exclusion Constraints</a></li> <li><a href="#full-text-search">Full Text Search</a></li> <li><a href="#database-views">Database Views</a></li> <li><a href="#structure-dumps">Structure Dumps</a></li> </ol>  <hr>  <p>In order to use the PostgreSQL adapter you need to have at least version 9.3 installed. Older versions are not supported.</p>
<p>To get started with PostgreSQL have a look at the <a href="configuring.html#configuring-a-postgresql-database">configuring Rails guide</a>. It describes how to properly set up Active Record for PostgreSQL.</p>
<h1 id="datatypes"><a class="anchorlink" href="#datatypes"><span>1</span> Datatypes</a></h1>
<p>PostgreSQL offers a number of specific datatypes. Following is a list of types, that are supported by the PostgreSQL adapter.</p>
<h2 id="bytea"><a class="anchorlink" href="#bytea"><span>1.1</span> Bytea</a></h2> <ul> <li><a href="https://www.postgresql.org/docs/current/static/datatype-binary.html">type definition</a></li> <li><a href="https://www.postgresql.org/docs/current/static/functions-binarystring.html">functions and operators</a></li> </ul> <div class="interstitial code"> <pre data-language="ruby"># db/migrate/20140207133952_create_documents.rb
create_table :documents do |t|
  t.binary 'payload'
end</pre> <button class="clipboard-button" data-clipboard-text="create_table :documents do |t|
  t.binary 'payload'
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="ruby"># app/models/document.rb
class Document &lt; ApplicationRecord
end</pre> <button class="clipboard-button" data-clipboard-text="class Document &lt; ApplicationRecord
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="ruby"># Usage
data = File.read(Rails.root + "tmp/output.pdf")
Document.create payload: data</pre> <button class="clipboard-button" data-clipboard-text='# Usage
data = File.read(Rails.root + "tmp/output.pdf")
Document.create payload: data
'>Copy</button> </div> <h2 id="array"><a class="anchorlink" href="#array"><span>1.2</span> Array</a></h2> <ul> <li><a href="https://www.postgresql.org/docs/current/static/arrays.html">type definition</a></li> <li><a href="https://www.postgresql.org/docs/current/static/functions-array.html">functions and operators</a></li> </ul> <div class="interstitial code"> <pre data-language="ruby"># db/migrate/20140207133952_create_books.rb
create_table :books do |t|
  t.string 'title'
  t.string 'tags', array: true
  t.integer 'ratings', array: true
end
add_index :books, :tags, using: 'gin'
add_index :books, :ratings, using: 'gin'</pre> <button class="clipboard-button" data-clipboard-text="create_table :books do |t|
  t.string 'title'
  t.string 'tags', array: true
  t.integer 'ratings', array: true
end
add_index :books, :tags, using: 'gin'
add_index :books, :ratings, using: 'gin'
">Copy</button> </div> <div class="interstitial code"> <pre data-language="ruby"># app/models/book.rb
class Book &lt; ApplicationRecord
end</pre> <button class="clipboard-button" data-clipboard-text="class Book &lt; ApplicationRecord
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="ruby"># Usage
Book.create title: "Brave New World",
            tags: ["fantasy", "fiction"],
            ratings: [4, 5]

## Books for a single tag
Book.where("'fantasy' = ANY (tags)")

## Books for multiple tags
Book.where("tags @&gt; ARRAY[?]::varchar[]", ["fantasy", "fiction"])

## Books with 3 or more ratings
Book.where("array_length(ratings, 1) &gt;= 3")</pre> <button class="clipboard-button" data-clipboard-text="# Usage
Book.create title: &quot;Brave New World&quot;,
            tags: [&quot;fantasy&quot;, &quot;fiction&quot;],
            ratings: [4, 5]

## Books for a single tag
Book.where(&quot;'fantasy' = ANY (tags)&quot;)

## Books for multiple tags
Book.where(&quot;tags @&gt; ARRAY[?]::varchar[]&quot;, [&quot;fantasy&quot;, &quot;fiction&quot;])

## Books with 3 or more ratings
Book.where(&quot;array_length(ratings, 1) &gt;= 3&quot;)
">Copy</button> </div> <h2 id="hstore"><a class="anchorlink" href="#hstore"><span>1.3</span> Hstore</a></h2> <ul> <li><a href="https://www.postgresql.org/docs/current/static/hstore.html">type definition</a></li> <li><a href="https://www.postgresql.org/docs/current/static/hstore.html#id-1.11.7.26.5">functions and operators</a></li> </ul> <div class="interstitial note"><p>You need to enable the <code>hstore</code> extension to use hstore.</p></div>
<div class="interstitial code"> <pre data-language="ruby"># db/migrate/20131009135255_create_profiles.rb
class CreateProfiles &lt; ActiveRecord::Migration[7.0]
  enable_extension 'hstore' unless extension_enabled?('hstore')
  create_table :profiles do |t|
    t.hstore 'settings'
  end
end</pre> <button class="clipboard-button" data-clipboard-text="class CreateProfiles &lt; ActiveRecord::Migration[7.0]
  enable_extension 'hstore' unless extension_enabled?('hstore')
  create_table :profiles do |t|
    t.hstore 'settings'
  end
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="ruby"># app/models/profile.rb
class Profile &lt; ApplicationRecord
end</pre> <button class="clipboard-button" data-clipboard-text="class Profile &lt; ApplicationRecord
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="irb">irb&gt; Profile.create(settings: { "color" =&gt; "blue", "resolution" =&gt; "800x600" })

irb&gt; profile = Profile.first
irb&gt; profile.settings
=&gt; {"color"=&gt;"blue", "resolution"=&gt;"800x600"}

irb&gt; profile.settings = {"color" =&gt; "yellow", "resolution" =&gt; "1280x1024"}
irb&gt; profile.save!

irb&gt; Profile.where("settings-&gt;'color' = ?", "yellow")
=&gt; #&lt;ActiveRecord::Relation [#&lt;Profile id: 1, settings: {"color"=&gt;"yellow", "resolution"=&gt;"1280x1024"}&gt;]&gt;</pre> <button class="clipboard-button" data-clipboard-text="Profile.create(settings: { &quot;color&quot; =&gt; &quot;blue&quot;, &quot;resolution&quot; =&gt; &quot;800x600&quot; })
profile = Profile.first
profile.settings
profile.settings = {&quot;color&quot; =&gt; &quot;yellow&quot;, &quot;resolution&quot; =&gt; &quot;1280x1024&quot;}
profile.save!
Profile.where(&quot;settings-&gt;'color' = ?&quot;, &quot;yellow&quot;)
">Copy</button> </div> <h2 id="json-and-jsonb"><a class="anchorlink" href="#json-and-jsonb"><span>1.4</span> JSON and JSONB</a></h2> <ul> <li><a href="https://www.postgresql.org/docs/current/static/datatype-json.html">type definition</a></li> <li><a href="https://www.postgresql.org/docs/current/static/functions-json.html">functions and operators</a></li> </ul> <div class="interstitial code"> <pre data-language="ruby"># db/migrate/20131220144913_create_events.rb
# ... for json datatype:
create_table :events do |t|
  t.json 'payload'
end
# ... or for jsonb datatype:
create_table :events do |t|
  t.jsonb 'payload'
end</pre> <button class="clipboard-button" data-clipboard-text="# ... for json datatype:
create_table :events do |t|
  t.json 'payload'
end
# ... or for jsonb datatype:
create_table :events do |t|
  t.jsonb 'payload'
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="ruby"># app/models/event.rb
class Event &lt; ApplicationRecord
end</pre> <button class="clipboard-button" data-clipboard-text="class Event &lt; ApplicationRecord
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="irb">irb&gt; Event.create(payload: { kind: "user_renamed", change: ["jack", "john"]})

irb&gt; event = Event.first
irb&gt; event.payload
=&gt; {"kind"=&gt;"user_renamed", "change"=&gt;["jack", "john"]}

## Query based on JSON document
# The -&gt; operator returns the original JSON type (which might be an object), whereas -&gt;&gt; returns text
irb&gt; Event.where("payload-&gt;&gt;'kind' = ?", "user_renamed")</pre> <button class="clipboard-button" data-clipboard-text="Event.create(payload: { kind: &quot;user_renamed&quot;, change: [&quot;jack&quot;, &quot;john&quot;]})
event = Event.first
event.payload
Event.where(&quot;payload-&gt;&gt;'kind' = ?&quot;, &quot;user_renamed&quot;)
">Copy</button> </div> <h2 id="range-types"><a class="anchorlink" href="#range-types"><span>1.5</span> Range Types</a></h2> <ul> <li><a href="https://www.postgresql.org/docs/current/static/rangetypes.html">type definition</a></li> <li><a href="https://www.postgresql.org/docs/current/static/functions-range.html">functions and operators</a></li> </ul> <p>This type is mapped to Ruby <a href="https://docs.ruby-lang.org/en/master/Range.html"><code>Range</code></a> objects.</p>
<div class="interstitial code"> <pre data-language="ruby"># db/migrate/20130923065404_create_events.rb
create_table :events do |t|
  t.daterange 'duration'
end</pre> <button class="clipboard-button" data-clipboard-text="create_table :events do |t|
  t.daterange 'duration'
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="ruby"># app/models/event.rb
class Event &lt; ApplicationRecord
end</pre> <button class="clipboard-button" data-clipboard-text="class Event &lt; ApplicationRecord
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="irb">irb&gt; Event.create(duration: Date.new(2014, 2, 11)..Date.new(2014, 2, 12))

irb&gt; event = Event.first
irb&gt; event.duration
=&gt; Tue, 11 Feb 2014...Thu, 13 Feb 2014

## All Events on a given date
irb&gt; Event.where("duration @&gt; ?::date", Date.new(2014, 2, 12))

## Working with range bounds
irb&gt; event = Event.select("lower(duration) AS starts_at").select("upper(duration) AS ends_at").first

irb&gt; event.starts_at
=&gt; Tue, 11 Feb 2014
irb&gt; event.ends_at
=&gt; Thu, 13 Feb 2014</pre> <button class="clipboard-button" data-clipboard-text='Event.create(duration: Date.new(2014, 2, 11)..Date.new(2014, 2, 12))
event = Event.first
event.duration
Event.where("duration @&gt; ?::date", Date.new(2014, 2, 12))
event = Event.select("lower(duration) AS starts_at").select("upper(duration) AS ends_at").first
event.starts_at
event.ends_at
'>Copy</button> </div> <h2 id="composite-types"><a class="anchorlink" href="#composite-types"><span>1.6</span> Composite Types</a></h2> <ul> <li><a href="https://www.postgresql.org/docs/current/static/rowtypes.html">type definition</a></li> </ul> <p>Currently there is no special support for composite types. They are mapped to normal text columns:</p>
<div class="interstitial code"> <pre data-language="sql">CREATE TYPE full_address AS
(
  city VARCHAR(90),
  street VARCHAR(90)
);</pre> <button class="clipboard-button" data-clipboard-text="CREATE TYPE full_address AS
(
  city VARCHAR(90),
  street VARCHAR(90)
);
">Copy</button> </div> <div class="interstitial code"> <pre data-language="ruby"># db/migrate/20140207133952_create_contacts.rb
execute &lt;&lt;-SQL
  CREATE TYPE full_address AS
  (
    city VARCHAR(90),
    street VARCHAR(90)
  );
SQL
create_table :contacts do |t|
  t.column :address, :full_address
end</pre> <button class="clipboard-button" data-clipboard-text="execute &lt;&lt;-SQL
  CREATE TYPE full_address AS
  (
    city VARCHAR(90),
    street VARCHAR(90)
  );
SQL
create_table :contacts do |t|
  t.column :address, :full_address
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="ruby"># app/models/contact.rb
class Contact &lt; ApplicationRecord
end</pre> <button class="clipboard-button" data-clipboard-text="class Contact &lt; ApplicationRecord
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="irb">irb&gt; Contact.create address: "(Paris,Champs-Élysées)"
irb&gt; contact = Contact.first
irb&gt; contact.address
=&gt; "(Paris,Champs-Élysées)"
irb&gt; contact.address = "(Paris,Rue Basse)"
irb&gt; contact.save!</pre> <button class="clipboard-button" data-clipboard-text='Contact.create address: "(Paris,Champs-Élysées)"
contact = Contact.first
contact.address
contact.address = "(Paris,Rue Basse)"
contact.save!
'>Copy</button> </div> <h2 id="enumerated-types"><a class="anchorlink" href="#enumerated-types"><span>1.7</span> Enumerated Types</a></h2> <ul> <li><a href="https://www.postgresql.org/docs/current/static/datatype-enum.html">type definition</a></li> </ul> <p>The type can be mapped as a normal text column, or to an <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/Enum.html"><code>ActiveRecord::Enum</code></a>.</p>
<div class="interstitial code"> <pre data-language="ruby"># db/migrate/20131220144913_create_articles.rb
def change
  create_enum :article_status, ["draft", "published", "archived"]

  create_table :articles do |t|
    t.enum :status, enum_type: :article_status, default: "draft", null: false
  end
end</pre> <button class="clipboard-button" data-clipboard-text='def change
  create_enum :article_status, ["draft", "published", "archived"]

  create_table :articles do |t|
    t.enum :status, enum_type: :article_status, default: "draft", null: false
  end
end
'>Copy</button> </div> <p>You can also create an enum type and add an enum column to an existing table:</p>
<div class="interstitial code"> <pre data-language="ruby"># db/migrate/20230113024409_add_status_to_articles.rb
def change
  create_enum :article_status, ["draft", "published", "archived"]

  add_column :articles, :status, :enum, enum_type: :article_status, default: "draft", null: false
end</pre> <button class="clipboard-button" data-clipboard-text='def change
  create_enum :article_status, ["draft", "published", "archived"]

  add_column :articles, :status, :enum, enum_type: :article_status, default: "draft", null: false
end
'>Copy</button> </div> <p>The above migrations are both reversible, but you can define separate <code>#up</code> and <code>#down</code> methods if required. Make sure you remove any columns or tables that depend on the enum type before dropping it:</p>
<div class="interstitial code"> <pre data-language="ruby">def down
  drop_table :articles

  # OR: remove_column :articles, :status
  drop_enum :article_status
end</pre> <button class="clipboard-button" data-clipboard-text="def down
  drop_table :articles

  # OR: remove_column :articles, :status
  drop_enum :article_status
end
">Copy</button> </div> <p>Declaring an enum attribute in the model adds helper methods and prevents invalid values from being assigned to instances of the class:</p>
<div class="interstitial code"> <pre data-language="ruby"># app/models/article.rb
class Article &lt; ApplicationRecord
  enum :status, {
    draft: "draft", published: "published", archived: "archived"
  }, prefix: true
end</pre> <button class="clipboard-button" data-clipboard-text='class Article &lt; ApplicationRecord
  enum :status, {
    draft: "draft", published: "published", archived: "archived"
  }, prefix: true
end
'>Copy</button> </div> <div class="interstitial code"> <pre data-language="irb">irb&gt; article = Article.create
irb&gt; article.status
=&gt; "draft" # default status from PostgreSQL, as defined in migration above

irb&gt; article.status_published!
irb&gt; article.status
=&gt; "published"

irb&gt; article.status_archived?
=&gt; false

irb&gt; article.status = "deleted"
ArgumentError: 'deleted' is not a valid status</pre> <button class="clipboard-button" data-clipboard-text='article = Article.create
article.status
article.status_published!
article.status
article.status_archived?
article.status = "deleted"
'>Copy</button> </div> <p>To rename the enum you can use <code>rename_enum</code> along with updating any model usage:</p>
<div class="interstitial code"> <pre data-language="ruby"># db/migrate/20150718144917_rename_article_status.rb
def change
  rename_enum :article_status, to: :article_state
end</pre> <button class="clipboard-button" data-clipboard-text="def change
  rename_enum :article_status, to: :article_state
end
">Copy</button> </div> <p>To add a new value you can use <code>add_enum_value</code>:</p>
<div class="interstitial code"> <pre data-language="ruby"># db/migrate/20150720144913_add_new_state_to_articles.rb
def up
  add_enum_value :article_state, "archived" # will be at the end after published
  add_enum_value :article_state, "in review", before: "published"
  add_enum_value :article_state, "approved", after: "in review"
end</pre> <button class="clipboard-button" data-clipboard-text='def up
  add_enum_value :article_state, "archived" # will be at the end after published
  add_enum_value :article_state, "in review", before: "published"
  add_enum_value :article_state, "approved", after: "in review"
end
'>Copy</button> </div> <div class="interstitial note"><p>Enum values can't be dropped, which also means add_enum_value is irreversible. You can read why <a href="https://www.postgresql.org/message-id/29F36C7C98AB09499B1A209D48EAA615B7653DBC8A@mail2a.alliedtesting.com">here</a>.</p></div>
<p>To rename a value you can use <code>rename_enum_value</code>:</p>
<div class="interstitial code"> <pre data-language="ruby"># db/migrate/20150722144915_rename_article_state.rb
def change
  rename_enum_value :article_state, from: "archived", to: "deleted"
end</pre> <button class="clipboard-button" data-clipboard-text='def change
  rename_enum_value :article_state, from: "archived", to: "deleted"
end
'>Copy</button> </div> <p>Hint: to show all the values of the all enums you have, you can call this query in <code>bin/rails db</code> or <code>psql</code> console:</p>
<div class="interstitial code"> <pre data-language="sql">SELECT n.nspname AS enum_schema,
       t.typname AS enum_name,
       e.enumlabel AS enum_value
  FROM pg_type t
      JOIN pg_enum e ON t.oid = e.enumtypid
      JOIN pg_catalog.pg_namespace n ON n.oid = t.typnamespace</pre> <button class="clipboard-button" data-clipboard-text="SELECT n.nspname AS enum_schema,
       t.typname AS enum_name,
       e.enumlabel AS enum_value
  FROM pg_type t
      JOIN pg_enum e ON t.oid = e.enumtypid
      JOIN pg_catalog.pg_namespace n ON n.oid = t.typnamespace
">Copy</button> </div> <h2 id="uuid"><a class="anchorlink" href="#uuid"><span>1.8</span> UUID</a></h2> <ul> <li><a href="https://www.postgresql.org/docs/current/static/datatype-uuid.html">type definition</a></li> <li><a href="https://www.postgresql.org/docs/current/static/pgcrypto.html">pgcrypto generator function</a></li> <li><a href="https://www.postgresql.org/docs/current/static/uuid-ossp.html">uuid-ossp generator functions</a></li> </ul> <div class="interstitial note"><p>If you're using PostgreSQL earlier than version 13.0 you may need to enable special extensions to use UUIDs. Enable the <code>pgcrypto</code> extension (PostgreSQL &gt;= 9.4) or <code>uuid-ossp</code> extension (for even earlier releases).</p></div>
<div class="interstitial code"> <pre data-language="ruby"># db/migrate/20131220144913_create_revisions.rb
create_table :revisions do |t|
  t.uuid :identifier
end</pre> <button class="clipboard-button" data-clipboard-text="create_table :revisions do |t|
  t.uuid :identifier
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="ruby"># app/models/revision.rb
class Revision &lt; ApplicationRecord
end</pre> <button class="clipboard-button" data-clipboard-text="class Revision &lt; ApplicationRecord
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="irb">irb&gt; Revision.create identifier: "A0EEBC99-9C0B-4EF8-BB6D-6BB9BD380A11"

irb&gt; revision = Revision.first
irb&gt; revision.identifier
=&gt; "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"</pre> <button class="clipboard-button" data-clipboard-text='Revision.create identifier: "A0EEBC99-9C0B-4EF8-BB6D-6BB9BD380A11"
revision = Revision.first
revision.identifier
'>Copy</button> </div> <p>You can use <code>uuid</code> type to define references in migrations:</p>
<div class="interstitial code"> <pre data-language="ruby"># db/migrate/20150418012400_create_blog.rb
enable_extension 'pgcrypto' unless extension_enabled?('pgcrypto')
create_table :posts, id: :uuid

create_table :comments, id: :uuid do |t|
  # t.belongs_to :post, type: :uuid
  t.references :post, type: :uuid
end</pre> <button class="clipboard-button" data-clipboard-text="enable_extension 'pgcrypto' unless extension_enabled?('pgcrypto')
create_table :posts, id: :uuid

create_table :comments, id: :uuid do |t|
  # t.belongs_to :post, type: :uuid
  t.references :post, type: :uuid
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="ruby"># app/models/post.rb
class Post &lt; ApplicationRecord
  has_many :comments
end</pre> <button class="clipboard-button" data-clipboard-text="class Post &lt; ApplicationRecord
  has_many :comments
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="ruby"># app/models/comment.rb
class Comment &lt; ApplicationRecord
  belongs_to :post
end</pre> <button class="clipboard-button" data-clipboard-text="class Comment &lt; ApplicationRecord
  belongs_to :post
end
">Copy</button> </div> <p>See <a href="#uuid-primary-keys">this section</a> for more details on using UUIDs as primary key.</p>
<h2 id="bit-string-types"><a class="anchorlink" href="#bit-string-types"><span>1.9</span> Bit String Types</a></h2> <ul> <li><a href="https://www.postgresql.org/docs/current/static/datatype-bit.html">type definition</a></li> <li><a href="https://www.postgresql.org/docs/current/static/functions-bitstring.html">functions and operators</a></li> </ul> <div class="interstitial code"> <pre data-language="ruby"># db/migrate/20131220144913_create_users.rb
create_table :users, force: true do |t|
  t.column :settings, "bit(8)"
end</pre> <button class="clipboard-button" data-clipboard-text='create_table :users, force: true do |t|
  t.column :settings, "bit(8)"
end
'>Copy</button> </div> <div class="interstitial code"> <pre data-language="ruby"># app/models/user.rb
class User &lt; ApplicationRecord
end</pre> <button class="clipboard-button" data-clipboard-text="class User &lt; ApplicationRecord
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="irb">irb&gt; User.create settings: "01010011"
irb&gt; user = User.first
irb&gt; user.settings
=&gt; "01010011"
irb&gt; user.settings = "0xAF"
irb&gt; user.settings
=&gt; "10101111"
irb&gt; user.save!</pre> <button class="clipboard-button" data-clipboard-text='User.create settings: "01010011"
user = User.first
user.settings
user.settings = "0xAF"
user.settings
user.save!
'>Copy</button> </div> <h2 id="network-address-types"><a class="anchorlink" href="#network-address-types"><span>1.10</span> Network Address Types</a></h2> <ul> <li><a href="https://www.postgresql.org/docs/current/static/datatype-net-types.html">type definition</a></li> </ul> <p>The types <code>inet</code> and <code>cidr</code> are mapped to Ruby <a href="https://docs.ruby-lang.org/en/master/IPAddr.html"><code>IPAddr</code></a> objects. The <code>macaddr</code> type is mapped to normal text.</p>
<div class="interstitial code"> <pre data-language="ruby"># db/migrate/20140508144913_create_devices.rb
create_table(:devices, force: true) do |t|
  t.inet 'ip'
  t.cidr 'network'
  t.macaddr 'address'
end</pre> <button class="clipboard-button" data-clipboard-text="create_table(:devices, force: true) do |t|
  t.inet 'ip'
  t.cidr 'network'
  t.macaddr 'address'
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="ruby"># app/models/device.rb
class Device &lt; ApplicationRecord
end</pre> <button class="clipboard-button" data-clipboard-text="class Device &lt; ApplicationRecord
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="irb">irb&gt; macbook = Device.create(ip: "192.168.1.12", network: "192.168.2.0/24", address: "32:01:16:6d:05:ef")

irb&gt; macbook.ip
=&gt; #&lt;IPAddr: IPv4:192.168.1.12/255.255.255.255&gt;

irb&gt; macbook.network
=&gt; #&lt;IPAddr: IPv4:192.168.2.0/255.255.255.0&gt;

irb&gt; macbook.address
=&gt; "32:01:16:6d:05:ef"</pre> <button class="clipboard-button" data-clipboard-text='macbook = Device.create(ip: "192.168.1.12", network: "192.168.2.0/24", address: "32:01:16:6d:05:ef")
macbook.ip
macbook.network
macbook.address
'>Copy</button> </div> <h2 id="geometric-types"><a class="anchorlink" href="#geometric-types"><span>1.11</span> Geometric Types</a></h2> <ul> <li><a href="https://www.postgresql.org/docs/current/static/datatype-geometric.html">type definition</a></li> </ul> <p>All geometric types, with the exception of <code>points</code> are mapped to normal text. A point is cast to an array containing <code>x</code> and <code>y</code> coordinates.</p>
<h2 id="interval"><a class="anchorlink" href="#interval"><span>1.12</span> Interval</a></h2> <ul> <li><a href="https://www.postgresql.org/docs/current/static/datatype-datetime.html#DATATYPE-INTERVAL-INPUT">type definition</a></li> <li><a href="https://www.postgresql.org/docs/current/static/functions-datetime.html">functions and operators</a></li> </ul> <p>This type is mapped to <a href="https://edgeapi.rubyonrails.org/classes/ActiveSupport/Duration.html"><code>ActiveSupport::Duration</code></a> objects.</p>
<div class="interstitial code"> <pre data-language="ruby"># db/migrate/20200120000000_create_events.rb
create_table :events do |t|
  t.interval 'duration'
end</pre> <button class="clipboard-button" data-clipboard-text="create_table :events do |t|
  t.interval 'duration'
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="ruby"># app/models/event.rb
class Event &lt; ApplicationRecord
end</pre> <button class="clipboard-button" data-clipboard-text="class Event &lt; ApplicationRecord
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="irb">irb&gt; Event.create(duration: 2.days)

irb&gt; event = Event.first
irb&gt; event.duration
=&gt; 2 days</pre> <button class="clipboard-button" data-clipboard-text="Event.create(duration: 2.days)
event = Event.first
event.duration
">Copy</button> </div> <h1 id="uuid-primary-keys"><a class="anchorlink" href="#uuid-primary-keys"><span>2</span> UUID Primary Keys</a></h1>
<div class="interstitial note"><p>You need to enable the <code>pgcrypto</code> (only PostgreSQL &gt;= 9.4) or <code>uuid-ossp</code> extension to generate random UUIDs.</p></div>
<div class="interstitial code"> <pre data-language="ruby"># db/migrate/20131220144913_create_devices.rb
enable_extension 'pgcrypto' unless extension_enabled?('pgcrypto')
create_table :devices, id: :uuid do |t|
  t.string :kind
end</pre> <button class="clipboard-button" data-clipboard-text="enable_extension 'pgcrypto' unless extension_enabled?('pgcrypto')
create_table :devices, id: :uuid do |t|
  t.string :kind
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="ruby"># app/models/device.rb
class Device &lt; ApplicationRecord
end</pre> <button class="clipboard-button" data-clipboard-text="class Device &lt; ApplicationRecord
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="irb">irb&gt; device = Device.create
irb&gt; device.id
=&gt; "814865cd-5a1d-4771-9306-4268f188fe9e"</pre> <button class="clipboard-button" data-clipboard-text="device = Device.create
device.id
">Copy</button> </div> <div class="interstitial note"><p><code>gen_random_uuid()</code> (from <code>pgcrypto</code>) is assumed if no <code>:default</code> option was passed to <code>create_table</code>.</p></div>
<p>To use the Rails model generator for a table using UUID as the primary key, pass <code>--primary-key-type=uuid</code> to the model generator.</p>
<p>For example:</p>
<div class="interstitial code"> <pre data-language="console">$ rails generate model Device --primary-key-type=uuid kind:string</pre> <button class="clipboard-button" data-clipboard-text="rails generate model Device --primary-key-type=uuid kind:string
">Copy</button> </div> <p>When building a model with a foreign key that will reference this UUID, treat <code>uuid</code> as the native field type, for example:</p>
<div class="interstitial code"> <pre data-language="console">$ rails generate model Case device_id:uuid</pre> <button class="clipboard-button" data-clipboard-text="rails generate model Case device_id:uuid
">Copy</button> </div> <h1 id="indexing"><a class="anchorlink" href="#indexing"><span>3</span> Indexing</a></h1> <ul> <li><a href="https://www.postgresql.org/docs/current/sql-createindex.html">index creation</a></li> </ul> <p>PostgreSQL includes a variety of index options. The following options are supported by the PostgreSQL adapter in addition to the <a href="https://edgeapi.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_index">common index options</a></p>
<h2 id="include"><a class="anchorlink" href="#include"><span>3.1</span> Include</a></h2>
<p>When creating a new index, non-key columns can be included with the <code>:include</code> option. These keys are not used in index scans for searching, but can be read during an index only scan without having to visit the associated table.</p>
<div class="interstitial code"> <pre data-language="ruby"># db/migrate/20131220144913_add_index_users_on_email_include_id.rb

add_index :users, :email, include: :id</pre> <button class="clipboard-button" data-clipboard-text="
add_index :users, :email, include: :id
">Copy</button> </div> <p>Multiple columns are supported:</p>
<div class="interstitial code"> <pre data-language="ruby"># db/migrate/20131220144913_add_index_users_on_email_include_id_and_created_at.rb

add_index :users, :email, include: [:id, :created_at]</pre> <button class="clipboard-button" data-clipboard-text="
add_index :users, :email, include: [:id, :created_at]
">Copy</button> </div> <h1 id="generated-columns"><a class="anchorlink" href="#generated-columns"><span>4</span> Generated Columns</a></h1>
<div class="interstitial note"><p>Generated columns are supported since version 12.0 of PostgreSQL.</p></div>
<div class="interstitial code"> <pre data-language="ruby"># db/migrate/20131220144913_create_users.rb
create_table :users do |t|
  t.string :name
  t.virtual :name_upcased, type: :string, as: 'upper(name)', stored: true
end

# app/models/user.rb
class User &lt; ApplicationRecord
end

# Usage
user = User.create(name: 'John')
User.last.name_upcased # =&gt; "JOHN"</pre> <button class="clipboard-button" data-clipboard-text="create_table :users do |t|
  t.string :name
  t.virtual :name_upcased, type: :string, as: 'upper(name)', stored: true
end

class User &lt; ApplicationRecord
end

# Usage
user = User.create(name: 'John')
User.last.name_upcased # =&gt; &quot;JOHN&quot;
">Copy</button> </div> <h1 id="deferrable-foreign-keys"><a class="anchorlink" href="#deferrable-foreign-keys"><span>5</span> Deferrable Foreign Keys</a></h1> <ul> <li><a href="https://www.postgresql.org/docs/current/sql-set-constraints.html">foreign key table constraints</a></li> </ul> <p>By default, table constraints in PostgreSQL are checked immediately after each statement. It intentionally does not allow creating records where the referenced record is not yet in the referenced table. It is possible to run this integrity check later on when the transaction is committed by adding <code>DEFERRABLE</code> to the foreign key definition though. To defer all checks by default it can be set to <code>DEFERRABLE INITIALLY DEFERRED</code>. Rails exposes this PostgreSQL feature by adding the <code>:deferrable</code> key to the <code>foreign_key</code> options in the <code>add_reference</code> and <code>add_foreign_key</code> methods.</p>
<p>One example of this is creating circular dependencies in a transaction even if you have created foreign keys:</p>
<div class="interstitial code"> <pre data-language="ruby">add_reference :person, :alias, foreign_key: { deferrable: :deferred }
add_reference :alias, :person, foreign_key: { deferrable: :deferred }</pre> <button class="clipboard-button" data-clipboard-text="add_reference :person, :alias, foreign_key: { deferrable: :deferred }
add_reference :alias, :person, foreign_key: { deferrable: :deferred }
">Copy</button> </div> <p>If the reference was created with the <code>foreign_key: true</code> option, the following transaction would fail when executing the first <code>INSERT</code> statement. It does not fail when the <code>deferrable: :deferred</code> option is set though.</p>
<div class="interstitial code"> <pre data-language="ruby">ActiveRecord::Base.connection.transaction do
  person = Person.create(id: SecureRandom.uuid, alias_id: SecureRandom.uuid, name: "John Doe")
  Alias.create(id: person.alias_id, person_id: person.id, name: "jaydee")
end</pre> <button class="clipboard-button" data-clipboard-text='ActiveRecord::Base.connection.transaction do
  person = Person.create(id: SecureRandom.uuid, alias_id: SecureRandom.uuid, name: "John Doe")
  Alias.create(id: person.alias_id, person_id: person.id, name: "jaydee")
end
'>Copy</button> </div> <p>When the <code>:deferrable</code> option is set to <code>:immediate</code>, let the foreign keys keep the default behavior of checking the constraint immediately, but allow manually deferring the checks using <code>set_constraints</code> within a transaction. This will cause the foreign keys to be checked when the transaction is committed:</p>
<div class="interstitial code"> <pre data-language="ruby">ActiveRecord::Base.connection.transaction do
  ActiveRecord::Base.connection.set_constraints(:deferred)
  person = Person.create(alias_id: SecureRandom.uuid, name: "John Doe")
  Alias.create(id: person.alias_id, person_id: person.id, name: "jaydee")
end</pre> <button class="clipboard-button" data-clipboard-text='ActiveRecord::Base.connection.transaction do
  ActiveRecord::Base.connection.set_constraints(:deferred)
  person = Person.create(alias_id: SecureRandom.uuid, name: "John Doe")
  Alias.create(id: person.alias_id, person_id: person.id, name: "jaydee")
end
'>Copy</button> </div> <p>By default <code>:deferrable</code> is <code>false</code> and the constraint is always checked immediately.</p>
<h1 id="unique-constraint"><a class="anchorlink" href="#unique-constraint"><span>6</span> Unique Constraint</a></h1> <ul> <li><a href="https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-UNIQUE-CONSTRAINTS">unique constraints</a></li> </ul> <div class="interstitial code"> <pre data-language="ruby"># db/migrate/20230422225213_create_items.rb
create_table :items do |t|
  t.integer :position, null: false
  t.unique_constraint [:position], deferrable: :immediate
end</pre> <button class="clipboard-button" data-clipboard-text="create_table :items do |t|
  t.integer :position, null: false
  t.unique_constraint [:position], deferrable: :immediate
end
">Copy</button> </div> <p>If you want to change an existing unique index to deferrable, you can use <code>:using_index</code> to create deferrable unique constraints.</p>
<div class="interstitial code"> <pre data-language="ruby">add_unique_constraint :items, deferrable: :deferred, using_index: "index_items_on_position"</pre> <button class="clipboard-button" data-clipboard-text='add_unique_constraint :items, deferrable: :deferred, using_index: "index_items_on_position"
'>Copy</button> </div> <p>Like foreign keys, unique constraints can be deferred by setting <code>:deferrable</code> to either <code>:immediate</code> or <code>:deferred</code>. By default, <code>:deferrable</code> is <code>false</code> and the constraint is always checked immediately.</p>
<h1 id="exclusion-constraints"><a class="anchorlink" href="#exclusion-constraints"><span>7</span> Exclusion Constraints</a></h1> <ul> <li><a href="https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-EXCLUSION">exclusion constraints</a></li> </ul> <div class="interstitial code"> <pre data-language="ruby"># db/migrate/20131220144913_create_products.rb
create_table :products do |t|
  t.integer :price, null: false
  t.daterange :availability_range, null: false

  t.exclusion_constraint "price WITH =, availability_range WITH &amp;&amp;", using: :gist, name: "price_check"
end</pre> <button class="clipboard-button" data-clipboard-text='create_table :products do |t|
  t.integer :price, null: false
  t.daterange :availability_range, null: false

  t.exclusion_constraint "price WITH =, availability_range WITH &amp;&amp;", using: :gist, name: "price_check"
end
'>Copy</button> </div> <p>Like foreign keys, exclusion constraints can be deferred by setting <code>:deferrable</code> to either <code>:immediate</code> or <code>:deferred</code>. By default, <code>:deferrable</code> is <code>false</code> and the constraint is always checked immediately.</p>
<h1 id="full-text-search"><a class="anchorlink" href="#full-text-search"><span>8</span> Full Text Search</a></h1>
<div class="interstitial code"> <pre data-language="ruby"># db/migrate/20131220144913_create_documents.rb
create_table :documents do |t|
  t.string :title
  t.string :body
end

add_index :documents, "to_tsvector('english', title || ' ' || body)", using: :gin, name: 'documents_idx'</pre> <button class="clipboard-button" data-clipboard-text="create_table :documents do |t|
  t.string :title
  t.string :body
end

add_index :documents, &quot;to_tsvector('english', title || ' ' || body)&quot;, using: :gin, name: 'documents_idx'
">Copy</button> </div> <div class="interstitial code"> <pre data-language="ruby"># app/models/document.rb
class Document &lt; ApplicationRecord
end</pre> <button class="clipboard-button" data-clipboard-text="class Document &lt; ApplicationRecord
end
">Copy</button> </div> <div class="interstitial code"> <pre data-language="ruby"># Usage
Document.create(title: "Cats and Dogs", body: "are nice!")

## all documents matching 'cat &amp; dog'
Document.where("to_tsvector('english', title || ' ' || body) @@ to_tsquery(?)",
                 "cat &amp; dog")</pre> <button class="clipboard-button" data-clipboard-text="# Usage
Document.create(title: &quot;Cats and Dogs&quot;, body: &quot;are nice!&quot;)

## all documents matching 'cat &amp; dog'
Document.where(&quot;to_tsvector('english', title || ' ' || body) @@ to_tsquery(?)&quot;,
                 &quot;cat &amp; dog&quot;)
">Copy</button> </div> <p>Optionally, you can store the vector as automatically generated column (from PostgreSQL 12.0):</p>
<div class="interstitial code"> <pre data-language="ruby"># db/migrate/20131220144913_create_documents.rb
create_table :documents do |t|
  t.string :title
  t.string :body

  t.virtual :textsearchable_index_col,
            type: :tsvector, as: "to_tsvector('english', title || ' ' || body)", stored: true
end

add_index :documents, :textsearchable_index_col, using: :gin, name: 'documents_idx'

# Usage
Document.create(title: "Cats and Dogs", body: "are nice!")

## all documents matching 'cat &amp; dog'
Document.where("textsearchable_index_col @@ to_tsquery(?)", "cat &amp; dog")</pre> <button class="clipboard-button" data-clipboard-text="create_table :documents do |t|
  t.string :title
  t.string :body

  t.virtual :textsearchable_index_col,
            type: :tsvector, as: &quot;to_tsvector('english', title || ' ' || body)&quot;, stored: true
end

add_index :documents, :textsearchable_index_col, using: :gin, name: 'documents_idx'

# Usage
Document.create(title: &quot;Cats and Dogs&quot;, body: &quot;are nice!&quot;)

## all documents matching 'cat &amp; dog'
Document.where(&quot;textsearchable_index_col @@ to_tsquery(?)&quot;, &quot;cat &amp; dog&quot;)
">Copy</button> </div> <h1 id="database-views"><a class="anchorlink" href="#database-views"><span>9</span> Database Views</a></h1> <ul> <li><a href="https://www.postgresql.org/docs/current/static/sql-createview.html">view creation</a></li> </ul> <p>Imagine you need to work with a legacy database containing the following table:</p>
<div class="interstitial code"> <pre data-language="plaintext">rails_pg_guide=# \d "TBL_ART"
                                        Table "public.TBL_ART"
   Column   |            Type             |                         Modifiers
------------+-----------------------------+------------------------------------------------------------
 INT_ID     | integer                     | not null default nextval('"TBL_ART_INT_ID_seq"'::regclass)
 STR_TITLE  | character varying           |
 STR_STAT   | character varying           | default 'draft'::character varying
 DT_PUBL_AT | timestamp without time zone |
 BL_ARCH    | boolean                     | default false
Indexes:
    "TBL_ART_pkey" PRIMARY KEY, btree ("INT_ID")</pre> <button class="clipboard-button" data-clipboard-text="rails_pg_guide=# \d &quot;TBL_ART&quot;
                                        Table &quot;public.TBL_ART&quot;
   Column   |            Type             |                         Modifiers
------------+-----------------------------+------------------------------------------------------------
 INT_ID     | integer                     | not null default nextval('&quot;TBL_ART_INT_ID_seq&quot;'::regclass)
 STR_TITLE  | character varying           |
 STR_STAT   | character varying           | default 'draft'::character varying
 DT_PUBL_AT | timestamp without time zone |
 BL_ARCH    | boolean                     | default false
Indexes:
    &quot;TBL_ART_pkey&quot; PRIMARY KEY, btree (&quot;INT_ID&quot;)
">Copy</button> </div> <p>This table does not follow the Rails conventions at all. Because simple PostgreSQL views are updateable by default, we can wrap it as follows:</p>
<div class="interstitial code"> <pre data-language="ruby"># db/migrate/20131220144913_create_articles_view.rb
execute &lt;&lt;-SQL
CREATE VIEW articles AS
  SELECT "INT_ID" AS id,
         "STR_TITLE" AS title,
         "STR_STAT" AS status,
         "DT_PUBL_AT" AS published_at,
         "BL_ARCH" AS archived
  FROM "TBL_ART"
  WHERE "BL_ARCH" = 'f'
SQL</pre> <button class="clipboard-button" data-clipboard-text="execute &lt;&lt;-SQL
CREATE VIEW articles AS
  SELECT &quot;INT_ID&quot; AS id,
         &quot;STR_TITLE&quot; AS title,
         &quot;STR_STAT&quot; AS status,
         &quot;DT_PUBL_AT&quot; AS published_at,
         &quot;BL_ARCH&quot; AS archived
  FROM &quot;TBL_ART&quot;
  WHERE &quot;BL_ARCH&quot; = 'f'
SQL
">Copy</button> </div> <div class="interstitial code"> <pre data-language="ruby"># app/models/article.rb
class Article &lt; ApplicationRecord
  self.primary_key = "id"
  def archive!
    update_attribute :archived, true
  end
end</pre> <button class="clipboard-button" data-clipboard-text='class Article &lt; ApplicationRecord
  self.primary_key = "id"
  def archive!
    update_attribute :archived, true
  end
end
'>Copy</button> </div> <div class="interstitial code"> <pre data-language="irb">irb&gt; first = Article.create! title: "Winter is coming", status: "published", published_at: 1.year.ago
irb&gt; second = Article.create! title: "Brace yourself", status: "draft", published_at: 1.month.ago

irb&gt; Article.count
=&gt; 2
irb&gt; first.archive!
irb&gt; Article.count
=&gt; 1</pre> <button class="clipboard-button" data-clipboard-text='first = Article.create! title: "Winter is coming", status: "published", published_at: 1.year.ago
second = Article.create! title: "Brace yourself", status: "draft", published_at: 1.month.ago
Article.count
first.archive!
Article.count
'>Copy</button> </div> <div class="interstitial note"><p>This application only cares about non-archived <code>Articles</code>. A view also allows for conditions so we can exclude the archived <code>Articles</code> directly.</p></div>
<h1 id="structure-dumps"><a class="anchorlink" href="#structure-dumps"><span>10</span> Structure Dumps</a></h1>
<p>If your <code>config.active_record.schema_format</code> is <code>:sql</code>, Rails will call <code>pg_dump</code> to generate a structure dump.</p>
<p>You can use <code>ActiveRecord::Tasks::DatabaseTasks.structure_dump_flags</code> to configure <code>pg_dump</code>. For example, to exclude comments from your structure dump, add this to an initializer:</p>
<div class="interstitial code"> <pre data-language="ruby">ActiveRecord::Tasks::DatabaseTasks.structure_dump_flags = ["--no-comments"]</pre> <button class="clipboard-button" data-clipboard-text='ActiveRecord::Tasks::DatabaseTasks.structure_dump_flags = ["--no-comments"]
'>Copy</button> </div> <hr> <h2>Feedback</h2> <p> You're encouraged to help improve the quality of this guide. </p> <p> Please contribute if you see any typos or factual errors. To get started, you can read our <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">documentation contributions</a> section. </p> <p> You may also find incomplete content or stuff that is not up to date. Please do add any missing documentation for main. Make sure to check <a href="https://edgeguides.rubyonrails.org">Edge Guides</a> first to verify if the issues are already fixed or not on the main branch. Check the <span>Ruby on Rails Guides Guidelines</span> for style and conventions. </p> <p> If for whatever reason you spot something to fix but cannot patch it yourself, please <a href="https://github.com/rails/rails/issues">open an issue</a>. </p> <p>And last but not least, any kind of discussion regarding Ruby on Rails documentation is very welcome on the <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">official Ruby on Rails Forum</a>. </p> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2004&ndash;2021 David Heinemeier Hansson<br>Licensed under the Creative Commons Attribution-ShareAlike 4.0 International License.<br>
    
  </p>
</div>
