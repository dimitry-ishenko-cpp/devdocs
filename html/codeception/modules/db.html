<h1 id="db">Db</h1> <h2 id="installation">Installation</h2> <p>If you use Codeception installed using composer, install this module with the following command:</p> <pre data-language="yaml">composer require --dev codeception/module-db</pre> <p>Alternatively, you can enable <code class="language-plaintext highlighter-rouge">Db</code> module in suite configuration file and run</p> <pre data-language="yaml">codecept init upgrade4</pre> <p>This module was bundled with Codeception 2 and 3, but since version 4 it is necessary to install it separately. <br> Some modules are bundled with PHAR files.<br> Warning. Using PHAR file and composer in the same project can cause unexpected errors.</p> <h2 id="description">Description</h2> <p>Access a database.</p> <p>The most important function of this module is to clean a database before each test. This module also provides actions to perform checks in a database, e.g. <a href="db.html#seeInDatabase">seeInDatabase()</a></p> <p>In order to have your database populated with data you need a raw SQL dump. Simply put the dump in the <code class="language-plaintext highlighter-rouge">tests/_data</code> directory (by default) and specify the path in the config. The next time after the database is cleared, all your data will be restored from the dump. Don’t forget to include <code class="language-plaintext highlighter-rouge">CREATE TABLE</code> statements in the dump.</p> <p>Supported and tested databases are:</p> <ul> <li>MySQL</li> <li>SQLite (i.e. just one file)</li> <li>PostgreSQL</li> </ul> <p>Also available:</p> <ul> <li>MS SQL</li> <li>Oracle</li> </ul> <p>Connection is done by database Drivers, which are stored in the <code class="language-plaintext highlighter-rouge">Codeception\Lib\Driver</code> namespace. <a href="https://github.com/Codeception/Codeception/tree/2.4/src/Codeception/Lib/Driver">Check out the drivers</a> if you run into problems loading dumps and cleaning databases.</p> <h2 id="config">Config</h2> <ul> <li>dsn <em>required</em> - PDO DSN</li> <li>user <em>required</em> - username to access database</li> <li>password <em>required</em> - password</li> <li>dump - path to database dump</li> <li>populate: false - whether the the dump should be loaded before the test suite is started</li> <li>cleanup: false - whether the dump should be reloaded before each test</li> <li>reconnect: false - whether the module should reconnect to the database before each test</li> <li>waitlock: 0 - wait lock (in seconds) that the database session should use for DDL statements</li> <li>ssl_key - path to the SSL key (MySQL specific, @see http://php.net/manual/de/ref.pdo-mysql.php#pdo.constants.mysql-attr-key)</li> <li>ssl_cert - path to the SSL certificate (MySQL specific, @see http://php.net/manual/de/ref.pdo-mysql.php#pdo.constants.mysql-attr-ssl-cert)</li> <li>ssl_ca - path to the SSL certificate authority (MySQL specific, @see http://php.net/manual/de/ref.pdo-mysql.php#pdo.constants.mysql-attr-ssl-ca)</li> <li>ssl_verify_server_cert - disables certificate CN verification (MySQL specific, @see http://php.net/manual/de/ref.pdo-mysql.php)</li> <li>ssl_cipher - list of one or more permissible ciphers to use for SSL encryption (MySQL specific, @see http://php.net/manual/de/ref.pdo-mysql.php#pdo.constants.mysql-attr-cipher)</li> <li>databases - include more database configs and switch between them in tests.</li> <li>initial_queries - list of queries to be executed right after connection to the database has been initiated, i.e. creating the database if it does not exist or preparing the database collation</li> </ul> <h2 id="example">Example</h2> <div class="language-plaintext highlighter-rouge"><code>modules:
   enabled:
      - Db:
         dsn: 'mysql:host=localhost;dbname=testdb'
         user: 'root'
         password: ''
         dump: 'tests/_data/dump.sql'
         populate: true
         cleanup: true
         reconnect: true
         waitlock: 10
         ssl_key: '/path/to/client-key.pem'
         ssl_cert: '/path/to/client-cert.pem'
         ssl_ca: '/path/to/ca-cert.pem'
         ssl_verify_server_cert: false
         ssl_cipher: 'AES256-SHA'
         initial_queries:
             - 'CREATE DATABASE IF NOT EXISTS temp_db;'
             - 'USE temp_db;'
             - 'SET NAMES utf8;'
</code></div> <h2 id="example-with-multi-dumps">Example with multi-dumps</h2> <div class="language-plaintext highlighter-rouge"><code>modules:
     enabled:
        - Db:
           dsn: 'mysql:host=localhost;dbname=testdb'
           user: 'root'
           password: ''
           dump:
              - 'tests/_data/dump.sql'
              - 'tests/_data/dump-2.sql'
</code></div> <h2 id="example-with-multi-databases">Example with multi-databases</h2> <div class="language-plaintext highlighter-rouge"><code>modules:
   enabled:
      - Db:
         dsn: 'mysql:host=localhost;dbname=testdb'
         user: 'root'
         password: ''
         databases:
            db2:
               dsn: 'mysql:host=localhost;dbname=testdb2'
               user: 'userdb2'
               password: ''
</code></div> <h2 id="example-with-sqlite">Example with Sqlite</h2> <div class="language-plaintext highlighter-rouge"><code>modules:
   enabled:
      - Db:
         dsn: 'sqlite:relative/path/to/sqlite-database.db'
         user: ''
         password: ''
</code></div> <h2 id="sql-data-dump">SQL data dump</h2> <p>There are two ways of loading the dump into your database:</p> <h3 id="populator">Populator</h3> <p>The recommended approach is to configure a <code class="language-plaintext highlighter-rouge">populator</code>, an external command to load a dump. Command parameters like host, username, password, database can be obtained from the config and inserted into placeholders:</p> <p>For MySQL:</p> <pre data-language="yaml">modules:
   enabled:
      - Db:
         dsn: 'mysql:host=localhost;dbname=testdb'
         user: 'root'
         password: ''
         dump: 'tests/_data/dump.sql'
         populate: true # run populator before all tests
         cleanup: true # run populator before each test
         populator: 'mysql -u $user -h $host $dbname &lt; $dump'</pre> <p>For PostgreSQL (using pg_restore)</p> <pre data-language="yaml">modules:
   enabled:
      - Db:
         dsn: 'pgsql:host=localhost;dbname=testdb'
         user: 'root'
         password: ''
         dump: 'tests/_data/db_backup.dump'
         populate: true # run populator before all tests
         cleanup: true # run populator before each test
         populator: 'pg_restore -u $user -h $host -D $dbname &lt; $dump'</pre> <p>Variable names are being taken from config and DSN which has a <code class="language-plaintext highlighter-rouge">keyword=value</code> format, so you should expect to have a variable named as the keyword with the full value inside it.</p> <p>PDO dsn elements for the supported drivers:</p> <ul> <li>MySQL: <a href="https://secure.php.net/manual/en/ref.pdo-mysql.connection.php">PDO_MYSQL DSN</a>
</li> <li>SQLite: <a href="https://secure.php.net/manual/en/ref.pdo-sqlite.connection.php">PDO_SQLITE DSN</a> - use <em>relative</em> path from the project root</li> <li>PostgreSQL: <a href="https://secure.php.net/manual/en/ref.pdo-pgsql.connection.php">PDO_PGSQL DSN</a>
</li> <li>MSSQL: <a href="https://secure.php.net/manual/en/ref.pdo-sqlsrv.connection.php">PDO_SQLSRV DSN</a>
</li> <li>Oracle: <a href="https://secure.php.net/manual/en/ref.pdo-oci.connection.php">PDO_OCI DSN</a>
</li> </ul> <h3 id="dump">Dump</h3> <p>Db module by itself can load SQL dump without external tools by using current database connection. This approach is system-independent, however, it is slower than using a populator and may have parsing issues (see below).</p> <p>Provide a path to SQL file in <code class="language-plaintext highlighter-rouge">dump</code> config option:</p> <pre data-language="yaml">modules:
   enabled:
      - Db:
         dsn: 'mysql:host=localhost;dbname=testdb'
         user: 'root'
         password: ''
         populate: true # load dump before all tests
         cleanup: true # load dump for each test
         dump: 'tests/_data/dump.sql'</pre> <p>To parse SQL Db file, it should follow this specification:</p> <ul> <li>Comments are permitted.</li> <li>The <code class="language-plaintext highlighter-rouge">dump.sql</code> may contain multiline statements.</li> <li>The delimiter, a semi-colon in this case, must be on the same line as the last statement:</li> </ul> <pre data-language="sql">-- Add a few contacts to the table.
REPLACE INTO `Contacts` (`created`, `modified`, `status`, `contact`, `first`, `last`) VALUES
(NOW(), NOW(), 1, 'Bob Ross', 'Bob', 'Ross'),
(NOW(), NOW(), 1, 'Fred Flintstone', 'Fred', 'Flintstone');

-- Remove existing orders for testing.
DELETE FROM `Order`;</pre> <h2 id="query-generation">Query generation</h2> <p><code class="language-plaintext highlighter-rouge">seeInDatabase</code>, <code class="language-plaintext highlighter-rouge">dontSeeInDatabase</code>, <code class="language-plaintext highlighter-rouge">seeNumRecords</code>, <code class="language-plaintext highlighter-rouge">grabFromDatabase</code> and <code class="language-plaintext highlighter-rouge">grabNumRecords</code> methods accept arrays as criteria. WHERE condition is generated using item key as a field name and item value as a field value.</p> <p>Example:</p> <pre data-language="php">&lt;?php
$I-&gt;seeInDatabase('users', ['name' =&gt; 'Davert', 'email' =&gt; 'davert@mail.com']);</pre> <p>Will generate:</p> <pre data-language="sql">SELECT COUNT(*) FROM `users` WHERE `name` = 'Davert' AND `email` = 'davert@mail.com'</pre> <p>Since version 2.1.9 it’s possible to use LIKE in a condition, as shown here:</p> <pre data-language="php">&lt;?php
$I-&gt;seeInDatabase('users', ['name' =&gt; 'Davert', 'email like' =&gt; 'davert%']);</pre> <p>Will generate:</p> <pre data-language="sql">SELECT COUNT(*) FROM `users` WHERE `name` = 'Davert' AND `email` LIKE 'davert%'</pre> <p>Null comparisons are also available, as shown here:</p> <pre data-language="php">&lt;?php
$I-&gt;seeInDatabase('users', ['name' =&gt; null, 'email !=' =&gt; null]);</pre> <p>Will generate:</p> <pre data-language="sql">SELECT COUNT(*) FROM `users` WHERE `name` IS NULL AND `email` IS NOT NULL</pre> <h2 id="public-properties">Public Properties</h2> <ul> <li>dbh - contains the PDO connection</li> <li>driver - contains the Connection Driver</li> </ul> <h2 id="actions">Actions</h2> <h3 id="amconnectedtodatabase">amConnectedToDatabase</h3> <p>Make sure you are connected to the right database.</p> <pre data-language="php">&lt;?php
$I-&gt;seeNumRecords(2, 'users');   //executed on default database
$I-&gt;amConnectedToDatabase('db_books');
$I-&gt;seeNumRecords(30, 'books');  //executed on db_books database
//All the next queries will be on db_books</pre> <ul> <li>
<code class="language-plaintext highlighter-rouge">param</code> $databaseKey @throws ModuleConfigException</li> </ul> <h3 id="dontseeindatabase">dontSeeInDatabase</h3> <p>Effect is opposite to -&gt;seeInDatabase</p> <p>Asserts that there is no record with the given column values in a database. Provide table name and column values.</p> <pre data-language="php">&lt;?php
$I-&gt;dontSeeInDatabase('users', ['name' =&gt; 'Davert', 'email' =&gt; 'davert@mail.com']);</pre> <p>Fails if such user was found.</p> <p>Comparison expressions can be used as well:</p> <pre data-language="php">&lt;?php
$I-&gt;dontSeeInDatabase('posts', ['num_comments &gt;=' =&gt; '0']);
$I-&gt;dontSeeInDatabase('users', ['email like' =&gt; 'miles%']);</pre> <p>Supported operators: <code class="language-plaintext highlighter-rouge">&lt;</code>, <code class="language-plaintext highlighter-rouge">&gt;</code>, <code class="language-plaintext highlighter-rouge">&gt;=</code>, <code class="language-plaintext highlighter-rouge">&lt;=</code>, <code class="language-plaintext highlighter-rouge">!=</code>, <code class="language-plaintext highlighter-rouge">like</code>.</p> <ul> <li>
<code class="language-plaintext highlighter-rouge">param string</code> $table</li> <li>
<code class="language-plaintext highlighter-rouge">param array</code> $criteria</li> </ul> <h3 id="grabcolumnfromdatabase">grabColumnFromDatabase</h3> <p>Fetches all values from the column in database. Provide table name, desired column and criteria.</p> <pre data-language="php">&lt;?php
$mails = $I-&gt;grabColumnFromDatabase('users', 'email', array('name' =&gt; 'RebOOter'));</pre> <ul> <li>
<code class="language-plaintext highlighter-rouge">param string</code> $table</li> <li>
<code class="language-plaintext highlighter-rouge">param string</code> $column</li> <li> <p><code class="language-plaintext highlighter-rouge">param array</code> $criteria</p> </li> <li><code class="language-plaintext highlighter-rouge">return array</code></li> </ul> <h3 id="grabfromdatabase">grabFromDatabase</h3> <p>Fetches a single column value from a database. Provide table name, desired column and criteria.</p> <pre data-language="php">&lt;?php
$mail = $I-&gt;grabFromDatabase('users', 'email', array('name' =&gt; 'Davert'));</pre> <p>Comparison expressions can be used as well:</p> <pre data-language="php">&lt;?php
$post = $I-&gt;grabFromDatabase('posts', ['num_comments &gt;=' =&gt; 100]);
$user = $I-&gt;grabFromDatabase('users', ['email like' =&gt; 'miles%']);</pre> <p>Supported operators: <code class="language-plaintext highlighter-rouge">&lt;</code>, <code class="language-plaintext highlighter-rouge">&gt;</code>, <code class="language-plaintext highlighter-rouge">&gt;=</code>, <code class="language-plaintext highlighter-rouge">&lt;=</code>, <code class="language-plaintext highlighter-rouge">!=</code>, <code class="language-plaintext highlighter-rouge">like</code>.</p> <ul> <li>
<code class="language-plaintext highlighter-rouge">param string</code> $table</li> <li>
<code class="language-plaintext highlighter-rouge">param string</code> $column</li> <li> <p><code class="language-plaintext highlighter-rouge">param array</code> $criteria</p> </li> <li>
<code class="language-plaintext highlighter-rouge">return mixed</code> Returns a single column value or false</li> </ul> <h3 id="grabnumrecords">grabNumRecords</h3> <p>Returns the number of rows in a database</p> <ul> <li>
<code class="language-plaintext highlighter-rouge">param string</code> $table Table name</li> <li> <p><code class="language-plaintext highlighter-rouge">param array</code> $criteria Search criteria [Optional]</p> </li> <li><code class="language-plaintext highlighter-rouge">return int</code></li> </ul> <h3 id="haveindatabase">haveInDatabase</h3> <p>Inserts an SQL record into a database. This record will be erased after the test.</p> <pre data-language="php">&lt;?php
$I-&gt;haveInDatabase('users', array('name' =&gt; 'miles', 'email' =&gt; 'miles@davis.com'));
?&gt;</pre> <ul> <li>
<code class="language-plaintext highlighter-rouge">param string</code> $table</li> <li> <p><code class="language-plaintext highlighter-rouge">param array</code> $data</p> </li> <li>
<code class="language-plaintext highlighter-rouge">return integer</code> $id</li> </ul> <h3 id="performindatabase">performInDatabase</h3> <p>Can be used with a callback if you don’t want to change the current database in your test.</p> <pre data-language="php">&lt;?php
$I-&gt;seeNumRecords(2, 'users');   //executed on default database
$I-&gt;performInDatabase('db_books', function($I) {
    $I-&gt;seeNumRecords(30, 'books');  //executed on db_books database
});
$I-&gt;seeNumRecords(2, 'users');  //executed on default database</pre> <p>List of actions can be pragmatically built using <code class="language-plaintext highlighter-rouge">Codeception\Util\ActionSequence</code>:</p> <pre data-language="php">&lt;?php
$I-&gt;performInDatabase('db_books', ActionSequence::build()
    -&gt;seeNumRecords(30, 'books')
);</pre> <p>Alternatively an array can be used:</p> <pre data-language="php">$I-&gt;performInDatabase('db_books', ['seeNumRecords' =&gt; [30, 'books']]);</pre> <p>Choose the syntax you like the most and use it,</p> <p>Actions executed from array or ActionSequence will print debug output for actions, and adds an action name to exception on failure.</p> <ul> <li>
<code class="language-plaintext highlighter-rouge">param</code> $databaseKey</li> <li>
<code class="language-plaintext highlighter-rouge">param \Codeception\Util\ActionSequence|array|callable</code> $actions @throws ModuleConfigException</li> </ul> <h3 id="seeindatabase">seeInDatabase</h3> <p>Asserts that a row with the given column values exists. Provide table name and column values.</p> <pre data-language="php">&lt;?php
$I-&gt;seeInDatabase('users', ['name' =&gt; 'Davert', 'email' =&gt; 'davert@mail.com']);</pre> <p>Fails if no such user found.</p> <p>Comparison expressions can be used as well:</p> <pre data-language="php">&lt;?php
$I-&gt;seeInDatabase('posts', ['num_comments &gt;=' =&gt; '0']);
$I-&gt;seeInDatabase('users', ['email like' =&gt; 'miles@davis.com']);</pre> <p>Supported operators: <code class="language-plaintext highlighter-rouge">&lt;</code>, <code class="language-plaintext highlighter-rouge">&gt;</code>, <code class="language-plaintext highlighter-rouge">&gt;=</code>, <code class="language-plaintext highlighter-rouge">&lt;=</code>, <code class="language-plaintext highlighter-rouge">!=</code>, <code class="language-plaintext highlighter-rouge">like</code>.</p> <ul> <li>
<code class="language-plaintext highlighter-rouge">param string</code> $table</li> <li>
<code class="language-plaintext highlighter-rouge">param array</code> $criteria</li> </ul> <h3 id="seenumrecords">seeNumRecords</h3> <p>Asserts that the given number of records were found in the database.</p> <pre data-language="php">&lt;?php
$I-&gt;seeNumRecords(1, 'users', ['name' =&gt; 'davert'])
?&gt;</pre> <ul> <li>
<code class="language-plaintext highlighter-rouge">param int</code> $expectedNumber Expected number</li> <li>
<code class="language-plaintext highlighter-rouge">param string</code> $table Table name</li> <li>
<code class="language-plaintext highlighter-rouge">param array</code> $criteria Search criteria [Optional]</li> </ul> <h3 id="updateindatabase">updateInDatabase</h3> <p>Update an SQL record into a database.</p> <pre data-language="php">&lt;?php
$I-&gt;updateInDatabase('users', array('isAdmin' =&gt; true), array('email' =&gt; 'miles@davis.com'));
?&gt;</pre> <ul> <li>
<code class="language-plaintext highlighter-rouge">param string</code> $table</li> <li>
<code class="language-plaintext highlighter-rouge">param array</code> $data</li> <li>
<code class="language-plaintext highlighter-rouge">param array</code> $criteria</li> </ul> <div class="_attribution">
  <p class="_attribution-p">
    &copy; 2011 Michael Bodnarchuk and contributors<br>Licensed under the MIT License.<br>
    <a href="https://codeception.com/docs/modules/Db" class="_attribution-link">https://codeception.com/docs/modules/Db</a>
  </p>
</div>
