  <h1 class="section">Sharing Job Slots with GNU make</h1>   <p>GNU <code>make</code> has the ability to run multiple recipes in parallel (see <a href="parallel.html">Parallel Execution</a>) and to cap the total number of parallel jobs even across recursive invocations of <code>make</code> (see <a href="options_002frecursion.html">Communicating Options to a Sub-<code>make</code></a>). Tools that <code>make</code> invokes which are also able to run multiple operations in parallel, either using multiple threads or multiple processes, can be enhanced to participate in GNU <code>make</code>’s job management facility to ensure that the total number of active threads/processes running on the system does not exceed the maximum number of slots provided to GNU <code>make</code>. </p>  <p>GNU <code>make</code> uses a method called the “jobserver” to control the number of active jobs across recursive invocations. The actual implementation of the jobserver varies across different operating systems, but some fundamental aspects are always true. </p>  <p>First, <code>make</code> will provide information necessary for accessing the jobserver through the environment to its children, in the <code>MAKEFLAGS</code> environment variable. Tools which want to participate in the jobserver protocol will need to parse this environment variable and find the word starting with <code>--jobserver-auth=</code>. The value of this option will describe how to communicate with the jobserver. The interpretation of this value is described in the sections below. </p> <p>Be aware that the <code>MAKEFLAGS</code> variable may contain multiple instances of the <code>--jobserver-auth=</code> option. Only the <em>last</em> instance is relevant. </p> <p>Second, every command <code>make</code> starts has one implicit job slot reserved for it before it starts. Any tool which wants to participate in the jobserver protocol should assume it can always run one job without having to contact the jobserver at all. </p> <p>Finally, it’s critical that tools that participate in the jobserver protocol return the exact number of slots they obtained from the jobserver back to the jobserver before they exit, even under error conditions. Remember that the implicit job slot should <strong>not</strong> be returned to the jobserver! Returning too few slots means that those slots will be lost for the rest of the build process; returning too many slots means that extra slots will be available. The top-level <code>make</code> command will print an error message at the end of the build if it detects an incorrect number of slots available in the jobserver. </p> <p>As an example, suppose you are implementing a linker which provides for multithreaded operation. You would like to enhance the linker so that if it is invoked by GNU <code>make</code> it can participate in the jobserver protocol to control how many threads are used during link. First you will need to modify the linker to determine if the <code>MAKEFLAGS</code> environment variable is set. Next you will need to parse the value of that variable to determine if the jobserver is available, and how to access it. If it is available then you can access it to obtain job slots controlling how much parallelism your tool can use. Once done your tool must return those job slots back to the jobserver. </p> <table class="menu" border="0" cellspacing="0"> <tr>
<td align="left" valign="top">• <a href="posix-jobserver.html" accesskey="1">POSIX Jobserver</a>
</td>
<td> </td>
<td align="left" valign="top">Using the jobserver on POSIX systems. </td>
</tr> <tr>
<td align="left" valign="top">• <a href="windows-jobserver.html" accesskey="2">Windows Jobserver</a>
</td>
<td> </td>
<td align="left" valign="top">Using the jobserver on Windows systems. </td>
</tr> </table><div class="_attribution">
  <p class="_attribution-p">
    Copyright © 1988, 1989, 1990, 1991, 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022 Free Software Foundation, Inc. <br>Licensed under the GNU Free Documentation License.<br>
    <a href="https://www.gnu.org/software/make/manual/html_node/Job-Slots.html" class="_attribution-link">https://www.gnu.org/software/make/manual/html_node/Job-Slots.html</a>
  </p>
</div>
