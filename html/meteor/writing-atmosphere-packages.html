<h1 class="title-page">Writing Atmosphere Packages</h1>    <p>To get started writing a package, use the Meteor command line tool:</p> <pre class="highlight bash" data-language="bash">meteor create --package my-package</pre> <blockquote> <p>It is required that your <code>my-package</code> name take the form of <code>username:my-package</code>, where <code>username</code> is your Meteor Developer username, if you plan to publish your package to Atmosphere.</p> </blockquote> <p>If you run this inside an app, it will place the newly generated package in that app’s <code>packages/</code> directory. Outside an app, it will just create a standalone package directory. The command also generates some boilerplate files for you:</p> <pre class="highlight plain" data-language="plain">my-package
├── README.md
├── package.js
├── my-package-tests.js
└── my-package.js</pre> <p>The <code>package.js</code> file is the main file in every Meteor package. This is a JavaScript file that defines the metadata, files loaded, architectures, npm packages, and Cordova packages for your Meteor package.</p> <p>In this guide article, we will go over some important points for building packages, but we won’t explain every part of the <code>package.js</code> API. To learn about all of the options, <a href="http://docs.meteor.com/#/full/packagejs" target="_blank" rel="external">read about the <code>package.js</code> API in the Meteor docs.</a></p> <blockquote> <p>Don’t forget to run <a href="http://docs.meteor.com/#/full/meteoradd" target="_blank" rel="external"><code>meteor add [my-package]</code></a> once you have finished developing your package in order to use it; this applies if the package is a local package for internal use only or if you have published the package to Atmosphere.</p> </blockquote> <h2 id="adding-files">Adding files and assets</h2> <p>The main function of an Atmosphere package is to contain source code (JS, CSS, and any transpiled languages) and assets (images, fonts, and more) that will be shared across different applications.</p> <h3 id="adding-javascript">Adding JavaScript</h3> <p>To add JavaScript files to a package, specify an entrypoint with <a href="http://docs.meteor.com/#/full/pack_mainModule" target="_blank" rel="external"><code>api.mainModule()</code></a> in the package’s <code>onUse</code> block (this will already have been done by <code>meteor create --package</code> above):</p> <pre class="highlight js" data-language="js">Package.onUse(function(api) {
  api.mainModule('my-package.js');
});</pre> <p>From that entrypoint, you can <code>import</code> other files within your package, <a href="structure.html">just as you would in an application</a>.</p> <p>If you want to include different files on the client and server, you can specify multiple entry points using the second argument to the function:</p> <pre class="highlight js" data-language="js">Package.onUse(function(api) {
  api.mainModule('my-package-client.js', 'client');
  api.mainModule('my-package-server.js', 'server');
});</pre> <p>You can also add any source file that would be compiled to a JS file (such as a CoffeeScript file) in a similar way, assuming you <a href="#dependencies">depend</a> on an appropriate build plugin.</p> <h3 id="adding-css">Adding CSS</h3> <p>To include CSS files with your package you can use <a href="http://docs.meteor.com/#/full/pack_addFiles" target="_blank" rel="external"><code>api.addFiles()</code></a>:</p> <pre class="highlight js" data-language="js">Package.onUse(function(api) {
  api.addFiles('my-package.css', 'client');
});</pre> <p>The CSS file will be automatically loaded into any app that uses your package.</p> <h3 id="adding-style">Adding Sass, Less, or Stylus mixins/variables</h3> <p>Just like packages can export JavaScript code, they can export reusable bits of CSS pre-processor code. You can also have a package that doesn’t actually include any CSS, but just exports different bits of reusable mixins and variables. To get more details see Meteor <a href="build-tool.html#css">build tool CSS pre-processors</a>:</p> <pre class="highlight js" data-language="js">Package.onUse(function(api) {
  api.addFiles('my-package.scss', 'client');
});</pre> <p>This Sass file will be eagerly evaluated and its compiled form will be added to the CSS of the app immediately.</p> <pre class="highlight js" data-language="js">Package.onUse(function(api) {
  api.addFiles([
    'stylesheets/_util.scss',
    'stylesheets/_variables.scss'

  ], 'client', {isImport: true});
});</pre> <p>These two Sass files will be lazily evaluated and only included in the CSS of the app if imported from some other file.</p> <h3 id="adding-assets">Adding other assets</h3> <p>You can include other assets, such as fonts, icons or images, to your package using <a href="http://docs.meteor.com/#/full/PackageAPI-addAssets" target="_blank" rel="external"><code>api.addAssets</code></a>:</p> <pre class="highlight js" data-language="js">Package.onUse(function(api) {
  api.addAssets([
    'font/OpenSans-Regular-webfont.eot',
    'font/OpenSans-Regular-webfont.svg',
    'font/OpenSans-Regular-webfont.ttf',
    'font/OpenSans-Regular-webfont.woff',
  ], 'client');
});</pre> <p>You can then access these files from the client from a URL <code>/packages/username_my-package/font/OpenSans-Regular-webfont.eot</code> or from the server using the <a href="http://docs.meteor.com/#/full/assets_getText" target="_blank" rel="external">Assets API</a>.</p> <h2 id="exporting">Exporting</h2> <p>While some packages exist just to provide side effects to the app, most packages provide a reusable bit of code that can be used by the consumer with <code>import</code>. To export a symbol from your package, simply use the ES2015 <code>export</code> syntax in your <code>mainModule</code>:</p> <pre class="highlight js" data-language="js">// in my-package.js:

export const myName = 'my-package';</pre> <p>Now users of your package can import the symbol with:</p> <pre class="highlight js" data-language="js">
import { myName } from 'meteor/username:my-package';</pre> <h2 id="dependencies">Dependencies</h2> <p>Chances are your package will want to make use of other packages. To ensure they are available, you can declare dependencies. Atmosphere packages can depend both on other Atmosphere packages, as well as packages from npm.</p> <h3 id="atmosphere-dependencies">Atmosphere dependencies</h3> <p>To depend on another Atmosphere package, use <a href="http://docs.meteor.com/#/full/pack_use" target="_blank" rel="external"><code>api.use</code></a>:</p> <pre class="highlight js" data-language="js">Package.onUse(function(api) {
  // This package depends on 1.3.3 or above of simple-schema

  api.use('aldeed:simple-schema@1.3.3');
});</pre> <p>One important feature of the Atmosphere package system is that it is single-loading: no two packages in the same app can have dependencies on conflicting versions of a single package. Read more about that in the section about version constraints below.</p> <h4 id="meteor-version-dependencies">Depending on Meteor version</h4> <p>Note that the Meteor release version number is mostly a marketing artifact - the core Meteor packages themselves typically don’t share this version number. This means packages can only depend on specific versions of the packages inside a Meteor release, but can’t depend on a specific release itself. We have a helpful shorthand api called <a href="http://docs.meteor.com/#/full/pack_versions" target="_blank" rel="external"><code>api.versionsFrom</code></a> that handles this for you by automatically filling in package version numbers from a particular release:</p> <pre class="highlight js" data-language="js">// Use versions of core packages from Meteor 1.2.1
api.versionsFrom('1.2.1');

api.use([
  // Don't need to specify version because of versionsFrom above

  'ecmascript',
  'check',

  // Still need to specify versions of non-core packages

  'aldeed:simple-schema@1.3.3',
  'mdg:validation-error@0.1.0'

]);</pre> <p>The above code snippet is equivalent to the code below, which specifies all of the version numbers individually:</p> <pre class="highlight js" data-language="js">api.use([
  'ecmascript@0.1.6',
  'check@1.1.0',
  'aldeed:simple-schema@1.3.3',
  'mdg:validation-error@0.1.0'

]);</pre> <h4 id="version-constraints">Semantic versioning and version constraints</h4> <p>Meteor’s package system relies heavily on <a href="http://semver.org/" target="_blank" rel="external">Semantic Versioning</a>, or SemVer. When one package declares a dependency on another, it always comes with a version constraint. These version constraints are then solved by Meteor’s industrial-grade Version Solver to arrive at a set of package versions that meet all of the requirements, or display a helpful error if there is no solution.</p> <p>The mental model here is:</p> <ol> <li>
<strong>The major version must always match exactly.</strong> If package <code>a</code> depends on <code>b@2.0.0</code>, the constraint will only be satisfied if the version of package <code>b</code> starts with a <code>2</code>. This means that you can never have two different major versions of a package in the same app.</li> <li>
<strong>The minor and patch version numbers must be greater or equal to the requested version.</strong> If the dependency requests version <code>2.1.3</code>, then <code>2.1.4</code> and <code>2.2.0</code> will work, but <code>2.0.4</code> and <code>2.1.2</code> will not.</li> </ol> <p>The constraint solver is necessary because Meteor’s package system is <strong>single-loading</strong> - that is, you can never have two different versions of the same package loaded side-by-side in the same app. This is particularly useful for packages that include a lot of client-side code, or packages that expect to be singletons.</p> <p>Note that the version solver also has a concept of “gravity” - when many solutions are possible for a certain set of dependencies, it always selects the oldest possible version. This is helpful if you are trying to develop a package to ship to lots of users, since it ensures your package will be compatible with the lowest common denominator of a dependency. If your package needs a newer version than is currently being selected for a certain dependency, you need to update your <code>package.js</code> to have a newer version constraint.</p> <h3 id="npm-dependencies">npm dependencies</h3> <p>Meteor packages can include <a href="https://www.npmjs.com/" target="_blank" rel="external">npm packages</a> to use JavaScript code from outside the Meteor package ecosystem or to include JavaScript code with native dependencies. Use <a href="http://docs.meteor.com/#/full/Npm-depends" target="_blank" rel="external">Npm.depends</a> at the top level of your <code>package.js</code> file. For example, here’s how you would include the <code>github</code> npm package:</p> <pre class="highlight js" data-language="js">Npm.depends({
  github: '0.2.4'

});</pre> <p>You can import the dependency from within you package code in the same way that you would inside an <a href="using-npm-packages.html#using-npm">application</a>:</p> <pre class="highlight js" data-language="js">
import github from 'github';</pre> <h3 id="peer-npm-dependencies">Peer npm dependencies</h3> <p><code>Npm.depends()</code> is fairly rigid (you can only depend on an exact version), and will typically result in multiple versions of a package being installed if many different Atmosphere packages depend on the same npm package. This makes it less than ideal to use on the client, where it’s impractical to ship multiple copies of the same package code to the browser. Client-side packages are also often written with the assumption that only a single copy will be loaded. For example, React will complain if it is included more than once in an application bundle.</p> <p>To avoid this problem as a package author, you can request that users of your package have installed the npm package you want to use at the application level. This is similar to a <a href="https://nodejs.org/en/blog/npm/peer-dependencies/" target="_blank" rel="external">peer dependency</a> of an npm package (although with less support in the tool). You can use the <a href="https://atmospherejs.com/tmeasday/check-npm-versions" target="_blank" rel="external"><code>tmeasday:check-npm-versions</code></a> package to ensure that they’ve done this, and to warn them if not.</p> <p>For instance, if you are writing a React package, you should not directly depend on <a href="https://www.npmjs.com/package/react" target="_blank" rel="external"><code>react</code></a>, but instead use <code>check-npm-versions</code> to check the user has installed it:</p> <pre class="highlight js" data-language="js">
import { checkNpmVersions } from 'meteor/tmeasday:check-npm-versions';

checkNpmVersions({
  'react': '0.14.x'

}, 'my:awesome-package');

// If you are using the dependency in the same file, you'll need to use require, otherwise
// you can continue to `import` in another file.

const React = require('react');</pre> <blockquote> <p>Note that <code>checkNpmVersions</code> will only output a warning if the user has installed a incompatible version of the npm package. So your <code>require</code> call may not give you what you expect. This is consistent with npm’s handling of <a href="http://blog.npmjs.org/post/110924823920/npm-weekly-5" target="_blank" rel="external">peer dependencies</a>.</p> </blockquote> <h2 id="cordova-plugins">Cordova plugins</h2> <p>Atmosphere packages can include <a href="http://cordova.apache.org/plugins/" target="_blank" rel="external">Cordova plugins</a> to ship native code for the Meteor mobile app container. This way, you can interact with the native camera interface, use the gyroscope, save files locally, and more.</p> <p>Include Cordova plugins in your Meteor package by using <a href="http://docs.meteor.com/#/full/Cordova-depends" target="_blank" rel="external">Cordova.depends</a>.</p> <p>Read more about using Cordova in the <a href="mobile.html">mobile guide</a>.</p> <h2 id="testing">Testing packages</h2> <p>Meteor has a test mode for packages called <code>meteor test-packages</code>. If you are in a package’s directory, you can run</p> <pre class="highlight bash" data-language="bash">meteor test-packages ./ --driver-package practicalmeteor:mocha</pre> <p>This will run a special app containing only a “test” version of your package and start a Mocha <a href="testing.html#driver-packages">test driver package</a>.</p> <p>When your package starts in test mode, rather than loading the <code>onUse</code> block, Meteor loads the <code>onTest</code> block:</p> <pre class="highlight js" data-language="js">Package.onTest(function(api) {
  // You almost definitely want to depend on the package itself,

  // this is what you are testing!

  api.use('my-package');

  // You should also include any packages you need to use in the test code

  api.use(['ecmascript', 'random', 'practicalmeteor:mocha']);

  // Finally add an entry point for tests

  api.mainModule('my-package-tests.js');
});</pre> <p>From within your test entry point, you can import other files as you would in the package proper.</p> <p>You can read more about testing in Meteor in the <a href="testing.html">Testing article</a>.</p> <h2 id="publishing-atmosphere">Publishing your package</h2> <p>To publish your package to Atmosphere, run <a href="http://docs.meteor.com/#/full/meteorpublish" target="_blank" rel="external"><code>meteor publish</code></a> from the package directory. To publish a package the package name must follow the format of <code>username:my-package</code> and the package must contain a <a href="#version-constraints">SemVer version number</a>.</p> <h3 id="local-vs-published">Cache format</h3> <p>If you’ve ever looked inside Meteor’s package cache at <code>~/.meteor/packages</code>, you know that the on-disk format of a built Meteor package is completely different from the way the source code looks when you’re developing the package. The idea is that the target format of a package can remain consistent even if the API for development changes.</p> <h2 id="local-packages">Local packages</h2> <p>As an alternative to publishing your package on Atmosphere, if you want to keep your package private, you can place it in your Meteor app in the <code>packages/</code> directory, for instance <code>packages/foo/</code>, and then add it to your app with <code>meteor add foo</code>.</p> <h3 id="overriding-atmosphere-packages">Overriding published packages with a local version</h3> <p>If you need to modify an Atmosphere package to do something that the published version doesn’t do, you can edit a local version of the package on your computer.</p> <p>A Meteor app can load Atmosphere packages in one of three ways, and it looks for a matching package name in the following order:</p> <ol> <li>Package source code in the <code>packages/</code> directory inside your app.</li> <li>Package source code in directories indicated by setting a <code>METEOR_PACKAGE_DIRS</code> environment variable before running any <code>meteor</code> command. You can add multiple directories by separating the paths with a <code>:</code> on OSX or Linux, or a <code>;</code> on Windows. For example: <code>METEOR_PACKAGE_DIRS=../first/directory:../second/directory</code>, or on Windows: <code>set PACKAGE_DIRS=..\first\directory;..\second\directory</code>.<blockquote> <p>Note: Prior to Meteor 1.4.2, <code>METEOR_PACKAGE_DIRS</code> was simply <code>PACKAGE_DIRS</code>. For compatibility reasons, developers should use <code>METEOR_PACKAGE_DIRS</code> going forward.</p> </blockquote> </li> <li>Pre-built package from Atmosphere. The package is cached in <code>~/.meteor/packages</code> on Mac/Linux or <code>%LOCALAPPDATA%\.meteor\packages</code> on Windows, and only loaded into your app as it is built.</li> </ol> <p>You can use (1) or (2) to override the version from Atmosphere. You can even do this to load patched versions of Meteor core packages - just copy the code of the package from <a href="https://github.com/meteor/meteor/tree/devel/packages" target="_blank" rel="external">Meteor’s GitHub repository</a>, and edit away.</p><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2011&ndash;2017 Meteor Development Group, Inc.<br>Licensed under the MIT License.<br>
    <a href="https://guide.meteor.com/writing-atmosphere-packages.html" class="_attribution-link">https://guide.meteor.com/writing-atmosphere-packages.html</a>
  </p>
</div>
