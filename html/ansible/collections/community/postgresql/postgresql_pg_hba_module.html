<h1 id="community-postgresql-postgresql-pg-hba-add-remove-or-modify-a-rule-in-a-pg-hba-file">community.postgresql.postgresql_pg_hba – Add, remove or modify a rule in a pg_hba file</h1> <div class="admonition note"> <p class="admonition-title">Note</p> <p>This plugin is part of the <a class="reference external" href="https://galaxy.ansible.com/community/postgresql">community.postgresql collection</a> (version 1.5.0).</p> <p>You might already have this collection installed if you are using the <code>ansible</code> package. It is not included in <code>ansible-core</code>. To check whether it is installed, run <code>ansible-galaxy collection list</code>.</p> <p>To install it, use: <code>ansible-galaxy collection install community.postgresql</code>.</p> <p>To use it in a playbook, specify: <code>community.postgresql.postgresql_pg_hba</code>.</p> </div>  <ul class="simple"> <li><a class="reference internal" href="#synopsis" id="id1">Synopsis</a></li> <li><a class="reference internal" href="#requirements" id="id2">Requirements</a></li> <li><a class="reference internal" href="#parameters" id="id3">Parameters</a></li> <li><a class="reference internal" href="#notes" id="id4">Notes</a></li> <li><a class="reference internal" href="#see-also" id="id5">See Also</a></li> <li><a class="reference internal" href="#examples" id="id6">Examples</a></li> <li><a class="reference internal" href="#return-values" id="id7">Return Values</a></li> </ul>   <h2 id="synopsis">Synopsis</h2> <ul class="simple"> <li>The fundamental function of the module is to create, or delete lines in pg_hba files.</li> <li>The lines in the file should be in a typical pg_hba form and lines should be unique per key (type, databases, users, source). If they are not unique and the SID is ‘the one to change’, only one for <em>state=present</em> or none for <em>state=absent</em> of the SID’s will remain.</li> </ul>   <h2 id="requirements">Requirements</h2> <p>The below requirements are needed on the host that executes this module.</p> <ul class="simple"> <li>ipaddress</li> </ul>   <h2 id="parameters">Parameters</h2> <table class="documentation-table"> <tr> <th colspan="1">Parameter</th> <th>Choices/Defaults</th> <th width="100%">Comments</th> </tr> <tr> <td colspan="1">  <b>address</b>  <div> <span>string</span> </div> </td> <td> <b>Default:</b><br><div>"samehost"</div> </td> <td> <div>The source address/net where the connections could come from.</div> <div>Will not be used for entries of <em>type</em>=<code>local</code>.</div> <div>You can also use keywords <code>all</code>, <code>samehost</code>, and <code>samenet</code>.</div> <div>
<br>aliases: source, src</div> </td> </tr> <tr> <td colspan="1">  <b>attributes</b>  <div> <span>string</span> </div> <div> added in 2.3 of ansible.builtin </div> </td> <td> </td> <td> <div>The attributes the resulting file or directory should have.</div> <div>To get supported flags look at the man page for <em>chattr</em> on the target system.</div> <div>This string should contain the attributes in the same order as the one displayed by <em>lsattr</em>.</div> <div>The <code>=</code> operator is assumed as default, otherwise <code>+</code> or <code>-</code> operators need to be included in the string.</div> <div>
<br>aliases: attr</div> </td> </tr> <tr> <td colspan="1">  <b>backup</b>  <div> <span>boolean</span> </div> </td> <td> <ul>
<b>Choices:</b> <li><div>
<b>no</b> ←</div></li> <li>yes</li> </ul> </td> <td> <div>If set, create a backup of the <code>pg_hba</code> file before it is modified. The location of the backup is returned in the (backup) variable by this module.</div> </td> </tr> <tr> <td colspan="1">  <b>backup_file</b>  <div> <span>string</span> </div> </td> <td> </td> <td> <div>Write backup to a specific backupfile rather than a temp file.</div> </td> </tr> <tr> <td colspan="1">  <b>comment</b>  <div> <span>string</span> </div> <div> added in 1.5.0 of community.postgresql </div> </td> <td> </td> <td> <div>A comment that will be placed in the same line behind the rule. See also the <em>keep_comments_at_rules</em> parameter.</div> </td> </tr> <tr> <td colspan="1">  <b>contype</b>  <div> <span>string</span> </div> </td> <td> <ul>
<b>Choices:</b> <li>local</li> <li>host</li> <li>hostnossl</li> <li>hostssl</li> </ul> </td> <td> <div>Type of the rule. If not set, <code>postgresql_pg_hba</code> will only return contents.</div> </td> </tr> <tr> <td colspan="1">  <b>create</b>  <div> <span>boolean</span> </div> </td> <td> <ul>
<b>Choices:</b> <li><div>
<b>no</b> ←</div></li> <li>yes</li> </ul> </td> <td> <div>Create an <code>pg_hba</code> file if none exists.</div> <div>When set to false, an error is raised when the <code>pg_hba</code> file doesn't exist.</div> </td> </tr> <tr> <td colspan="1">  <b>databases</b>  <div> <span>string</span> </div> </td> <td> <b>Default:</b><br><div>"all"</div> </td> <td> <div>Databases this line applies to.</div> </td> </tr> <tr> <td colspan="1">  <b>dest</b>  <div> <span>path</span> / <span>required</span> </div> </td> <td> </td> <td> <div>Path to <code>pg_hba</code> file to modify.</div> </td> </tr> <tr> <td colspan="1">  <b>group</b>  <div> <span>string</span> </div> </td> <td> </td> <td> <div>Name of the group that should own the file/directory, as would be fed to <em>chown</em>.</div> </td> </tr> <tr> <td colspan="1">  <b>keep_comments_at_rules</b>  <div> <span>boolean</span> </div> <div> added in 1.5.0 of community.postgresql </div> </td> <td> <ul>
<b>Choices:</b> <li><div>
<b>no</b> ←</div></li> <li>yes</li> </ul> </td> <td> <div>If <code>true</code>, comments that stand together with a rule in one line are kept behind that line.</div> <div>If <code>false</code>, such comments are moved to the beginning of the file, like all other comments.</div> </td> </tr> <tr> <td colspan="1">  <b>method</b>  <div> <span>string</span> </div> </td> <td> <ul>
<b>Choices:</b> <li>cert</li> <li>gss</li> <li>ident</li> <li>krb5</li> <li>ldap</li> <li><div>
<b>md5</b> ←</div></li> <li>pam</li> <li>password</li> <li>peer</li> <li>radius</li> <li>reject</li> <li>scram-sha-256</li> <li>sspi</li> <li>trust</li> </ul> </td> <td> <div>Authentication method to be used.</div> </td> </tr> <tr> <td colspan="1">  <b>mode</b>  <div> <span>raw</span> </div> </td> <td> </td> <td> <div>The permissions the resulting file or directory should have.</div> <div>For those used to <em>/usr/bin/chmod</em> remember that modes are actually octal numbers. You must either add a leading zero so that Ansible's YAML parser knows it is an octal number (like <code>0644</code> or <code>01777</code>) or quote it (like <code>'644'</code> or <code>'1777'</code>) so Ansible receives a string and can do its own conversion from string into number.</div> <div>Giving Ansible a number without following one of these rules will end up with a decimal number which will have unexpected results.</div> <div>As of Ansible 1.8, the mode may be specified as a symbolic mode (for example, <code>u+rwx</code> or <code>u=rw,g=r,o=r</code>).</div> <div>If <code>mode</code> is not specified and the destination file <b>does not</b> exist, the default <code>umask</code> on the system will be used when setting the mode for the newly created file.</div> <div>If <code>mode</code> is not specified and the destination file <b>does</b> exist, the mode of the existing file will be used.</div> <div>Specifying <code>mode</code> is the best way to ensure files are created with the correct permissions. See CVE-2020-1736 for further details.</div> </td> </tr> <tr> <td colspan="1">  <b>netmask</b>  <div> <span>string</span> </div> </td> <td> </td> <td> <div>The netmask of the source address.</div> </td> </tr> <tr> <td colspan="1">  <b>options</b>  <div> <span>string</span> </div> </td> <td> </td> <td> <div>Additional options for the authentication <em>method</em>.</div> </td> </tr> <tr> <td colspan="1">  <b>order</b>  <div> <span>string</span> </div> </td> <td> <ul>
<b>Choices:</b> <li><div>
<b>sdu</b> ←</div></li> <li>sud</li> <li>dsu</li> <li>dus</li> <li>usd</li> <li>uds</li> </ul> </td> <td> <div>The entries will be written out in a specific order. With this option you can control by which field they are ordered first, second and last. s=source, d=databases, u=users. This option is deprecated since 2.9 and will be removed in community.postgresql 3.0.0. Sortorder is now hardcoded to sdu.</div> </td> </tr> <tr> <td colspan="1">  <b>owner</b>  <div> <span>string</span> </div> </td> <td> </td> <td> <div>Name of the user that should own the file/directory, as would be fed to <em>chown</em>.</div> </td> </tr> <tr> <td colspan="1">  <b>selevel</b>  <div> <span>string</span> </div> </td> <td> </td> <td> <div>The level part of the SELinux file context.</div> <div>This is the MLS/MCS attribute, sometimes known as the <code>range</code>.</div> <div>When set to <code>_default</code>, it will use the <code>level</code> portion of the policy if available.</div> </td> </tr> <tr> <td colspan="1">  <b>serole</b>  <div> <span>string</span> </div> </td> <td> </td> <td> <div>The role part of the SELinux file context.</div> <div>When set to <code>_default</code>, it will use the <code>role</code> portion of the policy if available.</div> </td> </tr> <tr> <td colspan="1">  <b>setype</b>  <div> <span>string</span> </div> </td> <td> </td> <td> <div>The type part of the SELinux file context.</div> <div>When set to <code>_default</code>, it will use the <code>type</code> portion of the policy if available.</div> </td> </tr> <tr> <td colspan="1">  <b>seuser</b>  <div> <span>string</span> </div> </td> <td> </td> <td> <div>The user part of the SELinux file context.</div> <div>By default it uses the <code>system</code> policy, where applicable.</div> <div>When set to <code>_default</code>, it will use the <code>user</code> portion of the policy if available.</div> </td> </tr> <tr> <td colspan="1">  <b>state</b>  <div> <span>string</span> </div> </td> <td> <ul>
<b>Choices:</b> <li>absent</li> <li><div>
<b>present</b> ←</div></li> </ul> </td> <td> <div>The lines will be added/modified when <code>state=present</code> and removed when <code>state=absent</code>.</div> </td> </tr> <tr> <td colspan="1">  <b>unsafe_writes</b>  <div> <span>boolean</span> </div> <div> added in 2.2 of ansible.builtin </div> </td> <td> <ul>
<b>Choices:</b> <li><div>
<b>no</b> ←</div></li> <li>yes</li> </ul> </td> <td> <div>Influence when to use atomic operation to prevent data corruption or inconsistent reads from the target file.</div> <div>By default this module uses atomic operations to prevent data corruption or inconsistent reads from the target files, but sometimes systems are configured or just broken in ways that prevent this. One example is docker mounted files, which cannot be updated atomically from inside the container and can only be written in an unsafe manner.</div> <div>This option allows Ansible to fall back to unsafe methods of updating files when atomic operations fail (however, it doesn't force Ansible to perform unsafe writes).</div> <div>IMPORTANT! Unsafe writes are subject to race conditions and can lead to data corruption.</div> </td> </tr> <tr> <td colspan="1">  <b>users</b>  <div> <span>string</span> </div> </td> <td> <b>Default:</b><br><div>"all"</div> </td> <td> <div>Users this line applies to.</div> </td> </tr> </table> <br>  <h2 id="notes">Notes</h2> <div class="admonition note"> <p class="admonition-title">Note</p> <ul class="simple"> <li>The default authentication assumes that on the host, you are either logging in as or sudo’ing to an account with appropriate permissions to read and modify the file.</li> <li>This module also returns the pg_hba info. You can use this module to only retrieve it by only specifying <em>dest</em>. The info can be found in the returned data under key pg_hba, being a list, containing a dict per rule.</li> <li>This module will sort resulting <code>pg_hba</code> files if a rule change is required. This could give unexpected results with manual created hba files, if it was improperly sorted. For example a rule was created for a net first and for a ip in that net range next. In that situation, the ‘ip specific rule’ will never hit, it is in the <code>pg_hba</code> file obsolete. After the <code>pg_hba</code> file is rewritten by the <a class="reference internal" href="#ansible-collections-community-postgresql-postgresql-pg-hba-module"><span class="std std-ref">community.postgresql.postgresql_pg_hba</span></a> module, the ip specific rule will be sorted above the range rule. And then it will hit, which will give unexpected results.</li> <li>With the ‘order’ parameter you can control which field is used to sort first, next and last.</li> <li>The module supports a check mode and a diff mode.</li> </ul> </div>   <h2 id="see-also">See Also</h2> <div class="admonition seealso"> <p class="admonition-title">See also</p> <dl class="simple"> <dt><a class="reference external" href="https://www.postgresql.org/docs/current/auth-pg-hba-conf.html">PostgreSQL pg_hba.conf file reference</a></dt>
<dd>
<p>Complete reference of the PostgreSQL pg_hba.conf file documentation.</p> </dd> </dl> </div>   <h2 id="examples">Examples</h2> <pre data-language="yaml+jinja">- name: Grant users joe and simon access to databases sales and logistics from ipv6 localhost ::1/128 using peer authentication
  community.postgresql.postgresql_pg_hba:
    dest: /var/lib/postgres/data/pg_hba.conf
    contype: host
    users: joe,simon
    source: ::1
    databases: sales,logistics
    method: peer
    create: true

- name: Grant user replication from network 192.168.0.100/24 access for replication with client cert authentication
  community.postgresql.postgresql_pg_hba:
    dest: /var/lib/postgres/data/pg_hba.conf
    contype: host
    users: replication
    source: 192.168.0.100/24
    databases: replication
    method: cert

- name: Revoke access from local user mary on database mydb
  community.postgresql.postgresql_pg_hba:
    dest: /var/lib/postgres/data/pg_hba.conf
    contype: local
    users: mary
    databases: mydb
    state: absent

- name: Grant some_user access to some_db, comment that and keep other rule-specific comments attached to their rules
  community.postgresql.postgresql_pg_hba:
    dest: /var/lib/postgres/data/pg_hba.conf
    contype: host
    users: some_user
    databases: some_db
    method: md5
    source: ::/0
    keep_comments_at_rules: true
    comment: "this rule is an example"
</pre>   <h2 id="return-values">Return Values</h2> <p>Common return values are documented <a class="reference internal" href="../../../reference_appendices/common_return_values.html#common-return-values"><span class="std std-ref">here</span></a>, the following are the fields unique to this module:</p> <table class="documentation-table"> <tr> <th colspan="1">Key</th> <th>Returned</th> <th width="100%">Description</th> </tr> <tr> <td colspan="1">  <b>backup_file</b>  <div> <span>string</span> </div> </td> <td>changed</td> <td> <div>File that the original pg_hba file was backed up to.</div> <br> <div><b>Sample:</b></div> <div>/tmp/pg_hba_jxobj_p</div> </td> </tr> <tr> <td colspan="1">  <b>msgs</b>  <div> <span>list</span> / <span>elements=string</span> </div> </td> <td>always</td> <td> <div>List of textual messages what was done.</div> <br> <div><b>Sample:</b></div> <div>{'msgs': ['Removing', 'Changed', 'Writing']}</div> </td> </tr> <tr> <td colspan="1">  <b>pg_hba</b>  <div> <span>list</span> / <span>elements=string</span> </div> </td> <td>always</td> <td> <div>List of the pg_hba rules as they are configured in the specified hba file.</div> <br> <div><b>Sample:</b></div> <div>{'pg_hba': [{'db': 'all', 'method': 'md5', 'src': 'samehost', 'type': 'host', 'usr': 'all'}]}</div> </td> </tr> </table> <br><br> <h3 id="authors">Authors</h3> <ul class="simple"> <li>Sebastiaan Mannem (@sebasmannem)</li> <li>Felix Hamme (@betanummeric)</li> </ul><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2012&ndash;2018 Michael DeHaan<br>&copy; 2018&ndash;2021 Red Hat, Inc.<br>Licensed under the GNU General Public License version 3.<br>
    <a href="https://docs.ansible.com/ansible/latest/collections/community/postgresql/postgresql_pg_hba_module.html" class="_attribution-link">https://docs.ansible.com/ansible/latest/collections/community/postgresql/postgresql_pg_hba_module.html</a>
  </p>
</div>
