<h1 id="community-crypto-openssl-privatekey-pipe-generate-openssl-private-keys-without-disk-access">community.crypto.openssl_privatekey_pipe – Generate OpenSSL private keys without disk access</h1> <div class="admonition note"> <p class="admonition-title">Note</p> <p>This plugin is part of the <a class="reference external" href="https://galaxy.ansible.com/community/crypto">community.crypto collection</a> (version 1.9.6).</p> <p>You might already have this collection installed if you are using the <code>ansible</code> package. It is not included in <code>ansible-core</code>. To check whether it is installed, run <code>ansible-galaxy collection list</code>.</p> <p>To install it, use: <code>ansible-galaxy collection install community.crypto</code>.</p> <p>To use it in a playbook, specify: <code>community.crypto.openssl_privatekey_pipe</code>.</p> </div> <div class="versionadded"> <p><span class="versionmodified added">New in version 1.3.0: </span>of community.crypto</p> </div>  <ul class="simple"> <li><a class="reference internal" href="#synopsis" id="id1">Synopsis</a></li> <li><a class="reference internal" href="#requirements" id="id2">Requirements</a></li> <li><a class="reference internal" href="#parameters" id="id3">Parameters</a></li> <li><a class="reference internal" href="#see-also" id="id4">See Also</a></li> <li><a class="reference internal" href="#examples" id="id5">Examples</a></li> <li><a class="reference internal" href="#return-values" id="id6">Return Values</a></li> </ul>   <h2 id="synopsis">Synopsis</h2> <ul class="simple"> <li>Keys are generated in PEM format.</li> <li>Make sure to not write the result of this module into logs or to the console, as it contains private key data! Use the <em>no_log</em> task option to be sure.</li> <li>Note that this module is implemented as an <a class="reference external" href="../../../plugins/action.html">action plugin</a> and will always be executed on the controller.</li> <li>One can generate <a class="reference external" href="https://en.wikipedia.org/wiki/RSA_%28cryptosystem%29">RSA</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/Digital_Signature_Algorithm">DSA</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/Elliptic-curve_cryptography">ECC</a> or <a class="reference external" href="https://en.wikipedia.org/wiki/EdDSA">EdDSA</a> private keys.</li> <li>Please note that the module regenerates private keys if they don’t match the module’s options. In particular, if you provide another passphrase (or specify none), change the keysize, etc., the private key will be regenerated. If you are concerned that this could <strong>overwrite your private key</strong>, consider using the <em>backup</em> option.</li> <li>The module can use the cryptography Python library, or the pyOpenSSL Python library. By default, it tries to detect which one is available. This can be overridden with the <em>select_crypto_backend</em> option. Please note that the PyOpenSSL backend was deprecated in Ansible 2.9 and will be removed in community.crypto 2.0.0.</li> <li>This allows to read and write keys to vaults without having to write intermediate versions to disk.</li> <li>This module allows one to (re)generate OpenSSL private keys without disk access.</li> </ul> <div class="admonition note"> <p class="admonition-title">Note</p> <p>This module has a corresponding <a class="reference internal" href="../../../plugins/action.html#action-plugins"><span class="std std-ref">action plugin</span></a>.</p> </div>   <h2 id="requirements">Requirements</h2> <p>The below requirements are needed on the host that executes this module.</p> <ul class="simple"> <li>Either cryptography &gt;= 1.2.3 (older versions might work as well)</li> <li>Or pyOpenSSL</li> </ul>   <h2 id="parameters">Parameters</h2> <table class="documentation-table"> <tr> <th colspan="1">Parameter</th> <th>Choices/Defaults</th> <th width="100%">Comments</th> </tr> <tr> <td colspan="1">  <b>cipher</b>  <div> <span>string</span> </div> </td> <td> </td> <td> <div>The cipher to encrypt the private key. (Valid values can be found by running `openssl list -cipher-algorithms` or `openssl list-cipher-algorithms`, depending on your OpenSSL version.)</div> <div>When using the <code>cryptography</code> backend, use <code>auto</code>.</div> </td> </tr> <tr> <td colspan="1">  <b>content</b>  <div> <span>string</span> </div> </td> <td> </td> <td> <div>The current private key data.</div> <div>Needed for idempotency. If not provided, the module will always return a change, and all idempotence-related options are ignored.</div> </td> </tr> <tr> <td colspan="1">  <b>content_base64</b>  <div> <span>boolean</span> </div> </td> <td> <ul>
<b>Choices:</b> <li><div>
<b>no</b> ←</div></li> <li>yes</li> </ul> </td> <td> <div>Set to <code>true</code> if the content is base64 encoded.</div> </td> </tr> <tr> <td colspan="1">  <b>curve</b>  <div> <span>string</span> </div> </td> <td> <ul>
<b>Choices:</b> <li>secp224r1</li> <li>secp256k1</li> <li>secp256r1</li> <li>secp384r1</li> <li>secp521r1</li> <li>secp192r1</li> <li>brainpoolP256r1</li> <li>brainpoolP384r1</li> <li>brainpoolP512r1</li> <li>sect163k1</li> <li>sect163r2</li> <li>sect233k1</li> <li>sect233r1</li> <li>sect283k1</li> <li>sect283r1</li> <li>sect409k1</li> <li>sect409r1</li> <li>sect571k1</li> <li>sect571r1</li> </ul> </td> <td> <div>Note that not all curves are supported by all versions of <code>cryptography</code>.</div> <div>For maximal interoperability, <code>secp384r1</code> or <code>secp256r1</code> should be used.</div> <div>We use the curve names as defined in the <a href="https://www.iana.org/assignments/tls-parameters/tls-parameters.xhtml#tls-parameters-8">IANA registry for TLS</a>.</div> <div>Please note that all curves except <code>secp224r1</code>, <code>secp256k1</code>, <code>secp256r1</code>, <code>secp384r1</code> and <code>secp521r1</code> are discouraged for new private keys.</div> </td> </tr> <tr> <td colspan="1">  <b>format</b>  <div> <span>string</span> </div> </td> <td> <ul>
<b>Choices:</b> <li>pkcs1</li> <li>pkcs8</li> <li>raw</li> <li>auto</li> <li><div>
<b>auto_ignore</b> ←</div></li> </ul> </td> <td> <div>Determines which format the private key is written in. By default, PKCS1 (traditional OpenSSL format) is used for all keys which support it. Please note that not every key can be exported in any format.</div> <div>The value <code>auto</code> selects a fromat based on the key format. The value <code>auto_ignore</code> does the same, but for existing private key files, it will not force a regenerate when its format is not the automatically selected one for generation.</div> <div>Note that if the format for an existing private key mismatches, the key is <b>regenerated</b> by default. To change this behavior, use the <em>format_mismatch</em> option.</div> <div>The <em>format</em> option is only supported by the <code>cryptography</code> backend. The <code>pyopenssl</code> backend will fail if a value different from <code>auto_ignore</code> is used.</div> </td> </tr> <tr> <td colspan="1">  <b>format_mismatch</b>  <div> <span>string</span> </div> </td> <td> <ul>
<b>Choices:</b> <li><div>
<b>regenerate</b> ←</div></li> <li>convert</li> </ul> </td> <td> <div>Determines behavior of the module if the format of a private key does not match the expected format, but all other parameters are as expected.</div> <div>If set to <code>regenerate</code> (default), generates a new private key.</div> <div>If set to <code>convert</code>, the key will be converted to the new format instead.</div> <div>Only supported by the <code>cryptography</code> backend.</div> </td> </tr> <tr> <td colspan="1">  <b>passphrase</b>  <div> <span>string</span> </div> </td> <td> </td> <td> <div>The passphrase for the private key.</div> </td> </tr> <tr> <td colspan="1">  <b>regenerate</b>  <div> <span>string</span> </div> </td> <td> <ul>
<b>Choices:</b> <li>never</li> <li>fail</li> <li>partial_idempotence</li> <li><div>
<b>full_idempotence</b> ←</div></li> <li>always</li> </ul> </td> <td> <div>Allows to configure in which situations the module is allowed to regenerate private keys. The module will always generate a new key if the destination file does not exist.</div> <div>By default, the key will be regenerated when it doesn't match the module's options, except when the key cannot be read or the passphrase does not match. Please note that this <b>changed</b> for Ansible 2.10. For Ansible 2.9, the behavior was as if <code>full_idempotence</code> is specified.</div> <div>If set to <code>never</code>, the module will fail if the key cannot be read or the passphrase isn't matching, and will never regenerate an existing key.</div> <div>If set to <code>fail</code>, the module will fail if the key does not correspond to the module's options.</div> <div>If set to <code>partial_idempotence</code>, the key will be regenerated if it does not conform to the module's options. The key is <b>not</b> regenerated if it cannot be read (broken file), the key is protected by an unknown passphrase, or when they key is not protected by a passphrase, but a passphrase is specified.</div> <div>If set to <code>full_idempotence</code>, the key will be regenerated if it does not conform to the module's options. This is also the case if the key cannot be read (broken file), the key is protected by an unknown passphrase, or when they key is not protected by a passphrase, but a passphrase is specified. Make sure you have a <b>backup</b> when using this option!</div> <div>If set to <code>always</code>, the module will always regenerate the key. This is equivalent to setting <em>force</em> to <code>yes</code>.</div> <div>Note that if <em>format_mismatch</em> is set to <code>convert</code> and everything matches except the format, the key will always be converted, except if <em>regenerate</em> is set to <code>always</code>.</div> </td> </tr> <tr> <td colspan="1">  <b>return_current_key</b>  <div> <span>boolean</span> </div> </td> <td> <ul>
<b>Choices:</b> <li><div>
<b>no</b> ←</div></li> <li>yes</li> </ul> </td> <td> <div>Set to <code>true</code> to return the current private key when the module did not generate a new one.</div> <div>Note that in case of check mode, when this option is not set to <code>true</code>, the module always returns the current key (if it was provided) and Ansible will replace it by <code>VALUE_SPECIFIED_IN_NO_LOG_PARAMETER</code>.</div> </td> </tr> <tr> <td colspan="1">  <b>select_crypto_backend</b>  <div> <span>string</span> </div> </td> <td> <ul>
<b>Choices:</b> <li><div>
<b>auto</b> ←</div></li> <li>cryptography</li> <li>pyopenssl</li> </ul> </td> <td> <div>Determines which crypto backend to use.</div> <div>The default choice is <code>auto</code>, which tries to use <code>cryptography</code> if available, and falls back to <code>pyopenssl</code>.</div> <div>If set to <code>pyopenssl</code>, will try to use the <a href="https://pypi.org/project/pyOpenSSL/">pyOpenSSL</a> library.</div> <div>If set to <code>cryptography</code>, will try to use the <a href="https://cryptography.io/">cryptography</a> library.</div> <div>Please note that the <code>pyopenssl</code> backend has been deprecated in Ansible 2.9, and will be removed in community.crypto 2.0.0. From that point on, only the <code>cryptography</code> backend will be available.</div> </td> </tr> <tr> <td colspan="1">  <b>size</b>  <div> <span>integer</span> </div> </td> <td> <b>Default:</b><br><div>4096</div> </td> <td> <div>Size (in bits) of the TLS/SSL key to generate.</div> </td> </tr> <tr> <td colspan="1">  <b>type</b>  <div> <span>string</span> </div> </td> <td> <ul>
<b>Choices:</b> <li>DSA</li> <li>ECC</li> <li>Ed25519</li> <li>Ed448</li> <li><div>
<b>RSA</b> ←</div></li> <li>X25519</li> <li>X448</li> </ul> </td> <td> <div>The algorithm used to generate the TLS/SSL private key.</div> <div>Note that <code>ECC</code>, <code>X25519</code>, <code>X448</code>, <code>Ed25519</code> and <code>Ed448</code> require the <code>cryptography</code> backend. <code>X25519</code> needs cryptography 2.5 or newer, while <code>X448</code>, <code>Ed25519</code> and <code>Ed448</code> require cryptography 2.6 or newer. For <code>ECC</code>, the minimal cryptography version required depends on the <em>curve</em> option.</div> </td> </tr> </table> <br>  <h2 id="see-also">See Also</h2> <div class="admonition seealso"> <p class="admonition-title">See also</p> <dl class="simple"> <dt><a class="reference internal" href="openssl_privatekey_module.html#ansible-collections-community-crypto-openssl-privatekey-module"><span class="std std-ref">community.crypto.openssl_privatekey</span></a></dt>
<dd>
<p>The official documentation on the <strong>community.crypto.openssl_privatekey</strong> module.</p> </dd> <dt><a class="reference internal" href="openssl_privatekey_info_module.html#ansible-collections-community-crypto-openssl-privatekey-info-module"><span class="std std-ref">community.crypto.openssl_privatekey_info</span></a></dt>
<dd>
<p>The official documentation on the <strong>community.crypto.openssl_privatekey_info</strong> module.</p> </dd> <dt><a class="reference internal" href="x509_certificate_module.html#ansible-collections-community-crypto-x509-certificate-module"><span class="std std-ref">community.crypto.x509_certificate</span></a></dt>
<dd>
<p>The official documentation on the <strong>community.crypto.x509_certificate</strong> module.</p> </dd> <dt><a class="reference internal" href="x509_certificate_pipe_module.html#ansible-collections-community-crypto-x509-certificate-pipe-module"><span class="std std-ref">community.crypto.x509_certificate_pipe</span></a></dt>
<dd>
<p>The official documentation on the <strong>community.crypto.x509_certificate_pipe</strong> module.</p> </dd> <dt><a class="reference internal" href="openssl_csr_module.html#ansible-collections-community-crypto-openssl-csr-module"><span class="std std-ref">community.crypto.openssl_csr</span></a></dt>
<dd>
<p>The official documentation on the <strong>community.crypto.openssl_csr</strong> module.</p> </dd> <dt><a class="reference internal" href="openssl_csr_pipe_module.html#ansible-collections-community-crypto-openssl-csr-pipe-module"><span class="std std-ref">community.crypto.openssl_csr_pipe</span></a></dt>
<dd>
<p>The official documentation on the <strong>community.crypto.openssl_csr_pipe</strong> module.</p> </dd> <dt><a class="reference internal" href="openssl_dhparam_module.html#ansible-collections-community-crypto-openssl-dhparam-module"><span class="std std-ref">community.crypto.openssl_dhparam</span></a></dt>
<dd>
<p>The official documentation on the <strong>community.crypto.openssl_dhparam</strong> module.</p> </dd> <dt><a class="reference internal" href="openssl_pkcs12_module.html#ansible-collections-community-crypto-openssl-pkcs12-module"><span class="std std-ref">community.crypto.openssl_pkcs12</span></a></dt>
<dd>
<p>The official documentation on the <strong>community.crypto.openssl_pkcs12</strong> module.</p> </dd> <dt><a class="reference internal" href="openssl_publickey_module.html#ansible-collections-community-crypto-openssl-publickey-module"><span class="std std-ref">community.crypto.openssl_publickey</span></a></dt>
<dd>
<p>The official documentation on the <strong>community.crypto.openssl_publickey</strong> module.</p> </dd> </dl> </div>   <h2 id="examples">Examples</h2> <pre data-language="yaml+jinja">- name: Generate an OpenSSL private key with the default values (4096 bits, RSA)
  community.crypto.openssl_privatekey_pipe:
    path: /etc/ssl/private/ansible.com.pem
  register: output
  no_log: true  # make sure that private key data is not accidentally revealed in logs!
- name: Show generated key
  debug:
    msg: "{{ output.privatekey }}"
  # DO NOT OUTPUT KEY MATERIAL TO CONSOLE OR LOGS IN PRODUCTION!

- block:
    - name: Update sops-encrypted key with the community.sops collection
      community.crypto.openssl_privatekey_pipe:
        content: "{{ lookup('community.sops.sops', 'private_key.pem.sops') }}"
        size: 2048
      register: output
      no_log: true  # make sure that private key data is not accidentally revealed in logs!

    - name: Update encrypted key when openssl_privatekey_pipe reported a change
      community.sops.sops_encrypt:
        path: private_key.pem.sops
        content_text: "{{ output.privatekey }}"
      when: output is changed
  always:
    - name: Make sure that output (which contains the private key) is overwritten
      set_fact:
        output: ''
</pre>   <h2 id="return-values">Return Values</h2> <p>Common return values are documented <a class="reference internal" href="../../../reference_appendices/common_return_values.html#common-return-values"><span class="std std-ref">here</span></a>, the following are the fields unique to this module:</p> <table class="documentation-table"> <tr> <th colspan="1">Key</th> <th>Returned</th> <th width="100%">Description</th> </tr> <tr> <td colspan="1">  <b>curve</b>  <div> <span>string</span> </div> </td> <td>changed or success, and <em>type</em> is <code>ECC</code>
</td> <td> <div>Elliptic curve used to generate the TLS/SSL private key.</div> <br> <div><b>Sample:</b></div> <div>secp256r1</div> </td> </tr> <tr> <td colspan="1">  <b>fingerprint</b>  <div> <span>dictionary</span> </div> </td> <td>changed or success</td> <td> <div>The fingerprint of the public key. Fingerprint will be generated for each <code>hashlib.algorithms</code> available.</div> <div>The PyOpenSSL backend requires PyOpenSSL &gt;= 16.0 for meaningful output.</div> <br> <div><b>Sample:</b></div> <div>{'md5': '84:75:71:72:8d:04:b5:6c:4d:37:6d:66:83:f5:4c:29', 'sha1': '51:cc:7c:68:5d:eb:41:43:88:7e:1a:ae:c7:f8:24:72:ee:71:f6:10', 'sha224': 'b1:19:a6:6c:14:ac:33:1d:ed:18:50:d3:06:5c:b2:32:91:f1:f1:52:8c:cb:d5:75:e9:f5:9b:46', 'sha256': '41:ab:c7:cb:d5:5f:30:60:46:99:ac:d4:00:70:cf:a1:76:4f:24:5d:10:24:57:5d:51:6e:09:97:df:2f:de:c7', 'sha384': '85:39:50:4e:de:d9:19:33:40:70:ae:10:ab:59:24:19:51:c3:a2:e4:0b:1c:b1:6e:dd:b3:0c:d9:9e:6a:46:af:da:18:f8:ef:ae:2e:c0:9a:75:2c:9b:b3:0f:3a:5f:3d', 'sha512': 'fd:ed:5e:39:48:5f:9f:fe:7f:25:06:3f:79:08:cd:ee:a5:e7:b3:3d:13:82:87:1f:84:e1:f5:c7:28:77:53:94:86:56:38:69:f0:d9:35:22:01:1e:a6:60:...:0f:9b'}</div> </td> </tr> <tr> <td colspan="1">  <b>privatekey</b>  <div> <span>string</span> </div> </td> <td>changed, or <em>return_current_key</em> is <code>true</code>
</td> <td> <div>The generated private key's content.</div> <div>Please note that if the result is not changed, the current private key will only be returned if the <em>return_current_key</em> option is set to <code>true</code>.</div> <div>Will be Base64-encoded if the key is in raw format.</div> <br> </td> </tr> <tr> <td colspan="1">  <b>size</b>  <div> <span>integer</span> </div> </td> <td>changed or success</td> <td> <div>Size (in bits) of the TLS/SSL private key.</div> <br> <div><b>Sample:</b></div> <div>4096</div> </td> </tr> <tr> <td colspan="1">  <b>type</b>  <div> <span>string</span> </div> </td> <td>changed or success</td> <td> <div>Algorithm used to generate the TLS/SSL private key.</div> <br> <div><b>Sample:</b></div> <div>RSA</div> </td> </tr> </table> <br><br> <h3 id="authors">Authors</h3> <ul class="simple"> <li>Yanis Guenane (@Spredzy)</li> <li>Felix Fontein (@felixfontein)</li> </ul><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2012&ndash;2018 Michael DeHaan<br>&copy; 2018&ndash;2021 Red Hat, Inc.<br>Licensed under the GNU General Public License version 3.<br>
    <a href="https://docs.ansible.com/ansible/latest/collections/community/crypto/openssl_privatekey_pipe_module.html" class="_attribution-link">https://docs.ansible.com/ansible/latest/collections/community/crypto/openssl_privatekey_pipe_module.html</a>
  </p>
</div>
