<h1 id="community-windows-psexec-runs-commands-on-a-remote-windows-host-based-on-the-psexec-model">community.windows.psexec – Runs commands on a remote Windows host based on the PsExec model</h1> <div class="admonition note"> <p class="admonition-title">Note</p> <p>This plugin is part of the <a class="reference external" href="https://galaxy.ansible.com/community/windows">community.windows collection</a> (version 1.7.0).</p> <p>You might already have this collection installed if you are using the <code>ansible</code> package. It is not included in <code>ansible-core</code>. To check whether it is installed, run <code>ansible-galaxy collection list</code>.</p> <p>To install it, use: <code>ansible-galaxy collection install community.windows</code>.</p> <p>To use it in a playbook, specify: <code>community.windows.psexec</code>.</p> </div>  <ul class="simple"> <li><a class="reference internal" href="#synopsis" id="id1">Synopsis</a></li> <li><a class="reference internal" href="#requirements" id="id2">Requirements</a></li> <li><a class="reference internal" href="#parameters" id="id3">Parameters</a></li> <li><a class="reference internal" href="#notes" id="id4">Notes</a></li> <li><a class="reference internal" href="#see-also" id="id5">See Also</a></li> <li><a class="reference internal" href="#examples" id="id6">Examples</a></li> <li><a class="reference internal" href="#return-values" id="id7">Return Values</a></li> </ul>   <h2 id="synopsis">Synopsis</h2> <ul class="simple"> <li>Runs a remote command from a Linux host to a Windows host without WinRM being set up.</li> <li>Can be run on the Ansible controller to bootstrap Windows hosts to get them ready for WinRM.</li> </ul>   <h2 id="requirements">Requirements</h2> <p>The below requirements are needed on the host that executes this module.</p> <ul class="simple"> <li>pypsexec</li> <li>smbprotocol[kerberos] for optional Kerberos authentication</li> </ul>   <h2 id="parameters">Parameters</h2> <table class="documentation-table"> <tr> <th colspan="1">Parameter</th> <th>Choices/Defaults</th> <th width="100%">Comments</th> </tr> <tr> <td colspan="1">  <b>arguments</b>  <div> <span>string</span> </div> </td> <td> </td> <td> <div>Any arguments as a single string to use when running the executable.</div> </td> </tr> <tr> <td colspan="1">  <b>asynchronous</b>  <div> <span>boolean</span> </div> </td> <td> <ul>
<b>Choices:</b> <li><div>
<b>no</b> ←</div></li> <li>yes</li> </ul> </td> <td> <div>Will run the command as a detached process and the module returns immediately after starting the process while the process continues to run in the background.</div> <div>The <em>stdout</em> and <em>stderr</em> return values will be null when this is set to <code>yes</code>.</div> <div>The <em>stdin</em> option does not work with this type of process.</div> <div>The <em>rc</em> return value is not set when this is <code>yes</code>
</div> </td> </tr> <tr> <td colspan="1">  <b>connection_password</b>  <div> <span>string</span> </div> </td> <td> </td> <td> <div>The password for <em>connection_user</em>.</div> <div>Required if the Kerberos requirements are not installed or the username is a local account to the Windows host.</div> <div>Can be omitted to use a Kerberos principal ticket for the principal set by <em>connection_user</em> if the Kerberos library is installed and the ticket has already been retrieved with the <code>kinit</code> command before.</div> </td> </tr> <tr> <td colspan="1">  <b>connection_timeout</b>  <div> <span>integer</span> </div> </td> <td> <b>Default:</b><br><div>60</div> </td> <td> <div>The timeout in seconds to wait when receiving the initial SMB negotiate response from the server.</div> </td> </tr> <tr> <td colspan="1">  <b>connection_username</b>  <div> <span>string</span> </div> </td> <td> </td> <td> <div>The username to use when connecting to the remote Windows host.</div> <div>This user must be a member of the <code>Administrators</code> group of the Windows host.</div> <div>Required if the Kerberos requirements are not installed or the username is a local account to the Windows host.</div> <div>Can be omitted to use the default Kerberos principal ticket in the local credential cache if the Kerberos library is installed.</div> <div>If <em>process_username</em> is not specified, then the remote process will run under a Network Logon under this account.</div> </td> </tr> <tr> <td colspan="1">  <b>encrypt</b>  <div> <span>boolean</span> </div> </td> <td> <ul>
<b>Choices:</b> <li>no</li> <li><div>
<b>yes</b> ←</div></li> </ul> </td> <td> <div>Will use SMB encryption to encrypt the SMB messages sent to and from the host.</div> <div>This requires the SMB 3 protocol which is only supported from Windows Server 2012 or Windows 8, older versions like Windows 7 or Windows Server 2008 (R2) must set this to <code>no</code> and use no encryption.</div> <div>When setting to <code>no</code>, the packets are in plaintext and can be seen by anyone sniffing the network, any process options are included in this.</div> </td> </tr> <tr> <td colspan="1">  <b>executable</b>  <div> <span>string</span> / <span>required</span> </div> </td> <td> </td> <td> <div>The executable to run on the Windows host.</div> </td> </tr> <tr> <td colspan="1">  <b>hostname</b>  <div> <span>string</span> / <span>required</span> </div> </td> <td> </td> <td> <div>The remote Windows host to connect to, can be either an IP address or a hostname.</div> </td> </tr> <tr> <td colspan="1">  <b>integrity_level</b>  <div> <span>string</span> </div> </td> <td> <ul>
<b>Choices:</b> <li>limited</li> <li><div>
<b>default</b> ←</div></li> <li>elevated</li> </ul> </td> <td> <div>The integrity level of the process when <em>process_username</em> is defined and is not equal to <code>System</code>.</div> <div>When <code>default</code>, the default integrity level based on the system setup.</div> <div>When <code>elevated</code>, the command will be run with Administrative rights.</div> <div>When <code>limited</code>, the command will be forced to run with non-Administrative rights.</div> </td> </tr> <tr> <td colspan="1">  <b>interactive</b>  <div> <span>boolean</span> </div> </td> <td> <ul>
<b>Choices:</b> <li><div>
<b>no</b> ←</div></li> <li>yes</li> </ul> </td> <td> <div>Will run the process as an interactive process that shows a process Window of the Windows session specified by <em>interactive_session</em>.</div> <div>The <em>stdout</em> and <em>stderr</em> return values will be null when this is set to <code>yes</code>.</div> <div>The <em>stdin</em> option does not work with this type of process.</div> </td> </tr> <tr> <td colspan="1">  <b>interactive_session</b>  <div> <span>integer</span> </div> </td> <td> <b>Default:</b><br><div>0</div> </td> <td> <div>The Windows session ID to use when displaying the interactive process on the remote Windows host.</div> <div>This is only valid when <em>interactive</em> is <code>yes</code>.</div> <div>The default is <code>0</code> which is the console session of the Windows host.</div> </td> </tr> <tr> <td colspan="1">  <b>load_profile</b>  <div> <span>boolean</span> </div> </td> <td> <ul>
<b>Choices:</b> <li>no</li> <li><div>
<b>yes</b> ←</div></li> </ul> </td> <td> <div>Runs the remote command with the user's profile loaded.</div> </td> </tr> <tr> <td colspan="1">  <b>port</b>  <div> <span>integer</span> </div> </td> <td> <b>Default:</b><br><div>445</div> </td> <td> <div>The port that the remote SMB service is listening on.</div> </td> </tr> <tr> <td colspan="1">  <b>priority</b>  <div> <span>string</span> </div> </td> <td> <ul>
<b>Choices:</b> <li>above_normal</li> <li>below_normal</li> <li>high</li> <li>idle</li> <li><div>
<b>normal</b> ←</div></li> <li>realtime</li> </ul> </td> <td> <div>Set the command's priority on the Windows host.</div> <div>See <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms683211.aspx">https://msdn.microsoft.com/en-us/library/windows/desktop/ms683211.aspx</a> for more details.</div> </td> </tr> <tr> <td colspan="1">  <b>process_password</b>  <div> <span>string</span> </div> </td> <td> </td> <td> <div>The password for <em>process_username</em>.</div> <div>Required if <em>process_username</em> is defined and not <code>System</code>.</div> </td> </tr> <tr> <td colspan="1">  <b>process_timeout</b>  <div> <span>integer</span> </div> </td> <td> <b>Default:</b><br><div>0</div> </td> <td> <div>The timeout in seconds that is placed upon the running process.</div> <div>A value of <code>0</code> means no timeout.</div> </td> </tr> <tr> <td colspan="1">  <b>process_username</b>  <div> <span>string</span> </div> </td> <td> </td> <td> <div>The user to run the process as.</div> <div>This can be set to run the process under an Interactive logon of the specified account which bypasses limitations of a Network logon used when this isn't specified.</div> <div>If omitted then the process is run under the same account as <em>connection_username</em> with a Network logon.</div> <div>Set to <code>System</code> to run as the builtin SYSTEM account, no password is required with this account.</div> <div>If <em>encrypt</em> is <code>no</code>, the username and password are sent as a simple XOR scrambled byte string that is not encrypted. No special tools are required to get the username and password just knowledge of the protocol.</div> </td> </tr> <tr> <td colspan="1">  <b>show_ui_on_logon_screen</b>  <div> <span>boolean</span> </div> </td> <td> <ul>
<b>Choices:</b> <li><div>
<b>no</b> ←</div></li> <li>yes</li> </ul> </td> <td> <div>Shows the process UI on the Winlogon secure desktop when <em>process_username</em> is <code>System</code>.</div> </td> </tr> <tr> <td colspan="1">  <b>stdin</b>  <div> <span>string</span> </div> </td> <td> </td> <td> <div>Data to send on the stdin pipe once the process has started.</div> <div>This option has no effect when <em>interactive</em> or <em>asynchronous</em> is <code>yes</code>.</div> </td> </tr> <tr> <td colspan="1">  <b>working_directory</b>  <div> <span>string</span> </div> </td> <td> <b>Default:</b><br><div>"C:\\Windows\\System32"</div> </td> <td> <div>Changes the working directory set when starting the process.</div> </td> </tr> </table> <br>  <h2 id="notes">Notes</h2> <div class="admonition note"> <p class="admonition-title">Note</p> <ul class="simple"> <li>This module requires the Windows host to have SMB configured and enabled, and port 445 opened on the firewall.</li> <li>This module will wait until the process is finished unless <em>asynchronous</em> is <code>yes</code>, ensure the process is run as a non-interactive command to avoid infinite hangs waiting for input.</li> <li>The <em>connection_username</em> must be a member of the local Administrator group of the Windows host. For non-domain joined hosts, the <code>LocalAccountTokenFilterPolicy</code> should be set to <code>1</code> to ensure this works, see <a class="reference external" href="https://support.microsoft.com/en-us/help/951016/description-of-user-account-control-and-remote-restrictions-in-windows">https://support.microsoft.com/en-us/help/951016/description-of-user-account-control-and-remote-restrictions-in-windows</a>.</li> <li>For more information on this module and the various host requirements, see <a class="reference external" href="https://github.com/jborean93/pypsexec">https://github.com/jborean93/pypsexec</a>.</li> </ul> </div>   <h2 id="see-also">See Also</h2> <div class="admonition seealso"> <p class="admonition-title">See also</p> <dl class="simple"> <dt><a class="reference internal" href="../../ansible/builtin/raw_module.html#ansible-collections-ansible-builtin-raw-module"><span class="std std-ref">ansible.builtin.raw</span></a></dt>
<dd>
<p>The official documentation on the <strong>ansible.builtin.raw</strong> module.</p> </dd> <dt><a class="reference internal" href="../../ansible/windows/win_command_module.html#ansible-collections-ansible-windows-win-command-module"><span class="std std-ref">ansible.windows.win_command</span></a></dt>
<dd>
<p>The official documentation on the <strong>ansible.windows.win_command</strong> module.</p> </dd> <dt><a class="reference internal" href="win_psexec_module.html#ansible-collections-community-windows-win-psexec-module"><span class="std std-ref">community.windows.win_psexec</span></a></dt>
<dd>
<p>The official documentation on the <strong>community.windows.win_psexec</strong> module.</p> </dd> <dt><a class="reference internal" href="../../ansible/windows/win_shell_module.html#ansible-collections-ansible-windows-win-shell-module"><span class="std std-ref">ansible.windows.win_shell</span></a></dt>
<dd>
<p>The official documentation on the <strong>ansible.windows.win_shell</strong> module.</p> </dd> </dl> </div>   <h2 id="examples">Examples</h2> <pre data-language="yaml+jinja">- name: Run a cmd.exe command
  community.windows.psexec:
    hostname: server
    connection_username: username
    connection_password: password
    executable: cmd.exe
    arguments: /c echo Hello World

- name: Run a PowerShell command
  community.windows.psexec:
    hostname: server.domain.local
    connection_username: username@DOMAIN.LOCAL
    connection_password: password
    executable: powershell.exe
    arguments: Write-Host Hello World

- name: Send data through stdin
  community.windows.psexec:
    hostname: 192.168.1.2
    connection_username: username
    connection_password: password
    executable: powershell.exe
    arguments: '-'
    stdin: |
      Write-Host Hello World
      Write-Error Error Message
      exit 0

- name: Run the process as a different user
  community.windows.psexec:
    hostname: server
    connection_user: username
    connection_password: password
    executable: whoami.exe
    arguments: /all
    process_username: anotheruser
    process_password: anotherpassword

- name: Run the process asynchronously
  community.windows.psexec:
    hostname: server
    connection_username: username
    connection_password: password
    executable: cmd.exe
    arguments: /c rmdir C:\temp
    asynchronous: yes

- name: Use Kerberos authentication for the connection (requires smbprotocol[kerberos])
  community.windows.psexec:
    hostname: host.domain.local
    connection_username: user@DOMAIN.LOCAL
    executable: C:\some\path\to\executable.exe
    arguments: /s

- name: Disable encryption to work with WIndows 7/Server 2008 (R2)
  community.windows.psexec:
    hostanme: windows-pc
    connection_username: Administrator
    connection_password: Password01
    encrypt: no
    integrity_level: elevated
    process_username: Administrator
    process_password: Password01
    executable: powershell.exe
    arguments: (New-Object -ComObject Microsoft.Update.Session).CreateUpdateInstaller().IsBusy

- name: Download and run ConfigureRemotingForAnsible.ps1 to setup WinRM
  community.windows.psexec:
    hostname: '{{ hostvars[inventory_hostname]["ansible_host"] | default(inventory_hostname) }}'
    connection_username: '{{ ansible_user }}'
    connection_password: '{{ ansible_password }}'
    encrypt: yes
    executable: powershell.exe
    arguments: '-'
    stdin: |
      $ErrorActionPreference = "Stop"
      $sec_protocols = [Net.ServicePointManager]::SecurityProtocol -bor [Net.SecurityProtocolType]::SystemDefault
      $sec_protocols = $sec_protocols -bor [Net.SecurityProtocolType]::Tls12
      [Net.ServicePointManager]::SecurityProtocol = $sec_protocols
      $url = "https://github.com/ansible/ansible/raw/devel/examples/scripts/ConfigureRemotingForAnsible.ps1"
      Invoke-Expression ((New-Object Net.WebClient).DownloadString($url))
      exit
  delegate_to: localhost
</pre>   <h2 id="return-values">Return Values</h2> <p>Common return values are documented <a class="reference internal" href="../../../reference_appendices/common_return_values.html#common-return-values"><span class="std std-ref">here</span></a>, the following are the fields unique to this module:</p> <table class="documentation-table"> <tr> <th colspan="1">Key</th> <th>Returned</th> <th width="100%">Description</th> </tr> <tr> <td colspan="1">  <b>msg</b>  <div> <span>string</span> </div> </td> <td>module failed</td> <td> <div>Any exception details when trying to run the process</div> <br> <div><b>Sample:</b></div> <div>Received exception from remote PAExec service: Failed to start "invalid.exe". The system cannot find the file specified. [Err=0x2, 2]</div> </td> </tr> <tr> <td colspan="1">  <b>pid</b>  <div> <span>integer</span> </div> </td> <td>success and asynchronous is 'yes'</td> <td> <div>The process ID of the asynchronous process that was created</div> <br> <div><b>Sample:</b></div> <div>719</div> </td> </tr> <tr> <td colspan="1">  <b>rc</b>  <div> <span>integer</span> </div> </td> <td>success and asynchronous is 'no'</td> <td> <div>The return code of the remote process</div> <br> </td> </tr> <tr> <td colspan="1">  <b>stderr</b>  <div> <span>string</span> </div> </td> <td>success and interactive or asynchronous is 'no'</td> <td> <div>The stderr from the remote process</div> <br> <div><b>Sample:</b></div> <div>Error [10] running process</div> </td> </tr> <tr> <td colspan="1">  <b>stdout</b>  <div> <span>string</span> </div> </td> <td>success and interactive or asynchronous is 'no'</td> <td> <div>The stdout from the remote process</div> <br> <div><b>Sample:</b></div> <div>Hello World</div> </td> </tr> </table> <br><br> <h3 id="authors">Authors</h3> <ul class="simple"> <li>Jordan Borean (@jborean93)</li> </ul><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2012&ndash;2018 Michael DeHaan<br>&copy; 2018&ndash;2021 Red Hat, Inc.<br>Licensed under the GNU General Public License version 3.<br>
    <a href="https://docs.ansible.com/ansible/latest/collections/community/windows/psexec_module.html" class="_attribution-link">https://docs.ansible.com/ansible/latest/collections/community/windows/psexec_module.html</a>
  </p>
</div>
