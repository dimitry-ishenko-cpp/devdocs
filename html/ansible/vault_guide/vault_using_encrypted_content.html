<section id="using-encrypted-variables-and-files"> <h1 id="vault-using-encrypted-content">Using encrypted variables and files</h1> <p>When you run a task or playbook that uses encrypted variables or files, you must provide the passwords to decrypt the variables or files. You can do this at the command line or by setting a default password source in a config option or an environment variable.</p> <section id="passing-a-single-password"> <h2>Passing a single password</h2> <p>If all the encrypted variables and files in your task or playbook need to use a single password, you can use the <a class="reference internal" href="../cli/ansible-playbook.html#cmdoption-ansible-playbook-J"><code>--ask-vault-pass</code></a> or <a class="reference internal" href="../cli/ansible-playbook.html#cmdoption-ansible-playbook-vault-password-file"><code>--vault-password-file</code></a> cli options.</p> <p>To prompt for the password:</p> <pre data-language="bash">ansible-playbook --ask-vault-pass site.yml
</pre> <p>To retrieve the password from the <code>/path/to/my/vault-password-file</code> file:</p> <pre data-language="bash">ansible-playbook --vault-password-file /path/to/my/vault-password-file site.yml
</pre> <p>To get the password from the vault password client script <code>my-vault-password-client.py</code>:</p> <pre data-language="bash">ansible-playbook --vault-password-file my-vault-password-client.py
</pre> </section> <section id="passing-vault-ids"> <h2 id="specifying-vault-ids">Passing vault IDs</h2> <p>You can also use the <a class="reference internal" href="../cli/ansible-playbook.html#cmdoption-ansible-playbook-vault-id"><code>--vault-id</code></a> option to pass a single password with its vault label. This approach is clearer when multiple vaults are used within a single inventory.</p> <p>To prompt for the password for the ‘dev’ vault ID:</p> <pre data-language="bash">ansible-playbook --vault-id dev@prompt site.yml
</pre> <p>To retrieve the password for the ‘dev’ vault ID from the <code>dev-password</code> file:</p> <pre data-language="bash">ansible-playbook --vault-id dev@dev-password site.yml
</pre> <p>To get the password for the ‘dev’ vault ID from the vault password client script <code>my-vault-password-client.py</code>:</p> <pre data-language="bash">ansible-playbook --vault-id dev@my-vault-password-client.py
</pre> </section> <section id="passing-multiple-vault-passwords"> <h2>Passing multiple vault passwords</h2> <p>If your task or playbook requires multiple encrypted variables or files that you encrypted with different vault IDs, you must use the <a class="reference internal" href="../cli/ansible-playbook.html#cmdoption-ansible-playbook-vault-id"><code>--vault-id</code></a> option, passing multiple <code>--vault-id</code> options to specify the vault IDs (‘dev’, ‘prod’, ‘cloud’, ‘db’) and sources for the passwords (prompt, file, script). For example, to use a ‘dev’ password read from a file and to be prompted for the ‘prod’ password:</p> <pre data-language="bash">ansible-playbook --vault-id dev@dev-password --vault-id prod@prompt site.yml
</pre> <p>By default, the vault ID labels (dev, prod and so on) are only hints. Ansible attempts to decrypt vault content with each password. The password with the same label as the encrypted data will be tried first, after that, each vault secret will be tried in the order they were provided on the command line.</p> <p>Where the encrypted data has no label, or the label does not match any of the provided labels, the passwords will be tried in the order they are specified. In the example above, the ‘dev’ password will be tried first, then the ‘prod’ password for cases where Ansible doesn’t know which vault ID is used to encrypt something.</p> </section> <section id="using-vault-id-without-a-vault-id"> <h2>Using <code>--vault-id</code> without a vault ID</h2> <p>The <a class="reference internal" href="../cli/ansible-playbook.html#cmdoption-ansible-playbook-vault-id"><code>--vault-id</code></a> option can also be used without specifying a vault-id. This behavior is equivalent to <a class="reference internal" href="../cli/ansible-playbook.html#cmdoption-ansible-playbook-J"><code>--ask-vault-pass</code></a> or <a class="reference internal" href="../cli/ansible-playbook.html#cmdoption-ansible-playbook-vault-password-file"><code>--vault-password-file</code></a> so is rarely used.</p> <p>For example, to use a password file <code>dev-password</code>:</p> <pre data-language="bash">ansible-playbook --vault-id dev-password site.yml
</pre> <p>To prompt for the password:</p> <pre data-language="bash">ansible-playbook --vault-id @prompt site.yml
</pre> <p>To get the password from an executable script <code>my-vault-password-client.py</code>:</p> <pre data-language="bash">ansible-playbook --vault-id my-vault-password-client.py
</pre> </section> </section> <section id="configuring-defaults-for-using-encrypted-content"> <h1>Configuring defaults for using encrypted content</h1> <section id="setting-a-default-vault-id"> <h2>Setting a default vault ID</h2> <p>If you use one vault ID more frequently than any other, you can set the config option <a class="reference internal" href="../reference_appendices/config.html#default-vault-identity-list"><span class="std std-ref">DEFAULT_VAULT_IDENTITY_LIST</span></a> to specify a default vault ID and password source. Ansible will use the default vault ID and source any time you do not specify <a class="reference internal" href="../cli/ansible-playbook.html#cmdoption-ansible-playbook-vault-id"><code>--vault-id</code></a>. You can set multiple values for this option. Setting multiple values is equivalent to passing multiple <a class="reference internal" href="../cli/ansible-playbook.html#cmdoption-ansible-playbook-vault-id"><code>--vault-id</code></a> cli options.</p> </section> <section id="setting-a-default-password-source"> <h2>Setting a default password source</h2> <p>If you don’t want to provide the password file on the command line or if you use one vault password file more frequently than any other, you can set the <a class="reference internal" href="../reference_appendices/config.html#default-vault-password-file"><span class="std std-ref">DEFAULT_VAULT_PASSWORD_FILE</span></a> config option or the <a class="reference internal" href="../reference_appendices/config.html#envvar-ANSIBLE_VAULT_PASSWORD_FILE" id="index-0"><code>ANSIBLE_VAULT_PASSWORD_FILE</code></a> environment variable to specify a default file to use. For example, if you set <code>ANSIBLE_VAULT_PASSWORD_FILE=~/.vault_pass.txt</code>, Ansible will automatically search for the password in that file. This is useful if, for example, you use Ansible from a continuous integration system such as Jenkins.</p> <p>The file that you reference can be either a file containing the password (in plain text), or it can be a script (with executable permissions set) that returns the password.</p> </section> </section> <section id="when-are-encrypted-files-made-visible"> <h1>When are encrypted files made visible?</h1> <p>In general, the content you encrypt with Ansible Vault remains encrypted after execution. However, there is one exception. If you pass an encrypted file as the <code>src</code> argument to the <a class="reference internal" href="../collections/ansible/builtin/copy_module.html#copy-module"><span class="std std-ref">copy</span></a>, <a class="reference internal" href="../collections/ansible/builtin/template_module.html#template-module"><span class="std std-ref">template</span></a>, <a class="reference internal" href="../collections/ansible/builtin/unarchive_module.html#unarchive-module"><span class="std std-ref">unarchive</span></a>, <a class="reference internal" href="../collections/ansible/builtin/script_module.html#script-module"><span class="std std-ref">script</span></a> or <a class="reference internal" href="../collections/ansible/builtin/assemble_module.html#assemble-module"><span class="std std-ref">assemble</span></a> module, the file will not be encrypted on the target host (assuming you supply the correct vault password when you run the play). This behavior is intended and useful. You can encrypt a configuration file or template to avoid sharing the details of your configuration, but when you copy that configuration to servers in your environment, you want it to be decrypted so local users and processes can access it.</p> </section> <section id="format-of-files-encrypted-with-ansible-vault"> <h1 id="vault-format">Format of files encrypted with Ansible Vault</h1> <p>Ansible Vault creates UTF-8 encoded txt files. The file format includes a newline terminated header. For example:</p>  <pre data-language="text">$ANSIBLE_VAULT;1.1;AES256
</pre>  <p>or</p>  <pre data-language="text">$ANSIBLE_VAULT;1.2;AES256;vault-id-label
</pre>  <p>The header contains up to four elements, separated by semi-colons (<code>;</code>).</p>  <ol class="arabic simple"> <li>The format ID (<code>$ANSIBLE_VAULT</code>). Currently <code>$ANSIBLE_VAULT</code> is the only valid format ID. The format ID identifies content that is encrypted with Ansible Vault (with vault.is_encrypted_file()).</li> <li>The vault format version (<code>1.X</code>). All supported versions of Ansible will currently default to ‘1.1’ or ‘1.2’ if a labeled vault ID is supplied. The ‘1.0’ format is supported for reading only (and will be converted automatically to the ‘1.1’ format on write). The format version is currently used as an exact string compare only (version numbers are not currently ‘compared’).</li> <li>The cipher algorithm used to encrypt the data (<code>AES256</code>). Currently <code>AES256</code> is the only supported cipher algorithm. Vault format 1.0 used ‘AES’, but the current code always uses ‘AES256’.</li> <li>The vault ID label used to encrypt the data (optional, <code>vault-id-label</code>) For example, if you encrypt a file with <code>--vault-id dev@prompt</code>, the vault-id-label is <code>dev</code>.</li> </ol>  <p>Note: In the future, the header could change. Fields after the format ID and format version depend on the format version. Future vault format versions may add more cipher algorithm options and/or additional fields.</p> <p>The rest of the content of the file is the ‘vaulttext’. The vaulttext is a text-armored version of the encrypted ciphertext. Each line is 80 characters wide, except for the last line which may be shorter.</p> <section id="ansible-vault-payload-format-1-1-1-2"> <h2>Ansible Vault payload format 1.1 - 1.2</h2> <p>The vaulttext is a concatenation of the ciphertext and a SHA256 digest with the result ‘hexlifyied’.</p> <p>‘hexlify’ refers to the <code>hexlify()</code> method of the Python Standard Library’s <a class="reference external" href="https://docs.python.org/3/library/binascii.html">binascii</a> module.</p> <p>hexlify()’ed result of:</p> <ul class="simple"> <li>hexlify()’ed string of the salt, followed by a newline (<code>0x0a</code>)</li> <li>
<p>hexlify()’ed string of the encrypted HMAC, followed by a newline. The HMAC is:</p> <ul> <li>
<p>a <a class="reference external" href="https://www.ietf.org/rfc/rfc2104.txt">RFC2104</a> style HMAC</p> <ul> <li>
<p>inputs are:</p> <ul> <li>The AES256 encrypted ciphertext</li> <li>
<p>A PBKDF2 key. This key, the cipher key, and the cipher IV are generated from:</p> <ul> <li>the salt, in bytes</li> <li>10000 iterations</li> <li>SHA256() algorithm</li> <li>the first 32 bytes are the cipher key</li> <li>the second 32 bytes are the HMAC key</li> <li>the remaining 16 bytes are the cipher IV</li> </ul> </li> </ul> </li> </ul> </li> </ul> </li> <li>hexlify()’ed string of the ciphertext. The ciphertext is:</li> </ul>  <ul class="simple"> <li>
<p>AES256 encrypted data. The data is encrypted using:</p> <ul> <li>AES-CTR stream cipher</li> <li>cipher key</li> <li>IV</li> <li>a 128-bit counter block seeded from an integer IV</li> <li>
<p>the plaintext</p> <ul> <li>the original plaintext</li> <li>padding up to the AES256 blocksize. (The data used for padding is based on <a class="reference external" href="https://tools.ietf.org/html/rfc5652#section-6.3">RFC5652</a>)</li> </ul> </li> </ul> </li> </ul>  </section> </section><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2012&ndash;2018 Michael DeHaan<br>&copy; 2018&ndash;2024 Red Hat, Inc.<br>Licensed under the GNU General Public License version 3.<br>
    <a href="https://docs.ansible.com/ansible/latest/vault_guide/vault_using_encrypted_content.html" class="_attribution-link">https://docs.ansible.com/ansible/latest/vault_guide/vault_using_encrypted_content.html</a>
  </p>
</div>
