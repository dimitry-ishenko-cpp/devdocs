<section id="encrypting-content-with-ansible-vault"> <h1 id="vault-encrypting-content">Encrypting content with Ansible Vault</h1> <p>Once you have a strategy for managing and storing vault passwords, you can start encrypting content. You can encrypt two types of content with Ansible Vault: variables and files. Encrypted content always includes the <code>!vault</code> tag, which tells Ansible and YAML that the content needs to be decrypted, and a <code>|</code> character, which allows multi-line strings. Encrypted content created with <code>--vault-id</code> also contains the vault ID label. For more details about the encryption process and the format of content encrypted with Ansible Vault, see <a class="reference internal" href="vault_using_encrypted_content.html#vault-format"><span class="std std-ref">Format of files encrypted with Ansible Vault</span></a>. This table shows the main differences between encrypted variables and encrypted files:</p> <table class="documentation-table docutils align-default"> <thead> <tr>
<th class="head"></th> <th class="head"><p>Encrypted variables</p></th> <th class="head"><p>Encrypted files</p></th> </tr> </thead>  <tr>
<td><p>How much is encrypted?</p></td> <td><p>Variables within a plaintext file</p></td> <td><p>The entire file</p></td> </tr> <tr>
<td><p>When is it decrypted?</p></td> <td><p>On demand, only when needed</p></td> <td><p>Whenever loaded or referenced <a class="footnote-reference brackets" href="#f1" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a></p></td> </tr> <tr>
<td><p>What can be encrypted?</p></td> <td><p>Only variables</p></td> <td><p>Any structured data file</p></td> </tr>  </table> <aside class="footnote-list brackets"> <aside class="footnote brackets" id="f1" role="note"> <span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span> <p>Ansible cannot know if it needs content from an encrypted file unless it decrypts the file, so it decrypts all encrypted files referenced in your playbooks and roles.</p> </aside> </aside> <section id="encrypting-individual-variables-with-ansible-vault"> <h2 id="encrypting-variables">Encrypting individual variables with Ansible Vault</h2> <p>You can encrypt single values inside a YAML file using the <a class="reference internal" href="../cli/ansible-vault.html#ansible-vault-encrypt-string"><span class="std std-ref">ansible-vault encrypt_string</span></a> command. For one way to keep your vaulted variables safely visible, see <a class="reference internal" href="../tips_tricks/ansible_tips_tricks.html#tip-for-variables-and-vaults"><span class="std std-ref">Keep vaulted variables safely visible</span></a>.</p> <section id="advantages-and-disadvantages-of-encrypting-variables"> <h3>Advantages and disadvantages of encrypting variables</h3> <p>With variable-level encryption, your files are still easily legible. You can mix plaintext and encrypted variables, even inline in a play or role. However, password rotation is not as simple as with file-level encryption. You cannot <a class="reference internal" href="#rekeying-files"><span class="std std-ref">rekey</span></a> encrypted variables. Also, variable-level encryption only works on variables. If you want to encrypt tasks or other content, you must encrypt the entire file.</p> </section> <section id="creating-encrypted-variables"> <h3 id="encrypt-string-for-use-in-yaml">Creating encrypted variables</h3> <p>The <a class="reference internal" href="../cli/ansible-vault.html#ansible-vault-encrypt-string"><span class="std std-ref">ansible-vault encrypt_string</span></a> command encrypts and formats any string you type (or copy or generate) into a format that can be included in a playbook, role, or variables file. To create a basic encrypted variable, pass three options to the <a class="reference internal" href="../cli/ansible-vault.html#ansible-vault-encrypt-string"><span class="std std-ref">ansible-vault encrypt_string</span></a> command:</p>  <ul class="simple"> <li>a source for the vault password (prompt, file, or script, with or without a vault ID)</li> <li>the string to encrypt</li> <li>the string name (the name of the variable)</li> </ul>  <p>The pattern looks like this:</p> <pre data-language="bash">ansible-vault encrypt_string &lt;password_source&gt; '&lt;string_to_encrypt&gt;' --name '&lt;string_name_of_variable&gt;'
</pre> <p>For example, to encrypt the string ‘foobar’ using the only password stored in ‘a_password_file’ and name the variable ‘the_secret’:</p> <pre data-language="bash">ansible-vault encrypt_string --vault-password-file a_password_file 'foobar' --name 'the_secret'
</pre> <p>The command above creates this content:</p>  <pre data-language="yaml">the_secret: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      62313365396662343061393464336163383764373764613633653634306231386433626436623361
      6134333665353966363534333632666535333761666131620a663537646436643839616531643561
      63396265333966386166373632626539326166353965363262633030333630313338646335303630
      3438626666666137650a353638643435666633633964366338633066623234616432373231333331
      6564
</pre>  <p>To encrypt the string ‘foooodev’, add the vault ID label ‘dev’ with the ‘dev’ vault password stored in ‘a_password_file’, and call the encrypted variable ‘the_dev_secret’:</p> <pre data-language="bash">ansible-vault encrypt_string --vault-id dev@a_password_file 'foooodev' --name 'the_dev_secret'
</pre> <p>The command above creates this content:</p>  <pre data-language="yaml">the_dev_secret: !vault |
          $ANSIBLE_VAULT;1.2;AES256;dev
          30613233633461343837653833666333643061636561303338373661313838333565653635353162
          3263363434623733343538653462613064333634333464660a663633623939393439316636633863
          61636237636537333938306331383339353265363239643939666639386530626330633337633833
          6664656334373166630a363736393262666465663432613932613036303963343263623137386239
          6330
</pre>  <p>To encrypt the string ‘letmein’ read from stdin, add the vault ID ‘dev’ using the ‘dev’ vault password stored in <code>a_password_file</code>, and name the variable ‘db_password’:</p> <pre data-language="bash">echo -n 'letmein' | ansible-vault encrypt_string --vault-id dev@a_password_file --stdin-name 'db_password'
</pre> <div class="admonition warning"> <p class="admonition-title">Warning</p> <p>Typing secret content directly at the command line (without a prompt) leaves the secret string in your shell history. Do not do this outside of testing.</p> </div> <p>The command above creates this output:</p>  <pre data-language="console">Reading plaintext input from stdin. (ctrl-d to end input, twice if your content does not already have a new line)
db_password: !vault |
          $ANSIBLE_VAULT;1.2;AES256;dev
          61323931353866666336306139373937316366366138656131323863373866376666353364373761
          3539633234313836346435323766306164626134376564330a373530313635343535343133316133
          36643666306434616266376434363239346433643238336464643566386135356334303736353136
          6565633133366366360a326566323363363936613664616364623437336130623133343530333739
          3039
</pre>  <p>To be prompted for a string to encrypt, encrypt it with the ‘dev’ vault password from ‘a_password_file’, name the variable ‘new_user_password’ and give it the vault ID label ‘dev’:</p> <pre data-language="bash">ansible-vault encrypt_string --vault-id dev@a_password_file --stdin-name 'new_user_password'
</pre> <p>The command above triggers this prompt:</p> <pre data-language="text">Reading plaintext input from stdin. (ctrl-d to end input, twice if your content does not already have a new line)
</pre> <p>Type the string to encrypt (for example, ‘hunter2’), hit ctrl-d, and wait.</p> <div class="admonition warning"> <p class="admonition-title">Warning</p> <p>Do not press <code>Enter</code> after supplying the string to encrypt. That will add a newline to the encrypted value.</p> </div> <p>The sequence above creates this output:</p>  <pre data-language="yaml">new_user_password: !vault |
          $ANSIBLE_VAULT;1.2;AES256;dev
          37636561366636643464376336303466613062633537323632306566653533383833366462366662
          6565353063303065303831323539656138653863353230620a653638643639333133306331336365
          62373737623337616130386137373461306535383538373162316263386165376131623631323434
          3866363862363335620a376466656164383032633338306162326639643635663936623939666238
          3161
</pre>  <p>You can add the output from any of the examples above to any playbook, variables file, or role for future use. Encrypted variables are larger than plain-text variables, but they protect your sensitive content while leaving the rest of the playbook, variables file, or role in plain text so you can easily read it.</p> </section> <section id="viewing-encrypted-variables"> <h3>Viewing encrypted variables</h3> <p>You can view the original value of an encrypted variable using the debug module. You must pass the password that was used to encrypt the variable. For example, if you stored the variable created by the last example above in a file called ‘vars.yml’, you could view the unencrypted value of that variable like this:</p> <pre data-language="console">ansible localhost -m ansible.builtin.debug -a var="new_user_password" -e "@vars.yml" --vault-id dev@a_password_file

localhost | SUCCESS =&gt; {
    "new_user_password": "hunter2"
}
</pre> </section> </section> <section id="encrypting-files-with-ansible-vault"> <h2>Encrypting files with Ansible Vault</h2> <p>Ansible Vault can encrypt any structured data file used by Ansible, including:</p>  <ul class="simple"> <li>group variables files from inventory</li> <li>host variables files from inventory</li> <li>variables files passed to ansible-playbook with <code>-e @file.yml</code> or <code>-e @file.json</code>
</li> <li>variables files loaded by <code>include_vars</code> or <code>vars_files</code>
</li> <li>variables files in roles</li> <li>defaults files in roles</li> <li>tasks files</li> <li>handlers files</li> <li>binary files or other arbitrary files</li> </ul>  <p>The full file is encrypted in the vault.</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>Ansible Vault uses an editor to create or modify encrypted files. See <a class="reference internal" href="#vault-securing-editor"><span class="std std-ref">Steps to secure your editor</span></a> for some guidance on securing the editor.</p> </div> <section id="advantages-and-disadvantages-of-encrypting-files"> <h3>Advantages and disadvantages of encrypting files</h3> <p>File-level encryption is easy to use. Password rotation for encrypted files is straightforward with the <a class="reference internal" href="#rekeying-files"><span class="std std-ref">rekey</span></a> command. Encrypting files can hide not only sensitive values but the names of the variables you use. However, with file-level encryption, the contents of files are no longer easy to access and read. This may be a problem with encrypted tasks files. When encrypting a variables file, see <a class="reference internal" href="../tips_tricks/ansible_tips_tricks.html#tip-for-variables-and-vaults"><span class="std std-ref">Keep vaulted variables safely visible</span></a> for one way to keep references to these variables in a non-encrypted file. Ansible always decrypts the entire encrypted file when it is loaded or referenced because Ansible cannot know if it needs the content unless it decrypts it.</p> </section> <section id="creating-encrypted-files"> <h3 id="creating-files">Creating encrypted files</h3> <p>To create a new encrypted data file called ‘foo.yml’ with the ‘test’ vault password from ‘multi_password_file’:</p> <pre data-language="bash">ansible-vault create --vault-id test@multi_password_file foo.yml
</pre> <p>The tool launches an editor (whatever editor you have defined with $EDITOR, the default editor is vi). Add the content. When you close the editor session, the file is saved as encrypted data. The file header reflects the vault ID used to create it:</p> <pre data-language="text">``$ANSIBLE_VAULT;1.2;AES256;test``
</pre> <p>To create a new encrypted data file with the vault ID ‘my_new_password’ assigned to it and be prompted for the password:</p> <pre data-language="bash">ansible-vault create --vault-id my_new_password@prompt foo.yml
</pre> <p>Again, add content to the file in the editor and save. Be sure to store the new password you created at the prompt, so you can find it when you want to decrypt that file.</p> </section> <section id="encrypting-existing-files"> <h3 id="encrypting-files">Encrypting existing files</h3> <p>To encrypt an existing file, use the <a class="reference internal" href="../cli/ansible-vault.html#ansible-vault-encrypt"><span class="std std-ref">ansible-vault encrypt</span></a> command. This command can operate on multiple files at once. For example:</p> <pre data-language="bash">ansible-vault encrypt foo.yml bar.yml baz.yml
</pre> <p>To encrypt existing files with the ‘project’ ID and be prompted for the password:</p> <pre data-language="bash">ansible-vault encrypt --vault-id project@prompt foo.yml bar.yml baz.yml
</pre> </section> <section id="viewing-encrypted-files"> <h3 id="viewing-files">Viewing encrypted files</h3> <p>To view the contents of an encrypted file without editing it, you can use the <a class="reference internal" href="../cli/ansible-vault.html#ansible-vault-view"><span class="std std-ref">ansible-vault view</span></a> command:</p> <pre data-language="bash">ansible-vault view foo.yml bar.yml baz.yml
</pre> </section> <section id="editing-encrypted-files"> <h3 id="id2">Editing encrypted files</h3> <p>To edit an encrypted file in place, use the <a class="reference internal" href="../cli/ansible-vault.html#ansible-vault-edit"><span class="std std-ref">ansible-vault edit</span></a> command. This command decrypts the file to a temporary file, allows you to edit the content, then saves and re-encrypts the content and removes the temporary file when you close the editor. For example:</p> <pre data-language="bash">ansible-vault edit foo.yml
</pre> <p>To edit a file encrypted with the <code>vault2</code> password file and assigned the vault ID <code>pass2</code>:</p> <pre data-language="bash">ansible-vault edit --vault-id pass2@vault2 foo.yml
</pre> </section> <section id="changing-the-password-and-or-vault-id-on-encrypted-files"> <h3 id="rekeying-files">Changing the password and/or vault ID on encrypted files</h3> <p>To change the password on an encrypted file or files, use the <a class="reference internal" href="../cli/ansible-vault.html#ansible-vault-rekey"><span class="std std-ref">rekey</span></a> command:</p> <pre data-language="bash">ansible-vault rekey foo.yml bar.yml baz.yml
</pre> <p>This command can rekey multiple data files at once and will ask for the original password and also the new password. To set a different ID for the rekeyed files, pass the new ID to <code>--new-vault-id</code>. For example, to rekey a list of files encrypted with the ‘preprod1’ vault ID from the ‘ppold’ file to the ‘preprod2’ vault ID and be prompted for the new password:</p> <pre data-language="bash">ansible-vault rekey --vault-id preprod1@ppold --new-vault-id preprod2@prompt foo.yml bar.yml baz.yml
</pre> </section> <section id="decrypting-encrypted-files"> <h3 id="decrypting-files">Decrypting encrypted files</h3> <p>If you have an encrypted file that you no longer want to keep encrypted, you can permanently decrypt it by running the <a class="reference internal" href="../cli/ansible-vault.html#ansible-vault-decrypt"><span class="std std-ref">ansible-vault decrypt</span></a> command. This command will save the file unencrypted to the disk, so be sure you do not want to <a class="reference internal" href="../cli/ansible-vault.html#ansible-vault-edit"><span class="std std-ref">edit</span></a> it instead.</p> <pre data-language="bash">ansible-vault decrypt foo.yml bar.yml baz.yml
</pre> </section> <section id="steps-to-secure-your-editor"> <h3 id="vault-securing-editor">Steps to secure your editor</h3> <p>Ansible Vault relies on your configured editor, which can be a source of disclosures. Most editors have ways to prevent loss of data, but these normally rely on extra plain text files that can have a clear text copy of your secrets. Consult your editor documentation to configure the editor to avoid disclosing secure data. The following sections provide some guidance on common editors but should not be taken as a complete guide to securing your editor.</p> <section id="vim"> <h4>vim</h4> <p>You can set the following <code>vim</code> options in command mode to avoid cases of disclosure. There may be more settings you need to modify to ensure security, especially when using plugins, so consult the <code>vim</code> documentation.</p> <ol class="arabic simple"> <li>Disable swapfiles that act like an autosave in case of crash or interruption.</li> </ol> <pre data-language="text">set noswapfile
</pre> <ol class="arabic simple" start="2"> <li>Disable the creation of backup files.</li> </ol> <pre data-language="text">set nobackup
set nowritebackup
</pre> <ol class="arabic simple" start="3"> <li>Disable the viminfo file from copying data from your current session.</li> </ol> <pre data-language="text">set viminfo=
</pre> <ol class="arabic simple" start="4"> <li>Disable copying to the system clipboard.</li> </ol> <pre data-language="text">set clipboard=
</pre> <p>You can optionally add these settings in <code>.vimrc</code> for all files, or just specific paths or extensions. See the <code>vim</code> manual for details.</p> </section> <section id="emacs"> <h4>Emacs</h4> <p>You can set the following Emacs options to avoid cases of disclosure. There may be more settings you need to modify to ensure security, especially when using plugins, so consult the Emacs documentation.</p> <ol class="arabic simple"> <li>Do not copy data to the system clipboard.</li> </ol> <pre data-language="text">(setq x-select-enable-clipboard nil)
</pre> <ol class="arabic simple" start="2"> <li>Disable the creation of backup files.</li> </ol> <pre data-language="text">(setq make-backup-files nil)
</pre> <ol class="arabic simple" start="3"> <li>Disable autosave files.</li> </ol> <pre data-language="text">(setq auto-save-default nil)
</pre> </section> </section> </section> </section><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2012&ndash;2018 Michael DeHaan<br>&copy; 2018&ndash;2024 Red Hat, Inc.<br>Licensed under the GNU General Public License version 3.<br>
    <a href="https://docs.ansible.com/ansible/latest/vault_guide/vault_encrypting_content.html" class="_attribution-link">https://docs.ansible.com/ansible/latest/vault_guide/vault_encrypting_content.html</a>
  </p>
</div>
