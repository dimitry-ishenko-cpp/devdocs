<h1>Constraints</h1>

<div class="css-elchao exirf770">
<blockquote>
<p><strong>Experimental</strong></p>
<p>This feature is still incubating, and its exact API might change from a release to the next. It means it's the perfect time for you to get involved and let us hear your feedback!</p>
</blockquote>
<blockquote>
<p><strong>Plugin</strong></p>
<p>To access this feature, first install the <code class="language-text">constraints</code> plugin: <code class="language-text">yarn plugin import constraints</code></p>
</blockquote>
<p>Constraints are a solution to a very basic need: I have a lot of <a href="workspaces.html">workspaces</a>, and I need to make sure they use the same version of their dependencies. Or that they don't depend on a specific package. Or that they use a specific type of dependency. Anyway, you see the point: whatever is the exact logic, my goal is the same; I want to automatically enforce some kind of rule across all my workspaces. That's exactly what constraints allow you to do.</p>
<div class="toc"><ul>
<li>
<p><a href="#creating-a-constraint">Creating a constraint</a></p>
<ul>
<li>
<p><a href="#query-predicate">Query predicate</a></p>
<ul>
<li><a href="#dependency_type1"><code class="language-text">dependency_type/1</code></a></li>
<li><a href="#workspace1"><code class="language-text">workspace/1</code></a></li>
<li><a href="#workspace_ident2"><code class="language-text">workspace_ident/2</code></a></li>
<li><a href="#workspace_version2"><code class="language-text">workspace_version/2</code></a></li>
<li><a href="#workspace_has_dependency4"><code class="language-text">workspace_has_dependency/4</code></a></li>
<li><a href="#workspace_field3"><code class="language-text">workspace_field/3</code></a></li>
</ul>
</li>
<li><p><a href="#workspace_field_test3"><code class="language-text">workspace_field_test/3</code></a></p></li>
<li>
<p><a href="#constraint-predicates">Constraint predicates</a></p>
<ul>
<li><a href="#gen_enforced_dependency4"><code class="language-text">gen_enforced_dependency/4</code></a></li>
<li><a href="#gen_enforced_field3"><code class="language-text">gen_enforced_field/3</code></a></li>
</ul>
</li>
</ul>
</li>
<li>
<p><a href="#constraint-recipes">Constraint recipes</a></p>
<ul>
<li><a href="#prevent-all-workspaces-from-depending-on-a-specific-package">Prevent all workspaces from depending on a specific package</a></li>
<li><a href="#prevent-two-workspaces-from-depending-on-conflicting-versions-of-a-same-dependency">Prevent two workspaces from depending on conflicting versions of a same dependency</a></li>
<li><a href="#force-all-workspace-dependencies-to-be-made-explicit">Force all workspace dependencies to be made explicit</a></li>
</ul>
</li>
</ul></div>
<h2 id="creating-a-constraint">
Creating a constraint</h2>
<p>Constraints are created by adding a <code class="language-text">constraints.pro</code> file at the root of your project (repository). The <code class="language-text">.pro</code> extension might leave you perplexed: this is because constraints aren't written in JavaScript (!) but rather in Prolog, a fact-based rule engine. The goal of this section isn't to teach you Prolog (good tutorials already exist, such as <a href="https://learnxinyminutes.com/docs/prolog/">Learn Prolog in Y Minutes</a>), but rather to show you why we chose it and the value it brings.</p>
<p>As we mentioned, Prolog is a fact-based engine. It starts with a list of <em>facts</em> that are always true, and a list of <em>predicates</em> that basically read as "predicate <code class="language-text">f(X)</code> is true if <code class="language-text">u(X)</code> and <code class="language-text">v(X)</code> are both true". By computing for which values of <code class="language-text">X</code> are <code class="language-text">u(X)</code> and <code class="language-text">v(X)</code> true, Prolog is able to automatically compute the list of values for which <code class="language-text">f(X)</code> would be true. This is particularly useful for constraints, because it allows you to write very simple but powerful rules that have the ability to affect all your workspaces in very few lines.</p>
<p>Going back to the constraint engine, the <em>facts</em> are the definitions created by the package manager (such as "fact: the root workspace depends on Lodash version 4.4.2 in devDependencies"), and the <em>predicates</em> are the set of rules that you want to enforce across your project (check below for some recipes).</p>
<h3 id="query-predicate">
Query predicate</h3>
<p>The following predicates provide information about the current state of your project and are meant to be used in the dependencies of your own rules (check the recipes for examples how to use them in practice). Note that the <code class="language-text">/&lt;number&gt;</code> syntax listed at the end simply is the predicate arity (number of arguments it takes).</p>
<p>The notation on this page uses <code class="language-text">-</code>, <code class="language-text">+</code> and <code class="language-text">?</code> as prefix for the predicate parameters. These values are used commonly in prolog documentation and mean</p>
<ul>
<li>
<code class="language-text">+</code>: this value is considered input and must be instantiated</li>
<li>
<code class="language-text">-</code>: this value is considered output and will be instantiated by the predicate, though you can provide a value to verify that the value matches the predicate</li>
<li>
<code class="language-text">?</code>: this value can be instantiated or not, both will work</li>
</ul>
<h4 id="dependency_type1">
<code class="language-text">dependency_type/1</code>
</h4>
<div class="gatsby-highlight" data-language="prolog"><pre class="language-prolog"><code class="language-prolog"><span class="token function">dependency_type</span><span class="token punctuation">(</span>
  <span class="token operator">-</span><span class="token variable">DependencyType</span>
<span class="token punctuation">)</span><span class="token operator">.</span></code></pre></div>
<p>True for only three values: <code class="language-text">dependencies</code>, <code class="language-text">devDependencies</code> and <code class="language-text">peerDependencies</code>.</p>
<h4 id="workspace1">
<code class="language-text">workspace/1</code>
</h4>
<div class="gatsby-highlight" data-language="prolog"><pre class="language-prolog"><code class="language-prolog"><span class="token function">workspace</span><span class="token punctuation">(</span>
  <span class="token operator">-</span><span class="token variable">WorkspaceCwd</span>
<span class="token punctuation">)</span><span class="token operator">.</span></code></pre></div>
<p>True if the workspace described by the specified <code class="language-text">WorkspaceCwd</code> exists.</p>
<h4 id="workspace_ident2">
<code class="language-text">workspace_ident/2</code>
</h4>
<div class="gatsby-highlight" data-language="prolog"><pre class="language-prolog"><code class="language-prolog"><span class="token function">workspace_ident</span><span class="token punctuation">(</span>
  <span class="token operator">?</span><span class="token variable">WorkspaceCwd</span><span class="token punctuation">,</span>
  <span class="token operator">?</span><span class="token variable">WorkspaceIdent</span>
<span class="token punctuation">)</span><span class="token operator">.</span></code></pre></div>
<p>True if the workspace described by the specified <code class="language-text">WorkspaceCwd</code> exists and if it has the specified <code class="language-text">WorkspaceIdent</code>.</p>
<h4 id="workspace_version2">
<code class="language-text">workspace_version/2</code>
</h4>
<div class="gatsby-highlight" data-language="prolog"><pre class="language-prolog"><code class="language-prolog"><span class="token function">workspace_version</span><span class="token punctuation">(</span>
  <span class="token operator">?</span><span class="token variable">WorkspaceCwd</span><span class="token punctuation">,</span>
  <span class="token operator">?</span><span class="token variable">WorkspaceVersion</span>
<span class="token punctuation">)</span><span class="token operator">.</span></code></pre></div>
<p>True if the workspace described by the specified <code class="language-text">WorkspacedCwd</code> exists and if it has the specified <code class="language-text">WorkspaceVersion</code>.</p>
<h4 id="workspace_has_dependency4">
<code class="language-text">workspace_has_dependency/4</code>
</h4>
<div class="gatsby-highlight" data-language="prolog"><pre class="language-prolog"><code class="language-prolog"><span class="token function">workspace_has_dependency</span><span class="token punctuation">(</span>
  <span class="token operator">?</span><span class="token variable">WorkspaceCwd</span><span class="token punctuation">,</span>
  <span class="token operator">?</span><span class="token variable">DependencyIdent</span><span class="token punctuation">,</span>
  <span class="token operator">?</span><span class="token variable">DependencyRange</span><span class="token punctuation">,</span>
  <span class="token operator">?</span><span class="token variable">DependencyType</span>
<span class="token punctuation">)</span><span class="token operator">.</span></code></pre></div>
<p>True if the workspace described by the specified <code class="language-text">WorkspaceCwd</code> depends on the dependency described by the specified <code class="language-text">DependencyIdent</code> and <code class="language-text">DependencyRange</code> combination in the dependencies block of the given <code class="language-text">DependencyType</code>.</p>
<h4 id="workspace_field3">
<code class="language-text">workspace_field/3</code>
</h4>
<div class="gatsby-highlight" data-language="prolog"><pre class="language-prolog"><code class="language-prolog"><span class="token function">workspace_field</span><span class="token punctuation">(</span>
  <span class="token operator">+</span><span class="token variable">WorkspaceCwd</span><span class="token punctuation">,</span>
  <span class="token operator">+</span><span class="token variable">FieldPath</span><span class="token punctuation">,</span>
  <span class="token operator">-</span><span class="token variable">FieldValue</span>
<span class="token punctuation">)</span><span class="token operator">.</span></code></pre></div>
<p>True if the workspace described by the <code class="language-text">WorkspaceCwd</code> has the given <code class="language-text">FieldValue</code> in the manifest at <code class="language-text">FieldPath</code>.</p>
<p>The <code class="language-text">FieldPath</code> can target properties of properties via <code class="language-text">.</code> notation, e.g. a <code class="language-text">FieldPath</code> of <code class="language-text">'publishConfig.registry'</code> will set <code class="language-text">FieldValue</code> to the value of the <code class="language-text">registry</code> inside <code class="language-text">publishConfig</code>.</p>
<h3 id="workspace_field_test3">
<code class="language-text">workspace_field_test/3</code>
</h3>
<div class="gatsby-highlight" data-language="prolog"><pre class="language-prolog"><code class="language-prolog"><span class="token function">workspace_field</span><span class="token punctuation">(</span>
  <span class="token operator">+</span><span class="token variable">WorkspaceCwd</span><span class="token punctuation">,</span>
  <span class="token operator">+</span><span class="token variable">FieldPath</span><span class="token punctuation">,</span>
  <span class="token operator">+</span><span class="token variable">CheckCode</span>
<span class="token punctuation">)</span><span class="token operator">.</span></code></pre></div>
<p>True if the workspace described by the <code class="language-text">WorkspaceCwd</code> has a value in the manifest at <code class="language-text">FieldPath</code>, and if this value passes the check of <code class="language-text">CheckCode</code>.</p>
<p>The <code class="language-text">CheckCode</code> script is meant to be written in JavaScript, with the special variable <code class="language-text">$$</code> representing the value obtained from the manifest. This makes <code class="language-text">workspace_field_test</code> an escape hatch for some operations that would be too inconvenient to implement in Prolog (for example checking that a value is present within a JS array, etc).</p>
<p>The <code class="language-text">Arguments</code> parameter is expected to be an optional Prolog list of atoms that will be passed to <code class="language-text">CheckCode</code> through <code class="language-text">$0</code>, <code class="language-text">$1</code>, etc.</p>
<h3 id="constraint-predicates">
Constraint predicates</h3>
<p>The following predicates will affect the behavior of the <code class="language-text">yarn constraints</code> and <code class="language-text">yarn constraints --fix</code> commands.</p>
<p>The parameters to the predicates are prefixed with <code class="language-text">+</code> and <code class="language-text">-</code>. These have the same meaning as in the query predicates. In this context they mean</p>
<ul>
<li>
<code class="language-text">-</code> These are the output, they will not have a value when the predicate is invoked and the predicate must ensure a value is set</li>
<li>
<code class="language-text">+</code> These are the input, they will already have a value when the predicate is invoked</li>
</ul>
<h4 id="gen_enforced_dependency4">
<code class="language-text">gen_enforced_dependency/4</code>
</h4>
<div class="gatsby-highlight" data-language="prolog"><pre class="language-prolog"><code class="language-prolog"><span class="token function">gen_enforced_dependency</span><span class="token punctuation">(</span>
  <span class="token operator">+</span><span class="token variable">WorkspaceCwd</span><span class="token punctuation">,</span>
  <span class="token operator">-</span><span class="token variable">DependencyIdent</span><span class="token punctuation">,</span>
  <span class="token operator">-</span><span class="token variable">DependencyRange</span><span class="token punctuation">,</span>
  <span class="token operator">+</span><span class="token variable">DependencyType</span>
<span class="token punctuation">)</span><span class="token operator">.</span></code></pre></div>
<p>The <code class="language-text">gen_enforced_dependency</code> rule offers a neat way to inform the package manager that a specific workspace MUST either depend on a specific range of a specific dependency (if <code class="language-text">DependencyRange</code> is non-null) or not depend at all on the dependency (if <code class="language-text">DependencyRange</code> is null; takes precedence over any conflicting range) in the <code class="language-text">DependencyType</code> dependencies block.</p>
<p>Running <code class="language-text">yarn constraints --fix</code> will instruct Yarn to fix the detected errors the best it can, but in some cases ambiguities will arise. Those will have to be solved manually, although Yarn will help you in the process.</p>
<h4 id="gen_enforced_field3">
<code class="language-text">gen_enforced_field/3</code>
</h4>
<div class="gatsby-highlight" data-language="prolog"><pre class="language-prolog"><code class="language-prolog"><span class="token function">gen_enforced_field</span><span class="token punctuation">(</span>
  <span class="token operator">+</span><span class="token variable">WorkspaceCwd</span><span class="token punctuation">,</span>
  <span class="token operator">-</span><span class="token variable">FieldPath</span><span class="token punctuation">,</span>
  <span class="token operator">+</span><span class="token variable">FieldValue</span>
<span class="token punctuation">)</span><span class="token operator">.</span></code></pre></div>
<p>The <code class="language-text">gen_enforced_field</code> predicate tells the package manager that a specific workspace must have the given <code class="language-text">FieldValue</code> in the manifest via the <code class="language-text">FieldPath</code>. A <code class="language-text">FieldValue</code> of <code class="language-text">null</code> means the field has to be absent:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">? gen_enforced_field(WorkspaceCwd, FieldPath, null).</code></pre></div>
<p>Note that the value will be interpreted in JSON if possible, or as a regular string otherwise. So if you need to put a <code class="language-text">null</code> value into a field, use the JSON syntax:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">? gen_enforced_field(WorkspaceCwd, FieldPath, 'null').</code></pre></div>
<p>Finally, if you need to put a string containing <code class="language-text">null</code> into a field, use the JSON string syntax:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">? gen_enforced_field(WorkspaceCwd, FieldPath, '"null"').</code></pre></div>
<p>Running <code class="language-text">yarn constraints --fix</code> will instruct Yarn to fix the detected errors the best it can, but in some cases ambiguities will arise. Those will have to be solved manually, although Yarn will help you in the process.</p>
<h2 id="constraint-recipes">
Constraint recipes</h2>
<p>The following constraints are a good starting point to figure out how to write your own rules. If you build one that you think would be a good fit for this section, open a PR and we'll add them here!</p>
<blockquote>
<p><strong>Quick note about the Prolog syntax</strong></p>
<p>Be aware that in prolog <code class="language-text">X :- Y</code> basically means "X is true for each Y that's true". Similarly, know that UpperCamelCase names are variables that get "replaced" by every compatible value possible. Finally, the special variable name <code class="language-text">_</code> simply discards the parameter value.</p>
</blockquote>
<h3 id="prevent-all-workspaces-from-depending-on-a-specific-package">
Prevent all workspaces from depending on a specific package</h3>
<div class="gatsby-highlight" data-language="prolog"><pre class="language-prolog"><code class="language-prolog"><span class="token function">gen_enforced_dependency</span><span class="token punctuation">(</span><span class="token variable">WorkspaceCwd</span><span class="token punctuation">,</span> <span class="token string">'tslib'</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token variable">DependencyType</span><span class="token punctuation">)</span> <span class="token operator">:-</span>
  <span class="token function">workspace_has_dependency</span><span class="token punctuation">(</span><span class="token variable">WorkspaceCwd</span><span class="token punctuation">,</span> <span class="token string">'tslib'</span><span class="token punctuation">,</span> <span class="token variable">_</span><span class="token punctuation">,</span> <span class="token variable">DependencyType</span><span class="token punctuation">)</span><span class="token operator">.</span></code></pre></div>
<p>We define a rule that says that for each dependency of each workspace in our project, if this dependency name is <code class="language-text">tslib</code>, then it exists a similar rule of the <code class="language-text">gen_enforced_dependency</code> type that forbids the workspace from depending on <code class="language-text">tslib</code>. This will cause the package manager to see that the rule isn't met, and autofix it when requested by removing the dependency from the workspace.</p>
<h3 id="prevent-two-workspaces-from-depending-on-conflicting-versions-of-a-same-dependency">
Prevent two workspaces from depending on conflicting versions of a same dependency</h3>
<div class="gatsby-highlight" data-language="prolog"><pre class="language-prolog"><code class="language-prolog"><span class="token function">gen_enforced_dependency</span><span class="token punctuation">(</span><span class="token variable">WorkspaceCwd</span><span class="token punctuation">,</span> <span class="token variable">DependencyIdent</span><span class="token punctuation">,</span> <span class="token variable">DependencyRange2</span><span class="token punctuation">,</span> <span class="token variable">DependencyType</span><span class="token punctuation">)</span> <span class="token operator">:-</span>
  <span class="token function">workspace_has_dependency</span><span class="token punctuation">(</span><span class="token variable">WorkspaceCwd</span><span class="token punctuation">,</span> <span class="token variable">DependencyIdent</span><span class="token punctuation">,</span> <span class="token variable">DependencyRange</span><span class="token punctuation">,</span> <span class="token variable">DependencyType</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">workspace_has_dependency</span><span class="token punctuation">(</span><span class="token variable">OtherWorkspaceCwd</span><span class="token punctuation">,</span> <span class="token variable">DependencyIdent</span><span class="token punctuation">,</span> <span class="token variable">DependencyRange2</span><span class="token punctuation">,</span> <span class="token variable">DependencyType2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token variable">DependencyRange</span> <span class="token operator">\=</span> <span class="token variable">DependencyRange2</span><span class="token operator">.</span></code></pre></div>
<p>We define a <code class="language-text">gen_enforced_dependency</code> rule that requires each dependency of each package (first <code class="language-text">workspace_has_dependency</code>) if it also exists another dependency of another package (second <code class="language-text">workspace_has_dependency</code>) that has the same name but a different range (<code class="language-text">\=</code> operator).</p>
<h3 id="force-all-workspace-dependencies-to-be-made-explicit">
Force all workspace dependencies to be made explicit</h3>
<div class="gatsby-highlight" data-language="prolog"><pre class="language-prolog"><code class="language-prolog"><span class="token function">gen_enforced_dependency</span><span class="token punctuation">(</span><span class="token variable">WorkspaceCwd</span><span class="token punctuation">,</span> <span class="token variable">DependencyIdent</span><span class="token punctuation">,</span> <span class="token string">'workspace:*'</span><span class="token punctuation">,</span> <span class="token variable">DependencyType</span><span class="token punctuation">)</span> <span class="token operator">:-</span>
  <span class="token function">workspace_ident</span><span class="token punctuation">(</span><span class="token variable">_</span><span class="token punctuation">,</span> <span class="token variable">DependencyIdent</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">workspace_has_dependency</span><span class="token punctuation">(</span><span class="token variable">WorkspaceCwd</span><span class="token punctuation">,</span> <span class="token variable">DependencyIdent</span><span class="token punctuation">,</span> <span class="token variable">_</span><span class="token punctuation">,</span> <span class="token variable">DependencyType</span><span class="token punctuation">)</span><span class="token operator">.</span></code></pre></div>
<p>We define a <code class="language-text">gen_enforced_dependency</code> rule that requires the dependency range <code class="language-text">workspace:*</code> to be used if the dependency name is also the name of a valid workspace. The final <code class="language-text">workspace_has_dependency</code> check is there to ensure that this rule is only applied on workspace that currently depend on the specified workspace in the first place (if it wasn't there, the rule would instead force all workspaces to depend on one another).</p>
</div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2016&ndash;present Yarn Contributors<br>Licensed under the BSD License.<br>
    <a href="https://yarnpkg.com/features/constraints" class="_attribution-link">https://yarnpkg.com/features/constraints</a>
  </p>
</div>
