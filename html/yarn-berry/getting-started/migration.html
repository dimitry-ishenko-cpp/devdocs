<h1>5. Migration</h1>

<div class="css-elchao exirf770">
<p>Any major release has its breaking changes, and Yarn 2 isn't the exception. A few old behaviors were cleaned, fixed, modified, or removed. While one of our goals is to make the transition as easy as we can, there are a few things to be aware of when migrating a codebase. To make this process more efficient we've listed below the recommended migration steps, along with solutions for the most common problems you might face.</p>
<div class="toc"><ul>
<li><p><a href="#why-should-you-migrate">Why should you migrate?</a></p></li>
<li><p><a href="#step-by-step">Step by step</a></p></li>
<li>
<p><a href="#switching-to-plugnplay">Switching to Plug'n'Play</a></p>
<ul>
<li><a href="#before-we-start">Before we start</a></li>
<li><a href="#enabling-it">Enabling it</a></li>
<li><a href="#editor-support">Editor support</a></li>
<li><a href="#final-notes">Final notes</a></li>
</ul>
</li>
<li>
<p><a href="#general-advices">General Advices</a></p>
<ul>
<li><a href="#upgrade-to-nodejs-12x-or-newer">Upgrade to Node.js 12.x or newer</a></li>
<li><a href="#fix-dependencies-with-packageextensions">Fix dependencies with <code class="language-text">packageExtensions</code></a></li>
<li><a href="#use-yarn-dlx-instead-of-yarn-global">Use <code class="language-text">yarn dlx</code> instead of <code class="language-text">yarn global</code></a></li>
<li><a href="#enable-the-pnp-plugin-when-using-webpack-4">Enable the PnP plugin when using Webpack 4</a></li>
<li><a href="#upgrade-resolve-to-19">Upgrade <code class="language-text">resolve</code> to 1.9+</a></li>
<li><a href="#call-binaries-using-yarn-run-rather-than-node_modulesbin">Call binaries using <code class="language-text">yarn run</code> rather than <code class="language-text">node_modules/.bin</code></a></li>
<li><a href="#call-your-scripts-through-yarn-node-rather-than-node">Call your scripts through <code class="language-text">yarn node</code> rather than <code class="language-text">node</code></a></li>
<li><a href="#explicitly-call-the-pre-and-post-scripts">Explicitly call the <code class="language-text">pre</code> and <code class="language-text">post</code> scripts</a></li>
<li><a href="#setup-your-ide-for-pnp-support">Setup your IDE for PnP support</a></li>
<li><a href="#update-your-configuration-to-the-new-settings">Update your configuration to the new settings</a></li>
<li><a href="#dont-use-npmrc-files">Don't use <code class="language-text">.npmrc</code> files</a></li>
<li><a href="#take-a-look-at-our-end-to-end-tests">Take a look at our end-to-end tests</a></li>
<li><a href="#dont-use-bundledependencies">Don't use <code class="language-text">bundleDependencies</code></a></li>
<li><a href="#if-required-enable-the-node-modules-plugin">If required: enable the <code class="language-text">node-modules</code> plugin</a></li>
<li><a href="#replace-nohoist-by-nmhoistinglimits">Replace <code class="language-text">nohoist</code> by <code class="language-text">nmHoistingLimits</code></a></li>
</ul>
</li>
<li>
<p><a href="#cli-commands">CLI Commands</a></p>
<ul>
<li><a href="#renamed">Renamed</a></li>
<li><a href="#removed-from-core">Removed from core</a></li>
<li><a href="#not-implemented-yet">Not implemented yet</a></li>
</ul>
</li>
<li>
<p><a href="#troubleshooting">Troubleshooting</a></p>
<ul>
<li><a href="#cannot-find-module-"><code class="language-text">Cannot find module [...]</code></a></li>
<li><a href="#a-package-is-trying-to-access-another-package-"><code class="language-text">A package is trying to access another package [...]</code></a></li>
</ul>
</li>
</ul></div>
<h2 id="why-should-you-migrate">
Why should you migrate?</h2>
<p>We answer this question in details <a href="qa.html#why-should-you-upgrade-to-yarn-modern">here</a>.</p>
<p>In a few words, upgrading to the latest versions is critical to a fast and stable Yarn experience. Numerous bugs were fixed since the first major version, and we no longer expect to build new features on the old trunk. <strong>Even if you don't plan to use the new default installation strategy called Plug'n'Play</strong> your projects will still get benefits from the upgrade:</p>
<ul>
<li>The good old <code class="language-text">node_modules</code> installer improved as well as various edge cases got fixed</li>
<li>A renewed focus on performances and good practices (we now formally track perfs via a <a href="../benchmarks.html">dashboard</a>)</li>
<li>Improved user experience for various CLI commands and settings (<a href="../cli/add.html"><code class="language-text">yarn add -i</code></a>, <a href="../cli/up.html"><code class="language-text">yarn up</code></a>, <a href="../configuration/yarnrc.html#logFilters"><code class="language-text">logFilters</code></a>, ...)</li>
<li>New commands and capabilities (such as the <a href="https://github.com/yarnpkg/berry/tree/master/packages/plugin-typescript#yarnpkgplugin-typescript">TypeScript plugin</a>, or the <a href="../features/release-workflow.html">release workflow</a>)</li>
</ul>
<p>And of course a very active development cycle.</p>
<h2 id="step-by-step">
Step by step</h2>
<p><strong>Note:</strong> Don't worry if your project isn't quite ready for <a href="../features/pnp.html">Plug'n'Play</a> just yet! This guide will let you migrate <strong>without losing your <code class="language-text">node_modules</code> folder</strong>. Only in a later optional section we will cover how to enable PnP support, and this part will only be recommended, not mandatory. Baby steps! ðŸ˜‰</p>
<p>Note that those commands only need to be run once for the whole project and will automatically take effect for all your contributors as soon as they pull the migration commit, thanks to the power of <a href="../configuration/yarnrc.html#yarnPath"><code class="language-text">yarnPath</code></a>:</p>
<ol>
<li>Run <code class="language-text">npm install -g yarn</code> to update the global yarn version to latest v1</li>
<li>Go into your project directory</li>
<li>Run <code class="language-text">yarn set version berry</code> to enable v2 (cf <a href="install.html">Install</a> for more details)</li>
<li>If you used <code class="language-text">.npmrc</code> or <code class="language-text">.yarnrc</code>, you'll need to turn them into the <a href="../configuration/yarnrc.html">new format</a> (see also <a href="migration.html#update-your-configuration-to-the-new-settings">1</a>, <a href="migration.html#dont-use-npmrc-files">2</a>)</li>
<li>Add <a href="../configuration/yarnrc.html#nodeLinker"><code class="language-text">nodeLinker: node-modules</code></a> in your <code class="language-text">.yarnrc.yml</code> file</li>
<li>Commit the changes so far (<code class="language-text">yarn-X.Y.Z.js</code>, <code class="language-text">.yarnrc.yml</code>, ...)</li>
<li>Run <code class="language-text">yarn install</code> to migrate the lockfile</li>
<li>Take a look at <a href="qa.html#which-files-should-be-gitignored">this article</a> to see what should be gitignored</li>
<li>Commit everything remaining</li>
</ol>
<p>Some optional features are available via external plugins:</p>
<ol start="10">
<li>Run <a href="../cli/plugin/import.html"><code class="language-text">yarn plugin import interactive-tools</code></a> if you want <a href="../cli/upgrade-interactive.html"><code class="language-text">upgrade-interactive</code></a>
</li>
<li>Run <a href="../cli/plugin/list.html"><code class="language-text">yarn plugin list</code></a> to see what other official plugins exist and might be useful</li>
<li>Commit the yarn plugins</li>
</ol>
<p>Good, you should now have a working Yarn install! Some things might still require a bit of work (for instance we deprecated <a href="../advanced/lifecycle-scripts.html">arbitrary <code class="language-text">pre/post</code>-scripts</a>, and renamed <code class="language-text">--frozen-lockfile</code> into <code class="language-text">--immutable</code>), but those special cases will be documented on a case-by-case basis in the rest of this document (for example <a href="migration.html#explicitly-call-the-pre-and-post-scripts">here</a>).</p>
<h2 id="switching-to-plugnplay">
Switching to Plug'n'Play</h2>
<p>This step is completely optional - while we recommend to use Plug'n'Play for most new projects, it may sometimes require an average time investment to enable it on existing projects. For this reason, we prefer to list it here as a separate step that you can look into if you're curious or simply want the absolute best of what Yarn has to offer.</p>
<h3 id="before-we-start">
Before we start</h3>
<p>Plug'n'Play enforces strict dependency rules. In particular, you'll hit problems if you (or your dependencies) rely on unlisted dependencies (the reasons for that are detailed in our <a href="../advanced/rulebook.html">Rulebook</a>), but the gist is that it was the cause of many "project doesn't work on my computer" issues, both in Yarn and other package managers.</p>
<p>To quickly detect which places may rely on unsafe patterns run <code class="language-text">yarn dlx @yarnpkg/doctor</code> in your project - it'll statically analyze your sources to try to locate the most common issues that could result in a subpar experience. For example here's what <code class="language-text">webpack-dev-server</code> would reveal:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">âž¤ YN0000: Found 1 package(s) to process
âž¤ YN0000: For a grand total of 236 file(s) to validate

âž¤ YN0000: â”Œ /webpack-dev-server/package.json
âž¤ YN0000: â”‚ /webpack-dev-server/test/testSequencer.js:5:19: Undeclared dependency on @jest/test-sequencer
âž¤ YN0000: â”‚ /webpack-dev-server/client-src/default/webpack.config.js:12:14: Webpack configs from non-private packages should avoid referencing loaders without require.resolve
âž¤ YN0000: â”‚ /webpack-dev-server/test/server/contentBase-option.test.js:68:8: Strings should avoid referencing the node_modules directory (prefer require.resolve)
âž¤ YN0000: â”” Completed in 5.12s

âž¤ YN0000: Failed with errors in 5.12s</code></pre></div>
<p>In this case, the doctor noticed that:</p>
<ul>
<li><p><code class="language-text">testSequencer.js</code> depends on a package without listing it as a proper dependency - which would be reported as an error at runtime under Plug'n'Play.</p></li>
<li><p><code class="language-text">webpack.config.js</code> references a loader without passing its name to <code class="language-text">require.resolve</code> - which is unsafe, as it means the loader won't be loaded from <code class="language-text">webpack-dev-server</code>'s dependencies.</p></li>
<li><p><code class="language-text">contentBase-option.test.js</code> checks the content of the <code class="language-text">node_modules</code> folder - which wouldn't exist anymore under Plug'n'Play.</p></li>
</ul>
<h3 id="enabling-it">
Enabling it</h3>
<ol>
<li>Look into your <code class="language-text">.yarnrc.yml</code> file for the <a href="../configuration/yarnrc.html#nodeLinker"><code class="language-text">nodeLinker</code></a> setting</li>
<li>If you don't find it, or if it's set to <code class="language-text">pnp</code>, then it's all good: you're already using Plug'n'Play!</li>
<li>Otherwise, remove it from your configuration file</li>
<li>Run <code class="language-text">yarn install</code>
</li>
<li>Various files may have appeared; check <a href="qa.html#which-files-should-be-gitignored">this article</a> to see what to put in your gitignore</li>
<li>Commit the changes</li>
</ol>
<h3 id="editor-support">
Editor support</h3>
<p>We have a <a href="editor-sdks.html">dedicated documentation</a>, but if you're using VSCode (or some other IDE with Intellisense-like feature) the gist is:</p>
<ol>
<li>Install the <a href="https://marketplace.visualstudio.com/items?itemName=arcanis.vscode-zipfs">ZipFS</a> VSCode extension</li>
<li>Make sure that <code class="language-text">typescript</code>, <code class="language-text">eslint</code>, <code class="language-text">prettier</code>, ... all dependencies typically used by your IDE extensions are listed at the <em>top level</em> of the project (rather than in a random workspace)</li>
<li>Run <code class="language-text">yarn dlx @yarnpkg/sdks vscode</code>
</li>
<li>Commit the changes - this way contributors won't have to follow the same procedure</li>
<li>For TypeScript, don't forget to select <a href="https://code.visualstudio.com/docs/typescript/typescript-compiling#_using-the-workspace-version-of-typescript">Use Workspace Version</a> in VSCode</li>
</ol>
<h3 id="final-notes">
Final notes</h3>
<p>Now you should have a working Yarn Plug'n'Play setup, but your repository might still need some extra care. Some things to keep in mind:</p>
<ul>
<li>There is no <code class="language-text">node_modules</code> folder and no <code class="language-text">.bin</code> folder. If you relied on these, <a href="##call-binaries-using-yarn-run-rather-than-node_modulesbin">call <code class="language-text">yarn run</code> instead</a>.</li>
<li>Replace any calls to <code class="language-text">node</code> that are not inside a Yarn script with <code class="language-text">yarn node</code>
</li>
<li>Custom pre-hooks (e.g. prestart) need to be called manually now</li>
</ul>
<p>All of this and more is documented in the following sections. In general, we advise you at this point to try to run your application and see what breaks, then check here to find out tips on how to correct your install.</p>
<h2 id="general-advices">
General Advices</h2>
<h3 id="upgrade-to-nodejs-12x-or-newer">
Upgrade to Node.js 12.x or newer</h3>
<p>Node.js 10.x reached its official End of Life in April 2021 and won't receive any further update. Yarn consequently doesn't support it anymore.</p>
<h3 id="fix-dependencies-with-packageextensions">
Fix dependencies with <code class="language-text">packageExtensions</code>
</h3>
<p>Packages sometimes forget to list their dependencies. In the past it used to cause many subtle issues, so Yarn now defaults to prevent such unsound accesses. Still, we don't want it to prevent you from doing your work as long as you can do it in a safe and predictable way, so we came up with the <a href="../configuration/yarnrc.html#packageExtensions"><code class="language-text">packageExtensions</code></a> setting.</p>
<p>For example, if <code class="language-text">react</code> was to forget to list a dependency on <code class="language-text">prop-types</code>, you'd fix it like this:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">packageExtensions</span><span class="token punctuation">:</span>
  <span class="token key atrule">"react@*"</span><span class="token punctuation">:</span>
    <span class="token key atrule">dependencies</span><span class="token punctuation">:</span>
      <span class="token key atrule">prop-types</span><span class="token punctuation">:</span> <span class="token string">"*"</span></code></pre></div>
<p>And if a Babel plugin was missing its peer dependency on <code class="language-text">@babel/core</code>, you'd fix it with:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">packageExtensions</span><span class="token punctuation">:</span>
  <span class="token key atrule">"@babel/plugin-something@*"</span><span class="token punctuation">:</span>
    <span class="token key atrule">peerDependencies</span><span class="token punctuation">:</span>
      <span class="token key atrule">"@babel/core"</span><span class="token punctuation">:</span> <span class="token string">"*"</span></code></pre></div>
<h3 id="use-yarn-dlx-instead-of-yarn-global">
Use <code class="language-text">yarn dlx</code> instead of <code class="language-text">yarn global</code>
</h3>
<p><code class="language-text">yarn dlx</code> is designed to execute one off scripts that may have been installed as global packages with <code class="language-text">yarn 1.x</code>. Managing system-wide packages is outside of the scope of <code class="language-text">yarn</code>. To reflect this, <code class="language-text">yarn global</code> has been removed. <a href="https://github.com/yarnpkg/berry/issues/821">Read more on GitHub</a>.</p>
<h3 id="enable-the-pnp-plugin-when-using-webpack-4">
Enable the PnP plugin when using Webpack 4</h3>
<p>Webpack 5 supports PnP natively, but if you use Webpack 4 you'll need to add the <a href="https://github.com/arcanis/pnp-webpack-plugin"><code class="language-text">pnp-webpack-plugin</code></a> plugin yourself.</p>
<h3 id="upgrade-resolve-to-19">
Upgrade <code class="language-text">resolve</code> to 1.9+</h3>
<p>The <code class="language-text">resolve</code> package is used by many tools in order to retrieve the dependencies for any given folder on the filesystem. It's compatible with Plug'n'Play, but only starting from 1.9+, so make sure you don't have an older release in your dependency tree (especially as transitive dependency).</p>
<p><strong>Fix:</strong> Open your lockfile, look for all the <code class="language-text">resolve</code> entries that could match 1.9+ (for example <code class="language-text">^1.0.0</code>), and remove them. Then run <code class="language-text">yarn install</code> again. If you run <code class="language-text">yarn why resolve</code>, you'll also get a good idea of which package is depending on outdated version of <code class="language-text">resolve</code> - maybe you can upgrade them too?</p>
<h3 id="call-binaries-using-yarn-run-rather-than-node_modulesbin">
Call binaries using <code class="language-text">yarn run</code> rather than <code class="language-text">node_modules/.bin</code>
</h3>
<p>The <code class="language-text">node_modules/.bin</code> folder is an implementation detail, and the PnP installs don't generate it at all. Rather than relying on its existence, just use the <code class="language-text">yarn run</code> command which can start both scripts and binaries:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">yarn</span> run jest
<span class="token comment"># or, using the shortcut:</span>
<span class="token function">yarn</span> jest</code></pre></div>
<h3 id="call-your-scripts-through-yarn-node-rather-than-node">
Call your scripts through <code class="language-text">yarn node</code> rather than <code class="language-text">node</code>
</h3>
<p>We now need to inject some variables into the environment for Node to be able to locate your dependencies. In order to make this possible, we ask you to use <code class="language-text">yarn node</code> which transparently does the heavy lifting.</p>
<p><strong>Note:</strong> this section only applies to the <em>shell CLI</em>. The commands defined in your <code class="language-text">scripts</code> are unaffected, as we make sure that <code class="language-text">node</code> always points to the right location, with the right variables already set.</p>
<h3 id="explicitly-call-the-pre-and-post-scripts">
Explicitly call the <code class="language-text">pre</code> and <code class="language-text">post</code> scripts</h3>
<p>Rewrite:</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"prestart"</span><span class="token operator">:</span> <span class="token string">"do-something"</span><span class="token punctuation">,</span>
    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"http-server"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Into:</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"prestart"</span><span class="token operator">:</span> <span class="token string">"do-something"</span><span class="token punctuation">,</span>
    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"yarn prestart &amp;&amp; http-server"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p><strong>Note:</strong> This only applies to user scripts, such as <code class="language-text">start</code> &amp; friends. It's still fine to use any of <code class="language-text">preinstall</code>, <code class="language-text">install</code>, and <code class="language-text">postinstall</code>. Consult the <a href="../advanced/lifecycle-scripts.html">script documentation</a> for more information.</p>
<h3 id="setup-your-ide-for-pnp-support">
Setup your IDE for PnP support</h3>
<p>We've written a <a href="editor-sdks.html">guide</a> entirely designed to explain how to use Yarn with your IDE. Make sure to take a look at it, and maybe contribute to it if some instructions are unclear or missing!</p>
<h3 id="update-your-configuration-to-the-new-settings">
Update your configuration to the new settings</h3>
<p>Yarn 2 uses a different style of configuration files than Yarn 1. While mostly invisible for the lockfile (because we import them on the fly), it might cause some issues for your rc files.</p>
<ul>
<li><p>The main change is the name of the file. Yarn 1 used <code class="language-text">.yarnrc</code>, but Yarn 2 is moving to a different name: <code class="language-text">.yarnrc.yml</code>. This should make it easier for third-party tools to detect whether a project uses Yarn 1 or Yarn 2, and will allow you to easily set different settings in your home folders when working with a mix of Yarn 1 and Yarn 2 projects.</p></li>
<li><p>As evidenced by the new file extension, the Yarnrc files are now to be written in <a href="https://en.wikipedia.org/wiki/YAML">YAML</a>. This has been requested for a long time, and we hope it'll allow easier integrations for the various third-party tools that need to interact with the Yarnrc files (think Dependabot, etc).</p></li>
<li>
<p>The configuration keys have changed. The comprehensive settings list is available in our <a href="../configuration/yarnrc.html">documentation</a>, but here are some particular changes you need to be aware of:</p>
<ul>
<li><p>Custom registries are now configured via <a href="../configuration/yarnrc.html#npmRegistryServer"><code class="language-text">npmRegistryServer</code></a>.</p></li>
<li><p>Registry authentication tokens are now configured via <a href="../configuration/yarnrc.html#npmAuthToken"><code class="language-text">npmAuthToken</code></a>.</p></li>
<li><p>The <code class="language-text">yarn-offline-mirror</code> has been removed, since the offline mirror has been merged with the cache as part of the <a href="../features/zero-installs.html">Zero-Install effort</a>. Just commit the Yarn cache and you're ready to go.</p></li>
</ul>
</li>
</ul>
<h3 id="dont-use-npmrc-files">
Don't use <code class="language-text">.npmrc</code> files</h3>
<p>On top of their naming, the way we load the Yarnrc files has also been changed and simplified. In particular:</p>
<ul>
<li><p>Yarn doesn't use the configuration from your <code class="language-text">.npmrc</code> files anymore; we instead read all of our configuration from the <code class="language-text">.yarnrc.yml</code> files whose available settings can be found in <a href="../configuration/yarnrc.html">our documentation</a>.</p></li>
<li><p>As mentioned in the previous section, the yarnrc files are now called <code class="language-text">.yarnrc.yml</code>, with an extension. We've completely stopped reading the values from the regular <code class="language-text">.yarnrc</code> files.</p></li>
<li><p>All environment variables prefixed with <code class="language-text">YARN_</code> are automatically used to override the matching configuration settings. So for example, adding <code class="language-text">YARN_NPM_REGISTRY_SERVER</code> into your environment will change the value of <a href="../configuration/yarnrc.html#npmRegistryServer"><code class="language-text">npmRegistryServer</code></a>.</p></li>
</ul>
<h3 id="take-a-look-at-our-end-to-end-tests">
Take a look at our end-to-end tests</h3>
<p>We now run daily <a href="https://github.com/yarnpkg/berry#current-status">end-to-end tests</a> against various popular JavaScript tools in order to make sure that we never regress - or to be notified when those tools do.</p>
<p>Consulting the sources for those tests is a great way to check whether some special configuration values have to be set when using a particular toolchain.</p>
<h3 id="dont-use-bundledependencies">
Don't use <code class="language-text">bundleDependencies</code>
</h3>
<p>The <code class="language-text">bundleDependencies</code> (or <code class="language-text">bundledDependencies</code>) is an artifact of the past that used to let you define a set of packages that would be stored as-is within the package archive, <code class="language-text">node_modules</code> and all. This feature has many problems:</p>
<ul>
<li>It uses <code class="language-text">node_modules</code>, which doesn't easily allow different install strategies such as Plug'n'Play.</li>
<li>It encodes the hoisting inside the package, which is the exact opposite of what we aim for</li>
<li>It messes with the hoisting of other packages</li>
<li>Etc, etc, etc</li>
</ul>
<p>So how to replace them? There are different ways:</p>
<ul>
<li><p>If you need to patch a package, just fork it or reference it through <code class="language-text">file:</code> (it's perfectly fine even for transitive dependencies to use this protocol). The <code class="language-text">portal:</code> and <code class="language-text">patch:</code> protocols are also options, although they'll only work for Yarn consumers.</p></li>
<li><p>If you need to ship a package to your customers as a standalone (no dependencies), bundle it yourself using Webpack, Rollup, or similar tools.</p></li>
</ul>
<h3 id="if-required-enable-the-node-modules-plugin">
If required: enable the <code class="language-text">node-modules</code> plugin</h3>
<p><strong><a href="../features/pnp.html#compatibility-table">PnP Compatibility Table</a></strong></p>
<p>Despite our best efforts some tools don't work at all under Plug'n'Play environments, and we don't have the resources to update them ourselves. There are only two notorious ones on our list: Flow, and React Native.</p>
<p>In such a radical case, you can enable the built-in <a href="https://github.com/yarnpkg/berry/tree/master/packages/plugin-nm"><code class="language-text">node-modules</code> plugin</a> by adding the following into your local <a href="../configuration/yarnrc.html"><code class="language-text">.yarnrc.yml</code></a> file before running a fresh <code class="language-text">yarn install</code>:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">nodeLinker</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>modules</code></pre></div>
<p>This will cause Yarn to install the project just like Yarn 1 used to, by copying the packages into various <code class="language-text">node_modules</code> folders.</p>
<p><a href="../configuration/yarnrc.html#nodeLinker">More information about the <code class="language-text">nodeLinker</code> option.</a></p>
<h3 id="replace-nohoist-by-nmhoistinglimits">
Replace <code class="language-text">nohoist</code> by <code class="language-text">nmHoistingLimits</code>
</h3>
<p>The <code class="language-text">nohoist</code> setting from Yarn 1 was made specifically for React Native (in order to help it support workspaces), but the way it worked (through glob patterns) was causing a lot of bugs and confusion, noone being really sure which patterns needed to be set. As a result, we've simplified this feature in order to only support three identified patterns.</p>
<p>If you were using <code class="language-text">nohoist</code>, we recommend you remove it from your manifest configuration and instead set <a href="../configuration/yarnrc.html#nmHoistingLimits"><code class="language-text">nmHoistingLimits</code></a> in your yarnrc file:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">nmHoistingLimits</span><span class="token punctuation">:</span> workspaces</code></pre></div>
<h2 id="cli-commands">
CLI Commands</h2>
<h3 id="renamed">
Renamed</h3>
<table>
<thead><tr>
<th><div>Yarn Classic (1.x)</div></th>
<th><div>Yarn (2.x)</div></th>
<th>Notes</th>
</tr></thead>
<tbody>
<tr>
<td><code class="language-text">yarn audit</code></td>
<td><code class="language-text">yarn npm audit</code></td>
<td></td>
</tr>
<tr>
<td><code class="language-text">yarn create</code></td>
<td><code class="language-text">yarn dlx create-&lt;name&gt;</code></td>
<td>
<code class="language-text">yarn create</code> still works, but prefer using <code class="language-text">yarn dlx</code>
</td>
</tr>
<tr>
<td><code class="language-text">yarn global</code></td>
<td><code class="language-text">yarn dlx</code></td>
<td><a href="#use-yarn-dlx-instead-of-yarn-global">Dedicated section</a></td>
</tr>
<tr>
<td><code class="language-text">yarn info</code></td>
<td><code class="language-text">yarn npm info</code></td>
<td></td>
</tr>
<tr>
<td><code class="language-text">yarn login</code></td>
<td><code class="language-text">yarn npm login</code></td>
<td></td>
</tr>
<tr>
<td><code class="language-text">yarn logout</code></td>
<td><code class="language-text">yarn npm logout</code></td>
<td></td>
</tr>
<tr>
<td><code class="language-text">yarn outdated</code></td>
<td><code class="language-text">yarn upgrade-interactive</code></td>
<td><a href="https://github.com/yarnpkg/berry/issues/749">Read more on GitHub</a></td>
</tr>
<tr>
<td><code class="language-text">yarn publish</code></td>
<td><code class="language-text">yarn npm publish</code></td>
<td></td>
</tr>
<tr>
<td><code class="language-text">yarn tag</code></td>
<td><code class="language-text">yarn npm tag</code></td>
<td></td>
</tr>
<tr>
<td><code class="language-text">yarn upgrade</code></td>
<td><code class="language-text">yarn up</code></td>
<td>Will now upgrade packages across all workspaces</td>
</tr>
<tr>
<td><code class="language-text">yarn install --production</code></td>
<td><code class="language-text">yarn workspaces focus --all --production</code></td>
<td>Requires the <code class="language-text">workspace-tools</code> plugin</td>
</tr>
<tr>
<td><code class="language-text">yarn install --verbose</code></td>
<td><code class="language-text">YARN_ENABLE_INLINE_BUILDS=true yarn install</code></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="removed-from-core">
Removed from core</h3>
<table>
<thead><tr>
<th><div>Yarn Classic (1.x)</div></th>
<th>Notes</th>
</tr></thead>
<tbody>
<tr>
<td><code class="language-text">yarn check</code></td>
<td>Cache integrity is now checked on regular installs; <a href="https://github.com/yarnpkg/rfcs/pull/106">read more on GitHub</a>
</td>
</tr>
<tr>
<td><code class="language-text">yarn import</code></td>
<td>First import to Classic, then migrate to 2.x</td>
</tr>
<tr>
<td><code class="language-text">yarn licenses</code></td>
<td>Perfect use case for plugins; <a href="https://github.com/yarnpkg/berry/issues/1164">read more on GitHub</a>
</td>
</tr>
<tr>
<td><code class="language-text">yarn versions</code></td>
<td>Use <code class="language-text">yarn --version</code> and <code class="language-text">node -p process.versions</code>
</td>
</tr>
</tbody>
</table>
<h3 id="not-implemented-yet">
Not implemented yet</h3>
<p>Those features simply haven't been implemented yet. Help welcome!</p>
<table>
<thead><tr>
<th><div>Yarn Classic (1.x)</div></th>
<th>Notes</th>
</tr></thead>
<tbody>
<tr>
<td><code class="language-text">yarn list</code></td>
<td>
<code class="language-text">yarn why</code> may provide some information in the meantime</td>
</tr>
<tr>
<td><code class="language-text">yarn owner</code></td>
<td>Will eventually be available as <code class="language-text">yarn npm owner</code>
</td>
</tr>
<tr>
<td><code class="language-text">yarn team</code></td>
<td>Will eventually be available as <code class="language-text">yarn npm team</code>
</td>
</tr>
</tbody>
</table>
<h2 id="troubleshooting">
Troubleshooting</h2>
<h3 id="cannot-find-module-">
<code class="language-text">Cannot find module [...]</code>
</h3>
<p>Interestingly, this error often <strong>doesn't</strong> come from Yarn. In fact, seeing this message should be extremely rare when working with Yarn 2 projects and typically highlights that something is wrong in your setup.</p>
<p>This error appears when Node is executed without the proper environment variables. In such a case, the underlying application won't be able to access the dependencies and Node will throw this message. To fix that, make sure that the script is called through <code class="language-text">yarn node [...]</code> (instead of <code class="language-text">node [...]</code>) if you run it from the command line.</p>
<h3 id="a-package-is-trying-to-access-another-package-">
<code class="language-text">A package is trying to access another package [...]</code>
</h3>
<blockquote><p><strong>Full message:</strong> A package is trying to access another package without the second one being listed as a dependency of the first one.</p></blockquote>
<p>Some packages don't properly list their actual dependencies for a reason or another. Now that we've fully switched to Plug'n'Play and enforce boundaries between the various branches of the dependency tree, this kind of issue will start to become more apparent than it previously was.</p>
<p>The long term fix is to submit a pull request upstream to add the missing dependency to the package listing. Given that it sometimes might take some time before they get merged, we also have a more short-term fix available: create <code class="language-text">.yarnrc.yml</code> in your project, then use the <a href="../configuration/yarnrc.html#packageExtensions"><code class="language-text">packageExtensions</code> setting</a> to add the missing dependency to the relevant packages. Once you're done, run <code class="language-text">yarn install</code> to apply your changes and voilÃ !</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">packageExtensions</span><span class="token punctuation">:</span>
  <span class="token key atrule">"debug@*"</span><span class="token punctuation">:</span>
    <span class="token key atrule">peerDependenciesMeta</span><span class="token punctuation">:</span>
      <span class="token key atrule">"supports-color"</span><span class="token punctuation">:</span>
        <span class="token key atrule">optional</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code></pre></div>
<p>If you also open a PR on the upstream repository you will also be able to contribute your package extension to our <a href="https://github.com/yarnpkg/berry/blob/master/packages/plugin-compat/sources/extensions.ts">compat plugin</a>, helping the whole ecosystem move forward.</p>
</div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2016&ndash;present Yarn Contributors<br>Licensed under the BSD License.<br>
    <a href="https://yarnpkg.com/getting-started/migration" class="_attribution-link">https://yarnpkg.com/getting-started/migration</a>
  </p>
</div>
