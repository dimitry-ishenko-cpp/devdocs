<h1>Lifecycle Scripts</h1>

<div class="css-elchao exirf770">
<p>Packages can define in the <code class="language-text">scripts</code> field of their manifest various actions that should be executed when the package manager executes a particular workflow. Here they are:</p>
<blockquote><p><strong>Note about <code class="language-text">yarn pack</code>:</strong> Although rarely called directly, <code class="language-text">yarn pack</code> is a crucial part of Yarn. Each time Yarn has to fetch a dependency from a "raw" source (such as a Git repository), it will automatically run <code class="language-text">yarn install</code> and <code class="language-text">yarn pack</code> on it to know which are the files to use.</p></blockquote>
<ul>
<li><p><strong>prepack</strong> is the lifecycle script called before each call to <code class="language-text">yarn pack</code>. This is typically the place where you'll want to put scripts that build a package - such as transpiling its source.</p></li>
<li><p><strong>postpack</strong> is called right after <code class="language-text">yarn pack</code>, whether the call succeeded or not. This is typically the place where you'll clean your working directory from the build artifacts (note that whether to actually clean them or not is purely optional).</p></li>
<li><p><strong>prepublish</strong> is called before <code class="language-text">yarn npm publish</code> and similar commands (even before the package has been packed). This is the place where you'll want to check that the project is in an ok state. Because it's only called on prepublish, <strong>the prepublish hook shouldn't have side effects.</strong> In particular don't transpile the package sources in prepublish, as people consuming directly your repository (such as through the <a href="../features/protocols.html#git"><code class="language-text">git:</code> protocol</a>) wouldn't be able to use your project.</p></li>
<li><p><strong>postinstall</strong> is called after a package's dependency tree changes are written to the disk -- e.g. after a dependency or transitive dependency is added, removed, or changed. It is guaranteed to be called in topological order (in other words, your dependencies' postinstalls will always run before yours). For backwards compatibility, <strong>preinstall</strong> and <strong>install</strong> are called as part of <strong>postinstall</strong>.</p></li>
</ul>
<p>Note that we don't support every single lifecycle script originally present in npm. This is a deliberate decision based on the observation that too many lifecycle scripts make it difficult to know which one to use in which circumstances, leading to confusion and mistakes. We are open to add the missing ones on a case-by-case basis if compelling use cases are provided.</p>
<blockquote><p>In particular, we intentionally don't support arbitrary <code class="language-text">pre</code> and <code class="language-text">post</code> hooks for user-defined scripts (such as <code class="language-text">prestart</code>). This behavior, inherited from npm, caused scripts to be implicit rather than explicit, obfuscating the execution flow. It also led to surprising executions with <code class="language-text">yarn serve</code> also running <code class="language-text">yarn preserve</code>.</p></blockquote>
<h2 id="a-note-about-postinstall">
A note about <code class="language-text">postinstall</code>
</h2>
<p>Postinstall scripts have very real consequences for your users. In most cases Yarn will keep the installed packages in its cache under their archive form, and will instruct Node to load the files directly from there. This leads to much smaller installs, and eventually to <a href="../features/zero-installs.html">Zero-Installs</a>.</p>
<p>Unfortunately postinstall scripts break this model because they signal Yarn that those packages may need to mutate their own directory, forcing them to be extracted into physical locations on the disk and leading to heavier, slower, and less stable installs.</p>
<p>Depending on your use case, here's how you can avoid postinstall scripts:</p>
<ul>
<li><p>Native packages can be built to <a href="https://webassembly.org">WebAssembly</a>, which is already supported in Node 12 and beyond. On top of being portable and fast, WebAssembly packages also have the benefit to make your libraries available not only to Node but also to your browser users. And since their compilation is made upfront, your users won't be impacted by slow compilation time problems.</p></li>
<li><p>Project sustainability is a big topic, but the gist is that we don't think postinstall scripts are a viable solution. We however are committed to providing a specific field in the package.json that would signal to the package managers that a project would like to communicate its existence with the user in an integrated and respectful way.</p></li>
</ul>
<h2 id="environment-variables">
Environment variables</h2>
<p>When running scripts and binaries, some environment variables are usually made available:</p>
<ul>
<li><p><code class="language-text">$INIT_CWD</code> represents the directory from which the script has been invoked. This isn't the same as the cwd, which for scripts is always equal to the closest package root.</p></li>
<li><p><code class="language-text">$PROJECT_CWD</code> is the root of the project on the filesystem.</p></li>
<li><p><code class="language-text">$npm_package_name</code> is the name of the package that lists the script being executed.</p></li>
<li><p><code class="language-text">$npm_package_version</code> is its version.</p></li>
<li><p><code class="language-text">$npm_execpath</code> is the path to the Yarn binary.</p></li>
<li><p><code class="language-text">$npm_node_execpath</code> is the path to the Node binary.</p></li>
<li><p><code class="language-text">$npm_config_user_agent</code> is a string defining the Yarn version currently in use.</p></li>
<li><p><code class="language-text">$npm_lifecycle_event</code> is the name of the script or lifecycle event, if relevant.</p></li>
</ul>
</div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2016&ndash;present Yarn Contributors<br>Licensed under the BSD License.<br>
    <a href="https://yarnpkg.com/advanced/lifecycle-scripts" class="_attribution-link">https://yarnpkg.com/advanced/lifecycle-scripts</a>
  </p>
</div>
