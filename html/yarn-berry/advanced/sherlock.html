<h1>Sherlock</h1>

<div class="css-elchao exirf770">
<p>In order to simplify our work maintaining Yarn, we ask you to help us by providing reproductions for the bugs you encounter. We can't stress this enough: under normal circumstances, <strong>no reproduction will mean no help</strong> and your issue may be closed for this reason.</p>
<p>To help you help us, we use a tool called <a href="https://github.com/arcanis/sherlock">Sherlock</a> which allows you to attach reproduction testcases to your issues. In a sense, it's a bit like if you were writing a Jest test directly in your issue. By using this system we can quickly check whether a problem can be reproduced, and whether our fix is the right one. It's a win-win for everyone!</p>
<div class="toc"><ul>
<li><p><a href="#adding-a-reproduction-to-your-issue">Adding a reproduction to your issue</a></p></li>
<li>
<p><a href="#developing-your-reproduction">Developing your reproduction</a></p>
<ul>
<li><a href="#features">Features</a></li>
<li><a href="#limitations">Limitations</a></li>
</ul>
</li>
<li><p><a href="#available-functions">Available functions</a></p></li>
<li><p><a href="#examples">Examples</a></p></li>
<li>
<p><a href="#qa">Q&amp;A</a></p>
<ul>
<li><a href="#can-i-develop-my-reproduction-offline">Can I develop my reproduction offline?</a></li>
<li><a href="#the-sherlock-bot-doesnt-label-my-message">The Sherlock bot doesn't label my message</a></li>
<li><a href="#the-sherlock-bot-is-labelling-my-issue-with-broken-repro">The Sherlock bot is labelling my issue with <code class="language-text">broken-repro</code></a></li>
<li><a href="#how-can-i-run-the-bot-again">How can I run the bot again?</a></li>
<li><a href="#thats-really-cool-can-i-do-the-same-on-my-own-project">That's really cool, can I do the same on my own project?</a></li>
</ul>
</li>
</ul></div>
<h2 id="adding-a-reproduction-to-your-issue">
Adding a reproduction to your issue</h2>
<p>Adding a reproduction is as simple as adding a markdown codefence to your issue:</p>
<div class="gatsby-highlight" data-language="markdown"><pre class="language-markdown"><code class="language-markdown">This is my reproduction case:

<span class="token code"><span class="token punctuation">```</span><span class="token code-language">js repro</span>
<span class="token code-block language-js"><span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token operator">...</span><span class="token punctuation">;</span></span>
<span class="token punctuation">```</span></span></code></pre></div>
<blockquote><p><strong>Important:</strong> Note that the codefence is not only tagged <code class="language-text">js</code>, but also <code class="language-text">repro</code>. This is critical, as we don't want to execute every single snippet!</p></blockquote>
<h2 id="developing-your-reproduction">
Developing your reproduction</h2>
<p>The easiest and most convenient way to develop your reproduction is by using the <a href="../playground.html">Playground</a> (powered by <a href="https://codesandbox.io/">CodeSandbox</a>).</p>
<blockquote><p>Note: We <strong><em>strongly</em></strong> encourage you to use the Playground. It saves both you and us important time. Also, in the future, we <em>might</em> autoclose issues without a reproduction after a period of time, unless a contributor manually labels them as <code class="language-text">reproducible</code>, so be prepared!</p></blockquote>
<h3 id="features">
Features</h3>
<ul>
<li>A <a href="https://microsoft.github.io/monaco-editor/">Monaco Editor</a> (the editor that powers VSCode) where you can write your reproduction.</li>
<li>A Terminal-like output where you can see the assertion or the error / playground tips if you haven't run anything yet.</li>
<li>A Menu for selecting reproduction templates. Note: Your last input is saved inside <code class="language-text">localStorage</code> for future use.</li>
<li>The status of the playground (more information on hover).</li>
<li>An <code class="language-text">Export</code> button that can be used to share the link of the playground and even copy/open an issue in our repo with the issue template filled with your reproduction (status has to be <code class="language-text">reproducible</code>). You can also open the reproduction in CodeSandbox.</li>
<li>Shareable Playground URLs - You can export them by using the <code class="language-text">Export</code> button and the code will be automatically imported inside the Playground when you access it through them.</li>
</ul>
<h3 id="limitations">
Limitations</h3>
<ul>
<li>Reproductions are run inside a CodeSandbox container, so they're always running inside a Linux environment, with the Node version that CodeSandbox uses. This limitation also exists when running the reproduction with Sherlock inside an issue, so if you need to use a specific OS / Node version, you <strong>have to</strong> <a href="#can-i-develop-my-reproduction-offline">develop your reproduction offline</a>.</li>
<li>Don't use very large packages unless you absolutely have to - the sandbox won't like it.</li>
<li>The sandbox may go to sleep after some time. If that happens, reload the page to reboot it.</li>
</ul>
<h2 id="available-functions">
Available functions</h2>
<p>You can use all of Javascript inside the repro code, including <code class="language-text">async/await</code>. In fact, you can even use top-level <code class="language-text">await</code>! As far as the runtime goes you should have access to all of Node's APIs, plus some extras:</p>
<ul>
<li>
<p>In order to simplify some tasks that would be very menial otherwise (like spawning the Yarn process, or running a Node script in the generated environment), we provide a set of builtin functions that abstract these semantics. You can find the full reference inside <a href="https://github.com/yarnpkg/berry/tree/master/scripts/actions/sherlock-prepare.js">our repository</a>, along with some documentation.</p>
<p><strong>Note:</strong> All core plugins are enabled by default, you don't need to run yarn import on them again.</p>
</li>
<li><p>The <a href="https://jestjs.io/docs/en/expect">expect</a> API is available globally and <em>must</em> be used to describe the assertions in your test (simply throwing will cause Sherlock to mark your reproduction case as broken).</p></li>
</ul>
<h2 id="examples">
Examples</h2>
<p>In <a href="https://github.com/yarnpkg/berry/issues/478">#478</a>, Yarn used to print an incorrect help message.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> output <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">yarn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">add</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">--help</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">expect</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toContain</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">yarn yarn</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>In <a href="https://github.com/yarnpkg/berry/issues/448">#448</a>, running <code class="language-text">pnpify --sdk</code> used to fail when ESLint was missing.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">await</span> <span class="token function">packageJsonAndInstall</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  devDependencies<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@yarnpkg/pnpify</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^2.0.0-rc.3</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">typescript</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^3.6.3</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">yarn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">pnpify</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">--sdk</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rejects<span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toThrow</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Command failed</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>In <a href="https://github.com/yarnpkg/berry/issues/361">#361</a>, running <code class="language-text">yarn add dep</code> when <code class="language-text">dep</code> was already a devDependency used to duplicate it in both fields:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span>promises<span class="token operator">:</span> <span class="token punctuation">{</span>readFile<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">fs</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> <span class="token function">packageJsonAndInstall</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  devDependencies<span class="token operator">:</span> <span class="token punctuation">{</span>lodash<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">*</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> <span class="token function">yarn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">add</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">lodash</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pkgJson <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">package.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">utf8</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>pkgJson<span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toHaveProperty</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">lodash</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>For more examples, consult the list of issues that have been tagged as having valid reproductions:</p>
<p><a href="https://github.com/yarnpkg/berry/issues?q=is%3Aissue+label%3Areproducible+is%3Aclosed">https://github.com/yarnpkg/berry/issues?q=is%3Aissue+label%3Areproducible+is%3Aclosed</a></p>
<h2 id="qa">
Q&amp;A</h2>
<h3 id="can-i-develop-my-reproduction-offline">
Can I develop my reproduction offline?</h3>
<p>If you can't use the Playground, you can build a reproduction offline and only share it once it's ready:</p>
<ol>
<li>Clone our <a href="https://github.com/yarnpkg/berry">repository</a>
</li>
<li>Go into it, and write your issue in a markdown file (as if you were on GitHub)</li>
<li>Once ready, run <code class="language-text">yarn sherlock &lt;my-file.md&gt;</code> to make Sherlock run your reproduction locally</li>
</ol>
<p>Note that you must write the issue itself, not only the reproduction, so don't forget to add the codefence etc. Once you are done, copy-paste the result on GitHub and the bot will promptly review your code and approve it.</p>
<h3 id="the-sherlock-bot-doesnt-label-my-message">
The Sherlock bot doesn't label my message</h3>
<p>It likely means that it didn't see your issue as containing a reproduction case. Make sure you properly added the <code class="language-text">repro</code> tag to your codefence:</p>
<div class="gatsby-highlight" data-language="markdown"><pre class="language-markdown"><code class="language-markdown">This is my reproduction case:

<span class="token code"><span class="token punctuation">```</span><span class="token code-language">js repro</span>
<span class="token code-block language-js"><span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token operator">...</span><span class="token punctuation">;</span></span>
<span class="token punctuation">```</span></span></code></pre></div>
<h3 id="the-sherlock-bot-is-labelling-my-issue-with-broken-repro">
The Sherlock bot is labelling my issue with <code class="language-text">broken-repro</code>
</h3>
<p>This means that your code is throwing an exception on our systems which doesn't seem to be part of the expected testsuite. Note that only exceptions thrown by the <a href="https://jestjs.io/docs/en/expect">expect</a> API will lead to your reproduction being correctly labelled.</p>
<p>If you wish to test that something is failing (for example to test that <code class="language-text">yarn install --immutable</code> doesn't work when the lockfile isn't up-to-date, or something like this) you can use the following pattern:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">await</span> <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rejects<span class="token punctuation">.</span><span class="token function">toThrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h3 id="how-can-i-run-the-bot-again">
How can I run the bot again?</h3>
<p>Editing the issue content will cause the bot to run again. If you're a maintainer, you can also remove the reproduction label from the issue and Sherlock will happilly execute it again.</p>
<h3 id="thats-really-cool-can-i-do-the-same-on-my-own-project">
That's really cool, can I do the same on my own project?</h3>
<p>Sherlock is an open-source project that we develop on <a href="https://github.com/arcanis/sherlock">this repository</a>. Try and let us know how it worked out for you!</p>
</div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2016&ndash;present Yarn Contributors<br>Licensed under the BSD License.<br>
    <a href="https://yarnpkg.com/advanced/sherlock" class="_attribution-link">https://yarnpkg.com/advanced/sherlock</a>
  </p>
</div>
