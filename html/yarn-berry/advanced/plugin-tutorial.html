<h1>Plugin Tutorial</h1>

<div class="css-elchao exirf770">
<p>Starting from the Yarn 2, Yarn now supports plugins. For more information about what they are and in which case you'd want to use them, consult the <a href="../features/plugins.html">dedicated page</a>. We'll talk here about the exact steps needed to write one. It's quite simple, really!</p>
<div class="toc"><ul>
<li><a href="#what-does-a-plugin-look-like">What does a plugin look like?</a></li>
<li><a href="#writing-our-first-plugin">Writing our first plugin</a></li>
<li><a href="#all-in-one-plugin-builder">All-in-one plugin builder</a></li>
<li><a href="#adding-commands">Adding commands</a></li>
<li><a href="#using-hooks">Using hooks</a></li>
<li><a href="#using-a-the-yarn-api">Using a the Yarn API</a></li>
<li><a href="#official-hooks">Official hooks</a></li>
</ul></div>
<h2 id="what-does-a-plugin-look-like">
What does a plugin look like?</h2>
<p>Plugins are scripts that get loaded at runtime by Yarn, and that can inject new behaviors into it. They also can require some packages provided by Yarn itself, such as <code class="language-text">@yarnpkg/core</code>. This allows you to use the exact same core API as the Yarn binary currently in use, kinda like if it was a peer dependency!</p>
<blockquote><p><strong>Important:</strong> Since plugins are loaded before Yarn starts (and thus before you make your first install), it's strongly advised to write your plugins in such a way that they work without dependencies. If that becomes difficult, know that we provide a powerful tool (<a href="#all-in-one-plugin-builder"><code class="language-text">@yarnpkg/builder</code></a> that can bundle your plugins into a single Javascript file, ready to be published.</p></blockquote>
<h2 id="writing-our-first-plugin">
Writing our first plugin</h2>
<p>Open in a text editor a new file called <code class="language-text">plugin-hello-world.js</code>, and type the following code:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">plugin-hello-world</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token function-variable function">factory</span><span class="token operator">:</span> <span class="token parameter">require</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// What is this `require` function, you ask? It's a `require`</span>
    <span class="token comment">// implementation provided by Yarn core that allows you to</span>
    <span class="token comment">// access various packages (such as @yarnpkg/core) without</span>
    <span class="token comment">// having to list them in your own dependencies - hence</span>
    <span class="token comment">// lowering your plugin bundle size, and making sure that</span>
    <span class="token comment">// you'll use the exact same core modules as the rest of the</span>
    <span class="token comment">// application.</span>
    <span class="token comment">//</span>
    <span class="token comment">// Of course, the regular `require` implementation remains</span>
    <span class="token comment">// available, so feel free to use the `require` you need for</span>
    <span class="token comment">// your use case!</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>We have our plugin, but now we need to register it so that Yarn knows where to find it. To do this, we'll just add an entry within the <code class="language-text">.yarnrc.yml</code> file at the root of the repository:</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">plugins</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ./plugin<span class="token punctuation">-</span>hello<span class="token punctuation">-</span>world.js</code></pre></div>
<p>That's it! You have your first plugin, congratulations! Of course it doesn't do much (or anything at all, really), but we'll see how to extend it to make it more powerful.</p>
<h2 id="all-in-one-plugin-builder">
All-in-one plugin builder</h2>
<p>As we saw, plugins are meant to be standalone JavaScript source files. It's very possible to author them by hand, especially if you only need a small one, but once you start adding multiple commands it can become a bit more complicated. To make this process easier, we maintain a package called <code class="language-text">@yarnpkg/builder</code>. This builder is to Yarn what Next.js is to web development - it's a tool designed to help creating, building, and managing complex plugins written in TypeScript.</p>
<p>Its documentation can be found on the <a href="https://github.com/yarnpkg/berry/blob/master/packages/yarnpkg-builder/README.md">dedicated page</a>, but remember that you're not required to use it. Sometimes good old scripts are just fine!</p>
<h2 id="adding-commands">
Adding commands</h2>
<p>Plugins can also register their own commands. To do this, we just have to write them using the <a href="https://github.com/arcanis/clipanion"><code class="language-text">clipanion</code></a> library - and we don't even have to add it to our dependencies! Let's see an example:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">plugin-hello-world</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token function-variable function">factory</span><span class="token operator">:</span> <span class="token parameter">require</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>BaseCommand<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@yarnpkg/cli</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">HelloWorldCommand</span> <span class="token keyword">extends</span> <span class="token class-name">BaseCommand</span> <span class="token punctuation">{</span>
      <span class="token keyword">static</span> paths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token keyword">async</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">This is my very own plugin ðŸ˜Ž\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      commands<span class="token operator">:</span> <span class="token punctuation">[</span>
        HelloWorldCommand<span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>Now, try to run <code class="language-text">yarn hello</code>. You'll see your message appear! Note that you can use the full set of features provided by clipanion, including short options, long options, variadic argument lists, ... You can even validate your options using the <a href="https://github.com/arcanis/typanion"><code class="language-text">typanion</code></a> library, which we provide. Here's an example where we only accept numbers as parameter:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">plugin-addition</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token function-variable function">factory</span><span class="token operator">:</span> <span class="token parameter">require</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>BaseCommand<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@yarnpkg/cli</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>Option<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">clipanion</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">typanion</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">AdditionCommand</span> <span class="token keyword">extends</span> <span class="token class-name">BaseCommand</span> <span class="token punctuation">{</span>
      <span class="token keyword">static</span> paths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">addition</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">// Show descriptive usage for a --help argument passed to this command</span>
      <span class="token keyword">static</span> usage <span class="token operator">=</span> Command<span class="token punctuation">.</span><span class="token function">Usage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        description<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello world!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        details<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
          This command will print a nice message.
        </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        examples<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Add two numbers together</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">yarn addition 42 10</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      a <span class="token operator">=</span> Option<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">{</span>validator<span class="token operator">:</span> t<span class="token punctuation">.</span><span class="token function">isNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      b <span class="token operator">=</span> Option<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">{</span>validator<span class="token operator">:</span> t<span class="token punctuation">.</span><span class="token function">isNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">async</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">+</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>b<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>b<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      commands<span class="token operator">:</span> <span class="token punctuation">[</span>
        AdditionCommand<span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<h2 id="using-hooks">
Using hooks</h2>
<p>Plugins can register to various events in the Yarn lifetime, and provide them additional information to alter their behavior. To do this, you just need to declare a new <code class="language-text">hooks</code> property in your plugin and add members for each hook you want to listen to:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">plugin-hello-world</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token function-variable function">factory</span><span class="token operator">:</span> <span class="token parameter">require</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    hooks<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">setupScriptEnvironment</span><span class="token punctuation">(</span><span class="token parameter">project<span class="token punctuation">,</span> scriptEnv</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        scriptEnv<span class="token punctuation">.</span><span class="token constant">HELLO_WORLD</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">my first plugin!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>In this example, we registered to the <code class="language-text">setupScriptEnvironment</code> hook and used it to inject an argument into the environment. Now, each time you'll run a script, you'll see that your env will contain a new value called <code class="language-text">HELLO_WORLD</code>!</p>
<p>Hooks are numerous, and we're still working on them. Some might be added, removed, or changed, based on your feedback. So if you'd like to do something hooks don't allow you to do yet, come tell us!</p>
<blockquote><p><strong>Note:</strong> We don't yet have a list of hooks. If you're interested to improve this documentation by generating the hook list from our source code, please contact us on our Discord server!</p></blockquote>
<h2 id="using-a-the-yarn-api">
Using a the Yarn API</h2>
<p>Most Yarn's hooks are called with various arguments that tell you more about the context under which the hook is being called. The exact argument list is different for each hook, but in general they are of the types defined in the <a href="https://yarnpkg.com/api"><code class="language-text">@yarnpkg/core</code> library</a>.</p>
<p>In this example, we will integrate with the <code class="language-text">afterAllInstalled</code> hook in order to print some basic information about the dependency tree after each install. This hook gets invoked with an additional parameter that is the public <a href="https://yarnpkg.com/api/classes/yarnpkg_core.project.html"><code class="language-text">Project</code></a> instance where lie most of the information Yarn has collected about the project: dependencies, package manifests, workspace information, and so on.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">fs</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">util</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">plugin-project-info</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token function-variable function">factory</span><span class="token operator">:</span> <span class="token parameter">require</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>structUtils<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@yarnpkg/core</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        hooks<span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token function">afterAllInstalled</span><span class="token punctuation">(</span><span class="token parameter">project</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> descriptorCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> descriptor <span class="token keyword">of</span> project<span class="token punctuation">.</span>storedDescriptors<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>structUtils<span class="token punctuation">.</span><span class="token function">isVirtualDescriptor</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">)</span>
                descriptorCount <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>

            <span class="token keyword">let</span> packageCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> pkg <span class="token keyword">of</span> project<span class="token punctuation">.</span>storedPackages<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>structUtils<span class="token punctuation">.</span><span class="token function">isVirtualLocator</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span><span class="token punctuation">)</span>
                packageCount <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>

            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">This project contains </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>descriptorCount<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> different descriptors that resolve to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageCount<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> packages</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>This is getting interesting. As you can see, we accessed the <a href="https://yarnpkg.com/api/classes/yarnpkg_core.project.html#storeddescriptors"><code class="language-text">storedDescriptors</code></a> and <a href="https://yarnpkg.com/api/classes/yarnpkg_core.project.html#storedpackages"><code class="language-text">storedPackages</code></a> fields from our project instance, and iterated over them to obtain the number of non-virtual items (virtual packages are described in more details <a href="lexicon.html#virtual-package">here</a>). This is a very simple use case, but we could have done many more things: the project root is located in the <a href="https://yarnpkg.com/api/classes/yarnpkg_core.project.html#cwd"><code class="language-text">cwd</code></a> property, the workspaces are exposed as <a href="https://yarnpkg.com/api/classes/yarnpkg_core.project.html#workspaces"><code class="language-text">workspaces</code></a>, the link between descriptors and packages can be made via <a href="https://yarnpkg.com/api/classes/yarnpkg_core.project.html#storedresolutions"><code class="language-text">storedResolutions</code></a>, ... etc.</p>
<p>Note that we've only scratched the surface of the <code class="language-text">Project</code> class instance! The Yarn core provides many other classes (and hooks) that allow you to work with the cache, download packages, trigger http requests, ... and much more, as listed in the <a href="https://yarnpkg.com/api/">API documentation</a>. Next time you want to write a plugin, give it a look, there's almost certainly an utility there that will allow you to avoid having to reimplement the wheel.</p>
<h2 id="official-hooks">
Official hooks</h2>
<div>
<h3 id="hook-afterAllInstalled">
<code>afterAllInstalled</code>
</h3>
<div>
<p>Called after the <code>install</code> method from the <code>Project</code> class successfully completed.</p> </div>
<pre><code>afterAllInstalled?: (
  project: Project,
  options: InstallOptions
) =&gt; void;</code></pre>
</div>
<div>
<h3 id="hook-afterWorkspaceDependencyAddition">
<code>afterWorkspaceDependencyAddition</code>
</h3>
<div>
<p>Called when a new dependency is added to a workspace. Note that this hook is only called by the CLI commands like <code>yarn add</code> - manually adding the dependencies into the manifest and running <code>yarn install</code> won't trigger it.</p> </div>
<pre><code>afterWorkspaceDependencyAddition?: (
  workspace: Workspace,
  target: suggestUtils.Target,
  descriptor: Descriptor,
  strategies: Array&lt;suggestUtils.Strategy&gt;
) =&gt; Promise&lt;void&gt;;</code></pre>
</div>
<div>
<h3 id="hook-afterWorkspaceDependencyRemoval">
<code>afterWorkspaceDependencyRemoval</code>
</h3>
<div>
<p>Called when a dependency range is removed from a workspace. Note that this hook is only called by the CLI commands like <code>yarn remove</code> - manually removing the dependencies from the manifest and running <code>yarn install</code> won't trigger it.</p> </div>
<pre><code>afterWorkspaceDependencyRemoval?: (
  workspace: Workspace,
  target: suggestUtils.Target,
  descriptor: Descriptor,
) =&gt; Promise&lt;void&gt;;</code></pre>
</div>
<div>
<h3 id="hook-afterWorkspaceDependencyReplacement">
<code>afterWorkspaceDependencyReplacement</code>
</h3>
<div>
<p>Called when a dependency range is replaced inside a workspace. Note that this hook is only called by the CLI commands like <code>yarn add</code> - manually updating the dependencies from the manifest and running <code>yarn install</code> won't trigger it.</p> </div>
<pre><code>afterWorkspaceDependencyReplacement?: (
  workspace: Workspace,
  target: suggestUtils.Target,
  fromDescriptor: Descriptor,
  toDescriptor: Descriptor,
) =&gt; Promise&lt;void&gt;;</code></pre>
</div>
<div>
<h3 id="hook-beforeWorkspacePacking">
<code>beforeWorkspacePacking</code>
</h3>
<div>
<p>Called before a workspace is packed. The <code>rawManifest</code> value passed in parameter is allowed to be mutated at will, with the changes being only applied to the packed manifest (the original one won't be mutated).</p> </div>
<pre><code>beforeWorkspacePacking?: (
  workspace: Workspace,
  rawManifest: object,
) =&gt; Promise&lt;void&gt; | void;</code></pre>
</div>
<div>
<h3 id="hook-cleanGlobalArtifacts">
<code>cleanGlobalArtifacts</code>
</h3>
<div>
<p>Called when the user requests to clean the global cache. Plugins should use this hook to remove their own global artifacts.</p> </div>
<pre><code>cleanGlobalArtifacts?: (
  configuration: Configuration,
) =&gt; Promise&lt;void&gt;;</code></pre>
</div>
<div>
<h3 id="hook-fetchHostedRepository">
<code>fetchHostedRepository</code>
</h3>
<div>
<p>Called when a Git repository is fetched. If the function returns <code>null</code> the repository will be cloned and packed; otherwise, it must returns a value compatible with what a fetcher would return.</p> </div>
<div>
<p>The main use case for this hook is to let you implement smarter cloning strategies depending on the hosting platform. For instance, GitHub supports downloading repository tarballs, which are more efficient than cloning the repository (even without its history).</p> </div>
<pre><code>fetchHostedRepository?: (
  current: FetchResult | null,
  locator: Locator,
  opts: FetchOptions,
) =&gt; Promise&lt;FetchResult | null&gt;;</code></pre>
</div>
<div>
<h3 id="hook-fetchPackageInfo">
<code>fetchPackageInfo</code>
</h3>
<div>
<p>Called by <code>yarn info</code>. The <code>extra</code> field is the set of parameters passed to the <code>-X,--extra</code> flag. Calling <code>registerData</code> will add a new set of data that will be added to the package information.</p> </div>
<div>
<p>For instance, an "audit" plugin could check in <code>extra</code> whether the user requested audit information (via <code>-X audit</code>), and call <code>registerData</code> with those information (retrieved dynamically) if they did.</p> </div>
<pre><code>fetchPackageInfo?: (
  pkg: Package,
  extra: Set&lt;string&gt;,
  registerData: (namespace: string, data: Array&lt;formatUtils.Tuple&gt; | {[key: string]: formatUtils.Tuple | undefined}) =&gt; void,
) =&gt; Promise&lt;void&gt;;</code></pre>
</div>
<div>
<h3 id="hook-getBuiltinPatch">
<code>getBuiltinPatch</code>
</h3>
<div>
<p>Registers a builtin patch that can be referenced using the dedicated syntax: <code>patch:builtin&lt;name&gt;</code>. This is for instance how the TypeScript patch is automatically registered.</p> </div>
<pre><code>getBuiltinPatch?: (
  project: Project,
  name: string,
) =&gt; Promise&lt;string | null | void&gt;;</code></pre>
</div>
<div>
<h3 id="hook-globalHashGeneration">
<code>globalHashGeneration</code>
</h3>
<div>
<p>Called before the build, to compute a global hash key that we will use to detect whether packages must be rebuilt (typically when the Node version changes).</p> </div>
<pre><code>globalHashGeneration?: (
  project: Project,
  contributeHash: (data: string | Buffer) =&gt; void,
) =&gt; Promise&lt;void&gt;;</code></pre>
</div>
<div>
<h3 id="hook-populateYarnPaths">
<code>populateYarnPaths</code>
</h3>
<div>
<p>Used to notify the core of all the potential artifacts of the available linkers.</p> </div>
<pre><code>populateYarnPaths?: (
  project: Project,
  definePath: (path: PortablePath | null) =&gt; void,
) =&gt; Promise&lt;void&gt;;</code></pre>
</div>
<div>
<h3 id="hook-reduceDependency">
<code>reduceDependency</code>
</h3>
<div>
<p>Called during the resolution, once for each resolved package and each of their dependencies. By returning a new dependency descriptor you can replace the original one by a different range.</p> </div>
<div>
<p>Note that when multiple plugins are registered on <code>reduceDependency</code> they will be executed in definition order. In that case, <code>dependency</code> will always refer to the dependency as it currently is, whereas <code>initialDependency</code> will be the descriptor before any plugin attempted to change it.</p> </div>
<pre><code>reduceDependency?: (
  dependency: Descriptor,
  project: Project,
  locator: Locator,
  initialDependency: Descriptor,
  extra: {resolver: Resolver, resolveOptions: ResolveOptions},
) =&gt; Promise&lt;Descriptor&gt;;</code></pre>
</div>
<div>
<h3 id="hook-registerPackageExtensions">
<code>registerPackageExtensions</code>
</h3>
<div>
<p>Called when the package extensions are setup. Can be used to inject new ones. That's for example what the compat plugin uses to automatically fix packages with known flaws.</p> </div>
<pre><code>registerPackageExtensions?: (
  configuration: Configuration,
  registerPackageExtension: (descriptor: Descriptor, extensionData: PackageExtensionData) =&gt; void,
) =&gt; Promise&lt;void&gt;;</code></pre>
</div>
<div>
<h3 id="hook-setupScriptEnvironment">
<code>setupScriptEnvironment</code>
</h3>
<div>
<p>Called before a script is executed. The hooks are allowed to modify the <code>env</code> object as they see fit, and any call to <code>makePathWrapper</code> will cause a binary of the given name to be injected somewhere within the PATH (we recommend you don't alter the PATH yourself unless required).</p> </div>
<div>
<p>The keys you get in the env are guaranteed to be uppercase. We strongly suggest you adopt this convention for any new key added to the env (we might enforce it later on).</p> </div>
<pre><code>setupScriptEnvironment?: (
  project: Project,
  env: ProcessEnvironment,
  makePathWrapper: (name: string, argv0: string, args: Array&lt;string&gt;) =&gt; Promise&lt;void&gt;,
) =&gt; Promise&lt;void&gt;;</code></pre>
</div>
<div>
<h3 id="hook-validateProject">
<code>validateProject</code>
</h3>
<div>
<p>Called during the <code>Validation step</code> of the <code>install</code> method from the <code>Project</code> class.</p> </div>
<pre><code>validateProject?: (
  project: Project,
  report: {
    reportWarning: (name: MessageName, text: string) =&gt; void;
    reportError: (name: MessageName, text: string) =&gt; void;
  }
) =&gt; void;</code></pre>
</div>
<div>
<h3 id="hook-validateWorkspace">
<code>validateWorkspace</code>
</h3>
<div>
<p>Called during the <code>Validation step</code> of the <code>install</code> method from the <code>Project</code> class by the <code>validateProject</code> hook.</p> </div>
<pre><code>validateWorkspace?: (
  workspace: Workspace,
  report: {
    reportWarning: (name: MessageName, text: string) =&gt; void;
    reportError: (name: MessageName, text: string) =&gt; void;
  }
) =&gt; void;</code></pre>
</div>
<div>
<h3 id="hook-wrapNetworkRequest">
<code>wrapNetworkRequest</code>
</h3>
<div>
<p>Called when a network request is being made. The <code>executor</code> function parameter, when called, will trigger the network request. You can use this mechanism to wrap network requests, for example to run some validation or add some logging.</p> </div>
<pre><code>wrapNetworkRequest?: (
  executor: () =&gt; Promise&lt;any&gt;,
  extra: WrapNetworkRequestInfo
) =&gt; Promise&lt;() =&gt; Promise&lt;any&gt;&gt;;</code></pre>
</div>
<div>
<h3 id="hook-wrapScriptExecution">
<code>wrapScriptExecution</code>
</h3>
<div>
<p>Called as a script is getting executed. The <code>executor</code> function parameter, when called, will execute the script. You can use this mechanism to wrap script executions, for example to run some validation or add some performance monitoring.</p> </div>
<pre><code>wrapScriptExecution?: (
  executor: () =&gt; Promise&lt;number&gt;,
  project: Project,
  locator: Locator,
  scriptName: string,
  extra: {script: string, args: Array&lt;string&gt;, cwd: PortablePath, env: ProcessEnvironment, stdin: Readable | null, stdout: Writable, stderr: Writable},
) =&gt; Promise&lt;() =&gt; Promise&lt;number&gt;&gt;;</code></pre>
</div>
</div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2016&ndash;present Yarn Contributors<br>Licensed under the BSD License.<br>
    <a href="https://yarnpkg.com/advanced/plugin-tutorial" class="_attribution-link">https://yarnpkg.com/advanced/plugin-tutorial</a>
  </p>
</div>
