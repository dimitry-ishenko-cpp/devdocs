<h1 class="command-name">TS.CREATERULE</h1>
<pre>TS.CREATERULE</pre> <div class="font-semibold text-slate-900">Syntax</div> <pre class="command-syntax">TS.CREATERULE sourceKey destKey 
  AGGREGATION aggregator bucketDuration 
  [alignTimestamp]
</pre> <dl class="grid grid-cols-[auto,1fr] gap-x-2 mb-12"> <dt class="font-semibold text-slate-900">Available in:</dt> <dd> <a href="https://redis.io/docs/stack">Redis Stack</a> / <a href="https://redis.io/docs/stack/timeseries">TimeSeries 1.0.0</a> </dd> <dt class="font-semibold text-slate-900">Time complexity:</dt> <dd>O(1)</dd> </dl> <p>Create a compaction rule</p> <p><a href="#examples">Examples</a></p> <h2 id="required-arguments">Required arguments</h2> <details open><summary><code>sourceKey</code></summary> <p>is key name for the source time series.</p> </details> <details open><summary><code>destKey</code></summary> <p>is key name for destination (compacted) time series. It must be created before <code>TS.CREATERULE</code> is called.</p> </details> <details open><summary><code>AGGREGATION aggregator bucketDuration</code></summary> <p>aggregates results into time buckets.</p> <ul> <li> <p><code>aggregator</code> takes one of the following aggregation types:</p> <table> <thead> <tr> <th><code>aggregator</code></th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>avg</code></td> <td>Arithmetic mean of all values</td> </tr> <tr> <td><code>sum</code></td> <td>Sum of all values</td> </tr> <tr> <td><code>min</code></td> <td>Minimum value</td> </tr> <tr> <td><code>max</code></td> <td>Maximum value</td> </tr> <tr> <td><code>range</code></td> <td>Difference between the highest and the lowest value</td> </tr> <tr> <td><code>count</code></td> <td>Number of values</td> </tr> <tr> <td><code>first</code></td> <td>Value with lowest timestamp in the bucket</td> </tr> <tr> <td><code>last</code></td> <td>Value with highest timestamp in the bucket</td> </tr> <tr> <td><code>std.p</code></td> <td>Population standard deviation of the values</td> </tr> <tr> <td><code>std.s</code></td> <td>Sample standard deviation of the values</td> </tr> <tr> <td><code>var.p</code></td> <td>Population variance of the values</td> </tr> <tr> <td><code>var.s</code></td> <td>Sample variance of the values</td> </tr> <tr> <td><code>twa</code></td> <td>Time-weighted average over the bucket's timeframe (since RedisTimeSeries v1.8)</td> </tr> </tbody> </table> </li> <li> <p><code>bucketDuration</code> is duration of each bucket, in milliseconds.</p> </li> </ul> <p><note><b>Notes</b></note></p> <ul> <li>Only new samples that are added into the source series after the creation of the rule will be aggregated.</li> <li>Calling <code>TS.CREATERULE</code> with a nonempty <code>destKey</code> may result in inconsistencies between the raw and the compacted data.</li> <li>Explicitly adding samples to a compacted time series (using <a href="../ts.add.html"><code>TS.ADD</code></a>, <a href="../ts.madd.html"><code>TS.MADD</code></a>, <a href="../ts.incrby.html"><code>TS.INCRBY</code></a>, or <a href="../ts.decrby.html"><code>TS.DECRBY</code></a>) may result in inconsistencies between the raw and the compacted data. The compaction process may override such samples.</li> <li>If no samples are added to the source time series during a bucket period. no <em>compacted sample</em> is added to the destination time series.</li> <li>The timestamp of a compacted sample added to the destination time series is set to the start timestamp the appropriate compaction bucket. For example, for a 10-minute compaction bucket with no alignment, the compacted samples timestamps are <code>x:00</code>, <code>x:10</code>, <code>x:20</code>, and so on.</li> <li>Deleting <code>destKey</code> will cause the compaction rule to be deleted as well.</li> <li>On a clustered environment, hash tags should be used to force <code>sourceKey</code> and <code>destKey</code> to be stored in the same hash slot.</li> </ul> <h2 id="optional-arguments">Optional arguments</h2> <details open><summary><code>alignTimestamp</code> (since RedisTimeSeries v1.8)</summary> <p>ensures that there is a bucket that starts exactly at <code>alignTimestamp</code> and aligns all other buckets accordingly. It is expressed in milliseconds. The default value is 0 aligned with the epoch. For example, if <code>bucketDuration</code> is 24 hours (<code>24 * 3600 * 1000</code>), setting <code>alignTimestamp</code> to 6 hours after the epoch (<code>6 * 3600 * 1000</code>) ensures that each bucketâ€™s timeframe is <code>[06:00 .. 06:00)</code>.</p> </details> <h2 id="return-value">Return value</h2> <p><a href="https://redis.io/docs/reference/protocol-spec#resp-simple-strings">Simple string reply</a> - <code>OK</code> if executed correctly, or <a href="https://redis.io/docs/reference/protocol-spec#resp-errors">Error reply</a> otherwise.</p> <h2 id="examples">Examples</h2> <details open> <summary><b>Create a compaction rule</b></summary> <p>Create a time series to store the temperatures measured in Tel Aviv.</p> <div class="highlight"><pre tabindex="0" class="chroma"><span class="line"><span class="cl">127.0.0.1:6379&gt; TS.CREATE temp:TLV LABELS <span class="nb">type</span> temp location TLV
</span></span><span class="line"><span class="cl">OK</span></span></pre></div> <p>Next, create a compacted time series named <em>dailyAvgTemp</em> containing one compacted sample per 24 hours: the time-weighted average of all measurements taken from midnight to next midnight.</p> <div class="highlight"><pre tabindex="0" class="chroma"><span class="line"><span class="cl">127.0.0.1:6379&gt; TS.CREATE dailyAvgTemp:TLV LABELS <span class="nb">type</span> temp location TLV
</span></span><span class="line"><span class="cl">127.0.0.1:6379&gt; TS.CREATERULE temp:TLV dailyAvgTemp:TLV AGGREGATION twa <span class="m">86400000</span> </span></span></pre></div> <p>Now, also create a compacted time series named <em>dailyDiffTemp</em>. This time series will contain one compacted sample per 24 hours: the difference between the minimum and the maximum temperature measured between 06:00 and 06:00 next day. Here, 86400000 is the number of milliseconds in 24 hours, 21600000 is the number of milliseconds in 6 hours.</p> <div class="highlight"><pre tabindex="0" class="chroma"><span class="line"><span class="cl">127.0.0.1:6379&gt; TS.CREATE dailyDiffTemp:TLV LABELS <span class="nb">type</span> temp location TLV
</span></span><span class="line"><span class="cl">127.0.0.1:6379&gt; TS.CREATERULE temp:TLV dailyDiffTemp:TLV AGGREGATION range <span class="m">86400000</span> <span class="m">21600000</span></span></span></pre></div> </details> <h2 id="see-also">See also</h2> <p><a href="../ts.deleterule.html"><code>TS.DELETERULE</code></a></p> <h2 id="related-topics">Related topics</h2> <p><a href="https://redis.io/docs/stack/timeseries">RedisTimeSeries</a></p>  </details><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2006&ndash;2022 Salvatore Sanfilippo<br>Licensed under the Creative Commons Attribution-ShareAlike License 4.0.<br>
    <a href="https://redis.io/commands/ts.createrule/" class="_attribution-link">https://redis.io/commands/ts.createrule/</a>
  </p>
</div>
