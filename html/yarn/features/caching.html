<header><h1>Cache strategies</h1></header><h2 class="anchor anchorWithStickyNavbar_ATBP" id="overview">Overview<a class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" href="caching.html#overview">​</a>
</h2> <p>Yarn boasts a wide set of cache settings, letting you tweak depending on your preferred workflows or CI platforms. This documentation goes over some of the most interesting patterns to know.</p> <div class="theme-admonition theme-admonition-tip admonition_JrWa alert alert--success">
<div class="admonitionHeading_MtRg">
tip</div>
<div class="admonitionContent_G2Ck"><p>Yarn will by default cache everything you install and mutualize them for all other projects on your machine; this improves both installation speed and disk footprint, just like if you were using hardlinks.</p></div>
</div> <h2 class="anchor anchorWithStickyNavbar_ATBP" id="major-patterns">Major patterns<a class="hash-link" aria-label="Direct link to Major patterns" title="Direct link to Major patterns" href="caching.html#major-patterns">​</a>
</h2> <h3 class="anchor anchorWithStickyNavbar_ATBP" id="offline-mirror">Offline mirror<a class="hash-link" aria-label="Direct link to Offline mirror" title="Direct link to Offline mirror" href="caching.html#offline-mirror">​</a>
</h3> <p>When installed for the first time on a machine, packages are usually retrieved from the npm registry. While it usually works fine, it's not <em>always</em> the case - the registry is known to experience issues from time to time that often result in failed installs. If you're not prepared, it may be a significant disruption for your developers, as switching branches and performing deploys can be much harder or unstable.</p> <p>Some companies try to avoid this problem by configuring their registry to a mirror they control (for example by having a server run <a href="https://verdaccio.org/" target="_blank" rel="noopener noreferrer">Verdaccio</a>, an open-source implementation of the npm registry). It however requires a specific setup that isn't always easy to deploy to both developers and CI, and those systems sometimes come with <a href="https://medium.com/%2540alex.birsan/dependency-confusion-4a5d60fec610" target="_blank" rel="noopener noreferrer">risks</a>.</p> <p>Yarn provides a very simple but effective alternative: by setting <code data-tooltip-id="tooltip" data-tooltip-content="Define whether the cache should be shared between all local projects."><a class="key_FEvO" href="../configuration/yarnrc.html#enableGlobalCache">enableGlobalCache</a></code> to false, it will save the package cache into a folder local to your project (by default <code>.yarn/cache</code>) that can then be added to Git. Every given commit is thus guaranteed to be installable, even should the npm registry go under.</p> <h3 class="anchor anchorWithStickyNavbar_ATBP" id="zero-installs">Zero-installs<a class="hash-link" aria-label="Direct link to Zero-installs" title="Direct link to Zero-installs" href="caching.html#zero-installs">​</a>
</h3> <p>Zero-installs are the combination of two Yarn features that allow you to skip having to think about running <span class="inline_hdsZ"><code><span class="token_Ye2a" data-type="binary">yarn</span> <a class="path_tCL7" data-tooltip-id="tooltip" data-tooltip-content="Install the project dependencies
" href="../cli/install.html"><span class="token_Ye2a" data-type="path">install</span></a></code></span> when switching branches - a requirement otherwise easy to forget until you see your tools crash.</p> <p>As we saw, the offline mirror removes your project's dependency on the npm registry by keeping the Yarn cache within the repository. But can we go further, and directly make this cache the actual? The answer is yes!</p> <p>As long as your project uses <a href="pnp.html">Yarn PnP</a> <strong>and</strong> the <a href="caching.html#offline-mirror">offline mirror</a>, all you have to do is add the loader files to Git, and you can forget <span class="inline_hdsZ"><code><span class="token_Ye2a" data-type="binary">yarn</span> <a class="path_tCL7" data-tooltip-id="tooltip" data-tooltip-content="Install the project dependencies
" href="../cli/install.html"><span class="token_Ye2a" data-type="path">install</span></a></code></span> most of the time. Since the PnP loaders have exactly the same content regardless of the machine that generated them, and since the offline cache will contain all the files that the loaders reference, the <code>git checkout</code> calls effectively double as <span class="inline_hdsZ"><code><span class="token_Ye2a" data-type="binary">yarn</span> <a class="path_tCL7" data-tooltip-id="tooltip" data-tooltip-content="Install the project dependencies
" href="../cli/install.html"><span class="token_Ye2a" data-type="path">install</span></a></code></span> of sort.</p> <p>One caveat: adding or removing packages with native dependencies will still require <span class="inline_hdsZ"><code><span class="token_Ye2a" data-type="binary">yarn</span> <a class="path_tCL7" data-tooltip-id="tooltip" data-tooltip-content="Install the project dependencies
" href="../cli/install.html"><span class="token_Ye2a" data-type="path">install</span></a></code></span> to be run, as such packages depend on files that, unlike Node.js scripts, can't be evaluated directly from within their zip archives. Those packages are quite rare in practice, aren't frequently updated, and Yarn will display an helpful error message should you forget to do it, so this doesn't significantly impact the usefulness of the pattern.</p> <div class="theme-admonition theme-admonition-info admonition_JrWa alert alert--info">
<div class="admonitionHeading_MtRg">
info</div>
<div class="admonitionContent_G2Ck">
<p>Zero-installs are technically possible by adding your <code>node_modules</code> folders to Git. The difference however is that <code>node_modules</code> folders contain multiple thousands of files that Git each has to diff individually, that the hoisting causes them to frequently be moved around, and that people have a bad tendency to make manual changes to their <code>node_modules</code> folder that end up committed.</p>
<p>By contrast, adding your cache to Git and using Yarn PnP gives you a single folder with exactly one zip archive for each package, plus the PnP loader file. This is vastly easier for Git to track, as we saw earlier.</p>
</div>
</div> <h2 class="anchor anchorWithStickyNavbar_ATBP" id="specific-environments">Specific environments<a class="hash-link" aria-label="Direct link to Specific environments" title="Direct link to Specific environments" href="caching.html#specific-environments">​</a>
</h2> <h3 class="anchor anchorWithStickyNavbar_ATBP" id="github-actions">GitHub Actions<a class="hash-link" aria-label="Direct link to GitHub Actions" title="Direct link to GitHub Actions" href="caching.html#github-actions">​</a>
</h3> <div class="theme-admonition theme-admonition-info admonition_JrWa alert alert--info">
<div class="admonitionHeading_MtRg">
info</div>
<div class="admonitionContent_G2Ck"><p>We're still investigating the exact set of defaults that make GH Action caching more efficient. It's likely that we'll provide an official <code>yarn-cache</code> action mid-term for this purpose.</p></div>
</div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2016&ndash;present Yarn Contributors<br>Licensed under the BSD License.<br>
    <a href="https://yarnpkg.com/features/caching" class="_attribution-link">https://yarnpkg.com/features/caching</a>
  </p>
</div>
