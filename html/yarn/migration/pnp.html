<header><h1>To go further: Yarn PnP</h1></header><div class="theme-admonition theme-admonition-info admonition_JrWa alert alert--info">
<div class="admonitionHeading_MtRg">
info</div>
<div class="admonitionContent_G2Ck">
<p>These steps are <strong>completely optional</strong>!</p>
<p>While we recommend to use <a href="../features/pnp.html">Yarn Plug'n'Play</a> for new projects, enabling it on existing projects may require a time investment. Feel free to skip this part if you prefer, and to come back to it whenever you have more time and/or a concrete benefit to get from it.</p>
</div>
</div> <h2 class="anchor anchorWithStickyNavbar_ATBP" id="calling-the-doctor">Calling the Doctor<a class="hash-link" aria-label="Direct link to Calling the Doctor" title="Direct link to Calling the Doctor" href="pnp.html#calling-the-doctor">​</a>
</h2> <p>Plug'n'Play enforces strict <a href="../advanced/rulebook.html">dependency rules</a>. You'll get errors should something in your application rely on unlisted dependencies which could cause your application to become unstable.</p> <p>To quickly detect which places may rely on unsafe patterns, Yarn provides a tool called the Doctor. Just run <span class="inline_hdsZ"><code><span class="token_Ye2a" data-type="binary">yarn</span> <a class="path_tCL7" data-tooltip-id="tooltip" data-tooltip-content="Run a package in a temporary environment
" href="../cli/dlx.html"><span class="token_Ye2a" data-type="path">dlx</span></a> <span class="token_Ye2a" data-type="positional">@yarnpkg/doctor</span></code></span> in your project and the Doctor will start looking at your source files to detect any potentially problematic pattern.</p> <h3 class="anchor anchorWithStickyNavbar_ATBP" id="example">Example<a class="hash-link" aria-label="Direct link to Example" title="Direct link to Example" href="pnp.html#example">​</a>
</h3> <p>For example, here's what the Doctor used to say about <code>webpack-dev-server</code>:</p> <div class="codeBlockContainer_EXcq theme-code-block"><div class="codeBlockContent_gO9Y">
<pre tabindex="0" class="prism-code language-text codeBlock_itEV thin-scrollbar" data-language="text">➤ YN0000: Found 1 package(s) to process
➤ YN0000: For a grand total of 236 file(s) to validate

➤ YN0000: ┌ /webpack-dev-server/package.json
➤ YN0000: │ /webpack-dev-server/test/testSequencer.js:5:19: Undeclared dependency on @jest/test-sequencer
➤ YN0000: │ /webpack-dev-server/client-src/default/webpack.config.js:12:14: Webpack configs from non-private packages should avoid referencing loaders without require.resolve
➤ YN0000: │ /webpack-dev-server/test/server/contentBase-option.test.js:68:8: Strings should avoid referencing the node_modules directory (prefer require.resolve)
➤ YN0000: └ Completed in 5.12s

➤ YN0000: Failed with errors in 5.12s</pre>

</div></div> <p>We can see that the Doctor spotted a couple of legitimate issues:</p> <ul> <li> <p><code>testSequencer.js</code> depends on <code>@jest/test-sequencer</code> without listing it as a proper dependency - which would be reported as an error at runtime under Yarn Plug'n'Play, as nothing guarantees that the version of <code>@jest/test-sequencer</code> would match what the package has been tested with.</p> </li> <li> <p><code>webpack.config.js</code> references a loader without passing its name through <code>require.resolve</code> - this is unsafe, as it means the loader will be resolved relative to the <code>webpack</code> package, rather than <code>webpack-dev-server</code>'s dependencies.</p> </li> <li> <p><code>contentBase-option.test.js</code> checks the content of the <code>node_modules</code> folder - which wouldn't exist anymore under Plug'n'Play.</p> </li> </ul> <h2 class="anchor anchorWithStickyNavbar_ATBP" id="enabling-yarn-pnp">Enabling Yarn PnP<a class="hash-link" aria-label="Direct link to Enabling Yarn PnP" title="Direct link to Enabling Yarn PnP" href="pnp.html#enabling-yarn-pnp">​</a>
</h2> <ol> <li>Look into your <code>.yarnrc.yml</code> file for the <a href="../configuration/yarnrc.html#nodeLinker"><code data-tooltip-id="tooltip" data-tooltip-content="Define how Node packages should be installed."><span class="key_FEvO">nodeLinker</span></code></a> setting.</li> <li>If you don't find it, or if it's set to <code>pnp</code>, then it's all good: you're already using Yarn Plug'n'Play!</li> <li>Otherwise, remove it from your configuration file and run <span class="inline_hdsZ"><code><span class="token_Ye2a" data-type="binary">yarn</span> <a class="path_tCL7" data-tooltip-id="tooltip" data-tooltip-content="Install the project dependencies
" href="../cli/install.html"><span class="token_Ye2a" data-type="path">install</span></a></code></span>.</li> <li>Commit the changes.</li> </ol> <h3 class="anchor anchorWithStickyNavbar_ATBP" id="what-to-look-for">What to look for<a class="hash-link" aria-label="Direct link to What to look for" title="Direct link to What to look for" href="pnp.html#what-to-look-for">​</a>
</h3> <p>Now you should have a working Yarn Plug'n'Play setup, but your repository might still need some extra care. Some things to keep in mind:</p> <ul> <li>There are no <code>node_modules</code> folders. Use <code>require.resolve</code> instead.</li> <li>There are no <code>.bin</code> folders. If you relied on them, use <a href="pnp.html#call-binaries-using-yarn-run-rather-than-node_modulesbin"><span class="inline_hdsZ"><code><span class="token_Ye2a" data-type="binary">yarn</span> <a class="path_tCL7" data-tooltip-id="tooltip" data-tooltip-content="Run a script defined in the package.json
" href="../cli/run.html"><span class="token_Ye2a" data-type="path">run</span></a> <span class="token_Ye2a" data-type="positional">bin</span></code></span></a> instead.</li> <li>Replace any calls to <code>node</code> that are not inside the <code data-tooltip-id="tooltip" data-tooltip-content="Set of scripts to expose via `yarn run script-name`, or as lifecycle hooks."><a class="key_FEvO" href="../configuration/manifest.html#scripts">scripts</a></code> field by <span class="inline_hdsZ"><code><span class="token_Ye2a" data-type="binary">yarn</span> <a class="path_tCL7" data-tooltip-id="tooltip" data-tooltip-content="Run node with the hook already setup
" href="../cli/node.html"><span class="token_Ye2a" data-type="path">node</span></a></code></span>.</li> <li>Custom pre-hooks (e.g. <code>prestart</code>) need to be called manually now (<span class="inline_hdsZ"><code><span class="token_Ye2a" data-type="binary">yarn</span> <span class="token_Ye2a" data-type="positional">prestart</span></code></span>).</li> </ul> <p>All of this and more is documented in the following sections. In general, we advise you at this point to try to run your application and see what breaks, then check here to find out tips on how to correct your install.</p> <h3 class="anchor anchorWithStickyNavbar_ATBP" id="editor-support">Editor support<a class="hash-link" aria-label="Direct link to Editor support" title="Direct link to Editor support" href="pnp.html#editor-support">​</a>
</h3> <div class="theme-admonition theme-admonition-tip admonition_JrWa alert alert--success">
<div class="admonitionHeading_MtRg">
tip</div>
<div class="admonitionContent_G2Ck"><p>We only cover VSCode here, but we have a dedicated <a href="../getting-started/editor-sdks.html">documentation page</a> covering more IDEs!</p></div>
</div> <div class="theme-admonition theme-admonition-warning admonition_JrWa alert alert--warning">
<div class="admonitionHeading_MtRg">
warning</div>
<div class="admonitionContent_G2Ck"><p>Make sure that <code>typescript</code>, <code>eslint</code>, <code>prettier</code>, ... all dependencies typically used by your IDE extensions are listed at the <em>top level</em> of the project (rather than in an arbitrary workspace).</p></div>
</div> <ol> <li>Install the <a href="https://marketplace.visualstudio.com/items?itemName=arcanis.vscode-zipfs" target="_blank" rel="noopener noreferrer">ZipFS</a> VSCode extension.</li> <li>Run <span class="inline_hdsZ"><code><span class="token_Ye2a" data-type="binary">yarn</span> <a class="path_tCL7" data-tooltip-id="tooltip" data-tooltip-content="Run a package in a temporary environment
" href="../cli/dlx.html"><span class="token_Ye2a" data-type="path">dlx</span></a> <span class="token_Ye2a" data-type="positional">@yarnpkg/sdks</span> <span class="token_Ye2a" data-type="positional">vscode</span></code></span> and commit the changes.</li> <li>For TypeScript, don't forget to select <a href="https://code.visualstudio.com/docs/typescript/typescript-compiling#_using-the-workspace-version-of-typescript" target="_blank" rel="noopener noreferrer">Use Workspace Version</a> in VSCode.</li> </ol> <h2 class="anchor anchorWithStickyNavbar_ATBP" id="general-advices">General Advices<a class="hash-link" aria-label="Direct link to General Advices" title="Direct link to General Advices" href="pnp.html#general-advices">​</a>
</h2> <h3 class="anchor anchorWithStickyNavbar_ATBP" id="fix-dependencies-with-packageextensions">Fix dependencies with <code data-tooltip-id="tooltip" data-tooltip-content="Extend the package definitions of your dependencies; useful to fix third-party issues."><a class="key_FEvO" href="../configuration/yarnrc.html#packageExtensions">packageExtensions</a></code><a class="hash-link" aria-label="Direct link to fix-dependencies-with-packageextensions" title="Direct link to fix-dependencies-with-packageextensions" href="pnp.html#fix-dependencies-with-packageextensions">​</a>
</h3> <p>Packages sometimes forget to list their dependencies. In the past it used to cause many subtle issues, so Yarn now defaults to prevent such unsound accesses. Still, we don't want it to prevent you from doing your work as long as you can do it in a safe and predictable way, so we came up with the <a href="../configuration/yarnrc.html#packageExtensions"><code data-tooltip-id="tooltip" data-tooltip-content="Extend the package definitions of your dependencies; useful to fix third-party issues."><span class="key_FEvO">packageExtensions</span></code></a> setting.</p> <p>For example, if <code>react</code> was to forget to list a dependency on <code>prop-types</code>, you'd fix it like this:</p> <div class="language-yaml codeBlockContainer_EXcq theme-code-block"><div class="codeBlockContent_gO9Y">
<pre tabindex="0" class="prism-code language-yaml codeBlock_itEV thin-scrollbar" data-language="yaml">packageExtensions:
  "react@*":
    dependencies:
      prop-types: "*"</pre>

</div></div> <p>And if a Babel plugin was missing its peer dependency on <code>@babel/core</code>, you'd fix it with:</p> <div class="language-yaml codeBlockContainer_EXcq theme-code-block"><div class="codeBlockContent_gO9Y">
<pre tabindex="0" class="prism-code language-yaml codeBlock_itEV thin-scrollbar" data-language="yaml">packageExtensions:
  "@babel/plugin-something@*":
    peerDependencies:
      "@babel/core": "*"</pre>

</div></div> <p>Should you use dependencies or peer dependencies? It depends on the context; as a rule of thumb, if the package is a singleton (for example <code>react</code>, or <code>react-redux</code> which also relies on the React context), you'll want to make it a peer dependency. In other cases, where the package is just a collection of utilities, using a regular dependency should be fine (for example <code>tslib</code>, <code>lodash</code>, etc).</p> <h3 class="anchor anchorWithStickyNavbar_ATBP" id="call-binaries-using-yarn-run-bin-rather-than-node_modulesbin">Call binaries using <span class="inline_hdsZ"><code><span class="token_Ye2a" data-type="binary">yarn</span> <a class="path_tCL7" data-tooltip-id="tooltip" data-tooltip-content="Run a script defined in the package.json
" href="../cli/run.html"><span class="token_Ye2a" data-type="path">run</span></a> <span class="token_Ye2a" data-type="positional">bin</span></code></span> rather than <code>node_modules/.bin</code><a class="hash-link" aria-label="Direct link to call-binaries-using-yarn-run-bin-rather-than-node_modulesbin" title="Direct link to call-binaries-using-yarn-run-bin-rather-than-node_modulesbin" href="pnp.html#call-binaries-using-yarn-run-bin-rather-than-node_modulesbin">​</a>
</h3> <p>The <code>node_modules/.bin</code> folder is an implementation detail, and the PnP installs don't generate it at all. Rather than relying on its existence, just use the <span class="inline_hdsZ"><code><span class="token_Ye2a" data-type="binary">yarn</span> <a class="path_tCL7" data-tooltip-id="tooltip" data-tooltip-content="Run a script defined in the package.json
" href="../cli/run.html"><span class="token_Ye2a" data-type="path">run</span></a> <span class="token_Ye2a" data-type="positional">bin</span></code></span> command which can start both scripts and binaries:</p> <div class="language-bash codeBlockContainer_EXcq theme-code-block"><div class="codeBlockContent_gO9Y">
<pre tabindex="0" class="prism-code language-bash codeBlock_itEV thin-scrollbar" data-language="bash">yarn run jest
# or, using the shortcut:
yarn jest</pre>

</div></div> <h3 class="anchor anchorWithStickyNavbar_ATBP" id="call-your-scripts-through-yarn-node-rather-than-node">Call your scripts through <span class="inline_hdsZ"><code><span class="token_Ye2a" data-type="binary">yarn</span> <a class="path_tCL7" data-tooltip-id="tooltip" data-tooltip-content="Run node with the hook already setup
" href="../cli/node.html"><span class="token_Ye2a" data-type="path">node</span></a></code></span> rather than <code>node</code><a class="hash-link" aria-label="Direct link to call-your-scripts-through-yarn-node-rather-than-node" title="Direct link to call-your-scripts-through-yarn-node-rather-than-node" href="pnp.html#call-your-scripts-through-yarn-node-rather-than-node">​</a>
</h3> <p>We now need to inject some variables into the environment for Node to be able to locate your dependencies. In order to make this possible, we ask you to use <span class="inline_hdsZ"><code><span class="token_Ye2a" data-type="binary">yarn</span> <a class="path_tCL7" data-tooltip-id="tooltip" data-tooltip-content="Run node with the hook already setup
" href="../cli/node.html"><span class="token_Ye2a" data-type="path">node</span></a></code></span> which transparently does the heavy lifting.</p> <div class="theme-admonition theme-admonition-note admonition_JrWa alert alert--secondary">
<div class="admonitionHeading_MtRg">
note</div>
<div class="admonitionContent_G2Ck"><p>this section only applies to the <em>shell CLI</em>. The commands defined in your <code data-tooltip-id="tooltip" data-tooltip-content="Set of scripts to expose via `yarn run script-name`, or as lifecycle hooks."><a class="key_FEvO" href="../configuration/manifest.html#scripts">scripts</a></code> are unaffected, as we make sure that <code>node</code> always points to the right location, with the right variables already set.</p></div>
</div> <h3 class="anchor anchorWithStickyNavbar_ATBP" id="setup-your-ide-for-pnp-support">Setup your IDE for PnP support<a class="hash-link" aria-label="Direct link to Setup your IDE for PnP support" title="Direct link to Setup your IDE for PnP support" href="pnp.html#setup-your-ide-for-pnp-support">​</a>
</h3> <p>Since Yarn Plug'n'Play doesn't generate <code>node_modules</code> folders, some IDE integrations may not work out of the box. Check our <a href="../getting-started/editor-sdks.html">guide</a> to see how to fix them.</p> <h3 class="anchor anchorWithStickyNavbar_ATBP" id="take-a-look-at-our-end-to-end-tests">Take a look at our end-to-end tests<a class="hash-link" aria-label="Direct link to Take a look at our end-to-end tests" title="Direct link to Take a look at our end-to-end tests" href="pnp.html#take-a-look-at-our-end-to-end-tests">​</a>
</h3> <p>We now run daily <a href="https://github.com/yarnpkg/berry#current-status" target="_blank" rel="noopener noreferrer">end-to-end tests</a> against various popular JavaScript tools in order to make sure that we never regress - or be notified when third-party project ship incompatible changes.</p> <p>Consulting the sources for those tests is a great way to check whether some special configuration values have to be set when using a particular toolchain.</p> <h2 class="anchor anchorWithStickyNavbar_ATBP" id="troubleshooting">Troubleshooting<a class="hash-link" aria-label="Direct link to Troubleshooting" title="Direct link to Troubleshooting" href="pnp.html#troubleshooting">​</a>
</h2> <h3 class="anchor anchorWithStickyNavbar_ATBP" id="cannot-find-module-">
<code>Cannot find module [...]</code><a class="hash-link" aria-label="Direct link to cannot-find-module-" title="Direct link to cannot-find-module-" href="pnp.html#cannot-find-module-">​</a>
</h3> <p>This error <strong>doesn't</strong> come from Yarn: it's emitted by the Node.js resolution pipeline, telling you a package cannot be found on disk.</p> <p>If you have enabled Plug'n'Play, then the Node.js resolution pipeline is supposed to forward resolution requests to Yarn - meaning that if you get this message, it's that this forwarding didn't occur, and your first action should be to figure out why.</p> <p>Usually, it'll be because you called a Node.js script using <code>node ./my-script</code> instead of <span class="inline_hdsZ"><code><span class="token_Ye2a" data-type="binary">yarn</span> <a class="path_tCL7" data-tooltip-id="tooltip" data-tooltip-content="Run node with the hook already setup
" href="../cli/node.html"><span class="token_Ye2a" data-type="path">node</span></a> <span class="token_Ye2a" data-type="positional">./my-script</span></code></span>.</p> <h3 class="anchor anchorWithStickyNavbar_ATBP" id="a-package-is-trying-to-access-">
<code>A package is trying to access [...]</code><a class="hash-link" aria-label="Direct link to a-package-is-trying-to-access-" title="Direct link to a-package-is-trying-to-access-" href="pnp.html#a-package-is-trying-to-access-">​</a>
</h3> <p>Although rare, some packages don't list all their dependencies. Now that we enforce boundaries between the various branches of the dependency tree, this kind of issue is more apparent than it used to be (although it's always been problematic).</p> <p>The long term fix is to submit a pull request upstream to add the missing dependency to the package listing. Given that it sometimes might take some time before they get merged, we also have a more short-term fix available: create <code>.yarnrc.yml</code> in your project, then use the <a href="pnp.html#fix-dependencies-with-packageextensions"><code data-tooltip-id="tooltip" data-tooltip-content="Extend the package definitions of your dependencies; useful to fix third-party issues."><span class="key_FEvO">packageExtensions</span></code> setting</a> to add the missing dependency to the relevant packages. Run <span class="inline_hdsZ"><code><span class="token_Ye2a" data-type="binary">yarn</span> <a class="path_tCL7" data-tooltip-id="tooltip" data-tooltip-content="Install the project dependencies
" href="../cli/install.html"><span class="token_Ye2a" data-type="path">install</span></a></code></span> to apply your changes, and voilà!</p> <p>Should you choose to open a PR on the upstream repository, you will also be able to contribute your package extension to our <a href="https://github.com/yarnpkg/berry/blob/master/packages/plugin-compat/sources/extensions.ts" target="_blank" rel="noopener noreferrer"><code>plugin-compat</code> database</a>, helping the whole ecosystem move forward.</p><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2016&ndash;present Yarn Contributors<br>Licensed under the BSD License.<br>
    <a href="https://yarnpkg.com/migration/pnp" class="_attribution-link">https://yarnpkg.com/migration/pnp</a>
  </p>
</div>
