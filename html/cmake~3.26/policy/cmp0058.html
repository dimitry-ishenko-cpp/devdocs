<h1 id="policy:CMP0058">CMP0058</h1> <div class="versionadded"> <p><span class="versionmodified added">New in version 3.3.</span></p> </div> <p>Ninja requires custom command byproducts to be explicit.</p> <p>When an intermediate file generated during the build is consumed by an expensive operation or a large tree of dependents, one may reduce the work needed for an incremental rebuild by updating the file timestamp only when its content changes. With this approach the generation rule must have a separate output file that is always updated with a new timestamp that is newer than any dependencies of the rule so that the build tool re-runs the rule only when the input changes. We refer to the separate output file as a rule's <em>witness</em> and the generated file as a rule's <em>byproduct</em>.</p> <p>Byproducts may not be listed as outputs because their timestamps are allowed to be older than the inputs. No build tools (like <code>make</code>) that existed when CMake was designed have a way to express byproducts. Therefore CMake versions prior to 3.2 had no way to specify them. Projects typically left byproducts undeclared in the rules that generate them. For example:</p> <pre data-language="cmake">add_custom_command(
  OUTPUT witness.txt
  COMMAND ${CMAKE_COMMAND} -E copy_if_different
          ${CMAKE_CURRENT_SOURCE_DIR}/input.txt
          byproduct.txt # timestamp may not change
  COMMAND ${CMAKE_COMMAND} -E touch witness.txt
  DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/input.txt
  )
add_custom_target(Provider DEPENDS witness.txt)
add_custom_command(
  OUTPUT generated.c
  COMMAND expensive-task -i byproduct.txt -o generated.c
  DEPENDS ${CMAKE_CURRENT_BINARY_DIR}/byproduct.txt
  )
add_library(Consumer generated.c)
add_dependencies(Consumer Provider)
</pre> <p>This works well for all generators except <a class="reference internal" href="https://cmake.org/cmake/help/v3.26/generator/Ninja.html#generator:Ninja" title="Ninja" id="index-0-generator:Ninja"><code>Ninja</code></a>. The Ninja build tool sees a rule listing <code>byproduct.txt</code> as a dependency and no rule listing it as an output. Ninja then complains that there is no way to satisfy the dependency and stops building even though there are order-only dependencies that ensure <code>byproduct.txt</code> will exist before its consumers need it. See discussion of this problem in <a class="reference external" href="https://github.com/ninja-build/ninja/issues/760">Ninja Issue 760</a> for further details on why Ninja works this way.</p> <p>Instead of leaving byproducts undeclared in the rules that generate them, Ninja expects byproducts to be listed along with other outputs. Such rules may be marked with a <code>restat</code> option that tells Ninja to check the timestamps of outputs after the rules run. This prevents byproducts whose timestamps do not change from causing their dependents to re-build unnecessarily.</p> <p>Since the above approach does not tell CMake what custom command generates <code>byproduct.txt</code>, the Ninja generator does not have enough information to add the byproduct as an output of any rule. CMake 2.8.12 and above work around this problem and allow projects using the above approach to build by generating <code>phony</code> build rules to tell Ninja to tolerate such missing files. However, this workaround prevents Ninja from diagnosing a dependency that is really missing. It also works poorly in in-source builds where every custom command dependency, even on source files, needs to be treated this way because CMake does not have enough information to know which files are generated as byproducts of custom commands.</p>  <h2>Introducing Byproducts</h2> <p>CMake 3.2 introduced the <code>BYPRODUCTS</code> option to the <a class="reference internal" href="../command/add_custom_command.html#command:add_custom_command" title="add_custom_command" id="index-0-command:add_custom_command"><code>add_custom_command()</code></a> and <a class="reference internal" href="../command/add_custom_target.html#command:add_custom_target" title="add_custom_target" id="index-0-command:add_custom_target"><code>add_custom_target()</code></a> commands. This option allows byproducts to be specified explicitly:</p> <pre data-language="cmake">add_custom_command(
  OUTPUT witness.txt
  BYPRODUCTS byproduct.txt # explicit byproduct specification
  COMMAND ${CMAKE_COMMAND} -E copy_if_different
          ${CMAKE_CURRENT_SOURCE_DIR}/input.txt
          byproduct.txt # timestamp may not change
...
</pre> <p>The <code>BYPRODUCTS</code> option is used by the <a class="reference internal" href="https://cmake.org/cmake/help/v3.26/generator/Ninja.html#generator:Ninja" title="Ninja" id="index-1-generator:Ninja"><code>Ninja</code></a> generator to list byproducts among the outputs of the custom commands that generate them, and is ignored by other generators.</p> <p>CMake 3.3 and above prefer to require projects to specify custom command byproducts explicitly so that it can avoid using the <code>phony</code> rule workaround altogether. Policy <code>CMP0058</code> was introduced to provide compatibility with existing projects that still need the workaround.</p> <p>This policy has no effect on generators other than <a class="reference internal" href="https://cmake.org/cmake/help/v3.26/generator/Ninja.html#generator:Ninja" title="Ninja" id="index-2-generator:Ninja"><code>Ninja</code></a>. The <code>OLD</code> behavior for this policy is to generate Ninja <code>phony</code> rules for unknown dependencies in the build tree. The <code>NEW</code> behavior for this policy is to not generate these and instead require projects to specify custom command <code>BYPRODUCTS</code> explicitly.</p> <p>This policy was introduced in CMake version 3.3. CMake version 3.26.0-rc3 warns when it sees unknown dependencies in out-of-source build trees if the policy is not set and then uses <code>OLD</code> behavior. Use the <a class="reference internal" href="../command/cmake_policy.html#command:cmake_policy" title="cmake_policy" id="index-0-command:cmake_policy"><code>cmake_policy()</code></a> command to set the policy to <code>OLD</code> or <code>NEW</code> explicitly. The policy setting must be in scope at the end of the top-level <code>CMakeLists.txt</code> file of the project and has global effect.</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>The <code>OLD</code> behavior of a policy is <a class="reference internal" href="../manual/cmake-policies.7.html#manual:cmake-policies(7)" title="cmake-policies(7)" id="index-0-manual:cmake-policies(7)"><code>deprecated by definition</code></a> and may be removed in a future version of CMake.</p> </div>   <div class="_attribution">
  <p class="_attribution-p">
    &copy; 2000&ndash;2023 Kitware, Inc. and Contributors<br>Licensed under the BSD 3-clause License.<br>
    <a href="https://cmake.org/cmake/help/v3.26/policy/CMP0058.html" class="_attribution-link">https://cmake.org/cmake/help/v3.26/policy/CMP0058.html</a>
  </p>
</div>
