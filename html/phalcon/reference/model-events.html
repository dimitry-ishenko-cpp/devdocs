<h1 id="model-events">Model Events</h1>  <h2 id="events-and-events-manager">Events and Events Manager</h2> <p>Models allow you to implement events that will be thrown while performing an insert/update/delete which can be used to define business rules. The following are the events supported by <a class="reference internal" href="../api/phalcon_mvc_model.html"><em>Phalcon\Mvc\Model</em></a> and their order of execution:</p> <table class="docutils"> <colgroup> <col width="10%"> <col width="13%"> <col width="12%"> <col width="66%"> </colgroup> <thead valign="bottom"> <tr class="row-odd">
<th class="head">Operation</th> <th class="head">Name</th> <th class="head">Can stop operation?</th> <th class="head">Explanation</th> </tr> </thead> <tbody valign="top"> <tr class="row-even">
<td>Inserting/Updating</td> <td>beforeValidation</td> <td>YES</td> <td>Is executed before the fields are validated for not nulls/empty strings or foreign keys</td> </tr> <tr class="row-odd">
<td>Inserting</td> <td>beforeValidationOnCreate</td> <td>YES</td> <td>Is executed before the fields are validated for not nulls/empty strings or foreign keys when an insertion operation is being made</td> </tr> <tr class="row-even">
<td>Updating</td> <td>beforeValidationOnUpdate</td> <td>YES</td> <td>Is executed before the fields are validated for not nulls/empty strings or foreign keys when an updating operation is being made</td> </tr> <tr class="row-odd">
<td>Inserting/Updating</td> <td>onValidationFails</td> <td>YES (already stopped)</td> <td>Is executed after an integrity validator fails</td> </tr> <tr class="row-even">
<td>Inserting</td> <td>afterValidationOnCreate</td> <td>YES</td> <td>Is executed after the fields are validated for not nulls/empty strings or foreign keys when an insertion operation is being made</td> </tr> <tr class="row-odd">
<td>Updating</td> <td>afterValidationOnUpdate</td> <td>YES</td> <td>Is executed after the fields are validated for not nulls/empty strings or foreign keys when an updating operation is being made</td> </tr> <tr class="row-even">
<td>Inserting/Updating</td> <td>afterValidation</td> <td>YES</td> <td>Is executed after the fields are validated for not nulls/empty strings or foreign keys</td> </tr> <tr class="row-odd">
<td>Inserting/Updating</td> <td>beforeSave</td> <td>YES</td> <td>Runs before the required operation over the database system</td> </tr> <tr class="row-even">
<td>Updating</td> <td>beforeUpdate</td> <td>YES</td> <td>Runs before the required operation over the database system only when an updating operation is being made</td> </tr> <tr class="row-odd">
<td>Inserting</td> <td>beforeCreate</td> <td>YES</td> <td>Runs before the required operation over the database system only when an inserting operation is being made</td> </tr> <tr class="row-even">
<td>Updating</td> <td>afterUpdate</td> <td>NO</td> <td>Runs after the required operation over the database system only when an updating operation is being made</td> </tr> <tr class="row-odd">
<td>Inserting</td> <td>afterCreate</td> <td>NO</td> <td>Runs after the required operation over the database system only when an inserting operation is being made</td> </tr> <tr class="row-even">
<td>Inserting/Updating</td> <td>afterSave</td> <td>NO</td> <td>Runs after the required operation over the database system</td> </tr> </tbody> </table>  <h3 id="implementing-events-in-the-model-s-class">Implementing Events in the Model’s class</h3> <p>The easier way to make a model react to events is to implement a method with the same name of the event in the model’s class:</p> <pre class="highlight-php" data-language="php">namespace Store\Toys;

use Phalcon\Mvc\Model;

class Robots extends Model
{
    public function beforeValidationOnCreate()
    {
        echo "This is executed before creating a Robot!";
    }
}
</pre> <p>Events can be used to assign values before performing an operation, for example:</p> <pre class="highlight-php" data-language="php">use Phalcon\Mvc\Model;

class Products extends Model
{
    public function beforeCreate()
    {
        // Set the creation date
        $this-&gt;created_at = date("Y-m-d H:i:s");
    }

    public function beforeUpdate()
    {
        // Set the modification date
        $this-&gt;modified_in = date("Y-m-d H:i:s");
    }
}
</pre>   <h3 id="using-a-custom-events-manager">Using a custom Events Manager</h3> <p>Additionally, this component is integrated with <a class="reference internal" href="../api/phalcon_events_manager.html"><em>Phalcon\Events\Manager</em></a>, this means we can create listeners that run when an event is triggered.</p> <pre class="highlight-php" data-language="php">namespace Store\Toys;

use Phalcon\Mvc\Model;
use Phalcon\Events\Event;
use Phalcon\Events\Manager as EventsManager;

class Robots extends Model
{
    public function initialize()
    {
        $eventsManager = new EventsManager();

        // Attach an anonymous function as a listener for "model" events
        $eventsManager-&gt;attach(
            "model:beforeSave",
            function (Event $event, $robot) {
                if ($robot-&gt;name === "Scooby Doo") {
                    echo "Scooby Doo isn't a robot!";

                    return false;
                }

                return true;
            }
        );

        // Attach the events manager to the event
        $this-&gt;setEventsManager($eventsManager);
    }
}
</pre> <p>In the example given above, the Events Manager only acts as a bridge between an object and a listener (the anonymous function). Events will be fired to the listener when ‘robots’ are saved:</p> <pre class="highlight-php" data-language="php">use Store\Toys\Robots;

$robot = new Robots();

$robot-&gt;name = "Scooby Doo";
$robot-&gt;year = 1969;

$robot-&gt;save();
</pre> <p>If we want all objects created in our application use the same EventsManager, then we need to assign it to the Models Manager:</p> <pre class="highlight-php" data-language="php">use Phalcon\Events\Event;
use Phalcon\Events\Manager as EventsManager;

// Registering the modelsManager service
$di-&gt;setShared(
    "modelsManager",
    function () {
        $eventsManager = new EventsManager();

        // Attach an anonymous function as a listener for "model" events
        $eventsManager-&gt;attach(
            "model:beforeSave",
            function (Event $event, $model) {
                // Catch events produced by the Robots model
                if (get_class($model) === "Store\\Toys\\Robots") {
                    if ($model-&gt;name === "Scooby Doo") {
                        echo "Scooby Doo isn't a robot!";

                        return false;
                    }
                }

                return true;
            }
        );

        // Setting a default EventsManager
        $modelsManager = new ModelsManager();

        $modelsManager-&gt;setEventsManager($eventsManager);

        return $modelsManager;
    }
);
</pre> <p>If a listener returns false that will stop the operation that is executing currently.</p>    <h2 id="logging-low-level-sql-statements">Logging Low-Level SQL Statements</h2> <p>When using high-level abstraction components such as <a class="reference internal" href="../api/phalcon_mvc_model.html"><em>Phalcon\Mvc\Model</em></a> to access a database, it is difficult to understand which statements are finally sent to the database system. <a class="reference internal" href="../api/phalcon_mvc_model.html"><em>Phalcon\Mvc\Model</em></a> is supported internally by <a class="reference internal" href="../api/phalcon_db.html"><em>Phalcon\Db</em></a>. <a class="reference internal" href="../api/phalcon_logger.html"><em>Phalcon\Logger</em></a> interacts with <a class="reference internal" href="../api/phalcon_db.html"><em>Phalcon\Db</em></a>, providing logging capabilities on the database abstraction layer, thus allowing us to log SQL statements as they happen.</p> <pre class="highlight-php" data-language="php">use Phalcon\Logger;
use Phalcon\Events\Manager;
use Phalcon\Logger\Adapter\File as FileLogger;
use Phalcon\Db\Adapter\Pdo\Mysql as Connection;

$di-&gt;set(
    "db",
    function () {
        $eventsManager = new EventsManager();

        $logger = new FileLogger("app/logs/debug.log");

        // Listen all the database events
        $eventsManager-&gt;attach(
            "db:beforeQuery",
            function ($event, $connection) use ($logger) {
                $logger-&gt;log(
                    $connection-&gt;getSQLStatement(),
                    Logger::INFO
                );
            }
        );

        $connection = new Connection(
            [
                "host"     =&gt; "localhost",
                "username" =&gt; "root",
                "password" =&gt; "secret",
                "dbname"   =&gt; "invo",
            ]
        );

        // Assign the eventsManager to the db adapter instance
        $connection-&gt;setEventsManager($eventsManager);

        return $connection;
    }
);
</pre> <p>As models access the default database connection, all SQL statements that are sent to the database system will be logged in the file:</p> <pre class="highlight-php" data-language="php">use Store\Toys\Robots;

$robot = new Robots();

$robot-&gt;name       = "Robby the Robot";
$robot-&gt;created_at = "1956-07-21";

if ($robot-&gt;save() === false) {
    echo "Cannot save robot";
}
</pre> <p>As above, the file <em>app/logs/db.log</em> will contain something like this:</p> <pre class="highlight-irc" data-language="irc">[Mon, 30 Apr 12 13:47:18 -0500][DEBUG][Resource Id #77] INSERT INTO robots
(name, created_at) VALUES ('Robby the Robot', '1956-07-21')
</pre>   <h2 id="profiling-sql-statements">Profiling SQL Statements</h2> <p>Thanks to <a class="reference internal" href="../api/phalcon_db.html"><em>Phalcon\Db</em></a>, the underlying component of <a class="reference internal" href="../api/phalcon_mvc_model.html"><em>Phalcon\Mvc\Model</em></a>, it’s possible to profile the SQL statements generated by the ORM in order to analyze the performance of database operations. With this you can diagnose performance problems and to discover bottlenecks.</p> <pre class="highlight-php" data-language="php">use Phalcon\Db\Profiler as ProfilerDb;
use Phalcon\Events\Manager as EventsManager;
use Phalcon\Db\Adapter\Pdo\Mysql as MysqlPdo;

$di-&gt;set(
    "profiler",
    function () {
        return new ProfilerDb();
    },
    true
);

$di-&gt;set(
    "db",
    function () use ($di) {
        $eventsManager = new EventsManager();

        // Get a shared instance of the DbProfiler
        $profiler = $di-&gt;getProfiler();

        // Listen all the database events
        $eventsManager-&gt;attach(
            "db",
            function ($event, $connection) use ($profiler) {
                if ($event-&gt;getType() === "beforeQuery") {
                    $profiler-&gt;startProfile(
                        $connection-&gt;getSQLStatement()
                    );
                }

                if ($event-&gt;getType() === "afterQuery") {
                    $profiler-&gt;stopProfile();
                }
            }
        );

        $connection = new MysqlPdo(
            [
                "host"     =&gt; "localhost",
                "username" =&gt; "root",
                "password" =&gt; "secret",
                "dbname"   =&gt; "invo",
            ]
        );

        // Assign the eventsManager to the db adapter instance
        $connection-&gt;setEventsManager($eventsManager);

        return $connection;
    }
);
</pre> <p>Profiling some queries:</p> <pre class="highlight-php" data-language="php">use Store\Toys\Robots;

// Send some SQL statements to the database
Robots::find();

Robots::find(
    [
        "order" =&gt; "name",
    ]
);

Robots::find(
    [
        "limit" =&gt; 30,
    ]
);

// Get the generated profiles from the profiler
$profiles = $di-&gt;get("profiler")-&gt;getProfiles();

foreach ($profiles as $profile) {
   echo "SQL Statement: ", $profile-&gt;getSQLStatement(), "\n";
   echo "Start Time: ", $profile-&gt;getInitialTime(), "\n";
   echo "Final Time: ", $profile-&gt;getFinalTime(), "\n";
   echo "Total Elapsed Time: ", $profile-&gt;getTotalElapsedSeconds(), "\n";
}
</pre> <p>Each generated profile contains the duration in milliseconds that each instruction takes to complete as well as the generated SQL statement.</p><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2011&ndash;2017 Phalcon Framework Team<br>Licensed under the Creative Commons Attribution License 3.0.<br>
    <a href="https://docs.phalconphp.com/en/latest/reference/model-events.html" class="_attribution-link">https://docs.phalconphp.com/en/latest/reference/model-events.html</a>
  </p>
</div>
