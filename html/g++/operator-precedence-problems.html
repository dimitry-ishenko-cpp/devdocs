<div class="subsection-level-extent" id="Operator-Precedence-Problems"> <div class="nav-panel"> <p> Next: <a href="swallowing-the-semicolon.html" accesskey="n" rel="next">Swallowing the Semicolon</a>, Previous: <a href="misnesting.html" accesskey="p" rel="prev">Misnesting</a>, Up: <a href="macro-pitfalls.html" accesskey="u" rel="up">Macro Pitfalls</a> [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="https://gcc.gnu.org/onlinedocs/gcc-13.1.0/cpp/Index-of-Directives.html" title="Index" rel="index">Index</a>]</p> </div>  <h1 class="subsection" id="Operator-Precedence-Problems-1"><span>3.10.2 Operator Precedence Problems<a class="copiable-link" href="#Operator-Precedence-Problems-1"> ¶</a></span></h1>  <p>You may have noticed that in most of the macro definition examples shown above, each occurrence of a macro argument name had parentheses around it. In addition, another pair of parentheses usually surround the entire macro definition. Here is why it is best to write macros that way. </p> <p>Suppose you define a macro as follows, </p> <div class="example smallexample"> <pre class="example-preformatted" data-language="cpp">#define ceil_div(x, y) (x + y - 1) / y</pre>
</div> <p>whose purpose is to divide, rounding up. (One use for this operation is to compute how many <code class="code">int</code> objects are needed to hold a certain number of <code class="code">char</code> objects.) Then suppose it is used as follows: </p> <div class="example smallexample"> <pre class="example-preformatted" data-language="cpp">a = ceil_div (b &amp; c, sizeof (int));
     → a = (b &amp; c + sizeof (int) - 1) / sizeof (int);</pre>
</div> <p>This does not do what is intended. The operator-precedence rules of C make it equivalent to this: </p> <div class="example smallexample"> <pre class="example-preformatted" data-language="cpp">a = (b &amp; (c + sizeof (int) - 1)) / sizeof (int);</pre>
</div> <p>What we want is this: </p> <div class="example smallexample"> <pre class="example-preformatted" data-language="cpp">a = ((b &amp; c) + sizeof (int) - 1)) / sizeof (int);</pre>
</div> <p>Defining the macro as </p> <div class="example smallexample"> <pre class="example-preformatted" data-language="cpp">#define ceil_div(x, y) ((x) + (y) - 1) / (y)</pre>
</div> <p>provides the desired result. </p> <p>Unintended grouping can result in another way. Consider <code class="code">sizeof
ceil_div(1, 2)</code>. That has the appearance of a C expression that would compute the size of the type of <code class="code">ceil_div (1, 2)</code>, but in fact it means something very different. Here is what it expands to: </p> <div class="example smallexample"> <pre class="example-preformatted" data-language="cpp">sizeof ((1) + (2) - 1) / (2)</pre>
</div> <p>This would take the size of an integer and divide it by two. The precedence rules have put the division outside the <code class="code">sizeof</code> when it was intended to be inside. </p> <p>Parentheses around the entire macro definition prevent such problems. Here, then, is the recommended way to define <code class="code">ceil_div</code>: </p> <div class="example smallexample"> <pre class="example-preformatted" data-language="cpp">#define ceil_div(x, y) (((x) + (y) - 1) / (y))</pre>
</div> </div>  <div class="nav-panel"> <p> Next: <a href="swallowing-the-semicolon.html">Swallowing the Semicolon</a>, Previous: <a href="misnesting.html">Misnesting</a>, Up: <a href="macro-pitfalls.html">Macro Pitfalls</a> [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="https://gcc.gnu.org/onlinedocs/gcc-13.1.0/cpp/Index-of-Directives.html" title="Index" rel="index">Index</a>]</p> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Free Software Foundation<br>Licensed under the GNU Free Documentation License, Version 1.3.<br>
    <a href="https://gcc.gnu.org/onlinedocs/gcc-13.1.0/cpp/Operator-Precedence-Problems.html" class="_attribution-link">https://gcc.gnu.org/onlinedocs/gcc-13.1.0/cpp/Operator-Precedence-Problems.html</a>
  </p>
</div>
