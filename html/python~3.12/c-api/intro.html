 <span id="api-intro"></span><h1>Introduction</h1> <p>The Application Programmer’s Interface to Python gives C and C++ programmers access to the Python interpreter at a variety of levels. The API is equally usable from C++, but for brevity it is generally referred to as the Python/C API. There are two fundamentally different reasons for using the Python/C API. The first reason is to write <em>extension modules</em> for specific purposes; these are C modules that extend the Python interpreter. This is probably the most common use. The second reason is to use Python as a component in a larger application; this technique is generally referred to as <em class="dfn">embedding</em> Python in an application.</p> <p>Writing an extension module is a relatively well-understood process, where a “cookbook” approach works well. There are several tools that automate the process to some extent. While people have embedded Python in other applications since its early existence, the process of embedding Python is less straightforward than writing an extension.</p> <p>Many API functions are useful independent of whether you’re embedding or extending Python; moreover, most applications that embed Python will need to provide a custom extension as well, so it’s probably a good idea to become familiar with writing an extension before attempting to embed Python in a real application.</p> <section id="coding-standards"> <h2>Coding standards</h2> <p>If you’re writing C code for inclusion in CPython, you <strong>must</strong> follow the guidelines and standards defined in <span class="target" id="index-0"></span><a class="pep reference external" href="https://peps.python.org/pep-0007/"><strong>PEP 7</strong></a>. These guidelines apply regardless of the version of Python you are contributing to. Following these conventions is not necessary for your own third party extension modules, unless you eventually expect to contribute them to Python.</p> </section> <section id="include-files"> <span id="api-includes"></span><h2>Include Files</h2> <p>All function, type and macro definitions needed to use the Python/C API are included in your code by the following line:</p> <pre data-language="c">#define PY_SSIZE_T_CLEAN
#include &lt;Python.h&gt;
</pre> <p>This implies inclusion of the following standard headers: <code>&lt;stdio.h&gt;</code>, <code>&lt;string.h&gt;</code>, <code>&lt;errno.h&gt;</code>, <code>&lt;limits.h&gt;</code>, <code>&lt;assert.h&gt;</code> and <code>&lt;stdlib.h&gt;</code> (if available).</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>Since Python may define some pre-processor definitions which affect the standard headers on some systems, you <em>must</em> include <code>Python.h</code> before any standard headers are included.</p> <p>It is recommended to always define <code>PY_SSIZE_T_CLEAN</code> before including <code>Python.h</code>. See <a class="reference internal" href="arg.html#arg-parsing"><span class="std std-ref">Parsing arguments and building values</span></a> for a description of this macro.</p> </div> <p>All user visible names defined by Python.h (except those defined by the included standard headers) have one of the prefixes <code>Py</code> or <code>_Py</code>. Names beginning with <code>_Py</code> are for internal use by the Python implementation and should not be used by extension writers. Structure member names do not have a reserved prefix.</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>User code should never define names that begin with <code>Py</code> or <code>_Py</code>. This confuses the reader, and jeopardizes the portability of the user code to future Python versions, which may define additional names beginning with one of these prefixes.</p> </div> <p>The header files are typically installed with Python. On Unix, these are located in the directories <code><em>prefix</em>/include/pythonversion/</code> and <code><em>exec_prefix</em>/include/pythonversion/</code>, where <a class="reference internal" href="../using/configure.html#cmdoption-prefix"><code>prefix</code></a> and <a class="reference internal" href="../using/configure.html#cmdoption-exec-prefix"><code>exec_prefix</code></a> are defined by the corresponding parameters to Python’s <strong class="program">configure</strong> script and <em>version</em> is <code>'%d.%d' % sys.version_info[:2]</code>. On Windows, the headers are installed in <code><em>prefix</em>/include</code>, where <code>prefix</code> is the installation directory specified to the installer.</p> <p>To include the headers, place both directories (if different) on your compiler’s search path for includes. Do <em>not</em> place the parent directories on the search path and then use <code>#include &lt;pythonX.Y/Python.h&gt;</code>; this will break on multi-platform builds since the platform independent headers under <a class="reference internal" href="../using/configure.html#cmdoption-prefix"><code>prefix</code></a> include the platform specific headers from <a class="reference internal" href="../using/configure.html#cmdoption-exec-prefix"><code>exec_prefix</code></a>.</p> <p>C++ users should note that although the API is defined entirely using C, the header files properly declare the entry points to be <code>extern "C"</code>. As a result, there is no need to do anything special to use the API from C++.</p> </section> <section id="useful-macros"> <h2>Useful macros</h2> <p>Several useful macros are defined in the Python header files. Many are defined closer to where they are useful (e.g. <a class="reference internal" href="none.html#c.Py_RETURN_NONE" title="Py_RETURN_NONE"><code>Py_RETURN_NONE</code></a>). Others of a more general utility are defined here. This is not necessarily a complete listing.</p> <dl class="c macro"> <dt class="sig sig-object c" id="c.PyMODINIT_FUNC">
<code>PyMODINIT_FUNC</code> </dt> <dd>
<p>Declare an extension module <code>PyInit</code> initialization function. The function return type is <span class="c-expr sig sig-inline c"><a class="reference internal" href="structures.html#c.PyObject" title="PyObject"><span class="n">PyObject</span></a><span class="p">*</span></span>. The macro declares any special linkage declarations required by the platform, and for C++ declares the function as <code>extern "C"</code>.</p> <p>The initialization function must be named <code>PyInit_<em>name</em></code>, where <em>name</em> is the name of the module, and should be the only non-<code>static</code> item defined in the module file. Example:</p> <pre data-language="c">static struct PyModuleDef spam_module = {
    PyModuleDef_HEAD_INIT,
    .m_name = "spam",
    ...
};

PyMODINIT_FUNC
PyInit_spam(void)
{
    return PyModule_Create(&amp;spam_module);
}
</pre> </dd>
</dl> <dl class="c macro"> <dt class="sig sig-object c" id="c.Py_ABS">
<code>Py_ABS(x)</code> </dt> <dd>
<p>Return the absolute value of <code>x</code>.</p> <div class="versionadded"> <p><span class="versionmodified added">New in version 3.3.</span></p> </div> </dd>
</dl> <dl class="c macro"> <dt class="sig sig-object c" id="c.Py_ALWAYS_INLINE">
<code>Py_ALWAYS_INLINE</code> </dt> <dd>
<p>Ask the compiler to always inline a static inline function. The compiler can ignore it and decides to not inline the function.</p> <p>It can be used to inline performance critical static inline functions when building Python in debug mode with function inlining disabled. For example, MSC disables function inlining when building in debug mode.</p> <p>Marking blindly a static inline function with Py_ALWAYS_INLINE can result in worse performances (due to increased code size for example). The compiler is usually smarter than the developer for the cost/benefit analysis.</p> <p>If Python is <a class="reference internal" href="../using/configure.html#debug-build"><span class="std std-ref">built in debug mode</span></a> (if the <code>Py_DEBUG</code> macro is defined), the <a class="reference internal" href="#c.Py_ALWAYS_INLINE" title="Py_ALWAYS_INLINE"><code>Py_ALWAYS_INLINE</code></a> macro does nothing.</p> <p>It must be specified before the function return type. Usage:</p> <pre data-language="c">static inline Py_ALWAYS_INLINE int random(void) { return 4; }
</pre> <div class="versionadded"> <p><span class="versionmodified added">New in version 3.11.</span></p> </div> </dd>
</dl> <dl class="c macro"> <dt class="sig sig-object c" id="c.Py_CHARMASK">
<code>Py_CHARMASK(c)</code> </dt> <dd>
<p>Argument must be a character or an integer in the range [-128, 127] or [0, 255]. This macro returns <code>c</code> cast to an <code>unsigned char</code>.</p> </dd>
</dl> <dl class="c macro"> <dt class="sig sig-object c" id="c.Py_DEPRECATED">
<code>Py_DEPRECATED(version)</code> </dt> <dd>
<p>Use this for deprecated declarations. The macro must be placed before the symbol name.</p> <p>Example:</p> <pre data-language="c">Py_DEPRECATED(3.8) PyAPI_FUNC(int) Py_OldFunction(void);
</pre> <div class="versionchanged"> <p><span class="versionmodified changed">Changed in version 3.8: </span>MSVC support was added.</p> </div> </dd>
</dl> <dl class="c macro"> <dt class="sig sig-object c" id="c.Py_GETENV">
<code>Py_GETENV(s)</code> </dt> <dd>
<p>Like <code>getenv(s)</code>, but returns <code>NULL</code> if <a class="reference internal" href="../using/cmdline.html#cmdoption-E"><code>-E</code></a> was passed on the command line (see <a class="reference internal" href="init_config.html#c.PyConfig.use_environment" title="PyConfig.use_environment"><code>PyConfig.use_environment</code></a>).</p> </dd>
</dl> <dl class="c macro"> <dt class="sig sig-object c" id="c.Py_MAX">
<code>Py_MAX(x, y)</code> </dt> <dd>
<p>Return the maximum value between <code>x</code> and <code>y</code>.</p> <div class="versionadded"> <p><span class="versionmodified added">New in version 3.3.</span></p> </div> </dd>
</dl> <dl class="c macro"> <dt class="sig sig-object c" id="c.Py_MEMBER_SIZE">
<code>Py_MEMBER_SIZE(type, member)</code> </dt> <dd>
<p>Return the size of a structure (<code>type</code>) <code>member</code> in bytes.</p> <div class="versionadded"> <p><span class="versionmodified added">New in version 3.6.</span></p> </div> </dd>
</dl> <dl class="c macro"> <dt class="sig sig-object c" id="c.Py_MIN">
<code>Py_MIN(x, y)</code> </dt> <dd>
<p>Return the minimum value between <code>x</code> and <code>y</code>.</p> <div class="versionadded"> <p><span class="versionmodified added">New in version 3.3.</span></p> </div> </dd>
</dl> <dl class="c macro"> <dt class="sig sig-object c" id="c.Py_NO_INLINE">
<code>Py_NO_INLINE</code> </dt> <dd>
<p>Disable inlining on a function. For example, it reduces the C stack consumption: useful on LTO+PGO builds which heavily inline code (see <a class="reference external" href="https://bugs.python.org/issue?@action=redirect&amp;bpo=33720">bpo-33720</a>).</p> <p>Usage:</p> <pre data-language="c">Py_NO_INLINE static int random(void) { return 4; }
</pre> <div class="versionadded"> <p><span class="versionmodified added">New in version 3.11.</span></p> </div> </dd>
</dl> <dl class="c macro"> <dt class="sig sig-object c" id="c.Py_STRINGIFY">
<code>Py_STRINGIFY(x)</code> </dt> <dd>
<p>Convert <code>x</code> to a C string. E.g. <code>Py_STRINGIFY(123)</code> returns <code>"123"</code>.</p> <div class="versionadded"> <p><span class="versionmodified added">New in version 3.4.</span></p> </div> </dd>
</dl> <dl class="c macro"> <dt class="sig sig-object c" id="c.Py_UNREACHABLE">
<code>Py_UNREACHABLE()</code> </dt> <dd>
<p>Use this when you have a code path that cannot be reached by design. For example, in the <code>default:</code> clause in a <code>switch</code> statement for which all possible values are covered in <code>case</code> statements. Use this in places where you might be tempted to put an <code>assert(0)</code> or <code>abort()</code> call.</p> <p>In release mode, the macro helps the compiler to optimize the code, and avoids a warning about unreachable code. For example, the macro is implemented with <code>__builtin_unreachable()</code> on GCC in release mode.</p> <p>A use for <code>Py_UNREACHABLE()</code> is following a call a function that never returns but that is not declared <code>_Py_NO_RETURN</code>.</p> <p>If a code path is very unlikely code but can be reached under exceptional case, this macro must not be used. For example, under low memory condition or if a system call returns a value out of the expected range. In this case, it’s better to report the error to the caller. If the error cannot be reported to caller, <a class="reference internal" href="sys.html#c.Py_FatalError" title="Py_FatalError"><code>Py_FatalError()</code></a> can be used.</p> <div class="versionadded"> <p><span class="versionmodified added">New in version 3.7.</span></p> </div> </dd>
</dl> <dl class="c macro"> <dt class="sig sig-object c" id="c.Py_UNUSED">
<code>Py_UNUSED(arg)</code> </dt> <dd>
<p>Use this for unused arguments in a function definition to silence compiler warnings. Example: <code>int func(int a, int Py_UNUSED(b)) { return a; }</code>.</p> <div class="versionadded"> <p><span class="versionmodified added">New in version 3.4.</span></p> </div> </dd>
</dl> <dl class="c macro"> <dt class="sig sig-object c" id="c.PyDoc_STRVAR">
<code>PyDoc_STRVAR(name, str)</code> </dt> <dd>
<p>Creates a variable with name <code>name</code> that can be used in docstrings. If Python is built without docstrings, the value will be empty.</p> <p>Use <a class="reference internal" href="#c.PyDoc_STRVAR" title="PyDoc_STRVAR"><code>PyDoc_STRVAR</code></a> for docstrings to support building Python without docstrings, as specified in <span class="target" id="index-1"></span><a class="pep reference external" href="https://peps.python.org/pep-0007/"><strong>PEP 7</strong></a>.</p> <p>Example:</p> <pre data-language="c">PyDoc_STRVAR(pop_doc, "Remove and return the rightmost element.");

static PyMethodDef deque_methods[] = {
    // ...
    {"pop", (PyCFunction)deque_pop, METH_NOARGS, pop_doc},
    // ...
}
</pre> </dd>
</dl> <dl class="c macro"> <dt class="sig sig-object c" id="c.PyDoc_STR">
<code>PyDoc_STR(str)</code> </dt> <dd>
<p>Creates a docstring for the given input string or an empty string if docstrings are disabled.</p> <p>Use <a class="reference internal" href="#c.PyDoc_STR" title="PyDoc_STR"><code>PyDoc_STR</code></a> in specifying docstrings to support building Python without docstrings, as specified in <span class="target" id="index-2"></span><a class="pep reference external" href="https://peps.python.org/pep-0007/"><strong>PEP 7</strong></a>.</p> <p>Example:</p> <pre data-language="c">static PyMethodDef pysqlite_row_methods[] = {
    {"keys", (PyCFunction)pysqlite_row_keys, METH_NOARGS,
        PyDoc_STR("Returns the keys of the row.")},
    {NULL, NULL}
};
</pre> </dd>
</dl> </section> <section id="objects-types-and-reference-counts"> <span id="api-objects"></span><h2>Objects, Types and Reference Counts</h2> <p id="index-3">Most Python/C API functions have one or more arguments as well as a return value of type <span class="c-expr sig sig-inline c"><a class="reference internal" href="structures.html#c.PyObject" title="PyObject"><span class="n">PyObject</span></a><span class="p">*</span></span>. This type is a pointer to an opaque data type representing an arbitrary Python object. Since all Python object types are treated the same way by the Python language in most situations (e.g., assignments, scope rules, and argument passing), it is only fitting that they should be represented by a single C type. Almost all Python objects live on the heap: you never declare an automatic or static variable of type <a class="reference internal" href="structures.html#c.PyObject" title="PyObject"><code>PyObject</code></a>, only pointer variables of type <span class="c-expr sig sig-inline c"><a class="reference internal" href="structures.html#c.PyObject" title="PyObject"><span class="n">PyObject</span></a><span class="p">*</span></span> can be declared. The sole exception are the type objects; since these must never be deallocated, they are typically static <a class="reference internal" href="type.html#c.PyTypeObject" title="PyTypeObject"><code>PyTypeObject</code></a> objects.</p> <p>All Python objects (even Python integers) have a <em class="dfn">type</em> and a <em class="dfn">reference count</em>. An object’s type determines what kind of object it is (e.g., an integer, a list, or a user-defined function; there are many more as explained in <a class="reference internal" href="../reference/datamodel.html#types"><span class="std std-ref">The standard type hierarchy</span></a>). For each of the well-known types there is a macro to check whether an object is of that type; for instance, <code>PyList_Check(a)</code> is true if (and only if) the object pointed to by <em>a</em> is a Python list.</p> <section id="reference-counts"> <span id="api-refcounts"></span><h3>Reference Counts</h3> <p>The reference count is important because today’s computers have a finite (and often severely limited) memory size; it counts how many different places there are that have a <a class="reference internal" href="../glossary.html#term-strong-reference"><span class="xref std std-term">strong reference</span></a> to an object. Such a place could be another object, or a global (or static) C variable, or a local variable in some C function. When the last <a class="reference internal" href="../glossary.html#term-strong-reference"><span class="xref std std-term">strong reference</span></a> to an object is released (i.e. its reference count becomes zero), the object is deallocated. If it contains references to other objects, those references are released. Those other objects may be deallocated in turn, if there are no more references to them, and so on. (There’s an obvious problem with objects that reference each other here; for now, the solution is “don’t do that.”)</p> <p id="index-4">Reference counts are always manipulated explicitly. The normal way is to use the macro <a class="reference internal" href="refcounting.html#c.Py_INCREF" title="Py_INCREF"><code>Py_INCREF()</code></a> to take a new reference to an object (i.e. increment its reference count by one), and <a class="reference internal" href="refcounting.html#c.Py_DECREF" title="Py_DECREF"><code>Py_DECREF()</code></a> to release that reference (i.e. decrement the reference count by one). The <a class="reference internal" href="refcounting.html#c.Py_DECREF" title="Py_DECREF"><code>Py_DECREF()</code></a> macro is considerably more complex than the incref one, since it must check whether the reference count becomes zero and then cause the object’s deallocator to be called. The deallocator is a function pointer contained in the object’s type structure. The type-specific deallocator takes care of releasing references for other objects contained in the object if this is a compound object type, such as a list, as well as performing any additional finalization that’s needed. There’s no chance that the reference count can overflow; at least as many bits are used to hold the reference count as there are distinct memory locations in virtual memory (assuming <code>sizeof(Py_ssize_t) &gt;= sizeof(void*)</code>). Thus, the reference count increment is a simple operation.</p> <p>It is not necessary to hold a <a class="reference internal" href="../glossary.html#term-strong-reference"><span class="xref std std-term">strong reference</span></a> (i.e. increment the reference count) for every local variable that contains a pointer to an object. In theory, the object’s reference count goes up by one when the variable is made to point to it and it goes down by one when the variable goes out of scope. However, these two cancel each other out, so at the end the reference count hasn’t changed. The only real reason to use the reference count is to prevent the object from being deallocated as long as our variable is pointing to it. If we know that there is at least one other reference to the object that lives at least as long as our variable, there is no need to take a new <a class="reference internal" href="../glossary.html#term-strong-reference"><span class="xref std std-term">strong reference</span></a> (i.e. increment the reference count) temporarily. An important situation where this arises is in objects that are passed as arguments to C functions in an extension module that are called from Python; the call mechanism guarantees to hold a reference to every argument for the duration of the call.</p> <p>However, a common pitfall is to extract an object from a list and hold on to it for a while without taking a new reference. Some other operation might conceivably remove the object from the list, releasing that reference, and possibly deallocating it. The real danger is that innocent-looking operations may invoke arbitrary Python code which could do this; there is a code path which allows control to flow back to the user from a <a class="reference internal" href="refcounting.html#c.Py_DECREF" title="Py_DECREF"><code>Py_DECREF()</code></a>, so almost any operation is potentially dangerous.</p> <p>A safe approach is to always use the generic operations (functions whose name begins with <code>PyObject_</code>, <code>PyNumber_</code>, <code>PySequence_</code> or <code>PyMapping_</code>). These operations always create a new <a class="reference internal" href="../glossary.html#term-strong-reference"><span class="xref std std-term">strong reference</span></a> (i.e. increment the reference count) of the object they return. This leaves the caller with the responsibility to call <a class="reference internal" href="refcounting.html#c.Py_DECREF" title="Py_DECREF"><code>Py_DECREF()</code></a> when they are done with the result; this soon becomes second nature.</p> <section id="reference-count-details"> <span id="api-refcountdetails"></span><h4>Reference Count Details</h4> <p>The reference count behavior of functions in the Python/C API is best explained in terms of <em>ownership of references</em>. Ownership pertains to references, never to objects (objects are not owned: they are always shared). “Owning a reference” means being responsible for calling Py_DECREF on it when the reference is no longer needed. Ownership can also be transferred, meaning that the code that receives ownership of the reference then becomes responsible for eventually releasing it by calling <a class="reference internal" href="refcounting.html#c.Py_DECREF" title="Py_DECREF"><code>Py_DECREF()</code></a> or <a class="reference internal" href="refcounting.html#c.Py_XDECREF" title="Py_XDECREF"><code>Py_XDECREF()</code></a> when it’s no longer needed—or passing on this responsibility (usually to its caller). When a function passes ownership of a reference on to its caller, the caller is said to receive a <em>new</em> reference. When no ownership is transferred, the caller is said to <em>borrow</em> the reference. Nothing needs to be done for a <a class="reference internal" href="../glossary.html#term-borrowed-reference"><span class="xref std std-term">borrowed reference</span></a>.</p> <p>Conversely, when a calling function passes in a reference to an object, there are two possibilities: the function <em>steals</em> a reference to the object, or it does not. <em>Stealing a reference</em> means that when you pass a reference to a function, that function assumes that it now owns that reference, and you are not responsible for it any longer.</p> <p id="index-5">Few functions steal references; the two notable exceptions are <a class="reference internal" href="list.html#c.PyList_SetItem" title="PyList_SetItem"><code>PyList_SetItem()</code></a> and <a class="reference internal" href="tuple.html#c.PyTuple_SetItem" title="PyTuple_SetItem"><code>PyTuple_SetItem()</code></a>, which steal a reference to the item (but not to the tuple or list into which the item is put!). These functions were designed to steal a reference because of a common idiom for populating a tuple or list with newly created objects; for example, the code to create the tuple <code>(1, 2, "three")</code> could look like this (forgetting about error handling for the moment; a better way to code this is shown below):</p> <pre data-language="c">PyObject *t;

t = PyTuple_New(3);
PyTuple_SetItem(t, 0, PyLong_FromLong(1L));
PyTuple_SetItem(t, 1, PyLong_FromLong(2L));
PyTuple_SetItem(t, 2, PyUnicode_FromString("three"));
</pre> <p>Here, <a class="reference internal" href="long.html#c.PyLong_FromLong" title="PyLong_FromLong"><code>PyLong_FromLong()</code></a> returns a new reference which is immediately stolen by <a class="reference internal" href="tuple.html#c.PyTuple_SetItem" title="PyTuple_SetItem"><code>PyTuple_SetItem()</code></a>. When you want to keep using an object although the reference to it will be stolen, use <a class="reference internal" href="refcounting.html#c.Py_INCREF" title="Py_INCREF"><code>Py_INCREF()</code></a> to grab another reference before calling the reference-stealing function.</p> <p>Incidentally, <a class="reference internal" href="tuple.html#c.PyTuple_SetItem" title="PyTuple_SetItem"><code>PyTuple_SetItem()</code></a> is the <em>only</em> way to set tuple items; <a class="reference internal" href="sequence.html#c.PySequence_SetItem" title="PySequence_SetItem"><code>PySequence_SetItem()</code></a> and <a class="reference internal" href="object.html#c.PyObject_SetItem" title="PyObject_SetItem"><code>PyObject_SetItem()</code></a> refuse to do this since tuples are an immutable data type. You should only use <a class="reference internal" href="tuple.html#c.PyTuple_SetItem" title="PyTuple_SetItem"><code>PyTuple_SetItem()</code></a> for tuples that you are creating yourself.</p> <p>Equivalent code for populating a list can be written using <a class="reference internal" href="list.html#c.PyList_New" title="PyList_New"><code>PyList_New()</code></a> and <a class="reference internal" href="list.html#c.PyList_SetItem" title="PyList_SetItem"><code>PyList_SetItem()</code></a>.</p> <p>However, in practice, you will rarely use these ways of creating and populating a tuple or list. There’s a generic function, <a class="reference internal" href="arg.html#c.Py_BuildValue" title="Py_BuildValue"><code>Py_BuildValue()</code></a>, that can create most common objects from C values, directed by a <em class="dfn">format string</em>. For example, the above two blocks of code could be replaced by the following (which also takes care of the error checking):</p> <pre data-language="c">PyObject *tuple, *list;

tuple = Py_BuildValue("(iis)", 1, 2, "three");
list = Py_BuildValue("[iis]", 1, 2, "three");
</pre> <p>It is much more common to use <a class="reference internal" href="object.html#c.PyObject_SetItem" title="PyObject_SetItem"><code>PyObject_SetItem()</code></a> and friends with items whose references you are only borrowing, like arguments that were passed in to the function you are writing. In that case, their behaviour regarding references is much saner, since you don’t have to take a new reference just so you can give that reference away (“have it be stolen”). For example, this function sets all items of a list (actually, any mutable sequence) to a given item:</p> <pre data-language="c">int
set_all(PyObject *target, PyObject *item)
{
    Py_ssize_t i, n;

    n = PyObject_Length(target);
    if (n &lt; 0)
        return -1;
    for (i = 0; i &lt; n; i++) {
        PyObject *index = PyLong_FromSsize_t(i);
        if (!index)
            return -1;
        if (PyObject_SetItem(target, index, item) &lt; 0) {
            Py_DECREF(index);
            return -1;
        }
        Py_DECREF(index);
    }
    return 0;
}
</pre> <p id="index-6">The situation is slightly different for function return values. While passing a reference to most functions does not change your ownership responsibilities for that reference, many functions that return a reference to an object give you ownership of the reference. The reason is simple: in many cases, the returned object is created on the fly, and the reference you get is the only reference to the object. Therefore, the generic functions that return object references, like <a class="reference internal" href="object.html#c.PyObject_GetItem" title="PyObject_GetItem"><code>PyObject_GetItem()</code></a> and <a class="reference internal" href="sequence.html#c.PySequence_GetItem" title="PySequence_GetItem"><code>PySequence_GetItem()</code></a>, always return a new reference (the caller becomes the owner of the reference).</p> <p>It is important to realize that whether you own a reference returned by a function depends on which function you call only — <em>the plumage</em> (the type of the object passed as an argument to the function) <em>doesn’t enter into it!</em> Thus, if you extract an item from a list using <a class="reference internal" href="list.html#c.PyList_GetItem" title="PyList_GetItem"><code>PyList_GetItem()</code></a>, you don’t own the reference — but if you obtain the same item from the same list using <a class="reference internal" href="sequence.html#c.PySequence_GetItem" title="PySequence_GetItem"><code>PySequence_GetItem()</code></a> (which happens to take exactly the same arguments), you do own a reference to the returned object.</p> <p id="index-7">Here is an example of how you could write a function that computes the sum of the items in a list of integers; once using <a class="reference internal" href="list.html#c.PyList_GetItem" title="PyList_GetItem"><code>PyList_GetItem()</code></a>, and once using <a class="reference internal" href="sequence.html#c.PySequence_GetItem" title="PySequence_GetItem"><code>PySequence_GetItem()</code></a>.</p> <pre data-language="c">long
sum_list(PyObject *list)
{
    Py_ssize_t i, n;
    long total = 0, value;
    PyObject *item;

    n = PyList_Size(list);
    if (n &lt; 0)
        return -1; /* Not a list */
    for (i = 0; i &lt; n; i++) {
        item = PyList_GetItem(list, i); /* Can't fail */
        if (!PyLong_Check(item)) continue; /* Skip non-integers */
        value = PyLong_AsLong(item);
        if (value == -1 &amp;&amp; PyErr_Occurred())
            /* Integer too big to fit in a C long, bail out */
            return -1;
        total += value;
    }
    return total;
}
</pre> <pre data-language="c">long
sum_sequence(PyObject *sequence)
{
    Py_ssize_t i, n;
    long total = 0, value;
    PyObject *item;
    n = PySequence_Length(sequence);
    if (n &lt; 0)
        return -1; /* Has no length */
    for (i = 0; i &lt; n; i++) {
        item = PySequence_GetItem(sequence, i);
        if (item == NULL)
            return -1; /* Not a sequence, or other failure */
        if (PyLong_Check(item)) {
            value = PyLong_AsLong(item);
            Py_DECREF(item);
            if (value == -1 &amp;&amp; PyErr_Occurred())
                /* Integer too big to fit in a C long, bail out */
                return -1;
            total += value;
        }
        else {
            Py_DECREF(item); /* Discard reference ownership */
        }
    }
    return total;
}
</pre> </section> </section> <section id="types"> <span id="api-types"></span><span id="index-9"></span><h3>Types</h3> <p>There are few other data types that play a significant role in the Python/C API; most are simple C types such as <span class="c-expr sig sig-inline c"><span class="kt">int</span></span>, <span class="c-expr sig sig-inline c"><span class="kt">long</span></span>, <span class="c-expr sig sig-inline c"><span class="kt">double</span></span> and <span class="c-expr sig sig-inline c"><span class="kt">char</span><span class="p">*</span></span>. A few structure types are used to describe static tables used to list the functions exported by a module or the data attributes of a new object type, and another is used to describe the value of a complex number. These will be discussed together with the functions that use them.</p> <dl class="c type"> <dt class="sig sig-object c" id="c.Py_ssize_t">
<code>type Py_ssize_t</code> </dt> <dd>
<em class="stableabi"> Part of the <a class="reference internal" href="stable.html#stable"><span class="std std-ref">Stable ABI</span></a>.</em><p>A signed integral type such that <code>sizeof(Py_ssize_t) == sizeof(size_t)</code>. C99 doesn’t define such a thing directly (size_t is an unsigned integral type). See <span class="target" id="index-10"></span><a class="pep reference external" href="https://peps.python.org/pep-0353/"><strong>PEP 353</strong></a> for details. <code>PY_SSIZE_T_MAX</code> is the largest positive value of type <a class="reference internal" href="#c.Py_ssize_t" title="Py_ssize_t"><code>Py_ssize_t</code></a>.</p> </dd>
</dl> </section> </section> <section id="exceptions"> <span id="api-exceptions"></span><h2>Exceptions</h2> <p>The Python programmer only needs to deal with exceptions if specific error handling is required; unhandled exceptions are automatically propagated to the caller, then to the caller’s caller, and so on, until they reach the top-level interpreter, where they are reported to the user accompanied by a stack traceback.</p> <p id="index-11">For C programmers, however, error checking always has to be explicit. All functions in the Python/C API can raise exceptions, unless an explicit claim is made otherwise in a function’s documentation. In general, when a function encounters an error, it sets an exception, discards any object references that it owns, and returns an error indicator. If not documented otherwise, this indicator is either <code>NULL</code> or <code>-1</code>, depending on the function’s return type. A few functions return a Boolean true/false result, with false indicating an error. Very few functions return no explicit error indicator or have an ambiguous return value, and require explicit testing for errors with <a class="reference internal" href="exceptions.html#c.PyErr_Occurred" title="PyErr_Occurred"><code>PyErr_Occurred()</code></a>. These exceptions are always explicitly documented.</p> <p id="index-12">Exception state is maintained in per-thread storage (this is equivalent to using global storage in an unthreaded application). A thread can be in one of two states: an exception has occurred, or not. The function <a class="reference internal" href="exceptions.html#c.PyErr_Occurred" title="PyErr_Occurred"><code>PyErr_Occurred()</code></a> can be used to check for this: it returns a borrowed reference to the exception type object when an exception has occurred, and <code>NULL</code> otherwise. There are a number of functions to set the exception state: <a class="reference internal" href="exceptions.html#c.PyErr_SetString" title="PyErr_SetString"><code>PyErr_SetString()</code></a> is the most common (though not the most general) function to set the exception state, and <a class="reference internal" href="exceptions.html#c.PyErr_Clear" title="PyErr_Clear"><code>PyErr_Clear()</code></a> clears the exception state.</p> <p>The full exception state consists of three objects (all of which can be <code>NULL</code>): the exception type, the corresponding exception value, and the traceback. These have the same meanings as the Python result of <code>sys.exc_info()</code>; however, they are not the same: the Python objects represent the last exception being handled by a Python <a class="reference internal" href="../reference/compound_stmts.html#try"><code>try</code></a> … <a class="reference internal" href="../reference/compound_stmts.html#except"><code>except</code></a> statement, while the C level exception state only exists while an exception is being passed on between C functions until it reaches the Python bytecode interpreter’s main loop, which takes care of transferring it to <code>sys.exc_info()</code> and friends.</p> <p id="index-13">Note that starting with Python 1.5, the preferred, thread-safe way to access the exception state from Python code is to call the function <a class="reference internal" href="../library/sys.html#sys.exc_info" title="sys.exc_info"><code>sys.exc_info()</code></a>, which returns the per-thread exception state for Python code. Also, the semantics of both ways to access the exception state have changed so that a function which catches an exception will save and restore its thread’s exception state so as to preserve the exception state of its caller. This prevents common bugs in exception handling code caused by an innocent-looking function overwriting the exception being handled; it also reduces the often unwanted lifetime extension for objects that are referenced by the stack frames in the traceback.</p> <p>As a general principle, a function that calls another function to perform some task should check whether the called function raised an exception, and if so, pass the exception state on to its caller. It should discard any object references that it owns, and return an error indicator, but it should <em>not</em> set another exception — that would overwrite the exception that was just raised, and lose important information about the exact cause of the error.</p> <p id="index-14">A simple example of detecting exceptions and passing them on is shown in the <code>sum_sequence()</code> example above. It so happens that this example doesn’t need to clean up any owned references when it detects an error. The following example function shows some error cleanup. First, to remind you why you like Python, we show the equivalent Python code:</p> <pre data-language="c">def incr_item(dict, key):
    try:
        item = dict[key]
    except KeyError:
        item = 0
    dict[key] = item + 1
</pre> <p id="index-15">Here is the corresponding C code, in all its glory:</p> <pre data-language="c">int
incr_item(PyObject *dict, PyObject *key)
{
    /* Objects all initialized to NULL for Py_XDECREF */
    PyObject *item = NULL, *const_one = NULL, *incremented_item = NULL;
    int rv = -1; /* Return value initialized to -1 (failure) */

    item = PyObject_GetItem(dict, key);
    if (item == NULL) {
        /* Handle KeyError only: */
        if (!PyErr_ExceptionMatches(PyExc_KeyError))
            goto error;

        /* Clear the error and use zero: */
        PyErr_Clear();
        item = PyLong_FromLong(0L);
        if (item == NULL)
            goto error;
    }
    const_one = PyLong_FromLong(1L);
    if (const_one == NULL)
        goto error;

    incremented_item = PyNumber_Add(item, const_one);
    if (incremented_item == NULL)
        goto error;

    if (PyObject_SetItem(dict, key, incremented_item) &lt; 0)
        goto error;
    rv = 0; /* Success */
    /* Continue with cleanup code */

 error:
    /* Cleanup code, shared by success and failure path */

    /* Use Py_XDECREF() to ignore NULL references */
    Py_XDECREF(item);
    Py_XDECREF(const_one);
    Py_XDECREF(incremented_item);

    return rv; /* -1 for error, 0 for success */
}
</pre> <span class="target" id="index-16"></span><p id="index-17">This example represents an endorsed use of the <code>goto</code> statement in C! It illustrates the use of <a class="reference internal" href="exceptions.html#c.PyErr_ExceptionMatches" title="PyErr_ExceptionMatches"><code>PyErr_ExceptionMatches()</code></a> and <a class="reference internal" href="exceptions.html#c.PyErr_Clear" title="PyErr_Clear"><code>PyErr_Clear()</code></a> to handle specific exceptions, and the use of <a class="reference internal" href="refcounting.html#c.Py_XDECREF" title="Py_XDECREF"><code>Py_XDECREF()</code></a> to dispose of owned references that may be <code>NULL</code> (note the <code>'X'</code> in the name; <a class="reference internal" href="refcounting.html#c.Py_DECREF" title="Py_DECREF"><code>Py_DECREF()</code></a> would crash when confronted with a <code>NULL</code> reference). It is important that the variables used to hold owned references are initialized to <code>NULL</code> for this to work; likewise, the proposed return value is initialized to <code>-1</code> (failure) and only set to success after the final call made is successful.</p> </section> <section id="embedding-python"> <span id="api-embedding"></span><h2>Embedding Python</h2> <p>The one important task that only embedders (as opposed to extension writers) of the Python interpreter have to worry about is the initialization, and possibly the finalization, of the Python interpreter. Most functionality of the interpreter can only be used after the interpreter has been initialized.</p> <p id="index-18">The basic initialization function is <a class="reference internal" href="init.html#c.Py_Initialize" title="Py_Initialize"><code>Py_Initialize()</code></a>. This initializes the table of loaded modules, and creates the fundamental modules <a class="reference internal" href="../library/builtins.html#module-builtins" title="builtins: The module that provides the built-in namespace."><code>builtins</code></a>, <a class="reference internal" href="../library/__main__.html#module-__main__" title="__main__: The environment where top-level code is run. Covers command-line interfaces, import-time behavior, and ``__name__ == '__main__'``."><code>__main__</code></a>, and <a class="reference internal" href="../library/sys.html#module-sys" title="sys: Access system-specific parameters and functions."><code>sys</code></a>. It also initializes the module search path (<code>sys.path</code>).</p> <p><a class="reference internal" href="init.html#c.Py_Initialize" title="Py_Initialize"><code>Py_Initialize()</code></a> does not set the “script argument list” (<code>sys.argv</code>). If this variable is needed by Python code that will be executed later, setting <a class="reference internal" href="init_config.html#c.PyConfig.argv" title="PyConfig.argv"><code>PyConfig.argv</code></a> and <a class="reference internal" href="init_config.html#c.PyConfig.parse_argv" title="PyConfig.parse_argv"><code>PyConfig.parse_argv</code></a> must be set: see <a class="reference internal" href="init_config.html#init-config"><span class="std std-ref">Python Initialization Configuration</span></a>.</p> <p>On most systems (in particular, on Unix and Windows, although the details are slightly different), <a class="reference internal" href="init.html#c.Py_Initialize" title="Py_Initialize"><code>Py_Initialize()</code></a> calculates the module search path based upon its best guess for the location of the standard Python interpreter executable, assuming that the Python library is found in a fixed location relative to the Python interpreter executable. In particular, it looks for a directory named <code>lib/python<em>X.Y</em></code> relative to the parent directory where the executable named <code>python</code> is found on the shell command search path (the environment variable <span class="target" id="index-19"></span><code>PATH</code>).</p> <p>For instance, if the Python executable is found in <code>/usr/local/bin/python</code>, it will assume that the libraries are in <code>/usr/local/lib/python<em>X.Y</em></code>. (In fact, this particular path is also the “fallback” location, used when no executable file named <code>python</code> is found along <span class="target" id="index-20"></span><code>PATH</code>.) The user can override this behavior by setting the environment variable <span class="target" id="index-21"></span><a class="reference internal" href="../using/cmdline.html#envvar-PYTHONHOME"><code>PYTHONHOME</code></a>, or insert additional directories in front of the standard path by setting <span class="target" id="index-22"></span><a class="reference internal" href="../using/cmdline.html#envvar-PYTHONPATH"><code>PYTHONPATH</code></a>.</p> <p id="index-23">The embedding application can steer the search by calling <code>Py_SetProgramName(file)</code> <em>before</em> calling <a class="reference internal" href="init.html#c.Py_Initialize" title="Py_Initialize"><code>Py_Initialize()</code></a>. Note that <span class="target" id="index-24"></span><a class="reference internal" href="../using/cmdline.html#envvar-PYTHONHOME"><code>PYTHONHOME</code></a> still overrides this and <span class="target" id="index-25"></span><a class="reference internal" href="../using/cmdline.html#envvar-PYTHONPATH"><code>PYTHONPATH</code></a> is still inserted in front of the standard path. An application that requires total control has to provide its own implementation of <a class="reference internal" href="init.html#c.Py_GetPath" title="Py_GetPath"><code>Py_GetPath()</code></a>, <a class="reference internal" href="init.html#c.Py_GetPrefix" title="Py_GetPrefix"><code>Py_GetPrefix()</code></a>, <a class="reference internal" href="init.html#c.Py_GetExecPrefix" title="Py_GetExecPrefix"><code>Py_GetExecPrefix()</code></a>, and <a class="reference internal" href="init.html#c.Py_GetProgramFullPath" title="Py_GetProgramFullPath"><code>Py_GetProgramFullPath()</code></a> (all defined in <code>Modules/getpath.c</code>).</p> <p id="index-26">Sometimes, it is desirable to “uninitialize” Python. For instance, the application may want to start over (make another call to <a class="reference internal" href="init.html#c.Py_Initialize" title="Py_Initialize"><code>Py_Initialize()</code></a>) or the application is simply done with its use of Python and wants to free memory allocated by Python. This can be accomplished by calling <a class="reference internal" href="init.html#c.Py_FinalizeEx" title="Py_FinalizeEx"><code>Py_FinalizeEx()</code></a>. The function <a class="reference internal" href="init.html#c.Py_IsInitialized" title="Py_IsInitialized"><code>Py_IsInitialized()</code></a> returns true if Python is currently in the initialized state. More information about these functions is given in a later chapter. Notice that <a class="reference internal" href="init.html#c.Py_FinalizeEx" title="Py_FinalizeEx"><code>Py_FinalizeEx()</code></a> does <em>not</em> free all memory allocated by the Python interpreter, e.g. memory allocated by extension modules currently cannot be released.</p> </section> <section id="debugging-builds"> <span id="api-debugging"></span><h2>Debugging Builds</h2> <p>Python can be built with several macros to enable extra checks of the interpreter and extension modules. These checks tend to add a large amount of overhead to the runtime so they are not enabled by default.</p> <p>A full list of the various types of debugging builds is in the file <code>Misc/SpecialBuilds.txt</code> in the Python source distribution. Builds are available that support tracing of reference counts, debugging the memory allocator, or low-level profiling of the main interpreter loop. Only the most frequently used builds will be described in the remainder of this section.</p> <p>Compiling the interpreter with the <code>Py_DEBUG</code> macro defined produces what is generally meant by <a class="reference internal" href="../using/configure.html#debug-build"><span class="std std-ref">a debug build of Python</span></a>. <code>Py_DEBUG</code> is enabled in the Unix build by adding <a class="reference internal" href="../using/configure.html#cmdoption-with-pydebug"><code>--with-pydebug</code></a> to the <code>./configure</code> command. It is also implied by the presence of the not-Python-specific <code>_DEBUG</code> macro. When <code>Py_DEBUG</code> is enabled in the Unix build, compiler optimization is disabled.</p> <p>In addition to the reference count debugging described below, extra checks are performed, see <a class="reference internal" href="../using/configure.html#debug-build"><span class="std std-ref">Python Debug Build</span></a>.</p> <p>Defining <code>Py_TRACE_REFS</code> enables reference tracing (see the <a class="reference internal" href="../using/configure.html#cmdoption-with-trace-refs"><code>configure --with-trace-refs option</code></a>). When defined, a circular doubly linked list of active objects is maintained by adding two extra fields to every <a class="reference internal" href="structures.html#c.PyObject" title="PyObject"><code>PyObject</code></a>. Total allocations are tracked as well. Upon exit, all existing references are printed. (In interactive mode this happens after every statement run by the interpreter.)</p> <p>Please refer to <code>Misc/SpecialBuilds.txt</code> in the Python source distribution for more detailed information.</p> </section> <div class="_attribution">
  <p class="_attribution-p">
    &copy; 2001&ndash;2023 Python Software Foundation<br>Licensed under the PSF License.<br>
    <a href="https://docs.python.org/3.12/c-api/intro.html" class="_attribution-link">https://docs.python.org/3.12/c-api/intro.html</a>
  </p>
</div>
