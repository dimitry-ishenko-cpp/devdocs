<h1>Requests::compatible_gzinflate( string $gz_data ): string|bool</h1>  <section> <p>Decompression of deflated string while staying compatible with the majority of servers.</p> </section>   <section> <header class="toc-header"><h2 id="description">Description</h2></header> <p>Certain Servers will return deflated data with headers which PHP’s gzinflate() function cannot handle out of the box. The following function has been created from various snippets on the gzinflate() PHP documentation.</p> <p>Warning: Magic numbers within. Due to the potential different formats that the compressed data may be returned in, some "magic offsets" are needed to ensure proper decompression takes place. For a simple progmatic way to determine the magic offset in use, see: <a href="https://core.trac.wordpress.org/ticket/18273">https://core.trac.wordpress.org/ticket/18273</a></p> </section>  <section> <header class="toc-header"><h2 id="parameters">Parameters</h2></header> <dl> <dt> <code>$gz_data</code> <span class="type"><span class="string">string</span></span> <span class="required">Required</span> </dt> <dd> <div class="desc"> <span class="description">String to decompress.</span> </div> </dd> </dl> </section>  <section> <header class="toc-header"><h2 id="return">Return</h2></header> <p><span class="return-type">string|bool</span> False on failure.</p> </section>  <section> <header class="toc-header"><h2 id="source">Source</h2></header> <p> File: <code>wp-includes/class-requests.php</code>. <a href="https://developer.wordpress.org/reference/files/wp-includes/class-requests.php/">View all references</a> </p> <pre class="wp-block-code" data-start="882" aria-label="Function source code" data-language="php"><code lang="php" class="language-php line-numbers">public static function compatible_gzinflate($gz_data) {
	// Compressed data might contain a full zlib header, if so strip it for
	// gzinflate()
	if (substr($gz_data, 0, 3) === "\x1f\x8b\x08") {
		$i   = 10;
		$flg = ord(substr($gz_data, 3, 1));
		if ($flg &gt; 0) {
			if ($flg &amp; 4) {
				list($xlen) = unpack('v', substr($gz_data, $i, 2));
				$i         += 2 + $xlen;
			}
			if ($flg &amp; 8) {
				$i = strpos($gz_data, "\0", $i) + 1;
			}
			if ($flg &amp; 16) {
				$i = strpos($gz_data, "\0", $i) + 1;
			}
			if ($flg &amp; 2) {
				$i += 2;
			}
		}
		$decompressed = self::compatible_gzinflate(substr($gz_data, $i));
		if ($decompressed !== false) {
			return $decompressed;
		}
	}

	// If the data is Huffman Encoded, we must first strip the leading 2
	// byte Huffman marker for gzinflate()
	// The response is Huffman coded by many compressors such as
	// java.util.zip.Deflater, Ruby’s Zlib::Deflate, and .NET's
	// System.IO.Compression.DeflateStream.
	//
	// See https://decompres.blogspot.com/ for a quick explanation of this
	// data type
	$huffman_encoded = false;

	// low nibble of first byte should be 0x08
	list(, $first_nibble) = unpack('h', $gz_data);

	// First 2 bytes should be divisible by 0x1F
	list(, $first_two_bytes) = unpack('n', $gz_data);

	if ($first_nibble === 0x08 &amp;&amp; ($first_two_bytes % 0x1F) === 0) {
		$huffman_encoded = true;
	}

	if ($huffman_encoded) {
		$decompressed = @gzinflate(substr($gz_data, 2));
		if ($decompressed !== false) {
			return $decompressed;
		}
	}

	if (substr($gz_data, 0, 4) === "\x50\x4b\x03\x04") {
		// ZIP file format header
		// Offset 6: 2 bytes, General-purpose field
		// Offset 26: 2 bytes, filename length
		// Offset 28: 2 bytes, optional field length
		// Offset 30: Filename field, followed by optional field, followed
		// immediately by data
		list(, $general_purpose_flag) = unpack('v', substr($gz_data, 6, 2));

		// If the file has been compressed on the fly, 0x08 bit is set of
		// the general purpose field. We can use this to differentiate
		// between a compressed document, and a ZIP file
		$zip_compressed_on_the_fly = ((0x08 &amp; $general_purpose_flag) === 0x08);

		if (!$zip_compressed_on_the_fly) {
			// Don't attempt to decode a compressed zip file
			return $gz_data;
		}

		// Determine the first byte of data, based on the above ZIP header
		// offsets:
		$first_file_start = array_sum(unpack('v2', substr($gz_data, 26, 4)));
		$decompressed     = @gzinflate(substr($gz_data, 30 + $first_file_start));
		if ($decompressed !== false) {
			return $decompressed;
		}
		return false;
	}

	// Finally fall back to straight gzinflate
	$decompressed = @gzinflate($gz_data);
	if ($decompressed !== false) {
		return $decompressed;
	}

	// Fallback for all above failing, not expected, but included for
	// debugging and preventing regressions and to track stats
	$decompressed = @gzinflate(substr($gz_data, 2));
	if ($decompressed !== false) {
		return $decompressed;
	}

	return false;
}
</code></pre>  </section>  <section> <header class="toc-header"><h2 id="related">Related</h2></header> <article class="uses"> <header class="toc-header"><h3 id="uses">Uses</h3></header> <table id="uses-table" data-show="2">  <thead> <tr> <th>Uses</th> <th class="related-desc">Description</th> </tr> </thead> <tbody> <tr> <td class="related-title"> <a href="compatible_gzinflate.html">Requests::compatible_gzinflate()</a> <span>wp-includes/class-requests.php</span> </td> <td class="related-desc"> <p>Decompression of deflated string while staying compatible with the majority of servers.</p> </td> </tr> </tbody>

</table> </article> <article class="used-by"> <header class="toc-header"><h3 id="used-by">Used By</h3></header> <table id="used-by-table" data-show="5">  <thead> <tr> <th>Used By</th> <th class="related-desc">Description</th> </tr> </thead> <tbody> <tr> <td class="related-title"> <a href="compatible_gzinflate.html">Requests::compatible_gzinflate()</a> <span>wp-includes/class-requests.php</span> </td> <td class="related-desc"> <p>Decompression of deflated string while staying compatible with the majority of servers.</p> </td> </tr> <tr> <td class="related-title"> <a href="decompress.html">Requests::decompress()</a> <span>wp-includes/class-requests.php</span> </td> <td class="related-desc"> <p>Decompress an encoded body</p> </td> </tr> </tbody>

</table> </article> </section>  <section> <header class="toc-header"><h2 id="changelog">Changelog</h2></header> <table>  <thead> <tr> <th class="changelog-version">Version</th> <th class="changelog-desc">Description</th> </tr> </thead> <tbody> <tr> <td><a href="https://developer.wordpress.org/reference/since/2.8.1/" alt="WordPress 2.8.1">2.8.1</a></td> <td>Introduced.</td> </tr> </tbody> </table> </section><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2003&ndash;2022 WordPress Foundation<br>Licensed under the GNU GPLv2+ License.<br>
    <a href="https://developer.wordpress.org/reference/classes/requests/compatible_gzinflate" class="_attribution-link">https://developer.wordpress.org/reference/classes/requests/compatible_gzinflate</a>
  </p>
</div>
