<h1 class="wp-block-wporg-code-reference-title">WP_User_Query::prepare_query( <span class="arg-type">string|array</span> <span class="arg-name">$query</span> = <span class="arg-default">array()</span> )</h1> <section><p>Prepares the query variables.</p> </section> <section><h2 id="parameters">Parameters</h2> <dl>
<dt>
<code>$query</code><span class="type"><span class="string">string</span>|<span class="array">array</span></span><span class="required">optional</span>
</dt>
<dd>
<div class="desc"><span class="description">Array or string of query parameters.<br> <ul class="param-hash">
<li>
<code>blog_id</code> <span class="type">int</span><div class="desc">The site ID. Default is the current site.</div>
</li> <li>
<code>role</code> <span class="type">string|string[]</span><div class="desc">An array or a comma-separated list of role names that users must match to be included in results. Note that this is an inclusive list: users must match *each* role. </div>
</li> <li>
<code>role__in</code> <span class="type">string[]</span><div class="desc">An array of role names. Matched users must have at least one of these roles. </div>
</li> <li>
<code>role__not_in</code> <span class="type">string[]</span><div class="desc">An array of role names to exclude. Users matching one or more of these roles will not be included in results. </div>
</li> <li>
<code>meta_key</code> <span class="type">string|string[]</span><div class="desc">Meta key or keys to filter by.</div>
</li> <li>
<code>meta_value</code> <span class="type">string|string[]</span><div class="desc">Meta value or values to filter by.</div>
</li> <li>
<code>meta_compare</code> <span class="type">string</span><div class="desc">MySQL operator used for comparing the meta value.<br> See WP_Meta_Query::__construct() for accepted values and default value.</div>
</li> <li>
<code>meta_compare_key</code> <span class="type">string</span><div class="desc">MySQL operator used for comparing the meta key.<br> See WP_Meta_Query::__construct() for accepted values and default value.</div>
</li> <li>
<code>meta_type</code> <span class="type">string</span><div class="desc">MySQL data type that the meta_value column will be CAST to for comparisons.<br> See WP_Meta_Query::__construct() for accepted values and default value.</div>
</li> <li>
<code>meta_type_key</code> <span class="type">string</span><div class="desc">MySQL data type that the meta_key column will be CAST to for comparisons.<br> See WP_Meta_Query::__construct() for accepted values and default value.</div>
</li> <li>
<code>meta_query</code> <span class="type">array</span><div class="desc">An associative array of <a href="../wp_meta_query.html" rel="class">WP_Meta_Query</a> arguments.<br> See WP_Meta_Query::__construct() for accepted values.</div>
</li> <li>
<code>capability</code> <span class="type">string|string[]</span><div class="desc">An array or a comma-separated list of capability names that users must match to be included in results. Note that this is an inclusive list: users must match *each* capability.<br> Does NOT work for capabilities not in the database or filtered via <a href="../../hooks/map_meta_cap.html">'map_meta_cap'</a>. </div>
</li> <li>
<code>capability__in</code> <span class="type">string[]</span><div class="desc">An array of capability names. Matched users must have at least one of these capabilities.<br> Does NOT work for capabilities not in the database or filtered via <a href="../../hooks/map_meta_cap.html">'map_meta_cap'</a>. </div>
</li> <li>
<code>capability__not_in</code> <span class="type">string[]</span><div class="desc">An array of capability names to exclude. Users matching one or more of these capabilities will not be included in results.<br> Does NOT work for capabilities not in the database or filtered via <a href="../../hooks/map_meta_cap.html">'map_meta_cap'</a>. </div>
</li> <li>
<code>include</code> <span class="type">int[]</span><div class="desc">An array of user IDs to include. </div>
</li> <li>
<code>exclude</code> <span class="type">int[]</span><div class="desc">An array of user IDs to exclude. </div>
</li> <li>
<code>search</code> <span class="type">string</span><div class="desc">Search keyword. Searches for possible string matches on columns.<br> When <code>$search_columns</code> is left empty, it tries to determine which column to search in based on search string. </div>
</li> <li>
<code>search_columns</code> <span class="type">string[]</span><div class="desc">Array of column names to be searched. Accepts <code>'ID'</code>, <code>'user_login'</code>, <code>'user_email'</code>, <code>'user_url'</code>, <code>'user_nicename'</code>, <code>'display_name'</code>.<br> </div>
</li> <li>
<code>orderby</code> <span class="type">string|array</span><div class="desc">Field(s) to sort the retrieved users by. May be a single value, an array of values, or a multi-dimensional array with fields as keys and orders (<code>'ASC'</code> or <code>'DESC'</code>) as values. Accepted values are:<br> <ul>
<li><code>'ID'</code></li> <li>
<code>'display_name'</code> (or <code>'name'</code>)</li> <li><code>'include'</code></li> <li>
<code>'user_login'</code> (or <code>'login'</code>)</li> <li><code>'login__in'</code></li> <li>
<code>'user_nicename'</code> (or <code>'nicename'</code>)</li> <li><code>'nicename__in'</code></li> <li>â€˜user_email (or <code>'email'</code>)</li> <li>
<code>'user_url'</code> (or <code>'url'</code>)</li> <li>
<code>'user_registered'</code> (or <code>'registered'</code>)</li> <li><code>'post_count'</code></li> <li><code>'meta_value'</code></li> <li><code>'meta_value_num'</code></li> <li>The value of <code>$meta_key</code>
</li> <li>An array key of <code>$meta_query</code> To use <code>'meta_value'</code> or <code>'meta_value_num'</code>, <code>$meta_key</code> must be also be defined. Default <code>'user_login'</code>.</li>
</ul>
</div>
</li> <li>
<code>order</code> <span class="type">string</span><div class="desc">Designates ascending or descending order of users. Order values passed as part of an <code>$orderby</code> array take precedence over this parameter. Accepts <code>'ASC'</code>, <code>'DESC'</code>. Default <code>'ASC'</code>.</div>
</li> <li>
<code>offset</code> <span class="type">int</span><div class="desc">Number of users to offset in retrieved results. Can be used in conjunction with pagination. Default 0.</div>
</li> <li>
<code>number</code> <span class="type">int</span><div class="desc">Number of users to limit the query for. Can be used in conjunction with pagination. Value -1 (all) is supported, but should be used with caution on larger sites.<br> Default -1 (all users).</div>
</li> <li>
<code>paged</code> <span class="type">int</span><div class="desc">When used with number, defines the page of results to return.<br> Default 1.</div>
</li> <li>
<code>count_total</code> <span class="type">bool</span><div class="desc">Whether to count the total number of users found. If pagination is not needed, setting this to false can improve performance.<br> Default true.</div>
</li> <li>
<code>fields</code> <span class="type">string|string[]</span><div class="desc">Which fields to return. Single or all fields (string), or array of fields. Accepts:<br> <ul>
<li><code>'ID'</code></li> <li><code>'display_name'</code></li> <li><code>'user_login'</code></li> <li><code>'user_nicename'</code></li> <li><code>'user_email'</code></li> <li><code>'user_url'</code></li> <li><code>'user_registered'</code></li> <li><code>'user_pass'</code></li> <li><code>'user_activation_key'</code></li> <li><code>'user_status'</code></li> <li>
<code>'spam'</code> (only available on multisite installs)</li> <li>
<code>'deleted'</code> (only available on multisite installs)</li> <li>
<code>'all'</code> for all fields and loads user meta.</li> <li>
<code>'all_with_meta'</code> Deprecated. Use <code>'all'</code>.</li>
</ul> Default <code>'all'</code>.</div>
</li> <li>
<code>who</code> <span class="type">string</span><div class="desc">Deprecated, use <code>$capability</code> instead.<br> Type of users to query. Accepts <code>'authors'</code>.<br> Default empty (all users).</div>
</li> <li>
<code>has_published_posts</code> <span class="type">bool|string[]</span><div class="desc">Pass an array of post types to filter results to users who have published posts in those post types. <code>true</code> is an alias for all public post types.</div>
</li> <li>
<code>nicename</code> <span class="type">string</span><div class="desc">The user nicename. </div>
</li> <li>
<code>nicename__in</code> <span class="type">string[]</span><div class="desc">An array of nicenames to include. Users matching one of these nicenames will be included in results. </div>
</li> <li>
<code>nicename__not_in</code> <span class="type">string[]</span><div class="desc">An array of nicenames to exclude. Users matching one of these nicenames will not be included in results. </div>
</li> <li>
<code>login</code> <span class="type">string</span><div class="desc">The user login. </div>
</li> <li>
<code>login__in</code> <span class="type">string[]</span><div class="desc">An array of logins to include. Users matching one of these logins will be included in results. </div>
</li> <li>
<code>login__not_in</code> <span class="type">string[]</span><div class="desc">An array of logins to exclude. Users matching one of these logins will not be included in results. </div>
</li> <li>
<code>cache_results</code> <span class="type">bool</span><div class="desc">Whether to cache user information. Default true.</div>
</li> </ul> </span></div>
<p class="default">Default:<code>array()</code></p>
</dd>
</dl></section> <section><h2 id="source">Source</h2> <pre class="wp-block-code" data-start="265" aria-label="Function source code" data-language="php"><code id="wporg-source-code" lang="php" class="language-php line-numbers">public function prepare_query( $query = array() ) {
	global $wpdb, $wp_roles;

	if ( empty( $this-&gt;query_vars ) || ! empty( $query ) ) {
		$this-&gt;query_limit = null;
		$this-&gt;query_vars  = $this-&gt;fill_query_vars( $query );
	}

	/**
	 * Fires before the WP_User_Query has been parsed.
	 *
	 * The passed WP_User_Query object contains the query variables,
	 * not yet passed into SQL.
	 *
	 * @since 4.0.0
	 *
	 * @param WP_User_Query $query Current instance of WP_User_Query (passed by reference).
	 */
	do_action_ref_array( 'pre_get_users', array( &amp;$this ) );

	// Ensure that query vars are filled after 'pre_get_users'.
	$qv =&amp; $this-&gt;query_vars;
	$qv = $this-&gt;fill_query_vars( $qv );

	$allowed_fields = array(
		'id',
		'user_login',
		'user_pass',
		'user_nicename',
		'user_email',
		'user_url',
		'user_registered',
		'user_activation_key',
		'user_status',
		'display_name',
	);
	if ( is_multisite() ) {
		$allowed_fields[] = 'spam';
		$allowed_fields[] = 'deleted';
	}

	if ( is_array( $qv['fields'] ) ) {
		$qv['fields'] = array_map( 'strtolower', $qv['fields'] );
		$qv['fields'] = array_intersect( array_unique( $qv['fields'] ), $allowed_fields );

		if ( empty( $qv['fields'] ) ) {
			$qv['fields'] = array( 'id' );
		}

		$this-&gt;query_fields = array();
		foreach ( $qv['fields'] as $field ) {
			$field                = 'id' === $field ? 'ID' : sanitize_key( $field );
			$this-&gt;query_fields[] = "$wpdb-&gt;users.$field";
		}
		$this-&gt;query_fields = implode( ',', $this-&gt;query_fields );
	} elseif ( 'all_with_meta' === $qv['fields'] || 'all' === $qv['fields'] || ! in_array( $qv['fields'], $allowed_fields, true ) ) {
		$this-&gt;query_fields = "$wpdb-&gt;users.ID";
	} else {
		$field              = 'id' === strtolower( $qv['fields'] ) ? 'ID' : sanitize_key( $qv['fields'] );
		$this-&gt;query_fields = "$wpdb-&gt;users.$field";
	}

	if ( isset( $qv['count_total'] ) &amp;&amp; $qv['count_total'] ) {
		$this-&gt;query_fields = 'SQL_CALC_FOUND_ROWS ' . $this-&gt;query_fields;
	}

	$this-&gt;query_from  = "FROM $wpdb-&gt;users";
	$this-&gt;query_where = 'WHERE 1=1';

	// Parse and sanitize 'include', for use by 'orderby' as well as 'include' below.
	if ( ! empty( $qv['include'] ) ) {
		$include = wp_parse_id_list( $qv['include'] );
	} else {
		$include = false;
	}

	$blog_id = 0;
	if ( isset( $qv['blog_id'] ) ) {
		$blog_id = absint( $qv['blog_id'] );
	}

	if ( $qv['has_published_posts'] &amp;&amp; $blog_id ) {
		if ( true === $qv['has_published_posts'] ) {
			$post_types = get_post_types( array( 'public' =&gt; true ) );
		} else {
			$post_types = (array) $qv['has_published_posts'];
		}

		foreach ( $post_types as &amp;$post_type ) {
			$post_type = $wpdb-&gt;prepare( '%s', $post_type );
		}

		$posts_table        = $wpdb-&gt;get_blog_prefix( $blog_id ) . 'posts';
		$this-&gt;query_where .= " AND $wpdb-&gt;users.ID IN ( SELECT DISTINCT $posts_table.post_author FROM $posts_table WHERE $posts_table.post_status = 'publish' AND $posts_table.post_type IN ( " . implode( ', ', $post_types ) . ' ) )';
	}

	// nicename
	if ( '' !== $qv['nicename'] ) {
		$this-&gt;query_where .= $wpdb-&gt;prepare( ' AND user_nicename = %s', $qv['nicename'] );
	}

	if ( ! empty( $qv['nicename__in'] ) ) {
		$sanitized_nicename__in = array_map( 'esc_sql', $qv['nicename__in'] );
		$nicename__in           = implode( "','", $sanitized_nicename__in );
		$this-&gt;query_where     .= " AND user_nicename IN ( '$nicename__in' )";
	}

	if ( ! empty( $qv['nicename__not_in'] ) ) {
		$sanitized_nicename__not_in = array_map( 'esc_sql', $qv['nicename__not_in'] );
		$nicename__not_in           = implode( "','", $sanitized_nicename__not_in );
		$this-&gt;query_where         .= " AND user_nicename NOT IN ( '$nicename__not_in' )";
	}

	// login
	if ( '' !== $qv['login'] ) {
		$this-&gt;query_where .= $wpdb-&gt;prepare( ' AND user_login = %s', $qv['login'] );
	}

	if ( ! empty( $qv['login__in'] ) ) {
		$sanitized_login__in = array_map( 'esc_sql', $qv['login__in'] );
		$login__in           = implode( "','", $sanitized_login__in );
		$this-&gt;query_where  .= " AND user_login IN ( '$login__in' )";
	}

	if ( ! empty( $qv['login__not_in'] ) ) {
		$sanitized_login__not_in = array_map( 'esc_sql', $qv['login__not_in'] );
		$login__not_in           = implode( "','", $sanitized_login__not_in );
		$this-&gt;query_where      .= " AND user_login NOT IN ( '$login__not_in' )";
	}

	// Meta query.
	$this-&gt;meta_query = new WP_Meta_Query();
	$this-&gt;meta_query-&gt;parse_query_vars( $qv );

	if ( isset( $qv['who'] ) &amp;&amp; 'authors' === $qv['who'] &amp;&amp; $blog_id ) {
		_deprecated_argument(
			'WP_User_Query',
			'5.9.0',
			sprintf(
				/* translators: 1: who, 2: capability */
				__( '%1$s is deprecated. Use %2$s instead.' ),
				'&lt;code&gt;who&lt;/code&gt;',
				'&lt;code&gt;capability&lt;/code&gt;'
			)
		);

		$who_query = array(
			'key'     =&gt; $wpdb-&gt;get_blog_prefix( $blog_id ) . 'user_level',
			'value'   =&gt; 0,
			'compare' =&gt; '!=',
		);

		// Prevent extra meta query.
		$qv['blog_id'] = 0;
		$blog_id       = 0;

		if ( empty( $this-&gt;meta_query-&gt;queries ) ) {
			$this-&gt;meta_query-&gt;queries = array( $who_query );
		} else {
			// Append the cap query to the original queries and reparse the query.
			$this-&gt;meta_query-&gt;queries = array(
				'relation' =&gt; 'AND',
				array( $this-&gt;meta_query-&gt;queries, $who_query ),
			);
		}

		$this-&gt;meta_query-&gt;parse_query_vars( $this-&gt;meta_query-&gt;queries );
	}

	// Roles.
	$roles = array();
	if ( isset( $qv['role'] ) ) {
		if ( is_array( $qv['role'] ) ) {
			$roles = $qv['role'];
		} elseif ( is_string( $qv['role'] ) &amp;&amp; ! empty( $qv['role'] ) ) {
			$roles = array_map( 'trim', explode( ',', $qv['role'] ) );
		}
	}

	$role__in = array();
	if ( isset( $qv['role__in'] ) ) {
		$role__in = (array) $qv['role__in'];
	}

	$role__not_in = array();
	if ( isset( $qv['role__not_in'] ) ) {
		$role__not_in = (array) $qv['role__not_in'];
	}

	// Capabilities.
	$available_roles = array();

	if ( ! empty( $qv['capability'] ) || ! empty( $qv['capability__in'] ) || ! empty( $qv['capability__not_in'] ) ) {
		$wp_roles-&gt;for_site( $blog_id );
		$available_roles = $wp_roles-&gt;roles;
	}

	$capabilities = array();
	if ( ! empty( $qv['capability'] ) ) {
		if ( is_array( $qv['capability'] ) ) {
			$capabilities = $qv['capability'];
		} elseif ( is_string( $qv['capability'] ) ) {
			$capabilities = array_map( 'trim', explode( ',', $qv['capability'] ) );
		}
	}

	$capability__in = array();
	if ( ! empty( $qv['capability__in'] ) ) {
		$capability__in = (array) $qv['capability__in'];
	}

	$capability__not_in = array();
	if ( ! empty( $qv['capability__not_in'] ) ) {
		$capability__not_in = (array) $qv['capability__not_in'];
	}

	// Keep track of all capabilities and the roles they're added on.
	$caps_with_roles = array();

	foreach ( $available_roles as $role =&gt; $role_data ) {
		$role_caps = array_keys( array_filter( $role_data['capabilities'] ) );

		foreach ( $capabilities as $cap ) {
			if ( in_array( $cap, $role_caps, true ) ) {
				$caps_with_roles[ $cap ][] = $role;
				break;
			}
		}

		foreach ( $capability__in as $cap ) {
			if ( in_array( $cap, $role_caps, true ) ) {
				$role__in[] = $role;
				break;
			}
		}

		foreach ( $capability__not_in as $cap ) {
			if ( in_array( $cap, $role_caps, true ) ) {
				$role__not_in[] = $role;
				break;
			}
		}
	}

	$role__in     = array_merge( $role__in, $capability__in );
	$role__not_in = array_merge( $role__not_in, $capability__not_in );

	$roles        = array_unique( $roles );
	$role__in     = array_unique( $role__in );
	$role__not_in = array_unique( $role__not_in );

	// Support querying by capabilities added directly to users.
	if ( $blog_id &amp;&amp; ! empty( $capabilities ) ) {
		$capabilities_clauses = array( 'relation' =&gt; 'AND' );

		foreach ( $capabilities as $cap ) {
			$clause = array( 'relation' =&gt; 'OR' );

			$clause[] = array(
				'key'     =&gt; $wpdb-&gt;get_blog_prefix( $blog_id ) . 'capabilities',
				'value'   =&gt; '"' . $cap . '"',
				'compare' =&gt; 'LIKE',
			);

			if ( ! empty( $caps_with_roles[ $cap ] ) ) {
				foreach ( $caps_with_roles[ $cap ] as $role ) {
					$clause[] = array(
						'key'     =&gt; $wpdb-&gt;get_blog_prefix( $blog_id ) . 'capabilities',
						'value'   =&gt; '"' . $role . '"',
						'compare' =&gt; 'LIKE',
					);
				}
			}

			$capabilities_clauses[] = $clause;
		}

		$role_queries[] = $capabilities_clauses;

		if ( empty( $this-&gt;meta_query-&gt;queries ) ) {
			$this-&gt;meta_query-&gt;queries[] = $capabilities_clauses;
		} else {
			// Append the cap query to the original queries and reparse the query.
			$this-&gt;meta_query-&gt;queries = array(
				'relation' =&gt; 'AND',
				array( $this-&gt;meta_query-&gt;queries, array( $capabilities_clauses ) ),
			);
		}

		$this-&gt;meta_query-&gt;parse_query_vars( $this-&gt;meta_query-&gt;queries );
	}

	if ( $blog_id &amp;&amp; ( ! empty( $roles ) || ! empty( $role__in ) || ! empty( $role__not_in ) || is_multisite() ) ) {
		$role_queries = array();

		$roles_clauses = array( 'relation' =&gt; 'AND' );
		if ( ! empty( $roles ) ) {
			foreach ( $roles as $role ) {
				$roles_clauses[] = array(
					'key'     =&gt; $wpdb-&gt;get_blog_prefix( $blog_id ) . 'capabilities',
					'value'   =&gt; '"' . $role . '"',
					'compare' =&gt; 'LIKE',
				);
			}

			$role_queries[] = $roles_clauses;
		}

		$role__in_clauses = array( 'relation' =&gt; 'OR' );
		if ( ! empty( $role__in ) ) {
			foreach ( $role__in as $role ) {
				$role__in_clauses[] = array(
					'key'     =&gt; $wpdb-&gt;get_blog_prefix( $blog_id ) . 'capabilities',
					'value'   =&gt; '"' . $role . '"',
					'compare' =&gt; 'LIKE',
				);
			}

			$role_queries[] = $role__in_clauses;
		}

		$role__not_in_clauses = array( 'relation' =&gt; 'AND' );
		if ( ! empty( $role__not_in ) ) {
			foreach ( $role__not_in as $role ) {
				$role__not_in_clauses[] = array(
					'key'     =&gt; $wpdb-&gt;get_blog_prefix( $blog_id ) . 'capabilities',
					'value'   =&gt; '"' . $role . '"',
					'compare' =&gt; 'NOT LIKE',
				);
			}

			$role_queries[] = $role__not_in_clauses;
		}

		// If there are no specific roles named, make sure the user is a member of the site.
		if ( empty( $role_queries ) ) {
			$role_queries[] = array(
				'key'     =&gt; $wpdb-&gt;get_blog_prefix( $blog_id ) . 'capabilities',
				'compare' =&gt; 'EXISTS',
			);
		}

		// Specify that role queries should be joined with AND.
		$role_queries['relation'] = 'AND';

		if ( empty( $this-&gt;meta_query-&gt;queries ) ) {
			$this-&gt;meta_query-&gt;queries = $role_queries;
		} else {
			// Append the cap query to the original queries and reparse the query.
			$this-&gt;meta_query-&gt;queries = array(
				'relation' =&gt; 'AND',
				array( $this-&gt;meta_query-&gt;queries, $role_queries ),
			);
		}

		$this-&gt;meta_query-&gt;parse_query_vars( $this-&gt;meta_query-&gt;queries );
	}

	if ( ! empty( $this-&gt;meta_query-&gt;queries ) ) {
		$clauses            = $this-&gt;meta_query-&gt;get_sql( 'user', $wpdb-&gt;users, 'ID', $this );
		$this-&gt;query_from  .= $clauses['join'];
		$this-&gt;query_where .= $clauses['where'];

		if ( $this-&gt;meta_query-&gt;has_or_relation() ) {
			$this-&gt;query_fields = 'DISTINCT ' . $this-&gt;query_fields;
		}
	}

	// Sorting.
	$qv['order'] = isset( $qv['order'] ) ? strtoupper( $qv['order'] ) : '';
	$order       = $this-&gt;parse_order( $qv['order'] );

	if ( empty( $qv['orderby'] ) ) {
		// Default order is by 'user_login'.
		$ordersby = array( 'user_login' =&gt; $order );
	} elseif ( is_array( $qv['orderby'] ) ) {
		$ordersby = $qv['orderby'];
	} else {
		// 'orderby' values may be a comma- or space-separated list.
		$ordersby = preg_split( '/[,\s]+/', $qv['orderby'] );
	}

	$orderby_array = array();
	foreach ( $ordersby as $_key =&gt; $_value ) {
		if ( ! $_value ) {
			continue;
		}

		if ( is_int( $_key ) ) {
			// Integer key means this is a flat array of 'orderby' fields.
			$_orderby = $_value;
			$_order   = $order;
		} else {
			// Non-integer key means this the key is the field and the value is ASC/DESC.
			$_orderby = $_key;
			$_order   = $_value;
		}

		$parsed = $this-&gt;parse_orderby( $_orderby );

		if ( ! $parsed ) {
			continue;
		}

		if ( 'nicename__in' === $_orderby || 'login__in' === $_orderby ) {
			$orderby_array[] = $parsed;
		} else {
			$orderby_array[] = $parsed . ' ' . $this-&gt;parse_order( $_order );
		}
	}

	// If no valid clauses were found, order by user_login.
	if ( empty( $orderby_array ) ) {
		$orderby_array[] = "user_login $order";
	}

	$this-&gt;query_orderby = 'ORDER BY ' . implode( ', ', $orderby_array );

	// Limit.
	if ( isset( $qv['number'] ) &amp;&amp; $qv['number'] &gt; 0 ) {
		if ( $qv['offset'] ) {
			$this-&gt;query_limit = $wpdb-&gt;prepare( 'LIMIT %d, %d', $qv['offset'], $qv['number'] );
		} else {
			$this-&gt;query_limit = $wpdb-&gt;prepare( 'LIMIT %d, %d', $qv['number'] * ( $qv['paged'] - 1 ), $qv['number'] );
		}
	}

	$search = '';
	if ( isset( $qv['search'] ) ) {
		$search = trim( $qv['search'] );
	}

	if ( $search ) {
		$leading_wild  = ( ltrim( $search, '*' ) !== $search );
		$trailing_wild = ( rtrim( $search, '*' ) !== $search );
		if ( $leading_wild &amp;&amp; $trailing_wild ) {
			$wild = 'both';
		} elseif ( $leading_wild ) {
			$wild = 'leading';
		} elseif ( $trailing_wild ) {
			$wild = 'trailing';
		} else {
			$wild = false;
		}
		if ( $wild ) {
			$search = trim( $search, '*' );
		}

		$search_columns = array();
		if ( $qv['search_columns'] ) {
			$search_columns = array_intersect( $qv['search_columns'], array( 'ID', 'user_login', 'user_email', 'user_url', 'user_nicename', 'display_name' ) );
		}
		if ( ! $search_columns ) {
			if ( str_contains( $search, '@' ) ) {
				$search_columns = array( 'user_email' );
			} elseif ( is_numeric( $search ) ) {
				$search_columns = array( 'user_login', 'ID' );
			} elseif ( preg_match( '|^https?://|', $search ) &amp;&amp; ! ( is_multisite() &amp;&amp; wp_is_large_network( 'users' ) ) ) {
				$search_columns = array( 'user_url' );
			} else {
				$search_columns = array( 'user_login', 'user_url', 'user_email', 'user_nicename', 'display_name' );
			}
		}

		/**
		 * Filters the columns to search in a WP_User_Query search.
		 *
		 * The default columns depend on the search term, and include 'ID', 'user_login',
		 * 'user_email', 'user_url', 'user_nicename', and 'display_name'.
		 *
		 * @since 3.6.0
		 *
		 * @param string[]      $search_columns Array of column names to be searched.
		 * @param string        $search         Text being searched.
		 * @param WP_User_Query $query          The current WP_User_Query instance.
		 */
		$search_columns = apply_filters( 'user_search_columns', $search_columns, $search, $this );

		$this-&gt;query_where .= $this-&gt;get_search_sql( $search, $search_columns, $wild );
	}

	if ( ! empty( $include ) ) {
		// Sanitized earlier.
		$ids                = implode( ',', $include );
		$this-&gt;query_where .= " AND $wpdb-&gt;users.ID IN ($ids)";
	} elseif ( ! empty( $qv['exclude'] ) ) {
		$ids                = implode( ',', wp_parse_id_list( $qv['exclude'] ) );
		$this-&gt;query_where .= " AND $wpdb-&gt;users.ID NOT IN ($ids)";
	}

	// Date queries are allowed for the user_registered field.
	if ( ! empty( $qv['date_query'] ) &amp;&amp; is_array( $qv['date_query'] ) ) {
		$date_query         = new WP_Date_Query( $qv['date_query'], 'user_registered' );
		$this-&gt;query_where .= $date_query-&gt;get_sql();
	}

	/**
	 * Fires after the WP_User_Query has been parsed, and before
	 * the query is executed.
	 *
	 * The passed WP_User_Query object contains SQL parts formed
	 * from parsing the given query.
	 *
	 * @since 3.1.0
	 *
	 * @param WP_User_Query $query Current instance of WP_User_Query (passed by reference).
	 */
	do_action_ref_array( 'pre_user_query', array( &amp;$this ) );
}
</code></pre>
<p class="wporg-dot-link-list"><a href="https://developer.wordpress.org/reference/files/wp-includes/class-wp-user-query.php/">View all references</a> <a href="https://core.trac.wordpress.org/browser/tags/6.7/src/wp-includes/class-wp-user-query.php#L265">View on Trac</a> <a href="https://github.com/WordPress/wordpress-develop/blob/6.7/src/wp-includes/class-wp-user-query.php#L265-L773">View on GitHub</a></p></section> <section><h2 id="hooks">Hooks</h2> <dl>
<dt class="wp-block-wporg-code-reference-title has-normal-font-size"><a href="../../hooks/pre_get_users.html"><span class="hook-func">do_action_ref_array</span>( â€˜pre_get_usersâ€™, <nobr><span class="arg-type">WP_User_Query</span> <span class="arg-name">$query</span></nobr> )</a></dt>
<dd>
<p>Fires before the <a href="../wp_user_query.html" rel="class">WP_User_Query</a> has been parsed.</p> </dd>
<dt class="wp-block-wporg-code-reference-title has-normal-font-size"><a href="../../hooks/pre_user_query.html"><span class="hook-func">do_action_ref_array</span>( â€˜pre_user_queryâ€™, <nobr><span class="arg-type">WP_User_Query</span> <span class="arg-name">$query</span></nobr> )</a></dt>
<dd>
<p>Fires after the <a href="../wp_user_query.html" rel="class">WP_User_Query</a> has been parsed, and before the query is executed.</p> </dd>
<dt class="wp-block-wporg-code-reference-title has-normal-font-size"><a href="../../hooks/user_search_columns.html"><span class="hook-func">apply_filters</span>( â€˜user_search_columnsâ€™, <nobr><span class="arg-type">string[]</span> <span class="arg-name">$search_columns</span></nobr>, <nobr><span class="arg-type">string</span> <span class="arg-name">$search</span></nobr>, <nobr><span class="arg-type">WP_User_Query</span> <span class="arg-name">$query</span></nobr> )</a></dt>
<dd>
<p>Filters the columns to search in a <a href="../wp_user_query.html" rel="class">WP_User_Query</a> search.</p> </dd>
</dl></section>  <section><h2 id="changelog">Changelog</h2> <section style="margin-top:var(--wp--preset--spacing--20);"><figure class="wp-block-table "><table>
<thead><tr>
<th scope="col">Version</th>
<th scope="col">Description</th>
</tr></thead>
<tbody>
<tr class="">
<td><a href="https://developer.wordpress.org/reference/since/6.3.0/">6.3.0</a></td>
<td><span class="since-description">Added <code>'cache_results'</code> parameter.</span></td>
</tr>
<tr class="">
<td><a href="https://developer.wordpress.org/reference/since/5.9.0/">5.9.0</a></td>
<td><span class="since-description">Added <code>'capability'</code>, <code>'capability__in'</code>, and <code>'capability__not_in'</code> parameters.<br> Deprecated the <code>'who'</code> parameter.</span></td>
</tr>
<tr class="">
<td><a href="https://developer.wordpress.org/reference/since/5.3.0/">5.3.0</a></td>
<td><span class="since-description">Introduced the <code>'meta_type_key'</code> parameter.</span></td>
</tr>
<tr class="">
<td><a href="https://developer.wordpress.org/reference/since/5.1.0/">5.1.0</a></td>
<td><span class="since-description">Introduced the <code>'meta_compare_key'</code> parameter.</span></td>
</tr>
<tr class="">
<td><a href="https://developer.wordpress.org/reference/since/4.7.0/">4.7.0</a></td>
<td><span class="since-description">Added <code>'nicename'</code>, <code>'nicename__in'</code>, <code>'nicename__not_in'</code>, <code>'login'</code>, <code>'login__in'</code>, and <code>'login__not_in'</code> parameters.</span></td>
</tr>
<tr class="wporg-hidden">
<td><a href="https://developer.wordpress.org/reference/since/4.4.0/">4.4.0</a></td>
<td><span class="since-description">Added <code>'paged'</code>, <code>'role__in'</code>, and <code>'role__not_in'</code> parameters. The <code>'role'</code> parameter was updated to permit an array or comma-separated list of values. The <code>'number'</code> parameter was updated to support querying for all users with using -1.</span></td>
</tr>
<tr class="wporg-hidden">
<td><a href="https://developer.wordpress.org/reference/since/4.3.0/">4.3.0</a></td>
<td><span class="since-description">Added <code>'has_published_posts'</code> parameter.</span></td>
</tr>
<tr class="wporg-hidden">
<td><a href="https://developer.wordpress.org/reference/since/4.2.0/">4.2.0</a></td>
<td><span class="since-description">Added <code>'meta_value_num'</code> support for <code>$orderby</code> parameter. Added multi-dimensional array syntax for <code>$orderby</code> parameter.</span></td>
</tr>
<tr class="wporg-hidden">
<td><a href="https://developer.wordpress.org/reference/since/4.1.0/">4.1.0</a></td>
<td><span class="since-description">Added the ability to order by the <code>include</code> value.</span></td>
</tr>
<tr class="wporg-hidden">
<td><a href="https://developer.wordpress.org/reference/since/3.1.0/">3.1.0</a></td>
<td>Introduced.</td>
</tr>
</tbody>
</table></figure><a class="wp-block-wporg-code-table-show-more" href="#">Show 5 more</a><a class="wp-block-wporg-code-table-show-less" href="#">Show less</a></section> </section><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2003&ndash;2024 WordPress Foundation<br>Licensed under the GNU GPLv2+ License.<br>
    <a href="https://developer.wordpress.org/reference/classes/wp_user_query/prepare_query" class="_attribution-link">https://developer.wordpress.org/reference/classes/wp_user_query/prepare_query</a>
  </p>
</div>
