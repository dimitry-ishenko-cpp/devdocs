<h1>Requests_IRI::replace_invalid_with_pct_encoding( string $string, string $extra_chars, bool $iprivate = false ): string</h1>  <section> <p>Replace invalid character with percent encoding</p> </section>   <section> <header class="toc-header"><h2 id="parameters">Parameters</h2></header> <dl> <dt> <code>$string</code> <span class="type"><span class="string">string</span></span> <span class="required">Required</span> </dt> <dd> <div class="desc"> <span class="description">Input string</span> </div> </dd> <dt> <code>$extra_chars</code> <span class="type"><span class="string">string</span></span> <span class="required">Required</span> </dt> <dd> <div class="desc"> <span class="description">Valid characters not in iunreserved or iprivate (this is ASCII-only)</span> </div> </dd> <dt> <code>$iprivate</code> <span class="type"><span class="bool">bool</span></span> <span class="required">Optional</span> </dt> <dd> <div class="desc"> <span class="description">Allow iprivate</span> </div> <p class="default">Default: <code>false</code></p> </dd> </dl> </section>  <section> <header class="toc-header"><h2 id="return">Return</h2></header> <p><span class="return-type">string</span> </p> </section>  <section> <header class="toc-header"><h2 id="source">Source</h2></header> <p> File: <code>wp-includes/Requests/IRI.php</code>. <a href="https://developer.wordpress.org/reference/files/wp-includes/requests/iri.php/">View all references</a> </p> <pre class="wp-block-code" data-start="422" aria-label="Function source code" data-language="php"><code lang="php" class="language-php line-numbers">protected function replace_invalid_with_pct_encoding($string, $extra_chars, $iprivate = false) {
	// Normalize as many pct-encoded sections as possible
	$string = preg_replace_callback('/(?:%[A-Fa-f0-9]{2})+/', array($this, 'remove_iunreserved_percent_encoded'), $string);

	// Replace invalid percent characters
	$string = preg_replace('/%(?![A-Fa-f0-9]{2})/', '%25', $string);

	// Add unreserved and % to $extra_chars (the latter is safe because all
	// pct-encoded sections are now valid).
	$extra_chars .= 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~%';

	// Now replace any bytes that aren't allowed with their pct-encoded versions
	$position = 0;
	$strlen = strlen($string);
	while (($position += strspn($string, $extra_chars, $position)) &lt; $strlen) {
		$value = ord($string[$position]);

		// Start position
		$start = $position;

		// By default we are valid
		$valid = true;

		// No one byte sequences are valid due to the while.
		// Two byte sequence:
		if (($value &amp; 0xE0) === 0xC0) {
			$character = ($value &amp; 0x1F) &lt;&lt; 6;
			$length = 2;
			$remaining = 1;
		}
		// Three byte sequence:
		elseif (($value &amp; 0xF0) === 0xE0) {
			$character = ($value &amp; 0x0F) &lt;&lt; 12;
			$length = 3;
			$remaining = 2;
		}
		// Four byte sequence:
		elseif (($value &amp; 0xF8) === 0xF0) {
			$character = ($value &amp; 0x07) &lt;&lt; 18;
			$length = 4;
			$remaining = 3;
		}
		// Invalid byte:
		else {
			$valid = false;
			$length = 1;
			$remaining = 0;
		}

		if ($remaining) {
			if ($position + $length &lt;= $strlen) {
				for ($position++; $remaining; $position++) {
					$value = ord($string[$position]);

					// Check that the byte is valid, then add it to the character:
					if (($value &amp; 0xC0) === 0x80) {
						$character |= ($value &amp; 0x3F) &lt;&lt; (--$remaining * 6);
					}
					// If it is invalid, count the sequence as invalid and reprocess the current byte:
					else {
						$valid = false;
						$position--;
						break;
					}
				}
			}
			else {
				$position = $strlen - 1;
				$valid = false;
			}
		}

		// Percent encode anything invalid or not in ucschar
		if (
			// Invalid sequences
			!$valid
			// Non-shortest form sequences are invalid
			|| $length &gt; 1 &amp;&amp; $character &lt;= 0x7F
			|| $length &gt; 2 &amp;&amp; $character &lt;= 0x7FF
			|| $length &gt; 3 &amp;&amp; $character &lt;= 0xFFFF
			// Outside of range of ucschar codepoints
			// Noncharacters
			|| ($character &amp; 0xFFFE) === 0xFFFE
			|| $character &gt;= 0xFDD0 &amp;&amp; $character &lt;= 0xFDEF
			|| (
				// Everything else not in ucschar
				   $character &gt; 0xD7FF &amp;&amp; $character &lt; 0xF900
				|| $character &lt; 0xA0
				|| $character &gt; 0xEFFFD
			)
			&amp;&amp; (
				// Everything not in iprivate, if it applies
				   !$iprivate
				|| $character &lt; 0xE000
				|| $character &gt; 0x10FFFD
			)
		) {
			// If we were a character, pretend we weren't, but rather an error.
			if ($valid) {
				$position--;
			}

			for ($j = $start; $j &lt;= $position; $j++) {
				$string = substr_replace($string, sprintf('%%%02X', ord($string[$j])), $j, 1);
				$j += 2;
				$position += 2;
				$strlen += 2;
			}
		}
	}

	return $string;
}
</code></pre>  </section>  <section> <header class="toc-header"><h2 id="related">Related</h2></header> <article class="used-by"> <header class="toc-header"><h3 id="used-by">Used By</h3></header> <table id="used-by-table" data-show="5">  <thead> <tr> <th>Used By</th> <th class="related-desc">Description</th> </tr> </thead> <tbody> <tr> <td class="related-title"> <a href="set_userinfo.html">Requests_IRI::set_userinfo()</a> <span>wp-includes/Requests/IRI.php</span> </td> <td class="related-desc"> <p>Set the iuserinfo.</p> </td> </tr> <tr> <td class="related-title"> <a href="set_host.html">Requests_IRI::set_host()</a> <span>wp-includes/Requests/IRI.php</span> </td> <td class="related-desc"> <p>Set the ihost. Returns true on success, false on failure (if there are any invalid characters).</p> </td> </tr> <tr> <td class="related-title"> <a href="set_path.html">Requests_IRI::set_path()</a> <span>wp-includes/Requests/IRI.php</span> </td> <td class="related-desc"> <p>Set the ipath.</p> </td> </tr> <tr> <td class="related-title"> <a href="set_query.html">Requests_IRI::set_query()</a> <span>wp-includes/Requests/IRI.php</span> </td> <td class="related-desc"> <p>Set the iquery.</p> </td> </tr> <tr> <td class="related-title"> <a href="set_fragment.html">Requests_IRI::set_fragment()</a> <span>wp-includes/Requests/IRI.php</span> </td> <td class="related-desc"> <p>Set the ifragment.</p> </td> </tr> </tbody>

</table> </article> </section><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2003&ndash;2022 WordPress Foundation<br>Licensed under the GNU GPLv2+ License.<br>
    <a href="https://developer.wordpress.org/reference/classes/requests_iri/replace_invalid_with_pct_encoding" class="_attribution-link">https://developer.wordpress.org/reference/classes/requests_iri/replace_invalid_with_pct_encoding</a>
  </p>
</div>
