<h1>upgrade_network()</h1>  <section> <p>Executes network-level upgrade routines.</p> </section>   <section> <header class="toc-header"><h2 id="source">Source</h2></header> <p> File: <code>wp-admin/includes/upgrade.php</code>. <a href="https://developer.wordpress.org/reference/files/wp-admin/includes/upgrade.php/">View all references</a> </p> <pre class="wp-block-code" data-start="2296" aria-label="Function source code" data-language="php"><code lang="php" class="language-php line-numbers">function upgrade_network() {
	global $wp_current_db_version, $wpdb;

	// Always clear expired transients.
	delete_expired_transients( true );

	// 2.8.0
	if ( $wp_current_db_version &lt; 11549 ) {
		$wpmu_sitewide_plugins   = get_site_option( 'wpmu_sitewide_plugins' );
		$active_sitewide_plugins = get_site_option( 'active_sitewide_plugins' );
		if ( $wpmu_sitewide_plugins ) {
			if ( ! $active_sitewide_plugins ) {
				$sitewide_plugins = (array) $wpmu_sitewide_plugins;
			} else {
				$sitewide_plugins = array_merge( (array) $active_sitewide_plugins, (array) $wpmu_sitewide_plugins );
			}

			update_site_option( 'active_sitewide_plugins', $sitewide_plugins );
		}
		delete_site_option( 'wpmu_sitewide_plugins' );
		delete_site_option( 'deactivated_sitewide_plugins' );

		$start = 0;
		while ( $rows = $wpdb-&gt;get_results( "SELECT meta_key, meta_value FROM {$wpdb-&gt;sitemeta} ORDER BY meta_id LIMIT $start, 20" ) ) {
			foreach ( $rows as $row ) {
				$value = $row-&gt;meta_value;
				if ( ! @unserialize( $value ) ) {
					$value = stripslashes( $value );
				}
				if ( $value !== $row-&gt;meta_value ) {
					update_site_option( $row-&gt;meta_key, $value );
				}
			}
			$start += 20;
		}
	}

	// 3.0.0
	if ( $wp_current_db_version &lt; 13576 ) {
		update_site_option( 'global_terms_enabled', '1' );
	}

	// 3.3.0
	if ( $wp_current_db_version &lt; 19390 ) {
		update_site_option( 'initial_db_version', $wp_current_db_version );
	}

	if ( $wp_current_db_version &lt; 19470 ) {
		if ( false === get_site_option( 'active_sitewide_plugins' ) ) {
			update_site_option( 'active_sitewide_plugins', array() );
		}
	}

	// 3.4.0
	if ( $wp_current_db_version &lt; 20148 ) {
		// 'allowedthemes' keys things by stylesheet. 'allowed_themes' keyed things by name.
		$allowedthemes  = get_site_option( 'allowedthemes' );
		$allowed_themes = get_site_option( 'allowed_themes' );
		if ( false === $allowedthemes &amp;&amp; is_array( $allowed_themes ) &amp;&amp; $allowed_themes ) {
			$converted = array();
			$themes    = wp_get_themes();
			foreach ( $themes as $stylesheet =&gt; $theme_data ) {
				if ( isset( $allowed_themes[ $theme_data-&gt;get( 'Name' ) ] ) ) {
					$converted[ $stylesheet ] = true;
				}
			}
			update_site_option( 'allowedthemes', $converted );
			delete_site_option( 'allowed_themes' );
		}
	}

	// 3.5.0
	if ( $wp_current_db_version &lt; 21823 ) {
		update_site_option( 'ms_files_rewriting', '1' );
	}

	// 3.5.2
	if ( $wp_current_db_version &lt; 24448 ) {
		$illegal_names = get_site_option( 'illegal_names' );
		if ( is_array( $illegal_names ) &amp;&amp; count( $illegal_names ) === 1 ) {
			$illegal_name  = reset( $illegal_names );
			$illegal_names = explode( ' ', $illegal_name );
			update_site_option( 'illegal_names', $illegal_names );
		}
	}

	// 4.2.0
	if ( $wp_current_db_version &lt; 31351 &amp;&amp; 'utf8mb4' === $wpdb-&gt;charset ) {
		if ( wp_should_upgrade_global_tables() ) {
			$wpdb-&gt;query( "ALTER TABLE $wpdb-&gt;usermeta DROP INDEX meta_key, ADD INDEX meta_key(meta_key(191))" );
			$wpdb-&gt;query( "ALTER TABLE $wpdb-&gt;site DROP INDEX domain, ADD INDEX domain(domain(140),path(51))" );
			$wpdb-&gt;query( "ALTER TABLE $wpdb-&gt;sitemeta DROP INDEX meta_key, ADD INDEX meta_key(meta_key(191))" );
			$wpdb-&gt;query( "ALTER TABLE $wpdb-&gt;signups DROP INDEX domain_path, ADD INDEX domain_path(domain(140),path(51))" );

			$tables = $wpdb-&gt;tables( 'global' );

			// sitecategories may not exist.
			if ( ! $wpdb-&gt;get_var( "SHOW TABLES LIKE '{$tables['sitecategories']}'" ) ) {
				unset( $tables['sitecategories'] );
			}

			foreach ( $tables as $table ) {
				maybe_convert_table_to_utf8mb4( $table );
			}
		}
	}

	// 4.3.0
	if ( $wp_current_db_version &lt; 33055 &amp;&amp; 'utf8mb4' === $wpdb-&gt;charset ) {
		if ( wp_should_upgrade_global_tables() ) {
			$upgrade = false;
			$indexes = $wpdb-&gt;get_results( "SHOW INDEXES FROM $wpdb-&gt;signups" );
			foreach ( $indexes as $index ) {
				if ( 'domain_path' === $index-&gt;Key_name &amp;&amp; 'domain' === $index-&gt;Column_name &amp;&amp; 140 != $index-&gt;Sub_part ) {
					$upgrade = true;
					break;
				}
			}

			if ( $upgrade ) {
				$wpdb-&gt;query( "ALTER TABLE $wpdb-&gt;signups DROP INDEX domain_path, ADD INDEX domain_path(domain(140),path(51))" );
			}

			$tables = $wpdb-&gt;tables( 'global' );

			// sitecategories may not exist.
			if ( ! $wpdb-&gt;get_var( "SHOW TABLES LIKE '{$tables['sitecategories']}'" ) ) {
				unset( $tables['sitecategories'] );
			}

			foreach ( $tables as $table ) {
				maybe_convert_table_to_utf8mb4( $table );
			}
		}
	}

	// 5.1.0
	if ( $wp_current_db_version &lt; 44467 ) {
		$network_id = get_main_network_id();
		delete_network_option( $network_id, 'site_meta_supported' );
		is_site_meta_supported();
	}
}
</code></pre>  </section>  <section> <header class="toc-header"><h2 id="related">Related</h2></header> <article class="uses"> <header class="toc-header"><h3 id="uses">Uses</h3></header> <table id="uses-table" data-show="5">  <thead> <tr> <th>Uses</th> <th class="related-desc">Description</th> </tr> </thead> <tbody> <tr> <td class="related-title"> <a href="is_site_meta_supported.html">is_site_meta_supported()</a> <span>wp-includes/functions.php</span> </td> <td class="related-desc"> <p>Determines whether site meta is enabled.</p> </td> </tr> <tr> <td class="related-title"> <a href="delete_expired_transients.html">delete_expired_transients()</a> <span>wp-includes/option.php</span> </td> <td class="related-desc"> <p>Deletes all expired transients.</p> </td> </tr> <tr> <td class="related-title"> <a href="delete_network_option.html">delete_network_option()</a> <span>wp-includes/option.php</span> </td> <td class="related-desc"> <p>Removes a network option by name.</p> </td> </tr> <tr> <td class="related-title"> <a href="get_main_network_id.html">get_main_network_id()</a> <span>wp-includes/functions.php</span> </td> <td class="related-desc"> <p>Gets the main network ID.</p> </td> </tr> <tr> <td class="related-title"> <a href="wp_should_upgrade_global_tables.html">wp_should_upgrade_global_tables()</a> <span>wp-admin/includes/upgrade.php</span> </td> <td class="related-desc"> <p>Determine if global tables should be upgraded.</p> </td> </tr> <tr> <td class="related-title"> <a href="maybe_convert_table_to_utf8mb4.html">maybe_convert_table_to_utf8mb4()</a> <span>wp-admin/includes/upgrade.php</span> </td> <td class="related-desc"> <p>If a table only contains utf8 or utf8mb4 columns, convert it to utf8mb4.</p> </td> </tr> <tr> <td class="related-title"> <a href="wp_get_themes.html">wp_get_themes()</a> <span>wp-includes/theme.php</span> </td> <td class="related-desc"> <p>Returns an array of <a href="../classes/wp_theme.html" rel="class">WP_Theme</a> objects based on the arguments.</p> </td> </tr> <tr> <td class="related-title"> <a href="update_site_option.html">update_site_option()</a> <span>wp-includes/option.php</span> </td> <td class="related-desc"> <p>Updates the value of an option that was already added for the current network.</p> </td> </tr> <tr> <td class="related-title"> <a href="delete_site_option.html">delete_site_option()</a> <span>wp-includes/option.php</span> </td> <td class="related-desc"> <p>Removes a option by name for the current network.</p> </td> </tr> <tr> <td class="related-title"> <a href="../classes/wpdb/query.html">wpdb::query()</a> <span>wp-includes/class-wpdb.php</span> </td> <td class="related-desc"> <p>Performs a database query, using current database connection.</p> </td> </tr> <tr> <td class="related-title"> <a href="../classes/wpdb/tables.html">wpdb::tables()</a> <span>wp-includes/class-wpdb.php</span> </td> <td class="related-desc"> <p>Returns an array of WordPress tables.</p> </td> </tr> <tr> <td class="related-title"> <a href="get_site_option.html">get_site_option()</a> <span>wp-includes/option.php</span> </td> <td class="related-desc"> <p>Retrieve an option value for the current network based on name of option.</p> </td> </tr> <tr> <td class="related-title"> <a href="../classes/wpdb/get_results.html">wpdb::get_results()</a> <span>wp-includes/class-wpdb.php</span> </td> <td class="related-desc"> <p>Retrieves an entire SQL result set from the database (i.e., many rows).</p> </td> </tr> <tr> <td class="related-title"> <a href="../classes/wpdb/get_var.html">wpdb::get_var()</a> <span>wp-includes/class-wpdb.php</span> </td> <td class="related-desc"> <p>Retrieves one variable from the database.</p> </td> </tr> </tbody>

</table>   </article>  <article class="used-by"> <header class="toc-header"><h3 id="used-by">Used By</h3></header> <table id="used-by-table" data-show="5">  <thead> <tr> <th>Used By</th> <th class="related-desc">Description</th> </tr> </thead> <tbody> <tr> <td class="related-title"> <a href="wp_upgrade.html">wp_upgrade()</a> <span>wp-admin/includes/upgrade.php</span> </td> <td class="related-desc"> <p>Runs WordPress Upgrade functions.</p> </td> </tr> </tbody>

</table> </article> </section>  <section> <header class="toc-header"><h2 id="changelog">Changelog</h2></header> <table>  <thead> <tr> <th class="changelog-version">Version</th> <th class="changelog-desc">Description</th> </tr> </thead> <tbody> <tr> <td><a href="https://developer.wordpress.org/reference/since/3.0.0/" alt="WordPress 3.0.0">3.0.0</a></td> <td>Introduced.</td> </tr> </tbody> </table> </section><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2003&ndash;2022 WordPress Foundation<br>Licensed under the GNU GPLv2+ License.<br>
    <a href="https://developer.wordpress.org/reference/functions/upgrade_network" class="_attribution-link">https://developer.wordpress.org/reference/functions/upgrade_network</a>
  </p>
</div>
