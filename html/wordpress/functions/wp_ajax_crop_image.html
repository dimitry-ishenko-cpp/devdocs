<h1>wp_ajax_crop_image()</h1>  <section> <p>Ajax handler for cropping an image.</p> </section>   <section> <header class="toc-header"><h2 id="source">Source</h2></header> <p> File: <code>wp-admin/includes/ajax-actions.php</code>. <a href="https://developer.wordpress.org/reference/files/wp-admin/includes/ajax-actions.php/">View all references</a> </p> <pre class="wp-block-code" data-start="3949" aria-label="Function source code" data-language="php"><code lang="php" class="language-php line-numbers">function wp_ajax_crop_image() {
	$attachment_id = absint( $_POST['id'] );

	check_ajax_referer( 'image_editor-' . $attachment_id, 'nonce' );

	if ( empty( $attachment_id ) || ! current_user_can( 'edit_post', $attachment_id ) ) {
		wp_send_json_error();
	}

	$context = str_replace( '_', '-', $_POST['context'] );
	$data    = array_map( 'absint', $_POST['cropDetails'] );
	$cropped = wp_crop_image( $attachment_id, $data['x1'], $data['y1'], $data['width'], $data['height'], $data['dst_width'], $data['dst_height'] );

	if ( ! $cropped || is_wp_error( $cropped ) ) {
		wp_send_json_error( array( 'message' =&gt; __( 'Image could not be processed.' ) ) );
	}

	switch ( $context ) {
		case 'site-icon':
			require_once ABSPATH . 'wp-admin/includes/class-wp-site-icon.php';
			$wp_site_icon = new WP_Site_Icon();

			// Skip creating a new attachment if the attachment is a Site Icon.
			if ( get_post_meta( $attachment_id, '_wp_attachment_context', true ) == $context ) {

				// Delete the temporary cropped file, we don't need it.
				wp_delete_file( $cropped );

				// Additional sizes in wp_prepare_attachment_for_js().
				add_filter( 'image_size_names_choose', array( $wp_site_icon, 'additional_sizes' ) );
				break;
			}

			/** This filter is documented in wp-admin/includes/class-custom-image-header.php */
			$cropped    = apply_filters( 'wp_create_file_in_uploads', $cropped, $attachment_id ); // For replication.
			$attachment = $wp_site_icon-&gt;create_attachment_object( $cropped, $attachment_id );
			unset( $attachment['ID'] );

			// Update the attachment.
			add_filter( 'intermediate_image_sizes_advanced', array( $wp_site_icon, 'additional_sizes' ) );
			$attachment_id = $wp_site_icon-&gt;insert_attachment( $attachment, $cropped );
			remove_filter( 'intermediate_image_sizes_advanced', array( $wp_site_icon, 'additional_sizes' ) );

			// Additional sizes in wp_prepare_attachment_for_js().
			add_filter( 'image_size_names_choose', array( $wp_site_icon, 'additional_sizes' ) );
			break;

		default:
			/**
			 * Fires before a cropped image is saved.
			 *
			 * Allows to add filters to modify the way a cropped image is saved.
			 *
			 * @since 4.3.0
			 *
			 * @param string $context       The Customizer control requesting the cropped image.
			 * @param int    $attachment_id The attachment ID of the original image.
			 * @param string $cropped       Path to the cropped image file.
			 */
			do_action( 'wp_ajax_crop_image_pre_save', $context, $attachment_id, $cropped );

			/** This filter is documented in wp-admin/includes/class-custom-image-header.php */
			$cropped = apply_filters( 'wp_create_file_in_uploads', $cropped, $attachment_id ); // For replication.

			$parent_url      = wp_get_attachment_url( $attachment_id );
			$parent_basename = wp_basename( $parent_url );
			$url             = str_replace( $parent_basename, wp_basename( $cropped ), $parent_url );

			$size       = wp_getimagesize( $cropped );
			$image_type = ( $size ) ? $size['mime'] : 'image/jpeg';

			// Get the original image's post to pre-populate the cropped image.
			$original_attachment  = get_post( $attachment_id );
			$sanitized_post_title = sanitize_file_name( $original_attachment-&gt;post_title );
			$use_original_title   = (
				( '' !== trim( $original_attachment-&gt;post_title ) ) &amp;&amp;
				/*
				 * Check if the original image has a title other than the "filename" default,
				 * meaning the image had a title when originally uploaded or its title was edited.
				 */
				( $parent_basename !== $sanitized_post_title ) &amp;&amp;
				( pathinfo( $parent_basename, PATHINFO_FILENAME ) !== $sanitized_post_title )
			);
			$use_original_description = ( '' !== trim( $original_attachment-&gt;post_content ) );

			$attachment = array(
				'post_title'     =&gt; $use_original_title ? $original_attachment-&gt;post_title : wp_basename( $cropped ),
				'post_content'   =&gt; $use_original_description ? $original_attachment-&gt;post_content : $url,
				'post_mime_type' =&gt; $image_type,
				'guid'           =&gt; $url,
				'context'        =&gt; $context,
			);

			// Copy the image caption attribute (post_excerpt field) from the original image.
			if ( '' !== trim( $original_attachment-&gt;post_excerpt ) ) {
				$attachment['post_excerpt'] = $original_attachment-&gt;post_excerpt;
			}

			// Copy the image alt text attribute from the original image.
			if ( '' !== trim( $original_attachment-&gt;_wp_attachment_image_alt ) ) {
				$attachment['meta_input'] = array(
					'_wp_attachment_image_alt' =&gt; wp_slash( $original_attachment-&gt;_wp_attachment_image_alt ),
				);
			}

			$attachment_id = wp_insert_attachment( $attachment, $cropped );
			$metadata      = wp_generate_attachment_metadata( $attachment_id, $cropped );

			/**
			 * Filters the cropped image attachment metadata.
			 *
			 * @since 4.3.0
			 *
			 * @see wp_generate_attachment_metadata()
			 *
			 * @param array $metadata Attachment metadata.
			 */
			$metadata = apply_filters( 'wp_ajax_cropped_attachment_metadata', $metadata );
			wp_update_attachment_metadata( $attachment_id, $metadata );

			/**
			 * Filters the attachment ID for a cropped image.
			 *
			 * @since 4.3.0
			 *
			 * @param int    $attachment_id The attachment ID of the cropped image.
			 * @param string $context       The Customizer control requesting the cropped image.
			 */
			$attachment_id = apply_filters( 'wp_ajax_cropped_attachment_id', $attachment_id, $context );
	}

	wp_send_json_success( wp_prepare_attachment_for_js( $attachment_id ) );
}
</code></pre>  </section>  <section> <header class="toc-header"><h2 id="hooks">Hooks</h2></header> <article class="hooks"> <dl> <dt class="signature-highlight"> <a href="../hooks/wp_ajax_cropped_attachment_id.html" style="text-decoration: none"> <span class="hook-func">apply_filters</span>( 'wp_ajax_cropped_attachment_id', <nobr><span class="arg-type">int</span> <span class="arg-name">$attachment_id</span></nobr>, <nobr><span class="arg-type">string</span> <span class="arg-name">$context</span></nobr> ) </a> </dt> <dd class="hook-desc"> 
<p>Filters the attachment ID for a cropped image.</p> </dd> </dl> <dl> <dt class="signature-highlight"> <a href="../hooks/wp_ajax_cropped_attachment_metadata.html" style="text-decoration: none"> <span class="hook-func">apply_filters</span>( 'wp_ajax_cropped_attachment_metadata', <nobr><span class="arg-type">array</span> <span class="arg-name">$metadata</span></nobr> ) </a> </dt> <dd class="hook-desc"> 
<p>Filters the cropped image attachment metadata.</p> </dd> </dl> <dl> <dt class="signature-highlight"> <a href="../hooks/wp_ajax_crop_image_pre_save.html" style="text-decoration: none"> <span class="hook-func">do_action</span>( 'wp_ajax_crop_image_pre_save', <nobr><span class="arg-type">string</span> <span class="arg-name">$context</span></nobr>, <nobr><span class="arg-type">int</span> <span class="arg-name">$attachment_id</span></nobr>, <nobr><span class="arg-type">string</span> <span class="arg-name">$cropped</span></nobr> ) </a> </dt> <dd class="hook-desc"> 
<p>Fires before a cropped image is saved.</p> </dd> </dl> <dl> <dt class="signature-highlight"> <a href="../hooks/wp_create_file_in_uploads.html" style="text-decoration: none"> <span class="hook-func">do_action</span>( 'wp_create_file_in_uploads', <nobr><span class="arg-type">string</span> <span class="arg-name">$file</span></nobr>, <nobr><span class="arg-type">int</span> <span class="arg-name">$attachment_id</span></nobr> ) </a> </dt> <dd class="hook-desc"> 
<p>Fires after the header image is set or an error is returned.</p> </dd> </dl> </article> </section>  <section> <header class="toc-header"><h2 id="related">Related</h2></header> <article class="uses"> <header class="toc-header"><h3 id="uses">Uses</h3></header> <table id="uses-table" data-show="5">  <thead> <tr> <th>Uses</th> <th class="related-desc">Description</th> </tr> </thead> <tbody> <tr> <td class="related-title"> <a href="wp_getimagesize.html">wp_getimagesize()</a> <span>wp-includes/media.php</span> </td> <td class="related-desc"> <p>Allows PHP’s getimagesize() to be debuggable when necessary.</p> </td> </tr> <tr> <td class="related-title"> <a href="wp_prepare_attachment_for_js.html">wp_prepare_attachment_for_js()</a> <span>wp-includes/media.php</span> </td> <td class="related-desc"> <p>Prepares an attachment post object for JS, where it is expected to be JSON-encoded and fit into an Attachment model.</p> </td> </tr> <tr> <td class="related-title"> <a href="../classes/wp_site_icon/create_attachment_object.html">WP_Site_Icon::create_attachment_object()</a> <span>wp-admin/includes/class-wp-site-icon.php</span> </td> <td class="related-desc"> <p>Creates an attachment ‘object’.</p> </td> </tr> <tr> <td class="related-title"> <a href="../classes/wp_site_icon/insert_attachment.html">WP_Site_Icon::insert_attachment()</a> <span>wp-admin/includes/class-wp-site-icon.php</span> </td> <td class="related-desc"> <p>Inserts an attachment.</p> </td> </tr> <tr> <td class="related-title"> <a href="wp_delete_file.html">wp_delete_file()</a> <span>wp-includes/functions.php</span> </td> <td class="related-desc"> <p>Deletes a file.</p> </td> </tr> <tr> <td class="related-title"> <a href="wp_generate_attachment_metadata.html">wp_generate_attachment_metadata()</a> <span>wp-admin/includes/image.php</span> </td> <td class="related-desc"> <p>Generates attachment meta data and create image sub-sizes for images.</p> </td> </tr> <tr> <td class="related-title"> <a href="wp_crop_image.html">wp_crop_image()</a> <span>wp-admin/includes/image.php</span> </td> <td class="related-desc"> <p>Crops an image to a given size.</p> </td> </tr> <tr> <td class="related-title"> <a href="remove_filter.html">remove_filter()</a> <span>wp-includes/plugin.php</span> </td> <td class="related-desc"> <p>Removes a callback function from a filter hook.</p> </td> </tr> <tr> <td class="related-title"> <a href="wp_update_attachment_metadata.html">wp_update_attachment_metadata()</a> <span>wp-includes/post.php</span> </td> <td class="related-desc"> <p>Updates metadata for an attachment.</p> </td> </tr> <tr> <td class="related-title"> <a href="wp_insert_attachment.html">wp_insert_attachment()</a> <span>wp-includes/post.php</span> </td> <td class="related-desc"> <p>Inserts an attachment.</p> </td> </tr> <tr> <td class="related-title"> <a href="sanitize_file_name.html">sanitize_file_name()</a> <span>wp-includes/formatting.php</span> </td> <td class="related-desc"> <p>Sanitizes a filename, replacing whitespace with dashes.</p> </td> </tr> <tr> <td class="related-title"> <a href="wp_get_attachment_url.html">wp_get_attachment_url()</a> <span>wp-includes/post.php</span> </td> <td class="related-desc"> <p>Retrieves the URL for an attachment.</p> </td> </tr> <tr> <td class="related-title"> <a href="../classes/wp_site_icon/__construct.html">WP_Site_Icon::__construct()</a> <span>wp-admin/includes/class-wp-site-icon.php</span> </td> <td class="related-desc"> <p>Registers actions and filters.</p> </td> </tr> <tr> <td class="related-title"> <a href="do_action.html">do_action()</a> <span>wp-includes/plugin.php</span> </td> <td class="related-desc"> <p>Calls the callback functions that have been added to an action hook.</p> </td> </tr> <tr> <td class="related-title"> <a href="get_post_meta.html">get_post_meta()</a> <span>wp-includes/post.php</span> </td> <td class="related-desc"> <p>Retrieves a post meta field for the given post ID.</p> </td> </tr> <tr> <td class="related-title"> <a href="get_post.html">get_post()</a> <span>wp-includes/post.php</span> </td> <td class="related-desc"> <p>Retrieves post data given a post ID or post object.</p> </td> </tr> <tr> <td class="related-title"> <a href="apply_filters.html">apply_filters()</a> <span>wp-includes/plugin.php</span> </td> <td class="related-desc"> <p>Calls the callback functions that have been added to a filter hook.</p> </td> </tr> <tr> <td class="related-title"> <a href="absint.html">absint()</a> <span>wp-includes/functions.php</span> </td> <td class="related-desc"> <p>Converts a value to non-negative integer.</p> </td> </tr> <tr> <td class="related-title"> <a href="add_filter.html">add_filter()</a> <span>wp-includes/plugin.php</span> </td> <td class="related-desc"> <p>Adds a callback function to a filter hook.</p> </td> </tr> <tr> <td class="related-title"> <a href="wp_send_json_success.html">wp_send_json_success()</a> <span>wp-includes/functions.php</span> </td> <td class="related-desc"> <p>Sends a JSON response back to an Ajax request, indicating success.</p> </td> </tr> <tr> <td class="related-title"> <a href="wp_send_json_error.html">wp_send_json_error()</a> <span>wp-includes/functions.php</span> </td> <td class="related-desc"> <p>Sends a JSON response back to an Ajax request, indicating failure.</p> </td> </tr> <tr> <td class="related-title"> <a href="check_ajax_referer.html">check_ajax_referer()</a> <span>wp-includes/pluggable.php</span> </td> <td class="related-desc"> <p>Verifies the Ajax request to prevent processing requests external of the blog.</p> </td> </tr> <tr> <td class="related-title"> <a href="wp_slash.html">wp_slash()</a> <span>wp-includes/formatting.php</span> </td> <td class="related-desc"> <p>Adds slashes to a string or recursively adds slashes to strings within an array.</p> </td> </tr> <tr> <td class="related-title"> <a href="wp_basename.html">wp_basename()</a> <span>wp-includes/formatting.php</span> </td> <td class="related-desc"> <p>i18n-friendly version of basename().</p> </td> </tr> <tr> <td class="related-title"> <a href="__.html">__()</a> <span>wp-includes/l10n.php</span> </td> <td class="related-desc"> <p>Retrieves the translation of $text.</p> </td> </tr> <tr> <td class="related-title"> <a href="current_user_can.html">current_user_can()</a> <span>wp-includes/capabilities.php</span> </td> <td class="related-desc"> <p>Returns whether the current user has the specified capability.</p> </td> </tr> <tr> <td class="related-title"> <a href="is_wp_error.html">is_wp_error()</a> <span>wp-includes/load.php</span> </td> <td class="related-desc"> <p>Checks whether the given variable is a WordPress Error.</p> </td> </tr> </tbody>

</table>   </article> </section>  <section> <header class="toc-header"><h2 id="changelog">Changelog</h2></header> <table>  <thead> <tr> <th class="changelog-version">Version</th> <th class="changelog-desc">Description</th> </tr> </thead> <tbody> <tr> <td><a href="https://developer.wordpress.org/reference/since/4.3.0/" alt="WordPress 4.3.0">4.3.0</a></td> <td>Introduced.</td> </tr> </tbody> </table> </section><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2003&ndash;2022 WordPress Foundation<br>Licensed under the GNU GPLv2+ License.<br>
    <a href="https://developer.wordpress.org/reference/functions/wp_ajax_crop_image" class="_attribution-link">https://developer.wordpress.org/reference/functions/wp_ajax_crop_image</a>
  </p>
</div>
