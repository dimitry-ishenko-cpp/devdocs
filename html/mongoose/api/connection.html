<h1>Connection</h1>

<div class="api-content">
<h3 id="Connection()">Connection()</h3>
<h5>Parameters:</h5>
<ul class="params"><li class="param">
<code>base</code> <span class="method-type">«Mongoose»</span> a mongoose instance </li></ul>
<h5>Inherits:</h5>
<ul><li><span class="method-type"><a href="https://nodejs.org/api/events.html#class-eventemitter">«NodeJS EventEmitter»</a></span></li></ul>
<div>
<p>Connection constructor</p> <p>For practical reasons, a Connection equals a Db.</p> </div>
<h3 id="Connection.prototype.asPromise()">Connection.prototype.asPromise()</h3>
<h5>Returns:</h5>
<ul><li>
<span class="method-type">«Promise»</span> </li></ul>
<div>
<p>Returns a promise that resolves when this connection successfully connects to MongoDB, or rejects if this connection failed to connect.</p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript"><span class="hljs-keyword">const</span> conn = <span class="hljs-keyword">await</span> mongoose.<span class="hljs-title function_">createConnection</span>(<span class="hljs-string">'mongodb://127.0.0.1:27017/test'</span>).
  <span class="hljs-title function_">asPromise</span>();
conn.<span class="hljs-property">readyState</span>; <span class="hljs-comment">// 1, means Mongoose is connected</span>
</pre> </div>
<h3 id="Connection.prototype.client">Connection.prototype.client</h3>
<h5>Type:</h5>
<ul><li><span class="method-type">«property»</span></li></ul>
<div>
<p>The MongoClient instance this connection uses to talk to MongoDB. Mongoose automatically sets this property when the connection is opened.</p> </div>
<h3 id="Connection.prototype.close()">Connection.prototype.close()</h3>
<h5>Parameters:</h5>
<ul class="params"><li class="param">
<code>[force]</code> <span class="method-type">«Boolean»</span> optional </li></ul>
<h5>Returns:</h5>
<ul><li>
<span class="method-type">«Promise»</span> </li></ul>
<div>
<p>Closes the connection</p> </div>
<h3 id="Connection.prototype.collection()">Connection.prototype.collection()</h3>
<h5>Parameters:</h5>
<ul class="params">
<li class="param">
<code>name</code> <span class="method-type">«String»</span> of the collection </li>
<li class="param">
<code>[options]</code> <span class="method-type">«Object»</span> optional collection options </li>
</ul>
<h5>Returns:</h5>
<ul><li>
<span class="method-type">«Collection»</span> collection instance</li></ul>
<div>
<p>Retrieves a raw collection instance, creating it if not cached. This method returns a thin wrapper around a [MongoDB Node.js driver collection](<a href="https://mongodb.github.io/node-mongodb-native/Next/classes/Collection.html">MongoDB Node.js driver collection</a>). Using a Collection bypasses Mongoose middleware, validation, and casting, letting you use <a href="https://mongodb.github.io/node-mongodb-native/">MongoDB Node.js driver</a> functionality directly.</p> </div>
<h3 id="Connection.prototype.collections">Connection.prototype.collections</h3>
<h5>Type:</h5>
<ul><li><span class="method-type">«property»</span></li></ul>
<div>
<p>A hash of the collections associated with this connection</p> </div>
<h3 id="Connection.prototype.config">Connection.prototype.config</h3>
<h5>Type:</h5>
<ul><li><span class="method-type">«property»</span></li></ul>
<div>
<p>A hash of the global options that are associated with this connection</p> </div>
<h3 id="Connection.prototype.createCollection()">Connection.prototype.createCollection()</h3>
<h5>Parameters:</h5>
<ul class="params">
<li class="param">
<code>collection</code> <span class="method-type">«string»</span> The collection to create </li>
<li class="param">
<code>[options]</code> <span class="method-type">«Object»</span> see <a href="https://mongodb.github.io/node-mongodb-native/4.9/classes/Db.html#createCollection">MongoDB driver docs</a> </li>
</ul>
<h5>Returns:</h5>
<ul><li>
<span class="method-type">«Promise»</span> </li></ul>
<div>
<p>Helper for <code>createCollection()</code>. Will explicitly create the given collection with specified options. Used to create <a href="https://www.mongodb.com/docs/manual/core/capped-collections/">capped collections</a> and <a href="https://www.mongodb.com/docs/manual/core/views/">views</a> from mongoose.</p> <p>Options are passed down without modification to the <a href="https://mongodb.github.io/node-mongodb-native/4.9/classes/Db.html#createCollection">MongoDB driver's <code>createCollection()</code> function</a></p> </div>
<h3 id="Connection.prototype.createCollections()">Connection.prototype.createCollections()</h3>
<h5>Parameters:</h5>
<ul class="params"><li class="param">
<code>continueOnError</code> <span class="method-type">«Boolean»</span> When true, will continue to create collections and create a new error class for the collections that errored. </li></ul>
<div>
<p>Calls <code>createCollection()</code> on a models in a series.</p> </div>
<h3 id="Connection.prototype.db">Connection.prototype.db</h3>
<h5>Type:</h5>
<ul><li><span class="method-type">«property»</span></li></ul>
<div>
<p>The mongodb.Db instance, set when the connection is opened</p> </div>
<h3 id="Connection.prototype.deleteModel()">Connection.prototype.deleteModel()</h3>
<h5>Parameters:</h5>
<ul class="params"><li class="param">
<code>name</code> <span class="method-type">«String|RegExp»</span> if string, the name of the model to remove. If regexp, removes all models whose name matches the regexp. </li></ul>
<h5>Returns:</h5>
<ul><li>
<span class="method-type">«Connection»</span> this</li></ul>
<div>
<p>Removes the model named <code>name</code> from this connection, if it exists. You can use this function to clean up any models you created in your tests to prevent OverwriteModelErrors.</p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript">conn.<span class="hljs-title function_">model</span>(<span class="hljs-string">'User'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>({ <span class="hljs-attr">name</span>: <span class="hljs-title class_">String</span> }));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(conn.<span class="hljs-title function_">model</span>(<span class="hljs-string">'User'</span>)); <span class="hljs-comment">// Model object</span>
conn.<span class="hljs-title function_">deleteModel</span>(<span class="hljs-string">'User'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(conn.<span class="hljs-title function_">model</span>(<span class="hljs-string">'User'</span>)); <span class="hljs-comment">// undefined</span>

<span class="hljs-comment">// Usually useful in a Mocha `afterEach()` hook</span>
<span class="hljs-title function_">afterEach</span>(<span class="hljs-keyword">function</span>() {
  conn.<span class="hljs-title function_">deleteModel</span>(<span class="hljs-regexp">/.+/</span>); <span class="hljs-comment">// Delete every model</span>
});
</pre> </div>
<h3 id="Connection.prototype.destroy()">Connection.prototype.destroy()</h3>
<h5>Parameters:</h5>
<ul class="params"><li class="param">
<code>[force]</code> <span class="method-type">«Boolean»</span> </li></ul>
<div>
<p>Destroy the connection. Similar to <a href="#Connection.prototype.close()"><code>.close</code></a>, but also removes the connection from Mongoose's <code>connections</code> list and prevents the connection from ever being re-opened.</p> </div>
<h3 id="Connection.prototype.dropCollection()">Connection.prototype.dropCollection()</h3>
<h5>Parameters:</h5>
<ul class="params"><li class="param">
<code>collection</code> <span class="method-type">«string»</span> The collection to delete </li></ul>
<h5>Returns:</h5>
<ul><li>
<span class="method-type">«Promise»</span> </li></ul>
<div>
<p>Helper for <code>dropCollection()</code>. Will delete the given collection, including all documents and indexes.</p> </div>
<h3 id="Connection.prototype.dropDatabase()">Connection.prototype.dropDatabase()</h3>
<h5>Returns:</h5>
<ul><li>
<span class="method-type">«Promise»</span> </li></ul>
<div>
<p>Helper for <code>dropDatabase()</code>. Deletes the given database, including all collections, documents, and indexes.</p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript"><span class="hljs-keyword">const</span> conn = mongoose.<span class="hljs-title function_">createConnection</span>(<span class="hljs-string">'mongodb://127.0.0.1:27017/mydb'</span>);
<span class="hljs-comment">// Deletes the entire 'mydb' database</span>
<span class="hljs-keyword">await</span> conn.<span class="hljs-title function_">dropDatabase</span>();
</pre> </div>
<h3 id="Connection.prototype.get()">Connection.prototype.get()</h3>
<h5>Parameters:</h5>
<ul class="params"><li class="param">
<code>key</code> <span class="method-type">«String»</span> </li></ul>
<div>
<p>Gets the value of the option <code>key</code>. Equivalent to <code>conn.options[key]</code></p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript">conn.<span class="hljs-title function_">get</span>(<span class="hljs-string">'test'</span>); <span class="hljs-comment">// returns the 'test' value</span>
</pre> </div>
<h3 id="Connection.prototype.getClient()">Connection.prototype.getClient()</h3>
<h5>Returns:</h5>
<ul><li>
<span class="method-type">«MongoClient»</span> </li></ul>
<div>
<p>Returns the <a href="https://mongodb.github.io/node-mongodb-native/4.9/classes/MongoClient.html">MongoDB driver <code>MongoClient</code></a> instance that this connection uses to talk to MongoDB.</p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript"><span class="hljs-keyword">const</span> conn = <span class="hljs-keyword">await</span> mongoose.<span class="hljs-title function_">createConnection</span>(<span class="hljs-string">'mongodb://127.0.0.1:27017/test'</span>).
  <span class="hljs-title function_">asPromise</span>();

conn.<span class="hljs-title function_">getClient</span>(); <span class="hljs-comment">// MongoClient { ... }</span>
</pre> </div>
<h3 id="Connection.prototype.host">Connection.prototype.host</h3>
<h5>Type:</h5>
<ul><li><span class="method-type">«property»</span></li></ul>
<div>
<p>The host name portion of the URI. If multiple hosts, such as a replica set, this will contain the first host name in the URI</p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript">mongoose.<span class="hljs-title function_">createConnection</span>(<span class="hljs-string">'mongodb://127.0.0.1:27017/mydb'</span>).<span class="hljs-property">host</span>; <span class="hljs-comment">// "127.0.0.1"</span>
</pre> </div>
<h3 id="Connection.prototype.id">Connection.prototype.id</h3>
<h5>Type:</h5>
<ul><li><span class="method-type">«property»</span></li></ul>
<div>
<p>A number identifier for this connection. Used for debugging when you have <a href="../connections.html#multiple_connections">multiple connections</a>.</p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript"><span class="hljs-comment">// The default connection has `id = 0`</span>
mongoose.<span class="hljs-property">connection</span>.<span class="hljs-property">id</span>; <span class="hljs-comment">// 0</span>

<span class="hljs-comment">// If you create a new connection, Mongoose increments id</span>
<span class="hljs-keyword">const</span> conn = mongoose.<span class="hljs-title function_">createConnection</span>();
conn.<span class="hljs-property">id</span>; <span class="hljs-comment">// 1</span>
</pre> </div>
<h3 id="Connection.prototype.model()">Connection.prototype.model()</h3>
<h5>Parameters:</h5>
<ul class="params">
<li class="param">
<code>name</code> <span class="method-type">«String|Function»</span> the model name or class extending Model </li>
<li class="param">
<code>[schema]</code> <span class="method-type">«Schema»</span> a schema. necessary when defining a model </li>
<li class="param">
<code>[collection]</code> <span class="method-type">«String»</span> name of mongodb collection (optional) if not given it will be induced from model name </li>
<li class="param">
<code>[options]</code> <span class="method-type">«Object»</span> </li>
<ul style="margin-top: 0.5em"><li>
<code>[options.overwriteModels=false]</code> <span class="method-type">«Boolean»</span> If true, overwrite existing models with the same name to avoid <code>OverwriteModelError</code> </li></ul>
</ul>
<h5>Returns:</h5>
<ul><li>
<span class="method-type">«Model»</span> The compiled model</li></ul>
<h5>See:</h5>
<ul><li><span class="method-type"><a href="mongoose.html#Mongoose.prototype.model()">Mongoose#model</a></span></li></ul>
<div>
<p>Defines or retrieves a model.</p> <pre data-language="javascript"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
<span class="hljs-keyword">const</span> db = mongoose.<span class="hljs-title function_">createConnection</span>(..);
db.<span class="hljs-title function_">model</span>(<span class="hljs-string">'Venue'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>(..));
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Ticket</span> = db.<span class="hljs-title function_">model</span>(<span class="hljs-string">'Ticket'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>(..));
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Venue</span> = db.<span class="hljs-title function_">model</span>(<span class="hljs-string">'Venue'</span>);
</pre> <p><em>When no <code>collection</code> argument is passed, Mongoose produces a collection name by passing the model <code>name</code> to the <code>utils.toCollectionName</code> method. This method pluralizes the name. If you don't like this behavior, either pass a collection name or set your schemas collection name option.</em></p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript"><span class="hljs-keyword">const</span> schema = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>({ <span class="hljs-attr">name</span>: <span class="hljs-title class_">String</span> }, { <span class="hljs-attr">collection</span>: <span class="hljs-string">'actor'</span> });

<span class="hljs-comment">// or</span>

schema.<span class="hljs-title function_">set</span>(<span class="hljs-string">'collection'</span>, <span class="hljs-string">'actor'</span>);

<span class="hljs-comment">// or</span>

<span class="hljs-keyword">const</span> collectionName = <span class="hljs-string">'actor'</span>
<span class="hljs-keyword">const</span> M = conn.<span class="hljs-title function_">model</span>(<span class="hljs-string">'Actor'</span>, schema, collectionName)
</pre> </div>
<h3 id="Connection.prototype.modelNames()">Connection.prototype.modelNames()</h3>
<h5>Returns:</h5>
<ul><li>
<span class="method-type">«Array[String]»</span> </li></ul>
<div>
<p>Returns an array of model names created on this connection.</p> </div>
<h3 id="Connection.prototype.models">Connection.prototype.models</h3>
<h5>Type:</h5>
<ul><li><span class="method-type">«property»</span></li></ul>
<div>
<p>A <a href="https://masteringjs.io/tutorials/fundamentals/pojo">POJO</a> containing a map from model names to models. Contains all models that have been added to this connection using <a href="#Connection.prototype.model()"><code>Connection#model()</code></a>.</p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript"><span class="hljs-keyword">const</span> conn = mongoose.<span class="hljs-title function_">createConnection</span>();
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Test</span> = conn.<span class="hljs-title function_">model</span>(<span class="hljs-string">'Test'</span>, mongoose.<span class="hljs-title class_">Schema</span>({ <span class="hljs-attr">name</span>: <span class="hljs-title class_">String</span> }));

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(conn.<span class="hljs-property">models</span>).<span class="hljs-property">length</span>; <span class="hljs-comment">// 1</span>
conn.<span class="hljs-property">models</span>.<span class="hljs-property">Test</span> === <span class="hljs-title class_">Test</span>; <span class="hljs-comment">// true</span>
</pre> </div>
<h3 id="Connection.prototype.name">Connection.prototype.name</h3>
<h5>Type:</h5>
<ul><li><span class="method-type">«property»</span></li></ul>
<div>
<p>The name of the database this connection points to.</p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript">mongoose.<span class="hljs-title function_">createConnection</span>(<span class="hljs-string">'mongodb://127.0.0.1:27017/mydb'</span>).<span class="hljs-property">name</span>; <span class="hljs-comment">// "mydb"</span>
</pre> </div>
<h3 id="Connection.prototype.openUri()">Connection.prototype.openUri()</h3>
<h5>Parameters:</h5>
<ul class="params">
<li class="param">
<code>uri</code> <span class="method-type">«String»</span> The URI to connect with. </li>
<li class="param">
<code>[options]</code> <span class="method-type">«Object»</span> Passed on to <a href="https://mongodb.github.io/node-mongodb-native/4.9/classes/MongoClient.html#connect-1"><code>MongoClient.connect</code></a> </li>
<ul style="margin-top: 0.5em"><li>
<code>[options.bufferCommands=true]</code> <span class="method-type">«Boolean»</span> Mongoose specific option. Set to false to <a href="https://mongoosejs.com/docs/faq.html#callback_never_executes">disable buffering</a> on all models associated with this connection. </li></ul>
<ul style="margin-top: 0.5em"><li>
<code>[options.bufferTimeoutMS=10000]</code> <span class="method-type">«Number»</span> Mongoose specific option. If <code>bufferCommands</code> is true, Mongoose will throw an error after <code>bufferTimeoutMS</code> if the operation is still buffered. </li></ul>
<ul style="margin-top: 0.5em"><li>
<code>[options.dbName]</code> <span class="method-type">«String»</span> The name of the database we want to use. If not provided, use database name from connection string. </li></ul>
<ul style="margin-top: 0.5em"><li>
<code>[options.user]</code> <span class="method-type">«String»</span> username for authentication, equivalent to <code>options.auth.user</code>. Maintained for backwards compatibility. </li></ul>
<ul style="margin-top: 0.5em"><li>
<code>[options.pass]</code> <span class="method-type">«String»</span> password for authentication, equivalent to <code>options.auth.password</code>. Maintained for backwards compatibility. </li></ul>
<ul style="margin-top: 0.5em"><li>
<code>[options.maxPoolSize=100]</code> <span class="method-type">«Number»</span> The maximum number of sockets the MongoDB driver will keep open for this connection. Keep in mind that MongoDB only allows one operation per socket at a time, so you may want to increase this if you find you have a few slow queries that are blocking faster queries from proceeding. See <a href="https://thecodebarbarian.com/slow-trains-in-mongodb-and-nodejs">Slow Trains in MongoDB and Node.js</a>. </li></ul>
<ul style="margin-top: 0.5em"><li>
<code>[options.minPoolSize=0]</code> <span class="method-type">«Number»</span> The minimum number of sockets the MongoDB driver will keep open for this connection. Keep in mind that MongoDB only allows one operation per socket at a time, so you may want to increase this if you find you have a few slow queries that are blocking faster queries from proceeding. See <a href="https://thecodebarbarian.com/slow-trains-in-mongodb-and-nodejs">Slow Trains in MongoDB and Node.js</a>. </li></ul>
<ul style="margin-top: 0.5em"><li>
<code>[options.serverSelectionTimeoutMS]</code> <span class="method-type">«Number»</span> If <code>useUnifiedTopology = true</code>, the MongoDB driver will try to find a server to send any given operation to, and keep retrying for <code>serverSelectionTimeoutMS</code> milliseconds before erroring out. If not set, the MongoDB driver defaults to using <code>30000</code> (30 seconds). </li></ul>
<ul style="margin-top: 0.5em"><li>
<code>[options.heartbeatFrequencyMS]</code> <span class="method-type">«Number»</span> If <code>useUnifiedTopology = true</code>, the MongoDB driver sends a heartbeat every <code>heartbeatFrequencyMS</code> to check on the status of the connection. A heartbeat is subject to <code>serverSelectionTimeoutMS</code>, so the MongoDB driver will retry failed heartbeats for up to 30 seconds by default. Mongoose only emits a <code>'disconnected'</code> event after a heartbeat has failed, so you may want to decrease this setting to reduce the time between when your server goes down and when Mongoose emits <code>'disconnected'</code>. We recommend you do <strong>not</strong> set this setting below 1000, too many heartbeats can lead to performance degradation. </li></ul>
<ul style="margin-top: 0.5em"><li>
<code>[options.autoIndex=true]</code> <span class="method-type">«Boolean»</span> Mongoose-specific option. Set to false to disable automatic index creation for all models associated with this connection. </li></ul>
<ul style="margin-top: 0.5em"><li>
<code>[options.promiseLibrary]</code> <span class="method-type">«Class»</span> Sets the <a href="https://mongodb.github.io/node-mongodb-native/4.9/interfaces/MongoClientOptions.html#promiseLibrary">underlying driver's promise library</a>. </li></ul>
<ul style="margin-top: 0.5em"><li>
<code>[options.socketTimeoutMS=0]</code> <span class="method-type">«Number»</span> How long the MongoDB driver will wait before killing a socket due to inactivity <em>after initial connection</em>. A socket may be inactive because of either no activity or a long-running operation. <code>socketTimeoutMS</code> defaults to 0, which means Node.js will not time out the socket due to inactivity. This option is passed to <a href="https://nodejs.org/api/net.html#net_socket_settimeout_timeout_callback">Node.js <code>socket#setTimeout()</code> function</a> after the MongoDB driver successfully completes. </li></ul>
<ul style="margin-top: 0.5em"><li>
<code>[options.family=0]</code> <span class="method-type">«Number»</span> Passed transparently to <a href="https://nodejs.org/api/dns.html#dns_dns_lookup_hostname_options_callback">Node.js' <code>dns.lookup()</code></a> function. May be either <code>0, </code>4<code>, or </code>6<code>. </code>4<code>means use IPv4 only,</code>6<code>means use IPv6 only,</code>0` means try both. </li></ul>
<ul style="margin-top: 0.5em"><li>
<code>[options.autoCreate=false]</code> <span class="method-type">«Boolean»</span> Set to <code>true</code> to make Mongoose automatically call <code>createCollection()</code> on every model created on this connection. </li></ul>
</ul>
<div>
<p>Opens the connection with a URI using <code>MongoClient.connect()</code>.</p> </div>
<h3 id="Connection.prototype.pass">Connection.prototype.pass</h3>
<h5>Type:</h5>
<ul><li><span class="method-type">«property»</span></li></ul>
<div>
<p>The password specified in the URI</p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript">mongoose.<span class="hljs-title function_">createConnection</span>(<span class="hljs-string">'mongodb://val:psw@127.0.0.1:27017/mydb'</span>).<span class="hljs-property">pass</span>; <span class="hljs-comment">// "psw"</span>
</pre> </div>
<h3 id="Connection.prototype.plugin()">Connection.prototype.plugin()</h3>
<h5>Parameters:</h5>
<ul class="params">
<li class="param">
<code>fn</code> <span class="method-type">«Function»</span> plugin callback </li>
<li class="param">
<code>[opts]</code> <span class="method-type">«Object»</span> optional options </li>
</ul>
<h5>Returns:</h5>
<ul><li>
<span class="method-type">«Connection»</span> this</li></ul>
<h5>See:</h5>
<ul><li><span class="method-type"><a href="../plugins.html">plugins</a></span></li></ul>
<div>
<p>Declares a plugin executed on all schemas you pass to <code>conn.model()</code></p> <p>Equivalent to calling <code>.plugin(fn)</code> on each schema you create.</p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript"><span class="hljs-keyword">const</span> db = mongoose.<span class="hljs-title function_">createConnection</span>(<span class="hljs-string">'mongodb://127.0.0.1:27017/mydb'</span>);
db.<span class="hljs-title function_">plugin</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Applied'</span>));
db.<span class="hljs-property">plugins</span>.<span class="hljs-property">length</span>; <span class="hljs-comment">// 1</span>

db.<span class="hljs-title function_">model</span>(<span class="hljs-string">'Test'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>({})); <span class="hljs-comment">// Prints "Applied"</span>
</pre> </div>
<h3 id="Connection.prototype.plugins">Connection.prototype.plugins</h3>
<h5>Type:</h5>
<ul><li><span class="method-type">«property»</span></li></ul>
<div>
<p>The plugins that will be applied to all models created on this connection.</p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript"><span class="hljs-keyword">const</span> db = mongoose.<span class="hljs-title function_">createConnection</span>(<span class="hljs-string">'mongodb://127.0.0.1:27017/mydb'</span>);
db.<span class="hljs-title function_">plugin</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Applied'</span>));
db.<span class="hljs-property">plugins</span>.<span class="hljs-property">length</span>; <span class="hljs-comment">// 1</span>

db.<span class="hljs-title function_">model</span>(<span class="hljs-string">'Test'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>({})); <span class="hljs-comment">// Prints "Applied"</span>
</pre> </div>
<h3 id="Connection.prototype.port">Connection.prototype.port</h3>
<h5>Type:</h5>
<ul><li><span class="method-type">«property»</span></li></ul>
<div>
<p>The port portion of the URI. If multiple hosts, such as a replica set, this will contain the port from the first host name in the URI.</p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript">mongoose.<span class="hljs-title function_">createConnection</span>(<span class="hljs-string">'mongodb://127.0.0.1:27017/mydb'</span>).<span class="hljs-property">port</span>; <span class="hljs-comment">// 27017</span>
</pre> </div>
<h3 id="Connection.prototype.readyState">Connection.prototype.readyState</h3>
<h5>Type:</h5>
<ul><li><span class="method-type">«property»</span></li></ul>
<div>
<p>Connection ready state</p> <ul> <li>0 = disconnected</li> <li>1 = connected</li> <li>2 = connecting</li> <li>3 = disconnecting</li> </ul> <p>Each state change emits its associated event name.</p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript">conn.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connected'</span>, callback);
conn.<span class="hljs-title function_">on</span>(<span class="hljs-string">'disconnected'</span>, callback);
</pre> </div>
<h3 id="Connection.prototype.removeDb()">Connection.prototype.removeDb()</h3>
<h5>Parameters:</h5>
<ul class="params"><li class="param">
<code>name</code> <span class="method-type">«String»</span> The database name </li></ul>
<h5>Returns:</h5>
<ul><li>
<span class="method-type">«Connection»</span> this</li></ul>
<div>
<p>Removes the database connection with the given name created with with <code>useDb()</code>.</p> <p>Throws an error if the database connection was not found.</p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript"><span class="hljs-comment">// Connect to `initialdb` first</span>
<span class="hljs-keyword">const</span> conn = <span class="hljs-keyword">await</span> mongoose.<span class="hljs-title function_">createConnection</span>(<span class="hljs-string">'mongodb://127.0.0.1:27017/initialdb'</span>).<span class="hljs-title function_">asPromise</span>();

<span class="hljs-comment">// Creates an un-cached connection to `mydb`</span>
<span class="hljs-keyword">const</span> db = conn.<span class="hljs-title function_">useDb</span>(<span class="hljs-string">'mydb'</span>);

<span class="hljs-comment">// Closes `db`, and removes `db` from `conn.relatedDbs` and `conn.otherDbs`</span>
<span class="hljs-keyword">await</span> conn.<span class="hljs-title function_">removeDb</span>(<span class="hljs-string">'mydb'</span>);
</pre> </div>
<h3 id="Connection.prototype.set()">Connection.prototype.set()</h3>
<h5>Parameters:</h5>
<ul class="params">
<li class="param">
<code>key</code> <span class="method-type">«String»</span> </li>
<li class="param">
<code>val</code> <span class="method-type">«Any»</span> </li>
</ul>
<div>
<p>Sets the value of the option <code>key</code>. Equivalent to <code>conn.options[key] = val</code></p> <p>Supported options include:</p> <ul> <li>
<code>maxTimeMS</code>: Set <a href="query.html#Query.prototype.maxTimeMS()"><code>maxTimeMS</code></a> for all queries on this connection.</li> <li>'debug': If <code>true</code>, prints the operations mongoose sends to MongoDB to the console. If a writable stream is passed, it will log to that stream, without colorization. If a callback function is passed, it will receive the collection name, the method name, then all arugments passed to the method. For example, if you wanted to replicate the default logging, you could output from the callback <code>Mongoose: ${collectionName}.${methodName}(${methodArgs.join(', ')})</code>.</li> </ul> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript">conn.<span class="hljs-title function_">set</span>(<span class="hljs-string">'test'</span>, <span class="hljs-string">'foo'</span>);
conn.<span class="hljs-title function_">get</span>(<span class="hljs-string">'test'</span>); <span class="hljs-comment">// 'foo'</span>
conn.<span class="hljs-property">options</span>.<span class="hljs-property">test</span>; <span class="hljs-comment">// 'foo'</span>
</pre> </div>
<h3 id="Connection.prototype.setClient()">Connection.prototype.setClient()</h3>
<h5>Parameters:</h5>
<ul class="params"><li class="param">
<code>client</code> <span class="method-type">«MongClient»</span> The Client to set to be used. </li></ul>
<h5>Returns:</h5>
<ul><li>
<span class="method-type">«Connection»</span> this</li></ul>
<div>
<p>Set the <a href="https://mongodb.github.io/node-mongodb-native/4.9/classes/MongoClient.html">MongoDB driver <code>MongoClient</code></a> instance that this connection uses to talk to MongoDB. This is useful if you already have a MongoClient instance, and want to reuse it.</p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript"><span class="hljs-keyword">const</span> client = <span class="hljs-keyword">await</span> mongodb.<span class="hljs-property">MongoClient</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-string">'mongodb://127.0.0.1:27017/test'</span>);

<span class="hljs-keyword">const</span> conn = mongoose.<span class="hljs-title function_">createConnection</span>().<span class="hljs-title function_">setClient</span>(client);

conn.<span class="hljs-title function_">getClient</span>(); <span class="hljs-comment">// MongoClient { ... }</span>
conn.<span class="hljs-property">readyState</span>; <span class="hljs-comment">// 1, means 'CONNECTED'</span>
</pre> </div>
<h3 id="Connection.prototype.startSession()">Connection.prototype.startSession()</h3>
<h5>Parameters:</h5>
<ul class="params">
<li class="param">
<code>[options]</code> <span class="method-type">«Object»</span> see the <a href="https://mongodb.github.io/node-mongodb-native/4.9/classes/MongoClient.html#startSession">mongodb driver options</a> </li>
<ul style="margin-top: 0.5em"><li>
<code>[options.causalConsistency=true]</code> <span class="method-type">«Boolean»</span> set to false to disable causal consistency </li></ul>
</ul>
<h5>Returns:</h5>
<ul><li>
<span class="method-type">«Promise&lt;ClientSession&gt;»</span> promise that resolves to a MongoDB driver <code>ClientSession</code>
</li></ul>
<div>
<p><em>Requires MongoDB &gt;= 3.6.0.</em> Starts a <a href="https://www.mongodb.com/docs/manual/release-notes/3.6/#client-sessions">MongoDB session</a> for benefits like causal consistency, <a href="https://www.mongodb.com/docs/manual/core/retryable-writes/">retryable writes</a>, and <a href="https://thecodebarbarian.com/a-node-js-perspective-on-mongodb-4-transactions.html">transactions</a>.</p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript"><span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> conn.<span class="hljs-title function_">startSession</span>();
<span class="hljs-keyword">let</span> doc = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Person</span>.<span class="hljs-title function_">findOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Ned Stark'</span> }, <span class="hljs-literal">null</span>, { session });
<span class="hljs-keyword">await</span> doc.<span class="hljs-title function_">remove</span>();
<span class="hljs-comment">// `doc` will always be null, even if reading from a replica set</span>
<span class="hljs-comment">// secondary. Without causal consistency, it is possible to</span>
<span class="hljs-comment">// get a doc back from the below query if the query reads from a</span>
<span class="hljs-comment">// secondary that is experiencing replication lag.</span>
doc = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Person</span>.<span class="hljs-title function_">findOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Ned Stark'</span> }, <span class="hljs-literal">null</span>, { session, <span class="hljs-attr">readPreference</span>: <span class="hljs-string">'secondary'</span> });
</pre> </div>
<h3 id="Connection.prototype.syncIndexes()">Connection.prototype.syncIndexes()</h3>
<h5>Parameters:</h5>
<ul class="params">
<li class="param">
<code>[options]</code> <span class="method-type">«Object»</span> </li>
<ul style="margin-top: 0.5em"><li>
<code>[options.continueOnError]</code> <span class="method-type">«Boolean»</span> <code>false</code> by default. If set to <code>true</code>, mongoose will not throw an error if one model syncing failed, and will return an object where the keys are the names of the models, and the values are the results/errors for each model. </li></ul>
</ul>
<h5>Returns:</h5>
<ul><li>
<span class="method-type">«Promise&lt;Object&gt;»</span> Returns a Promise, when the Promise resolves the value is a list of the dropped indexes.</li></ul>
<div>
<p>Syncs all the indexes for the models registered with this connection.</p> </div>
<h3 id="Connection.prototype.transaction()">Connection.prototype.transaction()</h3>
<h5>Parameters:</h5>
<ul class="params">
<li class="param">
<code>fn</code> <span class="method-type">«Function»</span> Function to execute in a transaction </li>
<li class="param">
<code>[options]</code> <span class="method-type">«[object Object]»</span> Optional settings for the transaction </li>
</ul>
<h5>Returns:</h5>
<ul><li>
<span class="method-type">«Promise&lt;Any&gt;»</span> promise that is fulfilled if Mongoose successfully committed the transaction, or rejects if the transaction was aborted or if Mongoose failed to commit the transaction. If fulfilled, the promise resolves to a MongoDB command result.</li></ul>
<div>
<p><em>Requires MongoDB &gt;= 3.6.0.</em> Executes the wrapped async function in a transaction. Mongoose will commit the transaction if the async function executes successfully and attempt to retry if there was a retriable error.</p> <p>Calls the MongoDB driver's <a href="https://mongodb.github.io/node-mongodb-native/4.9/classes/ClientSession.html#withTransaction"><code>session.withTransaction()</code></a>, but also handles resetting Mongoose document state as shown below.</p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript"><span class="hljs-keyword">const</span> doc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Will Riker'</span> });
<span class="hljs-keyword">await</span> db.<span class="hljs-title function_">transaction</span>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setRank</span>(<span class="hljs-params">session</span>) {
  doc.<span class="hljs-property">rank</span> = <span class="hljs-string">'Captain'</span>;
  <span class="hljs-keyword">await</span> doc.<span class="hljs-title function_">save</span>({ session });
  doc.<span class="hljs-property">isNew</span>; <span class="hljs-comment">// false</span>

  <span class="hljs-comment">// Throw an error to abort the transaction</span>
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Oops!'</span>);
},{ <span class="hljs-attr">readPreference</span>: <span class="hljs-string">'primary'</span> }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {});

<span class="hljs-comment">// true, `transaction()` reset the document's state because the</span>
<span class="hljs-comment">// transaction was aborted.</span>
doc.<span class="hljs-property">isNew</span>;
</pre> </div>
<h3 id="Connection.prototype.useDb()">Connection.prototype.useDb()</h3>
<h5>Parameters:</h5>
<ul class="params">
<li class="param">
<code>name</code> <span class="method-type">«String»</span> The database name </li>
<li class="param">
<code>[options]</code> <span class="method-type">«Object»</span> </li>
<ul style="margin-top: 0.5em"><li>
<code>[options.useCache=false]</code> <span class="method-type">«Boolean»</span> If true, cache results so calling <code>useDb()</code> multiple times with the same name only creates 1 connection object. </li></ul>
<ul style="margin-top: 0.5em"><li>
<code>[options.noListener=false]</code> <span class="method-type">«Boolean»</span> If true, the connection object will not make the db listen to events on the original connection. See <a href="https://github.com/Automattic/mongoose/issues/9961">issue #9961</a>. </li></ul>
</ul>
<h5>Returns:</h5>
<ul><li>
<span class="method-type">«Connection»</span> New Connection Object</li></ul>
<div>
<p>Switches to a different database using the same <a href="connectionshtml.html#connection_pools">connection pool</a>.</p> <p>Returns a new connection object, with the new db.</p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript"><span class="hljs-comment">// Connect to `initialdb` first</span>
<span class="hljs-keyword">const</span> conn = <span class="hljs-keyword">await</span> mongoose.<span class="hljs-title function_">createConnection</span>(<span class="hljs-string">'mongodb://127.0.0.1:27017/initialdb'</span>).<span class="hljs-title function_">asPromise</span>();

<span class="hljs-comment">// Creates an un-cached connection to `mydb`</span>
<span class="hljs-keyword">const</span> db = conn.<span class="hljs-title function_">useDb</span>(<span class="hljs-string">'mydb'</span>);
<span class="hljs-comment">// Creates a cached connection to `mydb2`. All calls to `conn.useDb('mydb2', { useCache: true })` will return the same</span>
<span class="hljs-comment">// connection instance as opposed to creating a new connection instance</span>
<span class="hljs-keyword">const</span> db2 = conn.<span class="hljs-title function_">useDb</span>(<span class="hljs-string">'mydb2'</span>, { <span class="hljs-attr">useCache</span>: <span class="hljs-literal">true</span> });
</pre> </div>
<h3 id="Connection.prototype.user">Connection.prototype.user</h3>
<h5>Type:</h5>
<ul><li><span class="method-type">«property»</span></li></ul>
<div>
<p>The username specified in the URI</p> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript">mongoose.<span class="hljs-title function_">createConnection</span>(<span class="hljs-string">'mongodb://val:psw@127.0.0.1:27017/mydb'</span>).<span class="hljs-property">user</span>; <span class="hljs-comment">// "val"</span>
</pre> </div>
<h3 id="Connection.prototype.watch()">Connection.prototype.watch()</h3>
<h5>Parameters:</h5>
<ul class="params">
<li class="param">
<code>[pipeline]</code> <span class="method-type">«Array»</span> </li>
<li class="param">
<code>[options]</code> <span class="method-type">«Object»</span> passed without changes to <a href="https://mongodb.github.io/node-mongodb-native/4.9/classes/Db.html#watch">the MongoDB driver's <code>Db#watch()</code> function</a> </li>
</ul>
<h5>Returns:</h5>
<ul><li>
<span class="method-type">«ChangeStream»</span> mongoose-specific change stream wrapper, inherits from EventEmitter</li></ul>
<div>
<p>Watches the entire underlying database for changes. Similar to <a href="model.html#Model.watch()"><code>Model.watch()</code></a>.</p> <p>This function does <strong>not</strong> trigger any middleware. In particular, it does <strong>not</strong> trigger aggregate middleware.</p> <p>The ChangeStream object is an event emitter that emits the following events:</p> <ul> <li>'change': A change occurred, see below example</li> <li>'error': An unrecoverable error occurred. In particular, change streams currently error out if they lose connection to the replica set primary. Follow <a href="https://github.com/Automattic/mongoose/issues/6799">this GitHub issue</a> for updates.</li> <li>'end': Emitted if the underlying stream is closed</li> <li>'close': Emitted if the underlying stream is closed</li> </ul> <h4 id="example"> <a href="#example"> Example: </a> </h4> <pre data-language="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">User</span> = conn.<span class="hljs-title function_">model</span>(<span class="hljs-string">'User'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>({ <span class="hljs-attr">name</span>: <span class="hljs-title class_">String</span> }));

<span class="hljs-keyword">const</span> changeStream = conn.<span class="hljs-title function_">watch</span>().<span class="hljs-title function_">on</span>(<span class="hljs-string">'change'</span>, <span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data));

<span class="hljs-comment">// Triggers a 'change' event on the change stream.</span>
<span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">create</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'test'</span> });
</pre> </div>
</div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2010 LearnBoost<br>Licensed under the MIT License.<br>
    <a href="https://mongoosejs.com/docs/api/connection.html" class="_attribution-link">https://mongoosejs.com/docs/api/connection.html</a>
  </p>
</div>
