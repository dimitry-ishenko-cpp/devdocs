<h1 class="devsite-page-title">tf.compat.v1.layers.BatchNormalization</h1> <devsite-bookmark></devsite-bookmark>       <p>Batch Normalization layer from (Ioffe et al., 2015).</p> <p>Inherits From: <a href="../keras/layers/batchnormalization.html"><code translate="no" dir="ltr">BatchNormalization</code></a>, <a href="layer.html"><code translate="no" dir="ltr">Layer</code></a>, <a href="../../../keras/layers/layer.html"><code translate="no" dir="ltr">Layer</code></a>, <a href="../../../module.html"><code translate="no" dir="ltr">Module</code></a></p> <pre class="devsite-click-to-copy prettyprint lang-py tfo-signature-link" translate="no" dir="ltr" data-language="cpp">
tf.compat.v1.layers.BatchNormalization(
    axis=-1,
    momentum=0.99,
    epsilon=0.001,
    center=True,
    scale=True,
    beta_initializer=tf.compat.v1.zeros_initializer(),
    gamma_initializer=tf.compat.v1.ones_initializer(),
    moving_mean_initializer=tf.compat.v1.zeros_initializer(),
    moving_variance_initializer=tf.compat.v1.ones_initializer(),
    beta_regularizer=None,
    gamma_regularizer=None,
    beta_constraint=None,
    gamma_constraint=None,
    renorm=False,
    renorm_clipping=None,
    renorm_momentum=0.99,
    fused=None,
    trainable=True,
    virtual_batch_size=None,
    adjustment=None,
    name=None,
    **kwargs
)
</pre> <p><section><devsite-expandable expanded> <h2 class="showalways" id="migrate-to-tf2" data-text="Migrate to TF2">Migrate to TF2</h2></devsite-expandable></section></p> <aside class="caution"><strong>Caution:</strong><span> This API was designed for TensorFlow v1. Continue reading for details on how to migrate from this API to a native TensorFlow v2 equivalent. See the <a href="https://www.tensorflow.org/guide/migrate">TensorFlow v1 to TensorFlow v2 migration guide</a> for instructions on how to migrate the rest of your code.</span></aside> <p>This API is a legacy api that is only compatible with eager execution and <a href="../../../function.html"><code translate="no" dir="ltr">tf.function</code></a> if you combine it with <a href="../keras/utils/track_tf1_style_variables.html"><code translate="no" dir="ltr">tf.compat.v1.keras.utils.track_tf1_style_variables</code></a></p> <p>Please refer to <a href="https://www.tensorflow.org/guide/migrate/model_mapping">tf.layers model mapping section of the migration guide</a> to learn how to use your TensorFlow v1 model in TF2 with Keras.</p> <p>The corresponding TensorFlow v2 layer is <a href="../../../keras/layers/batchnormalization.html"><code translate="no" dir="ltr">tf.keras.layers.BatchNormalization</code></a>.</p> <h4 id="structural_mapping_to_native_tf2" data-text="Structural Mapping to Native TF2">Structural Mapping to Native TF2</h4> <p>None of the supported arguments have changed name.</p> <p>Before:</p> <pre class="prettyprint lang-python" translate="no" dir="ltr" data-language="python">bn = tf.compat.v1.layers.BatchNormalization()
</pre> <p>After:</p> <pre class="prettyprint lang-python" translate="no" dir="ltr" data-language="python">bn = tf.keras.layers.BatchNormalization()
</pre> <h4 id="how_to_map_arguments" data-text="How to Map Arguments">How to Map Arguments</h4> <table> <thead> <tr> <th style="text-align: left">TF1 Arg Name</th> <th style="text-align: left">TF2 Arg Name</th> <th style="text-align: left">Note</th> </tr> </thead> <tbody> <tr> <td style="text-align: left"><code translate="no" dir="ltr">name</code></td> <td style="text-align: left"><code translate="no" dir="ltr">name</code></td> <td style="text-align: left">Layer base class</td> </tr> <tr> <td style="text-align: left"><code translate="no" dir="ltr">trainable</code></td> <td style="text-align: left"><code translate="no" dir="ltr">trainable</code></td> <td style="text-align: left">Layer base class</td> </tr> <tr> <td style="text-align: left"><code translate="no" dir="ltr">axis</code></td> <td style="text-align: left"><code translate="no" dir="ltr">axis</code></td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code translate="no" dir="ltr">momentum</code></td> <td style="text-align: left"><code translate="no" dir="ltr">momentum</code></td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code translate="no" dir="ltr">epsilon</code></td> <td style="text-align: left"><code translate="no" dir="ltr">epsilon</code></td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code translate="no" dir="ltr">center</code></td> <td style="text-align: left"><code translate="no" dir="ltr">center</code></td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code translate="no" dir="ltr">scale</code></td> <td style="text-align: left"><code translate="no" dir="ltr">scale</code></td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code translate="no" dir="ltr">beta_initializer</code></td> <td style="text-align: left"><code translate="no" dir="ltr">beta_initializer</code></td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code translate="no" dir="ltr">gamma_initializer</code></td> <td style="text-align: left"><code translate="no" dir="ltr">gamma_initializer</code></td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code translate="no" dir="ltr">moving_mean_initializer</code></td> <td style="text-align: left"><code translate="no" dir="ltr">moving_mean_initializer</code></td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code translate="no" dir="ltr">beta_regularizer</code></td> <td style="text-align: left">`beta_regularizer'</td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code translate="no" dir="ltr">gamma_regularizer</code></td> <td style="text-align: left">`gamma_regularizer'</td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code translate="no" dir="ltr">beta_constraint</code></td> <td style="text-align: left">`beta_constraint'</td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code translate="no" dir="ltr">gamma_constraint</code></td> <td style="text-align: left">`gamma_constraint'</td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code translate="no" dir="ltr">renorm</code></td> <td style="text-align: left">Not supported</td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code translate="no" dir="ltr">renorm_clipping</code></td> <td style="text-align: left">Not supported</td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code translate="no" dir="ltr">renorm_momentum</code></td> <td style="text-align: left">Not supported</td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code translate="no" dir="ltr">fused</code></td> <td style="text-align: left">Not supported</td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code translate="no" dir="ltr">virtual_batch_size</code></td> <td style="text-align: left">Not supported</td> <td style="text-align: left">-</td> </tr> <tr> <td style="text-align: left"><code translate="no" dir="ltr">adjustment</code></td> <td style="text-align: left">Not supported</td> <td style="text-align: left">-</td> </tr> </tbody> </table>  <h2 id="description" data-text="Description">Description</h2>  <p>Keras APIs handle BatchNormalization updates to the moving_mean and moving_variance as part of their <code translate="no" dir="ltr">fit()</code> and <code translate="no" dir="ltr">evaluate()</code> loops. However, if a custom training loop is used with an instance of <code translate="no" dir="ltr">Model</code>, these updates need to be explicitly included. Here's a simple example of how it can be done:</p> <pre class="prettyprint lang-python" translate="no" dir="ltr" data-language="python"># model is an instance of Model that contains BatchNormalization layer.
update_ops = model.get_updates_for(None) + model.get_updates_for(features)
train_op = optimizer.minimize(loss)
train_op = tf.group([train_op, update_ops])
</pre>  
<table class="responsive fixed orange"> <colgroup>
<col width="214px">
<col>
</colgroup> <tr><th colspan="2">Args</th></tr> 
<tr> <td> <code translate="no" dir="ltr">axis</code> </td> <td> An <code translate="no" dir="ltr">int</code> or list of <code translate="no" dir="ltr">int</code>, the axis or axes that should be normalized, typically the features axis/axes. For instance, after a <code translate="no" dir="ltr">Conv2D</code> layer with <code translate="no" dir="ltr">data_format="channels_first"</code>, set <code translate="no" dir="ltr">axis=1</code>. If a list of axes is provided, each axis in <code translate="no" dir="ltr">axis</code> will be normalized simultaneously. Default is <code translate="no" dir="ltr">-1</code> which uses the last axis. Note: when using multi-axis batch norm, the <code translate="no" dir="ltr">beta</code>, <code translate="no" dir="ltr">gamma</code>, <code translate="no" dir="ltr">moving_mean</code>, and <code translate="no" dir="ltr">moving_variance</code> variables are the same rank as the input Tensor, with dimension size 1 in all reduced (non-axis) dimensions). </td> </tr>
<tr> <td> <code translate="no" dir="ltr">momentum</code> </td> <td> Momentum for the moving average. </td> </tr>
<tr> <td> <code translate="no" dir="ltr">epsilon</code> </td> <td> Small float added to variance to avoid dividing by zero. </td> </tr>
<tr> <td> <code translate="no" dir="ltr">center</code> </td> <td> If True, add offset of <code translate="no" dir="ltr">beta</code> to normalized tensor. If False, <code translate="no" dir="ltr">beta</code> is ignored. </td> </tr>
<tr> <td> <code translate="no" dir="ltr">scale</code> </td> <td> If True, multiply by <code translate="no" dir="ltr">gamma</code>. If False, <code translate="no" dir="ltr">gamma</code> is not used. When the next layer is linear (also e.g. <a href="https://www.tensorflow.org/api_docs/python/tf/nn/relu"><code translate="no" dir="ltr">nn.relu</code></a>), this can be disabled since the scaling can be done by the next layer. </td> </tr>
<tr> <td> <code translate="no" dir="ltr">beta_initializer</code> </td> <td> Initializer for the beta weight. </td> </tr>
<tr> <td> <code translate="no" dir="ltr">gamma_initializer</code> </td> <td> Initializer for the gamma weight. </td> </tr>
<tr> <td> <code translate="no" dir="ltr">moving_mean_initializer</code> </td> <td> Initializer for the moving mean. </td> </tr>
<tr> <td> <code translate="no" dir="ltr">moving_variance_initializer</code> </td> <td> Initializer for the moving variance. </td> </tr>
<tr> <td> <code translate="no" dir="ltr">beta_regularizer</code> </td> <td> Optional regularizer for the beta weight. </td> </tr>
<tr> <td> <code translate="no" dir="ltr">gamma_regularizer</code> </td> <td> Optional regularizer for the gamma weight. </td> </tr>
<tr> <td> <code translate="no" dir="ltr">beta_constraint</code> </td> <td> An optional projection function to be applied to the <code translate="no" dir="ltr">beta</code> weight after being updated by an <code translate="no" dir="ltr">Optimizer</code> (e.g. used to implement norm constraints or value constraints for layer weights). The function must take as input the unprojected variable and must return the projected variable (which must have the same shape). Constraints are not safe to use when doing asynchronous distributed training. </td> </tr>
<tr> <td> <code translate="no" dir="ltr">gamma_constraint</code> </td> <td> An optional projection function to be applied to the <code translate="no" dir="ltr">gamma</code> weight after being updated by an <code translate="no" dir="ltr">Optimizer</code>. </td> </tr>
<tr> <td> <code translate="no" dir="ltr">renorm</code> </td> <td> Whether to use Batch Renormalization (Ioffe, 2017). This adds extra variables during training. The inference is the same for either value of this parameter. </td> </tr>
<tr> <td> <code translate="no" dir="ltr">renorm_clipping</code> </td> <td> A dictionary that may map keys 'rmax', 'rmin', 'dmax' to scalar <code translate="no" dir="ltr">Tensors</code> used to clip the renorm correction. The correction <code translate="no" dir="ltr">(r, d)</code> is used as <code translate="no" dir="ltr">corrected_value = normalized_value * r + d</code>, with <code translate="no" dir="ltr">r</code> clipped to [rmin, rmax], and <code translate="no" dir="ltr">d</code> to [-dmax, dmax]. Missing rmax, rmin, dmax are set to inf, 0, inf, respectively. </td> </tr>
<tr> <td> <code translate="no" dir="ltr">renorm_momentum</code> </td> <td> Momentum used to update the moving means and standard deviations with renorm. Unlike <code translate="no" dir="ltr">momentum</code>, this affects training and should be neither too small (which would add noise) nor too large (which would give stale estimates). Note that <code translate="no" dir="ltr">momentum</code> is still applied to get the means and variances for inference. </td> </tr>
<tr> <td> <code translate="no" dir="ltr">fused</code> </td> <td> if <code translate="no" dir="ltr">None</code> or <code translate="no" dir="ltr">True</code>, use a faster, fused implementation if possible. If <code translate="no" dir="ltr">False</code>, use the system recommended implementation. </td> </tr>
<tr> <td> <code translate="no" dir="ltr">trainable</code> </td> <td> Boolean, if <code translate="no" dir="ltr">True</code> also add variables to the graph collection <code translate="no" dir="ltr">GraphKeys.TRAINABLE_VARIABLES</code> (see tf.Variable). </td> </tr>
<tr> <td> <code translate="no" dir="ltr">virtual_batch_size</code> </td> <td> An <code translate="no" dir="ltr">int</code>. By default, <code translate="no" dir="ltr">virtual_batch_size</code> is <code translate="no" dir="ltr">None</code>, which means batch normalization is performed across the whole batch. When <code translate="no" dir="ltr">virtual_batch_size</code> is not <code translate="no" dir="ltr">None</code>, instead perform "Ghost Batch Normalization", which creates virtual sub-batches which are each normalized separately (with shared gamma, beta, and moving statistics). Must divide the actual batch size during execution. </td> </tr>
<tr> <td> <code translate="no" dir="ltr">adjustment</code> </td> <td> A function taking the <code translate="no" dir="ltr">Tensor</code> containing the (dynamic) shape of the input tensor and returning a pair (scale, bias) to apply to the normalized values (before gamma and beta), only during training. For example, if axis==-1, <code translate="no" dir="ltr">adjustment = lambda shape: ( tf.random.uniform(shape[-1:], 0.93, 1.07), tf.random.uniform(shape[-1:], -0.1, 0.1))</code> will scale the normalized value by up to 7% up or down, then shift the result by up to 0.1 (with independent scaling and bias for each feature but shared across all examples), and finally apply gamma and/or beta. If <code translate="no" dir="ltr">None</code>, no adjustment is applied. Cannot be specified if virtual_batch_size is specified. </td> </tr>
<tr> <td> <code translate="no" dir="ltr">name</code> </td> <td> A string, the name of the layer. </td> </tr> </table> <h4 id="references" data-text="References:">References:</h4> <p>Batch Normalization - Accelerating Deep Network Training by Reducing Internal Covariate Shift: <a href="http://proceedings.mlr.press/v37/ioffe15.html">Ioffe et al., 2015</a> (<a href="http://proceedings.mlr.press/v37/ioffe15.pdf">pdf</a>) Batch Renormalization - Towards Reducing Minibatch Dependence in Batch-Normalized Models: <a href="http://papers.nips.cc/paper/6790-batch-renormalization-towards-reducing-minibatch-dependence-in-batch-normalized-models">Ioffe, 2017</a> (<a href="http://papers.nips.cc/paper/6790-batch-renormalization-towards-reducing-minibatch-dependence-in-batch-normalized-models.pdf">pdf</a>)</p>  
<table class="responsive fixed orange"> <colgroup>
<col width="214px">
<col>
</colgroup> <tr><th colspan="2">Attributes</th></tr> 
<tr> <td> <code translate="no" dir="ltr">graph</code> </td> <td> 
</td> </tr>
<tr> <td> <code translate="no" dir="ltr">scope_name</code> </td> <td> 
</td> </tr> </table> <h2 id="methods" data-text="Methods">Methods</h2> <h3 id="apply" data-text="apply"><code translate="no" dir="ltr">apply</code></h3> <p><a target="_blank" class="external" href="https://github.com/keras-team/keras/tree/v2.9.0/keras/legacy_tf_layers/base.py#L239-L240">View source</a></p> <pre class="devsite-click-to-copy prettyprint lang-py tfo-signature-link" translate="no" dir="ltr" data-language="cpp">
apply(
    *args, **kwargs
)
</pre> <h3 id="get_losses_for" data-text="get_losses_for"><code translate="no" dir="ltr">get_losses_for</code></h3> <p><a target="_blank" class="external" href="https://github.com/keras-team/keras/tree/v2.9.0/keras/engine/base_layer_v1.py#L1341-L1358">View source</a></p> <pre class="devsite-click-to-copy prettyprint lang-py tfo-signature-link" translate="no" dir="ltr" data-language="cpp">
get_losses_for(
    inputs
)
</pre> <p>Retrieves losses relevant to a specific set of inputs.</p>  
<table class="responsive fixed orange"> <colgroup>
<col width="214px">
<col>
</colgroup> <tr><th colspan="2">Args</th></tr> 
<tr> <td> <code translate="no" dir="ltr">inputs</code> </td> <td> Input tensor or list/tuple of input tensors. </td> </tr> </table>  
<table class="responsive fixed orange"> <colgroup>
<col width="214px">
<col>
</colgroup> <tr><th colspan="2">Returns</th></tr> <tr class="alt"> <td colspan="2"> List of loss tensors of the layer that depend on <code translate="no" dir="ltr">inputs</code>. </td> </tr> 
</table> <h3 id="get_updates_for" data-text="get_updates_for"><code translate="no" dir="ltr">get_updates_for</code></h3> <p><a target="_blank" class="external" href="https://github.com/keras-team/keras/tree/v2.9.0/keras/engine/base_layer_v1.py#L1322-L1339">View source</a></p> <pre class="devsite-click-to-copy prettyprint lang-py tfo-signature-link" translate="no" dir="ltr" data-language="cpp">
get_updates_for(
    inputs
)
</pre> <p>Retrieves updates relevant to a specific set of inputs.</p>  
<table class="responsive fixed orange"> <colgroup>
<col width="214px">
<col>
</colgroup> <tr><th colspan="2">Args</th></tr> 
<tr> <td> <code translate="no" dir="ltr">inputs</code> </td> <td> Input tensor or list/tuple of input tensors. </td> </tr> </table>  
<table class="responsive fixed orange"> <colgroup>
<col width="214px">
<col>
</colgroup> <tr><th colspan="2">Returns</th></tr> <tr class="alt"> <td colspan="2"> List of update ops of the layer that depend on <code translate="no" dir="ltr">inputs</code>. </td> </tr> 
</table>  <devsite-thumb-rating position="footer"> </devsite-thumb-rating><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2022 The TensorFlow Authors. All rights reserved.<br>Licensed under the Creative Commons Attribution License 4.0.<br>Code samples licensed under the Apache 2.0 License.<br>
    <a href="https://www.tensorflow.org/versions/r2.9/api_docs/python/tf/compat/v1/layers/BatchNormalization" class="_attribution-link">https://www.tensorflow.org/versions/r2.9/api_docs/python/tf/compat/v1/layers/BatchNormalization</a>
  </p>
</div>
