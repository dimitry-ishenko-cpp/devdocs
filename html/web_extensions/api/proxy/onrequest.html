<h1>proxy.onRequest</h1>
<div class="section-content">
<p>Fired when a web request is about to be made, to give the extension an opportunity to proxy it.</p> <p>This event is closely modeled on the events defined in the <a href="../webrequest.html"><code>webRequest</code></a> API. Like those events, its <code>addListener()</code> function takes three arguments:</p> <ul> <li>the listener that is called when the event is fired.</li> <li>a <a href="../webrequest/requestfilter.html"><code>RequestFilter</code></a> object controlling which requests cause the event to fire.</li> <li>an array of strings to control other aspects of the event's behavior.</li> </ul> <p>The event is fired before any of the <code>webRequest</code> events for the same request.</p> <p>When the event is fired, the listener is called with an object containing information about the request. The listener returns a <a href="proxyinfo.html"><code>proxy.ProxyInfo</code></a> object representing a proxy to use (or an array of <a href="proxyinfo.html"><code>proxy.ProxyInfo</code></a> objects, enabling the browser to fail over if a proxy is unreachable).</p> <p>To use <code>proxy.onRequest</code>, an extension must have the "proxy" <a href="../../manifest.json/permissions.html#api_permissions">API permission</a> and the <a href="../../manifest.json/permissions.html#host_permissions">host permission</a> for the URLs of the requests that it intercepts, which means that the match patterns in the <code>filter</code> argument must be a subset of the extension's host permissions.</p>
</div>
<section aria-labelledby="syntax"><h2 id="syntax">Syntax</h2>
<div class="section-content">
<div class="code-example"><pre data-language="js">browser<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>onRequest<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>
  listener<span class="token punctuation">,</span>             <span class="token comment">//  function</span>
  filter<span class="token punctuation">,</span>               <span class="token comment">//  object</span>
  extraInfoSpec         <span class="token comment">//  optional array of strings</span>
<span class="token punctuation">)</span>
browser<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>onRequest<span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
browser<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>onRequest<span class="token punctuation">.</span><span class="token function">hasListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
</pre></div> <p>Events have three functions:</p> <dl> <dt id="addlistenerlistener_filter_extrainfospec"><code>addListener(listener, filter, extraInfoSpec)</code></dt> <dd> <p>Adds a listener to this event.</p> </dd> <dt id="removelistenerlistener"><code>removeListener(listener)</code></dt> <dd> <p>Stop listening to this event. The <code>listener</code> argument is the listener to remove.</p> </dd> <dt id="haslistenerlistener"><code>hasListener(listener)</code></dt> <dd> <p>Check whether <code>listener</code> is registered for this event. Returns <code>true</code> if it is listening, <code>false</code> otherwise.</p> </dd> </dl>
</div></section><section aria-labelledby="addlistener_syntax"><h2 id="addlistener_syntax">addListener syntax</h2>
</section><section aria-labelledby="parameters"><h3 id="parameters">Parameters</h3>
<div class="section-content"><dl> <dt id="listener"><code>listener</code></dt> <dd> <p>The function that is called when this event occurs. The function is passed a single argument, which is a <a href="requestdetails.html"><code>proxy.RequestDetails</code></a> object containing details of the request.</p> <p>The listener can return any of:</p> <ul> <li>a <a href="proxyinfo.html"><code>proxy.ProxyInfo</code></a> object.</li> <li>an array of <a href="proxyinfo.html"><code>proxy.ProxyInfo</code></a> objects.</li> <li>a <code>Promise</code> that resolves to a <code>ProxyInfo</code> object.</li> <li>a <code>Promise</code> that resolves to an array of <code>ProxyInfo</code> objects.</li> </ul> <p>If the listener returns an array, or a Promise that resolves to an array, then all <code>ProxyInfo</code> objects after the first one represent failovers: if the proxy at position N in the array is not reachable when its <code>ProxyInfo.failoverTimeout</code> expires the browser will try the proxy at position N+1.</p> <p>If there is an error specifying the <a href="proxyinfo.html"><code>proxy.ProxyInfo</code></a> objects, then <a href="onerror.html"><code>proxy.onError</code></a> is called.</p> </dd> <dt id="filter"><code>filter</code></dt> <dd> <p><a href="../webrequest/requestfilter.html"><code>webRequest.RequestFilter</code></a>. A set of filters that restricts the events that are sent to the listener.</p> </dd> <dt id="extrainfospec">
<code>extraInfoSpec</code> <span class="badge inline optional">Optional</span>
</dt> <dd> <p><code>array</code> of <code>string</code>. Extra options for the event. Pass <code>"requestHeaders"</code> to include the request headers in the <code>details</code> object passed to the listener.</p> </dd> </dl></div></section><h2 id="browser_compatibility">Browser compatibility</h2>
<div class="_table"><table>
<thead>
<tr id="bct-browser-type">
<th></th>
<th colspan="6">Desktop</th>
<th colspan="6">Mobile</th>
</tr>
<tr id="bct-browsers">
<th></th>
<th>Chrome</th>
<th>Edge</th>
<th>Firefox</th>
<th>Internet Explorer</th>
<th>Opera</th>
<th>Safari</th>
<th>WebView Android</th>
<th>Chrome Android</th>
<th>Firefox for Android</th>
<th>Opera Android</th>
<th>Safari on IOS</th>
<th>Samsung Internet</th>
</tr>
</thead>
<tbody><tr>
<th><code>onRequest</code></th>
<td class="bc-supports-no">No</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-yes"><details><summary>60</summary>Before version 78, the <code>tabId</code> and <code>windowId</code> filter properties are ignored.</details></td>
<td>?</td>
<td class="bc-supports-no">No</td>
<td class="bc-supports-no">No</td>
<td>?</td>
<td>?</td>
<td class="bc-supports-yes">60</td>
<td>?</td>
<td class="bc-supports-no">No</td>
<td>?</td>
</tr></tbody>
</table></div>
<section aria-labelledby="examples"><h2 id="examples">Examples</h2>
<div class="section-content">
<p>This code intercepts requests to <code>&lt;all_urls&gt;</code>, and proxies them if they are not for a top-level frame.</p> <div class="code-example"><pre data-language="js"><span class="token keyword">function</span> <span class="token function">shouldProxyRequest</span><span class="token punctuation">(</span><span class="token parameter">requestInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> requestInfo<span class="token punctuation">.</span>parentFrameId <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">handleProxyRequest</span><span class="token punctuation">(</span><span class="token parameter">requestInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldProxyRequest</span><span class="token punctuation">(</span>requestInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Proxying: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>requestInfo<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"http"</span><span class="token punctuation">,</span> <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">65535</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"direct"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

browser<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>onRequest<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>handleProxyRequest<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">urls</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"&lt;all_urls&gt;"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre></div>
</div></section><section aria-labelledby="example_extensions"><h3 id="example_extensions">Example extensions</h3>
<div class="section-content"><ul><li><a href="https://github.com/mdn/webextensions-examples/tree/master/proxy-blocker" target="_blank">proxy-blocker</a></li></ul></div></section><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2005&ndash;2023 MDN contributors.<br>Licensed under the Creative Commons Attribution-ShareAlike License v2.5 or later.<br>
    <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/proxy/onRequest" class="_attribution-link">https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/proxy/onRequest</a>
  </p>
</div>
