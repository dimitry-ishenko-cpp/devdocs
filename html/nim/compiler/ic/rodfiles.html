<h1 class="title">ic/rodfiles</h1> <a href="https://github.com/nim-lang/Nim/tree/version-2-0/compiler/ic/rodfiles.nim#L1" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/compiler/ic/rodfiles.nim#L1" target="_blank">Edit</a>  
<p>Low level binary format used by the compiler to store and load various AST and related data.</p> <p>NB: this is incredibly low level and if you're interested in how the compiler works and less a storage format, you're probably looking for the <code><span class="Identifier">ic</span></code> or <code><span class="Identifier">packed_ast</span></code> modules to understand the logical format.</p> <h2 id="overview">Overview</h2>
<p><code><span class="Identifier">RodFile</span></code> represents a Rod File (versioned binary format), and the associated data for common interactions such as IO and error tracking (<code><span class="Identifier">RodFileError</span></code>). The file format broken up into sections (<code><span class="Identifier">RodSection</span></code>) and preceded by a header (see: <code><span class="Identifier">cookie</span></code>). The precise layout, section ordering and data following the section are determined by the user. See <code><span class="Identifier">ic</span><span class="Operator">.</span><span class="Identifier">loadRodFile</span></code>.</p> <h3 id="overview-a-basic-but-wrong-example-of-the-lifecyclecolon">A basic but "wrong" example of the lifecycle:</h3>
<ol class="simple">
<li>
<code><span class="Identifier">create</span></code> or <code><span class="Identifier">open</span></code> - create a new one or open an existing</li> <li>
<code><span class="Identifier">storeHeader</span></code> - header info</li> <li>
<code><span class="Identifier">storePrim</span></code> or <code><span class="Identifier">storeSeq</span></code> - save your stuff</li> <li>
<code><span class="Identifier">close</span></code> - and we're done</li> </ol> <p>Now read the bits below to understand what's missing.</p> <h4 id="a-basic-but-wrong-example-of-the-lifecyclecolon-issues-with-the-example">Issues with the Example</h4>
<p>Missing Sections: This is a low level API, so headers and sections need to be stored and loaded by the user, see <code><span class="Identifier">storeHeader</span></code> &amp; <code><span class="Identifier">loadHeader</span></code> and <code><span class="Identifier">storeSection</span></code> &amp; <code><span class="Identifier">loadSection</span></code>, respectively.</p> <p>No Error Handling: The API is centered around IO and prone to error, each operation checks or sets the <code><span class="Identifier">RodFile</span><span class="Operator">.</span><span class="Identifier">err</span></code> field. A user of this API needs to handle these appropriately.</p> <h2 id="api-notes">API Notes</h2> <h3 id="api-notes-valid-inputs-for-rod-files">Valid inputs for Rod files</h3>
<p>ASTs, hopes, dreams, and anything as long as it and any children it may have support <code><span class="Identifier">copyMem</span></code>. This means anything that is not a pointer and that does not contain a pointer. At a glance these are:</p> <ul class="simple">
<li>string</li> <li>objects &amp; tuples (fields are recursed)</li> <li>sequences AKA <code><span class="Identifier">seq</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span></code>
</li> </ul> <h3 id="api-notes-note-on-error-handling-style">Note on error handling style</h3>
<p>A flag based approach is used where operations no-op in case of a preexisting error and set the flag if they encounter one.</p> <h3 id="api-notes-misc">Misc</h3>
<ul class="simple">
<li>'Prim' is short for 'primitive', as in a non-sequence type</li> </ul>  <h2 id="7">Types</h2> <dl> <div id="RodFile"> <dt><pre data-language="nim">RodFile = object
  f*: File
  currentSection*: RodSection
  err*: RodFileError</pre></dt> <dd> <a href="https://github.com/nim-lang/Nim/tree/version-2-0/compiler/ic/rodfiles.nim#L105" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/compiler/ic/rodfiles.nim#L105" target="_blank">Edit</a> </dd> </div> <div id="RodFileError"> <dt><pre data-language="nim">RodFileError = enum
  ok, tooBig, cannotOpen, ioFailure, wrongHeader, wrongSection, configMismatch,
  includeFileChanged</pre></dt> <dd> <a href="https://github.com/nim-lang/Nim/tree/version-2-0/compiler/ic/rodfiles.nim#L101" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/compiler/ic/rodfiles.nim#L101" target="_blank">Edit</a> </dd> </div> <div id="RodSection"> <dt><pre data-language="nim">RodSection = enum
  versionSection, configSection, stringsSection, checkSumsSection, depsSection,
  numbersSection, exportsSection, hiddenSection, reexportsSection,
  compilerProcsSection, trmacrosSection, convertersSection, methodsSection,
  pureEnumsSection, toReplaySection, topLevelSection, bodiesSection,
  symsSection, typesSection, typeInstCacheSection, procInstCacheSection,
  attachedOpsSection, methodsPerTypeSection, enumToStringProcsSection,
  typeInfoSection, backendFlagsSection, aliveSymsSection</pre></dt> <dd> <a href="https://github.com/nim-lang/Nim/tree/version-2-0/compiler/ic/rodfiles.nim#L72" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/compiler/ic/rodfiles.nim#L72" target="_blank">Edit</a> </dd> </div> </dl>   <h2 id="12">Procs</h2> <dl> <div id="close-procs-all"> <div id="close,RodFile"> <dt><pre data-language="nim">proc close(f: var RodFile) {....raises: [], tags: [], forbids: [].}</pre></dt> <dd> <a href="https://github.com/nim-lang/Nim/tree/version-2-0/compiler/ic/rodfiles.nim#L244" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/compiler/ic/rodfiles.nim#L244" target="_blank">Edit</a> </dd> </div> </div> <div id="create-procs-all"> <div id="create,string"> <dt><pre data-language="nim">proc create(filename: string): RodFile {....raises: [], tags: [], forbids: [].}</pre></dt> <dd> create the file and open it for writing <a href="https://github.com/nim-lang/Nim/tree/version-2-0/compiler/ic/rodfiles.nim#L239" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/compiler/ic/rodfiles.nim#L239" target="_blank">Edit</a> </dd> </div> </div> <div id="loadHeader-procs-all"> <div id="loadHeader,RodFile"> <dt><pre data-language="nim">proc loadHeader(f: var RodFile) {....raises: [IOError], tags: [ReadIOEffect],
                                  forbids: [].}</pre></dt> <dd> Loads the header which is described by <code><span class="Identifier">cookie</span></code>. <a href="https://github.com/nim-lang/Nim/tree/version-2-0/compiler/ic/rodfiles.nim#L215" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/compiler/ic/rodfiles.nim#L215" target="_blank">Edit</a> </dd> </div> </div> <div id="loadPrim-procs-all"> <div id="loadPrim,RodFile,string"> <dt><pre data-language="nim">proc loadPrim(f: var RodFile; s: var string) {....raises: [IOError],
    tags: [ReadIOEffect], forbids: [].}</pre></dt> <dd> Read a string, the length was stored as a prefix <a href="https://github.com/nim-lang/Nim/tree/version-2-0/compiler/ic/rodfiles.nim#L168" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/compiler/ic/rodfiles.nim#L168" target="_blank">Edit</a> </dd> </div> <div id="loadPrim,RodFile,T"> <dt><pre data-language="nim">proc loadPrim[T](f: var RodFile; x: var T)</pre></dt> <dd> Load a non-sequence/string <code><span class="Identifier">T</span></code>. <a href="https://github.com/nim-lang/Nim/tree/version-2-0/compiler/ic/rodfiles.nim#L180" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/compiler/ic/rodfiles.nim#L180" target="_blank">Edit</a> </dd> </div> </div> <div id="loadSection-procs-all"> <div id="loadSection,RodFile,RodSection"> <dt><pre data-language="nim">proc loadSection(f: var RodFile; expected: RodSection) {....raises: [IOError],
    tags: [ReadIOEffect], forbids: [].}</pre></dt> <dd> read the bytes value of s, sets and error if the section is incorrect. <a href="https://github.com/nim-lang/Nim/tree/version-2-0/compiler/ic/rodfiles.nim#L231" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/compiler/ic/rodfiles.nim#L231" target="_blank">Edit</a> </dd> </div> </div> <div id="loadSeq-procs-all"> <div id="loadSeq,RodFile,seq[T]"> <dt><pre data-language="nim">proc loadSeq[T](f: var RodFile; s: var seq[T])</pre></dt> <dd> <code><span class="Identifier">T</span></code> must be compatible with <code><span class="Identifier">copyMem</span></code>, see <code><span class="Identifier">loadPrim</span></code> <a href="https://github.com/nim-lang/Nim/tree/version-2-0/compiler/ic/rodfiles.nim#L198" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/compiler/ic/rodfiles.nim#L198" target="_blank">Edit</a> </dd> </div> </div> <div id="open-procs-all"> <div id="open,string"> <dt><pre data-language="nim">proc open(filename: string): RodFile {....raises: [], tags: [], forbids: [].}</pre></dt> <dd> open the file for reading <a href="https://github.com/nim-lang/Nim/tree/version-2-0/compiler/ic/rodfiles.nim#L246" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/compiler/ic/rodfiles.nim#L246" target="_blank">Edit</a> </dd> </div> </div> <div id="storeHeader-procs-all"> <div id="storeHeader,RodFile"> <dt><pre data-language="nim">proc storeHeader(f: var RodFile) {....raises: [IOError], tags: [WriteIOEffect],
                                   forbids: [].}</pre></dt> <dd> stores the header which is described by <code><span class="Identifier">cookie</span></code>. <a href="https://github.com/nim-lang/Nim/tree/version-2-0/compiler/ic/rodfiles.nim#L209" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/compiler/ic/rodfiles.nim#L209" target="_blank">Edit</a> </dd> </div> </div> <div id="storePrim-procs-all"> <div id="storePrim,RodFile,string"> <dt><pre data-language="nim">proc storePrim(f: var RodFile; s: string) {....raises: [IOError],
    tags: [WriteIOEffect], forbids: [].}</pre></dt> <dd> Stores a string. The len is prefixed to allow for later retreival. <a href="https://github.com/nim-lang/Nim/tree/version-2-0/compiler/ic/rodfiles.nim#L120" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/compiler/ic/rodfiles.nim#L120" target="_blank">Edit</a> </dd> </div> <div id="storePrim,RodFile,T"> <dt><pre data-language="nim">proc storePrim[T](f: var RodFile; x: T)</pre></dt> <dd> Stores a non-sequence/string <code><span class="Identifier">T</span></code>. If <code><span class="Identifier">T</span></code> doesn't support <code><span class="Identifier">copyMem</span></code> and is an object or tuple then the fields are written -- the user from context will need to know which <code><span class="Identifier">T</span></code> to load. <a href="https://github.com/nim-lang/Nim/tree/version-2-0/compiler/ic/rodfiles.nim#L135" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/compiler/ic/rodfiles.nim#L135" target="_blank">Edit</a> </dd> </div> </div> <div id="storeSection-procs-all"> <div id="storeSection,RodFile,RodSection"> <dt><pre data-language="nim">proc storeSection(f: var RodFile; s: RodSection) {....raises: [IOError],
    tags: [WriteIOEffect], forbids: [].}</pre></dt> <dd> update <code><span class="Identifier">currentSection</span></code> and writes the bytes value of s. <a href="https://github.com/nim-lang/Nim/tree/version-2-0/compiler/ic/rodfiles.nim#L224" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/compiler/ic/rodfiles.nim#L224" target="_blank">Edit</a> </dd> </div> </div> <div id="storeSeq-procs-all"> <div id="storeSeq,RodFile,seq[T]"> <dt><pre data-language="nim">proc storeSeq[T](f: var RodFile; s: seq[T])</pre></dt> <dd> Stores a sequence of <code><span class="Identifier">T</span></code>s, with the len as a prefix for later retrieval. <a href="https://github.com/nim-lang/Nim/tree/version-2-0/compiler/ic/rodfiles.nim#L155" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/compiler/ic/rodfiles.nim#L155" target="_blank">Edit</a> </dd> </div> </div> </dl><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2006&ndash;2024 Andreas Rumpf<br>Licensed under the MIT License.<br>
    <a href="https://nim-lang.org/docs/compiler/ic/rodfiles.html" class="_attribution-link">https://nim-lang.org/docs/compiler/ic/rodfiles.html</a>
  </p>
</div>
