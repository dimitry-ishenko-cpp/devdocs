<h1 class="title">std/sharedtables</h1> <a href="https://github.com/nim-lang/Nim/tree/version-2-0/lib/pure/collections/sharedtables.nim#L1" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L1" target="_blank">Edit</a>  <div class="deprecation-message"> <b>Deprecated</b> </div> 
<p>Shared table support for Nim. Use plain old non GC'ed keys and values or you'll be in trouble. Uses a single lock to protect the table, lockfree implementations welcome but if lock contention is so high that you need a lockfree hash table, you're doing it wrong.</p> <p>Unstable API.</p>  <h2 id="6">Imports</h2> <dl> <a href="hashes.html">hashes</a>, <a href="math.html">math</a>, <a href="locks.html">locks</a>, <a href="outparams.html">outparams</a> </dl>   <h2 id="7">Types</h2> <dl> <div id="SharedTable"> <dt><pre data-language="nim">SharedTable[A; B] = object</pre></dt> <dd> generic hash SharedTable <a href="https://github.com/nim-lang/Nim/tree/version-2-0/lib/pure/collections/sharedtables.nim#L25" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L25" target="_blank">Edit</a> </dd> </div> </dl>   <h2 id="10">Consts</h2> <dl> <div id="defaultInitialSize"> <dt><pre>defaultInitialSize = 32</pre></dt> <dd> <a href="https://github.com/nim-lang/Nim/tree/version-2-0/lib/pure/collections/tableimpl.nim#L15" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/tableimpl.nim#L15" target="_blank">Edit</a> </dd> </div> </dl>   <h2 id="12">Procs</h2> <dl> <div id="[]=-procs-all"> <div id="[]=,SharedTable[A,B],A,B"> <dt><pre data-language="nim">proc `[]=`[A, B](t: var SharedTable[A, B]; key: A; val: B)</pre></dt> <dd> Puts a (key, value)-pair into <code><span class="Identifier">t</span></code>. <a href="https://github.com/nim-lang/Nim/tree/version-2-0/lib/pure/collections/sharedtables.nim#L218" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L218" target="_blank">Edit</a> </dd> </div> </div> <div id="add-procs-all"> <div id="add,SharedTable[A,B],A,B"> <dt><pre data-language="nim">proc add[A, B](t: var SharedTable[A, B]; key: A; val: B)</pre></dt> <dd> Puts a new (key, value)-pair into <code><span class="Identifier">t</span></code> even if <code><span class="Identifier">t</span><span class="Punctuation">[</span><span class="Identifier">key</span><span class="Punctuation">]</span></code> already exists. This can introduce duplicate keys into the table! <a href="https://github.com/nim-lang/Nim/tree/version-2-0/lib/pure/collections/sharedtables.nim#L223" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L223" target="_blank">Edit</a> </dd> </div> </div> <div id="deinitSharedTable-procs-all"> <div id="deinitSharedTable,SharedTable[A,B]"> <dt><pre data-language="nim">proc deinitSharedTable[A, B](t: var SharedTable[A, B])</pre></dt> <dd> <a href="https://github.com/nim-lang/Nim/tree/version-2-0/lib/pure/collections/sharedtables.nim#L250" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L250" target="_blank">Edit</a> </dd> </div> </div> <div id="del-procs-all"> <div id="del,SharedTable[A,B],A"> <dt><pre data-language="nim">proc del[A, B](t: var SharedTable[A, B]; key: A)</pre></dt> <dd> Deletes <code><span class="Identifier">key</span></code> from hash table <code><span class="Identifier">t</span></code>. <a href="https://github.com/nim-lang/Nim/tree/version-2-0/lib/pure/collections/sharedtables.nim#L229" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L229" target="_blank">Edit</a> </dd> </div> </div> <div id="hasKeyOrPut-procs-all"> <div id="hasKeyOrPut,SharedTable[A,B],A,B"> <dt><pre data-language="nim">proc hasKeyOrPut[A, B](t: var SharedTable[A, B]; key: A; val: B): bool</pre></dt> <dd> Returns true if <code><span class="Identifier">key</span></code> is in the table, otherwise inserts <code><span class="Identifier">value</span></code>. <a href="https://github.com/nim-lang/Nim/tree/version-2-0/lib/pure/collections/sharedtables.nim#L161" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L161" target="_blank">Edit</a> </dd> </div> </div> <div id="init-procs-all"> <div id="init,SharedTable[A,B],int"> <dt><pre data-language="nim">proc init[A, B](t: var SharedTable[A, B]; initialSize = 32)</pre></dt> <dd> <p>Creates a new hash table that is empty.</p> <p>This proc must be called before any other usage of <code><span class="Identifier">t</span></code>.</p> <a href="https://github.com/nim-lang/Nim/tree/version-2-0/lib/pure/collections/sharedtables.nim#L239" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L239" target="_blank">Edit</a> </dd> </div> </div> <div id="len-procs-all"> <div id="len,SharedTable[A,B]"> <dt><pre data-language="nim">proc len[A, B](t: var SharedTable[A, B]): int</pre></dt> <dd> Number of elements in <code><span class="Identifier">t</span></code>. <a href="https://github.com/nim-lang/Nim/tree/version-2-0/lib/pure/collections/sharedtables.nim#L234" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L234" target="_blank">Edit</a> </dd> </div> </div> <div id="mget-procs-all"> <div id="mget,SharedTable[A,B],A"> <dt><pre data-language="nim">proc mget[A, B](t: var SharedTable[A, B]; key: A): var B</pre></dt> <dd> Retrieves the value at <code><span class="Identifier">t</span><span class="Punctuation">[</span><span class="Identifier">key</span><span class="Punctuation">]</span></code>. The value can be modified. If <code><span class="Identifier">key</span></code> is not in <code><span class="Identifier">t</span></code>, the <code><span class="Identifier">KeyError</span></code> exception is raised. <a href="https://github.com/nim-lang/Nim/tree/version-2-0/lib/pure/collections/sharedtables.nim#L139" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L139" target="_blank">Edit</a> </dd> </div> </div> <div id="mgetOrPut-procs-all"> <div id="mgetOrPut,SharedTable[A,B],A,B"> <dt><pre data-language="nim">proc mgetOrPut[A, B](t: var SharedTable[A, B]; key: A; val: B): var B</pre></dt> <dd> Retrieves value at <code><span class="Identifier">t</span><span class="Punctuation">[</span><span class="Identifier">key</span><span class="Punctuation">]</span></code> or puts <code><span class="Identifier">val</span></code> if not present, either way returning a value which can be modified. <strong>Note</strong>: This is inherently unsafe in the context of multi-threading since it returns a pointer to <code><span class="Identifier">B</span></code>. <a href="https://github.com/nim-lang/Nim/tree/version-2-0/lib/pure/collections/sharedtables.nim#L153" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L153" target="_blank">Edit</a> </dd> </div> </div> <div id="withKey-procs-all"> <div id="withKey,SharedTable[A,B],A,proc(A,B,bool)"> <dt><pre data-language="nim">proc withKey[A, B](t: var SharedTable[A, B]; key: A;
                   mapper: proc (key: A; val: var B; pairExists: var bool))</pre></dt> <dd> <p>Computes a new mapping for the <code><span class="Identifier">key</span></code> with the specified <code><span class="Identifier">mapper</span></code> procedure.</p> <p>The <code><span class="Identifier">mapper</span></code> takes 3 arguments:</p> <ol class="simple">
<li>
<code><span class="Identifier">key</span></code> - the current key, if it exists, or the key passed to <code><span class="Identifier">withKey</span></code> otherwise;</li> <li>
<code><span class="Identifier">val</span></code> - the current value, if the key exists, or default value of the type otherwise;</li> <li>
<code><span class="Identifier">pairExists</span></code> - <code><span class="Identifier">true</span></code> if the key exists, <code><span class="Identifier">false</span></code> otherwise.</li> </ol> <p>The <code><span class="Identifier">mapper</span></code> can can modify <code><span class="Identifier">val</span></code> and <code><span class="Identifier">pairExists</span></code> values to change the mapping of the key or delete it from the table. When adding a value, make sure to set <code><span class="Identifier">pairExists</span></code> to <code><span class="Identifier">true</span></code> along with modifying the <code><span class="Identifier">val</span></code>.</p> <p>The operation is performed atomically and other operations on the table will be blocked while the <code><span class="Identifier">mapper</span></code> is invoked, so it should be short and simple.</p> <p>Example usage:</p> <pre class="listing" data-language="nim"># If value exists, decrement it.
# If it becomes zero or less, delete the key
t.withKey(1'i64) do (k: int64, v: var int, pairExists: var bool):
  if pairExists:
    dec v
    if v &lt;= 0:
      pairExists = false</pre> <a href="https://github.com/nim-lang/Nim/tree/version-2-0/lib/pure/collections/sharedtables.nim#L170" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L170" target="_blank">Edit</a> </dd> </div> </div> </dl>   <h2 id="18">Templates</h2> <dl> <div id="withValue-templates-all"> <div id="withValue.t,SharedTable[A,B],A,untyped,untyped,untyped"> <dt><pre data-language="nim">template withValue[A, B](t: var SharedTable[A, B]; key: A;
                         value, body1, body2: untyped)</pre></dt> <dd> Retrieves the value at <code><span class="Identifier">t</span><span class="Punctuation">[</span><span class="Identifier">key</span><span class="Punctuation">]</span></code>. <code><span class="Identifier">value</span></code> can be modified in the scope of the <code><span class="Identifier">withValue</span></code> call. <p><strong class="examples_text">Example:</strong></p> <pre class="listing" data-language="nim">var table: SharedTable[string, string]
init(table)

table["a"] = "x"
table["b"] = "y"
table["c"] = "z"


table.withValue("a", value):
  value[] = "m"

var flag = false
table.withValue("d", value):
  discard value
  doAssert false
do: # if "d" notin table
  flag = true

if flag:
  table["d"] = "n"

assert table.mget("a") == "m"
assert table.mget("d") == "n"</pre> <a href="https://github.com/nim-lang/Nim/tree/version-2-0/lib/pure/collections/sharedtables.nim#L97" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L97" target="_blank">Edit</a> </dd> </div> <div id="withValue.t,SharedTable[A,B],A,untyped,untyped"> <dt><pre data-language="nim">template withValue[A, B](t: var SharedTable[A, B]; key: A; value, body: untyped)</pre></dt> <dd> Retrieves the value at <code><span class="Identifier">t</span><span class="Punctuation">[</span><span class="Identifier">key</span><span class="Punctuation">]</span></code>. <code><span class="Identifier">value</span></code> can be modified in the scope of the <code><span class="Identifier">withValue</span></code> call. <p><strong class="examples_text">Example:</strong></p> <pre class="listing" data-language="nim">var table: SharedTable[string, string]
init(table)

table["a"] = "x"
table["b"] = "y"
table["c"] = "z"

table.withValue("a", value):
  assert value[] == "x"

table.withValue("b", value):
  value[] = "modified"

table.withValue("b", value):
  assert value[] == "modified"

table.withValue("nonexistent", value):
  assert false # not called</pre> <a href="https://github.com/nim-lang/Nim/tree/version-2-0/lib/pure/collections/sharedtables.nim#L63" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L63" target="_blank">Edit</a> </dd> </div> </div> </dl><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2006&ndash;2024 Andreas Rumpf<br>Licensed under the MIT License.<br>
    <a href="https://nim-lang.org/docs/sharedtables.html" class="_attribution-link">https://nim-lang.org/docs/sharedtables.html</a>
  </p>
</div>
