<h1 class="title">sharedtables</h1>  
<p>Shared table support for Nim. Use plain old non GC'ed keys and values or you'll be in trouble. Uses a single lock to protect the table, lockfree implementations welcome but if lock contention is so high that you need a lockfree hash table, you're doing it wrong.</p> <p>Unstable API.</p>  <h2 id="6">Imports</h2> <dl> <a href="hashes.html">hashes</a>, <a href="math.html">math</a>, <a href="locks.html">locks</a> </dl>  <h2 id="7">Types</h2> <dl>  <dt><pre id="SharedTable" data-language="nim">SharedTable[A; B] = object
  data: KeyValuePairSeq[A, B]
  counter, dataLen: int
  lock: Lock</pre></dt> <dd> generic hash SharedTable <a href="https://github.com/nim-lang/Nim/tree/version-1-4/lib/pure/collections/sharedtables.nim#L23" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L23" target="_blank">Edit</a> </dd> </dl>  <h2 id="12">Procs</h2> <dl>  <dt><pre id="rightSize%2CNatural" data-language="nim">proc rightSize(count: Natural): int {...}{.inline,
                                      deprecated: "Deprecated since 1.4.0",
                                      raises: [], tags: [].}</pre></dt> <dd> <div class="deprecation-message"> <b>Deprecated:</b> Deprecated since 1.4.0 </div> <p><strong>Deprecated since Nim v1.4.0</strong>, it is not needed anymore because picking the correct size is done internally.</p> <p>Return the value of <code>initialSize</code> to support <code>count</code> items.</p> <p>If more items are expected to be added, simply add that expected extra amount to the parameter before calling this.</p> <a href="https://github.com/nim-lang/Nim/tree/version-1-4/lib/pure/collections/hashcommon.nim#L41" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/hashcommon.nim#L41" target="_blank">Edit</a> </dd>  <dt><pre id="mget%2CSharedTable%5BA%2CB%5D%2CA" data-language="nim">proc mget[A, B](t: var SharedTable[A, B]; key: A): var B</pre></dt> <dd> retrieves the value at <code>t[key]</code>. The value can be modified. If <code>key</code> is not in <code>t</code>, the <code>KeyError</code> exception is raised. <a href="https://github.com/nim-lang/Nim/tree/version-1-4/lib/pure/collections/sharedtables.nim#L114" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L114" target="_blank">Edit</a> </dd>  <dt><pre id="mgetOrPut%2CSharedTable%5BA%2CB%5D%2CA%2CB" data-language="nim">proc mgetOrPut[A, B](t: var SharedTable[A, B]; key: A; val: B): var B</pre></dt> <dd> retrieves value at <code>t[key]</code> or puts <code>val</code> if not present, either way returning a value which can be modified. <strong>Note</strong>: This is inherently unsafe in the context of multi-threading since it returns a pointer to <code>B</code>. <a href="https://github.com/nim-lang/Nim/tree/version-1-4/lib/pure/collections/sharedtables.nim#L128" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L128" target="_blank">Edit</a> </dd>  <dt><pre id="hasKeyOrPut%2CSharedTable%5BA%2CB%5D%2CA%2CB" data-language="nim">proc hasKeyOrPut[A, B](t: var SharedTable[A, B]; key: A; val: B): bool</pre></dt> <dd> returns true if <code>key</code> is in the table, otherwise inserts <code>value</code>. <a href="https://github.com/nim-lang/Nim/tree/version-1-4/lib/pure/collections/sharedtables.nim#L136" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L136" target="_blank">Edit</a> </dd>  <dt><pre id="withKey%2CSharedTable%5BA%2CB%5D%2CA%2Cproc%28A%2CB%2Cbool%29" data-language="nim">proc withKey[A, B](t: var SharedTable[A, B]; key: A;
                   mapper: proc (key: A; val: var B; pairExists: var bool))</pre></dt> <dd> <p>Computes a new mapping for the <code>key</code> with the specified <code>mapper</code> procedure.</p> <p>The <code>mapper</code> takes 3 arguments:</p> <ol class="simple">
<li>
<code>key</code> - the current key, if it exists, or the key passed to <code>withKey</code> otherwise;</li> <li>
<code>val</code> - the current value, if the key exists, or default value of the type otherwise;</li> <li>
<code>pairExists</code> - <code>true</code> if the key exists, <code>false</code> otherwise.</li> </ol> <p>The <code>mapper</code> can can modify <code>val</code> and <code>pairExists</code> values to change the mapping of the key or delete it from the table. When adding a value, make sure to set <code>pairExists</code> to <code>true</code> along with modifying the <code>val</code>.</p> <p>The operation is performed atomically and other operations on the table will be blocked while the <code>mapper</code> is invoked, so it should be short and simple.</p> <p>Example usage:</p> <pre class="listing" data-language="nim"># If value exists, decrement it.
# If it becomes zero or less, delete the key
t.withKey(1'i64) do (k: int64, v: var int, pairExists: var bool):
  if pairExists:
    dec v
    if v &lt;= 0:
      pairExists = false</pre> <a href="https://github.com/nim-lang/Nim/tree/version-1-4/lib/pure/collections/sharedtables.nim#L145" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L145" target="_blank">Edit</a> </dd>  <dt><pre id="%5B%5D%3D%2CSharedTable%5BA%2CB%5D%2CA%2CB" data-language="nim">proc `[]=`[A, B](t: var SharedTable[A, B]; key: A; val: B)</pre></dt> <dd> puts a (key, value)-pair into <code>t</code>. <a href="https://github.com/nim-lang/Nim/tree/version-1-4/lib/pure/collections/sharedtables.nim#L193" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L193" target="_blank">Edit</a> </dd>  <dt><pre id="add%2CSharedTable%5BA%2CB%5D%2CA%2CB" data-language="nim">proc add[A, B](t: var SharedTable[A, B]; key: A; val: B)</pre></dt> <dd> puts a new (key, value)-pair into <code>t</code> even if <code>t[key]</code> already exists. This can introduce duplicate keys into the table! <a href="https://github.com/nim-lang/Nim/tree/version-1-4/lib/pure/collections/sharedtables.nim#L198" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L198" target="_blank">Edit</a> </dd>  <dt><pre id="del%2CSharedTable%5BA%2CB%5D%2CA" data-language="nim">proc del[A, B](t: var SharedTable[A, B]; key: A)</pre></dt> <dd> deletes <code>key</code> from hash table <code>t</code>. <a href="https://github.com/nim-lang/Nim/tree/version-1-4/lib/pure/collections/sharedtables.nim#L204" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L204" target="_blank">Edit</a> </dd>  <dt><pre id="len%2CSharedTable%5BA%2CB%5D" data-language="nim">proc len[A, B](t: var SharedTable[A, B]): int</pre></dt> <dd> number of elements in <code>t</code> <a href="https://github.com/nim-lang/Nim/tree/version-1-4/lib/pure/collections/sharedtables.nim#L209" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L209" target="_blank">Edit</a> </dd>  <dt><pre id="init%2CSharedTable%5BA%2CB%5D%2Cint" data-language="nim">proc init[A, B](t: var SharedTable[A, B]; initialSize = 32)</pre></dt> <dd> <p>creates a new hash table that is empty.</p> <p>This proc must be called before any other usage of <code>t</code>.</p> <a href="https://github.com/nim-lang/Nim/tree/version-1-4/lib/pure/collections/sharedtables.nim#L214" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L214" target="_blank">Edit</a> </dd>  <dt><pre id="deinitSharedTable%2CSharedTable%5BA%2CB%5D" data-language="nim">proc deinitSharedTable[A, B](t: var SharedTable[A, B])</pre></dt> <dd> <a href="https://github.com/nim-lang/Nim/tree/version-1-4/lib/pure/collections/sharedtables.nim#L225" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L225" target="_blank">Edit</a> </dd> </dl>  <h2 id="18">Templates</h2> <dl>  <dt><pre id="withValue.t%2CSharedTable%5BA%2CB%5D%2CA%2Cuntyped%2Cuntyped" data-language="nim">template withValue[A; B](t: var SharedTable[A, B]; key: A; value, body: untyped)</pre></dt> <dd> retrieves the value at <code>t[key]</code>. <code>value</code> can be modified in the scope of the <code>withValue</code> call.<pre class="listing" data-language="nim">sharedTable.withValue(key, value) do:
  # block is executed only if ``key`` in ``t``
  # value is threadsafe in block
  value.name = "username"
  value.uid = 1000</pre> <a href="https://github.com/nim-lang/Nim/tree/version-1-4/lib/pure/collections/sharedtables.nim#L61" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L61" target="_blank">Edit</a> </dd>  <dt><pre id="withValue.t%2CSharedTable%5BA%2CB%5D%2CA%2Cuntyped%2Cuntyped%2Cuntyped" data-language="nim">template withValue[A; B](t: var SharedTable[A, B]; key: A;
                         value, body1, body2: untyped)</pre></dt> <dd> retrieves the value at <code>t[key]</code>. <code>value</code> can be modified in the scope of the <code>withValue</code> call.<pre class="listing" data-language="nim">sharedTable.withValue(key, value) do:
  # block is executed only if ``key`` in ``t``
  # value is threadsafe in block
  value.name = "username"
  value.uid = 1000
do:
  # block is executed when ``key`` not in ``t``
  raise newException(KeyError, "Key not found")</pre> <a href="https://github.com/nim-lang/Nim/tree/version-1-4/lib/pure/collections/sharedtables.nim#L85" target="_blank">Source</a> <a href="https://github.com/nim-lang/Nim/edit/devel/lib/pure/collections/sharedtables.nim#L85" target="_blank">Edit</a> </dd> </dl><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2006&ndash;2021 Andreas Rumpf<br>Licensed under the MIT License.<br>
    <a href="https://nim-lang.org/docs/sharedtables.html" class="_attribution-link">https://nim-lang.org/docs/sharedtables.html</a>
  </p>
</div>
