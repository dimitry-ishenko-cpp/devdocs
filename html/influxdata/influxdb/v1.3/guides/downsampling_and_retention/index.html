<h1>Downsampling and Data Retention</h1>     <p>InfluxDB can handle hundreds of thousands of data points per second. Working with that much data over a long period of time can create storage concerns. A natural solution is to downsample the data; keep the high precision raw data for only a limited time, and store the lower precision, summarized data for much longer or forever.</p> <p>InfluxDB offers two features - Continuous Queries (CQ) and Retention Policies (RP) - that automate the process of downsampling data and expiring old data. This guide describes a practical use case for CQs and RPs and covers how to set up those features in InfluxDB.</p> <h3 id="definitions">Definitions</h3> <p>A <strong>Continuous Query</strong> (CQ) is an InfluxQL query that runs automatically and periodically within a database. CQs require a function in the <code>SELECT</code> clause and must include a <code>GROUP BY time()</code> clause.</p> <p>A <strong>Retention Policy</strong> (RP) is the part of InfluxDB’s data structure that describes for how long InfluxDB keeps data. InfluxDB compares your local server’s timestamp to the timestamps on your data and deletes data that are older than the RP’s <code>DURATION</code>. A single database can have several RPs and RPs are unique per database.</p> <p>This guide will not go into detail about the syntax for creating and managing CQs and RPs. If you’re new to both concepts, we recommend looking over the detailed <a href="../../query_language/continuous_queries/index.html">CQ documentation</a> and <a href="../../query_language/database_management/index.html#retention-policy-management">RP documentation</a>.</p> <h3 id="sample-data">Sample data</h3> <p>This section uses fictional real-time data that track the number of food orders to a restaurant via phone and via website at ten second intervals. We will store those data in a <a href="../../concepts/glossary/index.html#database">database</a> called <code>food_data</code>, in the <a href="../../concepts/glossary/index.html#measurement">measurement</a> <code>orders</code>, and in the <a href="../../concepts/glossary/index.html#field">fields</a> <code>phone</code> and <code>website</code>.</p> <p>Sample:</p> <pre>name: orders
------------
time			               phone	 website
2016-05-10T23:18:00Z	 10 	   30
2016-05-10T23:18:10Z	 12 	   39
2016-05-10T23:18:20Z	 11 	   56
</pre> <h3 id="goal">Goal</h3> <p>Assume that, in the long run, we’re only interested in the average number of orders by phone and by website at 30 minute intervals. In the next steps, we use RPs and CQs to:</p> <ul> <li>Automatically aggregate the ten-second resolution data to 30-minute resolution data</li> <li>Automatically delete the raw, ten-second resolution data that are older than two hours</li> <li>Automatically delete the 30-minute resolution data that are older than 52 weeks</li> </ul> <h3 id="database-preparation">Database Preparation</h3> <p>We perform the following steps before writing the data to the database <code>food_data</code>. We do this <strong>before</strong> inserting any data because CQs only run against recent data; that is, data with timestamps that are no older than <code>now()</code> minus the <code>FOR</code> clause of the CQ, or <code>now()</code> minus the <code>GROUP BY time()</code> interval if the CQ has no <code>FOR</code> clause.</p> <h4 id="1-create-the-database">1. Create the database</h4> <pre>&gt; CREATE DATABASE "food_data"
</pre> <h4 id="2-create-a-two-hour-default-rp">2. Create a two-hour <code>DEFAULT</code> RP</h4> <p>InfluxDB writes to the <code>DEFAULT</code> RP if we do not supply an explicit RP when writing a point to the database. We make the <code>DEFAULT</code> RP keep data for two hours, because we want InfluxDB to automatically write the incoming ten-second resolution data to that RP.</p> <p>Use the <a href="../../query_language/database_management/index.html#create-retention-policies-with-create-retention-policy"><code>CREATE RETENTION POLICY</code></a> statement to create a <code>DEFAULT</code> RP:</p> <pre data-language="sql">&gt; CREATE RETENTION POLICY "two_hours" ON "food_data" DURATION 2h REPLICATION 1 DEFAULT
</pre> <p>That query creates an RP called <code>two_hours</code> that exists in the database <code>food_data</code>. <code>two_hours</code> keeps data for a <code>DURATION</code> of two hours (<code>2h</code>) and it’s the <code>DEFAULT</code> RP for the database <code>food_data</code>.</p> 
<dt> The replication factor (<code>REPLICATION 1</code>) is a required parameter but must always be set to 1 for single node instances. </dt> <blockquote> <p><strong>Note:</strong> When we created the <code>food_data</code> database in step 1, InfluxDB automatically generated an RP named <code>autogen</code> and set it as the <code>DEFAULT</code> RP for the database. The <code>autogen</code> RP has an infinite retention period. With the query above, the RP <code>two_hours</code> replaces <code>autogen</code> as the <code>DEFAULT</code> RP for the <code>food_data</code> database.</p> </blockquote> <h4 id="3-create-a-52-week-rp">3. Create a 52-week RP</h4> <p>Next we want to create another RP that keeps data for 52 weeks and is not the <code>DEFAULT</code> RP for the database. Ultimately, the 30-minute rollup data will be stored in this RP.</p> <p>Use the <a href="../../query_language/database_management/index.html#create-retention-policies-with-create-retention-policy"><code>CREATE RETENTION POLICY</code></a> statement to create a non-<code>DEFAULT</code> RP:</p> <pre data-language="sql">&gt; CREATE RETENTION POLICY "a_year" ON "food_data" DURATION 52w REPLICATION 1
</pre> <p>That query creates an RP called <code>a_year</code> that exists in the database <code>food_data</code>. <code>a_year</code> keeps data for a <code>DURATION</code> of 52 weeks (<code>52w</code>). Leaving out the <code>DEFAULT</code> argument ensures that <code>a_year</code> is not the <code>DEFAULT</code> RP for the database <code>food_data</code>. That is, write and read operations against <code>food_data</code> that do not specify an RP will still go to the <code>two_hours</code> RP (the <code>DEFAULT</code> RP).</p> <h4 id="4-create-the-cq">4. Create the CQ</h4> <p>Now that we’ve set up our RPs, we want to create a CQ that will automatically and periodically downsample the ten-second resolution data to the 30-minute resolution, and store those results in a different measurement with a different retention policy.</p> <p>Use the <a href="../../query_language/continuous_queries/index.html"><code>CREATE CONTINUOUS QUERY</code></a> statement to generate a CQ:</p> <pre data-language="sql">&gt; CREATE CONTINUOUS QUERY "cq_30m" ON "food_data" BEGIN
  SELECT mean("website") AS "mean_website",mean("phone") AS "mean_phone"
  INTO "a_year"."downsampled_orders"
  FROM "orders"
  GROUP BY time(30m)
END
</pre> <p>That query creates a CQ called <code>cq_30m</code> in the database <code>food_data</code>. <code>cq_30m</code> tells InfluxDB to calculate the 30-minute average of the two fields <code>website</code> and <code>phone</code> in the measurement <code>orders</code> and in the <code>DEFAULT</code> RP <code>two_hours</code>. It also tells InfluxDB to write those results to the measurement <code>downsampled_orders</code> in the retention policy <code>a_year</code> with the field keys <code>mean_website</code> and <code>mean_phone</code>. InfluxDB will run this query every 30 minutes for the previous 30 minutes.</p> <blockquote> <p><strong>Note:</strong> Notice that we fully qualify (that is, we use the syntax <code>"&lt;retention_policy&gt;"."&lt;measurement&gt;"</code>) the measurement in the <code>INTO</code> clause. InfluxDB requires that syntax to write data to an RP other than the <code>DEFAULT</code> RP.</p> </blockquote> <h3 id="results">Results</h3> <p>With the new CQ and two new RPs, <code>food_data</code> is ready to start receiving data. After writing data to our database and letting things run for a bit, we see two measurements: <code>orders</code> and <code>downsampled_orders</code>.</p> <pre data-language="bash">&gt; SELECT * FROM "orders" LIMIT 5
name: orders
---------
time			                phone  website
2016-05-13T23:00:00Z	  10     30
2016-05-13T23:00:10Z	  12     39
2016-05-13T23:00:20Z	  11     56
2016-05-13T23:00:30Z	  8      34
2016-05-13T23:00:40Z	  17     32

&gt; SELECT * FROM "a_year"."downsampled_orders" LIMIT 5
name: downsampled_orders
---------------------
time			                mean_phone  mean_website
2016-05-13T15:00:00Z	  12          23
2016-05-13T15:30:00Z	  13          32
2016-05-13T16:00:00Z	  19          21
2016-05-13T16:30:00Z	  3           26
2016-05-13T17:00:00Z	  4           23
</pre> <p>The data in <code>orders</code> are the raw, ten-second resolution data that reside in the two-hour RP. The data in <code>downsampled_orders</code> are the aggregated, 30-minute resolution data that are subject to the 52-week RP.</p> <p>Notice that the first timestamps in <code>downsampled_orders</code> are older than the first timestamps in <code>orders</code>. This is because InfluxDB has already deleted data from <code>orders</code> with timestamps that are older than our local server’s timestamp minus two hours (assume we executed the <code>SELECT</code> queries at <code>2016-05-13T00:59:59Z</code>). InfluxDB will only start dropping data from <code>downsampled_orders</code> after 52 weeks.</p> <blockquote> <p><strong>Notes:</strong></p> <ul> <li><p>Notice that we fully qualify (that is, we use the syntax <code>"&lt;retention_policy&gt;"."&lt;measurement&gt;"</code>) <code>downsampled_orders</code> in the second <code>SELECT</code> statement. We must specify the RP in that query to <code>SELECT</code> data that reside in an RP other than the <code>DEFAULT</code> RP.</p></li> <li><p>By default, InfluxDB checks to enforce an RP every 30 minutes. Between checks, <code>orders</code> may have data that are older than two hours. The rate at which InfluxDB checks to enforce an RP is a configurable setting, see <a href="../../administration/config/index.html#check-interval-30m0s">Database Configuration</a>.</p></li> </ul> </blockquote> <p>Using a combination of RPs and CQs, we’ve successfully set up our database to automatically keep the high precision raw data for a limited time, create lower precision data, and store that lower precision data for a longer period of time. Now that you have a general understanding of how these features can work together, we recommend looking at the detailed documentation on <a href="../../query_language/continuous_queries/index.html">CQs</a> and <a href="../../query_language/database_management/index.html#retention-policy-management">RPs</a> to see all that they can do for you.</p><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2015 InfluxData, Inc.<br>Licensed under the MIT license.<br>
    <a href="https://docs.influxdata.com/influxdb/v1.3/guides/downsampling_and_retention/" class="_attribution-link">https://docs.influxdata.com/influxdb/v1.3/guides/downsampling_and_retention/</a>
  </p>
</div>
