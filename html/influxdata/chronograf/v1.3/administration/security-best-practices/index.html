<h1>Security Best Practices</h1>     <h3 id="content">Content</h3> <ul> <li>
<a href="#chronograf-with-oauth-2-0-authentication">Chronograf with OAuth 2.0 Authentication</a> <ul> <li>
<a href="#configuration">Configuration</a> <ul> <li><a href="#jwt-signature">JWT Signature</a></li> <li><a href="#github">GitHub</a></li> <li><a href="#google">Google</a></li> <li><a href="#heroku">Heroku</a></li> <li><a href="#auth0">Auth0</a></li> <li><a href="#generic-provider">Generic Provider</a></li> <li><a href="#optional-configure-an-authentication-duration">Optional: Configure an Authentication Duration</a></li> </ul>
</li> </ul>
</li> <li>
<a href="#tls">TLS</a> <ul> <li><a href="#running-chronograf-with-tls">Running Chronograf with TLS</a></li> <li><a href="#testing-with-self-signed-certificates">Testing with Self-Signed Certificates </a></li> </ul>
</li> </ul> <h2 id="chronograf-with-oauth-2-0-authentication">Chronograf with OAuth 2.0 Authentication</h2> <h3 id="configuration">Configuration</h3> <p>Configure the JWT signature and the OAuth provider to use authentication in Chronograf.</p> <blockquote> <p><strong>Note:</strong> If you’re using the <a href="../configuration/index.html#p-basepath"><code>--basepath</code> option</a> when starting Chronograf, add the same basepath to the callback URL of any OAuth provider that you configure.</p> </blockquote> <h3 id="jwt-signature">JWT Signature</h3> <p>Set a <a href="https://tools.ietf.org/html/rfc7519">JWT</a> signature to a random string. This is needed for all OAuth2 providers that you choose to configure. <em>Keep this random string around!</em></p> <p>You’ll need it each time you start a Chronograf server because it is used to verify user authorization. If you are running multiple Chronograf servers in an HA configuration set the <code>TOKEN_SECRET</code> environment variable on each server to allow users to stay logged in. If you want to log all users out every time the server restarts, change the value of <code>TOKEN_SECRET</code> to a different value on each restart.</p> <pre data-language="sh">export TOKEN_SECRET=supersupersecret
</pre> <h3 id="github">Github</h3> <h4 id="overview">Overview</h4> <pre data-language="sh">export AUTH_DURATION=1h                                           # force login every hour
export TOKEN_SECRET=supersupersecret                              # Signing secret
export GH_CLIENT_ID=b339dd4fddd95abec9aa                          # Github client id
export GH_CLIENT_SECRET=260041897d3252c146ece6b46ba39bc1e54416dc  # Github client secret
export GH_ORGS=biffs-gang                                         # Restrict to GH orgs
</pre> <h4 id="creating-github-oauth-application">Creating Github OAuth Application</h4> <p>To create a Github OAuth Application follow the <a href="https://developer.github.com/guides/basics-of-authentication/#registering-your-app">Register your app</a> instructions. Essentially, you’ll register your application <a href="https://github.com/settings/applications/new">here</a>.</p> <p>The <code>Homepage URL</code> should be Chronograf’s full server name and port. If you are running it locally for example, make it <code>http://localhost:8888</code>.</p> <p>The <code>Authorization callback URL</code> must be the location of the <code>Homepage URL</code> plus <code>/oauth/github/callback</code>. For example, if <code>Homepage URL</code> was <code>http://localhost:8888</code> then the <code>Authorization callback URL</code> should be <code>http://localhost:8888/oauth/github/callback</code>.</p> <p>Github provides a <code>Client ID</code> and <code>Client Secret</code>. To register these values with Chronograf set the following environment variables:</p> <ul> <li><code>GH_CLIENT_ID</code></li> <li><code>GH_CLIENT_SECRET</code></li> </ul> <p>For example:</p> <pre data-language="sh">export GH_CLIENT_ID=b339dd4fddd95abec9aa
export GH_CLIENT_SECRET=260041897d3252c146ece6b46ba39bc1e54416dc
</pre> <h4 id="optional-github-organizations">Optional Github Organizations</h4> <p>To require an organization membership for a user, set the <code>GH_ORGS</code> environment variables:</p> <pre data-language="sh">export GH_ORGS=biffs-gang
</pre> <p>If the user is not a member, then the user will not be allowed access. To support multiple organizations use a comma-delimited list like so:</p> <pre data-language="sh">export GH_ORGS=hill-valley-preservation-sociey,the-pinheads
</pre> <h3 id="google">Google</h3> <h4 id="creating-google-oauth-application">Creating Google OAuth Application</h4> <p>Obtain a client ID and an application secret by following the steps under “Basic Steps” <a href="https://developers.google.com/identity/protocols/OAuth2">here</a>. Chronograf will also need to be publicly accessible via a fully qualified domain name so that Google properly redirects users back to the application. This information should be set in the following environment variables:</p> <ul> <li><code>GOOGLE_CLIENT_ID</code></li> <li><code>GOOGLE_CLIENT_SECRET</code></li> <li><code>PUBLIC_URL</code></li> </ul> <p>Alternatively, this can also be set using the command line switches:</p> <ul> <li><a href="../configuration/index.html#google-client-id"><code>--google-client-id</code></a></li> <li><a href="../configuration/index.html#google-client-secret"><code>--google-client-secret</code></a></li> <li><a href="../configuration/index.html#public-url"><code>--public-url</code></a></li> </ul> <h4 id="optional-google-domains">Optional Google Domains</h4> <p>Similar to Github’s organization restriction, Google authentication can be restricted to permit access to Chronograf from only specific domains. These are configured using the <code>GOOGLE_DOMAINS</code> environment variable or the <a href="../configuration/index.html#google-domains"><code>--google-domains</code></a> switch. Multiple domains are separated with a comma. For example, if we wanted to permit access only from biffspleasurepalace.com and savetheclocktower.com the environment variable would be set as follows:</p> <pre data-language="sh">export GOOGLE_DOMAINS=biffspleasurepalance.com,savetheclocktower.com
</pre> <h3 id="heroku">Heroku</h3> <h4 id="creating-heroku-application">Creating Heroku Application</h4> <p>To obtain a client ID and application secret for Heroku, follow the guide posted <a href="https://devcenter.heroku.com/articles/oauth#register-client">here</a>. Once your application has been created, those two values should be inserted into the following environment variables:</p> <ul> <li><code>HEROKU_CLIENT_ID</code></li> <li><code>HEROKU_SECRET</code></li> </ul> <p>The equivalent command line switches are:</p> <ul> <li><a href="../configuration/index.html#heroku-client-id"><code>--heroku-client-id</code></a></li> <li><a href="../configuration/index.html#heroku-secret"><code>--heroku-secret</code></a></li> </ul> <h4 id="optional-heroku-organizations">Optional Heroku Organizations</h4> <p>Like the other OAuth2 providers, access to Chronograf via Heroku can be restricted to members of specific Heroku organizations. This is controlled using the <code>HEROKU_ORGS</code> environment variable or the <a href="../configuration/index.html#heroku-organization"><code>--heroku-organizations</code></a> switch and is comma-separated. If we wanted to permit access from the <code>hill-valley-preservation-society</code> organization and <code>the-pinheads</code> organization, we would use the following environment variable:</p> <pre data-language="sh">export HEROKU_ORGS=hill-valley-preservation-sociey,the-pinheads
</pre> <h3 id="auth0">Auth0</h3> <h4 id="creating-an-auth0-application">Creating an Auth0 Application</h4> <p>To begin authenticating Chronograf users with Auth0, you will need to have an Auth0 account and <a href="https://auth0.com/docs/clients">register an Auth0 client</a> within their dashboard.</p> <p>Auth0 clients should be configured as “Regular Web Applications” with the “Token Endpoint Authentication” set to “None”. Clients must have the “Allowed Callback URLs” set to “<a href="#">https://www.example.com/oauth/auth0/callback"</a> and the “Allowed Logout URLs” to “<a href="#">https://www.example.com"</a>, substituting “example.com” for the <a href="../configuration/index.html#public-url"><code>PUBLIC_URL</code></a> of your Chronograf instance.</p> <p>Finally, clients must be set to be <a href="https://auth0.com/docs/api-auth/intro#how-to-use-the-new-flows">“OIDC Conformant”</a>.</p> <p>Click save, and then take note of your Domain, Client ID, and Secret at the top of the page. These should be inserted into the following environment variables:</p> <ul> <li><code>AUTH0_DOMAIN</code></li> <li><code>AUTH0_CLIENT_ID</code></li> <li><code>AUTH0_CLIENT_SECRET</code></li> </ul> <p>The equivalent command line switches are:</p> <ul> <li><a href="../configuration/index.html#auth0-domain"><code>--auth0-domain</code></a></li> <li><a href="../configuration/index.html#auth0-client-id"><code>--auth0-client-id</code></a></li> <li><a href="../configuration/index.html#auth0-client-secret"><code>--auth0-client-secret</code></a></li> </ul> <h4 id="optional-auth0-organizations">Optional Auth0 Organizations</h4> <p>Auth0 can be customized to operators’ requirements, so it has no official concept of an “organization.” Organizations are supported in Chronograf using a lightweight “app_metadata” key that can be inserted into Auth0 users’ profiles automatically or manually.</p> <p>To assign a user to an organization, add an “organization” key to the user’s “app_metadata” field with the value corresponding to the user’s organization. For example, we can assign the user Marty McFly to the “time-travelers” organization by setting the “app_metadata” to <code>{"organization": "time-travelers"}</code>. This can be done either manually by an operator or automatically through the use of an <a href="https://auth0.com/docs/rules/metadata-in-rules#updating-app_metadata">Auth0 Rule</a> or a <a href="https://auth0.com/docs/hooks/extensibility-points/pre-user-registration">pre-user registration Auth0 Hook</a></p> <p>Next, you will need to set Chronograf’s <a href="../configuration/index.html#auth0-client-secret"><code>AUTH0_ORGS</code></a> environment variable to a comma-separated list of the allowed organizations. For example, if you have one group of users with an “organization” key set to “biffs-gang” and another group with an “organization” key set to “time-travelers” you can permit access to both with the environment variable: <code>AUTH0_ORGS=biffs-gang,time-travelers</code>.</p> <p>An <code>--auth0-organizations</code> command line switch is also available. However, it is limited to a single organization and does not accept a comma-separated list like its environment variable equivalent.</p> <h3 id="generic-provider">Generic Provider</h3> <h4 id="creating-oauth-application-using-your-own-provider">Creating OAuth Application using your own provider</h4> <p>The generic OAuth2 provider is very similar to the Github provider, but, you are able to set your own authentication, token, and API URLs. The callback URL path will be <code>/oauth/generic/callback</code>. So, if your Chronograf is hosted at <code>https://localhost:8888</code> then the full callback URL would be <code>https://localhost:8888/oauth/generic/callback</code>.</p> <p>The generic OAuth2 provider requires several settings:</p> <ul> <li>
<code>GENERIC_CLIENT_ID</code> : this application’s client <a href="https://tools.ietf.org/html/rfc6749#section-2.2">identifier</a> issued by the provider</li> <li>
<code>GENERIC_CLIENT_SECRET</code> : this application’s <a href="https://tools.ietf.org/html/rfc6749#section-2.3.1">secret</a> issued by the provider</li> <li>
<code>GENERIC_AUTH_URL</code> : OAuth 2.0 provider’s authorization <a href="https://tools.ietf.org/html/rfc6749#section-3.1">endpoint</a> URL</li> <li>
<code>GENERIC_TOKEN_URL</code> : OAuth 2.0 provider’s token endpoint <a href="https://tools.ietf.org/html/rfc6749#section-3.2">endpoint</a> is used by the client to obtain an access token</li> <li>
<code>TOKEN_SECRET</code> : Used to validate OAuth <a href="https://tools.ietf.org/html/rfc6749#section-4.1.1">state</a> response. (see above)</li> </ul> <h4 id="optional-scopes">Optional Scopes</h4> <p>By default Chronograf will ask for the <code>user:email</code> <a href="https://tools.ietf.org/html/rfc6749#section-3.3">scope</a> of the client. If your provider scopes email access under a different scope or scopes provide them as comma-separated values in the <code>GENERIC_SCOPES</code> environment variable.</p> <pre data-language="sh">export GENERIC_SCOPES="openid,email" # Requests access to openid and email scopes
</pre> <h4 id="optional-email-domains">Optional Email domains</h4> <p>The generic OAuth2 provider has a few optional parameters.</p> <ul> <li>
<code>GENERIC_API_URL</code> : URL that returns <a href="https://connect2id.com/products/server/docs/api/userinfo">OpenID UserInfo JWT</a> (specifically email address)</li> <li>
<code>GENERIC_DOMAINS</code> : Email domains user’s email address must use.</li> </ul> <h4 id="configuring-the-look-of-the-login-page">Configuring the look of the login page</h4> <p>To configure the copy of the login page button text, set the <code>GENERIC_NAME</code> environment variable. For example, with</p> <pre data-language="sh">export GENERIC_NAME="Hill Valley Preservation Society"
</pre> <p>the button text will be <code>Login with Hill Valley Preservation Society</code>.</p> <h3 id="optional-configure-an-authentication-duration">Optional: Configure an Authentication Duration</h3> <p>By default, authentication will remain valid for 30 days via a cookie stored in the browser. Configure that duration with the <code>AUTH_DURATION</code> environment variable. For example, to change it to 1 hour, use:</p> <pre data-language="sh">export AUTH_DURATION=1h
</pre> <p>The duration uses the Go (golang) <a href="https://golang.org/pkg/time/#ParseDuration">time duration format</a>, so the largest time unit is <code>h</code> (hours). So to change it to 45 days, use:</p> <pre data-language="sh">export AUTH_DURATION=1080h
</pre> <p>Additionally, for greater security, if you want to require re-authentication every time the browser is closed, set <code>AUTH_DURATION</code> to <code>0</code>. This makes the cookie transient (aka “in-memory”).</p> <h2 id="tls">TLS</h2> <p>Chronograf supports TLS to securely communicate between the browser and server via HTTPS.</p> <p>We recommend using HTTPS with Chronograf. If you are not using a TLS termination proxy, you can run Chronograf’s server with TLS connections.</p> <h3 id="running-chronograf-with-tls">Running Chronograf with TLS</h3> <p>Chronograf server has command line and environment variable options to specify the certificate and key files. The server reads and parses a public/private key pair from these files. The files must contain PEM encoded data.</p> <p>In Chronograf all command line options also have a corresponding environment variable.</p> <p>To specify the certificate file either use the <code>--cert</code> CLI option or <code>TLS_CERTIFICATE</code> environment variable.</p> <p>To specify the key file either use the <code>--key</code> CLI option or <code>TLS_PRIVATE_KEY</code> environment variable.</p> <p>To specify the certificate and key if both are in the same file either use the <code>--cert</code> CLI option or <code>TLS_CERTIFICATE</code> environment variable.</p> <h4 id="example-with-cli-options">Example with CLI options</h4> <pre data-language="sh">chronograf --cert=my.crt --key=my.key
</pre> <h4 id="example-with-environment-variables">Example with environment variables</h4> <pre data-language="sh">TLS_CERTIFICATE=my.crt TLS_PRIVATE_KEY=my.key chronograf
</pre> <h4 id="docker-example-with-environment-variables">Docker example with environment variables</h4> <pre data-language="sh">docker run -v /host/path/to/certs:/certs -e TLS_CERTIFICATE=/certs/my.crt -e TLS_PRIVATE_KEY=/certs/my.key quay.io/influxdb/chronograf:latest
</pre> <h3 id="testing-with-self-signed-certificates">Testing with Self-Signed Certificates</h3> <p>In a production environment you should not use self-signed certificates. However, for testing it is fast to create your own certs.</p> <p>To create a cert and key in one file with OpenSSL:</p> <pre data-language="sh">openssl req -x509 -newkey rsa:4096 -sha256 -nodes -keyout testing.pem -out testing.pem -subj "/CN=localhost" -days 365
</pre> <p>Next, set the environment variable <code>TLS_CERTIFICATE</code>:</p> <pre data-language="sh">export TLS_CERTIFICATE=$PWD/testing.pem
</pre> <p>Run Chronograf:</p> <pre data-language="sh">./chronograf
INFO[0000] Serving chronograf at https://[::]:8888       component=server
</pre> <p>In the first log message you should see <code>https</code> rather than <code>http</code>.</p><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2015 InfluxData, Inc.<br>Licensed under the MIT license.<br>
    <a href="https://docs.influxdata.com/chronograf/v1.3/administration/security-best-practices/" class="_attribution-link">https://docs.influxdata.com/chronograf/v1.3/administration/security-best-practices/</a>
  </p>
</div>
