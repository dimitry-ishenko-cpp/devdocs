<h1 id="page-subtitle">function hook_update_N</h1>     <pre class="signature">hook_update_N(&amp;<del>$sandbox</del>)</pre> <p>Perform a single update between minor versions.</p> <p><a href="8.1.x.html" title="Perform a single update between minor versions." class="local active">hook_update_N</a>() can only be used to update between minor versions of a module. To upgrade between major versions of Drupal (for example, between Drupal 7 and 8), use the Migrate API instead.</p> <h3 id="sec_naming">Naming and documenting your function</h3> <p>For each change in a module that requires one or more actions to be performed when updating a site, add a new implementation of <a href="8.1.x.html" title="Perform a single update between minor versions." class="local active">hook_update_N</a>() to your mymodule.install file (assuming mymodule is the machine name of your module). Implementations of <a href="8.1.x.html" title="Perform a single update between minor versions." class="local active">hook_update_N</a>() are named (module name)_update_(number). The numbers are normally composed of three parts:</p> <ul> <li>1 or 2 digits for Drupal core compatibility (Drupal 8, 9, 10, etc.). This convention must be followed.</li> <li>1 digit for your module's major release version; for example, for 8.x-1.* use 1, for 8.x-2.* use 2, for Core 8.0.x use 0, and for Core 8.1.x use 1. This convention is optional but suggested for clarity.</li> <li>2 digits for sequential counting, starting with 01. Note that the x000 number can never be used: the lowest update number that will be recognized and run for major version x is x001.</li> </ul> <p>Examples:</p> <ul> <li>
<strong><a href="https://api.drupal.org/api/drupal/core%21modules%21node%21node.install/function/node_update_8001/8.1.x" title="Add 'revision_translation_affected' field to 'node' entities." class="local">node_update_8001</a>()</strong>: The first update for the Drupal 8.0.x version of the Drupal Core node module.</li> <li>
<strong>mymodule_update_8101()</strong>: The first update for your custom or contributed module's 8.x-1.x versions.</li> <li>
<strong>mymodule_update_8201()</strong>: The first update for the 8.x-2.x versions.</li> </ul> <p>Never renumber update functions. The numeric part of the hook implementation function is stored in the database to keep track of which updates have run, so it is important to maintain this information consistently.</p> <p>The documentation block preceding this function is stripped of newlines and used as the description for the update on the pending updates task list, which users will see when they run the <a href="https://api.drupal.org/api/drupal/update.php/8.1.x" title="The PHP page that handles updating the Drupal installation." class="local">update.php</a> script.</p> <h3 id="sec_notes">Notes about the function body</h3> <p>Writing <a href="8.1.x.html" title="Perform a single update between minor versions." class="local active">hook_update_N</a>() functions is tricky. There are several reasons why this is the case:</p> <ul> <li>
<strong>You do not know when updates will be run</strong>: someone could be keeping up with every update and run them when the database and code are in the same state as when you wrote your update function, or they could have waited until a few more updates have come out, and run several at the same time.</li> <li>You do not know the state of other modules' updates either.</li> <li>Other modules can use <a href="../hook_update_dependencies/8.1.x.html" title="Return an array of information about module update dependencies." class="local">hook_update_dependencies</a>() to run updates between your module's updates, so you also cannot count on your functions running right after one another.</li> <li>You do not know what environment your update will run in (which modules are installed, whether certain hooks are implemented or not, whether services are overridden, etc.).</li> </ul> <p>Because of these reasons, you'll need to use care in writing your update function. Some things to think about:</p> <ul> <li>Never assume that the database schema is the same when the update will run as it is when you wrote the update function. So, when updating a database table or field, put the schema information you want to update to directly into your function instead of calling your <a href="../../../core-lib-drupal-core-database-database.api.php/function/hook_schema/8.1.x.html" title="Define the current version of the database schema." class="local">hook_schema</a>() function to retrieve it (this is one case where the right thing to do is copy and paste the code).</li> <li>Never assume that the configuration schema is the same when the update will run as it is when you wrote the update function. So, when saving configuration, use the $has_trusted_data = TRUE parameter so that schema is ignored, and make sure that the configuration data you are saving matches the configuration schema at the time when you write the update function (later updates may change it again to match new schema changes).</li> <li>Never assume your field or entity type definitions are the same when the update will run as they are when you wrote the update function. Always retrieve the correct version via <a href="../../../core-lib-drupal.php/function/drupal-entitydefinitionupdatemanager/8.1.x.html" title="Returns the entity definition update manager." class="local">\Drupal::entityDefinitionUpdateManager</a>()::getEntityType() or <a href="../../../core-lib-drupal.php/function/drupal-entitydefinitionupdatemanager/8.1.x.html" title="Returns the entity definition update manager." class="local">\Drupal::entityDefinitionUpdateManager</a>()::getFieldStorageDefinition(). When adding a new definition always replicate it in the update function body as you would do with a schema definition.</li> <li>Never call <a href="../../../core-lib-drupal.php/function/drupal-entitydefinitionupdatemanager/8.1.x.html" title="Returns the entity definition update manager." class="local">\Drupal::entityDefinitionUpdateManager</a>()::applyUpdates() in an update function, as it will apply updates for any module not only yours, which will lead to unpredictable results.</li> <li>Be careful about API functions and especially CRUD operations that you use in your update function. If they invoke hooks or use services, they may not behave as expected, and it may actually not be appropriate to use the normal API functions that invoke all the hooks, use the database schema, and/or use services in an update function -- you may need to switch to using a more direct method (database query, etc.).</li> <li>In particular, loading, saving, or performing any other CRUD operation on an entity is never safe to do (they always involve hooks and services).</li> <li>Never rebuild the router during an update function.</li> </ul> <p>The following actions are examples of things that are safe to do during updates:</p> <ul> <li>Cache invalidation.</li> <li>Using <a href="../../../core-lib-drupal.php/function/drupal-configfactory/8.1.x.html" title="Retrieves the configuration factory." class="local">\Drupal::configFactory</a>()-&gt;getEditable() and <a href="../../../core-lib-drupal.php/function/drupal-config/8.1.x.html" title="Retrieves a configuration object." class="local">\Drupal::config</a>(), as long as you make sure that your update data matches the schema, and you use the $has_trusted_data argument in the save operation.</li> <li>Marking a container for rebuild.</li> <li>Using the API provided by <a href="../../../core-lib-drupal.php/function/drupal-entitydefinitionupdatemanager/8.1.x.html" title="Returns the entity definition update manager." class="local">\Drupal::entityDefinitionUpdateManager</a>() to update the entity schema based on changes in entity type or field definitions provided by your module.</li> </ul> <p>See <a href="https://www.drupal.org/node/2535316">https://www.drupal.org/node/2535316</a> for more on writing update functions.</p> <h3 id="sec_bulk">Batch updates</h3> <p>If running your update all at once could possibly cause PHP to time out, use the $sandbox parameter to indicate that the Batch API should be used for your update. In this case, your update function acts as an implementation of <a href="../../../core-lib-drupal-core-form-form.api.php/function/callback_batch_operation/8.1.x.html" title="Perform a single batch operation." class="local">callback_batch_operation</a>(), and $sandbox acts as the batch context parameter. In your function, read the state information from the previous run from $sandbox (or initialize), run a chunk of updates, save the state in $sandbox, and set $sandbox['#finished'] to a value between 0 and 1 to indicate the percent completed, or 1 if it is finished (you need to do this explicitly in each pass).</p> <p>See the <a href="../../../core-includes-form.inc/group/batch/8.1.x.html" title="Creates and processes batch operations." class="local">Batch operations topic</a> for more information on how to use the Batch API.</p> <h3>Parameters</h3> <p> <strong>array $sandbox</strong>: Stores information for batch updates. See above for more information.</p> <h3>Return value</h3> <p> string|null Optionally, update hooks may return a translated string that will be displayed to the user after the update has completed. If no message is returned, no message will be presented to the user.</p> <h3>Throws</h3> <p> \Drupal\Core\Utility\UpdateException|PDOException In case of error, update hooks should throw an instance of <a href="../../../core-lib-drupal-core-utility-updateexception.php/class/updateexception/8.1.x.html" title="Exception class used to throw error if a module update fails." class="local">Drupal\Core\Utility\UpdateException</a> with a meaningful message for the user. If a database query fails for whatever reason, it will throw a PDOException.</p> <h3>See also</h3> <p> <a href="../../../core-includes-form.inc/group/batch/8.1.x.html" title="Creates and processes batch operations." class="local">Batch operations</a></p> <p><a href="../../../core-lib-drupal-core-database-database.api.php/group/schemaapi/8.1.x.html" title="API to handle database schemas." class="local">Schema API</a></p> <p><a href="../hook_update_last_removed/8.1.x.html" title="Return a number which is no longer available as hook_update_N()." class="local">hook_update_last_removed</a>()</p> <p><a href="../../../core-includes-update.inc/function/update_get_update_list/8.1.x.html" title="Returns a list of all the pending database updates." class="local">update_get_update_list</a>()</p> <p><a href="../../../core-lib-drupal-core-entity-entitydefinitionupdatemanagerinterface.php/interface/entitydefinitionupdatemanagerinterface/8.1.x.html" title="Defines an interface for managing entity definition updates." class="local">\Drupal\Core\Entity\EntityDefinitionUpdateManagerInterface</a></p> <p>node_update_8001</p> <p>system_update_8004</p> <p><a href="https://www.drupal.org/node/2535316">https://www.drupal.org/node/2535316</a></p> <h3>Related topics</h3>   <dl api-related-topics> <dt><a href="../../../core-core.api.php/group/hooks/8.1.x.html">Hooks</a></dt> <dd>Define functions that alter the behavior of Drupal core.</dd> <dt><a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Extension%21module.api.php/group/update_api/8.1.x">Update API</a></dt> <dd>Updating minor versions of modules</dd> </dl>    <h3>File</h3> 
<dl> <dt>core/lib/Drupal/Core/Extension/<a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Extension%21module.api.php/8.1.x">module.api.php</a>, line 619</dt> <dd>Hooks related to module and update systems.</dd> </dl> <h3>Code</h3> <pre class="php" data-language="php">function hook_update_N(&amp;$sandbox) {
  // For non-batch updates, the signature can simply be:
  // function hook_update_N() {

  // Example function body for adding a field to a database table, which does
  // not require a batch operation:
  $spec = array(
    'type' =&gt; 'varchar',
    'description' =&gt; "New Col",
    'length' =&gt; 20,
    'not null' =&gt; FALSE,
  );
  $schema = Database::getConnection()-&gt;schema();
  $schema-&gt;addField('mytable1', 'newcol', $spec);

  // Example of what to do if there is an error during your update.
  if ($some_error_condition_met) {
    throw new UpdateException('Something went wrong; here is what you should do.');
  }

  // Example function body for a batch update. In this example, the values in
  // a database field are updated.
  if (!isset($sandbox['progress'])) {
    // This must be the first run. Initialize the sandbox.
    $sandbox['progress'] = 0;
    $sandbox['current_pk'] = 0;
    $sandbox['max'] = Database::getConnection()-&gt;query('SELECT COUNT(myprimarykey) FROM {mytable1}')-&gt;fetchField() - 1;
  }

  // Update in chunks of 20.
  $records = Database::getConnection()-&gt;select('mytable1', 'm')
    -&gt;fields('m', array('myprimarykey', 'otherfield'))
    -&gt;condition('myprimarykey', $sandbox['current_pk'], '&gt;')
    -&gt;range(0, 20)
    -&gt;orderBy('myprimarykey', 'ASC')
    -&gt;execute();
  foreach ($records as $record) {
    // Here, you would make an update something related to this record. In this
    // example, some text is added to the other field.
    Database::getConnection()-&gt;update('mytable1')
      -&gt;fields(array('otherfield' =&gt; $record-&gt;otherfield . '-suffix'))
      -&gt;condition('myprimarykey', $record-&gt;myprimarykey)
      -&gt;execute();

    $sandbox['progress']++;
    $sandbox['current_pk'] = $record-&gt;myprimarykey;
  }

  $sandbox['#finished'] = empty($sandbox['max']) ? 1 : ($sandbox['progress'] / $sandbox['max']);

  // To display a message to the user when the update is completed, return it.
  // If you do not want to display a completion message, return nothing.
  return t('All foo bars were updated with the new suffix');
}
</pre><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2001&ndash;2016 by the original authors<br>Licensed under the GNU General Public License, version 2 and later.<br>Drupal is a registered trademark of Dries Buytaert.<br>
    <a href="https://api.drupal.org/api/drupal/core!lib!Drupal!Core!Extension!module.api.php/function/hook_update_N/8.1.x" class="_attribution-link">https://api.drupal.org/api/drupal/core!lib!Drupal!Core!Extension!module.api.php/function/hook_update_N/8.1.x</a>
  </p>
</div>
