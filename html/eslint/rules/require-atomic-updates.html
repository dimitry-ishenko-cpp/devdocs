<h1>require-atomic-updates</h1> 
<p>Disallow assignments that can lead to race conditions due to usage of <code>await</code> or <code>yield</code></p>  <nav class="docs-toc c-toc" aria-labelledby="js-toc-label"><h2 class="c-toc__label" id="js-toc-label">Table of Contents</h2> <div class="c-toc__panel" id="js-toc-panel"> <nav class="c-toc"> <ol> <li>
<a href="#rule-details">Rule Details</a> <ol> <li>
<a href="#variables">Variables</a> </li> <li>
<a href="#properties">Properties</a> </li> </ol> </li> <li>
<a href="#options">Options</a> <ol> <li>
<a href="#allowproperties">allowProperties</a> </li> </ol> </li> <li>
<a href="#when-not-to-use-it">When Not To Use It</a> </li> <li>
<a href="#version">Version</a> </li> <li>
<a href="#resources">Resources</a> </li> </ol> </nav> </div></nav> <p>When writing asynchronous code, it is possible to create subtle race condition bugs. Consider the following example:</p> <pre class="language-js line-numbers-mode"><code><span class="token keyword">let</span> totalLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">addLengthOfSinglePage</span><span class="token punctuation">(</span><span class="token parameter">pageNum</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  totalLength <span class="token operator">+=</span> <span class="token keyword">await</span> <span class="token function">getPageLength</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">addLengthOfSinglePage</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">addLengthOfSinglePage</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The combined length of both pages is'</span><span class="token punctuation">,</span> totalLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>This code looks like it will sum the results of calling <code>getPageLength(1)</code> and <code>getPageLength(2)</code>, but in reality the final value of <code>totalLength</code> will only be the length of one of the two pages. The bug is in the statement <code>totalLength += await getPageLength(pageNum);</code>. This statement first reads an initial value of <code>totalLength</code>, then calls <code>getPageLength(pageNum)</code> and waits for that Promise to fulfill. Finally, it sets the value of <code>totalLength</code> to the sum of <code>await getPageLength(pageNum)</code> and the <em>initial</em> value of <code>totalLength</code>. If the <code>totalLength</code> variable is updated in a separate function call during the time that the <code>getPageLength(pageNum)</code> Promise is pending, that update will be lost because the new value is overwritten without being read.</p> <p>One way to fix this issue would be to ensure that <code>totalLength</code> is read at the same time as it’s updated, like this:</p> <pre class="language-js line-numbers-mode"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">addLengthOfSinglePage</span><span class="token punctuation">(</span><span class="token parameter">pageNum</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> lengthOfThisPage <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getPageLength</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">)</span><span class="token punctuation">;</span>

  totalLength <span class="token operator">+=</span> lengthOfThisPage<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Another solution would be to avoid using a mutable variable reference at all:</p> <pre class="language-js line-numbers-mode"><code>Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">getPageLength</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getPageLength</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">pageLengths</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> totalLength <span class="token operator">=</span> pageLengths<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">accumulator<span class="token punctuation">,</span> length</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> accumulator <span class="token operator">+</span> length<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The combined length of both pages is'</span><span class="token punctuation">,</span> totalLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="rule-details" tabindex="-1">Rule Details</h2> <p>This rule aims to report assignments to variables or properties in cases where the assignments may be based on outdated values.</p> <h3 id="variables" tabindex="-1">Variables</h3> <p>This rule reports an assignment to a variable when it detects the following execution flow in a generator or async function:</p> <ol> <li>The variable is read.</li> <li>A <code>yield</code> or <code>await</code> pauses the function.</li> <li>After the function is resumed, a value is assigned to the variable from step 1.</li> </ol> <p>The assignment in step 3 is reported because it may be incorrectly resolved because the value of the variable from step 1 may have changed between steps 2 and 3. In particular, if the variable can be accessed from other execution contexts (for example, if it is not a local variable and therefore other functions can change it), the value of the variable may have changed elsewhere while the function was paused in step 2.</p> <p>Note that the rule does not report the assignment in step 3 in any of the following cases:</p> <ul> <li>If the variable is read again between steps 2 and 3.</li> <li>If the variable cannot be accessed while the function is paused (for example, if it’s a local variable).</li> </ul> <p>Examples of <strong>incorrect</strong> code for this rule:</p> <div class="incorrect"> <a class="c-btn c-btn--secondary c-btn--playground" href="https://eslint.org/play#eyJvcHRpb25zIjp7InBhcnNlck9wdGlvbnMiOnsic291cmNlVHlwZSI6Im1vZHVsZSJ9fSwidGV4dCI6Ii8qIGVzbGludCByZXF1aXJlLWF0b21pYy11cGRhdGVzOiBlcnJvciAqL1xuXG5sZXQgcmVzdWx0O1xuXG5hc3luYyBmdW5jdGlvbiBmb28oKSB7XG4gICAgcmVzdWx0ICs9IGF3YWl0IHNvbWV0aGluZztcbn1cblxuYXN5bmMgZnVuY3Rpb24gYmFyKCkge1xuICAgIHJlc3VsdCA9IHJlc3VsdCArIGF3YWl0IHNvbWV0aGluZztcbn1cblxuYXN5bmMgZnVuY3Rpb24gYmF6KCkge1xuICAgIHJlc3VsdCA9IHJlc3VsdCArIGRvU29tZXRoaW5nKGF3YWl0IHNvbWV0aGluZ0Vsc2UpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBxdXgoKSB7XG4gICAgaWYgKCFyZXN1bHQpIHtcbiAgICAgICAgcmVzdWx0ID0gYXdhaXQgaW5pdGlhbGl6ZSgpO1xuICAgIH1cbn1cblxuZnVuY3Rpb24qIGdlbmVyYXRvcigpIHtcbiAgICByZXN1bHQgKz0geWllbGQ7XG59In0=" target="_blank"> Open in Playground </a><pre class="language-js line-numbers-mode"><code><span class="token comment">/* eslint require-atomic-updates: error */</span>

<span class="token keyword">let</span> result<span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">+=</span> <span class="token keyword">await</span> something<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> result <span class="token operator">+</span> <span class="token keyword">await</span> something<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> result <span class="token operator">+</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token keyword">await</span> somethingElse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">qux</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">+=</span> <span class="token keyword">yield</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>Examples of <strong>correct</strong> code for this rule:</p> <div class="correct"> <a class="c-btn c-btn--secondary c-btn--playground" href="https://eslint.org/play#eyJvcHRpb25zIjp7InBhcnNlck9wdGlvbnMiOnsic291cmNlVHlwZSI6Im1vZHVsZSJ9fSwidGV4dCI6Ii8qIGVzbGludCByZXF1aXJlLWF0b21pYy11cGRhdGVzOiBlcnJvciAqL1xuXG5sZXQgcmVzdWx0O1xuXG5hc3luYyBmdW5jdGlvbiBmb29iYXIoKSB7XG4gICAgcmVzdWx0ID0gYXdhaXQgc29tZXRoaW5nICsgcmVzdWx0O1xufVxuXG5hc3luYyBmdW5jdGlvbiBiYXooKSB7XG4gICAgY29uc3QgdG1wID0gZG9Tb21ldGhpbmcoYXdhaXQgc29tZXRoaW5nRWxzZSk7XG4gICAgcmVzdWx0ICs9IHRtcDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcXV4KCkge1xuICAgIGlmICghcmVzdWx0KSB7XG4gICAgICAgIGNvbnN0IHRtcCA9IGF3YWl0IGluaXRpYWxpemUoKTtcbiAgICAgICAgaWYgKCFyZXN1bHQpIHtcbiAgICAgICAgICAgIHJlc3VsdCA9IHRtcDtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcXV1eCgpIHtcbiAgICBsZXQgbG9jYWxWYXJpYWJsZSA9IDA7XG4gICAgbG9jYWxWYXJpYWJsZSArPSBhd2FpdCBzb21ldGhpbmc7XG59XG5cbmZ1bmN0aW9uKiBnZW5lcmF0b3IoKSB7XG4gICAgcmVzdWx0ID0gKHlpZWxkKSArIHJlc3VsdDtcbn0ifQ==" target="_blank"> Open in Playground </a><pre class="language-js line-numbers-mode"><code><span class="token comment">/* eslint require-atomic-updates: error */</span>

<span class="token keyword">let</span> result<span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">foobar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> something <span class="token operator">+</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> tmp <span class="token operator">=</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token keyword">await</span> somethingElse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">+=</span> tmp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">qux</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> tmp <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">quux</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> localVariable <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    localVariable <span class="token operator">+=</span> <span class="token keyword">await</span> something<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">yield</span><span class="token punctuation">)</span> <span class="token operator">+</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<h3 id="properties" tabindex="-1">Properties</h3> <p>This rule reports an assignment to a property through a variable when it detects the following execution flow in a generator or async function:</p> <ol> <li>The variable or object property is read.</li> <li>A <code>yield</code> or <code>await</code> pauses the function.</li> <li>After the function is resumed, a value is assigned to a property.</li> </ol> <p>This logic is similar to the logic for variables, but stricter because the property in step 3 doesn’t have to be the same as the property in step 1. It is assumed that the flow depends on the state of the object as a whole.</p> <p>Example of <strong>incorrect</strong> code for this rule:</p> <div class="incorrect"> <a class="c-btn c-btn--secondary c-btn--playground" href="https://eslint.org/play#eyJvcHRpb25zIjp7InBhcnNlck9wdGlvbnMiOnsic291cmNlVHlwZSI6Im1vZHVsZSJ9fSwidGV4dCI6Ii8qIGVzbGludCByZXF1aXJlLWF0b21pYy11cGRhdGVzOiBlcnJvciAqL1xuXG5hc3luYyBmdW5jdGlvbiBmb28ob2JqKSB7XG4gICAgaWYgKCFvYmouZG9uZSkge1xuICAgICAgICBvYmouc29tZXRoaW5nID0gYXdhaXQgZ2V0U29tZXRoaW5nKCk7XG4gICAgfVxufSJ9" target="_blank"> Open in Playground </a><pre class="language-js line-numbers-mode"><code><span class="token comment">/* eslint require-atomic-updates: error */</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        obj<span class="token punctuation">.</span>something <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>Example of <strong>correct</strong> code for this rule:</p> <div class="correct"> <a class="c-btn c-btn--secondary c-btn--playground" href="https://eslint.org/play#eyJvcHRpb25zIjp7InBhcnNlck9wdGlvbnMiOnsic291cmNlVHlwZSI6Im1vZHVsZSJ9fSwidGV4dCI6Ii8qIGVzbGludCByZXF1aXJlLWF0b21pYy11cGRhdGVzOiBlcnJvciAqL1xuXG5hc3luYyBmdW5jdGlvbiBmb28ob2JqKSB7XG4gICAgaWYgKCFvYmouZG9uZSkge1xuICAgICAgICBjb25zdCB0bXAgPSBhd2FpdCBnZXRTb21ldGhpbmcoKTtcbiAgICAgICAgaWYgKCFvYmouZG9uZSkge1xuICAgICAgICAgICAgb2JqLnNvbWV0aGluZyA9IHRtcDtcbiAgICAgICAgfVxuICAgIH1cbn0ifQ==" target="_blank"> Open in Playground </a><pre class="language-js line-numbers-mode"><code><span class="token comment">/* eslint require-atomic-updates: error */</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> tmp <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            obj<span class="token punctuation">.</span>something <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<h2 id="options" tabindex="-1">Options</h2> <p>This rule has an object option:</p> <ul> <li>
<code>"allowProperties"</code>: When set to <code>true</code>, the rule does not report assignments to properties. Default is <code>false</code>.</li> </ul> <h3 id="allowproperties" tabindex="-1">allowProperties</h3> <p>Example of <strong>correct</strong> code for this rule with the <code>{ "allowProperties": true }</code> option:</p> <div class="correct"> <a class="c-btn c-btn--secondary c-btn--playground" href="https://eslint.org/play#eyJvcHRpb25zIjp7InBhcnNlck9wdGlvbnMiOnsic291cmNlVHlwZSI6Im1vZHVsZSJ9fSwidGV4dCI6Ii8qIGVzbGludCByZXF1aXJlLWF0b21pYy11cGRhdGVzOiBbXCJlcnJvclwiLCB7IFwiYWxsb3dQcm9wZXJ0aWVzXCI6IHRydWUgfV0gKi9cblxuYXN5bmMgZnVuY3Rpb24gZm9vKG9iaikge1xuICAgIGlmICghb2JqLmRvbmUpIHtcbiAgICAgICAgb2JqLnNvbWV0aGluZyA9IGF3YWl0IGdldFNvbWV0aGluZygpO1xuICAgIH1cbn0ifQ==" target="_blank"> Open in Playground </a><pre class="language-js line-numbers-mode"><code><span class="token comment">/* eslint require-atomic-updates: ["error", { "allowProperties": true }] */</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        obj<span class="token punctuation">.</span>something <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<h2 id="when-not-to-use-it" tabindex="-1">When Not To Use It</h2> <p>If you don’t use async or generator functions, you don’t need to enable this rule.</p> <h2 id="version">Version</h2> <p>This rule was introduced in ESLint v5.3.0.</p> <h2 id="resources">Resources</h2> <ul> <li><a href="https://github.com/eslint/eslint/blob/main/lib/rules/require-atomic-updates.js">Rule source</a></li> <li><a href="https://github.com/eslint/eslint/blob/main/tests/lib/rules/require-atomic-updates.js">Tests source</a></li> </ul><div class="_attribution">
  <p class="_attribution-p">
    &copy; OpenJS Foundation and other contributors<br>Licensed under the MIT License.<br>
    <a href="https://eslint.org/docs/latest/rules/require-atomic-updates" class="_attribution-link">https://eslint.org/docs/latest/rules/require-atomic-updates</a>
  </p>
</div>
