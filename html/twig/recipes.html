<h1 id="recipes">Recipes</h1>  <h2>Displaying Deprecation Notices</h2> <p>Deprecated features generate deprecation notices (via a call to the <code class="docutils literal notranslate"><span class="pre">trigger_error()</span></code> PHP function). By default, they are silenced and never displayed nor logged.</p> <p>To remove all deprecated feature usages from your templates, write and run a script along the lines of the following:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="k">require_once</span> <span class="no">__DIR__</span><span class="o">.</span><span class="s1">'/vendor/autoload.php'</span><span class="p">;</span>

<span class="nv">$twig</span> <span class="o">=</span> <span class="nx">create_your_twig_env</span><span class="p">();</span>

<span class="nv">$deprecations</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Twig\Util\DeprecationCollector</span><span class="p">(</span><span class="nv">$twig</span><span class="p">);</span>

<span class="nb">print_r</span><span class="p">(</span><span class="nv">$deprecations</span><span class="o">-&gt;</span><span class="na">collectDir</span><span class="p">(</span><span class="no">__DIR__</span><span class="o">.</span><span class="s1">'/templates'</span><span class="p">));</span>
</pre></div> </div> <p>The <code class="docutils literal notranslate"><span class="pre">collectDir()</span></code> method compiles all templates found in a directory, catches deprecation notices, and return them.</p> <div class="admonition tip"> <p class="first admonition-title">Tip</p> <p class="last">If your templates are not stored on the filesystem, use the <code class="docutils literal notranslate"><span class="pre">collect()</span></code> method instead. <code class="docutils literal notranslate"><span class="pre">collect()</span></code> takes a <code class="docutils literal notranslate"><span class="pre">Traversable</span></code> which must return template names as keys and template contents as values (as done by <code class="docutils literal notranslate"><span class="pre">\Twig\Util\TemplateDirIterator</span></code>).</p> </div> <p>However, this code won’t find all deprecations (like using deprecated some Twig classes). To catch all notices, register a custom error handler like the one below:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="nv">$deprecations</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nb">set_error_handler</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="o">&amp;</span><span class="nv">$deprecations</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">E_USER_DEPRECATED</span> <span class="o">===</span> <span class="nv">$type</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$deprecations</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$msg</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// run your application</span>

<span class="nb">print_r</span><span class="p">(</span><span class="nv">$deprecations</span><span class="p">);</span>
</pre></div> </div> <p>Note that most deprecation notices are triggered during <strong>compilation</strong>, so they won’t be generated when templates are already cached.</p> <div class="admonition tip"> <p class="first admonition-title">Tip</p> <p class="last">If you want to manage the deprecation notices from your PHPUnit tests, have a look at the <a class="reference external" href="https://github.com/symfony/phpunit-bridge">symfony/phpunit-bridge</a> package, which eases the process.</p> </div>   <h2 id="making-a-layout-conditional">Making a Layout conditional</h2> <p>Working with Ajax means that the same content is sometimes displayed as is, and sometimes decorated with a layout. As Twig layout template names can be any valid expression, you can pass a variable that evaluates to <code class="docutils literal notranslate"><span class="pre">true</span></code> when the request is made via Ajax and choose the layout accordingly:</p> <div class="highlight-twig notranslate"><pre data-language="php" class="highlight"><span class="cp">{%</span> <span class="k">extends</span> <span class="nv">request.ajax</span> <span class="o">?</span> <span class="s2">"base_ajax.html"</span> <span class="o">:</span> <span class="s2">"base.html"</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="x">    This is the content to be displayed.</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></div>   <h2 id="making-an-include-dynamic">Making an Include dynamic</h2> <p>When including a template, its name does not need to be a string. For instance, the name can depend on the value of a variable:</p> <div class="highlight-twig notranslate"><pre data-language="php" class="highlight"><span class="cp">{%</span> <span class="k">include</span> <span class="nv">var</span> <span class="o">~</span> <span class="s1">'_foo.html'</span> <span class="cp">%}</span>
</pre></div> <p>If <code class="docutils literal notranslate"><span class="pre">var</span></code> evaluates to <code class="docutils literal notranslate"><span class="pre">index</span></code>, the <code class="docutils literal notranslate"><span class="pre">index_foo.html</span></code> template will be rendered.</p> <p>As a matter of fact, the template name can be any valid expression, such as the following:</p> <div class="highlight-twig notranslate"><pre data-language="php" class="highlight"><span class="cp">{%</span> <span class="k">include</span> <span class="nv">var</span><span class="o">|</span><span class="nf">default</span><span class="o">(</span><span class="s1">'index'</span><span class="o">)</span> <span class="o">~</span> <span class="s1">'_foo.html'</span> <span class="cp">%}</span>
</pre></div>   <h2 id="overriding-a-template-that-also-extends-itself">Overriding a Template that also extends itself</h2> <p>A template can be customized in two different ways:</p> <ul class="simple"> <li>
<em>Inheritance</em>: A template <em>extends</em> a parent template and overrides some blocks;</li> <li>
<em>Replacement</em>: If you use the filesystem loader, Twig loads the first template it finds in a list of configured directories; a template found in a directory <em>replaces</em> another one from a directory further in the list.</li> </ul> <p>But how do you combine both: <em>replace</em> a template that also extends itself (aka a template in a directory further in the list)?</p> <p>Let’s say that your templates are loaded from both <code class="docutils literal notranslate"><span class="pre">.../templates/mysite</span></code> and <code class="docutils literal notranslate"><span class="pre">.../templates/default</span></code> in this order. The <code class="docutils literal notranslate"><span class="pre">page.twig</span></code> template, stored in <code class="docutils literal notranslate"><span class="pre">.../templates/default</span></code> reads as follows:</p> <div class="highlight-twig notranslate"><pre data-language="php" class="highlight"><span class="c">{# page.twig #}</span>
<span class="cp">{%</span> <span class="k">extends</span> <span class="s2">"layout.twig"</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></div> <p>You can replace this template by putting a file with the same name in <code class="docutils literal notranslate"><span class="pre">.../templates/mysite</span></code>. And if you want to extend the original template, you might be tempted to write the following:</p> <div class="highlight-twig notranslate"><pre data-language="php" class="highlight"><span class="c">{# page.twig in .../templates/mysite #}</span>
<span class="cp">{%</span> <span class="k">extends</span> <span class="s2">"page.twig"</span> <span class="cp">%}</span><span class="c">{# from .../templates/default #}</span>
</pre></div> <p>However, this will not work as Twig will always load the template from <code class="docutils literal notranslate"><span class="pre">.../templates/mysite</span></code>.</p> <p>It turns out it is possible to get this to work, by adding a directory right at the end of your template directories, which is the parent of all of the other directories: <code class="docutils literal notranslate"><span class="pre">.../templates</span></code> in our case. This has the effect of making every template file within our system uniquely addressable. Most of the time you will use the “normal” paths, but in the special case of wanting to extend a template with an overriding version of itself we can reference its parent’s full, unambiguous template path in the extends tag:</p> <div class="highlight-twig notranslate"><pre data-language="php" class="highlight"><span class="c">{# page.twig in .../templates/mysite #}</span>
<span class="cp">{%</span> <span class="k">extends</span> <span class="s2">"default/page.twig"</span> <span class="cp">%}</span><span class="c">{# from .../templates #}</span>
</pre></div> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">This recipe was inspired by the following Django wiki page: <a class="reference external" href="https://code.djangoproject.com/wiki/ExtendingTemplates">https://code.djangoproject.com/wiki/ExtendingTemplates</a></p> </div>   <h2 id="customizing-the-syntax">Customizing the Syntax</h2> <p>Twig allows some syntax customization for the block delimiters. It’s <strong>not</strong> recommended to use this feature as templates will be tied with your custom syntax. But for specific projects, it can make sense to change the defaults.</p> <p>To change the block delimiters, you need to create your own lexer object:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="nv">$twig</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Twig\Environment</span><span class="p">(</span><span class="o">...</span><span class="p">);</span>

<span class="nv">$lexer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Twig\Lexer</span><span class="p">(</span><span class="nv">$twig</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">'tag_comment'</span>   <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'{#'</span><span class="p">,</span> <span class="s1">'#}'</span><span class="p">],</span>
    <span class="s1">'tag_block'</span>     <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'{%'</span><span class="p">,</span> <span class="s1">'%}'</span><span class="p">],</span>
    <span class="s1">'tag_variable'</span>  <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'{{'</span><span class="p">,</span> <span class="s1">'}}'</span><span class="p">],</span>
    <span class="s1">'interpolation'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'#{'</span><span class="p">,</span> <span class="s1">'}'</span><span class="p">],</span>
<span class="p">]);</span>
<span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">setLexer</span><span class="p">(</span><span class="nv">$lexer</span><span class="p">);</span>
</pre></div> </div> <p>Here are some configuration example that simulates some other template engines syntax:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="c1">// Ruby erb syntax</span>
<span class="nv">$lexer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Twig\Lexer</span><span class="p">(</span><span class="nv">$twig</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">'tag_comment'</span>  <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'&lt;%#'</span><span class="p">,</span> <span class="s1">'%&gt;'</span><span class="p">],</span>
    <span class="s1">'tag_block'</span>    <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'&lt;%'</span><span class="p">,</span> <span class="s1">'%&gt;'</span><span class="p">],</span>
    <span class="s1">'tag_variable'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'&lt;%='</span><span class="p">,</span> <span class="s1">'%&gt;'</span><span class="p">],</span>
<span class="p">]);</span>

<span class="c1">// SGML Comment Syntax</span>
<span class="nv">$lexer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Twig\Lexer</span><span class="p">(</span><span class="nv">$twig</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">'tag_comment'</span>  <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'&lt;!--#'</span><span class="p">,</span> <span class="s1">'--&gt;'</span><span class="p">],</span>
    <span class="s1">'tag_block'</span>    <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'&lt;!--'</span><span class="p">,</span> <span class="s1">'--&gt;'</span><span class="p">],</span>
    <span class="s1">'tag_variable'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'${'</span><span class="p">,</span> <span class="s1">'}'</span><span class="p">],</span>
<span class="p">]);</span>

<span class="c1">// Smarty like</span>
<span class="nv">$lexer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Twig\Lexer</span><span class="p">(</span><span class="nv">$twig</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">'tag_comment'</span>  <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'{*'</span><span class="p">,</span> <span class="s1">'*}'</span><span class="p">],</span>
    <span class="s1">'tag_block'</span>    <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'{'</span><span class="p">,</span> <span class="s1">'}'</span><span class="p">],</span>
    <span class="s1">'tag_variable'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'{$'</span><span class="p">,</span> <span class="s1">'}'</span><span class="p">],</span>
<span class="p">]);</span>
</pre></div> </div>   <h2 id="using-dynamic-object-properties">Using dynamic Object Properties</h2> <p>When Twig encounters a variable like <code class="docutils literal notranslate"><span class="pre">article.title</span></code>, it tries to find a <code class="docutils literal notranslate"><span class="pre">title</span></code> public property in the <code class="docutils literal notranslate"><span class="pre">article</span></code> object.</p> <p>It also works if the property does not exist but is rather defined dynamically thanks to the magic <code class="docutils literal notranslate"><span class="pre">__get()</span></code> method; you need to also implement the <code class="docutils literal notranslate"><span class="pre">__isset()</span></code> magic method like shown in the following snippet of code:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="k">class</span> <span class="nc">Article</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__get</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">'title'</span> <span class="o">==</span> <span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s1">'The title'</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// throw some kind of error</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__isset</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">'title'</span> <span class="o">==</span> <span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div> </div>   <h2 id="accessing-the-parent-context-in-nested-loops">Accessing the parent Context in Nested Loops</h2> <p>Sometimes, when using nested loops, you need to access the parent context. The parent context is always accessible via the <code class="docutils literal notranslate"><span class="pre">loop.parent</span></code> variable. For instance, if you have the following template data:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'topics'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'topic1'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'Message 1 of topic 1'</span><span class="p">,</span> <span class="s1">'Message 2 of topic 1'</span><span class="p">],</span>
        <span class="s1">'topic2'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'Message 1 of topic 2'</span><span class="p">,</span> <span class="s1">'Message 2 of topic 2'</span><span class="p">],</span>
    <span class="p">],</span>
<span class="p">];</span>
</pre></div> </div> <p>And the following template to display all messages in all topics:</p> <div class="highlight-twig notranslate"><pre data-language="php" class="highlight"><span class="cp">{%</span> <span class="k">for</span> <span class="nv">topic</span><span class="o">,</span> <span class="nv">messages</span> <span class="k">in</span> <span class="nv">topics</span> <span class="cp">%}</span>
<span class="x">    * </span><span class="cp">{{</span> <span class="nb">loop</span><span class="nv">.index</span> <span class="cp">}}</span><span class="x">: </span><span class="cp">{{</span> <span class="nv">topic</span> <span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">message</span> <span class="k">in</span> <span class="nv">messages</span> <span class="cp">%}</span>
<span class="x">      - </span><span class="cp">{{</span> <span class="nb">loop</span><span class="nv">.parent.loop.index</span> <span class="cp">}}</span><span class="x">.</span><span class="cp">{{</span> <span class="nb">loop</span><span class="nv">.index</span> <span class="cp">}}</span><span class="x">: </span><span class="cp">{{</span> <span class="nv">message</span> <span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
</pre></div> <p>The output will be similar to:</p> <div class="highlight-text notranslate"><pre data-language="php" class="highlight">* 1: topic1
  - 1.1: The message 1 of topic 1
  - 1.2: The message 2 of topic 1
* 2: topic2
  - 2.1: The message 1 of topic 2
  - 2.2: The message 2 of topic 2
</pre></div> <p>In the inner loop, the <code class="docutils literal notranslate"><span class="pre">loop.parent</span></code> variable is used to access the outer context. So, the index of the current <code class="docutils literal notranslate"><span class="pre">topic</span></code> defined in the outer for loop is accessible via the <code class="docutils literal notranslate"><span class="pre">loop.parent.loop.index</span></code> variable.</p>   <h2 id="defining-undefined-functions-and-filters-on-the-fly">Defining undefined Functions and Filters on the Fly</h2> <p>When a function (or a filter) is not defined, Twig defaults to throw a <code class="docutils literal notranslate"><span class="pre">\Twig\Error\SyntaxError</span></code> exception. However, it can also call a <a class="reference external" href="https://secure.php.net/manual/en/function.is-callable.php">callback</a> (any valid PHP callable) which should return a function (or a filter).</p> <p>For filters, register callbacks with <code class="docutils literal notranslate"><span class="pre">registerUndefinedFilterCallback()</span></code>. For functions, use <code class="docutils literal notranslate"><span class="pre">registerUndefinedFunctionCallback()</span></code>:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="c1">// auto-register all native PHP functions as Twig functions</span>
<span class="c1">// don't try this at home as it's not secure at all!</span>
<span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">registerUndefinedFunctionCallback</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="nv">$name</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">\Twig\TwigFunction</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
<span class="p">});</span>
</pre></div> </div> <p>If the callable is not able to return a valid function (or filter), it must return <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p> <p>If you register more than one callback, Twig will call them in turn until one does not return <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p> <div class="admonition tip"> <p class="first admonition-title">Tip</p> <p class="last">As the resolution of functions and filters is done during compilation, there is no overhead when registering these callbacks.</p> </div>   <h2 id="validating-the-template-syntax">Validating the Template Syntax</h2> <p>When template code is provided by a third-party (through a web interface for instance), it might be interesting to validate the template syntax before saving it. If the template code is stored in a <code class="docutils literal notranslate"><span class="pre">$template</span></code> variable, here is how you can do it:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="k">try</span> <span class="p">{</span>
    <span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">parse</span><span class="p">(</span><span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">tokenize</span><span class="p">(</span><span class="k">new</span> <span class="nx">\Twig\Source</span><span class="p">(</span><span class="nv">$template</span><span class="p">)));</span>

    <span class="c1">// the $template is valid</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Twig\Error\SyntaxError</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// $template contains one or more syntax errors</span>
<span class="p">}</span>
</pre></div> </div> <p>If you iterate over a set of files, you can pass the filename to the <code class="docutils literal notranslate"><span class="pre">tokenize()</span></code> method to get the filename in the exception message:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="k">foreach</span> <span class="p">(</span><span class="nv">$files</span> <span class="k">as</span> <span class="nv">$file</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">parse</span><span class="p">(</span><span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">tokenize</span><span class="p">(</span><span class="k">new</span> <span class="nx">\Twig\Source</span><span class="p">(</span><span class="nv">$template</span><span class="p">,</span> <span class="nv">$file</span><span class="o">-&gt;</span><span class="na">getFilename</span><span class="p">(),</span> <span class="nv">$file</span><span class="p">)));</span>

        <span class="c1">// the $template is valid</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Twig\Error\SyntaxError</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// $template contains one or more syntax errors</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div> </div> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">This method won’t catch any sandbox policy violations because the policy is enforced during template rendering (as Twig needs the context for some checks like allowed methods on objects).</p> </div>   <h2 id="refreshing-modified-templates-when-opcache-or-apc-is-enabled">Refreshing modified Templates when OPcache or APC is enabled</h2> <p>When using OPcache with <code class="docutils literal notranslate"><span class="pre">opcache.validate_timestamps</span></code> set to <code class="docutils literal notranslate"><span class="pre">0</span></code> or APC with <code class="docutils literal notranslate"><span class="pre">apc.stat</span></code> set to <code class="docutils literal notranslate"><span class="pre">0</span></code> and Twig cache enabled, clearing the template cache won’t update the cache.</p> <p>To get around this, force Twig to invalidate the bytecode cache:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="nv">$twig</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Twig\Environment</span><span class="p">(</span><span class="nv">$loader</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">'cache'</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">\Twig\Cache\FilesystemCache</span><span class="p">(</span><span class="s1">'/some/cache/path'</span><span class="p">,</span> <span class="nx">\Twig\Cache\FilesystemCache</span><span class="o">::</span><span class="na">FORCE_BYTECODE_INVALIDATION</span><span class="p">),</span>
    <span class="c1">// ...</span>
<span class="p">]);</span>
</pre></div> </div>   <h2 id="reusing-a-stateful-node-visitor">Reusing a stateful Node Visitor</h2> <p>When attaching a visitor to a <code class="docutils literal notranslate"><span class="pre">\Twig\Environment</span></code> instance, Twig uses it to visit <em>all</em> templates it compiles. If you need to keep some state information around, you probably want to reset it when visiting a new template.</p> <p>This can be achieved with the following code:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="k">protected</span> <span class="nv">$someTemplateState</span> <span class="o">=</span> <span class="p">[];</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">enterNode</span><span class="p">(</span><span class="nx">\Twig\Node\Node</span> <span class="nv">$node</span><span class="p">,</span> <span class="nx">\Twig\Environment</span> <span class="nv">$env</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span> <span class="nx">instanceof</span> <span class="nx">\Twig\Node\ModuleNode</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// reset the state as we are entering a new template</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">someTemplateState</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>

    <span class="k">return</span> <span class="nv">$node</span><span class="p">;</span>
<span class="p">}</span>
</pre></div> </div>   <h2 id="using-a-database-to-store-templates">Using a Database to store Templates</h2> <p>If you are developing a CMS, templates are usually stored in a database. This recipe gives you a simple PDO template loader you can use as a starting point for your own.</p> <p>First, let’s create a temporary in-memory SQLite3 database to work with:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="nv">$dbh</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="s1">'sqlite::memory:'</span><span class="p">);</span>
<span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">exec</span><span class="p">(</span><span class="s1">'CREATE TABLE templates (name STRING, source STRING, last_modified INTEGER)'</span><span class="p">);</span>
<span class="nv">$base</span> <span class="o">=</span> <span class="s1">'{% block content %}{% endblock %}'</span><span class="p">;</span>
<span class="nv">$index</span> <span class="o">=</span> <span class="s1">'</span>
<span class="s1">{% extends "base.twig" %}</span>
<span class="s1">{% block content %}Hello {{ name }}{% endblock %}</span>
<span class="s1">'</span><span class="p">;</span>
<span class="nv">$now</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
<span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s1">'INSERT INTO templates (name, source, last_modified) VALUES (?, ?, ?)'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">([</span><span class="s1">'base.twig'</span><span class="p">,</span> <span class="nv">$base</span><span class="p">,</span> <span class="nv">$now</span><span class="p">]);</span>
<span class="nv">$dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s1">'INSERT INTO templates (name, source, last_modified) VALUES (?, ?, ?)'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">([</span><span class="s1">'index.twig'</span><span class="p">,</span> <span class="nv">$index</span><span class="p">,</span> <span class="nv">$now</span><span class="p">]);</span>
</pre></div> </div> <p>We have created a simple <code class="docutils literal notranslate"><span class="pre">templates</span></code> table that hosts two templates: <code class="docutils literal notranslate"><span class="pre">base.twig</span></code> and <code class="docutils literal notranslate"><span class="pre">index.twig</span></code>.</p> <p>Now, let’s define a loader able to use this database:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="k">class</span> <span class="nc">DatabaseTwigLoader</span> <span class="k">implements</span> <span class="nx">\Twig\Loader\LoaderInterface</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$dbh</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">PDO</span> <span class="nv">$dbh</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dbh</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getSourceContext</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$name</span><span class="p">)</span><span class="o">:</span> <span class="nx">Source</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nv">$source</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getValue</span><span class="p">(</span><span class="s1">'source'</span><span class="p">,</span> <span class="nv">$name</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Twig\Error\LoaderError</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="s1">'Template "%s" does not exist.'</span><span class="p">,</span> <span class="nv">$name</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nx">\Twig\Source</span><span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="nv">$name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">exists</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$name</span> <span class="o">===</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getValue</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="nv">$name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getCacheKey</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$name</span><span class="p">)</span><span class="o">:</span> <span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">isFresh</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$name</span><span class="p">,</span> <span class="nx">int</span> <span class="nv">$time</span><span class="p">)</span><span class="o">:</span> <span class="nx">bool</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">false</span> <span class="o">===</span> <span class="nv">$lastModified</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getValue</span><span class="p">(</span><span class="s1">'last_modified'</span><span class="p">,</span> <span class="nv">$name</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$lastModified</span> <span class="o">&lt;=</span> <span class="nv">$time</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">getValue</span><span class="p">(</span><span class="nv">$column</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dbh</span><span class="o">-&gt;</span><span class="na">prepare</span><span class="p">(</span><span class="s1">'SELECT '</span><span class="o">.</span><span class="nv">$column</span><span class="o">.</span><span class="s1">' FROM templates WHERE name = :name'</span><span class="p">);</span>
        <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">([</span><span class="s1">':name'</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="nv">$name</span><span class="p">]);</span>

        <span class="k">return</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="na">fetchColumn</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div> </div> <p>Finally, here is an example on how you can use it:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="nv">$loader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DatabaseTwigLoader</span><span class="p">(</span><span class="nv">$dbh</span><span class="p">);</span>
<span class="nv">$twig</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Twig\Environment</span><span class="p">(</span><span class="nv">$loader</span><span class="p">);</span>

<span class="k">echo</span> <span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'index.twig'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'Fabien'</span><span class="p">]);</span>
</pre></div> </div>   <h2 id="using-different-template-sources">Using different Template Sources</h2> <p>This recipe is the continuation of the previous one. Even if you store the contributed templates in a database, you might want to keep the original/base templates on the filesystem. When templates can be loaded from different sources, you need to use the <code class="docutils literal notranslate"><span class="pre">\Twig\Loader\ChainLoader</span></code> loader.</p> <p>As you can see in the previous recipe, we reference the template in the exact same way as we would have done it with a regular filesystem loader. This is the key to be able to mix and match templates coming from the database, the filesystem, or any other loader for that matter: the template name should be a logical name, and not the path from the filesystem:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="nv">$loader1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DatabaseTwigLoader</span><span class="p">(</span><span class="nv">$dbh</span><span class="p">);</span>
<span class="nv">$loader2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Twig\Loader\ArrayLoader</span><span class="p">([</span>
    <span class="s1">'base.twig'</span> <span class="o">=&gt;</span> <span class="s1">'{% block content %}{% endblock %}'</span><span class="p">,</span>
<span class="p">]);</span>
<span class="nv">$loader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Twig\Loader\ChainLoader</span><span class="p">([</span><span class="nv">$loader1</span><span class="p">,</span> <span class="nv">$loader2</span><span class="p">]);</span>

<span class="nv">$twig</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Twig\Environment</span><span class="p">(</span><span class="nv">$loader</span><span class="p">);</span>

<span class="k">echo</span> <span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'index.twig'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'Fabien'</span><span class="p">]);</span>
</pre></div> </div> <p>Now that the <code class="docutils literal notranslate"><span class="pre">base.twig</span></code> templates is defined in an array loader, you can remove it from the database, and everything else will still work as before.</p>   <h2 id="loading-a-template-from-a-string">Loading a Template from a String</h2> <p>From a template, you can load a template stored in a string via the <code class="docutils literal notranslate"><span class="pre">template_from_string</span></code> function (via the <code class="docutils literal notranslate"><span class="pre">\Twig\Extension\StringLoaderExtension</span></code> extension):</p> <div class="highlight-twig notranslate"><pre data-language="php" class="highlight"><span class="cp">{{</span> <span class="nv">include</span><span class="o">(</span><span class="nv">template_from_string</span><span class="o">(</span><span class="s2">"Hello {{ name }}"</span><span class="o">))</span> <span class="cp">}}</span>
</pre></div> <p>From PHP, it’s also possible to load a template stored in a string via <code class="docutils literal notranslate"><span class="pre">\Twig\Environment::createTemplate()</span></code>:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="nv">$template</span> <span class="o">=</span> <span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">createTemplate</span><span class="p">(</span><span class="s1">'hello {{ name }}'</span><span class="p">);</span>
<span class="k">echo</span> <span class="nv">$template</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">([</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'Fabien'</span><span class="p">]);</span>
</pre></div> </div>   <h2 id="using-twig-and-angularjs-in-the-same-templates">Using Twig and AngularJS in the same Templates</h2> <p>Mixing different template syntaxes in the same file is not a recommended practice as both AngularJS and Twig use the same delimiters in their syntax: <code class="docutils literal notranslate"><span class="pre">{{</span></code> and <code class="docutils literal notranslate"><span class="pre">}}</span></code>.</p> <p>Still, if you want to use AngularJS and Twig in the same template, there are two ways to make it work depending on the amount of AngularJS you need to include in your templates:</p> <ul> <li>
<p class="first">Escaping the AngularJS delimiters by wrapping AngularJS sections with the <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">verbatim</span> <span class="pre">%}</span></code> tag or by escaping each delimiter via <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">'{{'</span> <span class="pre">}}</span></code> and <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">'}}'</span> <span class="pre">}}</span></code>;</p> </li> <li>
<p class="first">Changing the delimiters of one of the template engines (depending on which engine you introduced last):</p> <ul> <li>
<p class="first">For AngularJS, change the interpolation tags using the <code class="docutils literal notranslate"><span class="pre">interpolateProvider</span></code> service, for instance at the module initialization time:</p> <div class="highlight-javascript notranslate"><pre data-language="php" class="highlight"><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'myApp'</span><span class="p">,</span> <span class="p">[]).</span><span class="nx">config</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$interpolateProvider</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$interpolateProvider</span><span class="p">.</span><span class="nx">startSymbol</span><span class="p">(</span><span class="s1">'{['</span><span class="p">).</span><span class="nx">endSymbol</span><span class="p">(</span><span class="s1">']}'</span><span class="p">);</span>
<span class="p">});</span>
</pre></div> </li> <li>
<p class="first">For Twig, change the delimiters via the <code class="docutils literal notranslate"><span class="pre">tag_variable</span></code> Lexer option:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="nv">$env</span><span class="o">-&gt;</span><span class="na">setLexer</span><span class="p">(</span><span class="k">new</span> <span class="nx">\Twig\Lexer</span><span class="p">(</span><span class="nv">$env</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">'tag_variable'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'{['</span><span class="p">,</span> <span class="s1">']}'</span><span class="p">],</span>
<span class="p">]));</span>
</pre></div> </div> </li> </ul> </li> </ul>    <div class="navigation" style="text-align: center"> <a accesskey="P" title="Deprecated Features" href="https://twig.symfony.com/doc/3.x/deprecated.html"> « Deprecated Features </a> <span class="separator">|</span> <a accesskey="N" title="Coding Standards" href="coding_standards.html"> Coding Standards » </a> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2009&ndash;2018 by the Twig Team<br>Licensed under the three clause BSD license.<br>The Twig logo is &copy; 2010&ndash;2020 Symfony<br>
    <a href="https://twig.symfony.com/doc/3.x/recipes.html" class="_attribution-link">https://twig.symfony.com/doc/3.x/recipes.html</a>
  </p>
</div>
