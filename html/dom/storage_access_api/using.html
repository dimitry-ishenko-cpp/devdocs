<header><h1>Using the Storage Access API</h1></header><div class="section-content"><p>The <a href="../storage_access_api.html">Storage Access API</a> can be used by embedded cross-site documents to verify whether they have access to unpartitioned cookies and, if not, to request access. We'll briefly look at a common storage access scenario.</p></div>
<h2 id="usage_notes">Usage notes</h2>
<div class="section-content">
<p>The Storage Access API is designed to allow embedded content to request access to unpartitioned cookies — most modern browsers block such access by default to protect user privacy. Since embedded content won't know what a browser's behavior is going to be in this regard, it's best to always check whether the embedded <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe"><code>&lt;iframe&gt;</code></a> has storage access before attempting to read or write a cookie. This is particularly true for <a href="../document/cookie.html"><code>Document.cookie</code></a> access, as browsers will often return an empty cookie jar when third-party cookie access is blocked.</p> <p>In the example below, we show how an embedded cross-site <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe"><code>&lt;iframe&gt;</code></a> can access unpartitioned cookies under a browser storage access policy that blocks third-party cookie access.</p>
</div>
<h2 id="allowing_a_sandboxed_iframe_to_use_the_api">Allowing a sandboxed &lt;iframe&gt; to use the API</h2>
<div class="section-content">
<p>First of all, if the <code>&lt;iframe&gt;</code> is sandboxed, the embedding website needs to add the <code>allow-storage-access-by-user-activation</code> <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe#sandbox">sandbox token</a> to allow Storage Access API requests to be successful, along with <code>allow-scripts</code> and <code>allow-same-origin</code> to allow it to execute a script to call the API and execute it in an origin that can have cookies:</p> <div class="code-example">
<p class="example-header"><span class="language-name">html</span></p>
<pre data-signature="LiNEgm+7VKVwjuEFnrX4AXfppRKSGke45b4qykPpbZw=" data-language="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span>
  <span class="token attr-name">sandbox</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>allow-storage-access-by-user-activation
                 allow-scripts
                 allow-same-origin<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  …
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span>
</pre>
</div>
</div>
<h2 id="checking_and_requesting_storage_access">Checking and requesting storage access</h2>
<div class="section-content">
<p>Now on to the code executed inside the embedded document. In this code:</p> <ol> <li>We first use feature detection (<code>if (document.hasStorageAccess) {}</code>) to check whether the API is supported. If not, we run our code that accesses cookies anyway, and hope that it works. It should be coded defensively to deal with such eventualities anyway.</li> <li>If the API is supported, we call <code>document.hasStorageAccess()</code>.</li> <li>If that call returns <code>true</code>, it means this <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe"><code>&lt;iframe&gt;</code></a> has already obtained access, and we can run our code that accesses cookies right away.</li> <li>If that call returns <code>false</code>, we then call <a href="../permissions/query.html"><code>Permissions.query()</code></a> to check whether permission to access unpartitioned cookies has already been granted (i.e. to another same-site embed). We wrap this whole section in a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/try...catch"><code>try...catch</code></a> block because some browsers don't support the <code>"storage-access"</code> permission, which can cause the <code>query()</code> call to throw. If it throws, we report that to the console and try running the cookie code anyway.</li> <li>If the permission state is <code>"granted"</code>, we immediately call <code>document.requestStorageAccess()</code>. This call will automatically resolve, saving the user some time, then we can run our code that accesses cookies.</li> <li>If the permission state is <code>"prompt"</code>, we call <code>document.requestStorageAccess()</code> after user interaction. This call may trigger a prompt to the user. If this call resolves, then we can run our code that accesses cookies.</li> <li>If the permission state is <code>"denied"</code>, the user has denied our requests to access unpartitioned cookies, and our code cannot make use of them.</li> </ol> <div class="code-example">
<p class="example-header"><span class="language-name">js</span></p>
<pre data-signature="ripGfEFRe9uoyVYn+l/pYdzDu9nws1kWDVabt6sJRnM=" data-language="js"><span class="token keyword">function</span> <span class="token function">doThingsWithCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token string">"foo=bar"</span><span class="token punctuation">;</span> <span class="token comment">// set a cookie</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleCookieAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>document<span class="token punctuation">.</span>hasStorageAccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This browser doesn't support the Storage Access API</span>
    <span class="token comment">// so let's just hope we have access!</span>
    <span class="token function">doThingsWithCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> hasAccess <span class="token operator">=</span> <span class="token keyword">await</span> document<span class="token punctuation">.</span><span class="token function">hasStorageAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasAccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// We have access to unpartitioned cookies, so let's go</span>
      <span class="token function">doThingsWithCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Check whether unpartitioned cookie access has been granted</span>
      <span class="token comment">// to another same-site embed</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> permission <span class="token operator">=</span> <span class="token keyword">await</span> navigator<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"storage-access"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>permission<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">"granted"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// If so, you can just call requestStorageAccess() without a user interaction,</span>
          <span class="token comment">// and it will resolve automatically.</span>
          <span class="token keyword">await</span> document<span class="token punctuation">.</span><span class="token function">requestStorageAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">doThingsWithCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>permission<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">"prompt"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Need to call requestStorageAccess() after a user interaction</span>
          btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">await</span> document<span class="token punctuation">.</span><span class="token function">requestStorageAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">doThingsWithCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// If there is an error obtaining storage access.</span>
              console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Error obtaining storage access: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.
                            Please sign in.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>permission<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">"denied"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// User has denied unpartitioned cookie access, so we'll</span>
          <span class="token comment">// need to do something else</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Could not access permission state. Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">doThingsWithCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Again, we'll have to hope we have access!</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre>
</div> <div class="notecard note" id="sect1"> <p><strong>Note:</strong> <code>requestStorageAccess()</code> requests are automatically denied unless the embedded content is currently processing a user gesture such as a tap or click (<a href="https://developer.mozilla.org/en-US/docs/Glossary/Transient_activation">transient activation</a>), or if permission was already granted previously. If permission was not previously granted, they need to be run inside some kind of user gesture-based event handler, as shown above.</p> </div>
</div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2005&ndash;2023 MDN contributors.<br>Licensed under the Creative Commons Attribution-ShareAlike License v2.5 or later.<br>
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/Storage_Access_API/Using" class="_attribution-link">https://developer.mozilla.org/en-US/docs/Web/API/Storage_Access_API/Using</a>
  </p>
</div>
