<h1 id="class-CSV::Parser" class="class"> class CSV::Parser </h1>
<dl class="meta">
<dt>Parent:</dt>
<dd class="meta-parent"><a href="../object.html">Object</a></dd>
</dl> <section class="description"> <p>Note: Donâ€™t use this class directly. This is an internal class.</p> </section> <section id="5Buntitled-5D" class="documentation-section"> <section class="constants-list"> <header> <h3>Constants</h3> </header> <dl> <dt id="SCANNER_TEST">SCANNER_TEST </dt>

<dt id="SCANNER_TEST_CHUNK_SIZE_NAME">SCANNER_TEST_CHUNK_SIZE_NAME </dt>

<dt id="SCANNER_TEST_CHUNK_SIZE_VALUE">SCANNER_TEST_CHUNK_SIZE_VALUE </dt>

<dt id="STRING_SCANNER_SCAN_ACCEPT_STRING">STRING_SCANNER_SCAN_ACCEPT_STRING </dt>

</dl> </section> <section id="public-class-5Buntitled-5D-method-details" class="method-section"> <header> <h3>Public Class Methods</h3> </header> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-c-new"> <span class="method-name">new</span><span class="method-args">(input, options)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="new-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 326
def initialize(input, options)
  @input = input
  @options = options
  @samples = []

  prepare
end</pre> </div>  </div> </div> </section> <section id="public-instance-5Buntitled-5D-method-details" class="method-section"> <header> <h3>Public Instance Methods</h3> </header> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-column_separator"> <span class="method-name">column_separator</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="column_separator-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 334
def column_separator
  @column_separator
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-field_size_limit"> <span class="method-name">field_size_limit</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="field_size_limit-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 346
def field_size_limit
  @max_field_size&amp;.succ
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-header_row-3F"> <span class="method-name">header_row?</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="header_row-3F-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 366
def header_row?
  @use_headers and @headers.nil?
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-headers"> <span class="method-name">headers</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="headers-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 362
def headers
  @headers
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-liberal_parsing-3F"> <span class="method-name">liberal_parsing?</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="liberal_parsing-3F-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 378
def liberal_parsing?
  @liberal_parsing
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-line"> <span class="method-name">line</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="line-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 386
def line
  last_line
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-lineno"> <span class="method-name">lineno</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="lineno-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 382
def lineno
  @lineno
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-max_field_size"> <span class="method-name">max_field_size</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="max_field_size-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 350
def max_field_size
  @max_field_size
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-parse"> <span class="method-name">parse</span><span class="method-args">() { |headers| ... }</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="parse-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 390
def parse(&amp;block)
  return to_enum(__method__) unless block_given?

  if @return_headers and @headers and @raw_headers
    headers = Row.new(@headers, @raw_headers, true)
    if @unconverted_fields
      headers = add_unconverted_fields(headers, [])
    end
    yield headers
  end

  begin
    @scanner ||= build_scanner
    if quote_character.nil?
      parse_no_quote(&amp;block)
    elsif @need_robust_parsing
      parse_quotable_robust(&amp;block)
    else
      parse_quotable_loose(&amp;block)
    end
  rescue InvalidEncoding
    if @scanner
      ignore_broken_line
      lineno = @lineno
    else
      lineno = @lineno + 1
    end
    raise InvalidEncodingError.new(@encoding, lineno)
  rescue UnexpectedError =&gt; error
    if @scanner
      ignore_broken_line
      lineno = @lineno
    else
      lineno = @lineno + 1
    end
    message = "This should not be happen: #{error.message}: "
    message += "Please report this to https://github.com/ruby/csv/issues"
    raise MalformedCSVError.new(message, lineno)
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-quote_character"> <span class="method-name">quote_character</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="quote_character-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 342
def quote_character
  @quote_character
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-return_headers-3F"> <span class="method-name">return_headers?</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="return_headers-3F-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 370
def return_headers?
  @return_headers
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-row_separator"> <span class="method-name">row_separator</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="row_separator-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 338
def row_separator
  @row_separator
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-skip_blanks-3F"> <span class="method-name">skip_blanks?</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="skip_blanks-3F-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 374
def skip_blanks?
  @skip_blanks
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-skip_lines"> <span class="method-name">skip_lines</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="skip_lines-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 354
def skip_lines
  @skip_lines
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-unconverted_fields-3F"> <span class="method-name">unconverted_fields?</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="unconverted_fields-3F-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 358
def unconverted_fields?
  @unconverted_fields
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-use_headers-3F"> <span class="method-name">use_headers?</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="use_headers-3F-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 431
def use_headers?
  @use_headers
end</pre> </div>  </div> </div> </section> <section id="private-instance-5Buntitled-5D-method-details" class="method-section"> <header> <h3>Private Instance Methods</h3> </header> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-add_unconverted_fields"> <span class="method-name">add_unconverted_fields</span><span class="method-args">(row, fields)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="add_unconverted_fields-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 1280
def add_unconverted_fields(row, fields)
  class &lt;&lt; row
    attr_reader :unconverted_fields
  end
  row.instance_variable_set(:@unconverted_fields, fields)
  row
end</pre> </div> <p>This method injects an instance variable <code>unconverted_fields</code> into <code>row</code> and an accessor method for <code>row</code> called unconverted_fields(). The variable is set to the contents of <code>fields</code>.</p>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-adjust_headers"> <span class="method-name">adjust_headers</span><span class="method-args">(headers, quoted_fields)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="adjust_headers-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 794
def adjust_headers(headers, quoted_fields)
  adjusted_headers = @header_fields_converter.convert(headers, nil, @lineno, quoted_fields)
  adjusted_headers.each {|h| h.freeze if h.is_a? String}
  adjusted_headers
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-build_scanner"> <span class="method-name">build_scanner</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="build_scanner-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 840
def build_scanner
  inputs = @samples.collect do |sample|
    UnoptimizedStringIO.new(sample)
  end
  if @input.is_a?(StringIO)
    inputs &lt;&lt; UnoptimizedStringIO.new(@input.read)
  else
    inputs &lt;&lt; @input
  end
  begin
    chunk_size_value = ENV[SCANNER_TEST_CHUNK_SIZE_NAME]
  rescue # Ractor::IsolationError
    # Ractor on Ruby 3.0 can't read ENV value.
    chunk_size_value = SCANNER_TEST_CHUNK_SIZE_VALUE
  end
  chunk_size = Integer((chunk_size_value || "1"), 10)
  InputsScanner.new(inputs,
                    @encoding,
                    @row_separator,
                    chunk_size: chunk_size)
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-detect_row_separator"> <span class="method-name">detect_row_separator</span><span class="method-args">(sample, cr, lf)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="detect_row_separator-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 716
def detect_row_separator(sample, cr, lf)
  lf_index = sample.index(lf)
  if lf_index
    cr_index = sample[0, lf_index].index(cr)
  else
    cr_index = sample.index(cr)
  end
  if cr_index and lf_index
    if cr_index + 1 == lf_index
      cr + lf
    elsif cr_index &lt; lf_index
      cr
    else
      lf
    end
  elsif cr_index
    cr
  elsif lf_index
    lf
  else
    :auto
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-emit_row"> <span class="method-name">emit_row</span><span class="method-args">(row, quoted_fields) { |row| ... }</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="emit_row-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 1251
def emit_row(row, quoted_fields, &amp;block)
  @lineno += 1

  raw_row = row
  if @use_headers
    if @headers.nil?
      @headers = adjust_headers(row, quoted_fields)
      return unless @return_headers
      row = Row.new(@headers, row, true)
    else
      row = Row.new(@headers,
                    @fields_converter.convert(raw_row, @headers, @lineno, quoted_fields))
    end
  else
    # convert fields, if needed...
    row = @fields_converter.convert(raw_row, nil, @lineno, quoted_fields)
  end

  # inject unconverted fields and accessor, if requested...
  if @unconverted_fields and not row.respond_to?(:unconverted_fields)
    add_unconverted_fields(row, raw_row)
  end

  yield(row)
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-ignore_broken_line"> <span class="method-name">ignore_broken_line</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="ignore_broken_line-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 1236
def ignore_broken_line
  @scanner.scan_all(@not_line_end)
  @scanner.scan_all(@line_end)
  @lineno += 1
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-last_line"> <span class="method-name">last_line</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="last_line-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 746
def last_line
  if @scanner
    @last_line ||= @scanner.keep_end
  else
    @last_line
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-may_quoted-3F"> <span class="method-name">may_quoted?</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="may_quoted-3F-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 804
def may_quoted?
  return false if @quote_character.nil?

  if @input.is_a?(StringIO)
    pos = @input.pos
    sample = @input.read
    @input.seek(pos)
  else
    return false if @samples.empty?
    sample = @samples.first
  end
  sample[0, 128].index(@quote_character)
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-parse_column_end"> <span class="method-name">parse_column_end</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="parse_column_end-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 1191
def parse_column_end
  return true if @scanner.scan(@column_end)
  return false unless @column_ends

  @scanner.keep_start
  if @column_ends.all? {|column_end| @scanner.scan(column_end)}
    @scanner.keep_drop
    true
  else
    @scanner.keep_back
    false
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-parse_column_value"> <span class="method-name">parse_column_value</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="parse_column_value-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 1091
def parse_column_value
  if @liberal_parsing
    quoted_value = parse_quoted_column_value
    if quoted_value
      @scanner.scan_all(@strip_value) if @strip_value
      unquoted_value = parse_unquoted_column_value
      if unquoted_value
        if @double_quote_outside_quote
          unquoted_value = unquoted_value.gsub(@quote_character * 2,
                                               @quote_character)
          if quoted_value.empty? # %Q{""...} case
            return @quote_character + unquoted_value
          end
        end
        @quote_character + quoted_value + @quote_character + unquoted_value
      else
        quoted_value
      end
    else
      parse_unquoted_column_value
    end
  elsif @may_quoted
    parse_quoted_column_value ||
      parse_unquoted_column_value
  else
    parse_unquoted_column_value ||
      parse_quoted_column_value
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-parse_headers"> <span class="method-name">parse_headers</span><span class="method-args">(row)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="parse_headers-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 780
def parse_headers(row)
  quoted_fields = []
  converter = lambda do |field, info|
    quoted_fields &lt;&lt; info.quoted?
    field
  end
  headers = CSV.parse_line(row,
                           col_sep:    @column_separator,
                           row_sep:    @row_separator,
                           quote_char: @quote_character,
                           converters: [converter])
  [headers, quoted_fields]
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-parse_no_quote"> <span class="method-name">parse_no_quote</span><span class="method-args">(&amp;block)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="parse_no_quote-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 929
def parse_no_quote(&amp;block)
  @scanner.each_line(@row_separator) do |line|
    next if @skip_lines and skip_line?(line)
    original_line = line
    line = line.delete_suffix(@row_separator)

    if line.empty?
      next if @skip_blanks
      row = []
      quoted_fields = []
    else
      line = strip_value(line)
      row = line.split(@split_column_separator, -1)
      quoted_fields = [false] * row.size
      if @max_field_size
        row.each do |column|
          validate_field_size(column)
        end
      end
      n_columns = row.size
      i = 0
      while i &lt; n_columns
        row[i] = nil if row[i].empty?
        i += 1
      end
    end
    @last_line = original_line
    emit_row(row, quoted_fields, &amp;block)
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-parse_quotable_loose"> <span class="method-name">parse_quotable_loose</span><span class="method-args">(&amp;block)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="parse_quotable_loose-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 960
def parse_quotable_loose(&amp;block)
  @scanner.keep_start
  @scanner.each_line(@row_separator) do |line|
    if @skip_lines and skip_line?(line)
      @scanner.keep_drop
      @scanner.keep_start
      next
    end
    original_line = line
    line = line.delete_suffix(@row_separator)

    if line.empty?
      if @skip_blanks
        @scanner.keep_drop
        @scanner.keep_start
        next
      end
      row = []
      quoted_fields = []
    elsif line.include?(@cr) or line.include?(@lf)
      @scanner.keep_back
      @need_robust_parsing = true
      return parse_quotable_robust(&amp;block)
    else
      row = line.split(@split_column_separator, -1)
      quoted_fields = []
      n_columns = row.size
      i = 0
      while i &lt; n_columns
        column = row[i]
        if column.empty?
          quoted_fields &lt;&lt; false
          row[i] = nil
        else
          n_quotes = column.count(@quote_character)
          if n_quotes.zero?
            quoted_fields &lt;&lt; false
            # no quote
          elsif n_quotes == 2 and
               column.start_with?(@quote_character) and
               column.end_with?(@quote_character)
            quoted_fields &lt;&lt; true
            row[i] = column[1..-2]
          else
            @scanner.keep_back
            @need_robust_parsing = true
            return parse_quotable_robust(&amp;block)
          end
          validate_field_size(row[i])
        end
        i += 1
      end
    end
    @scanner.keep_drop
    @scanner.keep_start
    @last_line = original_line
    emit_row(row, quoted_fields, &amp;block)
  end
  @scanner.keep_drop
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-parse_quotable_robust"> <span class="method-name">parse_quotable_robust</span><span class="method-args">(&amp;block)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="parse_quotable_robust-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 1021
def parse_quotable_robust(&amp;block)
  row = []
  quoted_fields = []
  skip_needless_lines
  start_row
  while true
    @quoted_column_value = false
    @unquoted_column_value = false
    @scanner.scan_all(@strip_value) if @strip_value
    value = parse_column_value
    if value
      @scanner.scan_all(@strip_value) if @strip_value
      validate_field_size(value)
    end
    if parse_column_end
      row &lt;&lt; value
      quoted_fields &lt;&lt; @quoted_column_value
    elsif parse_row_end
      if row.empty? and value.nil?
        emit_row([], [], &amp;block) unless @skip_blanks
      else
        row &lt;&lt; value
        quoted_fields &lt;&lt; @quoted_column_value
        emit_row(row, quoted_fields, &amp;block)
        row = []
        quoted_fields = []
      end
      skip_needless_lines
      start_row
    elsif @scanner.eos?
      break if row.empty? and value.nil?
      row &lt;&lt; value
      quoted_fields &lt;&lt; @quoted_column_value
      emit_row(row, quoted_fields, &amp;block)
      break
    else
      if @quoted_column_value
        if liberal_parsing? and (new_line = @scanner.check(@line_end))
          message =
            "Illegal end-of-line sequence outside of a quoted field " +
            "&lt;#{new_line.inspect}&gt;"
        else
          message = "Any value after quoted field isn't allowed"
        end
        ignore_broken_line
        raise MalformedCSVError.new(message, @lineno)
      elsif @unquoted_column_value and
            (new_line = @scanner.scan(@line_end))
        ignore_broken_line
        message = "Unquoted fields do not allow new line " +
                  "&lt;#{new_line.inspect}&gt;"
        raise MalformedCSVError.new(message, @lineno)
      elsif @scanner.rest.start_with?(@quote_character)
        ignore_broken_line
        message = "Illegal quoting"
        raise MalformedCSVError.new(message, @lineno)
      elsif (new_line = @scanner.scan(@line_end))
        ignore_broken_line
        message = "New line must be &lt;#{@row_separator.inspect}&gt; " +
                  "not &lt;#{new_line.inspect}&gt;"
        raise MalformedCSVError.new(message, @lineno)
      else
        ignore_broken_line
        raise MalformedCSVError.new("TODO: Meaningful message",
                                    @lineno)
      end
    end
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-parse_quoted_column_value"> <span class="method-name">parse_quoted_column_value</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="parse_quoted_column_value-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 1149
def parse_quoted_column_value
  quotes = @scanner.scan_all(@quotes)
  return nil unless quotes

  @quoted_column_value = true
  n_quotes = quotes.size
  if (n_quotes % 2).zero?
    quotes[0, (n_quotes - 2) / 2]
  else
    value = quotes[0, n_quotes / 2]
    while true
      quoted_value = @scanner.scan_all(@quoted_value)
      value &lt;&lt; quoted_value if quoted_value
      if @backslash_quote
        if @scanner.scan(@escaped_backslash)
          if @scanner.scan(@escaped_quote)
            value &lt;&lt; @quote_character
          else
            value &lt;&lt; @backslash_character
          end
          next
        end
      end

      quotes = @scanner.scan_all(@quotes)
      unless quotes
        ignore_broken_line
        message = "Unclosed quoted field"
        raise MalformedCSVError.new(message, @lineno)
      end
      n_quotes = quotes.size
      if n_quotes == 1
        break
      else
        value &lt;&lt; quotes[0, n_quotes / 2]
        break if (n_quotes % 2) == 1
      end
    end
    value
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-parse_row_end"> <span class="method-name">parse_row_end</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="parse_row_end-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 1205
def parse_row_end
  return true if @scanner.scan(@row_end)
  return false unless @row_ends
  @scanner.keep_start
  if @row_ends.all? {|row_end| @scanner.scan(row_end)}
    @scanner.keep_drop
    true
  else
    @scanner.keep_back
    false
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-parse_unquoted_column_value"> <span class="method-name">parse_unquoted_column_value</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="parse_unquoted_column_value-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 1121
def parse_unquoted_column_value
  value = @scanner.scan_all(@unquoted_value)
  return nil unless value

  @unquoted_column_value = true
  if @first_column_separators
    while true
      @scanner.keep_start
      is_column_end = @column_ends.all? do |column_end|
        @scanner.scan(column_end)
      end
      @scanner.keep_back
      break if is_column_end
      sub_separator = @scanner.scan_all(@first_column_separators)
      break if sub_separator.nil?
      value &lt;&lt; sub_separator
      sub_value = @scanner.scan_all(@unquoted_value)
      break if sub_value.nil?
      value &lt;&lt; sub_value
    end
  end
  value.gsub!(@backslash_quote_character, @quote_character) if @backslash_quote
  if @rstrip_value
    value.gsub!(@rstrip_value, "")
  end
  value
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-prepare"> <span class="method-name">prepare</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="prepare-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 437
def prepare
  prepare_variable
  prepare_quote_character
  prepare_backslash
  prepare_skip_lines
  prepare_strip
  prepare_separators
  validate_strip_and_col_sep_options
  prepare_quoted
  prepare_unquoted
  prepare_line
  prepare_header
  prepare_parser
end</pre> </div> <p>A set of tasks to prepare the file in order to parse it</p>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-prepare_backslash"> <span class="method-name">prepare_backslash</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="prepare_backslash-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 494
def prepare_backslash
  return unless @backslash_quote

  @backslash_character = "\\".encode(@encoding)

  @escaped_backslash_character = Regexp.escape(@backslash_character)
  @escaped_backslash = Regexp.new(@escaped_backslash_character)
  if @quote_character.nil?
    @backslash_quote_character = nil
  else
    @backslash_quote_character =
      @backslash_character + @escaped_quote_character
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-prepare_header"> <span class="method-name">prepare_header</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="prepare_header-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 754
def prepare_header
  @return_headers = @options[:return_headers]

  headers = @options[:headers]
  case headers
  when Array
    @raw_headers = headers
    quoted_fields = [false] * @raw_headers.size
    @use_headers = true
  when String
    @raw_headers, quoted_fields = parse_headers(headers)
    @use_headers = true
  when nil, false
    @raw_headers = nil
    @use_headers = false
  else
    @raw_headers = nil
    @use_headers = true
  end
  if @raw_headers
    @headers = adjust_headers(@raw_headers, quoted_fields)
  else
    @headers = nil
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-prepare_line"> <span class="method-name">prepare_line</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="prepare_line-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 740
def prepare_line
  @lineno = 0
  @last_line = nil
  @scanner = nil
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-prepare_parser"> <span class="method-name">prepare_parser</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="prepare_parser-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 800
def prepare_parser
  @may_quoted = may_quoted?
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-prepare_quote_character"> <span class="method-name">prepare_quote_character</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="prepare_quote_character-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 478
def prepare_quote_character
  @quote_character = @options[:quote_character]
  if @quote_character.nil?
    @escaped_quote_character = nil
    @escaped_quote = nil
  else
    @quote_character = @quote_character.to_s.encode(@encoding)
    if @quote_character.length != 1
      message = ":quote_char has to be nil or a single character String"
      raise ArgumentError, message
    end
    @escaped_quote_character = Regexp.escape(@quote_character)
    @escaped_quote = Regexp.new(@escaped_quote_character)
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-prepare_quoted"> <span class="method-name">prepare_quoted</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="prepare_quoted-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 636
def prepare_quoted
  if @quote_character
    @quotes = Regexp.new(@escaped_quote_character +
                         "+".encode(@encoding))
    no_quoted_values = @escaped_quote_character.dup
    if @backslash_quote
      no_quoted_values &lt;&lt; @escaped_backslash_character
    end
    @quoted_value = Regexp.new("[^".encode(@encoding) +
                               no_quoted_values +
                               "]+".encode(@encoding))
  end
  if @escaped_strip
    @split_column_separator = Regexp.new(@escaped_strip +
                                         "*".encode(@encoding) +
                                         @escaped_column_separator +
                                         @escaped_strip +
                                         "*".encode(@encoding))
  else
    if @column_separator == " ".encode(@encoding)
      @split_column_separator = Regexp.new(@escaped_column_separator)
    else
      @split_column_separator = @column_separator
    end
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-prepare_separators"> <span class="method-name">prepare_separators</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="prepare_separators-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 568
def prepare_separators
  column_separator = @options[:column_separator]
  @column_separator = column_separator.to_s.encode(@encoding)
  if @column_separator.size &lt; 1
    message = ":col_sep must be 1 or more characters: "
    message += column_separator.inspect
    raise ArgumentError, message
  end
  @row_separator =
    resolve_row_separator(@options[:row_separator]).encode(@encoding)

  @escaped_column_separator = Regexp.escape(@column_separator)
  @escaped_first_column_separator = Regexp.escape(@column_separator[0])
  if @column_separator.size &gt; 1
    @column_end = Regexp.new(@escaped_column_separator)
    @column_ends = @column_separator.each_char.collect do |char|
      Regexp.new(Regexp.escape(char))
    end
    @first_column_separators = Regexp.new(@escaped_first_column_separator +
                                          "+".encode(@encoding))
  else
    if STRING_SCANNER_SCAN_ACCEPT_STRING
      @column_end = @column_separator
    else
      @column_end = Regexp.new(@escaped_column_separator)
    end
    @column_ends = nil
    @first_column_separators = nil
  end

  escaped_row_separator = Regexp.escape(@row_separator)
  @row_end = Regexp.new(escaped_row_separator)
  if @row_separator.size &gt; 1
    @row_ends = @row_separator.each_char.collect do |char|
      Regexp.new(Regexp.escape(char))
    end
  else
    @row_ends = nil
  end

  @cr = "\r".encode(@encoding)
  @lf = "\n".encode(@encoding)
  @line_end = Regexp.new("\r\n|\n|\r".encode(@encoding))
  @not_line_end = Regexp.new("[^\r\n]+".encode(@encoding))
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-prepare_skip_lines"> <span class="method-name">prepare_skip_lines</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="prepare_skip_lines-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 509
def prepare_skip_lines
  skip_lines = @options[:skip_lines]
  case skip_lines
  when String
    @skip_lines = skip_lines.encode(@encoding)
  when Regexp, nil
    @skip_lines = skip_lines
  else
    unless skip_lines.respond_to?(:match)
      message =
        ":skip_lines has to respond to \#match: #{skip_lines.inspect}"
      raise ArgumentError, message
    end
    @skip_lines = skip_lines
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-prepare_strip"> <span class="method-name">prepare_strip</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="prepare_strip-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 526
def prepare_strip
  @strip = @options[:strip]
  @escaped_strip = nil
  @strip_value = nil
  @rstrip_value = nil
  if @strip.is_a?(String)
    case @strip.length
    when 0
      raise ArgumentError, ":strip must not be an empty String"
    when 1
      # ok
    else
      raise ArgumentError, ":strip doesn't support 2 or more characters yet"
    end
    @strip = @strip.encode(@encoding)
    @escaped_strip = Regexp.escape(@strip)
    if @quote_character
      @strip_value = Regexp.new(@escaped_strip +
                                "+".encode(@encoding))
      @rstrip_value = Regexp.new(@escaped_strip +
                                 "+\\z".encode(@encoding))
    end
    @need_robust_parsing = true
  elsif @strip
    strip_values = " \t\f\v"
    @escaped_strip = strip_values.encode(@encoding)
    if @quote_character
      @strip_value = Regexp.new("[#{strip_values}]+".encode(@encoding))
      @rstrip_value = Regexp.new("[#{strip_values}]+\\z".encode(@encoding))
    end
    @need_robust_parsing = true
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-prepare_unquoted"> <span class="method-name">prepare_unquoted</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="prepare_unquoted-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 663
def prepare_unquoted
  return if @quote_character.nil?

  no_unquoted_values = "\r\n".encode(@encoding)
  no_unquoted_values &lt;&lt; @escaped_first_column_separator
  unless @liberal_parsing
    no_unquoted_values &lt;&lt; @escaped_quote_character
  end
  @unquoted_value = Regexp.new("[^".encode(@encoding) +
                               no_unquoted_values +
                               "]+".encode(@encoding))
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-prepare_variable"> <span class="method-name">prepare_variable</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="prepare_variable-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 452
def prepare_variable
  @need_robust_parsing = false
  @encoding = @options[:encoding]
  liberal_parsing = @options[:liberal_parsing]
  if liberal_parsing
    @liberal_parsing = true
    if liberal_parsing.is_a?(Hash)
      @double_quote_outside_quote =
        liberal_parsing[:double_quote_outside_quote]
      @backslash_quote = liberal_parsing[:backslash_quote]
    else
      @double_quote_outside_quote = false
      @backslash_quote = false
    end
    @need_robust_parsing = true
  else
    @liberal_parsing = false
    @backslash_quote = false
  end
  @unconverted_fields = @options[:unconverted_fields]
  @max_field_size = @options[:max_field_size]
  @skip_blanks = @options[:skip_blanks]
  @fields_converter = @options[:fields_converter]
  @header_fields_converter = @options[:header_fields_converter]
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-resolve_row_separator"> <span class="method-name">resolve_row_separator</span><span class="method-args">(separator)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="resolve_row_separator-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 676
def resolve_row_separator(separator)
  if separator == :auto
    cr = "\r".encode(@encoding)
    lf = "\n".encode(@encoding)
    if @input.is_a?(StringIO)
      pos = @input.pos
      separator = detect_row_separator(@input.read, cr, lf)
      @input.seek(pos)
    elsif @input.respond_to?(:gets)
      if @input.is_a?(File)
        chunk_size = 32 * 1024
      else
        chunk_size = 1024
      end
      begin
        while separator == :auto
          #
          # if we run out of data, it's probably a single line
          # (ensure will set default value)
          #
          break unless sample = @input.gets(nil, chunk_size)

          # extend sample if we're unsure of the line ending
          if sample.end_with?(cr)
            sample &lt;&lt; (@input.gets(nil, 1) || "")
          end

          @samples &lt;&lt; sample

          separator = detect_row_separator(sample, cr, lf)
        end
      rescue IOError
        # do nothing:  ensure will set default
      end
    end
    separator = InputRecordSeparator.value if separator == :auto
  end
  separator.to_s.encode(@encoding)
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-skip_line-3F"> <span class="method-name">skip_line?</span><span class="method-args">(line)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="skip_line-3F-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 909
def skip_line?(line)
  line = line.delete_suffix(@row_separator)
  case @skip_lines
  when String
    line.include?(@skip_lines)
  when Regexp
    @skip_lines.match?(line)
  else
    @skip_lines.match(line)
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-skip_needless_lines"> <span class="method-name">skip_needless_lines</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="skip_needless_lines-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 892
def skip_needless_lines
  return unless @skip_lines

  until @scanner.eos?
    @scanner.keep_start
    line = @scanner.scan_all(@not_line_end) || "".encode(@encoding)
    line &lt;&lt; @row_separator if parse_row_end
    if skip_line?(line)
      @lineno += 1
      @scanner.keep_drop
    else
      @scanner.keep_back
      return
    end
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-start_row"> <span class="method-name">start_row</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="start_row-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 1242
def start_row
  if @last_line
    @last_line = nil
  else
    @scanner.keep_drop
  end
  @scanner.keep_start
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-strip_value"> <span class="method-name">strip_value</span><span class="method-args">(value)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="strip_value-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 1218
def strip_value(value)
  return value unless @strip
  return value if value.nil?

  case @strip
  when String
    while value.delete_prefix!(@strip)
      # do nothing
    end
    while value.delete_suffix!(@strip)
      # do nothing
    end
  else
    value.strip!
  end
  value
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-validate_field_size"> <span class="method-name">validate_field_size</span><span class="method-args">(field)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="validate_field_size-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 921
def validate_field_size(field)
  return unless @max_field_size
  return if field.size &lt;= @max_field_size
  ignore_broken_line
  message = "Field size exceeded: #{field.size} &gt; #{@max_field_size}"
  raise MalformedCSVError.new(message, @lineno)
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-validate_strip_and_col_sep_options"> <span class="method-name">validate_strip_and_col_sep_options</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="validate_strip_and_col_sep_options-source"> <pre class="ruby" data-language="ruby"># File lib/csv/parser.rb, line 618
def validate_strip_and_col_sep_options
  return unless @strip

  if @strip.is_a?(String)
    if @column_separator.start_with?(@strip) || @column_separator.end_with?(@strip)
      raise ArgumentError,
            "The provided strip (#{@escaped_strip}) and " \
            "col_sep (#{@escaped_column_separator}) options are incompatible."
    end
  else
    if Regexp.new("\\A[#{@escaped_strip}]|[#{@escaped_strip}]\\z").match?(@column_separator)
      raise ArgumentError,
            "The provided strip (true) and " \
            "col_sep (#{@escaped_column_separator}) options are incompatible."
    end
  end
end</pre> </div> <p>This method verifies that there are no (obvious) ambiguities with the provided <code>col_sep</code> and <code>strip</code> parsing options. For example, if <code>col_sep</code> and <code>strip</code> were both equal to <code>\t</code>, then there would be no clear way to parse the input.</p>  </div> </div> </section> </section><div class="_attribution">
  <p class="_attribution-p">
    Ruby Core &copy; 1993&ndash;2022 Yukihiro Matsumoto<br>Licensed under the Ruby License.<br>Ruby Standard Library &copy; contributors<br>Licensed under their own licenses.<br>
    
  </p>
</div>
