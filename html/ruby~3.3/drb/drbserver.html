<h1 id="class-DRb::DRbServer" class="class"> class DRb::DRbServer </h1>
<dl class="meta">
<dt>Parent:</dt>
<dd class="meta-parent"><a href="../object.html">Object</a></dd>
</dl> <section class="description"> <p><a href="../class.html"><code>Class</code></a> representing a drb server instance.</p> <p>A DRbServer must be running in the local process before any incoming dRuby calls can be accepted, or any local objects can be passed as dRuby references to remote processes, even if those local objects are never actually called remotely. You do not need to start a DRbServer in the local process if you are only making outgoing dRuby calls passing marshalled parameters.</p> <p>Unless multiple servers are being used, the local DRbServer is normally started by calling <a href="../drb.html#method-c-start_service"><code>DRb.start_service</code></a>.</p> </section> <section id="5Buntitled-5D" class="documentation-section"> <section class="constants-list"> <header> <h3>Constants</h3> </header> <dl> <dt id="INSECURE_METHOD">INSECURE_METHOD </dt>
<dd>
<p>List of insecure methods.</p> <p>These methods are not callable via dRuby.</p> </dd>
</dl> </section> <section class="attribute-method-details"> <header> <h3>Attributes</h3> </header> <div class="method-detail"> <div class="method-heading attribute-method-heading" id="attribute-i-config"> <span class="method-name">config</span><span class="attribute-access-type">[R]</span> </div> <div class="method-description"> <p>The configuration of this DRbServer</p> </div> </div> <div class="method-detail"> <div class="method-heading attribute-method-heading" id="attribute-i-front"> <span class="method-name">front</span><span class="attribute-access-type">[R]</span> </div> <div class="method-description"> <p>The front object of the DRbServer.</p> <p>This object receives remote method calls made on the server’s <a href="../uri.html"><code>URI</code></a> alone, with an object id.</p> </div> </div> <div class="method-detail"> <div class="method-heading attribute-method-heading" id="attribute-i-thread"> <span class="method-name">thread</span><span class="attribute-access-type">[R]</span> </div> <div class="method-description"> <p>The main thread of this DRbServer.</p> <p>This is the thread that listens for and accepts connections from clients, not that handles each client’s request-response session.</p> </div> </div> <div class="method-detail"> <div class="method-heading attribute-method-heading" id="attribute-i-uri"> <span class="method-name">uri</span><span class="attribute-access-type">[R]</span> </div> <div class="method-description"> <p>The <a href="../uri.html"><code>URI</code></a> of this DRbServer.</p> </div> </div> </section> <section id="public-class-5Buntitled-5D-method-details" class="method-section"> <header> <h3>Public Class Methods</h3> </header> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-c-default_acl"> <span class="method-name">default_acl</span><span class="method-args">(acl)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="default_acl-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1375
def self.default_acl(acl)
  @@acl = acl
end</pre> </div> <p><a href="../set.html"><code>Set</code></a> the default access control list to <code>acl</code>. The default <a href="../acl.html"><code>ACL</code></a> is <code>nil</code>.</p> <p>See also <a href="../acl.html"><code>DRb::ACL</code></a> and new()</p>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-c-default_argc_limit"> <span class="method-name">default_argc_limit</span><span class="method-args">(argc)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="default_argc_limit-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1361
def self.default_argc_limit(argc)
  @@argc_limit = argc
end</pre> </div> <p><a href="../set.html"><code>Set</code></a> the default value for the :argc_limit option.</p> <p>See new(). The initial default value is 256.</p>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-c-default_id_conv"> <span class="method-name">default_id_conv</span><span class="method-args">(idconv)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="default_id_conv-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1382
def self.default_id_conv(idconv)
  @@idconv = idconv
end</pre> </div> <p><a href="../set.html"><code>Set</code></a> the default value for the :id_conv option.</p> <p>See new(). The initial default value is a <a href="drbidconv.html"><code>DRbIdConv</code></a> instance.</p>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-c-default_load_limit"> <span class="method-name">default_load_limit</span><span class="method-args">(sz)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="default_load_limit-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1368
def self.default_load_limit(sz)
  @@load_limit = sz
end</pre> </div> <p><a href="../set.html"><code>Set</code></a> the default value for the :load_limit option.</p> <p>See new(). The initial default value is 25 MB.</p>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-c-new"> <span class="method-name">new</span><span class="method-args">(uri=nil, front=nil, config_or_acl=nil)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="new-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1451
def initialize(uri=nil, front=nil, config_or_acl=nil)
  if Hash === config_or_acl
    config = config_or_acl.dup
  else
    acl = config_or_acl || @@acl
    config = {
      :tcp_acl =&gt; acl
    }
  end

  @config = self.class.make_config(config)

  @protocol = DRbProtocol.open_server(uri, @config)
  @uri = @protocol.uri
  @exported_uri = [@uri]

  @front = front
  @idconv = @config[:idconv]

  @grp = ThreadGroup.new
  @thread = run

  DRb.regist_server(self)
end</pre> </div> <p>Create a new DRbServer instance.</p> <p><code>uri</code> is the <a href="../uri.html"><code>URI</code></a> to bind to. This is normally of the form ‘druby://&lt;hostname&gt;:&lt;port&gt;’ where &lt;hostname&gt; is a hostname of the local machine. If nil, then the system’s default hostname will be bound to, on a port selected by the system; these value can be retrieved from the <code>uri</code> attribute. ‘druby:’ specifies the default dRuby transport protocol: another protocol, such as ‘drbunix:’, can be specified instead.</p> <p><code>front</code> is the front object for the server, that is, the object to which remote method calls on the server will be passed. If nil, then the server will not accept remote method calls.</p> <p>If <code>config_or_acl</code> is a hash, it is the configuration to use for this server. The following options are recognised:</p> <dl class="rdoc-list note-list">
<dt>:idconv </dt>
<dd> <p>an id-to-object conversion object. This defaults to an instance of the class <a href="drbidconv.html"><code>DRb::DRbIdConv</code></a>.</p> </dd>
<dt>:verbose </dt>
<dd> <p>if true, all unsuccessful remote calls on objects in the server will be logged to $stdout. false by default.</p> </dd>
<dt>:tcp_acl </dt>
<dd> <p>the access control list for this server. See the <a href="../acl.html"><code>ACL</code></a> class from the main dRuby distribution.</p> </dd>
<dt>:load_limit </dt>
<dd> <p>the maximum message size in bytes accepted by the server. Defaults to 25 MB (26214400).</p> </dd>
<dt>:argc_limit </dt>
<dd> <p>the maximum number of arguments to a remote method accepted by the server. Defaults to 256.</p> </dd>
</dl> <p>The default values of these options can be modified on a class-wide basis by the class methods default_argc_limit, default_load_limit, default_acl, default_id_conv, and <a href="drbserver.html#method-i-verbose-3D"><code>verbose=</code></a></p> <p>If <code>config_or_acl</code> is not a hash, but is not nil, it is assumed to be the access control list for this server. See the :tcp_acl option for more details.</p> <p>If no other server is currently set as the primary server, this will become the primary server.</p> <p>The server will immediately start running in its own thread.</p>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-c-verbose"> <span class="method-name">verbose</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="verbose-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1394
def self.verbose
  @@verbose
end</pre> </div> <p>Get the default value of the :verbose option.</p>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-c-verbose-3D"> <span class="method-name">verbose=</span><span class="method-args">(on)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="verbose-3D-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1389
def self.verbose=(on)
  @@verbose = on
end</pre> </div> <p><a href="../set.html"><code>Set</code></a> the default value of the :verbose option.</p> <p>See new(). The initial default value is false.</p>  </div> </div> </section> <section id="public-instance-5Buntitled-5D-method-details" class="method-section"> <header> <h3>Public Instance Methods</h3> </header> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-alive-3F"> <span class="method-name">alive?</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="alive-3F-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1506
def alive?
  @thread.alive?
end</pre> </div> <p>Is this server alive?</p>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-check_insecure_method"> <span class="method-name">check_insecure_method</span><span class="method-args">(obj, msg_id)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="check_insecure_method-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1594
def check_insecure_method(obj, msg_id)
  return true if Proc === obj &amp;&amp; msg_id == :__drb_yield
  raise(ArgumentError, "#{any_to_s(msg_id)} is not a symbol") unless Symbol == msg_id.class
  raise(SecurityError, "insecure method `#{msg_id}'") if insecure_method?(msg_id)

  case obj
  when Object
    if obj.private_methods.include?(msg_id)
      desc = any_to_s(obj)
      raise NoMethodError, "private method `#{msg_id}' called for #{desc}"
    elsif obj.protected_methods.include?(msg_id)
      desc = any_to_s(obj)
      raise NoMethodError, "protected method `#{msg_id}' called for #{desc}"
    else
      true
    end
  else
    if Kernel.instance_method(:private_methods).bind(obj).call.include?(msg_id)
      desc = any_to_s(obj)
      raise NoMethodError, "private method `#{msg_id}' called for #{desc}"
    elsif Kernel.instance_method(:protected_methods).bind(obj).call.include?(msg_id)
      desc = any_to_s(obj)
      raise NoMethodError, "protected method `#{msg_id}' called for #{desc}"
    else
      true
    end
  end
end</pre> </div> <p>Check that a method is callable via dRuby.</p> <p><code>obj</code> is the object we want to invoke the method on. <code>msg_id</code> is the method name, as a <a href="../symbol.html"><code>Symbol</code></a>.</p> <p>If the method is an insecure method (see <a href="drbserver.html#method-i-insecure_method-3F"><code>insecure_method?</code></a>) a <a href="../securityerror.html"><code>SecurityError</code></a> is thrown. If the method is private or undefined, a <a href="../nameerror.html"><code>NameError</code></a> is thrown.</p>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-here-3F"> <span class="method-name">here?</span><span class="method-args">(uri)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="here-3F-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1511
def here?(uri)
  @exported_uri.include?(uri)
end</pre> </div> <p>Is <code>uri</code> the <a href="../uri.html"><code>URI</code></a> for this server?</p>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-stop_service"> <span class="method-name">stop_service</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="stop_service-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1516
def stop_service
  DRb.remove_server(self)
  if  Thread.current['DRb'] &amp;&amp; Thread.current['DRb']['server'] == self
    Thread.current['DRb']['stop_service'] = true
  else
    shutdown
  end
end</pre> </div> <p>Stop this server.</p>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-to_id"> <span class="method-name">to_id</span><span class="method-args">(obj)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="to_id-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1533
def to_id(obj)
  return nil if obj.__id__ == front.__id__
  @idconv.to_id(obj)
end</pre> </div> <p>Convert a local object to a dRuby reference.</p>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-to_obj"> <span class="method-name">to_obj</span><span class="method-args">(ref)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="to_obj-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1526
def to_obj(ref)
  return front if ref.nil?
  return front[ref.to_s] if DRbURIOption === ref
  @idconv.to_obj(ref)
end</pre> </div> <p>Convert a dRuby reference to the local object it refers to.</p>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-verbose"> <span class="method-name">verbose</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="verbose-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1503
def verbose; @config[:verbose]; end</pre> </div> <p>Get whether the server is in verbose mode.</p> <p>In verbose mode, failed calls are logged to stdout.</p>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-verbose-3D"> <span class="method-name">verbose=</span><span class="method-args">(v)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="verbose-3D-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1498
def verbose=(v); @config[:verbose]=v; end</pre> </div> <p><a href="../set.html"><code>Set</code></a> whether to operate in verbose mode.</p> <p>In verbose mode, failed calls are logged to stdout.</p>  </div> </div> </section> <section id="private-instance-5Buntitled-5D-method-details" class="method-section"> <header> <h3>Private Instance Methods</h3> </header> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-any_to_s"> <span class="method-name">any_to_s</span><span class="method-args">(obj)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="any_to_s-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1580
def any_to_s(obj)
  "#{obj}:#{obj.class}"
rescue
  Kernel.instance_method(:to_s).bind_call(obj)
end</pre> </div> <p>Coerce an object to a string, providing our own representation if to_s is not defined for the object.</p>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-error_print"> <span class="method-name">error_print</span><span class="method-args">(exception)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="error_print-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1696
def error_print(exception)
  exception.backtrace.inject(true) do |first, x|
    if first
      $stderr.puts "#{x}: #{exception} (#{exception.class})"
    else
      $stderr.puts "\tfrom #{x}"
    end
    false
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-insecure_method-3F"> <span class="method-name">insecure_method?</span><span class="method-args">(msg_id)</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="insecure_method-3F-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1574
def insecure_method?(msg_id)
  INSECURE_METHOD.include?(msg_id)
end</pre> </div> <p>Has a method been included in the list of insecure methods?</p>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-main_loop"> <span class="method-name">main_loop</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="main_loop-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1714
def main_loop
  client0 = @protocol.accept
  return nil if !client0
  Thread.start(client0) do |client|
    @grp.add Thread.current
    Thread.current['DRb'] = { 'client' =&gt; client ,
                              'server' =&gt; self }
    DRb.mutex.synchronize do
      client_uri = client.uri
      @exported_uri &lt;&lt; client_uri unless @exported_uri.include?(client_uri)
    end
    _last_invoke_method = nil
    loop do
      begin
        succ = false
        invoke_method = InvokeMethod.new(self, client)
        succ, result = invoke_method.perform
        error_print(result) if !succ &amp;&amp; verbose
        unless DRbConnError === result &amp;&amp; result.message == 'connection closed'
          client.send_reply(succ, result)
        end
      rescue Exception =&gt; e
        error_print(e) if verbose
      ensure
        _last_invoke_method = invoke_method
        client.close unless succ
        if Thread.current['DRb']['stop_service']
          shutdown
          break
        end
        break unless succ
      end
    end
  end
end</pre> </div> <p>The main loop performed by a DRbServer’s internal thread.</p> <p>Accepts a connection from a client, and starts up its own thread to handle it. This thread loops, receiving requests from the client, invoking them on a local object, and returning responses, until the client closes the connection or a local method call fails.</p>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-run"> <span class="method-name">run</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="run-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1555
def run
  Thread.start do
    begin
      while main_loop
      end
    ensure
      @protocol.close if @protocol
    end
  end
end</pre> </div> <p>Starts the <a href="../drb.html"><code>DRb</code></a> main loop in a new thread.</p>  </div> </div> <div class="method-detail "> <div class="method-header"> <div class="method-heading" id="method-i-shutdown"> <span class="method-name">shutdown</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> </div> <div class="method-description">
<div class="method-source-code" id="shutdown-source"> <pre class="ruby" data-language="ruby"># File lib/drb/drb.rb, line 1540
def shutdown
  current = Thread.current
  if @protocol.respond_to? :shutdown
    @protocol.shutdown
  else
    [@thread, *@grp.list].each { |thread|
      thread.kill unless thread == current # xxx: Thread#kill
    }
  end
  @thread.join unless @thread == current
end</pre> </div>  </div> </div> </section> </section><div class="_attribution">
  <p class="_attribution-p">
    Ruby Core &copy; 1993&ndash;2022 Yukihiro Matsumoto<br>Licensed under the Ruby License.<br>Ruby Standard Library &copy; contributors<br>Licensed under their own licenses.<br>
    
  </p>
</div>
