<h1>salt.proxy.vcenter</h1> <p>Proxy Minion interface module for managing VMWare vCenters.</p> <dl class="field-list simple"> <dt class="field-odd">codeauthor</dt> <dd class="field-odd">
<p><cite>Rod McKenzie (roderick.mckenzie@morganstanley.com)</cite></p> </dd> <dt class="field-even">codeauthor</dt> <dd class="field-even">
<p><cite>Alexandru Bleotu (alexandru.bleotu@morganstanley.com)</cite></p> </dd> </dl> <div class="section" id="dependencies"> <h2>Dependencies</h2> <ul class="simple"> <li><p>pyVmomi Python Module</p></li> </ul> <div class="section" id="pyvmomi"> <h3>pyVmomi</h3> <p>PyVmomi can be installed via pip:</p> <pre class="highlight-bash notranslate" data-language="bash">pip install pyVmomi</pre> <div class="admonition note"> <p class="admonition-title">Note</p> <p>Version 6.0 of pyVmomi has some problems with SSL error handling on certain versions of Python. If using version 6.0 of pyVmomi, Python 2.6, Python 2.7.9, or newer must be present. This is due to an upstream dependency in pyVmomi 6.0 that is not supported in Python versions 2.7 to 2.7.8. If the version of Python is not in the supported range, you will need to install an earlier version of pyVmomi. See <a class="reference external" href="https://github.com/saltstack/salt/issues/29537">Issue #29537</a> for more information.</p> </div> <p>Based on the note above, to install an earlier version of pyVmomi than the version currently listed in PyPi, run the following:</p> <pre class="highlight-bash notranslate" data-language="bash">pip install pyVmomi==5.5.0.2014.1.1</pre> <p>The 5.5.0.2014.1.1 is a known stable version that this original ESXi State Module was developed against.</p> </div> </div> <div class="section" id="configuration"> <h2>Configuration</h2> <p>To use this proxy module, please use on of the following configurations:</p> <pre class="highlight-yaml notranslate" data-language="yaml">proxy:
  proxytype: vcenter
  vcenter: &lt;ip or dns name of parent vcenter&gt;
  username: &lt;vCenter username&gt;
  mechanism: userpass
  passwords:
    - first_password
    - second_password
    - third_password

proxy:
  proxytype: vcenter
  vcenter: &lt;ip or dns name of parent vcenter&gt;
  username: &lt;vCenter username&gt;
  domain: &lt;user domain&gt;
  mechanism: sspi
  principal: &lt;host kerberos principal&gt;</pre> <div class="section" id="proxytype"> <h3>proxytype</h3> <p>The <code class="docutils literal notranslate"><span class="pre">proxytype</span></code> key and value pair is critical, as it tells Salt which interface to load from the <code class="docutils literal notranslate"><span class="pre">proxy</span></code> directory in Salt's install hierarchy, or from <code class="docutils literal notranslate"><span class="pre">/srv/salt/_proxy</span></code> on the Salt Master (if you have created your own proxy module, for example). To use this Proxy Module, set this to <code class="docutils literal notranslate"><span class="pre">vcenter</span></code>.</p> </div> <div class="section" id="vcenter"> <h3>vcenter</h3> <p>The location of the VMware vCenter server (host of ip). Required</p> </div> <div class="section" id="username"> <h3>username</h3> <p>The username used to login to the vcenter, such as <code class="docutils literal notranslate"><span class="pre">root</span></code>. Required only for userpass.</p> </div> <div class="section" id="mechanism"> <h3>mechanism</h3> <p>The mechanism used to connect to the vCenter server. Supported values are <code class="docutils literal notranslate"><span class="pre">userpass</span></code> and <code class="docutils literal notranslate"><span class="pre">sspi</span></code>. Required.</p> </div> <div class="section" id="passwords"> <h3>passwords</h3> <p>A list of passwords to be used to try and login to the vCenter server. At least one password in this list is required if mechanism is <code class="docutils literal notranslate"><span class="pre">userpass</span></code></p> <p>The proxy integration will try the passwords listed in order.</p> </div> <div class="section" id="domain"> <h3>domain</h3> <p>User domain. Required if mechanism is <code class="docutils literal notranslate"><span class="pre">sspi</span></code></p> </div> <div class="section" id="principal"> <h3>principal</h3> <p>Kerberos principal. Rquired if mechanism is <code class="docutils literal notranslate"><span class="pre">sspi</span></code></p> </div> <div class="section" id="protocol"> <h3>protocol</h3> <p>If the vCenter is not using the default protocol, set this value to an alternate protocol. Default is <code class="docutils literal notranslate"><span class="pre">https</span></code>.</p> </div> <div class="section" id="port"> <h3>port</h3> <p>If the ESXi host is not using the default port, set this value to an alternate port. Default is <code class="docutils literal notranslate"><span class="pre">443</span></code>.</p> </div> </div> <div class="section" id="salt-proxy"> <h2>Salt Proxy</h2> <p>After your pillar is in place, you can test the proxy. The proxy can run on any machine that has network connectivity to your Salt Master and to the vCenter server in the pillar. SaltStack recommends that the machine running the salt-proxy process also run a regular minion, though it is not strictly necessary.</p> <p>On the machine that will run the proxy, make sure there is an <code class="docutils literal notranslate"><span class="pre">/etc/salt/proxy</span></code> file with at least the following in it:</p> <pre class="highlight-yaml notranslate" data-language="yaml">master: &lt;ip or hostname of salt-master&gt;</pre> <p>You can then start the salt-proxy process with:</p> <pre class="highlight-bash notranslate" data-language="bash">salt-proxy --proxyid &lt;id of the cluster&gt;</pre> <p>You may want to add <code class="docutils literal notranslate"><span class="pre">-l</span> <span class="pre">debug</span></code> to run the above in the foreground in debug mode just to make sure everything is OK.</p> <p>Next, accept the key for the proxy on your salt-master, just like you would for a regular minion:</p> <pre class="highlight-bash notranslate" data-language="bash">salt-key -a &lt;id you gave the vcenter host&gt;</pre> <p>You can confirm that the pillar data is in place for the proxy:</p> <pre class="highlight-bash notranslate" data-language="bash">salt &lt;id&gt; pillar.items</pre> <p>And now you should be able to ping the ESXi host to make sure it is responding:</p> <pre class="highlight-bash notranslate" data-language="bash">salt &lt;id&gt; test.ping</pre> <p>At this point you can execute one-off commands against the vcenter. For example, you can get if the proxy can actually connect to the vCenter:</p> <pre class="highlight-bash notranslate" data-language="bash">salt &lt;id&gt; vsphere.test_vcenter_connection</pre> <p>Note that you don't need to provide credentials or an ip/hostname. Salt knows to use the credentials you stored in Pillar.</p> <p>It's important to understand how this particular proxy works. <code class="xref py py-mod docutils literal notranslate"><span class="pre">Salt.modules.vsphere</span></code> is a standard Salt execution module.</p> <p>If you pull up the docs for it you'll see that almost every function in the module takes credentials and a targets either a vcenter or a host. When credentials and a host aren't passed, Salt runs commands through <code class="docutils literal notranslate"><span class="pre">pyVmomi</span></code> against the local machine. If you wanted, you could run functions from this module on any host where an appropriate version of <code class="docutils literal notranslate"><span class="pre">pyVmomi</span></code> is installed, and that host would reach out over the network and communicate with the ESXi host.</p> <dl class="py function"> <h3 id="salt.proxy.vcenter.find_credentials"> salt.proxy.vcenter.find_credentials()</h3> <dd>
<p>Cycle through all the possible credentials and return the first one that works.</p> </dd>
</dl> <dl class="py function"> <h3 id="salt.proxy.vcenter.get_details"> salt.proxy.vcenter.get_details()</h3> <dd>
<p>Function that returns the cached details</p> </dd>
</dl> <dl class="py function"> <h3 id="salt.proxy.vcenter.init"> salt.proxy.vcenter.init(opts)</h3> <dd>
<p>This function gets called when the proxy starts up. For login the protocol and port are cached.</p> </dd>
</dl> <dl class="py function"> <h3 id="salt.proxy.vcenter.ping"> salt.proxy.vcenter.ping()</h3> <dd>
<p>Returns True.</p> <p>CLI Example:</p> <pre class="highlight-bash notranslate" data-language="bash">salt vcenter test.ping</pre> </dd>
</dl> <dl class="py function"> <h3 id="salt.proxy.vcenter.shutdown"> salt.proxy.vcenter.shutdown()</h3> <dd>
<p>Shutdown the connection to the proxy device. For this proxy, shutdown is a no-op.</p> </dd>
</dl> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2021 SaltStack.<br>Licensed under the Apache License, Version 2.0.<br>
    <a href="https://docs.saltproject.io/en/latest/ref/proxy/all/salt.proxy.vcenter.html" class="_attribution-link">https://docs.saltproject.io/en/latest/ref/proxy/all/salt.proxy.vcenter.html</a>
  </p>
</div>
