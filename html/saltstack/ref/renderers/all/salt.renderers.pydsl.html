<h1>salt.renderers.pydsl</h1> <p>A Python-based DSL</p> <dl class="field-list simple"> <dt class="field-odd">maintainer</dt> <dd class="field-odd">
<p>Jack Kuan &lt;<a class="reference external" href="mailto:kjkuan%40gmail.com.html">kjkuan<span>@</span>gmail<span>.</span>com</a>&gt;</p> </dd> <dt class="field-even">maturity</dt> <dd class="field-even">
<p>new</p> </dd> <dt class="field-odd">platform</dt> <dd class="field-odd">
<p>all</p> </dd> </dl> <p>The <cite>pydsl</cite> renderer allows one to author salt formulas (.sls files) in pure Python using a DSL that's easy to write and easy to read. Here's an example:</p> <pre class="highlight-python notranslate" data-language="python">1
2
3
4
5
6
7
8
9#!pydsl

apache = state('apache')
apache.pkg.installed()
apache.service.running()
state('/var/www/index.html') \
    .file('managed',
          source='salt://webserver/index.html') \
    .require(pkg='apache')</pre> <p>Notice that any Python code is allow in the file as it's really a Python module, so you have the full power of Python at your disposal. In this module, a few objects are defined for you, including the usual (with <code class="docutils literal notranslate"><span class="pre">__</span></code> added) <code class="docutils literal notranslate"><span class="pre">__salt__</span></code> dictionary, <code class="docutils literal notranslate"><span class="pre">__grains__</span></code>, <code class="docutils literal notranslate"><span class="pre">__pillar__</span></code>, <code class="docutils literal notranslate"><span class="pre">__opts__</span></code>, <code class="docutils literal notranslate"><span class="pre">__env__</span></code>, and <code class="docutils literal notranslate"><span class="pre">__sls__</span></code>, plus a few more:</p> <blockquote> <div>
<p><code class="docutils literal notranslate"><span class="pre">__file__</span></code></p> <blockquote> <div>
<p>local file system path to the sls module.</p> </div>
</blockquote> <p><code class="docutils literal notranslate"><span class="pre">__pydsl__</span></code></p> <blockquote> <div>
<p>Salt PyDSL object, useful for configuring DSL behavior per sls rendering.</p> </div>
</blockquote> <p><code class="docutils literal notranslate"><span class="pre">include</span></code></p> <blockquote> <div>
<p>Salt PyDSL function for creating <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#include-declaration"><span class="std std-ref">Include declaration</span></a>'s.</p> </div>
</blockquote> <p><code class="docutils literal notranslate"><span class="pre">extend</span></code></p> <blockquote> <div>
<p>Salt PyDSL function for creating <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#extend-declaration"><span class="std std-ref">Extend declaration</span></a>'s.</p> </div>
</blockquote> <p><code class="docutils literal notranslate"><span class="pre">state</span></code></p> <blockquote> <div>
<p>Salt PyDSL function for creating <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#id-declaration"><span class="std std-ref">ID declaration</span></a>'s.</p> </div>
</blockquote> </div>
</blockquote> <p>A state <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#id-declaration"><span class="std std-ref">ID declaration</span></a> is created with a <code class="docutils literal notranslate"><span class="pre">state(id)</span></code> function call. Subsequent <code class="docutils literal notranslate"><span class="pre">state(id)</span></code> call with the same id returns the same object. This singleton access pattern applies to all declaration objects created with the DSL.</p> <pre class="highlight-python notranslate" data-language="python">state('example')
assert state('example') is state('example')
assert state('example').cmd is state('example').cmd
assert state('example').cmd.running is state('example').cmd.running</pre> <p>The <cite>id</cite> argument is optional. If omitted, an UUID will be generated and used as the <cite>id</cite>.</p> <p><code class="docutils literal notranslate"><span class="pre">state(id)</span></code> returns an object under which you can create a <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#state-declaration"><span class="std std-ref">State declaration</span></a> object by accessing an attribute named after <em>any</em> state module available in Salt.</p> <pre class="highlight-python notranslate" data-language="python">state('example').cmd
state('example').file
state('example').pkg
...</pre> <p>Then, a <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#function-declaration"><span class="std std-ref">Function declaration</span></a> object can be created from a <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#state-declaration"><span class="std std-ref">State declaration</span></a> object by one of the following two ways:</p> <ol class="arabic simple"> <li><p>by calling a method named after the state function on the <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#state-declaration"><span class="std std-ref">State declaration</span></a> object.</p></li> </ol> <pre class="highlight-python notranslate" data-language="python">state('example').file.managed(...)</pre> <ol class="arabic simple" start="2"> <li><p>by directly calling the attribute named for the <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#state-declaration"><span class="std std-ref">State declaration</span></a>, and supplying the state function name as the first argument.</p></li> </ol> <pre class="highlight-python notranslate" data-language="python">state('example').file('managed', ...)</pre> <p>With either way of creating a <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#function-declaration"><span class="std std-ref">Function declaration</span></a> object, any <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#function-arg-declaration"><span class="std std-ref">Function arg declaration</span></a>'s can be passed as keyword arguments to the call. Subsequent calls of a <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#function-declaration"><span class="std std-ref">Function declaration</span></a> will update the arg declarations.</p> <pre class="highlight-python notranslate" data-language="python">state('example').file('managed', source='salt://webserver/index.html')
state('example').file.managed(source='salt://webserver/index.html')</pre> <p>As a shortcut, the special <cite>name</cite> argument can also be passed as the first or second positional argument depending on the first or second way of calling the <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#state-declaration"><span class="std std-ref">State declaration</span></a> object. In the following two examples <cite>ls -la</cite> is the <cite>name</cite> argument.</p> <pre class="highlight-python notranslate" data-language="python">state('example').cmd.run('ls -la', cwd='/')
state('example').cmd('run', 'ls -la', cwd='/')</pre> <p>Finally, a <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#requisite-declaration"><span class="std std-ref">Requisite declaration</span></a> object with its <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#requisite-reference"><span class="std std-ref">Requisite reference</span></a>'s can be created by invoking one of the requisite methods (see <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/requisites.html#requisites"><span class="std std-ref">State Requisites</span></a>) on either a <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#function-declaration"><span class="std std-ref">Function declaration</span></a> object or a <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#state-declaration"><span class="std std-ref">State declaration</span></a> object. The return value of a requisite call is also a <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#function-declaration"><span class="std std-ref">Function declaration</span></a> object, so you can chain several requisite calls together.</p> <p>Arguments to a requisite call can be a list of <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#state-declaration"><span class="std std-ref">State declaration</span></a> objects and/or a set of keyword arguments whose names are state modules and values are IDs of <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#id-declaration"><span class="std std-ref">ID declaration</span></a>'s or names of <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#name-declaration"><span class="std std-ref">Name declaration</span></a>'s.</p> <pre class="highlight-python notranslate" data-language="python">apache2 = state('apache2')
apache2.pkg.installed()
state('libapache2-mod-wsgi').pkg.installed()

# you can call requisites on function declaration
apache2.service.running() \
               .require(apache2.pkg,
                        pkg='libapache2-mod-wsgi') \
               .watch(file='/etc/apache2/httpd.conf')

# or you can call requisites on state declaration.
# this actually creates an anonymous function declaration object
# to add the requisites.
apache2.service.require(state('libapache2-mod-wsgi').pkg,
                        pkg='apache2') \
               .watch(file='/etc/apache2/httpd.conf')

# we still need to set the name of the function declaration.
apache2.service.running()</pre> <p><a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#include-declaration"><span class="std std-ref">Include declaration</span></a> objects can be created with the <code class="docutils literal notranslate"><span class="pre">include</span></code> function, while <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#extend-declaration"><span class="std std-ref">Extend declaration</span></a> objects can be created with the <code class="docutils literal notranslate"><span class="pre">extend</span></code> function, whose arguments are just <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#function-declaration"><span class="std std-ref">Function declaration</span></a> objects.</p> <pre class="highlight-python notranslate" data-language="python">include('edit.vim', 'http.server')
extend(state('apache2').service.watch(file='/etc/httpd/httpd.conf')</pre> <p>The <code class="docutils literal notranslate"><span class="pre">include</span></code> function, by default, causes the included sls file to be rendered as soon as the <code class="docutils literal notranslate"><span class="pre">include</span></code> function is called. It returns a list of rendered module objects; sls files not rendered with the pydsl renderer return <code class="docutils literal notranslate"><span class="pre">None</span></code>'s. This behavior creates no <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#include-declaration"><span class="std std-ref">Include declaration</span></a>'s in the resulting high state data structure.</p> <pre class="highlight-python notranslate" data-language="python">import types

# including multiple sls returns a list.
_, mod = include('a-non-pydsl-sls', 'a-pydsl-sls')

assert _ is None
assert isinstance(slsmods[1], types.ModuleType)

# including a single sls returns a single object
mod = include('a-pydsl-sls')

# myfunc is a function that calls state(...) to create more states.
mod.myfunc(1, 2, "three")</pre> <p>Notice how you can define a reusable function in your pydsl sls module and then call it via the module returned by <code class="docutils literal notranslate"><span class="pre">include</span></code>.</p> <p>It's still possible to do late includes by passing the <code class="docutils literal notranslate"><span class="pre">delayed=True</span></code> keyword argument to <code class="docutils literal notranslate"><span class="pre">include</span></code>.</p> <pre class="highlight-python notranslate" data-language="python">include('edit.vim', 'http.server', delayed=True)</pre> <p>Above will just create a <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#include-declaration"><span class="std std-ref">Include declaration</span></a> in the rendered result, and such call always returns <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p> <div class="section" id="special-integration-with-the-cmd-state"> <h2>Special integration with the <cite>cmd</cite> state</h2> <p>Taking advantage of rendering a Python module, PyDSL allows you to declare a state that calls a pre-defined Python function when the state is executed.</p> <pre class="highlight-python notranslate" data-language="python">greeting = "hello world"
def helper(something, *args, **kws):
    print greeting                # hello world
    print something, args, kws    # test123 ['a', 'b', 'c'] {'x': 1, 'y': 2}

state().cmd.call(helper, "test123", 'a', 'b', 'c', x=1, y=2)</pre> <p>The <cite>cmd.call</cite> state function takes care of calling our <code class="docutils literal notranslate"><span class="pre">helper</span></code> function with the arguments we specified in the states, and translates the return value of our function into a structure expected by the state system. See <a class="reference internal" href="../../states/all/salt.states.cmd.html#salt.states.cmd.call" title="salt.states.cmd.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">salt.states.cmd.call()</span></code></a> for more information.</p> </div> <div class="section" id="implicit-ordering-of-states"> <h2>Implicit ordering of states</h2> <p>Salt states are explicitly ordered via <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#requisite-declaration"><span class="std std-ref">Requisite declaration</span></a>'s. However, with <cite>pydsl</cite> it's possible to let the renderer track the order of creation for <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#function-declaration"><span class="std std-ref">Function declaration</span></a> objects, and implicitly add <code class="docutils literal notranslate"><span class="pre">require</span></code> requisites for your states to enforce the ordering. This feature is enabled by setting the <code class="docutils literal notranslate"><span class="pre">ordered</span></code> option on <code class="docutils literal notranslate"><span class="pre">__pydsl__</span></code>.</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>this feature is only available if your minions are using Python &gt;= 2.7.</p> </div> <pre class="highlight-python notranslate" data-language="python">include('some.sls.file')

A = state('A').cmd.run(cwd='/var/tmp')
extend(A)

__pydsl__.set(ordered=True)

for i in range(10):
    i = six.text_type(i)
    state(i).cmd.run('echo '+i, cwd='/')
state('1').cmd.run('echo one')
state('2').cmd.run(name='echo two')</pre> <p>Notice that the <code class="docutils literal notranslate"><span class="pre">ordered</span></code> option needs to be set after any <code class="docutils literal notranslate"><span class="pre">extend</span></code> calls. This is to prevent <cite>pydsl</cite> from tracking the creation of a state function that's passed to an <code class="docutils literal notranslate"><span class="pre">extend</span></code> call.</p> <p>Above example should create states from <code class="docutils literal notranslate"><span class="pre">0</span></code> to <code class="docutils literal notranslate"><span class="pre">9</span></code> that will output <code class="docutils literal notranslate"><span class="pre">0</span></code>, <code class="docutils literal notranslate"><span class="pre">one</span></code>, <code class="docutils literal notranslate"><span class="pre">two</span></code>, <code class="docutils literal notranslate"><span class="pre">3</span></code>, ... <code class="docutils literal notranslate"><span class="pre">9</span></code>, in that order.</p> <p>It's important to know that <cite>pydsl</cite> tracks the <em>creations</em> of <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#function-declaration"><span class="std std-ref">Function declaration</span></a> objects, and automatically adds a <code class="docutils literal notranslate"><span class="pre">require</span></code> requisite to a <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#function-declaration"><span class="std std-ref">Function declaration</span></a> object that requires the last <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#function-declaration"><span class="std std-ref">Function declaration</span></a> object created before it in the sls file.</p> <p>This means later calls (perhaps to update the function's <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#function-arg-declaration"><span class="std std-ref">Function arg declaration</span></a>) to a previously created function declaration will not change the order.</p> </div> <div class="section" id="render-time-state-execution"> <h2>Render time state execution</h2> <p>When Salt processes a salt formula file, the file is rendered to salt's high state data representation by a renderer before the states can be executed. In the case of the <cite>pydsl</cite> renderer, the .sls file is executed as a python module as it is being rendered which makes it easy to execute a state at render time. In <cite>pydsl</cite>, executing one or more states at render time can be done by calling a configured <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#id-declaration"><span class="std std-ref">ID declaration</span></a> object.</p> <pre class="highlight-python notranslate" data-language="python">#!pydsl

s = state() # save for later invocation

# configure it
s.cmd.run('echo at render time', cwd='/')
s.file.managed('target.txt', source='salt://source.txt')

s() # execute the two states now</pre> <p>Once an <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#id-declaration"><span class="std std-ref">ID declaration</span></a> is called at render time it is detached from the sls module as if it was never defined.</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>If <cite>implicit ordering</cite> is enabled (i.e., via <code class="docutils literal notranslate"><span class="pre">__pydsl__.set(ordered=True)</span></code>) then the <em>first</em> invocation of a <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#id-declaration"><span class="std std-ref">ID declaration</span></a> object must be done before a new <a class="reference internal" href="https://docs.saltproject.io/en/latest/ref/states/highstate.html#function-declaration"><span class="std std-ref">Function declaration</span></a> is created.</p> </div> </div> <div class="section" id="integration-with-the-stateconf-renderer"> <h2>Integration with the stateconf renderer</h2> <p>The <a class="reference internal" href="salt.renderers.stateconf.html#module-salt.renderers.stateconf" title="salt.renderers.stateconf"><code class="xref py py-mod docutils literal notranslate"><span class="pre">salt.renderers.stateconf</span></code></a> renderer offers a few interesting features that can be leveraged by the <cite>pydsl</cite> renderer. In particular, when using with the <cite>pydsl</cite> renderer, we are interested in <cite>stateconf</cite>'s sls namespacing feature (via dot-prefixed id declarations), as well as, the automatic <cite>start</cite> and <cite>goal</cite> states generation.</p> <p>Now you can use <cite>pydsl</cite> with <cite>stateconf</cite> like this:</p> <pre class="highlight-python notranslate" data-language="python">#!pydsl|stateconf -ps

include('xxx', 'yyy')

# ensure that states in xxx run BEFORE states in this file.
extend(state('.start').stateconf.require(stateconf='xxx::goal'))

# ensure that states in yyy run AFTER states in this file.
extend(state('.goal').stateconf.require_in(stateconf='yyy::start'))

__pydsl__.set(ordered=True)

...</pre> <p><code class="docutils literal notranslate"><span class="pre">-s</span></code> enables the generation of a stateconf <cite>start</cite> state, and <code class="docutils literal notranslate"><span class="pre">-p</span></code> lets us pipe high state data rendered by <cite>pydsl</cite> to <cite>stateconf</cite>. This example shows that by <code class="docutils literal notranslate"><span class="pre">require</span></code>-ing or <code class="docutils literal notranslate"><span class="pre">require_in</span></code>-ing the included sls' <cite>start</cite> or <cite>goal</cite> states, it's possible to ensure that the included sls files can be made to execute before or after a state in the including sls file.</p> </div> <div class="section" id="importing-custom-python-modules"> <h2>Importing custom Python modules</h2> <p>To use a custom Python module inside a PyDSL state, place the module somewhere that it can be loaded by the Salt loader, such as <cite>_modules</cite> in the <cite>/srv/salt</cite> directory.</p> <p>Then, copy it to any minions as necessary by using <cite>saltutil.sync_modules</cite>.</p> <p>To import into a PyDSL SLS, one must bypass the Python importer and insert it manually by getting a reference from Python's <cite>sys.modules</cite> dictionary.</p> <p>For example:</p> <pre class="highlight-python notranslate" data-language="python">#!pydsl|stateconf -ps

def main():
    my_mod = sys.modules['salt.loaded.ext.module.my_mod']</pre> <dl class="py function"> <h3 id="salt.renderers.pydsl.render"> salt.renderers.pydsl.render(template, saltenv='base', sls='', tmplpath=None, rendered_sls=None, **kws)</h3> 
</dl> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2021 SaltStack.<br>Licensed under the Apache License, Version 2.0.<br>
    <a href="https://docs.saltproject.io/en/latest/ref/renderers/all/salt.renderers.pydsl.html" class="_attribution-link">https://docs.saltproject.io/en/latest/ref/renderers/all/salt.renderers.pydsl.html</a>
  </p>
</div>
