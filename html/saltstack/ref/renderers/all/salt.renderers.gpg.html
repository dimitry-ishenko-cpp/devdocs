<h1>salt.renderers.gpg</h1> <p>Renderer that will decrypt GPG ciphers</p> <p>Any key in the SLS file can be a GPG cipher, and this renderer will decrypt it before passing it off to Salt. This allows you to safely store secrets in source control, in such a way that only your Salt master can decrypt them and distribute them only to the minions that need them.</p> <p>The typical use-case would be to use ciphers in your pillar data, and keep a secret key on your master. You can put the public key in source control so that developers can add new secrets quickly and easily.</p> <p>This renderer requires the <a class="reference external" href="https://gnupg.org">gpg</a> binary. No python libraries are required as of the 2015.8.0 release.</p> <div class="section" id="gpg-homedir"> <h2>GPG Homedir</h2> <p>When running gpg commands, it is important to run commands as the user that owns the keys directory. If salt-master runs as user salt, then <code class="docutils literal notranslate"><span class="pre">su</span> <span class="pre">salt</span></code> before running any gpg commands.</p> <p>To avoid compatibility and upgrade problems and to provide a standardized location for keys, salt uses <code class="docutils literal notranslate"><span class="pre">/etc/salt/gpgkeys</span></code>. In order to make the gpg command use this directory, use <code class="docutils literal notranslate"><span class="pre">gpg</span> <span class="pre">--homedir</span> <span class="pre">/etc/salt/gpgkeys</span></code> with gpg commands or set the homedir for that user using <code class="docutils literal notranslate"><span class="pre">echo</span> <span class="pre">'homedir</span> <span class="pre">/etc/salt/gpgkeys'</span> <span class="pre">&gt;&gt;</span> <span class="pre">~/.gnupg</span></code>.</p> </div> <div class="section" id="setup"> <h2>Setup</h2> <p>To set things up, first generate a keypair. On the master, run the following:</p> <pre class="highlight-bash notranslate" data-language="bash"># mkdir -p /etc/salt/gpgkeys
# chmod 0700 /etc/salt/gpgkeys
# gpg --gen-key --homedir /etc/salt/gpgkeys</pre> <p>Do not supply a password for the keypair, and use a name that makes sense for your application. Be sure to back up the <code class="docutils literal notranslate"><span class="pre">gpgkeys</span></code> directory someplace safe!</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>Unfortunately, there are some scenarios - for example, on virtual machines which donâ€™t have real hardware - where insufficient entropy causes key generation to be extremely slow. In these cases, there are usually means of increasing the system entropy. On virtualised Linux systems, this can often be achieved by installing the <code class="docutils literal notranslate"><span class="pre">rng-tools</span></code> package.</p> </div> <div class="section" id="import-keys-to-a-master"> <h3>Import keys to a master</h3> <p>If the keys already exist and need to be imported to the salt master, run the following to import them.</p> <pre class="highlight-bash notranslate" data-language="bash">gpg --homedir /etc/salt/gpgkeys --import /path/to/private.key
gpg --homedir /etc/salt/gpgkeys --import /path/to/pubkey.gpg</pre> <p>Note: The default <cite>GPG Homedir &lt;gpg-homedir&gt;</cite> is <code class="docutils literal notranslate"><span class="pre">~/.gnupg</span></code> and needs to be set using <code class="docutils literal notranslate"><span class="pre">--homedir</span></code>.</p> </div> <div class="section" id="adjust-trust-level-of-imported-keys"> <h3>Adjust trust level of imported keys</h3> <p>In some cases, importing existing keys may not be enough and the trust level of the key needs to be adjusted. This can be done by editing the key. The <code class="docutils literal notranslate"><span class="pre">key_id</span></code> and the actual trust level of the key can be seen by listing the already imported keys.</p> <pre class="highlight-bash notranslate" data-language="bash">gpg --homedir /etc/salt/gpgkeys --list-keys
gpg --homedir /etc/salt/gpgkeys --list-secret-keys</pre> <p>If the trust-level is not <code class="docutils literal notranslate"><span class="pre">ultimate</span></code> it needs to be changed by running</p> <pre class="highlight-bash notranslate" data-language="bash">gpg --homedir /etc/salt/gpgkeys --edit-key &lt;key_id&gt;</pre> <p>This will open an interactive shell for the management of the GPG encryption key. Type <code class="docutils literal notranslate"><span class="pre">trust</span></code> to be able to set the trust level for the key and then select <code class="docutils literal notranslate"><span class="pre">5</span>
<span class="pre">(I</span> <span class="pre">trust</span> <span class="pre">ultimately)</span></code>. Then quit the shell by typing <code class="docutils literal notranslate"><span class="pre">save</span></code>.</p> </div> <div class="section" id="different-gpg-location"> <h3>Different GPG Location</h3> <p>In some cases, it's preferable to have gpg keys stored on removable media or other non-standard locations. This can be done using the <code class="docutils literal notranslate"><span class="pre">gpg_keydir</span></code> option on the salt master. This will also require using a different path to <code class="docutils literal notranslate"><span class="pre">--homedir</span></code>, as mentioned in the <cite>GPG Homedir &lt;gpg-homedir&gt;</cite> section.</p> <pre class="highlight-bash notranslate" data-language="bash">gpg_keydir: &lt;path/to/homedir&gt;</pre> </div> </div> <div class="section" id="export-the-public-key"> <h2>Export the Public Key</h2> <pre class="highlight-bash notranslate" data-language="bash"># gpg --homedir /etc/salt/gpgkeys --armor --export &lt;KEY-NAME&gt; &gt; exported_pubkey.gpg</pre> </div> <div class="section" id="import-the-public-key"> <h2>Import the Public Key</h2> <p>To encrypt secrets, copy the public key to your local machine and run:</p> <pre class="highlight-bash notranslate" data-language="bash">$ gpg --import exported_pubkey.gpg</pre> <p>To generate a cipher from a secret:</p> <pre class="highlight-bash notranslate" data-language="bash">$ echo -n "supersecret" | gpg --armor --batch --trust-model always --encrypt -r &lt;KEY-name&gt;</pre> <p>To apply the renderer on a file-by-file basis add the following line to the top of any pillar with gpg data in it:</p> <pre class="highlight-yaml notranslate" data-language="yaml">#!yaml|gpg</pre> <p>Now with your renderer configured, you can include your ciphers in your pillar data like so:</p> <pre class="highlight-yaml notranslate" data-language="yaml">#!yaml|gpg

a-secret: |
  -----BEGIN PGP MESSAGE-----
  Version: GnuPG v1

  hQEMAweRHKaPCfNeAQf9GLTN16hCfXAbPwU6BbBK0unOc7i9/etGuVc5CyU9Q6um
  QuetdvQVLFO/HkrC4lgeNQdM6D9E8PKonMlgJPyUvC8ggxhj0/IPFEKmrsnv2k6+
  cnEfmVexS7o/U1VOVjoyUeliMCJlAz/30RXaME49Cpi6No2+vKD8a4q4nZN1UZcG
  RhkhC0S22zNxOXQ38TBkmtJcqxnqT6YWKTUsjVubW3bVC+u2HGqJHu79wmwuN8tz
  m4wBkfCAd8Eyo2jEnWQcM4TcXiF01XPL4z4g1/9AAxh+Q4d8RIRP4fbw7ct4nCJv
  Gr9v2DTF7HNigIMl4ivMIn9fp+EZurJNiQskLgNbktJGAeEKYkqX5iCuB1b693hJ
  FKlwHiJt5yA8X2dDtfk8/Ph1Jx2TwGS+lGjlZaNqp3R1xuAZzXzZMLyZDe5+i3RJ
  skqmFTbOiA===Eqsm
  -----END PGP MESSAGE-----</pre> </div> <div class="section" id="encrypted-cli-pillar-data"> <h2>Encrypted CLI Pillar Data</h2> <div class="versionadded"> <p><span class="versionmodified added">New in version 2016.3.0.</span></p> </div> <p>Functions like <a class="reference internal" href="../../modules/all/salt.modules.state.html#salt.modules.state.highstate" title="salt.modules.state.highstate"><code class="xref py py-func docutils literal notranslate"><span class="pre">state.highstate</span></code></a> and <a class="reference internal" href="../../modules/all/salt.modules.state.html#salt.modules.state.sls" title="salt.modules.state.sls"><code class="xref py py-func docutils literal notranslate"><span class="pre">state.sls</span></code></a> allow for pillar data to be passed on the CLI.</p> <pre class="highlight-bash notranslate" data-language="bash">salt myminion state.highstate pillar="{'mypillar': 'foo'}"</pre> <p>Starting with the 2016.3.0 release of Salt, it is now possible for this pillar data to be GPG-encrypted, and to use the GPG renderer to decrypt it.</p> <div class="section" id="replacing-newlines"> <h3>Replacing Newlines</h3> <p>To pass encrypted pillar data on the CLI, the ciphertext must have its newlines replaced with a literal backslash-n (<code class="docutils literal notranslate"><span class="pre">\n</span></code>), as newlines are not supported within Salt CLI arguments. There are a number of ways to do this:</p> <p>With awk or Perl:</p> <pre class="highlight-bash notranslate" data-language="bash"># awk
ciphertext=`echo -n "supersecret" | gpg --armor --batch --trust-model always --encrypt -r user@domain.com | awk '{printf "%s\\n",$0} END {print ""}'`
# Perl
ciphertext=`echo -n "supersecret" | gpg --armor --batch --trust-model always --encrypt -r user@domain.com | perl -pe 's/\n/\\n/g'`</pre> <p>With Python:</p> <pre class="highlight-python notranslate" data-language="python">import subprocess

secret, stderr = subprocess.Popen(
    ['gpg', '--armor', '--batch', '--trust-model', 'always', '--encrypt',
     '-r', 'user@domain.com'],
    stdin=subprocess.PIPE,
    stdout=subprocess.PIPE,
    stderr=subprocess.PIPE).communicate(input='supersecret')

if secret:
    print(secret.replace('\n', r'\n'))
else:
    raise ValueError('No ciphertext found: {0}'.format(stderr))</pre> <pre class="highlight-bash notranslate" data-language="bash">ciphertext=`python /path/to/script.py`</pre> <p>The ciphertext can be included in the CLI pillar data like so:</p> <pre class="highlight-bash notranslate" data-language="bash">salt myminion state.sls secretstuff pillar_enc=gpg pillar="{secret_pillar: '$ciphertext'}"</pre> <p>The <code class="docutils literal notranslate"><span class="pre">pillar_enc=gpg</span></code> argument tells Salt that there is GPG-encrypted pillar data, so that the CLI pillar data is passed through the GPG renderer, which will iterate recursively though the CLI pillar dictionary to decrypt any encrypted values.</p> </div> <div class="section" id="encrypting-the-entire-cli-pillar-dictionary"> <h3>Encrypting the Entire CLI Pillar Dictionary</h3> <p>If several values need to be encrypted, it may be more convenient to encrypt the entire CLI pillar dictionary. Again, this can be done in several ways:</p> <p>With awk or Perl:</p> <pre class="highlight-bash notranslate" data-language="bash"># awk
ciphertext=`echo -n "{'secret_a': 'CorrectHorseBatteryStaple', 'secret_b': 'GPG is fun!'}" | gpg --armor --batch --trust-model always --encrypt -r user@domain.com | awk '{printf "%s\\n",$0} END {print ""}'`
# Perl
ciphertext=`echo -n "{'secret_a': 'CorrectHorseBatteryStaple', 'secret_b': 'GPG is fun!'}" | gpg --armor --batch --trust-model always --encrypt -r user@domain.com | perl -pe 's/\n/\\n/g'`</pre> <p>With Python:</p> <pre class="highlight-python notranslate" data-language="python">import subprocess

pillar_data = {'secret_a': 'CorrectHorseBatteryStaple',
               'secret_b': 'GPG is fun!'}

secret, stderr = subprocess.Popen(
    ['gpg', '--armor', '--batch', '--trust-model', 'always', '--encrypt',
     '-r', 'user@domain.com'],
    stdin=subprocess.PIPE,
    stdout=subprocess.PIPE,
    stderr=subprocess.PIPE).communicate(input=repr(pillar_data))

if secret:
    print(secret.replace('\n', r'\n'))
else:
    raise ValueError('No ciphertext found: {0}'.format(stderr))</pre> <pre class="highlight-bash notranslate" data-language="bash">ciphertext=`python /path/to/script.py`</pre> <p>With the entire pillar dictionary now encrypted, it can be included in the CLI pillar data like so:</p> <pre class="highlight-bash notranslate" data-language="bash">salt myminion state.sls secretstuff pillar_enc=gpg pillar="$ciphertext"</pre> <dl class="py function"> <h3 id="salt.renderers.gpg.render"> salt.renderers.gpg.render(gpg_data, saltenv='base', sls='', argline='', **kwargs)</h3> <dd>
<p>Create a gpg object given a gpg_keydir, and then use it to try to decrypt the data to be rendered.</p> </dd>
</dl> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2021 SaltStack.<br>Licensed under the Apache License, Version 2.0.<br>
    <a href="https://docs.saltproject.io/en/latest/ref/renderers/all/salt.renderers.gpg.html" class="_attribution-link">https://docs.saltproject.io/en/latest/ref/renderers/all/salt.renderers.gpg.html</a>
  </p>
</div>
