<h1>How to use Redis with Deno</h1>
<div>
<p><a href="https://redis.io/">Redis</a> is an in-memory data store you can use for caching, as a message broker, or for streaming data.</p> <p><a href="https://github.com/denoland/examples/tree/main/with-redis">View source here.</a></p> <p>Here we're going to set up Redis to cache data from an API call to speed up any subsequent requests for that data. We're going to:</p> <ul> <li>Set up a Redis client to save data from every API call in memory</li> <li>Set up a Deno server so we can easily request certain data</li> <li>Call the Github API within the server handler to get the data on first request</li> <li>Serve data from Redis on every subsequent request</li> </ul> <p>We can do this within a single file, <code data-language="ts">main.ts</code>.</p> <h2 id="connecting-to-a-redis-client" tabindex="-1">Connecting to a Redis client </h2> <p>We need two modules. The first is the Deno server. We'll use this to get the information from the user to query our API. The second is Redis. We can grab the node package for Redis using the <code data-language="ts">npm:</code> modifier:</p> <div class="relative">
<pre class="language-tsx" tabindex="0"><code data-language="tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> createClient <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"npm:redis@^4.5"</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>We create a Redis client using <code data-language="ts">createClient</code> and connect to our local Redis server:</p> <div class="relative">
<pre class="language-tsx" tabindex="0"><code data-language="tsx"><span class="token comment">// make a connection to the local instance of redis</span>
<span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  url<span class="token operator">:</span> <span class="token string">"redis://localhost:6379"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>You can also set host, user, password, and port individually in this <a href="https://github.com/redis/node-redis/blob/master/docs/client-configuration.md">configuration</a> object.</p> <h2 id="setting-up-the-server" tabindex="-1">Setting up the server </h2> <p>Our server is going to act as a wrapper around the Github API. A client can call our server with a Github username in the URL pathname, such as <code data-language="ts">http://localhost:3000/{username}</code>.</p> <p>Parsing out the pathname and calling the Github API will take place inside a handler function in our server. We strip the leading slash so we are left with a variable we can pass to the Github API as a username. We'll then pass the response back to the user.</p> <div class="relative">
<pre class="language-tsx" tabindex="0"><code data-language="tsx">Deno<span class="token punctuation">.</span><span class="token function">serve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> port<span class="token operator">:</span> <span class="token number">3000</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pathname <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token constant">URL</span></span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// strip the leading slash</span>
  <span class="token keyword">const</span> username <span class="token operator">=</span> pathname<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> resp <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.github.com/users/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> resp<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    headers<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"content-type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>We'll run this with:</p> <div class="relative">
<pre class="language-tsx" tabindex="0"><code data-language="tsx">deno run <span class="token operator">--</span>allow<span class="token operator">-</span>net main<span class="token punctuation">.</span>ts
</code></pre>   </div>
<p>If we then go to <a href="http://localhost:3000/ry">http://localhost:3000/ry</a> in Postman, we'll get the Github response:</p> <p><img src="https://docs.deno.com/runtime/tutorials/images/how-to/redis/uncached-redis-body.png" alt="uncached-redis-body.png"></p> <p>Let's cache this response using Redis.</p> <h2 id="checking-the-cache" tabindex="-1">Checking the cache </h2> <p>Once we have our response from the Github API, we can cache this within Redis using <code data-language="ts">client.set</code>, with our username as the key and the user object as the value:</p> <div class="relative">
<pre class="language-tsx" tabindex="0"><code data-language="tsx"><span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>Next time we request the same username, we can use <code data-language="ts">client.get</code> to get the cached user:</p> <div class="relative">
<pre class="language-tsx" tabindex="0"><code data-language="tsx"><span class="token keyword">const</span> cached_user <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>This returns null if the key doesn't exist. So we can use it in some flow control. When we get the username, we'll initially check whether we already have that user in the cache. If we do we'll serve the cached result. If not, we'll call the Github API to get the user, cache it, the serve the API result. In both cases, we'll add a custom header to show which version we're serving:</p> <div class="relative">
<pre class="language-tsx" tabindex="0"><code data-language="tsx"><span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Server</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> pathname <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token constant">URL</span></span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// strip the leading slash</span>
    <span class="token keyword">const</span> username <span class="token operator">=</span> pathname<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> cached_user <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cached_user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>cached_user<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        headers<span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">"content-type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"is-cached"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> resp <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.github.com/users/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> resp<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        headers<span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">"content-type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"is-cached"</span><span class="token operator">:</span> <span class="token string">"false"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  port<span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>Running this first time gives us the same response as above, and we'll see the <code data-language="ts">is-cached</code> header set to <code data-language="ts">false</code>:</p> <p><img src="https://docs.deno.com/runtime/tutorials/images/how-to/redis/uncached-redis-header.png" alt="uncached-redis-header.png"></p> <p>But call with the same username again, and we get the cached result. The body is identical:</p> <p><img src="https://docs.deno.com/runtime/tutorials/images/how-to/redis/cached-redis-body.png" alt="cached-redis-body.png"></p> <p>But the header shows we have the cache:</p> <p><img src="https://docs.deno.com/runtime/tutorials/images/how-to/redis/cached-redis-header.png" alt="cached-redis-header.png"></p> <p>We can also see that the response was ~200ms quicker!</p> <p>You can check out the Redis documentation <a href="https://redis.io/docs/">here</a> and the Redis node package <a href="https://github.com/redis/node-redis">here</a>.</p> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2018–2024 the Deno authors<br>Licensed under the MIT License.<br>
    <a href="https://docs.deno.com/runtime/tutorials/how_to_with_npm/redis" class="_attribution-link">https://docs.deno.com/runtime/tutorials/how_to_with_npm/redis</a>
  </p>
</div>
