<h1>Deno Namespace APIs</h1>
<div>
<p>The global <code data-language="ts">Deno</code> namespace contains APIs that are not web standard, including APIs for reading from files, opening TCP sockets, serving HTTP, and executing subprocesses, etc.</p> <p><a href="https://docs.deno.com/api/deno/" class="docs-cta runtime-cta">Explore all Deno APIs</a></p> <p>Below we highlight some of the most important Deno APIs to know.</p> <h2 id="file-system" tabindex="-1">File System </h2> <p>The Deno runtime comes with <a href="https://docs.deno.com/api/deno/file-system">various functions for working with files and directories</a>. You will need to use --allow-read and --allow-write permissions to gain access to the file system.</p> <p>Refer to the links below for code examples of how to use the file system functions.</p> <ul> <li><a href="https://docs.deno.com/examples/reading-files">Reading files in several different ways</a></li> <li><a href="../tutorials/file_server.html">Reading files in streams</a></li> <li><a href="https://docs.deno.com/examples/reading-files">Reading a text file (<code data-language="ts">Deno.readTextFile</code>)</a></li> <li><a href="https://docs.deno.com/examples/writing-files">Writing a text file (<code data-language="ts">Deno.writeTextFile</code>)</a></li> </ul> <h2 id="network" tabindex="-1">Network </h2> <p>The Deno runtime comes with <a href="https://docs.deno.com/api/deno/network">built-in functions for dealing with connections to network ports</a>.</p> <p>Refer to the links below for code examples for common functions.</p> <ul> <li><a href="../../api/deno/~/deno.connect.html">Connect to the hostname and port (<code data-language="ts">Deno.connect</code>)</a></li> <li><a href="../../api/deno/~/deno.listen.html">Announcing on the local transport address (<code data-language="ts">Deno.listen</code>)</a></li> </ul> <h2 id="subprocesses" tabindex="-1">Subprocesses </h2> <p>The Deno runtime comes with <a href="https://docs.deno.com/api/deno/sub-process">built-in functions for spinning up subprocesses</a>.</p> <p>Refer to the links below for code samples of how to create a subprocess.</p> <ul> <li><a href="../tutorials/subprocess.html">Creating a subprocess (<code data-language="ts">Deno.Command</code>)</a></li> </ul> <h2 id="errors" tabindex="-1">Errors </h2> <p>The Deno runtime comes with <a href="https://docs.deno.com/api/deno/errors">20 error classes</a> that can be raised in response to a number of conditions.</p> <p>Some examples are:</p> <div class="relative">
<pre class="language-sh" tabindex="0"><code data-language="sh">Deno.errors.NotFound<span class="token punctuation">;</span>
Deno.errors.WriteZero<span class="token punctuation">;</span>
</code></pre>   </div>
<p>They can be used as below:</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token keyword">await</span> Deno<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"./some/file.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token keyword">instanceof</span> <span class="token class-name">Deno</span><span class="token punctuation">.</span>errors<span class="token punctuation">.</span>NotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"the file was not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// otherwise re-throw</span>
    <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>   </div>
<h2 id="http-server" tabindex="-1">HTTP Server </h2> <p>Deno has two HTTP Server APIs:</p> <ul> <li>
<a href="../../api/deno/~/deno.serve.html"><code data-language="ts">Deno.serve</code></a>: native, <em>higher-level</em>, supports HTTP/1.1 and HTTP2, this is the preferred API to write HTTP servers in Deno.</li> <li>
<a href="../../api/deno/~/deno.servehttp.html"><code data-language="ts">Deno.serveHttp</code></a>: native, <em>low-level</em>, supports HTTP/1.1 and HTTP2.</li> </ul> <p>To start an HTTP server on a given port, use the <code data-language="ts">Deno.serve</code> function. This function takes a handler function that will be called for each incoming request, and is expected to return a response (or a promise resolving to a response). For example:</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts">Deno<span class="token punctuation">.</span><span class="token function">serve</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_req<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">"Hello, World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>By default <code data-language="ts">Deno.serve</code> will listen on port <code data-language="ts">8000</code>, but this can be changed by passing in a port number in options bag as the first or second argument.</p> <p>You can <a href="../fundamentals/http_server.html">read more about how to use the HTTP server APIs</a>.</p> <h2 id="permissions" tabindex="-1">Permissions </h2> <p>Permissions are granted from the CLI when running the <code data-language="ts">deno</code> command. User code will often assume its own set of required permissions, but there is no guarantee during execution that the set of <strong>granted</strong> permissions will align with this.</p> <p>In some cases, ensuring a fault-tolerant program requires a way to interact with the permission system at runtime.</p> <h3 id="permission-descriptors" tabindex="-1">Permission descriptors </h3> <p>On the CLI, read permission for <code data-language="ts">/foo/bar</code> is represented as <code data-language="ts">--allow-read=/foo/bar</code>. In runtime JS, it is represented as the following:</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token keyword">const</span> desc <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"read"</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">"/foo/bar"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>Other examples:</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token comment">// Global write permission.</span>
<span class="token keyword">const</span> desc1 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"write"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

<span class="token comment">// Write permission to `$PWD/foo/bar`.</span>
<span class="token keyword">const</span> desc2 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"write"</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">"foo/bar"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

<span class="token comment">// Global net permission.</span>
<span class="token keyword">const</span> desc3 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"net"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

<span class="token comment">// Net permission to 127.0.0.1:8000.</span>
<span class="token keyword">const</span> desc4 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"net"</span><span class="token punctuation">,</span> host<span class="token operator">:</span> <span class="token string">"127.0.0.1:8000"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

<span class="token comment">// High-resolution time permission.</span>
<span class="token keyword">const</span> desc5 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"hrtime"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>See <a href="../../api/deno/~/deno.permissiondescriptor.html"><code data-language="ts">PermissionDescriptor</code></a> in API reference for more details. Synchronous API counterparts (ex. <code data-language="ts">Deno.permissions.querySync</code>) exist for all the APIs described below.</p> <h3 id="query-permissions" tabindex="-1">Query permissions </h3> <p>Check, by descriptor, if a permission is granted or not.</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token comment">// deno run --allow-read=/foo main.ts</span>

<span class="token keyword">const</span> desc1 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"read"</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">"/foo"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> Deno<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>desc1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// PermissionStatus { state: "granted", partial: false }</span>

<span class="token keyword">const</span> desc2 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"read"</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">"/foo/bar"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> Deno<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>desc2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// PermissionStatus { state: "granted", partial: false }</span>

<span class="token keyword">const</span> desc3 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"read"</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">"/bar"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> Deno<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>desc3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// PermissionStatus { state: "prompt", partial: false }</span>
</code></pre>   </div>
<p>If <code data-language="ts">--deny-read</code> flag was used to restrict some of the filepaths, the result will contain <code data-language="ts">partial: true</code> describing that not all subpaths have permissions granted:</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token comment">// deno run --allow-read=/foo --deny-read=/foo/bar main.ts</span>

<span class="token keyword">const</span> desc1 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"read"</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">"/foo"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> Deno<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>desc1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// PermissionStatus { state: "granted", partial: true }</span>

<span class="token keyword">const</span> desc2 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"read"</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">"/foo/bar"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> Deno<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>desc2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// PermissionStatus { state: "denied", partial: false }</span>

<span class="token keyword">const</span> desc3 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"read"</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">"/bar"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> Deno<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>desc3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// PermissionStatus { state: "prompt", partial: false }</span>
</code></pre>   </div>
<h3 id="permission-states" tabindex="-1">Permission states </h3> <p>A permission state can be either "granted", "prompt" or "denied". Permissions which have been granted from the CLI will query to <code data-language="ts">{ state: "granted" }</code>. Those which have not been granted query to <code data-language="ts">{ state: "prompt" }</code> by default, while <code data-language="ts">{ state: "denied" }</code> reserved for those which have been explicitly refused. This will come up in <a href="#request-permissions">Request permissions</a>.</p> <h3 id="permission-strength" tabindex="-1">Permission strength </h3> <p>The intuitive understanding behind the result of the second query in <a href="#query-permissions">Query permissions</a> is that read access was granted to <code data-language="ts">/foo</code> and <code data-language="ts">/foo/bar</code> is within <code data-language="ts">/foo</code> so <code data-language="ts">/foo/bar</code> is allowed to be read. This hold true, unless the CLI-granted permission is <em>partial</em> to the queried permissions (as an effect of using a <code data-language="ts">--deny-*</code> flag).</p> <p>We can also say that <code data-language="ts">desc1</code> is <em><a href="https://www.w3.org/TR/permissions/#ref-for-permissiondescriptor-stronger-than">stronger than</a></em> <code data-language="ts">desc2</code>. This means that for any set of CLI-granted permissions:</p> <ol> <li>If <code data-language="ts">desc1</code> queries to <code data-language="ts">{ state: "granted", partial: false }</code> then so must <code data-language="ts">desc2</code>.</li> <li>If <code data-language="ts">desc2</code> queries to <code data-language="ts">{ state: "denied", partial: false }</code> then so must <code data-language="ts">desc1</code>.</li> </ol> <p>More examples:</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token keyword">const</span> desc1 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"write"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token comment">// is stronger than</span>
<span class="token keyword">const</span> desc2 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"write"</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">"/foo"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> desc3 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"net"</span><span class="token punctuation">,</span> host<span class="token operator">:</span> <span class="token string">"127.0.0.1"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token comment">// is stronger than</span>
<span class="token keyword">const</span> desc4 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"net"</span><span class="token punctuation">,</span> host<span class="token operator">:</span> <span class="token string">"127.0.0.1:8000"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
</code></pre>   </div>
<h3 id="request-permissions" tabindex="-1">Request permissions </h3> <p>Request an ungranted permission from the user via CLI prompt.</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token comment">// deno run main.ts</span>

<span class="token keyword">const</span> desc1 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"read"</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">"/foo"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> status1 <span class="token operator">=</span> <span class="token keyword">await</span> Deno<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>desc1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ⚠️ Deno requests read access to "/foo". Grant? [y/n (y = yes allow, n = no deny)] y</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>status1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// PermissionStatus { state: "granted", partial: false }</span>

<span class="token keyword">const</span> desc2 <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"read"</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">"/bar"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> status2 <span class="token operator">=</span> <span class="token keyword">await</span> Deno<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>desc2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ⚠️ Deno requests read access to "/bar". Grant? [y/n (y = yes allow, n = no deny)] n</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>status2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// PermissionStatus { state: "denied", partial: false }</span>
</code></pre>   </div>
<p>If the current permission state is "prompt", a prompt will appear on the user's terminal asking them if they would like to grant the request. The request for <code data-language="ts">desc1</code> was granted so its new status is returned and execution will continue as if <code data-language="ts">--allow-read=/foo</code> was specified on the CLI. The request for <code data-language="ts">desc2</code> was denied so its permission state is downgraded from "prompt" to "denied".</p> <p>If the current permission state is already either "granted" or "denied", the request will behave like a query and just return the current status. This prevents prompts both for already granted permissions and previously denied requests.</p> <h3 id="revoke-permissions" tabindex="-1">Revoke permissions </h3> <p>Downgrade a permission from "granted" to "prompt".</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token comment">// deno run --allow-read=/foo main.ts</span>

<span class="token keyword">const</span> desc <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"read"</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">"/foo"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> Deno<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">revoke</span><span class="token punctuation">(</span>desc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// PermissionStatus { state: "prompt", partial: false }</span>
</code></pre>   </div>
<p>What happens when you try to revoke a permission which is <em>partial</em> to one granted on the CLI?</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token comment">// deno run --allow-read=/foo main.ts</span>

<span class="token keyword">const</span> desc <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"read"</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">"/foo/bar"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> Deno<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">revoke</span><span class="token punctuation">(</span>desc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// PermissionStatus { state: "prompt", partial: false }</span>
<span class="token keyword">const</span> cliDesc <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"read"</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">"/foo"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> Deno<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">revoke</span><span class="token punctuation">(</span>cliDesc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// PermissionStatus { state: "prompt", partial: false }</span>
</code></pre>   </div>
<p>The CLI-granted permission, which implies the revoked permission, was also revoked.</p> <p>To understand this behavior, imagine that Deno stores an internal set of <em>explicitly granted permission descriptors</em>. Specifying <code data-language="ts">--allow-read=/foo,/bar</code> on the CLI initializes this set to:</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"read"</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">"/foo"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"read"</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">"/bar"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>Granting a runtime request for <code data-language="ts">{ name: "write", path: "/foo" }</code> updates the set to:</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"read"</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">"/foo"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"read"</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">"/bar"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"write"</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">"/foo"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>Deno's permission revocation algorithm works by removing every element from this set which is <em>stronger than</em> the argument permission descriptor.</p> <p>Deno does not allow "fragmented" permission states, where some strong permission is granted with exclusions of weak permissions implied by it. Such a system would prove increasingly complex and unpredictable as you factor in a wider variety of use cases and the <code data-language="ts">"denied"</code> state. This is a calculated trade-off of granularity for security.</p> <h2 id="import.meta" tabindex="-1">import.meta </h2> <p>Deno supports a number of properties and methods on the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/import.meta"><code data-language="ts">import.meta</code></a> API. It can be used to get information about the module, such as the module's URL.</p> <h3 id="import.meta.url" tabindex="-1">import.meta.url </h3> <p>Returns the URL of the current module.</p> <div>
<div class="markdownBlockTitle">main.ts</div>
<div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<div class="relative">
<pre class="language-sh" tabindex="0"><code data-language="sh">$ deno run main.ts
file:///dev/main.ts

$ deno run https:/example.com/main.ts
https://example.com/main.ts
</code></pre>   </div>
<h3 id="import.meta.main" tabindex="-1">import.meta.main </h3> <p>Returns whether the current module is the entry point to your program.</p> <div>
<div class="markdownBlockTitle">main.ts</div>
<div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token keyword">import</span> <span class="token string">"./other.ts"</span><span class="token punctuation">;</span>

<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> the main module?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<div>
<div class="markdownBlockTitle">other.ts</div>
<div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> the main module?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>main<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<div class="relative">
<pre class="language-sh" tabindex="0"><code data-language="sh">$ deno run main.ts
Is file:///dev/other.ts the main module? <span class="token boolean">false</span>
Is file:///dev/main.ts the main module? <span class="token boolean">true</span>
</code></pre>   </div>
<h3 id="import.meta.filename" tabindex="-1">import.meta.filename </h3> <p><em>This property is only available for local modules (module that have <code data-language="ts">file:///...</code> specifier) and returns <code data-language="ts">undefined</code> for remote modules.</em></p> <p>Returns the fully resolved path to the current module. The value contains OS specific path separators.</p> <div>
<div class="markdownBlockTitle">main.ts</div>
<div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<p>On Unix:</p> <div class="relative">
<pre class="language-sh" tabindex="0"><code data-language="sh">$ deno run main.ts
/dev/main.ts

$ deno run https://example.com/main.ts
undefined
</code></pre>   </div>
<p>On Windows:</p> <div class="relative">
<pre class="language-sh" tabindex="0"><code data-language="sh">$ deno run main.ts
C:<span class="token punctuation">\</span>dev<span class="token punctuation">\</span>main.ts

$ deno run https://example.com/main.ts
undefined
</code></pre>   </div>
<h3 id="import.meta.dirname" tabindex="-1">import.meta.dirname </h3> <p><em>This property is only available for local modules (module that have <code data-language="ts">file:///...</code> specifier) and returns <code data-language="ts">undefined</code> for remote modules.</em></p> <p>Returns the fully resolved path to the directory containing the current module. The value contains OS specific path separators.</p> <div>
<div class="markdownBlockTitle">main.ts</div>
<div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<p>On Unix:</p> <div class="relative">
<pre class="language-sh" tabindex="0"><code data-language="sh">$ deno run main.ts
/dev/

$ deno run https://example.com/main.ts
undefined
</code></pre>   </div>
<p>On Windows:</p> <div class="relative">
<pre class="language-sh" tabindex="0"><code data-language="sh">$ deno run main.ts
C:<span class="token punctuation">\</span>dev<span class="token punctuation">\</span>

$ deno run https://example.com/main.ts
undefined
</code></pre>   </div>
<h3 id="import.meta.resolve" tabindex="-1">import.meta.resolve </h3> <p>Resolve specifiers relative to the current module.</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"./worker.ts"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>The <code data-language="ts">import.meta.resolve</code> API takes into account the currently applied import map, which gives you the ability to resolve "bare" specifiers as well.</p> <p>With such import map loaded...</p> <div class="relative">
<pre class="language-json" tabindex="0"><code data-language="json"><span class="token punctuation">{</span>
  <span class="token property">"imports"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"fresh"</span><span class="token operator">:</span> <span class="token string">"https://deno.land/x/fresh@1.0.1/dev.ts"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>   </div>
<p>...you can now resolve:</p> <div>
<div class="markdownBlockTitle">resolve.js</div>
<div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"fresh"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<div class="relative">
<pre class="language-sh" tabindex="0"><code data-language="sh">$ deno run resolve.js
https://deno.land/x/fresh@1.0.1/dev.ts
</code></pre>   </div>
<h2 id="ffi" tabindex="-1">FFI </h2> <p>The FFI (foreign function interface) API allows users to call libraries written in native languages that support the C ABIs (C/C++, Rust, Zig, V, etc.) using <code data-language="ts">Deno.dlopen</code>.</p> <p>Here's an example showing how to call a Rust function from Deno:</p> <div class="relative">
<pre class="language-rust" tabindex="0"><code data-language="rust">// add.rs
#[no_mangle]
pub extern "C" fn add(a: isize, b: isize) -&gt; isize {
    a + b
}
</code></pre>   </div>
<p>Compile it to a C dynamic library (<code data-language="ts">libadd.so</code> on Linux):</p> <div class="relative">
<pre class="language-sh" tabindex="0"><code data-language="sh">rustc --crate-type cdylib add.rs
</code></pre>   </div>
<p>In C you can write it as:</p> <div class="relative">
<pre class="language-c" tabindex="0"><code data-language="c">// add.c
int add(int a, int b) {
  return a + b;
}
</code></pre>   </div>
<p>And compile it:</p> <div class="relative">
<pre class="language-sh" tabindex="0"><code data-language="sh">// unix
cc <span class="token parameter variable">-c</span> <span class="token parameter variable">-o</span> add.o add.c
cc <span class="token parameter variable">-shared</span> <span class="token parameter variable">-W</span> <span class="token parameter variable">-o</span> libadd.so add.o
// Windows
cl /LD add.c /link /EXPORT:add
</code></pre>   </div>
<p>Calling the library from Deno:</p> <div class="relative">
<pre class="language-typescript" tabindex="0"><code data-language="typescript"><span class="token comment">// ffi.ts</span>

<span class="token comment">// Determine library extension based on</span>
<span class="token comment">// your OS.</span>
<span class="token keyword">let</span> libSuffix <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token keyword">switch</span> <span class="token punctuation">(</span>Deno<span class="token punctuation">.</span>build<span class="token punctuation">.</span>os<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token string">"windows"</span><span class="token operator">:</span>
    libSuffix <span class="token operator">=</span> <span class="token string">"dll"</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> <span class="token string">"darwin"</span><span class="token operator">:</span>
    libSuffix <span class="token operator">=</span> <span class="token string">"dylib"</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">default</span><span class="token operator">:</span>
    libSuffix <span class="token operator">=</span> <span class="token string">"so"</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> libName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./libadd.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>libSuffix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token comment">// Open library and define exported symbols</span>
<span class="token keyword">const</span> dylib <span class="token operator">=</span> Deno<span class="token punctuation">.</span><span class="token function">dlopen</span><span class="token punctuation">(</span>
  libName<span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token string-property property">"add"</span><span class="token operator">:</span> <span class="token punctuation">{</span> parameters<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"isize"</span><span class="token punctuation">,</span> <span class="token string">"isize"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> result<span class="token operator">:</span> <span class="token string">"isize"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Call the symbol `add`</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> dylib<span class="token punctuation">.</span>symbols<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 69</span>

<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Result from external addition of 35 and 34: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>Run with <code data-language="ts">--allow-ffi</code> and <code data-language="ts">--unstable</code> flag:</p> <div class="relative">
<pre class="language-sh" tabindex="0"><code data-language="sh">deno run --allow-ffi <span class="token parameter variable">--unstable</span> ffi.ts
</code></pre>   </div>
<h3 id="non-blocking-ffi" tabindex="-1">Non-blocking FFI </h3> <p>There are many use cases where users might want to run CPU-bound FFI functions in the background without blocking other tasks on the main thread.</p> <p>As of Deno 1.15, symbols can be marked <code data-language="ts">nonblocking</code> in <code data-language="ts">Deno.dlopen</code>. These function calls will run on a dedicated blocking thread and will return a <code data-language="ts">Promise</code> resolving to the desired <code data-language="ts">result</code>.</p> <p>Example of executing expensive FFI calls with Deno:</p> <div class="relative">
<pre class="language-c" tabindex="0"><code data-language="c">// sleep.c
#ifdef _WIN32
#include &lt;Windows.h&gt;
#else
#include &lt;time.h&gt;
#endif

int sleep(unsigned int ms) {
  #ifdef _WIN32
  Sleep(ms);
  #else
  struct timespec ts;
  ts.tv_sec = ms / 1000;
  ts.tv_nsec = (ms % 1000) * 1000000;
  nanosleep(&amp;ts, NULL);
  #endif
}
</code></pre>   </div>
<p>Calling it from Deno:</p> <div class="relative">
<pre class="language-typescript" tabindex="0"><code data-language="typescript"><span class="token comment">// nonblocking_ffi.ts</span>
<span class="token keyword">const</span> library <span class="token operator">=</span> Deno<span class="token punctuation">.</span><span class="token function">dlopen</span><span class="token punctuation">(</span>
  <span class="token string">"./sleep.so"</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    sleep<span class="token operator">:</span> <span class="token punctuation">{</span>
      parameters<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"usize"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      result<span class="token operator">:</span> <span class="token string">"void"</span><span class="token punctuation">,</span>
      nonblocking<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

library<span class="token punctuation">.</span>symbols<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"After"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Before"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>Result:</p> <div class="relative">
<pre class="language-sh" tabindex="0"><code data-language="sh">$ deno run --allow-ffi <span class="token parameter variable">--unstable</span> unblocking_ffi.ts
Before
After
</code></pre>   </div>
<h3 id="callbacks" tabindex="-1">Callbacks </h3> <p>Deno FFI API supports creating C callbacks from JavaScript functions for calling back into Deno from dynamic libraries. An example of how callbacks are created and used is as follows:</p> <div class="relative">
<pre class="language-typescript" tabindex="0"><code data-language="typescript"><span class="token comment">// callback_ffi.ts</span>
<span class="token keyword">const</span> library <span class="token operator">=</span> Deno<span class="token punctuation">.</span><span class="token function">dlopen</span><span class="token punctuation">(</span>
  <span class="token string">"./callback.so"</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    set_status_callback<span class="token operator">:</span> <span class="token punctuation">{</span>
      parameters<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"function"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      result<span class="token operator">:</span> <span class="token string">"void"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    start_long_operation<span class="token operator">:</span> <span class="token punctuation">{</span>
      parameters<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      result<span class="token operator">:</span> <span class="token string">"void"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    check_status<span class="token operator">:</span> <span class="token punctuation">{</span>
      parameters<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      result<span class="token operator">:</span> <span class="token string">"void"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> callback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Deno</span><span class="token punctuation">.</span><span class="token function">UnsafeCallback</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    parameters<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"u8"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    result<span class="token operator">:</span> <span class="token string">"void"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>success<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Pass the callback pointer to dynamic library</span>
library<span class="token punctuation">.</span>symbols<span class="token punctuation">.</span><span class="token function">set_status_callback</span><span class="token punctuation">(</span>callback<span class="token punctuation">.</span>pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Start some long operation that does not block the thread</span>
library<span class="token punctuation">.</span>symbols<span class="token punctuation">.</span><span class="token function">start_long_operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Later, trigger the library to check if the operation is done.</span>
<span class="token comment">// If it is, this call will trigger the callback.</span>
library<span class="token punctuation">.</span>symbols<span class="token punctuation">.</span><span class="token function">check_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>If an <code data-language="ts">UnsafeCallback</code>'s callback function throws an error, the error will get propagated up to the function that triggered the callback to be called (above, that would be <code data-language="ts">check_status()</code>) and can be caught there. If a callback returning a value throws then Deno will return 0 (null pointer for pointers) as the result.</p> <p><code data-language="ts">UnsafeCallback</code> is not deallocated by default as it can cause use-after-free bugs. To properly dispose of an <code data-language="ts">UnsafeCallback</code> its <code data-language="ts">close()</code> method must be called.</p> <div class="relative">
<pre class="language-typescript" tabindex="0"><code data-language="typescript"><span class="token keyword">const</span> callback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Deno</span><span class="token punctuation">.</span><span class="token function">UnsafeCallback</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> parameters<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> result<span class="token operator">:</span> <span class="token string">"void"</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// After callback is no longer needed</span>
callback<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// It is no longer safe to pass the callback as a parameter.</span>
</code></pre>   </div>
<p>It is also possible for native libraries to setup interrupt handlers and to have those directly trigger the callback. However, this is not recommended and may cause unexpected side-effects and undefined behaviour. Preferably any interrupt handlers would only set a flag that can later be polled similarly to how <code data-language="ts">check_status()</code> is used above.</p> <h3 id="supported-types" tabindex="-1">Supported types </h3> <p>Here's a list of types supported currently by the Deno FFI API.</p> <table> <thead> <tr> <th>FFI Type</th> <th>Deno</th> <th>C</th> <th>Rust</th> </tr> </thead> <tbody> <tr> <td><code data-language="ts">i8</code></td> <td><code data-language="ts">number</code></td> <td>
<code data-language="ts">char</code> / <code data-language="ts">signed char</code>
</td> <td><code data-language="ts">i8</code></td> </tr> <tr> <td><code data-language="ts">u8</code></td> <td><code data-language="ts">number</code></td> <td><code data-language="ts">unsigned char</code></td> <td><code data-language="ts">u8</code></td> </tr> <tr> <td><code data-language="ts">i16</code></td> <td><code data-language="ts">number</code></td> <td><code data-language="ts">short int</code></td> <td><code data-language="ts">i16</code></td> </tr> <tr> <td><code data-language="ts">u16</code></td> <td><code data-language="ts">number</code></td> <td><code data-language="ts">unsigned short int</code></td> <td><code data-language="ts">u16</code></td> </tr> <tr> <td><code data-language="ts">i32</code></td> <td><code data-language="ts">number</code></td> <td>
<code data-language="ts">int</code> / <code data-language="ts">signed int</code>
</td> <td><code data-language="ts">i32</code></td> </tr> <tr> <td><code data-language="ts">u32</code></td> <td><code data-language="ts">number</code></td> <td><code data-language="ts">unsigned int</code></td> <td><code data-language="ts">u32</code></td> </tr> <tr> <td><code data-language="ts">i64</code></td> <td><code data-language="ts">number | bigint</code></td> <td><code data-language="ts">long long int</code></td> <td><code data-language="ts">i64</code></td> </tr> <tr> <td><code data-language="ts">u64</code></td> <td><code data-language="ts">number | bigint</code></td> <td><code data-language="ts">unsigned long long int</code></td> <td><code data-language="ts">u64</code></td> </tr> <tr> <td><code data-language="ts">usize</code></td> <td><code data-language="ts">number | bigint</code></td> <td><code data-language="ts">size_t</code></td> <td><code data-language="ts">usize</code></td> </tr> <tr> <td><code data-language="ts">isize</code></td> <td><code data-language="ts">number | bigint</code></td> <td><code data-language="ts">size_t</code></td> <td><code data-language="ts">isize</code></td> </tr> <tr> <td><code data-language="ts">f32</code></td> <td><code data-language="ts">number | bigint</code></td> <td><code data-language="ts">float</code></td> <td><code data-language="ts">f32</code></td> </tr> <tr> <td><code data-language="ts">f64</code></td> <td><code data-language="ts">number | bigint</code></td> <td><code data-language="ts">double</code></td> <td><code data-language="ts">f64</code></td> </tr> <tr> <td>
<code data-language="ts">void</code>[1]</td> <td><code data-language="ts">undefined</code></td> <td><code data-language="ts">void</code></td> <td><code data-language="ts">()</code></td> </tr> <tr> <td><code data-language="ts">pointer</code></td> <td><code data-language="ts">{} | null</code></td> <td><code data-language="ts">void *</code></td> <td><code data-language="ts">*mut c_void</code></td> </tr> <tr> <td>
<code data-language="ts">buffer</code>[2]</td> <td><code data-language="ts">TypedArray | null</code></td> <td><code data-language="ts">uint8_t *</code></td> <td><code data-language="ts">*mut u8</code></td> </tr> <tr> <td>
<code data-language="ts">function</code>[3]</td> <td><code data-language="ts">{} | null</code></td> <td><code data-language="ts">void (*fun)()</code></td> <td><code data-language="ts">Option&lt;extern "C" fn()&gt;</code></td> </tr> <tr> <td>
<code data-language="ts">{ struct: [...] }</code>[4]</td> <td><code data-language="ts">TypedArray</code></td> <td><code data-language="ts">struct MyStruct</code></td> <td><code data-language="ts">MyStruct</code></td> </tr> </tbody> </table> <p>As of Deno 1.25, the <code data-language="ts">pointer</code> type has been split into a <code data-language="ts">pointer</code> and a <code data-language="ts">buffer</code> type to ensure users take advantage of optimizations for Typed Arrays, and as of Deno 1.31 the JavaScript representation of <code data-language="ts">pointer</code> has become an opaque pointer object or <code data-language="ts">null</code> for null pointers.</p> <ul> <li>[1] <code data-language="ts">void</code> type can only be used as a result type.</li> <li>[2] <code data-language="ts">buffer</code> type accepts TypedArrays as parameter, but it always returns a pointer object or <code data-language="ts">null</code> when used as result type like the <code data-language="ts">pointer</code> type.</li> <li>[3] <code data-language="ts">function</code> type works exactly the same as the <code data-language="ts">pointer</code> type as a parameter and result type.</li> <li>[4] <code data-language="ts">struct</code> type is for passing and returning C structs by value (copy). The <code data-language="ts">struct</code> array must enumerate each of the struct's fields' type in order. The structs are padded automatically: Packed structs can be defined by using an appropriate amount of <code data-language="ts">u8</code> fields to avoid padding. Only TypedArrays are supported as structs, and structs are always returned as <code data-language="ts">Uint8Array</code>s.</li> </ul> <h3 id="deno_bindgen" tabindex="-1">deno_bindgen </h3> <p><a href="https://github.com/denoland/deno_bindgen"><code data-language="ts">deno_bindgen</code></a> is the official tool to simplify glue code generation of Deno FFI libraries written in Rust.</p> <p>It is similar to <a href="https://github.com/rustwasm/wasm-bindgen"><code data-language="ts">wasm-bindgen</code></a> in the Rust Wasm ecosystem.</p> <p>Here's an example showing its usage:</p> <div class="relative">
<pre class="language-rust" tabindex="0"><code data-language="rust">// mul.rs
use deno_bindgen::deno_bindgen;

#[deno_bindgen]
struct Input {
  a: i32,
  b: i32,
}

#[deno_bindgen]
fn mul(input: Input) -&gt; i32 {
  input.a * input.b
}
</code></pre>   </div>
<p>Run <code data-language="ts">deno_bindgen</code> to generate bindings. You can now directly import them into Deno:</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token comment">// mul.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mul <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./bindings/bindings.ts"</span><span class="token punctuation">;</span>
<span class="token function">mul</span><span class="token punctuation">(</span><span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 20</span>
</code></pre>   </div>
<p>Any issues related to <code data-language="ts">deno_bindgen</code> should be reported at <a href="https://github.com/denoland/deno_bindgen/issues">https://github.com/denoland/deno_bindgen/issues</a></p> <h2 id="program-lifecycle" tabindex="-1">Program Lifecycle </h2> <p>Deno supports browser compatible lifecycle events:</p> <ul> <li>
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/load_event#:~:text=The%20load%20event%20is%20fired,for%20resources%20to%20finish%20loading."><code data-language="ts">load</code></a>: fired when the whole page has loaded, including all dependent resources such as stylesheets and images.</li> <li>
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/beforeunload_event#:~:text=The%20beforeunload%20event%20is%20fired,want%20to%20leave%20the%20page."><code data-language="ts">beforeunload</code></a>: fired when the event loop has no more work to do and is about to exit. Scheduling more asynchronous work (like timers or network requests) will cause the program to continue.</li> <li>
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/unload_event"><code data-language="ts">unload</code></a>: fired when the document or a child resource is being unloaded.</li> <li>
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/unhandledrejection_event"><code data-language="ts">unhandledrejection</code></a>: fired when a promise that has no rejection handler is rejected, ie. a promise that has no <code data-language="ts">.catch()</code> handler or a second argument to <code data-language="ts">.then()</code>.</li> <li>
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/rejectionhandled_event"><code data-language="ts">rejectionhandled</code></a>: fired when a <code data-language="ts">.catch()</code> handler is added to a a promise that has already rejected. This event is fired only if there's <code data-language="ts">unhandledrejection</code> listener installed that prevents propagation of the event (which would result in the program terminating with an error).</li> </ul> <p>You can use these events to provide setup and cleanup code in your program.</p> <p>Listeners for <code data-language="ts">load</code> events can be asynchronous and will be awaited, this event cannot be canceled. Listeners for <code data-language="ts">beforeunload</code> need to be synchronous and can be cancelled to keep the program running. Listeners for <code data-language="ts">unload</code> events need to be synchronous and cannot be cancelled.</p> <p><strong>main.ts</strong></p> <div>
<div class="markdownBlockTitle">main.ts</div>
<div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token keyword">import</span> <span class="token string">"./imported.ts"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Event<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">got </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> event in event handler (main)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

globalThis<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"load"</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

globalThis<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"beforeunload"</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

globalThis<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"unload"</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

globalThis<span class="token punctuation">.</span>onload <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Event<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">got </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> event in onload function (main)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

globalThis<span class="token punctuation">.</span>onbeforeunload <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Event<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">got </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> event in onbeforeunload function (main)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

globalThis<span class="token punctuation">.</span>onunload <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Event<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">got </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> event in onunload function (main)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"log from main script"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<div>
<div class="markdownBlockTitle">imported.ts</div>
<div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Event<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">got </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> event in event handler (imported)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

globalThis<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"load"</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
globalThis<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"beforeunload"</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
globalThis<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"unload"</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

globalThis<span class="token punctuation">.</span>onload <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Event<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">got </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> event in onload function (imported)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

globalThis<span class="token punctuation">.</span>onbeforeunload <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Event<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">got </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> event in onbeforeunload function (imported)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

globalThis<span class="token punctuation">.</span>onunload <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Event<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">got </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> event in onunload function (imported)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"log from imported script"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<p>A couple notes on this example:</p> <ul> <li>
<code data-language="ts">addEventListener</code> and <code data-language="ts">onload</code>/<code data-language="ts">onunload</code> are prefixed with <code data-language="ts">globalThis</code>, but you could also use <code data-language="ts">self</code> or no prefix at all. <a href="https://lint.deno.land/#no-window-prefix">It is not recommended to use <code data-language="ts">window</code> as a prefix</a>.</li> <li>You can use <code data-language="ts">addEventListener</code> and/or <code data-language="ts">onload</code>/<code data-language="ts">onunload</code> to define handlers for events. There is a major difference between them, let's run the example:</li> </ul> <div class="relative">
<pre class="language-shell" tabindex="0"><code data-language="shell">$ deno run main.ts
log from imported script
log from main script
got load event <span class="token keyword">in</span> event handler <span class="token punctuation">(</span>imported<span class="token punctuation">)</span>
got load event <span class="token keyword">in</span> event handler <span class="token punctuation">(</span>main<span class="token punctuation">)</span>
got load event <span class="token keyword">in</span> onload <span class="token keyword">function</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span>
got onbeforeunload event <span class="token keyword">in</span> event handler <span class="token punctuation">(</span>imported<span class="token punctuation">)</span>
got onbeforeunload event <span class="token keyword">in</span> event handler <span class="token punctuation">(</span>main<span class="token punctuation">)</span>
got onbeforeunload event <span class="token keyword">in</span> onbeforeunload <span class="token keyword">function</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span>
got unload event <span class="token keyword">in</span> event handler <span class="token punctuation">(</span>imported<span class="token punctuation">)</span>
got unload event <span class="token keyword">in</span> event handler <span class="token punctuation">(</span>main<span class="token punctuation">)</span>
got unload event <span class="token keyword">in</span> onunload <span class="token keyword">function</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span>
</code></pre>   </div>
<p>All listeners added using <code data-language="ts">addEventListener</code> were run, but <code data-language="ts">onload</code>, <code data-language="ts">onbeforeunload</code> and <code data-language="ts">onunload</code> defined in <code data-language="ts">main.ts</code> overrode handlers defined in <code data-language="ts">imported.ts</code>.</p> <p>In other words, you can use <code data-language="ts">addEventListener</code> to register multiple <code data-language="ts">"load"</code> or <code data-language="ts">"unload"</code> event handlers, but only the last defined <code data-language="ts">onload</code>, <code data-language="ts">onbeforeunload</code>, <code data-language="ts">onunload</code> event handlers will be executed. It is preferable to use <code data-language="ts">addEventListener</code> when possible for this reason.</p> <h3 id="beforeunload" tabindex="-1">beforeunload </h3> <div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js"><span class="token comment">// beforeunload.js</span>
<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>

globalThis<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"beforeunload"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"About to exit..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Scheduling more work..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  count<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

globalThis<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"unload"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Exiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

count<span class="token operator">++</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  count<span class="token operator">++</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>Running this program will print:</p> <div class="relative">
<pre class="language-sh" tabindex="0"><code data-language="sh">$ deno run beforeunload.js
<span class="token number">0</span>
<span class="token number">1</span>
<span class="token number">2</span>
About to exit<span class="token punctuation">..</span>.
Scheduling <span class="token function">more</span> work<span class="token punctuation">..</span>.
<span class="token number">3</span>
About to exit<span class="token punctuation">..</span>.
Scheduling <span class="token function">more</span> work<span class="token punctuation">..</span>.
<span class="token number">4</span>
About to exit<span class="token punctuation">..</span>.
Exiting
</code></pre>   </div>
<h3 id="unhandledrejection-event" tabindex="-1">unhandledrejection event </h3> <p>This event is fired when a promise that has no rejection handler is rejected, ie. a promise that has no .catch() handler or a second argument to .then().</p> <div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js"><span class="token comment">// unhandledrejection.js</span>
globalThis<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"unhandledrejection"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"unhandled rejection at:"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>promise<span class="token punctuation">,</span> <span class="token string">"reason:"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
  e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>bar <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"bar not available"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>Running this program will print:</p> <div class="relative">
<pre class="language-sh" tabindex="0"><code data-language="sh">$ deno run unhandledrejection.js
unhandled rejection at: Promise <span class="token punctuation">{</span>
  <span class="token operator">&lt;</span>rejected<span class="token operator">&gt;</span> Error: bar not available
    at new Foo <span class="token punctuation">(</span>file:///dev/unhandled_rejection.js:7:29<span class="token punctuation">)</span>
    at file:///dev/unhandled_rejection.js:10:1
<span class="token punctuation">}</span> reason: Error: bar not available
    at new Foo <span class="token punctuation">(</span>file:///dev/unhandled_rejection.js:7:29<span class="token punctuation">)</span>
    at file:///dev/unhandled_rejection.js:10:1
unhandled rejection at: Promise <span class="token punctuation">{</span> <span class="token operator">&lt;</span>rejected<span class="token operator">&gt;</span> undefined <span class="token punctuation">}</span> reason: undefined
</code></pre>   </div>
</div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2018–2024 the Deno authors<br>Licensed under the MIT License.<br>
    <a href="https://docs.deno.com/runtime/reference/deno_namespace_apis" class="_attribution-link">https://docs.deno.com/runtime/reference/deno_namespace_apis</a>
  </p>
</div>
