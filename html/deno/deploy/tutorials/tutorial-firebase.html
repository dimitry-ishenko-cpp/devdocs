<h1>API server with Firestore (Firebase)</h1>
<div>
<p>Firebase is a platform developed by Google for creating mobile and web applications. You can persist data on the platform using Firestore. In this tutorial let's take a look at how we can use it to build a small API that has endpoints to insert and retrieve information.</p> <ul> <li><a href="#overview">Overview</a></li> <li><a href="#concepts">Concepts</a></li> <li><a href="#setup-firebase">Setup Firebase</a></li> <li><a href="#write-the-application">Write the application</a></li> <li><a href="#deploy-the-application">Deploy the application</a></li> </ul> <h2 id="overview" tabindex="-1">Overview </h2> <p>We are going to build an API with a single endpoint that accepts <code data-language="ts">GET</code> and <code data-language="ts">POST</code> requests and returns a JSON payload of information:</p> <div class="relative">
<pre class="language-sh" tabindex="0"><code data-language="sh"><span class="token comment"># A GET request to the endpoint without any sub-path should return the details</span>
<span class="token comment"># of all songs in the store:</span>
GET /songs
<span class="token comment"># response</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    title: <span class="token string">"Song Title"</span>,
    artist: <span class="token string">"Someone"</span>,
    album: <span class="token string">"Something"</span>,
    released: <span class="token string">"1970"</span>,
    genres: <span class="token string">"country rap"</span>,
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

<span class="token comment"># A GET request to the endpoint with a sub-path to the title should return the</span>
<span class="token comment"># details of the song based on its title.</span>
GET /songs/Song%20Title <span class="token comment"># '%20' == space</span>
<span class="token comment"># response</span>
<span class="token punctuation">{</span>
  title: <span class="token string">"Song Title"</span>
  artist: <span class="token string">"Someone"</span>
  album: <span class="token string">"Something"</span>,
  released: <span class="token string">"1970"</span>,
  genres: <span class="token string">"country rap"</span>,
<span class="token punctuation">}</span>

<span class="token comment"># A POST request to the endpoint should insert the song details.</span>
POST /songs
<span class="token comment"># post request body</span>
<span class="token punctuation">{</span>
  title: <span class="token string">"A New Title"</span>
  artist: <span class="token string">"Someone New"</span>
  album: <span class="token string">"Something New"</span>,
  released: <span class="token string">"2020"</span>,
  genres: <span class="token string">"country rap"</span>,
<span class="token punctuation">}</span>
</code></pre>   </div>
<p>In this tutorial, we will be:</p> <ul> <li>Creating and setting up a <a href="https://console.firebase.google.com/">Firebase Project</a>.</li> <li>Using a text editor to create our application.</li> <li>Creating a <a href="https://gist.github.com/">gist</a> to "host" our application.</li> <li>Deploying our application on <a href="https://dash.deno.com/">Deno Deploy</a>.</li> <li>Testing our application using <a href="https://curl.se/">cURL</a>.</li> </ul> <h2 id="concepts" tabindex="-1">Concepts </h2> <p>There are a few concepts that help in understanding why we take a particular approach in the rest of the tutorial, and can help in extending the application. You can skip ahead to <a href="#setup-firebase">Setup Firebase</a> if you want.</p> <h3 id="deploy-is-browser-like" tabindex="-1">Deploy is browser-like </h3> <p>Even though Deploy runs in the cloud, in many aspects the APIs it provides are based on web standards. So when using Firebase, the Firebase APIs are more compatible with the web than those that are designed for server run times. That means we will be using the Firebase web libraries in this tutorial.</p> <h3 id="firebase-uses-xhr" tabindex="-1">Firebase uses XHR </h3> <p>Firebase uses a wrapper around Closure's <a href="https://google.github.io/closure-library/api/goog.net.WebChannel.html">WebChannel</a> and WebChannel was originally built around <a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest"><code data-language="ts">XMLHttpRequest</code></a>. While WebChannel supports the more modern <code data-language="ts">fetch()</code> API, current versions of Firebase for the web do not uniformly instantiate WebChannel with <code data-language="ts">fetch()</code> support, and instead use <code data-language="ts">XMLHttpRequest</code>.</p> <p>While Deploy is browser-like, it does not support <code data-language="ts">XMLHttpRequest</code>. <code data-language="ts">XMLHttpRequest</code> is a "legacy" browser API that has several limitations and features that would be difficult to implement in Deploy, which means it is unlikely that Deploy will ever implement that API.</p> <p>So, in this tutorial we will be using a limited <em>polyfill</em> that provides enough of the <code data-language="ts">XMLHttpRequest</code> feature set to allow Firebase/WebChannel to communicate with the server.</p> <h3 id="firebase-auth" tabindex="-1">Firebase auth </h3> <p>Firebase offers quite <a href="https://firebase.google.com/docs/auth">a few options</a> around authentication. In this tutorial we are going to be using email and password authentication.</p> <p>When a user is logged in, Firebase can persist that authentication. Because we are using the web libraries for Firebase, persisting the authentication allows a user to navigate away from a page and not need to re-log in when returning. Firebase allows authentication to be persisted in local storage, session storage or none.</p> <p>In a Deploy context, it is a little different. A Deploy deployment will remain "active" meaning that in-memory state will be present from request to request on some requests, but under various conditions a new deployment can be started up or shutdown. Currently, Deploy doesn't offer any persistence outside of in-memory allocation. In addition it doesn't currently offer the global <code data-language="ts">localStorage</code> or <code data-language="ts">sessionStorage</code>, which is what is used by Firebase to store the authentication information.</p> <p>In order to reduce the need to re-authenticate but also ensure that we can support multiple-users with a single deployment, we are going to use a polyfill that will allow us to provide a <code data-language="ts">localStorage</code> interface to Firebase, but store the information as a cookie in the client.</p> <h2 id="setup-firebase" tabindex="-1">Setup Firebase </h2> <p><a href="https://firebase.google.com/">Firebase</a> is a feature rich platform. All the details of Firebase administration are beyond the scope of this tutorial. We will cover what it needed for this tutorial.</p> <ol> <li> <p>Create a new project under the <a href="https://console.firebase.google.com/">Firebase console</a>.</p> </li> <li> <p>Add a web application to your project. Make note of the <code data-language="ts">firebaseConfig</code> provided in the setup wizard. It should look something like the below. We will use this later:</p> <div>
<div class="markdownBlockTitle">firebase.js</div>
<div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js"><span class="token keyword">var</span> firebaseConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">apiKey</span><span class="token operator">:</span> <span class="token string">"APIKEY"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">authDomain</span><span class="token operator">:</span> <span class="token string">"example-12345.firebaseapp.com"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">projectId</span><span class="token operator">:</span> <span class="token string">"example-12345"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">storageBucket</span><span class="token operator">:</span> <span class="token string">"example-12345.appspot.com"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">messagingSenderId</span><span class="token operator">:</span> <span class="token string">"1234567890"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">appId</span><span class="token operator">:</span> <span class="token string">"APPID"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
</li> <li> <p>Under <code data-language="ts">Authentication</code> in the administration console for, you will want to enable the <code data-language="ts">Email/Password</code> sign-in method.</p> </li> <li> <p>You will want to add a user and password under <code data-language="ts">Authentication</code> and then <code data-language="ts">Users</code> section, making note of the values used for later.</p> </li> <li> <p>Add <code data-language="ts">Firestore Database</code> to your project. The console will allow you to setup in <em>production mode</em> or <em>test mode</em>. It is up to you how you configure this, but <em>production mode</em> will require you to setup further security rules.</p> </li> <li> <p>Add a collection to the database named <code data-language="ts">songs</code>. This will require you to add at least one document. Just set the document with an <em>Auto ID</em>.</p> </li> </ol> <p><em>Note</em> depending on the status of your Google account, there maybe other setup and administration steps that need to occur.</p> <h2 id="write-the-application" tabindex="-1">Write the application </h2> <p>We want to create our application as a JavaScript file in our favorite editor.</p> <p>The first thing we will do is import the <code data-language="ts">XMLHttpRequest</code> polyfill that Firebase needs to work under Deploy as well as a polyfill for <code data-language="ts">localStorage</code> to allow the Firebase auth to persist logged in users:</p> <div>
<div class="markdownBlockTitle">firebase.js</div>
<div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js"><span class="token keyword">import</span> <span class="token string">"https://deno.land/x/xhr@0.1.1/mod.ts"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> installGlobals <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"https://deno.land/x/virtualstorage@0.1.0/mod.ts"</span><span class="token punctuation">;</span>
<span class="token function">installGlobals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<blockquote> <p>ℹ️ we are using the current version of packages at the time of the writing of this tutorial. They may not be up-to-date and you may want to double check current versions.</p> </blockquote> <p>Because Deploy has a lot of the web standard APIs, it is best to use the web libraries for Firebase under deploy. Currently v9 is in still in beta for Firebase, so we will use v8 in this tutorial:</p> <div>
<div class="markdownBlockTitle">firebase.js</div>
<div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js"><span class="token keyword">import</span> firebase <span class="token keyword">from</span> <span class="token string">"https://esm.sh/firebase@8.7.0/app"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"https://esm.sh/firebase@8.7.0/auth"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"https://esm.sh/firebase@8.7.0/firestore"</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<p>We are also going to use <a href="https://deno.land/x/oak">oak</a> as the middleware framework for creating the APIs, including middleware that will take the <code data-language="ts">localStorage</code> values and set them as client cookies:</p> <div>
<div class="markdownBlockTitle">firebase.js</div>
<div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js"><span class="token keyword">import</span> <span class="token punctuation">{</span>
  Application<span class="token punctuation">,</span>
  Router<span class="token punctuation">,</span>
  Status<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"https://deno.land/x/oak@v7.7.0/mod.ts"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> virtualStorage <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"https://deno.land/x/virtualstorage@0.1.0/middleware.ts"</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<p>Now we need to setup our Firebase application. We will be getting the configuration from environment variables we will setup later under the key <code data-language="ts">FIREBASE_CONFIG</code> and get references to the parts of Firebase we are going to use:</p> <div>
<div class="markdownBlockTitle">firebase.js</div>
<div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js"><span class="token keyword">const</span> firebaseConfig <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>Deno<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"FIREBASE_CONFIG"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> firebaseApp <span class="token operator">=</span> firebase<span class="token punctuation">.</span><span class="token function">initializeApp</span><span class="token punctuation">(</span>firebaseConfig<span class="token punctuation">,</span> <span class="token string">"example"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> auth <span class="token operator">=</span> firebase<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span>firebaseApp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> firebase<span class="token punctuation">.</span><span class="token function">firestore</span><span class="token punctuation">(</span>firebaseApp<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<p>We are also going to setup the application to handle signed in users per request. So we will create a map of users that we have previously signed in in this deployment. While in this tutorial we will only ever have one signed in user, the code can easily be adapted to allow clients to sign-in individually:</p> <div>
<div class="markdownBlockTitle">firebase.js</div>
<div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js"><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<p>Let's create our middleware router and create three different middleware handlers to support <code data-language="ts">GET</code> and <code data-language="ts">POST</code> of <code data-language="ts">/songs</code> and a <code data-language="ts">GET</code> of a specific song on <code data-language="ts">/songs/{title}</code>:</p> <div>
<div class="markdownBlockTitle">firebase.js</div>
<div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js"><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Returns any songs in the collection</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/songs"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> querySnapshot <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">"songs"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> querySnapshot<span class="token punctuation">.</span>docs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> doc<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">"json"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Returns the first document that matches the title</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/songs/:title"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> title <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
  <span class="token keyword">const</span> querySnapshot <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">"songs"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token string">"=="</span><span class="token punctuation">,</span> title<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> song <span class="token operator">=</span> querySnapshot<span class="token punctuation">.</span>docs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> doc<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>song<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The song titled "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" was not found.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">"text"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> querySnapshot<span class="token punctuation">.</span>docs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> doc<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">"json"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">isSong</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">"object"</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token string">"title"</span> <span class="token keyword">in</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Removes any songs with the same title and adds the new song</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/songs"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>body<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">"json"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span>Status<span class="token punctuation">.</span>BadRequest<span class="token punctuation">,</span> <span class="token string">"Must be a JSON document"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> song <span class="token operator">=</span> <span class="token keyword">await</span> body<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSong</span><span class="token punctuation">(</span>song<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span>Status<span class="token punctuation">.</span>BadRequest<span class="token punctuation">,</span> <span class="token string">"Payload was not well formed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> querySnapshot <span class="token operator">=</span> <span class="token keyword">await</span> db
    <span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">"songs"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token string">"=="</span><span class="token punctuation">,</span> song<span class="token punctuation">.</span>title<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>querySnapshot<span class="token punctuation">.</span>docs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> doc<span class="token punctuation">.</span>ref<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> songsRef <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">"songs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> songsRef<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>song<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status <span class="token operator">=</span> Status<span class="token punctuation">.</span>NoContent<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<p>Ok, we are almost done. We just need to create our middleware application, and add the <code data-language="ts">localStorage</code> middleware we imported:</p> <div>
<div class="markdownBlockTitle">firebase.js</div>
<div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Application</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">virtualStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<p>And then we need to add middleware to authenticate the user. In this tutorial we are simply grabbing the username and password from the environment variables we will be setting up, but this could easily be adapted to redirect a user to a sign-in page if they are not logged in:</p> <div>
<div class="markdownBlockTitle">firebase.js</div>
<div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> signedInUid <span class="token operator">=</span> ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"LOGGED_IN_UID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> signedInUser <span class="token operator">=</span> signedInUid <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> users<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>signedInUid<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>signedInUid <span class="token operator">||</span> <span class="token operator">!</span>signedInUser <span class="token operator">||</span> <span class="token operator">!</span>auth<span class="token punctuation">.</span>currentUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> creds <span class="token operator">=</span> <span class="token keyword">await</span> auth<span class="token punctuation">.</span><span class="token function">signInWithEmailAndPassword</span><span class="token punctuation">(</span>
      Deno<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"FIREBASE_USERNAME"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Deno<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"FIREBASE_PASSWORD"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> user <span class="token punctuation">}</span> <span class="token operator">=</span> creds<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      users<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"LOGGED_IN_UID"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>signedInUser <span class="token operator">&amp;&amp;</span> signedInUid<span class="token punctuation">.</span>uid <span class="token operator">!==</span> auth<span class="token punctuation">.</span>currentUser<span class="token operator">?.</span>uid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> auth<span class="token punctuation">.</span><span class="token function">updateCurrentUser</span><span class="token punctuation">(</span>signedInUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<p>Now let's add our router to the middleware application and set the application to listen on port 8000:</p> <div>
<div class="markdownBlockTitle">firebase.js</div>
<div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">8000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<p>Now we have an application that should serve up our APIs.</p> <h2 id="deploy-the-application" tabindex="-1">Deploy the Application </h2> <p>Now that we have everything in place, let's deploy your new application!</p> <ol> <li>In your browser, visit <a href="https://dash.deno.com/new_project">Deno Deploy</a> and link your GitHub account.</li> <li>Select the repository which contains your new application.</li> <li>You can give your project a name or allow Deno to generate one for you</li> <li>Select <code data-language="ts">firebase.js</code> in the Entrypoint dropdown</li> <li>Click <strong>Deploy Project</strong>
</li> </ol> <p>In order for your Application to work, we will need to configure its environment variables.</p> <p>On your project's success page, or in your project dashboard, click on <strong>Add environmental variables</strong>. Under Environment Variables, click <strong>+ Add Variable</strong>. Create the following variables:</p> <ol> <li>
<code data-language="ts">FIREBASE_USERNAME</code> - The Firebase user (email address) that was added above</li> <li>
<code data-language="ts">FIREBASE_PASSWORD</code> - The Firebase user password that was added above</li> <li>
<code data-language="ts">FIREBASE_CONFIG</code> - The configuration of the Firebase application as a string of JSON</li> </ol> <p>The configuration needs to be a valid JSON string to be readable by the application. If the code snippet given when setting up looked like this:</p> <div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js"><span class="token keyword">var</span> firebaseConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">apiKey</span><span class="token operator">:</span> <span class="token string">"APIKEY"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">authDomain</span><span class="token operator">:</span> <span class="token string">"example-12345.firebaseapp.com"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">projectId</span><span class="token operator">:</span> <span class="token string">"example-12345"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">storageBucket</span><span class="token operator">:</span> <span class="token string">"example-12345.appspot.com"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">messagingSenderId</span><span class="token operator">:</span> <span class="token string">"1234567890"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">appId</span><span class="token operator">:</span> <span class="token string">"APPID"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>You would need to set the value of the string to this (noting that spacing and new lines are not required):</p> <div class="relative">
<pre class="language-json" tabindex="0"><code data-language="json"><span class="token punctuation">{</span>
  <span class="token property">"apiKey"</span><span class="token operator">:</span> <span class="token string">"APIKEY"</span><span class="token punctuation">,</span>
  <span class="token property">"authDomain"</span><span class="token operator">:</span> <span class="token string">"example-12345.firebaseapp.com"</span><span class="token punctuation">,</span>
  <span class="token property">"projectId"</span><span class="token operator">:</span> <span class="token string">"example-12345"</span><span class="token punctuation">,</span>
  <span class="token property">"storageBucket"</span><span class="token operator">:</span> <span class="token string">"example-12345.appspot.com"</span><span class="token punctuation">,</span>
  <span class="token property">"messagingSenderId"</span><span class="token operator">:</span> <span class="token string">"1234567890"</span><span class="token punctuation">,</span>
  <span class="token property">"appId"</span><span class="token operator">:</span> <span class="token string">"APPID"</span>
<span class="token punctuation">}</span>
</code></pre>   </div>
<p>Click to save the variables.</p> <p>Now let's take our API for a spin.</p> <p>We can create a new song:</p> <div class="relative">
<pre class="language-sh" tabindex="0"><code data-language="sh"><span class="token function">curl</span> <span class="token parameter variable">--request</span> POST <span class="token punctuation">\</span>
  <span class="token parameter variable">--header</span> <span class="token string">"Content-Type: application/json"</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--data</span> <span class="token string">'{"title": "Old Town Road", "artist": "Lil Nas X", "album": "7", "released": "2019", "genres": "Country rap, Pop"}'</span> <span class="token punctuation">\</span>
  --dump-header <span class="token punctuation">\</span>
  - https://<span class="token operator">&lt;</span>project_name<span class="token operator">&gt;</span>.deno.dev/songs
</code></pre>   </div>
<p>And we can get all the songs in our collection:</p> <div class="relative">
<pre class="language-sh" tabindex="0"><code data-language="sh"><span class="token function">curl</span> https://<span class="token operator">&lt;</span>project_name<span class="token operator">&gt;</span>.deno.dev/songs
</code></pre>   </div>
<p>And we get specific information about a title we created:</p> <div class="relative">
<pre class="language-sh" tabindex="0"><code data-language="sh"><span class="token function">curl</span> https://<span class="token operator">&lt;</span>project_name<span class="token operator">&gt;</span>.deno.dev/songs/Old%20Town%20Road
</code></pre>   </div>
</div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2018–2024 the Deno authors<br>Licensed under the MIT License.<br>
    <a href="https://docs.deno.com/deploy/tutorials/tutorial-firebase" class="_attribution-link">https://docs.deno.com/deploy/tutorials/tutorial-firebase</a>
  </p>
</div>
