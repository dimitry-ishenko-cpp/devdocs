<h1>Transactions</h1>
<div>
<p><deno-admonition></deno-admonition></p> <p>The Deno KV store utilizes <em>optimistic concurrency control transactions</em> rather than <em>interactive transactions</em> like many SQL systems like PostgreSQL or MySQL. This approach employs versionstamps, which represent the current version of a value for a given key, to manage concurrent access to shared resources without using locks. When a read operation occurs, the system returns a versionstamp for the associated key in addition to the value.</p> <p>To execute a transaction, one performs an atomic operations that can consist of multiple mutation actions (like set or delete). Along with these actions, key+versionstamp pairs are provided as a condition for the transaction's success. The optimistic concurrency control transaction will only commit if the specified versionstamps match the current version for the values in the database for the corresponding keys. This transaction model ensures data consistency and integrity while allowing concurrent interactions within the Deno KV store.</p> <p>Because OCC transactions are optimistic, they can fail on commit because the version constraints specified in the atomic operation were violated. This occurs when an agent updates a key used within the transaction between read and commit. When this happens, the agent performing the transaction must retry the transaction.</p> <p>To illustrate how to use OCC transactions with Deno KV, this example shows how to implement a <code data-language="ts">transferFunds(from: string, to: string, amount: number)</code> function for an account ledger. The account ledger stores the balance for each account in the key-value store. The keys are prefixed by <code data-language="ts">"account"</code>, followed by the account identifier: <code data-language="ts">["account", "alice"]</code>. The value stored for each key is a number that represents the account balance.</p> <p>Here's a step-by-step example of implementing this <code data-language="ts">transferFunds</code> function:</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">transferFunds</span><span class="token punctuation">(</span>sender<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> receiver<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> amount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>amount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Amount must be positive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Construct the KV keys for the sender and receiver accounts.</span>
  <span class="token keyword">const</span> senderKey <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"account"</span><span class="token punctuation">,</span> sender<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> receiverKey <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"account"</span><span class="token punctuation">,</span> receiver<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// Retry the transaction until it succeeds.</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token punctuation">{</span> ok<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Read the current balance of both accounts.</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>senderRes<span class="token punctuation">,</span> receiverRes<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> kv<span class="token punctuation">.</span><span class="token function">getMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>senderKey<span class="token punctuation">,</span> receiverKey<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>senderRes<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Account </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sender<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>receiverRes<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Account </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>receiver<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> senderBalance <span class="token operator">=</span> senderRes<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token keyword">const</span> receiverBalance <span class="token operator">=</span> receiverRes<span class="token punctuation">.</span>value<span class="token punctuation">;</span>

    <span class="token comment">// Ensure the sender has a sufficient balance to complete the transfer.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>senderBalance <span class="token operator">&lt;</span> amount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Insufficient funds to transfer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>amount<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sender<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Perform the transfer.</span>
    <span class="token keyword">const</span> newSenderBalance <span class="token operator">=</span> senderBalance <span class="token operator">-</span> amount<span class="token punctuation">;</span>
    <span class="token keyword">const</span> newReceiverBalance <span class="token operator">=</span> receiverBalance <span class="token operator">+</span> amount<span class="token punctuation">;</span>

    <span class="token comment">// Attempt to commit the transaction. `res` returns an object with</span>
    <span class="token comment">// `ok: false` if the transaction fails to commit due to a check failure</span>
    <span class="token comment">// (i.e. the versionstamp for a key has changed)</span>
    res <span class="token operator">=</span> <span class="token keyword">await</span> kv<span class="token punctuation">.</span><span class="token function">atomic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>senderRes<span class="token punctuation">)</span> <span class="token comment">// Ensure the sender's balance hasn't changed.</span>
      <span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>receiverRes<span class="token punctuation">)</span> <span class="token comment">// Ensure the receiver's balance hasn't changed.</span>
      <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>senderKey<span class="token punctuation">,</span> newSenderBalance<span class="token punctuation">)</span> <span class="token comment">// Update the sender's balance.</span>
      <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>receiverKey<span class="token punctuation">,</span> newReceiverBalance<span class="token punctuation">)</span> <span class="token comment">// Update the receiver's balance.</span>
      <span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>   </div>
<p>In this example, the <code data-language="ts">transferFunds</code> function reads the balances and versionstamps of both accounts, calculates the new balances after the transfer, and checks if there are sufficient funds in account A. It then performs an atomic operation, setting the new balances with the versionstamp constraints. If the transaction is successful, the loop exits. If the version constraints are violated, the transaction fails, and the loop retries the transaction until it succeeds.</p> <h2 id="limits" tabindex="-1">Limits </h2> <p>In addition to a max key size of 2 KiB and max value size of 64 KiB, there are certain limits with the Deno KV transaction API:</p> <ul> <li>
<strong>Max keys per <code data-language="ts">kv.getMany()</code></strong>: 10</li> <li>
<strong>Max batch size per <code data-language="ts">kv.list()</code></strong>: 1000</li> <li>
<strong>Max checks in an atomic operation</strong>: 100</li> <li>
<strong>Max mutations in an atomic operation</strong>: 1000</li> <li>
<strong>Max total size of an atomic operation</strong>: 800 KiB. This includes all keys and values in checks and mutations, and encoding overhead counts toward this limit as well.</li> <li>
<strong>Max total size of keys</strong>: 90 KiB. This includes all keys in checks and mutations, and encoding overhead counts toward this limit as well.</li> <li>
<strong>Max watched keys per <code data-language="ts">kv.watch()</code></strong>：10</li> </ul> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2018–2024 the Deno authors<br>Licensed under the MIT License.<br>
    <a href="https://docs.deno.com/deploy/kv/manual/transactions" class="_attribution-link">https://docs.deno.com/deploy/kv/manual/transactions</a>
  </p>
</div>
