<h1>Using Queues</h1>
<div>
<p><deno-admonition></deno-admonition></p> <p>The Deno runtime includes a queueing API that supports offloading larger workloads for async processing, with guaranteed at-least-once delivery of queued messages. Queues can be used to offload tasks in a web application, or to schedule units of work for a time in the future.</p> <p>The primary APIs you'll use with queues are in the <code data-language="ts">Deno.Kv</code> namespace as <a href="../../../api/deno/~/deno.kv.prototype.enqueue.html"><code data-language="ts">enqueue</code></a> and <a href="../../../api/deno/~/deno.kv.prototype.listenqueue.html"><code data-language="ts">listenQueue</code></a>.</p> <h2 id="enqueue-a-message" tabindex="-1">Enqueue a message </h2> <p>To enqueue a message for processing, use the <code data-language="ts">enqueue</code> method on an instance of <a href="../../../api/deno/~/deno.kv.html"><code data-language="ts">Deno.Kv</code></a>. In the example below, we show what it might look like to enqueue a notification for delivery.</p> <div>
<div class="markdownBlockTitle">queue_example.ts</div>
<div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token comment">// Describe the shape of your message object (optional)</span>
<span class="token keyword">interface</span> <span class="token class-name">Notification</span> <span class="token punctuation">{</span>
  forUser<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  body<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Get a reference to a KV instance</span>
<span class="token keyword">const</span> kv <span class="token operator">=</span> <span class="token keyword">await</span> Deno<span class="token punctuation">.</span><span class="token function">openKv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create a notification object</span>
<span class="token keyword">const</span> message<span class="token operator">:</span> Notification <span class="token operator">=</span> <span class="token punctuation">{</span>
  forUser<span class="token operator">:</span> <span class="token string">"alovelace"</span><span class="token punctuation">,</span>
  body<span class="token operator">:</span> <span class="token string">"You've got mail!"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Enqueue the message for immediate delivery</span>
<span class="token keyword">await</span> kv<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<p>You can enqueue a message for later delivery by specifying a <code data-language="ts">delay</code> option in milliseconds.</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token comment">// Enqueue the message for delivery in 3 days</span>
<span class="token keyword">const</span> delay <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> kv<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token punctuation">{</span> delay <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>You can also specify a key in Deno KV where your message value will be stored if your message isn't delivered for any reason.</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token comment">// Configure a key where a failed message would be sent</span>
<span class="token keyword">const</span> backupKey <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"failed_notifications"</span><span class="token punctuation">,</span> <span class="token string">"alovelace"</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> kv<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token punctuation">{</span> keysIfUndelivered<span class="token operator">:</span> <span class="token punctuation">[</span>backupKey<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ... disaster strikes ...</span>

<span class="token comment">// Get the unsent message</span>
<span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token keyword">await</span> kv<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span>Notification<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>backupKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// This is the message that didn't get sent:</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Found failed notification for:"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>value<span class="token operator">?.</span>forUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
<h2 id="listening-for-messages" tabindex="-1">Listening for messages </h2> <p>You can configure a JavaScript function that will process items added to your queue with the <code data-language="ts">listenQueue</code> method on an instance of <a href="../../../api/deno/~/deno.kv.html"><code data-language="ts">Deno.Kv</code></a>.</p> <div>
<div class="markdownBlockTitle">listen_example.ts</div>
<div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token comment">// Define the shape of the object we expect as a message in the queue</span>
<span class="token keyword">interface</span> <span class="token class-name">Notification</span> <span class="token punctuation">{</span>
  forUser<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  body<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Create a type guard to check the type of the incoming message</span>
<span class="token keyword">function</span> <span class="token function">isNotification</span><span class="token punctuation">(</span>o<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> o <span class="token keyword">is</span> Notification <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span>o <span class="token keyword">as</span> Notification<span class="token punctuation">)</span><span class="token operator">?.</span>forUser <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">typeof</span> <span class="token punctuation">(</span>o <span class="token keyword">as</span> Notification<span class="token punctuation">)</span><span class="token punctuation">.</span>forUser <span class="token operator">===</span> <span class="token string">"string"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span>o <span class="token keyword">as</span> Notification<span class="token punctuation">)</span><span class="token operator">?.</span>body <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">typeof</span> <span class="token punctuation">(</span>o <span class="token keyword">as</span> Notification<span class="token punctuation">)</span><span class="token punctuation">.</span>body <span class="token operator">===</span> <span class="token string">"string"</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Get a reference to a KV database</span>
<span class="token keyword">const</span> kv <span class="token operator">=</span> <span class="token keyword">await</span> Deno<span class="token punctuation">.</span><span class="token function">openKv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Register a handler function to listen for values - this example shows</span>
<span class="token comment">// how you might send a notification</span>
kv<span class="token punctuation">.</span><span class="token function">listenQueue</span><span class="token punctuation">(</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Use type guard - then TypeScript compiler knows msg is a Notification</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNotification</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Sending notification to user:"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>forUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ... do something to actually send the notification!</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// If the message is of an unknown type, it might be an error</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Unknown message received:"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<h2 id="queue-api-with-kv-atomic-transactions" tabindex="-1">Queue API with KV atomic transactions </h2> <p>You can combine the queue API with <a href="transactions.html">KV atomic transactions</a> to atomically enqueue messages and modify keys in the same transaction.</p> <div>
<div class="markdownBlockTitle">kv_transaction_example.ts</div>
<div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token keyword">const</span> kv <span class="token operator">=</span> <span class="token keyword">await</span> Deno<span class="token punctuation">.</span><span class="token function">openKv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

kv<span class="token punctuation">.</span><span class="token function">listenQueue</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>msg<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> nonce <span class="token operator">=</span> <span class="token keyword">await</span> kv<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"nonces"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>nonce<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nonce<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This messaged was already processed</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> change <span class="token operator">=</span> msg<span class="token punctuation">.</span>change<span class="token punctuation">;</span>
  <span class="token keyword">const</span> bob <span class="token operator">=</span> <span class="token keyword">await</span> kv<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">,</span> <span class="token string">"bob"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> liz <span class="token operator">=</span> <span class="token keyword">await</span> kv<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">,</span> <span class="token string">"liz"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> success <span class="token operator">=</span> <span class="token keyword">await</span> kv<span class="token punctuation">.</span><span class="token function">atomic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// Ensure this message was not yet processed</span>
    <span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token operator">:</span> nonce<span class="token punctuation">.</span>key<span class="token punctuation">,</span> versionstamp<span class="token operator">:</span> nonce<span class="token punctuation">.</span>versionstamp <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>nonce<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"processed_count"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1n</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>bob<span class="token punctuation">,</span> liz<span class="token punctuation">)</span> <span class="token comment">// balances did not change</span>
    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">,</span> <span class="token string">"bob"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bob<span class="token punctuation">.</span>value <span class="token operator">-</span> change<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"balance"</span><span class="token punctuation">,</span> <span class="token string">"liz"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> liz<span class="token punctuation">.</span>value <span class="token operator">+</span> change<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Modify keys and enqueue messages in the same KV transaction!</span>
<span class="token keyword">const</span> nonce <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> kv
  <span class="token punctuation">.</span><span class="token function">atomic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"nonces"</span><span class="token punctuation">,</span> nonce<span class="token punctuation">]</span><span class="token punctuation">,</span> versionstamp<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token punctuation">{</span> nonce<span class="token operator">:</span> nonce<span class="token punctuation">,</span> change<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"nonces"</span><span class="token punctuation">,</span> nonce<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"enqueued_count"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1n</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
</div>
<h2 id="queue-behavior" tabindex="-1">Queue behavior </h2> <h3 id="message-delivery-guarantees" tabindex="-1">Message delivery guarantees </h3> <p>The runtime guarantees at-least-once delivery. This means that for majority of enqueued messages, the <a href="../../../api/deno/~/deno.kv.prototype.listenqueue.html"><code data-language="ts">listenQueue</code></a> handler will be invoked once for each message. In some failure scenarios, the handler may be invoked multiple times for the same message to ensure delivery. It's important to design your applications such that duplicate messages are handled correctly.</p> <p>You may use queues in combination with <a href="transactions.html">KV atomic transactions</a> primitives to ensure that your queue handler KV updates are performed exactly once per message. See <a href="#queue-api-with-kv-atomic-transactions">Queue API with KV atomic transactions</a>.</p> <h3 id="automatic-retries" tabindex="-1">Automatic retries </h3> <p><a href="../../../api/deno/~/deno.kv.prototype.listenqueue.html"><code data-language="ts">listenQueue</code></a> handler is invoked to process your queued messages when they're ready for delivery. If your handler throws an exception the runtime will automatically retry to call the handler again until it succeeds or until maximum retry attempts are reached. The message is considered to be successfully processed once the <a href="../../../api/deno/~/deno.kv.prototype.listenqueue.html"><code data-language="ts">listenQueue</code></a> handler invocation completes successfully. The message will be dropped if the handler consistently fails on retries.</p> <h3 id="message-delivery-order" tabindex="-1">Message delivery order </h3> <p>The runtime makes best effort to deliver messages in the order they were enqueued. However, there is not strict order guarantee. Occasionally, messages may be delivered out of order to ensure maximum throughput.</p> <h2 id="queues-on-deno-deploy" tabindex="-1">Queues on Deno Deploy </h2> <p>Deno Deploy offers global, serverless, distributed implementation of the queueing API, designed for high availability and throughput. You can use it to build applications that scale to handle large workloads.</p> <h3 id="just-in-time-isolate-spin-up" tabindex="-1">Just-in-time isolate spin-up </h3> <p>When using queues with Deno Deploy, isolates are automatically spun up on demand to invoke your <a href="../../../api/deno/~/deno.kv.prototype.listenqueue.html"><code data-language="ts">listenQueue</code></a> handler when a message becomes available for processing. Defining <a href="../../../api/deno/~/deno.kv.prototype.listenqueue.html"><code data-language="ts">listenQueue</code></a> handler is the only requirement to enable queue processing in your Deno Deploy application, no additional configuration is needed.</p> <h3 id="queue-size-limit" tabindex="-1">Queue size limit </h3> <p>The maximum number of undelivered queue messages is limited to 100,000. <a href="../../../api/deno/~/deno.kv.prototype.enqueue.html"><code data-language="ts">enqueue</code></a> method will fail with an error if the queue is full.</p> <h3 id="pricing-details-and-limits" tabindex="-1">Pricing details and limits </h3> <ul> <li>
<a href="../../../api/deno/~/deno.kv.prototype.enqueue.html"><code data-language="ts">enqueue</code></a> is treated just like other <a href="../../../api/deno/~/deno.kv.html"><code data-language="ts">Deno.Kv</code></a> write operations. Enqueued messages consume KV storage and write units.</li> <li>Messages delivered through <a href="../../../api/deno/~/deno.kv.prototype.listenqueue.html"><code data-language="ts">listenQueue</code></a> consume requests and KV write units.</li> <li>See <a href="https://deno.com/deploy/pricing">Pricing details</a> for more information.</li> </ul> <h2 id="use-cases" tabindex="-1">Use cases </h2> <p>Queues can be useful in many different scenarios, but there are a few use cases you might see a lot when building web applications.</p> <h3 id="offloading-async-processes" tabindex="-1">Offloading async processes </h3> <p>Sometimes a task that's initiated by a client (like sending a notification or API request), may take long enough where you don't want to make clients wait for that task to be completed before returning a response. Other times, clients don't actually need a response at all, such as when a client is sending your application a <a href="https://en.wikipedia.org/wiki/Webhook">webhook request</a>, so there's no need to wait for the underlying task to be completed before returning a response.</p> <p>In these cases, you can offload work to a queue to keep your web application responsive and send immediate feedback to clients. To see an example of this use case in action, check out our <a href="../tutorials/webhook_processor.html">webhook processing example</a>.</p> <h3 id="scheduling-work-for-the-future" tabindex="-1">Scheduling work for the future </h3> <p>Another helpful application of queues (and queue APIs like this one), is to schedule work to happen at an appropriate time in the future. Maybe you'd like to send a notification to a new customer a day after they have placed an order to send them a satisfaction survey. You can schedule a queue message to be delivered 24 hours into the future, and set up a listener to send out the notification at that time.</p> <p>To see an example of scheduling a notification to go out in the future, check out our <a href="../tutorials/schedule_notification.html">notification example</a>.</p> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2018â€“2024 the Deno authors<br>Licensed under the MIT License.<br>
    <a href="https://docs.deno.com/deploy/kv/manual/queue_overview" class="_attribution-link">https://docs.deno.com/deploy/kv/manual/queue_overview</a>
  </p>
</div>
