<h1>Key Space</h1>
<div>
<p><deno-admonition></deno-admonition></p> <p>Deno KV is a key value store. The key space is a flat namespace of key+value+versionstamp pairs. Keys are sequences of key parts, which allow modeling of hierarchical data. Values are arbitrary JavaScript objects. Versionstamps represent when a value was inserted / modified.</p> <h2 id="keys" tabindex="-1">Keys </h2> <p>Keys in Deno KV are sequences of key parts, which can be <code data-language="ts">string</code>s, <code data-language="ts">number</code>s, <code data-language="ts">boolean</code>s, <code data-language="ts">Uint8Array</code>s, or <code data-language="ts">bigint</code>s.</p> <p>Using a sequence of parts, rather than a single string eliminates the possibility of delimiter injection attacks, because there is no visible delimiter.</p> <blockquote> <p>A key injection attack occurs when an attacker manipulates the structure of a key-value store by injecting delimiters used in the key encoding scheme into a user controlled variable, leading to unintended behavior or unauthorized access. For example, consider a key-value store using a slash (/) as a delimiter, with keys like "users/alice/settings" and "users/bob/settings". An attacker could create a new user with the name "alice/settings/hacked" to form the key "users/alice/settings/hacked/settings", injecting the delimiter and manipulating the key structure. In Deno KV, the injection would result in the key <code data-language="ts">["users", "alice/settings/hacked", "settings"]</code>, which is not harmful.</p> </blockquote> <p>Between key parts, invisible delimiters are used to separate the parts. These delimiters are never visible, but ensure that one part can not be confused with another part. For example, the key parts <code data-language="ts">["abc", "def"]</code>, <code data-language="ts">["ab", "cdef"]</code>, <code data-language="ts">["abc", "", "def"]</code> are all different keys.</p> <p>Keys are case sensitive and are ordered lexicographically by their parts. The first part is the most significant, and the last part is the least significant. The order of the parts is determined by both the type and the value of the part.</p> <h3 id="key-part-ordering" tabindex="-1">Key Part Ordering </h3> <p>Key parts are ordered lexicographically by their type, and within a given type, they are ordered by their value. The ordering of types is as follows:</p> <ol> <li><code data-language="ts">Uint8Array</code></li> <li><code data-language="ts">string</code></li> <li><code data-language="ts">number</code></li> <li><code data-language="ts">bigint</code></li> <li><code data-language="ts">boolean</code></li> </ol> <p>Within a given type, the ordering is:</p> <ul> <li>
<code data-language="ts">Uint8Array</code>: byte ordering of the array</li> <li>
<code data-language="ts">string</code>: byte ordering of the UTF-8 encoding of the string</li> <li>
<code data-language="ts">number</code>: -Infinity &lt; -1.0 &lt; -0.5 &lt; -0.0 &lt; 0.0 &lt; 0.5 &lt; 1.0 &lt; Infinity &lt; NaN</li> <li>
<code data-language="ts">bigint</code>: mathematical ordering, largest negative number first, largest positive number last</li> <li>
<code data-language="ts">boolean</code>: false &lt; true</li> </ul> <p>This means that the part <code data-language="ts">1.0</code> (a number) is ordered before the part <code data-language="ts">2.0</code> (also a number), but is greater than the part <code data-language="ts">0n</code> (a bigint), because <code data-language="ts">1.0</code> is a number and <code data-language="ts">0n</code> is a bigint, and type ordering has precedence over the ordering of values within a type.</p> <h3 id="key-examples" tabindex="-1">Key Examples </h3> <div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js"><span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token string">"profile"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// User with ID 42's profile</span>
<span class="token punctuation">[</span><span class="token string">"posts"</span><span class="token punctuation">,</span> <span class="token string">"2023-04-23"</span><span class="token punctuation">,</span> <span class="token string">"comments"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Comments for all posts on 2023-04-23</span>
<span class="token punctuation">[</span><span class="token string">"products"</span><span class="token punctuation">,</span> <span class="token string">"electronics"</span><span class="token punctuation">,</span> <span class="token string">"smartphones"</span><span class="token punctuation">,</span> <span class="token string">"apple"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Apple smartphones in the electronics category</span>
<span class="token punctuation">[</span><span class="token string">"orders"</span><span class="token punctuation">,</span> <span class="token number">1001</span><span class="token punctuation">,</span> <span class="token string">"shipping"</span><span class="token punctuation">,</span> <span class="token string">"tracking"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Tracking information for order ID 1001</span>
<span class="token punctuation">[</span><span class="token string">"files"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"metadata"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Metadata for a file with Uint8Array identifier</span>
<span class="token punctuation">[</span><span class="token string">"projects"</span><span class="token punctuation">,</span> <span class="token string">"openai"</span><span class="token punctuation">,</span> <span class="token string">"tasks"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Task with ID 5 in the OpenAI project</span>
<span class="token punctuation">[</span><span class="token string">"events"</span><span class="token punctuation">,</span> <span class="token string">"2023-03-31"</span><span class="token punctuation">,</span> <span class="token string">"location"</span><span class="token punctuation">,</span> <span class="token string">"san_francisco"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Events in San Francisco on 2023-03-31</span>
<span class="token punctuation">[</span><span class="token string">"invoices"</span><span class="token punctuation">,</span> <span class="token number">2023</span><span class="token punctuation">,</span> <span class="token string">"Q1"</span><span class="token punctuation">,</span> <span class="token string">"summary"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Summary of Q1 invoices for 2023</span>
<span class="token punctuation">[</span><span class="token string">"teams"</span><span class="token punctuation">,</span> <span class="token string">"engineering"</span><span class="token punctuation">,</span> <span class="token string">"members"</span><span class="token punctuation">,</span> <span class="token number">1n</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Member with ID 1n in the engineering team</span>
</code></pre>   </div>
<h3 id="universally-unique-lexicographically-sortable-identifiers-(ulids)" tabindex="-1">Universally Unique Lexicographically Sortable Identifiers (ULIDs) </h3> <p>Key part ordering allows keys consisting of timestamps and ID parts to be listed chronologically. Typically, you can generate a key using the following: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/now"><code data-language="ts">Date.now()</code></a> and <a href="https://developer.mozilla.org/en-US/docs/Web/API/Crypto/randomUUID"><code data-language="ts">crypto.randomUUID()</code></a>:</p> <div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">setUser</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> kv<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>   </div>
<p>Run multiple times sequentially, this produces the following keys:</p> <div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js"><span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">,</span> <span class="token number">1691377037923</span><span class="token punctuation">,</span> <span class="token string">"8c72fa25-40ad-42ce-80b0-44f79bc7a09e"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// First user</span>
<span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">,</span> <span class="token number">1691377037924</span><span class="token punctuation">,</span> <span class="token string">"8063f20c-8c2e-425e-a5ab-d61e7a717765"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Second user</span>
<span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">,</span> <span class="token number">1691377037925</span><span class="token punctuation">,</span> <span class="token string">"35310cea-58ba-4101-b09a-86232bf230b2"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Third user</span>
</code></pre>   </div>
<p>However, having the timestamp and ID represented within a single key part may be more straightforward in some cases. You can use a <a href="https://github.com/ulid/spec">Universally Unique Lexicographically Sortable Identifier (ULID)</a> to do this. This type of identifier encodes a UTC timestamp, is lexicographically sortable and is cryptographically random by default:</p> <div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js"><span class="token keyword">import</span> <span class="token punctuation">{</span> ulid <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"jsr:@std/ulid"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> kv <span class="token operator">=</span> <span class="token keyword">await</span> Deno<span class="token punctuation">.</span><span class="token function">openKv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">setUser</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> kv<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">,</span> <span class="token function">ulid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>   </div>
<div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js"><span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">,</span> <span class="token string">"01H76YTWK3YBV020S6MP69TBEQ"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// First user</span>
<span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">,</span> <span class="token string">"01H76YTWK4V82VFET9YTYDQ0NY"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Second user</span>
<span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">,</span> <span class="token string">"01H76YTWK5DM1G9TFR0Y5SCZQV"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Third user</span>
</code></pre>   </div>
<p>Furthermore, you can generate ULIDs monotonically increasingly using <code data-language="ts">monotonicUlid</code> function:</p> <div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js"><span class="token keyword">import</span> <span class="token punctuation">{</span> monotonicUlid <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"jsr:@std/ulid"</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">setUser</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> kv<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">,</span> <span class="token function">monotonicUlid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>   </div>
<div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js"><span class="token comment">// Strict ordering for the same timestamp by incrementing the least-significant random bit by 1</span>
<span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">,</span> <span class="token string">"01H76YTWK3YBV020S6MP69TBEQ"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// First user</span>
<span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">,</span> <span class="token string">"01H76YTWK3YBV020S6MP69TBER"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Second user</span>
<span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">,</span> <span class="token string">"01H76YTWK3YBV020S6MP69TBES"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Third user</span>
</code></pre>   </div>
<h2 id="values" tabindex="-1">Values </h2> <p>Values in Deno KV can be arbitrary JavaScript values that are compatible with the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm">structured clone algorithm</a>. This includes:</p> <ul> <li><code data-language="ts">undefined</code></li> <li><code data-language="ts">null</code></li> <li><code data-language="ts">boolean</code></li> <li><code data-language="ts">number</code></li> <li><code data-language="ts">string</code></li> <li><code data-language="ts">bigint</code></li> <li><code data-language="ts">Uint8Array</code></li> <li><code data-language="ts">Array</code></li> <li><code data-language="ts">Object</code></li> <li><code data-language="ts">Map</code></li> <li><code data-language="ts">Set</code></li> <li><code data-language="ts">Date</code></li> <li><code data-language="ts">RegExp</code></li> </ul> <p>Objects and arrays can contain any of the above types, including other objects and arrays. <code data-language="ts">Map</code>s and <code data-language="ts">Set</code>s can contain any of the above types, including other <code data-language="ts">Map</code>s and <code data-language="ts">Set</code>s.</p> <p>Circular references within values are supported.</p> <p>Objects with a non-primitive prototype are not supported (such as class instances or Web API objects). Functions and symbols can also not be serialized.</p> <h3 id="deno.kvu64-type" tabindex="-1">
<code data-language="ts">Deno.KvU64</code> type </h3> <p>In addition to structured serializable values, the special value <code data-language="ts">Deno.KvU64</code> is also supported as a value. This object represents a 64-bit unsigned integer, represented as a bigint. It can be used with the <code data-language="ts">sum</code>, <code data-language="ts">min</code>, and <code data-language="ts">max</code> KV operations. It can not be stored within an object or array. It must be stored as a top-level value.</p> <p>It can be created with the <code data-language="ts">Deno.KvU64</code> constructor:</p> <div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js"><span class="token keyword">const</span> u64 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Deno<span class="token punctuation">.</span>KvU64</span><span class="token punctuation">(</span><span class="token number">42n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
<h3 id="value-examples" tabindex="-1">Value Examples </h3> <div class="relative">
<pre class="language-none" tabindex="0"><code data-language="js">undefined;
null;
true;
false;
42;
-42.5;
42n;
"hello";
new Uint8Array([1, 2, 3]);
[1, 2, 3];
{ a: 1, b: 2, c: 3 };
new Map([["a", 1], ["b", 2], ["c", 3]]);
new Set([1, 2, 3]);
new Date("2023-04-23");
/abc/;

// Circular references are supported
const a = {};
const b = { a };
a.b = b;

// Deno.KvU64 is supported
new Deno.KvU64(42n);
</code></pre>   </div>
<h2 id="versionstamp" tabindex="-1">Versionstamp </h2> <p>All data in the Deno KV key-space is versioned. Every time a value is inserted or modified, a versionstamp is assigned to it. Versionstamps are monotonically increasing, non-sequential, 12 byte values that represent the time that the value was modified. Versionstamps do not represent real time, but rather the order in which the values were modified.</p> <p>Because versionstamps are monotonically increasing, they can be used to determine whether a given value is newer or older than another value. This can be done by comparing the versionstamps of the two values. If versionstamp A is greater than versionstamp B, then value A was modified more recently than value B.</p> <div class="relative">
<pre class="language-js" tabindex="0"><code data-language="js">versionstampA <span class="token operator">&gt;</span> versionstampB<span class="token punctuation">;</span>
<span class="token string">"000002fa526aaccb0000"</span> <span class="token operator">&gt;</span> <span class="token string">"000002fa526aacc90000"</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre>   </div>
<p>All data modified by a single transaction are assigned the same versionstamp. This means that if two <code data-language="ts">set</code> operations are performed in the same atomic operation, then the versionstamp of the new values will be the same.</p> <p>Versionstamps are used to implement optimistic concurrency control. Atomic operations can contain checks that ensure that the versionstamp of the data they are operating on matches a versionstamp passed to the operation. If the versionstamp of the data is not the same as the versionstamp passed to the operation, then the transaction will fail and the operation will not be applied.</p> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2018–2024 the Deno authors<br>Licensed under the MIT License.<br>
    <a href="https://docs.deno.com/deploy/kv/manual/key_space" class="_attribution-link">https://docs.deno.com/deploy/kv/manual/key_space</a>
  </p>
</div>
