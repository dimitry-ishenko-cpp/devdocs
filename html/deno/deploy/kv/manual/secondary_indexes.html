<h1>Secondary Indexes</h1>
<div>
<p><deno-admonition></deno-admonition></p> <p>Key-value stores like Deno KV organize data as collections of key-value pairs, where each unique key is associated with a single value. This structure enables easy retrieval of values based on their keys but does not allow for querying based on the values themselves. To overcome this constraint, you can create secondary indexes, which store the same value under additional keys that include (part of) that value.</p> <p>Maintaining consistency between primary and secondary keys is crucial when using secondary indexes. If a value is updated at the primary key without updating the secondary key, the data returned from a query targeting the secondary key will be incorrect. To ensure that primary and secondary keys always represent the same data, use atomic operations when inserting, updating, or deleting data. This approach ensures that the group of mutation actions are executed as a single unit, and either all succeed or all fail, preventing inconsistencies.</p> <h2 id="unique-indexes-(one-to-one)" tabindex="-1">Unique indexes (one-to-one) </h2> <p>Unique indexes have each key in the index associated with exactly one primary key. For example, when storing user data and looking up users by both their unique IDs and email addresses, store user data under two separate keys: one for the primary key (user ID) and another for the secondary index (email). This setup allows querying users based on either their ID or their email. The secondary index can also enforce uniqueness constraints on values in the store. In the case of user data, use the index to ensure that each email address is associated with only one user - in other words that emails are unique.</p> <p>To implement a unique secondary index for this example, follow these steps:</p> <ol> <li> <p>Create a <code data-language="ts">User</code> interface representing the data:</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token keyword">interface</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  email<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>   </div>
</li> <li> <p>Define an <code data-language="ts">insertUser</code> function that stores user data at both the primary and secondary keys:</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">insertUser</span><span class="token punctuation">(</span>user<span class="token operator">:</span> User<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> primaryKey <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> byEmailKey <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"users_by_email"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>email<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> kv<span class="token punctuation">.</span><span class="token function">atomic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token operator">:</span> primaryKey<span class="token punctuation">,</span> versionstamp<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token operator">:</span> byEmailKey<span class="token punctuation">,</span> versionstamp<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>primaryKey<span class="token punctuation">,</span> user<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>byEmailKey<span class="token punctuation">,</span> user<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">"User with ID or email already exists"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>   </div>
<blockquote> <p>This function performs the insert using an atomic operation that checks that no user with the same ID or email already exists. If either of these constraints is violated, the insert fails and no data is modified.</p> </blockquote> </li> <li> <p>Define a <code data-language="ts">getUser</code> function to retrieve a user by their ID:</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getUser</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>User <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> kv<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span>User<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">,</span> id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>   </div>
</li> <li> <p>Define a <code data-language="ts">getUserByEmail</code> function to retrieve a user by their email address:</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getUserByEmail</span><span class="token punctuation">(</span>email<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>User <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> kv<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span>User<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"users_by_email"</span><span class="token punctuation">,</span> email<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>   </div>
<p>This function queries the store using the secondary key (<code data-language="ts">["users_by_email", email]</code>).</p> </li> <li> <p>Define a deleteUser function to delete users by their ID:</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">deleteUser</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token punctuation">{</span> ok<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> getRes <span class="token operator">=</span> <span class="token keyword">await</span> kv<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span>User<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">,</span> id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>getRes<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token keyword">await</span> kv<span class="token punctuation">.</span><span class="token function">atomic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>getRes<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">,</span> id<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"users_by_email"</span><span class="token punctuation">,</span> getRes<span class="token punctuation">.</span>value<span class="token punctuation">.</span>email<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>   </div>
<blockquote> <p>This function first retrieves the user by their ID to get the users email address. This is needed to retrieve the email that is needed to construct the key for the secondary index for this user address. It then performs an atomic operation that checks that the user in the database has not changed, and then deletes both the primary and secondary key pointing to the user value. If this fails (the user has been modified between query and delete), the atomic operation aborts. The entire procedure is retried until the delete succeeds. The check is required to prevent race conditions where value may have been modified between the retrieve and delete. This race can occur if an update changes the user's email, because the secondary index moves in this case. The delete of the secondary index then fails, because the delete is targeting the old secondary index key.</p> </blockquote> </li> </ol> <h2 id="non-unique-indexes-(one-to-many)" tabindex="-1">Non-Unique Indexes (One-to-Many) </h2> <p>Non-unique indexes are secondary indexes where a single key can be associated with multiple primary keys, allowing you to query for multiple items based on a shared attribute. For example, when querying users by their favorite color, implement this using a non-unique secondary index. The favorite color is a non-unique attribute since multiple users can have the same favorite color.</p> <p>To implement a non-unique secondary index for this example, follow these steps:</p> <ol> <li> <p>Define the <code data-language="ts">User</code> interface:</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token keyword">interface</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  favoriteColor<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>   </div>
</li> <li> <p>Define the <code data-language="ts">insertUser</code> function:</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">insertUser</span><span class="token punctuation">(</span>user<span class="token operator">:</span> User<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> primaryKey <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> byColorKey <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"users_by_favorite_color"</span><span class="token punctuation">,</span>
    user<span class="token punctuation">.</span>favoriteColor<span class="token punctuation">,</span>
    user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> kv<span class="token punctuation">.</span><span class="token function">atomic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token operator">:</span> primaryKey<span class="token punctuation">,</span> versionstamp<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>primaryKey<span class="token punctuation">,</span> user<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>byColorKey<span class="token punctuation">,</span> user<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>   </div>
</li> <li> <p>Define a function to retrieve users by their favorite color:</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getUsersByFavoriteColor</span><span class="token punctuation">(</span>color<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>User<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> iter <span class="token operator">=</span> kv<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">list</span><span class="token generic class-name"><span class="token operator">&lt;</span>User<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> prefix<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"users_by_favorite_color"</span><span class="token punctuation">,</span> color<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">{</span> value <span class="token punctuation">}</span> <span class="token keyword">of</span> iter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    users<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> users<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>   </div>
</li> </ol> <p>This example demonstrates the use of a non-unique secondary index, <code data-language="ts">users_by_favorite_color</code>, which allows querying users based on their favorite color. The primary key remains the user <code data-language="ts">id</code>.</p> <p>The primary difference between the implementation of unique and non-unique indexes lies in the structure and organization of the secondary keys. In unique indexes, each secondary key is associated with exactly one primary key, ensuring that the indexed attribute is unique across all records. In the case of non-unique indexes, a single secondary key can be associated with multiple primary keys, as the indexed attribute may be shared among multiple records. To achieve this, non-unique secondary keys are typically structured with an additional unique identifier (e.g., primary key) as part of the key, allowing multiple records with the same attribute to coexist without conflicts.</p> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2018–2024 the Deno authors<br>Licensed under the MIT License.<br>
    <a href="https://docs.deno.com/deploy/kv/manual/secondary_indexes" class="_attribution-link">https://docs.deno.com/deploy/kv/manual/secondary_indexes</a>
  </p>
</div>
