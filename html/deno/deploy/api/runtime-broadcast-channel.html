<h1>BroadcastChannel</h1>
<div>
<p>In Deno Deploy, code is run in different data centers around the world in order to reduce latency by servicing requests at the data center nearest to the client. In the browser, the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Broadcast_Channel_API"><code data-language="ts">BroadcastChannel</code></a> API allows different tabs with the same origin to exchange messages. In Deno Deploy, the BroadcastChannel API provides a communication mechanism between the various instances; a simple message bus that connects the various Deploy instances worldwide.</p> <h2 id="constructor" tabindex="-1">Constructor </h2> <p>The <code data-language="ts">BroadcastChannel()</code> constructor creates a new <code data-language="ts">BroadcastChannel</code> instance and connects to (or creates) the provided channel.</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token keyword">let</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastChannel</span><span class="token punctuation">(</span>channelName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
<h4 id="parameters" tabindex="-1">Parameters </h4> <table> <thead> <tr> <th>name</th> <th>type</th> <th>description</th> </tr> </thead> <tbody> <tr> <td>channelName</td> <td><code data-language="ts">string</code></td> <td>The name for the underlying broadcast channel connection.</td> </tr> </tbody> </table> <p>The return type of the constructor is a <code data-language="ts">BroadcastChannel</code> instance.</p> <h2 id="properties" tabindex="-1">Properties </h2> <table> <thead> <tr> <th>name</th> <th>type</th> <th>description</th> </tr> </thead> <tbody> <tr> <td><code data-language="ts">name</code></td> <td><code data-language="ts">string</code></td> <td>The name of the underlying broadcast channel.</td> </tr> <tr> <td><code data-language="ts">onmessage</code></td> <td>
<code data-language="ts">function</code> (or <code data-language="ts">null</code>)</td> <td>The function that's executed when the channel receives a new message (<a href="https://developer.mozilla.org/en-US/docs/Web/API/MessageEvent"><code data-language="ts">MessageEvent</code></a>).</td> </tr> <tr> <td><code data-language="ts">onmessageerror</code></td> <td>
<code data-language="ts">function</code> (or <code data-language="ts">null</code>)</td> <td>The function that's executed when the arrived message cannot be deserialized to a JavaScript data structure.</td> </tr> </tbody> </table> <h2 id="methods" tabindex="-1">Methods </h2> <table> <thead> <tr> <th>name</th> <th>description</th> </tr> </thead> <tbody> <tr> <td><code data-language="ts">close()</code></td> <td>Close the connection to the underlying channel. After closing, you can no longer post messages to the channel.</td> </tr> <tr> <td><code data-language="ts">postMessage(message)</code></td> <td>Post a message to the underlying channel. The message can be a string, object literal, a number or any kind of <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object"><code data-language="ts">Object</code></a>.</td> </tr> </tbody> </table> <p><code data-language="ts">BroadcastChannel</code> extends <a href="https://developer.mozilla.org/en-US/docs/Web/API/EventTarget"><code data-language="ts">EventTarget</code></a>, which allows you to use methods of <code data-language="ts">EventTarget</code> like <code data-language="ts">addEventListener</code> and <code data-language="ts">removeEventListener</code> on an instance of <code data-language="ts">BroadcastChannel</code>.</p> <h2 id="example%3A-update-an-in-memory-cache-across-instances" tabindex="-1">Example: Update an in-memory cache across instances </h2> <p>One use case for a message bus like the one enabled by <code data-language="ts">BroadcastChannel</code> is updating an in-memory cache of data between isolates running in different data centers across the network. In the example below, we show how you can configure a simple server that uses <code data-language="ts">BroadcastChannel</code> to synchornize state across all running instances of the server.</p> <div class="relative">
<pre class="language-ts" tabindex="0"><code data-language="ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> Hono <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"https://deno.land/x/hono/mod.ts"</span><span class="token punctuation">;</span>

<span class="token comment">// in-memory cache of messages</span>
<span class="token keyword">const</span> messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// A BroadcastChannel used by all isolates</span>
<span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastChannel</span><span class="token punctuation">(</span><span class="token string">"all_messages"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// When a new message comes in from other instances, add it</span>
channel<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token operator">:</span> MessageEvent<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  messages<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Create a server to add and retrieve messages</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hono</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Add a message to the list</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/send"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// New messages can be added by including a "message" query param</span>
  <span class="token keyword">const</span> message <span class="token operator">=</span> c<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    messages<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    channel<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get a list of messages</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Return the current list of messages</span>
  <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Deno<span class="token punctuation">.</span><span class="token function">serve</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>fetch<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>   </div>
<p>You can test this example yourself on Deno Deploy using <a href="https://dash.deno.com/playground/broadcast-channel-example">this playground</a>.</p> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2018â€“2024 the Deno authors<br>Licensed under the MIT License.<br>
    <a href="https://docs.deno.com/deploy/api/runtime-broadcast-channel" class="_attribution-link">https://docs.deno.com/deploy/api/runtime-broadcast-channel</a>
  </p>
</div>
