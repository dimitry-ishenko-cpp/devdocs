<h1 class="title">Geospatial queries</h1>  <div class="alg-content">
<p>RethinkDB supports spatial and geographic queries through geometry object support.</p> <div class="toc">  <ul id="markdown-toc"> <li><a href="#getting-started" id="markdown-toc-getting-started">Getting started</a></li> <li><a href="#coordinate-system" id="markdown-toc-coordinate-system">Coordinate system</a></li> <li><a href="#lines-and-distances" id="markdown-toc-lines-and-distances">Lines and distances</a></li> <li><a href="#data-types" id="markdown-toc-data-types">Data types</a></li> <li><a href="#geospatial-indexes" id="markdown-toc-geospatial-indexes">Geospatial indexes</a></li> <li><a href="#using-geojson" id="markdown-toc-using-geojson">Using GeoJSON</a></li> <li><a href="#faq" id="markdown-toc-faq">FAQ</a></li> <li><a href="#geospatial-commands" id="markdown-toc-geospatial-commands">Geospatial commands</a></li> </ul> </div> <p>Geometry objects are implemented through a geographic coordinate system, with points and shapes plotted on the surface of a sphere in three-dimensional space. In addition, ReQL geometry objects can be converted to and from GeoJSON, with some limitations.</p> <p>This is an overview of the system. For more details, consult the API documentation for individual geospatial commands.</p> <h2 id="getting-started">Getting started</h2> <p>These can be executed in the Data Explorer to try out RethinkDB’s geospatial support.</p> <p>Create a new table:</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight" data-language="">r.tableCreate('geo')
</pre></div></div> <p>Add a couple points:</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight" data-language="">r.table('geo').insert([
  {
    id: 1,
    name: 'San Francisco',
    location: r.point(-122.423246,37.779388)
  },
  {
    id: 2,
    name: 'San Diego',
    location: r.point(-117.220406,32.719464)
  }
])
</pre></div></div> <p>Get the distance between the two points in San Francisco and San Diego:</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight" data-language="">r.table('geo').get(1)('location').distance(r.table('geo').get(2)('location'))
</pre></div></div> <p>Add a geospatial index on the table (required for certain operations like <code class="language-plaintext highlighter-rouge">getNearest</code>):</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight" data-language="">r.table('geo').indexCreate('location', {geo: true})
</pre></div></div> <p>Get the nearest point in the table to a specified one based on the index:</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight" data-language="">var point = r.point(-122.422876,37.777128);  // San Francisco
r.table('geo').getNearest(point, {index: 'location'})
</pre></div></div> <h2 id="coordinate-system">Coordinate system</h2> <p>Coordinates of points on the sphere’s surface are addressed by a pair of floating point numbers that denote longitude and latitude. The range of longitude is −180 through 180, which wraps around the whole of the sphere: −180 and 180 denote the same line. The range of latitude is −90 (the south pole) through 90 (the north pole).</p> <p>For a more detailed explanation of this, consult the Wikipedia article on the <a href="http://en.wikipedia.org/wiki/Geographic_coordinate_system">geographic coordinate system</a>.</p> <h2 id="lines-and-distances">Lines and distances</h2> <p>Given two endpoints, a line in ReQL is the shortest path between those endpoints on the surface of the sphere, known as a <a href="http://en.wikipedia.org/wiki/Geodesic">geodesic</a>. Lines can be defined with multiple points, in which case each segment of the line will be a geodesic; likewise, sides of a polygon will be geodesics. Geodesics are calculated assuming a perfect sphere.</p> <p>Note that a line between the north pole and south pole (from latitude −90 to latitude 90) cannot be calculated, as <em>all</em> possible paths between them are the “shortest”; this may trigger an error in ReQL or it may choose an arbitrary (but technically correct) path.</p> <p>Distances in ReQL are (by default) calculated assuming not a perfect sphere but an ellipsoid, using a precise and relatively fast algorithm developed by <a href="http://link.springer.com/article/10.1007%2Fs00190-012-0578-z" title="Algorithms for geodesics">Charles Karney</a>. The reference ellipsoid used is <a href="http://en.wikipedia.org/wiki/World_Geodetic_System">WGS84</a>, the standard used for GPS. By default distances are specified in meters, but you can pass an optional argument to distance functions to specify kilometers, miles, nautical miles, and feet.</p> <h2 id="data-types">Data types</h2> <p>The geospatial functions are implemented through a set of new geometric object data types:</p> <ul> <li>
<strong>Points:</strong> a single coordinate pair</li> <li>
<strong>Lines:</strong> A sequence of two or more coordinate pairs</li> <li>
<strong>Polygons:</strong> A multipoint line (at least three coordinate pairs) which does not intersect with itself and whose first and last coordinate pairs are equal. The interior of the polygon is considered filled, that is, part of the polygon. Polygons with “holes” in them, where a hole is another polygon contained by the first, can be created with the [polygonSub][] command.</li> </ul> <p>In addition, there’s a “pseudotype” called <strong>geometry</strong> which appears in documentation, to indicate that any of the geometric objects can be used with those commands.</p> <p>Lines and polygons can be specified using either point objects or sequences of two-number arrays:</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight" data-language="">r.line(r.point(0,0), r.point(0,5), r.point(5,5), r.point(5,0), r.point(0,0))
r.line([0,0], [0,5], [5,5], [5,0], [0,0])
</pre></div></div> <p>Both of those define the same square. If <code class="language-plaintext highlighter-rouge">polygon</code> had been specified instead of <code class="language-plaintext highlighter-rouge">line</code> they would define a filled square.</p> <p>While there <em>is</em> a [circle] command, it approximates a circle by defining either a line or a polygon. There is no true circular data type.</p> <h2 id="geospatial-indexes">Geospatial indexes</h2> <p>To create indexes on fields containing geometry objects, you simply use the standard <a href="../../../api/javascript/index_create/index.html">indexCreate</a> command, setting the <code class="language-plaintext highlighter-rouge">geo</code> optional argument to <code class="language-plaintext highlighter-rouge">true</code>. In JavaScript, this would be:</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight" data-language="">r.table('sites').indexCreate('locations', {geo: true})
</pre></div></div> <p>Just like other ReQL indexes, you can create an index using an anonymous function rather than a simple field name, as well as create multi indexes by using the <code class="language-plaintext highlighter-rouge">multi</code> flag with <code class="language-plaintext highlighter-rouge">geo</code>. Read the <a href="../../../api/javascript/index_create/index.html">indexCreate</a> API documentation for more details.</p> <h2 id="using-geojson">Using GeoJSON</h2> <p>ReQL geometry objects are not <a href="http://geojson.org">GeoJSON</a> objects, but you can convert back and forth between them with the <a href="../../../api/javascript/geojson/index.html">geojson</a> and <a href="../../../api/javascript/to_geojson/index.html">toGeojson</a> commands.</p> <p>RethinkDB only allows conversion of GeoJSON objects which have ReQL equivalents: Point, LineString, and Polygon; MultiPoint, MultiLineString, and MultiPolygon are not supported. (You could, however, store multiple points, lines and polygons in an array and use a geospatial multi index with them.)</p> <p>Only longitude/latitude coordinates are supported. GeoJSON objects that use Cartesian coordinates, specify an altitude, or specify their own coordinate reference system will be rejected.</p> <h2 id="faq">FAQ</h2> <ul> <li> <p><strong>How many dimensions are supported?</strong></p> <p>Two (latitude and longitude). Elevation is not supported.</p> </li> <li> <p><strong>What projections are supported?</strong></p> <p>RethinkDB supports the WGS84 World Geodetic System’s reference ellipsoid and geographic coordinate system (GCS). It does not directly support any projected coordinate system (PCS), but there are many tools available for performing such projections.</p> </li> <li> <p><strong>Does RethinkDB do a correct interpolation of degrees to meters along a path?</strong></p> <p>Yes. Distance calculations are done on a geodesic (either WGS84’s reference ellipsoid or a unit sphere).</p> </li> <li> <p><strong>Can you export to WKT or WKB?</strong></p> <p>No. However, you can export to GeoJSON and process that with other tools.</p> </li> </ul> <h2 id="geospatial-commands">Geospatial commands</h2> <ul> <li>
<a href="../../../api/javascript/geojson/index.html">geojson</a>: convert a GeoJSON object to a geometry object</li> <li>
<a href="to_geojson/index.html">toGeojson</a>/<a href="../../../api/javascript/to_geojson/index.html">to_geojson</a>: convert a geometry object to a GeJSON object</li> <li>
<a href="../../../api/javascript/point/index.html">point</a>: create a point object</li> <li>
<a href="../../../api/javascript/line/index.html">line</a>: create a line object</li> <li>
<a href="../../../api/javascript/polygon/index.html">polygon</a>: create a polygon object</li> <li>
<a href="../../../api/javascript/circle/index.html">circle</a>: create a line or polygon that approximates a circle</li> <li>
<a href="../../../api/javascript/distance/index.html">distance</a>: compute the distance between a point and another geometry object</li> <li>
<a href="../../../api/javascript/intersects/index.html">intersects</a>: determine whether two geometry objects intersect</li> <li>
<a href="../../../api/javascript/includes/index.html">includes</a>: determine whether one geometry object is completely contained by a polygon object</li> <li>
<a href="../../../api/javascript/get_intersecting/index.html">getIntersecting</a>: return documents from a sequence that have a geospatially indexed field whose values intersect with a given geometry object</li> <li>
<a href="../../../api/javascript/get_nearest/index.html">getNearest</a>: return documents from a sequence that have a geospatially indexed field whose values are within a specified distance of a given point</li> <li>
<a href="../../../api/javascript/polygon_sub/index.html">polygonSub</a>: use one polygon completely contained within another to cut out a “hole” in the enclosing polygon</li> </ul> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; RethinkDB contributors<br>Licensed under the Creative Commons Attribution-ShareAlike 3.0 Unported License.<br>
    <a href="https://rethinkdb.com/docs/geo-support/javascript/" class="_attribution-link">https://rethinkdb.com/docs/geo-support/javascript/</a>
  </p>
</div>
