<div id="col-content" data-swiftype-index="true"> <div id="about-cookbook-versioning"><h1>About Cookbook Versioning</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/chef-web-docs/blob/main/content/cookbook_versioning.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>A cookbook version represents a set of functionality that is different from the cookbook on which it is based. A version may exist for many reasons, such as ensuring the correct use of a third-party component, updating a bug fix, or adding an improvement. A cookbook version is defined using syntax and operators, may be associated with environments, cookbook metadata, and/or run-lists, and may be frozen (to prevent unwanted updates from being made).</p> <p>A cookbook version is maintained just like a cookbook, with regard to source control, uploading it to the Chef Infra Server, and how Chef Infra Client applies that cookbook when configuring nodes.</p> <h2 id="syntax">Syntax</h2> <p>A cookbook version always takes the form x.y.z, where x, y, and z are decimal numbers that are used to represent major (x), minor (y), and patch (z) versions. A two-part version (x.y) is also allowed. Alphanumeric version numbers (1.2.a3) and version numbers with more than three parts (1.2.3.4) are not allowed.</p> <h2 id="constraints">Constraints</h2> <p>A version constraint is a string that combines the cookbook version syntax with an operator, in the following format:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">operator cookbook_version_syntax
</code></pre></div>
<div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> Single digit cookbook versions are not allowed. Cookbook versions must specify at least the major and minor version. For example, use <code>1.0</code> or <code>1.0.1</code>; do not use <code>1</code>. </div> </div> <p>The following operators may be used:</p> <table> <col style="width:40%"> <col style="width:60%"> <thead> <tr class="header"> <th>Operator</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>=</code></td> <td>equal to</td> </tr> <tr> <td><code>&gt;</code></td> <td>greater than</td> </tr> <tr> <td><code>&lt;</code></td> <td>less than</td> </tr> <tr> <td><code>&gt;=</code></td> <td>greater than or equal to; also known as "optimistically greater than", or "optimistic"</td> </tr> <tr> <td><code>&lt;=</code></td> <td>less than or equal to</td> </tr> <tr> <td><code>~&gt;</code></td> <td>approximately greater than; also known as "pessimistically greater than", or "pessimistic"</td> </tr> </tbody> </table> <p>For example, a version constraint for “equals version 1.0.7” is expressed like this:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#666">=</span> <span style="color:#40a070">1</span><span style="color:#666">.</span><span style="color:#40a070">0</span><span style="color:#666">.</span><span style="color:#40a070">7</span>
</code></pre></div>
<p>A version constraint for “greater than version 1.0.2” is expressed like this:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#666">&gt;</span> <span style="color:#40a070">1</span><span style="color:#666">.</span><span style="color:#40a070">0</span><span style="color:#666">.</span><span style="color:#40a070">2</span>
</code></pre></div>
<p>An optimistic version constraint is one that looks for versions greater than or equal to the specified version. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#666">&gt;=</span> <span style="color:#40a070">2</span><span style="color:#666">.</span><span style="color:#40a070">6</span><span style="color:#666">.</span><span style="color:#40a070">5</span>
</code></pre></div>
<p>will match cookbooks greater than or equal to 2.6.5, such as 2.6.5, 2.6.7 or 3.1.1.</p> <p>A pessimistic version constraint is one that will find the upper limit version number within the range specified by the minor version number or patch version number. For example, a pessimistic version constraint for minor version numbers:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#666">~&gt;</span> <span style="color:#40a070">2</span><span style="color:#666">.</span><span style="color:#40a070">6</span>
</code></pre></div>
<p>will match cookbooks that are greater than or equal to version 2.6, but less than version 3.0.</p> <p>Or, a pessimistic version constraint for patch version numbers:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#666">~&gt;</span> <span style="color:#40a070">2</span><span style="color:#666">.</span><span style="color:#40a070">6</span><span style="color:#666">.</span><span style="color:#40a070">5</span>
</code></pre></div>
<p>will match cookbooks that are greater than or equal to version 2.6.5, but less than version 2.7.0.</p> <p>Or, a pessimistic version constraint that matches cookbooks less than a version number:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#666">&lt;</span> <span style="color:#40a070">2</span><span style="color:#666">.</span><span style="color:#40a070">3</span><span style="color:#666">.</span><span style="color:#40a070">4</span>
</code></pre></div>
<p>or will match cookbooks less than or equal to a specific version number:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#666">&lt;=</span> <span style="color:#40a070">2</span><span style="color:#666">.</span><span style="color:#40a070">6</span><span style="color:#666">.</span><span style="color:#40a070">5</span>
</code></pre></div>
<h2 id="metadata">Metadata</h2> <p>Every cookbook requires a small amount of metadata. The contents of the <code>metadata.rb</code> file provides information that helps Chef Infra Client and Server correctly deploy cookbooks to each node.</p> <p>A <code>metadata.rb</code> file is:</p> <ul> <li>Located at the top level of a cookbook’s directory structure.</li> <li>Compiled whenever a cookbook is uploaded to the Chef Infra Server or when the <code>knife cookbook metadata</code> subcommand is run, and then stored as JSON data.</li> <li>Created automatically by knife whenever the <code>knife cookbook create</code> subcommand is run.</li> <li>Edited using a text editor, and then re-uploaded to the Chef Infra Server as part of a cookbook upload.</li> </ul> <p>Versions and version constraints can be specified in a cookbook’s metadata.rb file by using the following functions. Each function accepts a name and an optional version constraint; if a version constraint is not provided, <code>&gt;= 0.0.0</code> is used as the default.</p> <table> <col style="width:40%"> <col style="width:60%"> <thead> <tr class="header"> <th>Function</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><p><code>depends</code></p></td> <td>
<p>Show that a cookbook has a dependency on another cookbook. Use a version constraint to define dependencies for cookbook versions: <code>&lt;</code> (less than), <code>&lt;=</code> (less than or equal to), <code>=</code> (equal to), <code>&gt;=</code> (greater than or equal to; also known as "optimistically greater than", or "optimistic"), <code>~&gt;</code> (approximately greater than; also known as "pessimistically greater than", or "pessimistic"), or <code>&gt;</code> (greater than). This field requires that a cookbook with a matching name and version exists on the Chef Infra Server. When the match exists, the Chef Infra Server includes the dependency as part of the set of cookbooks that are sent to the node when Chef Infra Client runs. It is very important that the <code>depends</code> field contain accurate data. If a dependency statement is inaccurate, Chef Infra Client may not be able to complete the configuration of the system. For example:</p> <div class="sourceCode" id="cb1"><pre class="sourceCode ruby highlight" data-language="ruby"><code class="sourceCode ruby"><span id="cb1-1">depends <span class="st">'opscode-base'</span></span></code></pre></div> <p>or:</p> <div class="sourceCode" id="cb2"><pre class="sourceCode ruby highlight" data-language="ruby"><code class="sourceCode ruby"><span id="cb2-1">depends <span class="st">'opscode-github'</span>, <span class="st">'&gt; 1.0.0'</span></span></code></pre></div> <p>or:</p> <div class="sourceCode" id="cb3"><pre class="sourceCode ruby highlight" data-language="ruby"><code class="sourceCode ruby"><span id="cb3-1">depends <span class="st">'runit'</span>, <span class="st">'~&gt; 1.2.3'</span></span></code></pre></div>
</td> </tr> <tr> <td><code>provides</code></td> <td>Add a recipe, definition, or resource that is provided by this cookbook, should the auto-populated list be insufficient.</td> </tr> <tr> <td><code>supports</code></td> <td>Show that a cookbook has a supported platform. Use a version constraint to define dependencies for platform versions: <code>&lt;</code> (less than), <code>&lt;=</code> (less than or equal to), <code>=</code> (equal to), <code>&gt;=</code> (greater than or equal to), <code>~&gt;</code> (approximately greater than), or <code>&gt;</code> (greater than). To specify more than one platform, use more than one <code>supports</code> field, once for each platform.</td> </tr> </tbody> </table> <h2 id="environments">Environments</h2> <p>An environment can use version constraints to specify a list of allowed cookbook versions by specifying the cookbook’s name, along with the version constraint. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">cookbook <span style="color:#4070a0">'apache2'</span>, <span style="color:#4070a0">'~&gt; 1.2.3'</span>
</code></pre></div>
<p>Or:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">cookbook <span style="color:#4070a0">'runit'</span>, <span style="color:#4070a0">'= 4.2.0'</span>
</code></pre></div>
<p>If a cookbook is not explicitly given a version constraint the environment will assume the cookbook has no version constraint and will use any version of that cookbook with any node in the environment.</p> <h2 id="freeze-versions">Freeze Versions</h2> <p>A cookbook version can be frozen, which will prevent updates from being made to that version of a cookbook. (A user can always upload a new version of a cookbook.) Using cookbook versions that are frozen within environments is a reliable way to keep a production environment safe from accidental updates while testing changes that are made to a development infrastructure.</p> <p>For example, to freeze a cookbook version using knife, enter:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife cookbook upload redis --freeze
</code></pre></div>
<p>To return:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">Uploading redis...
Upload completed
</code></pre></div>
<p>Once a cookbook version is frozen, only by using the <code>--force</code> option can an update be made. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife cookbook upload redis --force
</code></pre></div>
<p>Without the <code>--force</code> option specified, an error will be returned similar to:</p> <pre tabindex="0" class="highlight" data-language="ruby"><code class="language-none" data-lang="none">Version 0.0.0 of cookbook redis is frozen. Use --force to override
</code></pre>
<h2 id="version-source-control">Version Source Control</h2> <p>There are two strategies to consider when using version control as part of the cookbook management process:</p> <ul> <li>Use maximum version control when it is important to keep every bit of data within version control</li> <li>Use branch tracking when cookbooks are being managed in separate environments using git branches and the versioning policy information is already stored in a cookbook’s metadata.</li> </ul> <h3 id="branch-tracking">Branch Tracking</h3> <p>Using a branch tracking strategy requires that a branch for each environment exists in the source control and that each cookbook’s versioning policy is tracked at the branch level. This approach is relatively simple and lightweight: for development environments that track the latest cookbooks, just bump the version before a cookbook is uploaded for testing. For any cookbooks that require higher levels of version control, knife allows cookbooks to be uploaded to specific environments and for cookbooks to be frozen (which prevents others from being able to make changes to that cookbook).</p> <p>The typical workflow with a branch tracking version control strategy includes:</p> <ol> <li>Bumping the version number as appropriate.</li> <li>Making changes to a cookbook.</li> <li>Uploading and testing a cookbook.</li> <li>Moving a tested cookbook to production.</li> </ol> <p>For example, to bump a version number, first make changes to the cookbook, and then upload and test it. Repeat this process as required, and then upload it using a knife command similar to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife cookbook upload my-app
</code></pre></div>
<p>When the cookbook is finished, move those changes to the production environment and use the <code>--freeze</code> option to prevent others from making further changes:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife cookbook upload  my-app -E production --freeze
</code></pre></div>
<h3 id="maximum-versions">Maximum Versions</h3> <p>Using a maximum version control strategy is required when everything needs to be tracked in source control. This approach is very similar to a branch tracking strategy while the cookbook is in development and being tested, but is more complicated and time-consuming (and requires file-level editing for environment data) in order to get the cookbook deployed to a production environment.</p> <p>The typical workflow with a maximum version control strategy includes:</p> <ol> <li>Bumping the version number as appropriate.</li> <li>Making changes to a cookbook.</li> <li>Uploading and testing a cookbook.</li> <li>Moving a tested cookbook to production.</li> </ol> <p>For example, to bump a version number, first make changes to the cookbook, and then upload and test it. Repeat this process as required, and then upload it using a knife command similar to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife cookbook upload my-app
</code></pre></div>
<p>When the cookbook is finished, move those changes to the production environment and use the <code>--freeze</code> option to prevent others from making further changes:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife cookbook upload  my-app -E production --freeze
</code></pre></div>
<p>Then modify the environment so that it prefers the newly uploaded version:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#666">(</span>vim|emacs|mate|ed<span style="color:#666">)</span> YOUR_REPO/environments/production.rb
</code></pre></div>
<p>Upload the updated environment:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife environment from file production.rb
</code></pre></div>
<p>And then deploy the new cookbook version.</p> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/cookbook_versioning/" class="_attribution-link">https://docs.chef.io/cookbook_versioning/</a>
  </p>
</div>
