<div id="col-content" data-swiftype-index="true"> <div id="pattern-library-introduction"><h1>Pattern Library Introduction</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/habitat-sh/habitat/tree/main/components/docs-chef-io/content/habitat/pattern_library.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <h2 id="chef-habitat-pattern-library">Chef Habitat Pattern Library</h2> <p>The Chef Habitat Pattern Library is an evolving set of design patterns to use as starting-points. These patterns are examples and require configuration and customization for your unique situation.</p> <p>For help with Chef Habitat and these patterns, ask:</p> <ul> <li>Your customer support agent</li> <li>In the <a href="https://discourse.chef.io/c/habitat/">Chef Discourse</a>
</li> </ul> <h2 id="kubernetes-bastion-ring-pattern">Kubernetes Bastion Ring Pattern</h2> <p>A <em>bastion ring</em> is a robust type of Supervisor network in which a small number of Supervisors are set up as permanent peers and that are dedicated to anchoring Supervisor network communication. These Supervisors are designated solely for communication between Supervisor and <em>do not run services</em>. These solely to anchor the entire Supervisor network. See <a href="../sup_networks/index.html">Supervisor Networks</a> for more information. The following examples demonstrate running a bastion ring in Kubernetes.</p> <h3 id="kubernetes-bastion-ring-plan">Kubernetes Bastion Ring Plan</h3> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#bb60d5">pkg_name</span><span style="color:#666">=</span>hab_bastion
<span style="color:#bb60d5">pkg_origin</span><span style="color:#666">=</span>habitat
<span style="color:#bb60d5">pkg_version</span><span style="color:#666">=</span><span style="color:#4070a0">"0.1.0"</span>
<span style="color:#bb60d5">pkg_maintainer</span><span style="color:#666">=</span><span style="color:#4070a0">"irvingpop"</span>
<span style="color:#bb60d5">pkg_license</span><span style="color:#666">=(</span><span style="color:#4070a0">"Apache-2.0"</span><span style="color:#666">)</span>
<span style="color:#bb60d5">pkg_deps</span><span style="color:#666">=(</span>core/busybox-static<span style="color:#666">)</span>
<span style="color:#bb60d5">pkg_svc_run</span><span style="color:#666">=</span><span style="color:#4070a0">"while true; do sleep 60; done"</span>

do_build<span style="color:#666">()</span> <span style="color:#666">{</span>
  <span style="color:#007020;font-weight:700">return</span> <span style="color:#40a070">0</span>
<span style="color:#666">}</span>

do_install<span style="color:#666">()</span> <span style="color:#666">{</span>
  <span style="color:#007020;font-weight:700">return</span> <span style="color:#40a070">0</span>
<span style="color:#666">}</span>
</code></pre></div>
<h3 id="kubernetes-bastion-ring-producer-pattern">Kubernetes Bastion Ring Producer Pattern</h3> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#0e84b5;font-weight:700">---</span><span style="color:#062873;font-weight:700">apiVersion</span>:v1<span style="color:#062873;font-weight:700">kind</span>:Service<span style="color:#062873;font-weight:700">metadata</span>:<span style="color:#062873;font-weight:700">name</span>:hab-bastion<span style="color:#062873;font-weight:700">spec</span>:<span style="color:#062873;font-weight:700">ports</span>:- <span style="color:#062873;font-weight:700">name</span>:gossip-listener<span style="color:#062873;font-weight:700">protocol</span>:UDP<span style="color:#062873;font-weight:700">port</span>:<span style="color:#40a070">9638</span><span style="color:#062873;font-weight:700">targetPort</span>:<span style="color:#40a070">9638</span>- <span style="color:#062873;font-weight:700">name</span>:http-gateway<span style="color:#062873;font-weight:700">protocol</span>:TCP<span style="color:#062873;font-weight:700">port</span>:<span style="color:#40a070">9631</span><span style="color:#062873;font-weight:700">targetPort</span>:<span style="color:#40a070">9631</span><span style="color:#062873;font-weight:700">selector</span>:<span style="color:#062873;font-weight:700">app</span>:hab-bastion<span style="color:#062873;font-weight:700">clusterIP</span>:None<span style="color:#0e84b5;font-weight:700">---</span><span style="color:#062873;font-weight:700">apiVersion</span>:apps/v1<span style="color:#062873;font-weight:700">kind</span>:StatefulSet<span style="color:#062873;font-weight:700">metadata</span>:<span style="color:#062873;font-weight:700">name</span>:hab-bastion<span style="color:#062873;font-weight:700">spec</span>:<span style="color:#062873;font-weight:700">selector</span>:<span style="color:#062873;font-weight:700">matchLabels</span>:<span style="color:#062873;font-weight:700">app</span>:hab-bastion<span style="color:#062873;font-weight:700">serviceName</span>:hab-bastion<span style="color:#062873;font-weight:700">replicas</span>:<span style="color:#40a070">1</span><span style="color:#062873;font-weight:700">template</span>:<span style="color:#062873;font-weight:700">metadata</span>:<span style="color:#062873;font-weight:700">labels</span>:<span style="color:#062873;font-weight:700">app</span>:hab-bastion<span style="color:#062873;font-weight:700">spec</span>:<span style="color:#062873;font-weight:700">terminationGracePeriodSeconds</span>:<span style="color:#40a070">10</span><span style="color:#062873;font-weight:700">securityContext</span>:<span style="color:#062873;font-weight:700">fsGroup</span>:<span style="color:#40a070">42</span><span style="color:#062873;font-weight:700">containers</span>:- <span style="color:#062873;font-weight:700">name</span>:hab-bastion<span style="color:#062873;font-weight:700">image</span>:irvingpop/hab_bastion:latest<span style="color:#062873;font-weight:700">args</span>:- <span style="color:#4070a0">'--permanent-peer'</span><span style="color:#062873;font-weight:700">resources</span>:<span style="color:#062873;font-weight:700">requests</span>:<span style="color:#062873;font-weight:700">memory</span>:<span style="color:#4070a0">"100Mi"</span><span style="color:#062873;font-weight:700">cpu</span>:<span style="color:#4070a0">"100m"</span><span style="color:#60a0b0;font-style:italic"># equivalent to 0.1 of a CPU core</span><span style="color:#062873;font-weight:700">ports</span>:- <span style="color:#062873;font-weight:700">name</span>:gossip-listener<span style="color:#062873;font-weight:700">protocol</span>:UDP<span style="color:#062873;font-weight:700">containerPort</span>:<span style="color:#40a070">9638</span>- <span style="color:#062873;font-weight:700">name</span>:http-gateway<span style="color:#062873;font-weight:700">protocol</span>:TCP<span style="color:#062873;font-weight:700">containerPort</span>:<span style="color:#40a070">9631</span><span style="color:#062873;font-weight:700">readinessProbe</span>:<span style="color:#062873;font-weight:700">httpGet</span>:<span style="color:#062873;font-weight:700">path</span>:/<span style="color:#062873;font-weight:700">port</span>:<span style="color:#40a070">9631</span><span style="color:#062873;font-weight:700">initialDelaySeconds</span>:<span style="color:#40a070">5</span><span style="color:#062873;font-weight:700">periodSeconds</span>:<span style="color:#40a070">10</span><span style="color:#062873;font-weight:700">livenessProbe</span>:<span style="color:#062873;font-weight:700">httpGet</span>:<span style="color:#062873;font-weight:700">path</span>:/<span style="color:#062873;font-weight:700">port</span>:<span style="color:#40a070">9631</span><span style="color:#062873;font-weight:700">initialDelaySeconds</span>:<span style="color:#40a070">15</span><span style="color:#062873;font-weight:700">periodSeconds</span>:<span style="color:#40a070">20</span><span style="color:#062873;font-weight:700">volumeMounts</span>:- <span style="color:#062873;font-weight:700">name</span>:hab-bastion<span style="color:#062873;font-weight:700">mountPath</span>:/hab/sup<span style="color:#062873;font-weight:700">volumeClaimTemplates</span>:- <span style="color:#062873;font-weight:700">metadata</span>:<span style="color:#062873;font-weight:700">name</span>:hab-bastion<span style="color:#062873;font-weight:700">spec</span>:<span style="color:#062873;font-weight:700">accessModes</span>:[<span style="color:#4070a0">"ReadWriteOnce"</span>]<span style="color:#60a0b0;font-style:italic"># uncomment if you don't have a default storageclass</span><span style="color:#60a0b0;font-style:italic"># storageClassName: "standard"</span><span style="color:#062873;font-weight:700">resources</span>:<span style="color:#062873;font-weight:700">requests</span>:<span style="color:#062873;font-weight:700">storage</span>:10Gi</code></pre></div>
<h3 id="kubernetes-bastion-ring-consumer-pattern">Kubernetes Bastion Ring Consumer Pattern</h3> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">apiVersion</span>:apps/v1<span style="color:#062873;font-weight:700">kind</span>:StatefulSet<span style="color:#062873;font-weight:700">metadata</span>:<span style="color:#062873;font-weight:700">name</span>:cockroachdb<span style="color:#062873;font-weight:700">spec</span>:<span style="color:#062873;font-weight:700">selector</span>:<span style="color:#062873;font-weight:700">matchLabels</span>:<span style="color:#062873;font-weight:700">app</span>:cockroachdb<span style="color:#062873;font-weight:700">serviceName</span>:cockroachdb<span style="color:#062873;font-weight:700">replicas</span>:<span style="color:#40a070">3</span><span style="color:#062873;font-weight:700">template</span>:<span style="color:#062873;font-weight:700">metadata</span>:<span style="color:#062873;font-weight:700">labels</span>:<span style="color:#062873;font-weight:700">app</span>:cockroachdb<span style="color:#062873;font-weight:700">spec</span>:<span style="color:#062873;font-weight:700">terminationGracePeriodSeconds</span>:<span style="color:#40a070">10</span><span style="color:#062873;font-weight:700">securityContext</span>:<span style="color:#062873;font-weight:700">fsGroup</span>:<span style="color:#40a070">42</span><span style="color:#062873;font-weight:700">containers</span>:- <span style="color:#062873;font-weight:700">name</span>:cockroachdb<span style="color:#062873;font-weight:700">image</span>:irvingpop/cockroach:latest<span style="color:#062873;font-weight:700">args</span>:- --peer- hab-bastion- --topology- leader<span style="color:#60a0b0;font-style:italic">#        env:</span><span style="color:#60a0b0;font-style:italic">#        - name: HAB_COCKROACH</span><span style="color:#60a0b0;font-style:italic">#          value: |</span><span style="color:#062873;font-weight:700">resources</span>:<span style="color:#062873;font-weight:700">requests</span>:<span style="color:#062873;font-weight:700">memory</span>:<span style="color:#4070a0">"300Mi"</span><span style="color:#062873;font-weight:700">cpu</span>:<span style="color:#4070a0">"500m"</span><span style="color:#60a0b0;font-style:italic"># equivalent to 0.5 CPU core</span><span style="color:#062873;font-weight:700">ports</span>:- <span style="color:#062873;font-weight:700">name</span>:http<span style="color:#062873;font-weight:700">containerPort</span>:<span style="color:#40a070">8080</span>- <span style="color:#062873;font-weight:700">name</span>:cockroachdb<span style="color:#062873;font-weight:700">containerPort</span>:<span style="color:#40a070">26257</span><span style="color:#062873;font-weight:700">volumeMounts</span>:- <span style="color:#062873;font-weight:700">name</span>:cockroachdb-data<span style="color:#062873;font-weight:700">mountPath</span>:/hab/svc/cockroach/data<span style="color:#062873;font-weight:700">volumeClaimTemplates</span>:- <span style="color:#062873;font-weight:700">metadata</span>:<span style="color:#062873;font-weight:700">name</span>:cockroachdb-data<span style="color:#062873;font-weight:700">spec</span>:<span style="color:#062873;font-weight:700">accessModes</span>:[<span style="color:#4070a0">"ReadWriteOnce"</span>]<span style="color:#062873;font-weight:700">resources</span>:<span style="color:#062873;font-weight:700">requests</span>:<span style="color:#062873;font-weight:700">storage</span>:10Gi</code></pre></div>
<h2 id="hab-pkg-download-patterns">hab pkg download Patterns</h2> <p>The <code>hab pkg download</code> command can be used to download individual packages (along with their dependencies and keys) from Builder, without installing them. This allows you to more easily transfer packages from one Builder instance to another, or to take a selective snapshot of particular packages.</p> <p>While you can download packages one-at-a-time, it can be more convenient to use a file to specify your packages. Two formats are recognized: plain text and TOML.</p> <h3 id="plain-text-download-descriptors">Plain Text Download Descriptors</h3> <p>The simplest thing you can do is create a plain text file with a package identifier on each line, like so:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text"># These are the packages needed to run a Supervisor
core/hab-launcher
core/hab
core/hab-sup
</code></pre></div>
<p>Each line is a valid package identifier. You can also add comments using <code>#</code>.</p> <p>To download these packages (and their dependencies), save that to a file named <code>supervisor.txt</code> and run:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">hab pkg download --file<span style="color:#666">=</span>supervisor.txt
</code></pre></div>
<p>This will download the packages into your existing Habitat cache directory. Alternatively, you can specify a directory using the <code>--download-directory</code> option.</p> <p>(You can also specify <code>--channel</code> and <code>--target</code> to further control which specific packages you download; run <code>hab pkg download --help</code> for more).</p> <h3 id="toml-download-descriptors">TOML Download Descriptors</h3> <p>Plain text is fine for simple cases, but has drawbacks. For instance, all packages will come from the same channel and will be for the same platform target. For maximum flexibility, you’ll want to use TOML to write your download descriptor. Here is an example of one that the Habitat core team uses to take periodic snapshots of everything needed to run Builder itself:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">format_version = <span style="color:#40a070">1</span>
file_descriptor = <span style="color:#4070a0">"Packages needed to run an instance of Builder"</span>

[[x86_64-linux]]
channel = <span style="color:#4070a0">"stable"</span>
packages = [
  <span style="color:#60a0b0;font-style:italic"># Supervisor and prerequisites</span>
  <span style="color:#4070a0">"core/hab-launcher"</span>,
  <span style="color:#4070a0">"core/hab"</span>,
  <span style="color:#4070a0">"core/hab-sup"</span>,

  <span style="color:#60a0b0;font-style:italic"># Utilities</span>
  <span style="color:#4070a0">"core/sumologic"</span>,
  <span style="color:#4070a0">"core/nmap"</span>
]

<span style="color:#60a0b0;font-style:italic"># Targets can be repeated to specify additional subsets of packages,</span>
<span style="color:#60a0b0;font-style:italic"># possibly from different channels</span>
[[x86_64-linux]]
channel = <span style="color:#4070a0">"stable"</span>
packages = [
  <span style="color:#60a0b0;font-style:italic"># Builder services</span>
  <span style="color:#4070a0">"habitat/builder-api"</span>,
  <span style="color:#4070a0">"habitat/builder-api-proxy"</span>,
  <span style="color:#4070a0">"habitat/builder-jobsrv"</span>,
  <span style="color:#4070a0">"habitat/builder-worker"</span>,
  <span style="color:#4070a0">"habitat/builder-memcached"</span>,
]

[[x86_64-linux-kernel2]]
channel = <span style="color:#4070a0">"stable"</span>
packages = [
  <span style="color:#60a0b0;font-style:italic"># Supervisor and prerequisites</span>
  <span style="color:#4070a0">"core/hab-launcher"</span>,
  <span style="color:#4070a0">"core/hab"</span>,
  <span style="color:#4070a0">"core/hab-sup"</span>,

  <span style="color:#4070a0">"habitat/builder-worker"</span>
]

[[x86_64-windows]]
channel = <span style="color:#4070a0">"stable"</span>
packages = [
  <span style="color:#60a0b0;font-style:italic"># Supervisor and prerequisites</span>
  <span style="color:#4070a0">"core/windows-service"</span>,
  <span style="color:#4070a0">"core/hab"</span>,
  <span style="color:#4070a0">"core/hab-sup"</span>,

  <span style="color:#4070a0">"habitat/builder-worker"</span>
]
</code></pre></div>
<p>This format allows us to specify multiple subsets of packages from different channels and for different architectures. Here, we are pulling down all the core service packages, which run on Linux, but are also pulling down the platform-specific versions of the <code>habitat/builder-worker</code> package. Without this format, we would have to invoke <code>hab pkg download</code> multiple times with different parameters. The file allows us to capture our full intention in one place.</p> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/habitat/pattern_library/" class="_attribution-link">https://docs.chef.io/habitat/pattern_library/</a>
  </p>
</div>
