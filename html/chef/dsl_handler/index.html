<div id="col-content" data-swiftype-index="true"> <div id="about-the-handler-dsl"><h1>About the Handler DSL</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/chef-web-docs/blob/main/content/dsl_handler.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>Use the Handler DSL to attach a callback to an event. If the event occurs during a Chef Infra Client run, the associated callback is executed. For example:</p> <ul> <li>Sending email if a Chef Infra Client run fails</li> <li>Aggregating statistics about resources updated during a Chef Infra Client runs to StatsD</li> </ul> <h2 id="on-method">on Method</h2> <p>Use the <code>on</code> method to associate an event type with a callback. The callback defines what steps are taken if the event occurs during a Chef Infra Client run and is defined using arbitrary Ruby code. The syntax is as follows:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60add5">Chef</span><span style="color:#666">.</span>event_handler <span style="color:#007020;font-weight:700">do</span>
  on <span style="color:#517918">:event_type</span> <span style="color:#007020;font-weight:700">do</span>
    <span style="color:#60a0b0;font-style:italic"># some Ruby</span>
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>where</p> <ul> <li>
<code>Chef.event_handler</code> declares a block of code within a recipe that is processed when the named event occurs during a Chef Infra Client run</li> <li>
<code>on</code> defines the block of code that will tell Chef Infra Client how to handle the event</li> <li>
<code>:event_type</code> is a valid exception event type, such as <code>:run_start</code>, <code>:run_failed</code>, <code>:converge_failed</code>, <code>:resource_failed</code>, or <code>:recipe_not_found</code>
</li> </ul> <p>For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">Chef.event_handler <span style="color:#007020;font-weight:700">do</span>
  on :converge_start <span style="color:#007020;font-weight:700">do</span>
    puts <span style="color:#4070a0">"Ohai! I have started a converge."</span>
  end
end
</code></pre></div>
<h2 id="event-types">Event Types</h2> <p>The following table describes the events that may occur during a Chef Infra Client run. Each of these events may be referenced in an <code>on</code> method block by declaring it as the event type.</p> <table> <col style="width:19%"> <col style="width:80%"> <thead> <tr class="header"> <th>Event</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>:run_start</code></td> <td>The start of a Chef Infra Client run.</td> </tr> <tr> <td><code>:run_started</code></td> <td>The Chef Infra Client run has started.</td> </tr> <tr> <td><code>:run_completed</code></td> <td>The Chef Infra Client run has completed.</td> </tr> <tr> <td><code>:run_failed</code></td> <td>The Chef Infra Client run has failed.</td> </tr> <tr> <td><code>:ohai_completed</code></td> <td>The Ohai run has completed.</td> </tr> <tr> <td><code>:skipping_registration</code></td> <td>The Chef Infra Client is not registering with the Chef Infra Server because it already has a private key or because it does not need one.</td> </tr> <tr> <td><code>:registration_start</code></td> <td>The Chef Infra Client is attempting to create a private key with which to register to the Chef Infra Server.</td> </tr> <tr> <td><code>:registration_completed</code></td> <td>The Chef Infra Client created its private key successfully.</td> </tr> <tr> <td><code>:registration_failed</code></td> <td>The Chef Infra Client encountered an error and was unable to register with the Chef Infra Server.</td> </tr> <tr> <td><code>:node_load_start</code></td> <td>The Chef Infra Client is attempting to load node data from the Chef Infra Server.</td> </tr> <tr> <td><code>:node_load_success</code></td> <td>The Chef Infra Client successfully loaded node data from the policy builder.</td> </tr> <tr> <td><code>:node_load_failed</code></td> <td>The Chef Infra Client encountered an error and was unable to load node data from the Chef Infra Server.</td> </tr> <tr> <td><code>:run_list_expand_failed</code></td> <td>The Chef Infra Client failed to expand the run-list.</td> </tr> <tr> <td><code>:node_load_completed</code></td> <td>The Chef Infra Client successfully loaded node data from the Chef Infra Server. Default and override attributes for roles have been computed, but are not yet applied.</td> </tr> <tr> <td><code>:policyfile_loaded</code></td> <td>The policy file was loaded.</td> </tr> <tr> <td><code>:cookbook_resolution_start</code></td> <td>The Chef Infra Client is attempting to pull down the cookbook collection from the Chef Infra Server.</td> </tr> <tr> <td><code>:cookbook_resolution_failed</code></td> <td>The Chef Infra Client failed to pull down the cookbook collection from the Chef Infra Server.</td> </tr> <tr> <td><code>:cookbook_resolution_complete</code></td> <td>The Chef Infra Client successfully pulled down the cookbook collection from the Chef Infra Server.</td> </tr> <tr> <td><code>:cookbook_clean_start</code></td> <td>The Chef Infra Client is attempting to remove unneeded cookbooks.</td> </tr> <tr> <td><code>:removed_cookbook_file</code></td> <td>The Chef Infra Client removed a file from a cookbook.</td> </tr> <tr> <td><code>:cookbook_clean_complete</code></td> <td>The Chef Infra Client is done removing cookbooks and/or cookbook files.</td> </tr> <tr> <td><code>:cookbook_sync_start</code></td> <td>The Chef Infra Client is attempting to synchronize cookbooks.</td> </tr> <tr> <td><code>:synchronized_cookbook</code></td> <td>The Chef Infra Client is attempting to synchronize the named cookbook.</td> </tr> <tr> <td><code>:updated_cookbook_file</code></td> <td>The Chef Infra Client updated the named file in the named cookbook.</td> </tr> <tr> <td><code>:cookbook_sync_failed</code></td> <td>The Chef Infra Client was unable to synchronize cookbooks.</td> </tr> <tr> <td><code>:cookbook_sync_complete</code></td> <td>The Chef Infra Client is finished synchronizing cookbooks.</td> </tr> <tr> <td><code>:cookbook_gem_start</code></td> <td>The Chef Infra Client is collecting gems from the cookbooks.</td> </tr> <tr> <td><code>:cookbook_gem_installing</code></td> <td>The Chef Infra Client is installing a cookbook gem.</td> </tr> <tr> <td><code>:cookbook_gem_using</code></td> <td>The Chef Infra Client is using a cookbook gem.</td> </tr> <tr> <td><code>:cookbook_gem_finished</code></td> <td>The Chef Infra Client finished installing cookbook gems.</td> </tr> <tr> <td><code>:cookbook_gem_failed</code></td> <td>The Chef Infra Client failed to install cookbook gems.</td> </tr> <tr> <td><code>:cookbook_compilation_start</code></td> <td> The Chef Infra Client created the run_context and is starting cookbook compilation.</td> </tr> <tr> <td><code>:library_load_start</code></td> <td>The Chef Infra Client is loading library files.</td> </tr> <tr> <td><code>:library_file_loaded</code></td> <td>The Chef Infra Client successfully loaded the named library file.</td> </tr> <tr> <td><code>:library_file_load_failed</code></td> <td>The Chef Infra Client was unable to load the named library file.</td> </tr> <tr> <td><code>:library_load_complete</code></td> <td>The Chef Infra Client is finished loading library files.</td> </tr> <tr> <td><code>:lwrp_load_start</code></td> <td>The Chef Infra Client is loading custom resources.</td> </tr> <tr> <td><code>:lwrp_file_loaded</code></td> <td>The Chef Infra Client successfully loaded the named custom resource.</td> </tr> <tr> <td><code>:lwrp_file_load_failed</code></td> <td>The Chef Infra Client was unable to load the named custom resource.</td> </tr> <tr> <td><code>:lwrp_load_complete</code></td> <td>The Chef Infra Client is finished loading custom resources.</td> </tr> <tr> <td><code>:ohai_plugin_load_start</code></td> <td>Ohai has started loading plugins.</td> </tr> <tr> <td><code>:ohai_plugin_file_loaded</code></td> <td>Ohai has loaded a plugin.</td> </tr> <tr> <td><code>:ohai_plugin_file_load_failed</code></td> <td>Ohai failed to load a plugin.</td> </tr> <tr> <td><code>:ohai_plugin_load_complete</code></td> <td>Ohai has completed loading plugins.</td> </tr> <tr> <td><code>:attribute_load_start</code></td> <td>The Chef Infra Client is loading attribute files.</td> </tr> <tr> <td><code>:attribute_file_loaded</code></td> <td>The Chef Infra Client successfully loaded the named attribute file.</td> </tr> <tr> <td><code>:attribute_file_load_failed</code></td> <td>The Chef Infra Client was unable to load the named attribute file.</td> </tr> <tr> <td><code>:attribute_load_complete</code></td> <td>The Chef Infra Client is finished loading attribute files.</td> </tr> <tr> <td><code>:definition_load_start</code></td> <td>The Chef Infra Client is loading definitions.</td> </tr> <tr> <td><code>:definition_file_loaded</code></td> <td>The Chef Infra Client successfully loaded the named definition.</td> </tr> <tr> <td><code>:definition_file_load_failed</code></td> <td>The Chef Infra Client was unable to load the named definition.</td> </tr> <tr> <td><code>:definition_load_complete</code></td> <td>The Chef Infra Client is finished loading definitions.</td> </tr> <tr> <td><code>:recipe_load_start</code></td> <td>The Chef Infra Client is loading recipes.</td> </tr> <tr> <td><code>:recipe_file_loaded</code></td> <td>The Chef Infra Client successfully loaded the named recipe.</td> </tr> <tr> <td><code>:recipe_file_load_failed</code></td> <td>The Chef Infra Client was unable to load the named recipe.</td> </tr> <tr> <td><code>:recipe_not_found</code></td> <td>The Chef Infra Client was unable to find the named recipe.</td> </tr> <tr> <td><code>:recipe_load_complete</code></td> <td>The Chef Infra Client is finished loading recipes.</td> </tr> <tr> <td><code>:cookbook_compilation_complete</code></td> <td>The Chef Infra Client completed all cookbook compilation phases.</td> </tr> <tr> <td><code>:converge_start</code></td> <td>The Chef Infra Client run converge phase has started.</td> </tr> <tr> <td><code>:action_collection_registration</code></td> <td>Provides a reference to the action_collection before cookbooks are compiled.</td> </tr> <tr> <td><code>:converge_complete</code></td> <td>The Chef Infra Client run converge phase is complete.</td> </tr> <tr> <td><code>:converge_failed</code></td> <td>The Chef Infra Client run converge phase has failed.</td> </tr> <tr> <td><code>:control_group_started</code></td> <td>The named control group is being processed.</td> </tr> <tr> <td><code>:control_example_success</code></td> <td>The named control group has been processed.</td> </tr> <tr> <td><code>:control_example_failure</code></td> <td>The named control group's processing has failed.</td> </tr> <tr> <td><code>:resource_action_start</code></td> <td>A resource action is starting.</td> </tr> <tr> <td><code>:resource_skipped</code></td> <td>A resource action was skipped.</td> </tr> <tr> <td><code>:resource_current_state_loaded</code></td> <td>A resource's current state was loaded.</td> </tr> <tr> <td><code>:resource_after_state_loaded</code></td> <td>A resource's after state was loaded.</td> </tr> <tr> <td><code>:resource_current_state_load_bypassed</code></td> <td>A resource's current state was not loaded because the resource does not support why-run mode.</td> </tr> <tr> <td><code>:resource_bypassed</code></td> <td>A resource action was skipped because the resource does not support why-run mode.</td> </tr> <tr> <td><code>:resource_update_applied</code></td> <td>A change has been made to a resource. (This event occurs for each change made to a resource.)</td> </tr>
<tr> <td><code>:resource_update_progress</code></td> <td>A resource sent a progress notification to the user to indicate overall progress of a long running operation.</td> </tr> <tr> <td><code>:resource_failed_retriable</code></td> <td>A resource action has failed and will be retried.</td> </tr> <tr> <td><code>:resource_failed</code></td> <td>A resource action has failed and will not be retried.</td> </tr> <tr> <td><code>:resource_updated</code></td> <td>A resource requires modification.</td> </tr> <tr> <td><code>:resource_up_to_date</code></td> <td>A resource is already correct.</td> </tr> <tr> <td><code>:resource_completed</code></td> <td>All actions for the resource are complete.</td> </tr> <tr> <td><code>:stream_opened</code></td> <td>A stream has opened.</td> </tr> <tr> <td><code>:stream_closed</code></td> <td>A stream has closed.</td> </tr> <tr> <td><code>:stream_output</code></td> <td>A chunk of data from a single named stream.</td> </tr> <tr> <td><code>:handlers_start</code></td> <td>The handler processing phase of a Chef Infra Client run has started.</td> </tr> <tr> <td><code>:handler_executed</code></td> <td>The named handler was processed.</td> </tr> <tr> <td><code>:handlers_completed</code></td> <td>The handler processing phase of a Chef Infra Client run is complete.</td> </tr> <tr> <td><code>:provider_requirement_failed</code></td> <td>An assertion declared by a provider has failed.</td> </tr> <tr> <td><code>:whyrun_assumption</code></td> <td>An assertion declared by a provider has failed, but execution is allowed to continue because the Chef Infra Client is running in why-run mode.</td> </tr> <td><code>:deprecation</code></td> <td>A deprecation message has been emitted.</td> <tr> <td><code>:attribute_changed</code></td> <td>Prints out all the attribute changes in cookbooks or sets a policy that override attributes should never be used.</td> </tr> </tbody> </table> <h2 id="examples">Examples</h2> <p>The following examples show ways to use the Handler DSL.</p> <h3 id="send-email">Send Email</h3> <p>Use the <code>on</code> method to create an event handler that sends email when a Chef Infra Client run fails. This will require:</p> <ul> <li>A way to tell Chef Infra Client how to send email</li> <li>An event handler that describes what to do when the <code>:run_failed</code> event is triggered</li> <li>A way to trigger the exception and test the behavior of the event handler</li> </ul> <h4 id="define-how-email-is-sent">Define How Email is Sent</h4> <p>Use a library to define the code that sends email when a Chef Infra Client run fails. Name the file <code>helper.rb</code> and add it to a cookbook’s <code>/libraries</code> directory:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#007020">require</span> <span style="color:#4070a0">'net/smtp'</span>

<span style="color:#007020;font-weight:700">module</span> <span style="color:#0e84b5;font-weight:700">HandlerSendEmail</span>
  <span style="color:#007020;font-weight:700">class</span> <span style="color:#0e84b5;font-weight:700">Helper</span>
    <span style="color:#007020;font-weight:700">def</span> <span style="color:#06287e">send_email_on_run_failure</span>(node_name)
      message <span style="color:#666">=</span> <span style="color:#4070a0">"From: Chef &lt;chef@chef.io&gt;</span><span style="color:#4070a0;font-weight:700">\n</span><span style="color:#4070a0">"</span>
      message <span style="color:#666">&lt;&lt;</span> <span style="color:#4070a0">"To: Grant &lt;grantmc@chef.io&gt;</span><span style="color:#4070a0;font-weight:700">\n</span><span style="color:#4070a0">"</span>
      message <span style="color:#666">&lt;&lt;</span> <span style="color:#4070a0">"Subject: Chef run failed</span><span style="color:#4070a0;font-weight:700">\n</span><span style="color:#4070a0">"</span>
      message <span style="color:#666">&lt;&lt;</span> <span style="color:#4070a0">"Date: </span><span style="color:#70a0d0;font-style:italic">#{</span><span style="color:#60add5">Time</span><span style="color:#666">.</span>now<span style="color:#666">.</span>rfc2822<span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0;font-weight:700">\n\n</span><span style="color:#4070a0">"</span>
      message <span style="color:#666">&lt;&lt;</span> <span style="color:#4070a0">"Chef run failed on </span><span style="color:#70a0d0;font-style:italic">#{</span>node_name<span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0;font-weight:700">\n</span><span style="color:#4070a0">"</span>
      <span style="color:#60add5">Net</span><span style="color:#666">::</span><span style="color:#60add5">SMTP</span><span style="color:#666">.</span>start(<span style="color:#4070a0">'localhost'</span>, <span style="color:#40a070">25</span>) <span style="color:#007020;font-weight:700">do</span> <span style="color:#666">|</span>smtp<span style="color:#666">|</span>
        smtp<span style="color:#666">.</span>send_message message, <span style="color:#4070a0">'chef@chef.io'</span>, <span style="color:#4070a0">'grantmc@chef.io'</span>
      <span style="color:#007020;font-weight:700">end</span>
    <span style="color:#007020;font-weight:700">end</span>
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div> <h4 id="add-the-handler">Add the Handler</h4> <p>Invoke the library helper in a recipe:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60add5">Chef</span><span style="color:#666">.</span>event_handler <span style="color:#007020;font-weight:700">do</span>
  on <span style="color:#517918">:run_failed</span> <span style="color:#007020;font-weight:700">do</span>
    <span style="color:#60add5">HandlerSendEmail</span><span style="color:#666">::</span><span style="color:#60add5">Helper</span><span style="color:#666">.</span>new<span style="color:#666">.</span>send_email_on_run_failure(
      <span style="color:#60add5">Chef</span><span style="color:#666">.</span>run_context<span style="color:#666">.</span>node<span style="color:#666">.</span>name
    )
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<ul> <li>Use <code>Chef.event_handler</code> to define the event handler</li> <li>Use the <code>on</code> method to specify the event type</li> </ul> <p>Within the <code>on</code> block, tell Chef Infra Client how to handle the event when it’s triggered.</p> <h4 id="test-the-handler">Test the Handler</h4> <p>Use the following code block to trigger the exception and have the Chef Infra Client send email to the specified email address:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">ruby_block <span style="color:#4070a0">'fail the run'</span> <span style="color:#007020;font-weight:700">do</span>
  block <span style="color:#007020;font-weight:700">do</span>
    <span style="color:#007020;font-weight:700">raise</span> <span style="color:#4070a0">'deliberately fail the run'</span>
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h3 id="etcd-locks">etcd Locks</h3> <p>The following example shows how to prevent concurrent Chef Infra Client runs from both holding a lock on etcd:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">lock_key <span style="color:#666">=</span> <span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">#{</span>node<span style="color:#666">.</span>chef_environment<span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">/</span><span style="color:#70a0d0;font-style:italic">#{</span>node<span style="color:#666">.</span>name<span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">"</span>

<span style="color:#60add5">Chef</span><span style="color:#666">.</span>event_handler <span style="color:#007020;font-weight:700">do</span>
  on <span style="color:#517918">:converge_start</span> <span style="color:#007020;font-weight:700">do</span> <span style="color:#666">|</span>run_context<span style="color:#666">|</span>
    <span style="color:#60add5">Etcd</span><span style="color:#666">.</span>lock_acquire(lock_key)
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>

<span style="color:#60add5">Chef</span><span style="color:#666">.</span>event_handler <span style="color:#007020;font-weight:700">do</span>
  on <span style="color:#517918">:converge_complete</span> <span style="color:#007020;font-weight:700">do</span>
    <span style="color:#60add5">Etcd</span><span style="color:#666">.</span>lock_release(lock_key)
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h3 id="hipchat-notifications">HipChat Notifications</h3> <p>Event messages can be sent to a team communication tool like HipChat. For example, if a Chef Infra Client run fails:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60add5">Chef</span><span style="color:#666">.</span>event_handler <span style="color:#007020;font-weight:700">do</span>
  on <span style="color:#517918">:run_failed</span> <span style="color:#007020;font-weight:700">do</span> <span style="color:#666">|</span>exception<span style="color:#666">|</span>
    hipchat_notify exception<span style="color:#666">.</span>message
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>or send an alert on a configuration change:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60add5">Chef</span><span style="color:#666">.</span>event_handler <span style="color:#007020;font-weight:700">do</span>
  on <span style="color:#517918">:resource_updated</span> <span style="color:#007020;font-weight:700">do</span> <span style="color:#666">|</span>resource, action<span style="color:#666">|</span>
    <span style="color:#007020;font-weight:700">if</span> resource<span style="color:#666">.</span>to_s <span style="color:#666">==</span> <span style="color:#4070a0">'template[/etc/nginx/nginx.conf]'</span>
      <span style="color:#60add5">Helper</span><span style="color:#666">.</span>hipchat_message(<span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">#{</span>resource<span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0"> was updated by chef"</span>)
    <span style="color:#007020;font-weight:700">end</span>
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h3 id="attribute_changed-event-hook">
<code>attribute_changed</code> event hook</h3> <p>In a cookbook library file, you can add this in order to print out all attribute changes in cookbooks:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60add5">Chef</span><span style="color:#666">.</span>event_handler <span style="color:#007020;font-weight:700">do</span>
  on <span style="color:#517918">:attribute_changed</span> <span style="color:#007020;font-weight:700">do</span> <span style="color:#666">|</span>precedence, key, value<span style="color:#666">|</span>
    <span style="color:#007020">puts</span> <span style="color:#4070a0">"setting attribute </span><span style="color:#70a0d0;font-style:italic">#{</span>precedence<span style="color:#70a0d0;font-style:italic">}#{</span>key<span style="color:#666">.</span>map <span style="color:#70a0d0;font-style:italic">{</span> <span style="color:#666">|</span>n<span style="color:#666">|</span> <span style="color:#4070a0">"[</span><span style="color:#4070a0;font-weight:700">\"</span><span style="color:#70a0d0;font-style:italic">#{</span>n<span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0;font-weight:700">\"</span><span style="color:#4070a0">]"</span> <span style="color:#70a0d0;font-style:italic">}</span><span style="color:#666">.</span>join<span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0"> = </span><span style="color:#70a0d0;font-style:italic">#{</span>value<span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">"</span>
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>If you want to setup a policy that override attributes should never be used:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60add5">Chef</span><span style="color:#666">.</span>event_handler <span style="color:#007020;font-weight:700">do</span>
  on <span style="color:#517918">:attribute_changed</span> <span style="color:#007020;font-weight:700">do</span> <span style="color:#666">|</span>precedence, key, value<span style="color:#666">|</span>
    <span style="color:#007020;font-weight:700">raise</span> <span style="color:#4070a0">'override policy violation'</span> <span style="color:#007020;font-weight:700">if</span> precedence <span style="color:#666">==</span> <span style="color:#517918">:override</span>
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/dsl_handler/" class="_attribution-link">https://docs.chef.io/dsl_handler/</a>
  </p>
</div>
