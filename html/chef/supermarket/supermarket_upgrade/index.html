<div id="col-content" data-swiftype-index="true"> <div id="upgrade-supermarket"><h1>Upgrade Supermarket</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/supermarket/blob/main/docs-chef-io/content/supermarket/supermarket_upgrade.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <h2 id="upgrade-matrix">Upgrade Matrix</h2> <table> <thead> <tr> <th>Running Version</th> <th>Upgrade Version</th> <th>Supported Version</th> </tr> </thead> <tbody> <tr> <td>A1</td> <td>B1</td> <td>C1</td> </tr> <tr> <td>A2</td> <td>B2</td> <td>C2</td> </tr> <tr> <td>A3</td> <td>B3</td> <td>C3</td> </tr> </tbody> </table> <h2 id="upgrade-supermarket">Upgrade Supermarket</h2> <h3 id="database-preparation">Database Preparation</h3> <h3 id="upgrade-steps">Upgrade Steps</h3> <h2 id="external-postgresql">External PostgreSQL</h2> <p>The External PostgreSQL upgrade steps are provided as a courtesy. It is the responsibility of the user to upgrade and maintain any External PostgreSQL configurations.</p> <p>Follow these steps to upgrade the PostgreSQL major version.</p> <h2 id="upgrade-supermarket-1">Upgrade Supermarket</h2> <p>Do we need to upgrade Supermarket first?</p> <h3 id="backup-postgresql-database">Backup PostgreSQL Database</h3> <ol> <li>Stop the Supermarket application</li> </ol> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">sudo supermarket-ctl stop
</code></pre></div>
<ol> <li>Start the Supermarket PostgreSQL service</li> </ol> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">sudo supermarket-ctl start postgresql
</code></pre></div>
<ol> <li>Back up the PostgreSQL database</li> </ol> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">/opt/supermarket/embedded/bin/pg_dumpall -U supermarket -p <span style="color:#40a070">15432</span> &gt; /tmp/supermarket-dump.sql
</code></pre></div>
<ol> <li>Vacuum the PostgreSQL database:</li> </ol> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">/opt/supermarket/embedded/bin/vacuumdb --all --full -p <span style="color:#40a070">15432</span>
</code></pre></div>
<ol> <li>Reindex the PostgreSQL database:</li> </ol> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">/opt/supermarket/embedded/bin/reindexdb --all -p <span style="color:#40a070">15432</span>
</code></pre></div>
<ol> <li>Restart the Supermarket application</li> </ol> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">supermarket-ctl restart
</code></pre></div>
<h3 id="recovering-from-upgrade-failures">Recovering from Upgrade Failures</h3> <p>If either the <code>vacuumdb</code> or <code>reindexdb</code> commands fail</p> <ol> <li>Drop the Supermarket PostgreSQL database</li> </ol> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">/opt/supermarket/embedded/bin/psql -U supermarket -d postgres -p <span style="color:#40a070">15432</span> -c <span style="color:#4070a0">"drop database supermarket"</span>
</code></pre></div>
<ol> <li>Recreate the Supermarket PostgreSQL database</li> </ol> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">/opt/supermarket/embedded/bin/psql -U supermarket -d postgres -p <span style="color:#40a070">15432</span> -c <span style="color:#4070a0">"create database supermarket"</span>
</code></pre></div>
<ol> <li>Restore Supermarket PostgreSQL database from the existing <code>dump.sql</code> file</li> </ol> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">/opt/supermarket/embedded/bin/psql -U supermarket -d supermarket -p <span style="color:#40a070">15432</span> -f /tmp/supermarket-dump.sql
</code></pre></div>
<ol> <li>Restart the Supermarket application</li> </ol> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">supermarket-ctl restart
</code></pre></div> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/supermarket/supermarket_upgrade/" class="_attribution-link">https://docs.chef.io/supermarket/supermarket_upgrade/</a>
  </p>
</div>
