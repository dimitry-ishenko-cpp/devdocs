<div id="col-content" data-swiftype-index="true"> <div id="monitor"><h1>Monitor</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/chef-server/blob/main/docs-chef-io/content/server/server_monitor.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>Monitoring the Chef Infra Server involves two types of checks: application and system. In addition monitoring the HTTP requests that workstations and nodes are making to the Chef Infra Server and per-disk data storage volumes is recommended.</p> <h2 id="monitoring-priorities">Monitoring Priorities</h2> <p>The following sections describe the priorities for monitoring of the Chef Infra Server. In particular, running out of disk space is the primary cause of failure.</p> <h3 id="disks">Disks</h3> <p>Over time, and with enough data, disks will fill up or exceed the per-disk quotas that may have been set for them and they will not be able to write data. A disk that is not able to write data will not be able to support certain components of the Chef Infra Server, such as PostgreSQL, service log files, and deleted file handles. Monitoring disk usage is the best way to ensure that disks don’t fill up or exceed their quota.</p> <p>Use the following commands to monitor global disk usage on a Chef Infra Server with a typical installation:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">du -sh /var/opt/opscode
</code></pre></div>
<p>and:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">du -sh /var/log/opscode
</code></pre></div>
<p>To keep the Chef Infra Server healthy, both <code>/var/opt/opscode</code> and <code>/var/log/opscode</code> should never exceed 80% use. In situations where disk space grows at a rapid pace, it may be preferable to shut down the Chef Infra Server and contact Chef support.</p> <p>The following components should be monitored for signs that disks may be rapidly filling up:</p> <ul> <li>
<strong>PostgreSQL</strong> PostgreSQL is the data store for the Chef Infra Server.</li> <li>
<strong>Log files</strong> If <code>/var/log/opscode</code> is taking up a lot of disk space, ensure that the Chef Infra Server log rotation cron job is running without errors. These errors can be found in <code>/var/log/messages</code>, <code>/var/log/syslog</code> and/or the root user’s local mail.</li> <li>
<strong>Deleted file handles</strong> Running processes with file handles associated with one (or more) deleted files will prevent the disk space being used by the deleted files from being reclaimed. Use the <code>sudo lsof | grep '(deleted)'</code> command to find all deleted file handles.</li> </ul> <h2 id="application-checks">Application Checks</h2> <p>Application-level checks should be done periodically to ensure that there is enough disk space, enough memory, and that the front-end and back-end services are communicating.</p> <h3 id="erlang">Erlang</h3> <p>Many components of the Chef Infra Server are written using Erlang and run on the BEAM virtual machine. One feature of Erlang and BEAM is the ability to interact with the running service using a command shell. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#007020">cd</span> /opt/opscode/embedded
  <span style="color:#007020">export</span> <span style="color:#bb60d5">PATH</span><span style="color:#666">=</span><span style="color:#bb60d5">$PATH</span>:/opt/opscode/bin:/opt/opscode/embedded/bin
  bin/erl -setcookie service_name -name me@127.0.0.1 -remsh service_name@127.0.0.1
</code></pre></div>
<p>where <code>service_name</code> is <code>bifrost</code> or <code>erchef</code>. This command will then open a shell that is connected to the Erchef processes:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">Erlang R15B02 <span style="color:#666">(</span>erts-5.9.2<span style="color:#666">)</span> <span style="color:#666">[</span>source<span style="color:#666">]</span> <span style="color:#666">[</span>64-bit<span style="color:#666">]</span> ...
</code></pre></div>
<div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> Connecting to the Erlang processes should only be done when directed by Chef support services. </div> </div> <p>To connect to the <strong>oc_bifrost</strong> service, use the following command:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">erl -setcookie oc_bifrost -name me@127.0.0.1 -remsh oc_bifrost@127.0.0.1
</code></pre></div>
<p>To connect to the <strong>opscode-erchef</strong> service, use the following command:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">erl -setcookie erchef -name me@127.0.0.1 -remsh erchef@127.0.0.1
</code></pre></div>
<p>To disconnect from the shell, use the following key sequence <code>CTRL-g</code>, <code>q</code>, and then <code>ENTER</code>.</p> <p>The output from the shell after the <code>CTRL-g</code> looks similar to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#666">(</span>erchef@127.0.0.1<span style="color:#666">)</span>1&gt;
User switch <span style="color:#007020">command</span>
</code></pre></div>
<p>then enter <code>q</code>, and then hit <code>ENTER</code> to exit the shell.</p> <p>Some commands should not be entered when interacting with a running service while using the command shell, including:</p> <ul> <li>
<code>q()</code> kills the Erlang node</li> <li><code>init:stop()</code></li> <li>
<code>exit</code> or <code>exit()</code> does nothing</li> </ul> <h4 id="eper-tools">
<code>eper</code> tools</h4> <p>As root on the Chef Infra Server, point to the bundled <code>eper</code> package of debugging tools. Replace the 2nd and 5th path entries and the <code>X.XX.X</code> value in the following path with the items that occur on the system.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#007020">export</span> <span style="color:#bb60d5">ERL_LIB</span><span style="color:#666">=</span>:/opt/<span style="color:#666">{</span>chef-server,opscode<span style="color:#666">}</span>/embedded/service/<span style="color:#666">{</span>erchef,opscode-erchef<span style="color:#666">}</span>/lib/eper-X.XX.X/ebin/
</code></pre></div>
<p>Open an Erlang command shell to begin diagnosing service issues on the Chef Infra Server:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">Eshell V5.10.4  <span style="color:#666">(</span>abort with ^G<span style="color:#666">)</span>
<span style="color:#666">(</span>erchef@127.0.0.1<span style="color:#666">)</span>1&gt;
</code></pre></div>
<p>The <code>dtop</code> tool presents a view on the Erlang virtual machine that is similar to the <code>linuxdagnostic</code> command. The period at the end of the dtop command is required for the command to take effect.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#666">(</span>erchef@127.0.0.1<span style="color:#666">)</span>1&gt; dtop:start<span style="color:#666">()</span>.
</code></pre></div>
<p>To stop the <code>dtop</code> command, run:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#666">(</span>erchef@127.0.0.1<span style="color:#666">)</span>1&gt; dtop:stop<span style="color:#666">()</span>.
</code></pre></div>
<p>To disconnect from the shell, use the following key sequence <code>CTRL-g</code>, <code>q</code>, and then <code>ENTER</code>.</p> <p>The output from the shell after the <code>CTRL-g</code> looks similar to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#666">(</span>erchef@127.0.0.1<span style="color:#666">)</span>1&gt;
User switch <span style="color:#007020">command</span>
</code></pre></div>
<p>then enter <code>q</code>, and then hit <code>ENTER</code> to exit the shell.</p> <h3 id="nginx">Nginx</h3> <p>Use Nginx to monitor for services that may be returning 504 errors. Use the following command on a front-end machine:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">grep <span style="color:#4070a0">'HTTP/1.1" 504'</span> /var/log/opscode/nginx/access.log
</code></pre></div>
<p>and then extract the URLs and sort them by <code>uniq</code> count:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">grep <span style="color:#4070a0">'HTTP/1.1" 504'</span> nginx-access.log | cut -d<span style="color:#4070a0">' '</span> -f8 | sort | uniq -c | sort
</code></pre></div>
<p>In a large installation, restricting these results to a subset of results may be necessary:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">tail -10000 nginx-access.log | grep <span style="color:#4070a0">'HTTP/1.1" 504'</span> | cut -d<span style="color:#4070a0">' '</span> -f8 | sort | uniq -c | sort
</code></pre></div>
<h3 id="postgresql">PostgreSQL</h3> <p>psql is the management tool for PostgreSQL. It can be used to obtain information about data stored in PostgreSQL. For more information about psql, see <a href="http://www.postgresql.org/docs/manuals/">http://www.postgresql.org/docs/manuals/</a>, and then the doc set appropriate for the version of PostgreSQL being used.</p> <p>To connect to the PostgreSQL database, run the following command:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#007020">cd</span> /opt/opscode/embedded/service/postgresql/
  <span style="color:#007020">export</span> <span style="color:#bb60d5">PATH</span><span style="color:#666">=</span><span style="color:#bb60d5">$PATH</span>:/opt/opscode/bin:/opt/opscode/embedded/bin
  bin/psql -U opscode_chef
</code></pre></div>
<div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> Connecting to the PostgreSQL database should only be done when directed by Chef support services. </div> </div> <h3 id="redis">Redis</h3> <p>The <strong>redis_lb</strong> service located on the back end machine handles requests that are made from the Nginx service that is located on all front end machines in a Chef Infra Server cluster.</p> <p>In the event of a disk full condition for the Redis data store, the <code>dump.rdb</code> (the primary data store <code>.rdb</code> used by Redis) can become corrupt and saved as a zero byte file.</p> <p>When this occurs, after the <strong>redis_lb</strong> service started, it’s logs will show a statement similar to the following:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">2015-03-23_16:11:31.44256 <span style="color:#666">[</span>11529<span style="color:#666">]</span> <span style="color:#40a070">23</span> Mar 16:10:09.624 <span style="color:#60a0b0;font-style:italic"># Server started, Redis version 2.8.2</span>
2015-03-23_16:11:31.44256 <span style="color:#666">[</span>11529<span style="color:#666">]</span> <span style="color:#40a070">23</span> Mar 16:10:09.624 <span style="color:#60a0b0;font-style:italic"># WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.</span>
2015-03-23_16:11:31.44257 <span style="color:#666">[</span>11529<span style="color:#666">]</span> <span style="color:#40a070">23</span> Mar 16:11:31.438 <span style="color:#60a0b0;font-style:italic"># Short read or OOM loading DB. Unrecoverable error, aborting now.</span>
</code></pre></div>
<p>The <code>dump.rdb</code> file will be empty:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">ls -al /var/opt/opscode/redis_lb/data/
total <span style="color:#40a070">20</span>
drwxr-x--- <span style="color:#40a070">2</span> opscode opscode <span style="color:#40a070">4096</span> Mar <span style="color:#40a070">23</span> 15:58 .
drwxr-x--- <span style="color:#40a070">4</span> opscode opscode <span style="color:#40a070">4096</span> Dec <span style="color:#40a070">22</span> 18:59 ..
-rw-r--r-- <span style="color:#40a070">1</span> opscode opscode    <span style="color:#40a070">0</span> Mar <span style="color:#40a070">23</span> 15:58 dump.rdb
</code></pre></div>
<p>This situation is caused by a bug in Redis where saves are allowed to succeed even when the disk has been full for some time, and not just on edge cases where the disk becomes full as Redis is writing. To fix this issue, do the following:</p> <ol> <li> <p>Stop the <strong>redis_lb</strong> service:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-server-ctl stop redis_lb
</code></pre></div>
</li> <li> <p>Remove the corrupt files:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#007020">cd</span> /var/opt/opscode/redis_lb/data
rm -fr *rdb
</code></pre></div>
</li> <li> <p>Start the <strong>redis_lb</strong> service:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-server-ctl start redis_lb

less /var/log/opscode/redis_lb/current
2015-03-23_17:05:18.82516 <span style="color:#666">[</span>28676<span style="color:#666">]</span> <span style="color:#40a070">23</span> Mar 17:05:18.825 * The server is now ready to accept connections on port <span style="color:#40a070">16379</span>
</code></pre></div>
</li> <li> <p>Reconfigure the Chef Infra Server to re-populate Redis:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-server-ctl reconfigure
</code></pre></div>
</li> <li> <p>Verify that Redis is re-populated, as indicated by the key <code>dl_default</code>:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">/opt/opscode/embedded/bin/redis-cli -p <span style="color:#40a070">16379</span> keys <span style="color:#4070a0;font-weight:700">\*</span>
1<span style="color:#666">)</span> <span style="color:#4070a0">"dl_default"</span>
</code></pre></div>
</li> </ol> <h2 id="system-checks">System Checks</h2> <p>System-level checks should be done for the ports and services status.</p> <h3 id="chef-backend-ctl-status">chef-backend-ctl status</h3> <p>The <code>chef-backend-ctl status</code> subcommand is used to check the status of services running in the <a href="../install_server_ha/index.html">Chef Backend server topology</a>. This command will verify the status of the following services on the node it is run on:</p> <ul> <li><code>leaderl</code></li> <li><code>postgresql</code></li> <li><code>etcd</code></li> <li><code>epmd</code></li> <li><code>elasticsearch</code></li> </ul> <p>It will also check on the status of other nodes in the cluster, from the current node’s perspective. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-backend-ctl status
Service Local Status Time in State Distributed Node Status
leaderl running <span style="color:#666">(</span>pid 1191<span style="color:#666">)</span> 53d 15h 11m 12s leader: 1; waiting: 0; follower: 2;    total: <span style="color:#40a070">3</span>
epmd running <span style="color:#666">(</span>pid 1195<span style="color:#666">)</span> 53d 15h 11m 12s status: local-only
etcd running <span style="color:#666">(</span>pid 1189<span style="color:#666">)</span> 53d 15h 11m 12s health: green; healthy nodes: 3/3
postgresql running <span style="color:#666">(</span>pid 40686<span style="color:#666">)</span> 0d 12h 36m 23s leader: 1; offline: 0; syncing: 0;    synced: <span style="color:#40a070">2</span>
elasticsearch running <span style="color:#666">(</span>pid 47423<span style="color:#666">)</span> 0d 12h 18m 6s state: green; nodes online: 3/3

System Local Status Distributed Node Status
disks /var/log/chef-backend: OK; /var/opt/chef-backend: OK health: green; healthy    nodes: 3/3
</code></pre></div>
<p>More information about each service can be found in the individual service logs in <code>/var/opt/chef-backend/</code>.</p> <h3 id="opscode-authz">opscode-authz</h3> <p>The authz API provides a high-level view of the health of the <strong>opscode-authz</strong> service with a simple endpoint: <code>_ping</code>. This endpoint can be accessed using cURL and GNU Wget. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">curl http://localhost:9463/_ping
</code></pre></div>
<p>This command typically prints a lot of information. Use Python to use pretty-print output:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">curl http://localhost:9463/_ping | python -mjson.tool
</code></pre></div>
<h3 id="opscode-erchef">opscode-erchef</h3> <p>The status API provides a high-level view of the health of the system with a simple endpoint: <code>_status</code>. This endpoint can be accessed using cURL and GNU Wget. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">curl http://localhost:8000/_status
</code></pre></div>
<p>which will return something similar to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#666">{</span>
  <span style="color:#4070a0">"status"</span>:<span style="color:#4070a0">"pong"</span>,
  <span style="color:#4070a0">"upstreams"</span>:<span style="color:#666">{</span><span style="color:#4070a0">"upstream_service"</span>:<span style="color:#4070a0">"pong"</span>,<span style="color:#4070a0">"upstream_service"</span>:<span style="color:#4070a0">"fail"</span>,...<span style="color:#666">}</span>,
<span style="color:#666">}</span>
</code></pre></div>
<p>For each of the upstream services, <code>pong</code> or <code>fail</code> is returned. The possible upstream names are:</p> <ul> <li>
<code>chef_sql</code> (for the <strong>postgresql</strong> service)</li> <li>
<code>oc_chef_authz</code> (for the <strong>opscode-authz</strong> service)</li> </ul> <p>If any of the status values return <code>fail</code>, this typically means the Chef Infra Server is unavailable for that service.</p> <h2 id="nodes-workstations">Nodes, Workstations</h2> <p>If a client makes an HTTP request to the server that returns a non-specific error message, this is typically an issue with the <strong>opscode-chef</strong> or <strong>opscode-erchef</strong> services. View the full error message for these services in their respective log files. The error is most often a stacktrace from the application error. In some cases, the error message will clearly indicate a problem with another service, which can then be investigated further. For non-obvious errors, please contact Chef support services.</p> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/server/server_monitor/" class="_attribution-link">https://docs.chef.io/server/server_monitor/</a>
  </p>
</div>
