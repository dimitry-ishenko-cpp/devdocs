<div id="col-content" data-swiftype-index="true"> <div id="knife-ssh"><h1>knife ssh</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/chef-workstation/blob/main/docs-chef-io/content/workstation/knife_ssh.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>Use the <code>knife ssh</code> subcommand to invoke SSH commands (in parallel) on a subset of nodes within an organization, based on the results of a <a href="../../chef_search/index.html">search query</a> made to the Chef Infra Server.</p> <h2 id="syntax">Syntax</h2> <p>This subcommand has the following syntax:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife ssh SEARCH_QUERY SSH_COMMAND <span style="color:#666">(</span>options<span style="color:#666">)</span>
</code></pre></div>
<h2 id="options">Options</h2> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> Review the list of <a href="../knife_options/index.html">common options</a> available to this (and all) knife subcommands and plugins. </div> </div> <p>This subcommand has the following options:</p> <dl> <dt>
<code>-a SSH_ATTR</code>, <code>--attribute SSH_ATTR</code>
</dt> <dd> <p>The attribute used when opening an SSH connection. The default attribute is the FQDN of the host. Other possible values include a public IP address, a private IP address, or a hostname.</p> </dd> <dt>
<code>-A</code>, <code>--forward-agent</code>
</dt> <dd> <p>Enable SSH agent forwarding.</p> </dd> <dt>
<code>-C NUM</code>, <code>--concurrency NUM</code>
</dt> <dd> <p>The number of allowed concurrent connections.</p> </dd> <dt>
<code>-e</code>, <code>--exit-on-error</code>
</dt> <dd> <p>Use to exit immediately upon error.</p> </dd> <dt>
<code>-G GATEWAY</code>, <code>--ssh-gateway GATEWAY</code>
</dt> <dd> <p>The SSH tunnel or gateway that is used to run a bootstrap action on a machine that is not accessible from the workstation.</p> </dd> <dt><code>--ssh-gateway-identity SSH_GATEWAY_IDENTITY</code></dt> <dd> <p>The SSH identity file used to connect to the SSH gateway.</p> <p><em>New in Chef Client 13.0.</em></p> </dd> <dt>
<code>-i IDENTITY_FILE</code>, <code>--ssh-identity-file IDENTIFY_FILE</code>
</dt> <dd> <p>The SSH identity file used for authentication. Key-based authentication is recommended.</p> </dd> <dt>
<code>-m</code>, <code>--manual-list</code>
</dt> <dd> <p>Define a search query as a space-separated list of servers. If there is more than one item in the list, put quotes around the entire list. For example: <code>--manual-list "server01 server02 server03"</code></p> </dd> <dt><code>--[no-]host-key-verify</code></dt> <dd> <p>Use <code>--no-host-key-verify</code> to disable host key verification. Default setting: <code>--host-key-verify</code>.</p> </dd> <dt><code>OTHER</code></dt> <dd> <p>The shell type. Possible values: <code>interactive</code>, <code>screen</code>, <code>tmux</code>, <code>macterm</code>, or <code>cssh</code>. (<code>csshx</code> is deprecated in favor of <code>cssh</code>.)</p> </dd> <dt>
<code>-p PORT</code>, <code>--ssh-port PORT</code>
</dt> <dd> <p>The SSH port.</p> </dd> <dt>
<code>-P PASSWORD</code>, <code>--ssh-password PASSWORD</code>
</dt> <dd> <p>The SSH password. This can be used to pass the password directly on the command line. If this option is not specified (and a password is required) knife prompts for the password.</p> </dd> <dt><code>SEARCH_QUERY</code></dt> <dd> <p>The search query used to return a list of servers to be accessed using SSH and the specified <code>SSH_COMMAND</code>. This option uses the same syntax as the search subcommand. If the <code>SEARCH_QUERY</code> does not contain a colon character (<code>:</code>), then the default query pattern is <code>tags:*#{@query}* OR roles:*#{@query}* OR fqdn:*#{@query}* OR addresses:*#{@query}*</code>, which means the following two search queries are effectively the same:</p> </dd> </dl> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife search ubuntu
</code></pre></div>
<p>or:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife search node <span style="color:#4070a0">"tags:*ubuntu* OR roles:*ubuntu* OR fqdn:*ubuntu* (etc.)"</span>
</code></pre></div>
<dl> <dt><code>SSH_COMMAND</code></dt> <dd> <p>The command to be run against the results of a search query.</p> </dd> <dt>
<code>-t SECONDS</code>, <code>--ssh-timeout SECONDS</code>
</dt> <dd> <p>The amount of time (in seconds) to wait for an SSH connection time out.</p> </dd> <dt><code>--tmux-split</code></dt> <dd> <p>Split the Tmux window. Default value: <code>false</code>.</p> </dd> <dt>
<code>-x USER_NAME</code>, <code>--ssh-user USER_NAME</code>
</dt> <dd> <p>The SSH user name.</p> </dd> </dl> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> See <a href="../config_rb_optional_settings/index.html">config.rb</a> for more information about how to add certain knife options as settings in the config.rb file. </div> </div> <h2 id="examples">Examples</h2> <p>The following examples show how to use this knife subcommand:</p> <p><strong>Find server uptime</strong></p> <p>To find the uptime of all of web servers running Ubuntu on the Amazon EC2 platform, enter:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife ssh <span style="color:#4070a0">"role:web"</span> <span style="color:#4070a0">"uptime"</span> -x ubuntu -a ec2.public_hostname
</code></pre></div>
<p>to return something like:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">ec2-174-129-127-206.compute-1.amazonaws.com  13:50:47 up <span style="color:#40a070">1</span> day, 23:26,  <span style="color:#40a070">1</span> user,  load average: 0.25, 0.18, 0.11
ec2-67-202-63-102.compute-1.amazonaws.com    13:50:47 up <span style="color:#40a070">1</span> day, 23:33,  <span style="color:#40a070">1</span> user,  load average: 0.12, 0.13, 0.10
ec2-184-73-9-250.compute-1.amazonaws.com     13:50:48 up 16:45,  <span style="color:#40a070">1</span> user,  load average: 0.30, 0.22, 0.13
ec2-75-101-240-230.compute-1.amazonaws.com   13:50:48 up <span style="color:#40a070">1</span> day, 22:59,  <span style="color:#40a070">1</span> user,  load average: 0.24, 0.17, 0.11
ec2-184-73-60-141.compute-1.amazonaws.com    13:50:48 up <span style="color:#40a070">1</span> day, 23:30,  <span style="color:#40a070">1</span> user,  load average: 0.32, 0.17, 0.15
</code></pre></div>
<p><strong>Run Chef Infra Client on all nodes</strong></p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife ssh <span style="color:#4070a0">'name:*'</span> <span style="color:#4070a0">'sudo chef-client'</span>
</code></pre></div>
<p><strong>Force a Chef Infra Client run</strong></p> <p>To force a Chef Infra Client run on all of the web servers running Ubuntu on the Amazon EC2 platform, enter:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife ssh <span style="color:#4070a0">"role:web"</span> <span style="color:#4070a0">"sudo chef-client"</span> -x ubuntu -a ec2.public_hostname
</code></pre></div>
<p>to return something like:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">ec2-67-202-63-102.compute-1.amazonaws.com   <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:37 +0000<span style="color:#666">]</span> INFO: Starting Chef Run <span style="color:#666">(</span>Version 0.9.10<span style="color:#666">)</span>
ec2-174-129-127-206.compute-1.amazonaws.com <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:37 +0000<span style="color:#666">]</span> INFO: Starting Chef Run <span style="color:#666">(</span>Version 0.9.10<span style="color:#666">)</span>
ec2-184-73-9-250.compute-1.amazonaws.com    <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:38 +0000<span style="color:#666">]</span> INFO: Starting Chef Run <span style="color:#666">(</span>Version 0.9.10<span style="color:#666">)</span>
ec2-75-101-240-230.compute-1.amazonaws.com  <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:38 +0000<span style="color:#666">]</span> INFO: Starting Chef Run <span style="color:#666">(</span>Version 0.9.10<span style="color:#666">)</span>
ec2-184-73-60-141.compute-1.amazonaws.com   <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:38 +0000<span style="color:#666">]</span> INFO: Starting Chef Run <span style="color:#666">(</span>Version 0.9.10<span style="color:#666">)</span>
ec2-174-129-127-206.compute-1.amazonaws.com <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:39 +0000<span style="color:#666">]</span> INFO: Chef Run <span style="color:#007020">complete</span> in 1.419243 seconds
ec2-174-129-127-206.compute-1.amazonaws.com <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:39 +0000<span style="color:#666">]</span> INFO: cleaning the checksum cache
ec2-174-129-127-206.compute-1.amazonaws.com <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:39 +0000<span style="color:#666">]</span> INFO: Running report handlers
ec2-174-129-127-206.compute-1.amazonaws.com <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:39 +0000<span style="color:#666">]</span> INFO: Report handlers <span style="color:#007020">complete</span>
ec2-67-202-63-102.compute-1.amazonaws.com   <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:39 +0000<span style="color:#666">]</span> INFO: Chef Run <span style="color:#007020">complete</span> in 1.578265 seconds
ec2-67-202-63-102.compute-1.amazonaws.com   <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:39 +0000<span style="color:#666">]</span> INFO: cleaning the checksum cache
ec2-67-202-63-102.compute-1.amazonaws.com   <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:39 +0000<span style="color:#666">]</span> INFO: Running report handlers
ec2-67-202-63-102.compute-1.amazonaws.com   <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:39 +0000<span style="color:#666">]</span> INFO: Report handlers <span style="color:#007020">complete</span>
ec2-184-73-9-250.compute-1.amazonaws.com    <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:40 +0000<span style="color:#666">]</span> INFO: Chef Run <span style="color:#007020">complete</span> in 1.638884 seconds
ec2-184-73-9-250.compute-1.amazonaws.com    <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:40 +0000<span style="color:#666">]</span> INFO: cleaning the checksum cache
ec2-184-73-9-250.compute-1.amazonaws.com    <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:40 +0000<span style="color:#666">]</span> INFO: Running report handlers
ec2-184-73-9-250.compute-1.amazonaws.com    <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:40 +0000<span style="color:#666">]</span> INFO: Report handlers <span style="color:#007020">complete</span>
ec2-75-101-240-230.compute-1.amazonaws.com  <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:40 +0000<span style="color:#666">]</span> INFO: Chef Run <span style="color:#007020">complete</span> in 1.540257 seconds
ec2-75-101-240-230.compute-1.amazonaws.com  <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:40 +0000<span style="color:#666">]</span> INFO: cleaning the checksum cache
ec2-75-101-240-230.compute-1.amazonaws.com  <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:40 +0000<span style="color:#666">]</span> INFO: Running report handlers
ec2-75-101-240-230.compute-1.amazonaws.com  <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:40 +0000<span style="color:#666">]</span> INFO: Report handlers <span style="color:#007020">complete</span>
ec2-184-73-60-141.compute-1.amazonaws.com   <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:40 +0000<span style="color:#666">]</span> INFO: Chef Run <span style="color:#007020">complete</span> in 1.502489 seconds
ec2-184-73-60-141.compute-1.amazonaws.com   <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:40 +0000<span style="color:#666">]</span> INFO: cleaning the checksum cache
ec2-184-73-60-141.compute-1.amazonaws.com   <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:40 +0000<span style="color:#666">]</span> INFO: Running report handlers
ec2-184-73-60-141.compute-1.amazonaws.com   <span style="color:#666">[</span>Fri, <span style="color:#40a070">22</span> Oct <span style="color:#40a070">2010</span> 14:18:40 +0000<span style="color:#666">]</span> INFO: Report handlers <span style="color:#007020">complete</span>
</code></pre></div>
<p><strong>Run a command based on search query</strong></p> <p>To query for all nodes that have the <code>webserver</code> role and then use SSH to run the command <code>sudo chef-client</code>, enter:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife ssh <span style="color:#4070a0">"role:webserver"</span> <span style="color:#4070a0">"sudo chef-client"</span>
</code></pre></div>
<p><strong>Upgrade all nodes</strong></p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife ssh name:* <span style="color:#4070a0">"sudo aptitude upgrade -y"</span>
</code></pre></div>
<p><strong>Specify the shell type</strong></p> <p>To specify the shell type used on the nodes returned by a search query:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife ssh roles:opscode-omnitruck macterm
</code></pre></div>
<p>where <code>screen</code> is one of the following values: <code>cssh</code>, <code>interactive</code>, <code>macterm</code>, <code>screen</code>, or <code>tmux</code>. If the node does not have the shell type installed, knife will return an error similar to the following:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">you need the rb-appscript gem to use knife ssh macterm.
<span style="color:#4070a0">`</span><span style="color:#666">(</span>sudo<span style="color:#666">)</span> gem    install rb-appscript<span style="color:#4070a0">`</span> to install
ERROR: LoadError: cannot load such file -- appscript
</code></pre></div> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/workstation/knife_ssh/" class="_attribution-link">https://docs.chef.io/workstation/knife_ssh/</a>
  </p>
</div>
