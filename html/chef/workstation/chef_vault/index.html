<div id="col-content" data-swiftype-index="true"> <div id="chef-vault"><h1>Chef Vault</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/chef-workstation/blob/main/docs-chef-io/content/workstation/chef_vault.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p><code>chef-vault</code> is a Ruby Gem that is included in Chef Workstation and Chef Infra Client. Chef Vault lets you encrypt a data bag item using asymmetric keys. When you provide Chef Vault with a list of public keys from your nodes, only the nodes with public keys entered on this list can decrypt the data bag item contents. Chef Vault is included in Chef Workstation and Chef Infra Client by way of the <code>chef-vault</code> Ruby Gem. <code>chef-vault</code> uses the <code>knife vault</code> subcommand.</p> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> <p>Chef Vault does not currently support alternate keying mechanisms like GPG and Amazon KMS.</p> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> <p>To use Chef Vault, Chef Infra Client must be configured to use public/private key pairs. Chef Vault is incompatible with the practice of using Chef Infra Client with a private key, such as <code>client.pem</code>, and a certificate set as its public identity in the Chef Infra Server database. To update existing nodes to use <code>chef-vault</code>, first re-register your Chef Infra Client nodes with the Chef Infra Server which will generate public/private key pairs, and then install Chef Vault on each node. If Chef Vault is used with a Chef Infra Client instance that has a private key, such as <code>client.pem</code>, and a certificate set as its public identity in the Chef Infra Server database, Chef Vault will generate the following error:</p> <pre tabindex="0" class="highlight" data-language="ruby"><code class="language-none" data-lang="none">## OpenSSL::PKey::RSAError
Neither PUB key nor PRIV key:: nested asn1 error
</code></pre> </div> </div> <h3 id="configuring-configrb-for-chef-vault">Configuring config.rb for Chef Vault</h3> <p>To set ‘client’ as the default mode, add the following line to the config.rb file.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife<span style="color:#666">[</span>:vault_mode<span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'client'</span>
</code></pre></div>
<p>To set the default list of admins for creating and updating vaults, add the following line to the config.rb file.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife<span style="color:#666">[</span>:vault_admins<span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#666">[</span> <span style="color:#4070a0">'example-alice'</span>, <span style="color:#4070a0">'example-bob'</span>, <span style="color:#4070a0">'example-carol'</span> <span style="color:#666">]</span>
</code></pre></div>
<p>(These values can be overridden on the command line by using <code>-A</code>)</p> <h3 id="syntax">Syntax</h3> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault SUBCOMMAND VAULT ITEM VALUES
</code></pre></div>
<p>where:</p> <ul> <li>
<code>vault</code> names the location for storing the encrypted item.</li> <li>
<code>item</code> names the item stored in the vault.</li> <li>
<code>values</code> contains the data that will be encrypted and stored in the vault.</li> </ul> <h3 id="vault-commands">Vault Commands</h3> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault create VAULT ITEM VALUES <span style="color:#666">(</span>options<span style="color:#666">)</span>
knife vault delete VAULT ITEM <span style="color:#666">(</span>options<span style="color:#666">)</span>
knife vault download VAULT ITEM PATH <span style="color:#666">(</span>options<span style="color:#666">)</span>
knife vault edit VAULT ITEM <span style="color:#666">(</span>options<span style="color:#666">)</span>
knife vault isvault VAULT ITEM <span style="color:#666">(</span>options<span style="color:#666">)</span>
knife vault itemtype VAULT ITEM <span style="color:#666">(</span>options<span style="color:#666">)</span>
knife vault list <span style="color:#666">(</span>options<span style="color:#666">)</span>
knife vault refresh VAULT ITEM
knife vault remove VAULT ITEM VALUES <span style="color:#666">(</span>options<span style="color:#666">)</span>
knife vault rotate all keys
knife vault rotate keys VAULT ITEM <span style="color:#666">(</span>options<span style="color:#666">)</span>
knife vault show VAULT <span style="color:#666">[</span>ITEM<span style="color:#666">]</span> <span style="color:#666">[</span>VALUES<span style="color:#666">]</span> <span style="color:#666">(</span>options<span style="color:#666">)</span>
knife vault update VAULT ITEM VALUES <span style="color:#666">(</span>options<span style="color:#666">)</span>
</code></pre></div>
<h3 id="vault-common-options">Vault Common Options</h3> <dl> <dt>
<code>-A</code>, <code>--admins ADMINS</code>
</dt> <dd> <p>Chef users to be added as admins</p> </dd> <dt>
<code>-s</code>, <code>--server-url URL</code>
</dt> <dd> <p>Chef Infra Server URL</p> </dd> <dt><code>--chef-zero-host HOST</code></dt> <dd> <p>Host to start chef-zero on</p> </dd> <dt><code>--chef-zero-port PORT</code></dt> <dd> <p>Port (or port range) to start chef-zero on. Port ranges like 1000,1010 or 8889-9999 will try all given ports until one works.</p> </dd> <dt>
<code>-k</code>, <code>--key KEY</code>
</dt> <dd> <p>API Client Key</p> </dd> <dt>
<code>-C</code>, <code>--clients CLIENTS</code>
</dt> <dd> <p>Chef clients to be added as clients</p> </dd> <dt><code>--[no-]color</code></dt> <dd> <p>Use colored output, defaults to enabled</p> </dd> <dt>
<code>-c</code>, <code>--config CONFIG</code>
</dt> <dd> <p>The configuration file to use</p> </dd> <dt><code>--config-option OPTION=VALUE</code></dt> <dd> <p>Override a single configuration option</p> </dd> <dt><code>--defaults</code></dt> <dd> <p>Accept default values for all questions</p> </dd> <dt>
<code>-d</code>, –disable-editing</dt> <dd> <p>Do not open EDITOR, just accept the data as is</p> </dd> <dt>
<code>-e</code>, <code>--editor EDITOR</code>
</dt> <dd> <p>Set the editor to use for interactive commands</p> </dd> <dt>
<code>-E</code>, <code>--environment ENVIRONMENT</code>
</dt> <dd> <p>Set the Chef environment (except for in searches, where this will be flagrantly ignored)</p> </dd> <dt><code>--file FILE</code></dt> <dd> <p>File to be added to vault item as file-content</p> </dd> <dt><code>--[no-]fips</code></dt> <dd> <p>Enable or disable fips mode</p> </dd> <dt>
<code>-F</code>, <code>--format FORMAT</code>
</dt> <dd> <p>Which format to use for output</p> </dd> <dt>
<code>-J</code>, <code>--json FILE</code>
</dt> <dd> <p>File containing JSON data to encrypt</p> </dd> <dt>
<code>-K</code>, <code>--keys-mode KEYS_MODE</code>
</dt> <dd> <p>Mode in which to save vault keys</p> </dd> <dt><code>--[no-]listen</code></dt> <dd> <p>Whether a local mode (-z) server binds to a port</p> </dd> <dt>
<code>-z</code>, <code>--local-mode</code>
</dt> <dd> <p>Point knife commands at local repository instead of server</p> </dd> <dt>
<code>-u</code>, <code>--user USER</code>
</dt> <dd> <p>API Client Username</p> </dd> <dt><code>--print-after</code></dt> <dd> <p>Show the data after a destructive operation</p> </dd> <dt>
<code>-S</code>, <code>--search SEARCH</code>
</dt> <dd> <p>Chef SOLR search for clients</p> </dd> <dt>
<code>-M</code>, <code>--mode MODE</code>
</dt> <dd> <p>Chef mode to run in. Default Value: <code>solo</code></p> </dd> <dt>
<code>-V</code>, <code>--verbose</code>
</dt> <dd> <p>More verbose output. Use twice for max verbosity</p> </dd> <dt>
<code>-v</code>, <code>--version</code>
</dt> <dd> <p>Show chef version</p> </dd> <dt>
<code>-y</code>, <code>--yes</code>
</dt> <dd> <p>Say yes to all prompts for confirmation</p> </dd> <dt>
<code>-h</code>, <code>--help</code>
</dt> <dd> <p>Show this message</p> </dd> </dl> <h3 id="example-commands">Example Commands</h3> <h3 id="create"><code>create</code></h3> <p>Create a vault called passwords and put an item called root in it with the given values for username and password encrypted for clients role:webserver, client1 &amp; client2 and admins admin1 &amp; admin2</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife vault create passwords root <span style="color:#4070a0">'{"username": "root", "password": "mypassword"}'</span> -S <span style="color:#4070a0">"role:webserver"</span> -C <span style="color:#4070a0">"client1,client2"</span> -A <span style="color:#4070a0">"admin1,admin2"</span>
</code></pre></div>
<p>Create a vault called passwords and put an item called root in it with the given values for username and password encrypted for clients role:webserver and admins admin1 &amp; admin2</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault create passwords root <span style="color:#4070a0">'{"username": "root", "password": "mypassword"}'</span> -S <span style="color:#4070a0">"role:webserver"</span> -A <span style="color:#4070a0">"admin1,admin2"</span>
</code></pre></div>
<p>Create a vault called passwords and put an item called root in it with the given values for username and password encrypted for clients role:webserver, client1 &amp; client2</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault create passwords root <span style="color:#4070a0">'{"username": "root", "password": "mypassword"}'</span> -S <span style="color:#4070a0">"role:webserver"</span> -C <span style="color:#4070a0">"client1,client2"</span>
</code></pre></div>
<p>Create a vault called passwords and put an item called root in it with the given values for username and password encrypted for clients role:webserver</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault create passwords root <span style="color:#4070a0">'{"username": "root", "password": "mypassword"}'</span> -S <span style="color:#4070a0">"role:webserver"</span>
</code></pre></div>
<p>Create a vault called passwords and put an item called root in it with the given values for username and password encrypted for clients client1 &amp; client2</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault create passwords root <span style="color:#4070a0">'{"username": "root", "password": "mypassword"}'</span> -C <span style="color:#4070a0">"client1,client2"</span>
</code></pre></div>
<p>Create a vault called passwords and put an item called root in it with the given values for username and password encrypted for admins admin1 &amp; admin2</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault create passwords root <span style="color:#4070a0">'{"username": "root", "password": "mypassword"}'</span> -A <span style="color:#4070a0">"admin1,admin2"</span>
</code></pre></div>
<p>Create a vault called passwords and put an item called root in it encrypted for admins admin1 &amp; admin2. <em>Leaving the data off the command-line will open an editor to fill out the data</em></p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault create passwords root -A <span style="color:#4070a0">"admin1,admin2"</span>
</code></pre></div>
<div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> A JSON file can be used in place of specifying the values on the command line, see global options below for details </div> </div> <h3 id="update"><code>update</code></h3> <p>Update the values in username and password in the vault passwords and item root. Will overwrite existing values if values already exist!</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault update passwords root <span style="color:#4070a0">'{"username": "root", "password": "mypassword"}'</span>
</code></pre></div>
<p>Update the values in username and password in the vault passwords and item root and add role:webserver, client1 &amp; client2 to the encrypted clients and admin1 &amp; admin2 to the encrypted admins. Will overwrite existing values if values already exist!</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault update passwords root <span style="color:#4070a0">'{"username": "root", "password": "mypassword"}'</span> -S <span style="color:#4070a0">"role:webserver"</span> -C <span style="color:#4070a0">"client1,client2"</span> -A <span style="color:#4070a0">"admin1,admin2"</span>
</code></pre></div>
<p>Update the values in username and password in the vault passwords and item root and add role:webserver to the encrypted clients and admin1 &amp; admin2 to the encrypted admins. Will overwrite existing values if values already exist!</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault update passwords root <span style="color:#4070a0">'{"username": "root", "password": "mypassword"}'</span> -S <span style="color:#4070a0">"role:webserver"</span> -A <span style="color:#4070a0">"admin1,admin2"</span>
</code></pre></div>
<p>Update the values in username and password in the vault passwords and item root and add role:webserver to the encrypted clients. Will overwrite existing values if values already exist!</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault update passwords root <span style="color:#4070a0">'{"username": "root", "password": "mypassword"}'</span> -S <span style="color:#4070a0">"role:webserver"</span>
</code></pre></div>
<p>Update the values in username and password in the vault passwords and item root and add client1 &amp; client2 to the encrypted clients. Will overwrite existing values if values already exist!</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault update passwords root <span style="color:#4070a0">'{"username": "root", "password": "mypassword"}'</span> -C <span style="color:#4070a0">"client1,client2"</span>
</code></pre></div>
<p>Update the values in username and password in the vault passwords and item root and add admin1 &amp; admin2 to the encrypted admins. Will overwrite existing values if values already exist!</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault update passwords root <span style="color:#4070a0">'{"username": "root", "password": "mypassword"}'</span> -A <span style="color:#4070a0">"admin1,admin2"</span>
</code></pre></div>
<p>Add role:webserver to encrypted clients for the vault passwords and item root.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault update passwords root -S <span style="color:#4070a0">"role:webserver"</span>
</code></pre></div>
<p>Add client1 &amp; client2 to encrypted clients for the vault passwords and item root.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault update passwords root -C <span style="color:#4070a0">"client1,client2"</span>
</code></pre></div>
<p>Add admin1 &amp; admin2 to encrypted admins for the vault passwords and item root.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault update passwords root -A <span style="color:#4070a0">"admin1,admin2"</span>
</code></pre></div>
<p>Add admin1 &amp; admin2 to encrypted admins and role:webserver, client1 &amp; client2 to encrypted clients for the vault passwords and item root.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault update passwords root -S <span style="color:#4070a0">"role:webserver"</span> -C <span style="color:#4070a0">"client1,client2"</span> -A <span style="color:#4070a0">"admin1,admin2"</span>
</code></pre></div>
<p>Add admin1 &amp; admin2 to encrypted admins and role:webserver to encrypted clients for the vault passwords and item root.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault update passwords root -S <span style="color:#4070a0">"role:webserver"</span> -A <span style="color:#4070a0">"admin1,admin2"</span>
</code></pre></div>
<p>Add admin1 &amp; admin2 to encrypted admins and client1 &amp; client2 to encrypted clients for the vault passwords and item root.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault update passwords root -C <span style="color:#4070a0">"client1,client2"</span> -A <span style="color:#4070a0">"admin1,admin2"</span>
</code></pre></div>
<p>..Note:: A JSON file can be used in place of specifying the values on the command line, see global options below for details</p> <h3 id="remove"><code>remove</code></h3> <p>Remove the values in username and password from the vault passwords and item root.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault remove passwords root <span style="color:#4070a0">'{"username": "root", "password": "mypassword"}'</span>
</code></pre></div>
<p>Remove the values in username and password from the vault passwords and item root and remove role:webserver, client1 &amp; client2 from the encrypted clients and admin1 &amp; admin2 from the encrypted admins.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault remove passwords root <span style="color:#4070a0">'{"username": "root", "password": "mypassword"}'</span> -S <span style="color:#4070a0">"role:webserver"</span> -C <span style="color:#4070a0">"client1,client2"</span> -A <span style="color:#4070a0">"admin1,admin2"</span>
</code></pre></div>
<p>Remove the values in username and password from the vault passwords and item root and remove role:webserver from the encrypted clients and admin1 &amp; admin2 from the encrypted admins.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault remove passwords root <span style="color:#4070a0">'{"username": "root", "password": "mypassword"}'</span> -S <span style="color:#4070a0">"role:webserver"</span> -A <span style="color:#4070a0">"admin1,admin2"</span>
</code></pre></div>
<p>Remove the values in username and password from the vault passwords and item root and remove client1 &amp; client2 from the encrypted clients and admin1 &amp; admin2 from the encrypted admins.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault remove passwords root <span style="color:#4070a0">'{"username": "root", "password": "mypassword"}'</span> -C <span style="color:#4070a0">"client1,client2"</span> -A <span style="color:#4070a0">"admin1,admin2"</span>
</code></pre></div>
<p>Remove the values in username and password from the vault passwords and item root and remove role:webserver from the encrypted clients.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault remove passwords root <span style="color:#4070a0">'{"username": "root", "password": "mypassword"}'</span> -S <span style="color:#4070a0">"role:webserver"</span>
</code></pre></div>
<p>Remove the values in username and password from the vault passwords and item root and remove client1 &amp; client2 from the encrypted clients.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault remove passwords root <span style="color:#4070a0">'{"username": "root", "password": "mypassword"}'</span> -C <span style="color:#4070a0">"client1,client2"</span>
</code></pre></div>
<p>Remove the values in username and password from the vault passwords and item root and remove admin1 &amp; admin2 from the encrypted admins.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault remove passwords root <span style="color:#4070a0">'{"username": "root", "password": "mypassword"}'</span> -A <span style="color:#4070a0">"admin1,admin2"</span>
</code></pre></div>
<p>Remove admin1 &amp; admin2 from encrypted admins and role:webserver, client1 &amp; client2 from encrypted clients for the vault passwords and item root.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault remove passwords root -S <span style="color:#4070a0">"role:webserver"</span> -C <span style="color:#4070a0">"client1,client2"</span> -A <span style="color:#4070a0">"admin1,admin2"</span>
</code></pre></div>
<p>Remove admin1 &amp; admin2 from encrypted admins and role:webserver from encrypted clients for the vault passwords and item root.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault remove passwords root -S <span style="color:#4070a0">"role:webserver"</span> -A <span style="color:#4070a0">"admin1,admin2"</span>
</code></pre></div>
<p>Remove role:webserver from encrypted clients for the vault passwords and item root.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault remove passwords root -S <span style="color:#4070a0">"role:webserver"</span>
</code></pre></div>
<p>Remove client1 &amp; client2 from encrypted clients for the vault passwords and item root.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault remove passwords root -C <span style="color:#4070a0">"client1,client2"</span>
</code></pre></div>
<p>Remove admin1 &amp; admin2 from encrypted admins for the vault passwords and item root.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault remove passwords root -A <span style="color:#4070a0">"admin1,admin2"</span>
</code></pre></div>
<h3 id="delete"><code>delete</code></h3> <p>Delete the item root from the vault passwords</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault delete passwords root
</code></pre></div>
<h3 id="show"><code>show</code></h3> <p>Show the items in a vault.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault show passwords
</code></pre></div>
<p>Show the entire root item in the passwords vault and print in JSON format.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault show passwords root -Fjson
</code></pre></div>
<p>Show the entire root item in the passwords vault and print in JSON format, including the search query, clients, and admins.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault show passwords root -Fjson -p all
</code></pre></div>
<p>Show the username and password for the item root in the vault passwords.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault show passwords root <span style="color:#4070a0">"username, password"</span>
</code></pre></div>
<p>Show the contents for the item user_pem in the vault certs.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault show certs user_pem <span style="color:#4070a0">"contents"</span>
</code></pre></div>
<h3 id="edit"><code>edit</code></h3> <p>Decrypt the entire root item in the passwords vault and open it in json format in your $EDITOR. Writing and exiting out the editor will save and encrypt the vault item.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault edit passwords root
</code></pre></div>
<h3 id="download"><code>download</code></h3> <p>Decrypt and download an encrypted file to the specified path.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault download certs user_pem ~/downloaded_user_pem
</code></pre></div>
<h3 id="rotate-keys"><code>rotate keys</code></h3> <p>Rotate the shared key for the vault passwords and item root. The shared key is that which is used for the chef encrypted data bag item.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault rotate keys passwords root
</code></pre></div>
<p>To remove clients which have been deleted from Chef but not from the vault, add the <code>--clean-unknown-clients</code> switch:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault rotate keys passwords root --clean-unknown-clients
</code></pre></div>
<h3 id="rotate-all-keys"><code>rotate all keys</code></h3> <p>Rotate the shared key for all vaults and items. The shared key is that which is used for the chef encrypted data bag item.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault rotate all keys
</code></pre></div>
<p>Removes clients which have been deleted from Chef but not from the vault.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault rotate keys passwords root --clean-unknown-clients
</code></pre></div>
<h3 id="refresh"><code>refresh</code></h3> <p>This command reads the search_query in the vault item, performs the search, and reapplies the results.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault refresh VAULT ITEM
</code></pre></div>
<p>To remove clients which have been deleted from Chef but not from the vault, add the <code>--clean-unknown-clients</code> switch:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault refresh passwords root --clean-unknown-clients
</code></pre></div>
<h3 id="isvault"><code>isvault</code></h3> <p>This command checks if the given item is a vault or not, and exit with a status of 0 if it is and 1 if it is not.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault isvault VAULT ITEM
</code></pre></div>
<h3 id="itemtype"><code>itemtype</code></h3> <p>This command outputs the type of the data bag item: normal, encrypted or vault</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">knife vault itemtype VAULT ITEM
</code></pre></div>
<h3 id="global-options">Global Options</h3> <table> <thead> <tr> <th>Short Command</th> <th>Long Command</th> <th>Description</th> <th>Default</th> <th>Valid Values</th> <th>Sub-Commands</th> </tr> </thead> <tbody> <tr> <td>
<code>-M</code>, <code>MODE</code>
</td> <td><code>--mode MODE</code></td> <td>Chef mode to run in. Can be set in config.rb</td> <td><code>solo</code></td> <td>
<code>solo</code>, <code>client</code>
</td> <td>all</td> </tr> <tr> <td>
<code>-S</code> <code>SEARCH</code>
</td> <td><code>--search SEARCH</code></td> <td>Chef Infra Server SOLR Search Of Nodes</td> <td>none</td> <td>none</td> <td>
<code>create</code>, <code>remove</code> , <code>update</code>
</td> </tr> <tr> <td>
<code>-A</code> <code>ADMINS</code>
</td> <td><code>--admins ADMINS</code></td> <td>Chef clients or users to be vault admins, can be comma list</td> <td>none</td> <td>none</td> <td>
<code>create</code>, <code>remove</code> , <code>update</code>
</td> </tr> <tr> <td>
<code>-J</code> <code>FILE</code>
</td> <td><code>--json FILE</code></td> <td>JSON file to be used for values, will be merged with VALUES if VALUES is passed</td> <td>none</td> <td>none</td> <td>
<code>create</code>, <code>update</code>
</td> </tr> <tr> <td>
<code>--file</code> <code>FILE</code>
</td> <td>none</td> <td>File that <code>chef-vault</code> should encrypt. It adds “file-content” &amp; “file-name” keys to the vault item</td> <td>none</td> <td>none</td> <td>
<code>create</code>, <code>update</code>
</td> </tr> <tr> <td>
<code>-p</code> <code>DATA</code>
</td> <td><code>--print DATA</code></td> <td>Print extra vault data</td> <td>none</td> <td>
<code>search</code>, <code>clients</code>, <code>admins</code>, <code>all</code>
</td> <td><code>show</code></td> </tr> <tr> <td>
<code>-F</code> <code>FORMAT</code>
</td> <td><code>--format FORMAT</code></td> <td>Format for decrypted output</td> <td>summary</td> <td>
<code>summary</code>, <code>json</code>, <code>yaml</code>, <code>pp</code>
</td> <td><code>show</code></td> </tr> <tr> <td>–clean-unknown-clients</td> <td>none</td> <td>Remove unknown clients during key rotation</td> <td>none</td> <td>none</td> <td>
<code>refresh</code>, <code>remove</code>, <code>rotate</code>
</td> </tr> </tbody> </table> <h2 id="options-for-knife-bootstrap">Options for knife bootstrap</h2> <p>Use the following options with a validatorless bootstrap to specify items that are stored in Chef Vault:</p> <dl> <dt><code>--bootstrap-vault-file VAULT_FILE</code></dt> <dd> <p>The path to a JSON file that contains a list of vaults and items to be updated.</p> </dd> <dt><code>--bootstrap-vault-item VAULT_ITEM</code></dt> <dd> <p>A single vault and item to update as <code>vault:item</code>.</p> </dd> <dt><code>--bootstrap-vault-json VAULT_JSON</code></dt> <dd> <p>A JSON string that contains a list of vaults and items to be updated. –bootstrap-vault-json ‘{ “vault1”: [“item1”, “item2”], “vault2”: “item2” }’</p> </dd> </dl> <h3 id="using-chef-vault-in-recipes">Using Chef Vault in recipes</h3> <p>To use this gem in a recipe to decrypt data you must first install the gem via a chef_gem resource. Once the gem is installed, <code>require</code> the gem and then you can create a new instance of Chef Vault.</p> <p>Chef Vault 1.0 style decryption is supported, however it has been deprecated and Chef Vault 2.0 decryption should be used instead</p> <h3 id="example-code">Example Code</h3> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">chef_gem <span style="color:#4070a0">'chef-vault'</span> <span style="color:#007020;font-weight:700">do</span>
  compile_time <span style="color:#007020">true</span> <span style="color:#007020;font-weight:700">if</span> <span style="color:#007020">respond_to?</span>(<span style="color:#517918">:compile_time</span>)
<span style="color:#007020;font-weight:700">end</span>
<span style="color:#60a0b0;font-style:italic">#</span>
<span style="color:#007020">require</span> <span style="color:#4070a0">'chef-vault'</span>
<span style="color:#60a0b0;font-style:italic">#</span>
item <span style="color:#666">=</span> <span style="color:#60add5">ChefVault</span><span style="color:#666">::</span><span style="color:#60add5">Item</span><span style="color:#666">.</span>load(<span style="color:#4070a0">"passwords"</span>, <span style="color:#4070a0">"root"</span>)
item<span style="color:#666">[</span><span style="color:#4070a0">"password"</span><span style="color:#666">]</span>
</code></pre></div>
<p>Note that in this case, the gem needs to be installed at compile time because the require statement is at the top-level of the recipe. If you move the require of <code>chef-vault</code> and the call to <code>::load</code> to library or provider code, you can install the gem in the converge phase instead.</p> <h3 id="specifying-an-alternate-node-name-or-client-key-path">Specifying an alternate node name or client key path</h3> <p>Normally, the value of <code>Chef::Config[:node_name]</code> is used to find the per-node encrypted secret in the keys data bag item, and the value of <span class="title-ref">Chef::Config[:client_key]</span> is used to locate the private key to decrypt this secret.</p> <p>These can be overridden by passing a hash with the keys <code>:node_name</code> or <code>:client_key_path</code> to <code>ChefVault::Item.load</code>:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">item <span style="color:#666">=</span> <span style="color:#60add5">ChefVault</span><span style="color:#666">::</span><span style="color:#60add5">Item</span><span style="color:#666">.</span>load(
  <span style="color:#4070a0">'passwords'</span>, <span style="color:#4070a0">'root'</span>,
  <span style="color:#517918">node_name</span>: <span style="color:#4070a0">'service_foo'</span>,
  <span style="color:#517918">client_key_path</span>: <span style="color:#4070a0">'/secure/place/service_foo.pem'</span>
)
item<span style="color:#666">[</span><span style="color:#4070a0">'password'</span><span style="color:#666">]</span>
</code></pre></div>
<p>The above example assumes that you have transferred <code>/secure/place/service_foo.pem</code> to your system via a secure channel.</p> <p>This usage allows you to decrypt a vault using a key shared among several nodes, which can be helpful when working in cloud environments or other configurations where nodes are created dynamically.</p> <h3 id="chef_vault_item-helper">chef_vault_item helper</h3> <p>The <a href="https://supermarket.chef.io/cookbooks/chef-vault/">chef-vault cookbook</a> contains a recipe to install the <code>chef-vault</code> gem and a helper method <code>chef_vault_item</code> which makes it easier to test cookbooks that use Chef Vault using Test Kitchen.</p> <h3 id="determining-if-item-is-a-vault">Determining if Item is a Vault</h3> <p>Chef Vault provides a helper method to determine if a data bag item is a vault, which can be helpful if you produce a recipe for community consumption and want to support both normal data bags and vaults:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#007020;font-weight:700">if</span> <span style="color:#60add5">ChefVault</span><span style="color:#666">::</span><span style="color:#60add5">Item</span><span style="color:#666">.</span>vault?(<span style="color:#4070a0">'passwords'</span>, <span style="color:#4070a0">'root'</span>)
  item <span style="color:#666">=</span> <span style="color:#60add5">ChefVault</span><span style="color:#666">::</span><span style="color:#60add5">Item</span><span style="color:#666">.</span>load(<span style="color:#4070a0">'passwords'</span>, <span style="color:#4070a0">'root'</span>)
<span style="color:#007020;font-weight:700">else</span>
  item <span style="color:#666">=</span> <span style="color:#60add5">Chef</span><span style="color:#666">::</span><span style="color:#60add5">DataBagItem</span><span style="color:#666">.</span>load(<span style="color:#4070a0">'passwords'</span>, <span style="color:#4070a0">'root'</span>)
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>This functionality is also available from the command line as <code>knife vault isvault VAULT ITEM</code>.</p> <h3 id="determining-data-bag-item-type">Determining Data Bag Item Type</h3> <p>Chef Vault provides a helper method to determine the type of a data bag item. It returns one of the symbols :normal, :encrypted or :vault</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#007020;font-weight:700">case</span> <span style="color:#60add5">ChefVault</span><span style="color:#666">::</span><span style="color:#60add5">Item</span><span style="color:#666">.</span>data_bag_item_type(<span style="color:#4070a0">'passwords'</span>, <span style="color:#4070a0">'root'</span>)
<span style="color:#007020;font-weight:700">when</span> <span style="color:#517918">:normal</span>
  <span style="color:#666">...</span>
<span style="color:#007020;font-weight:700">when</span> <span style="color:#517918">:encrypted</span>
  <span style="color:#666">...</span>
<span style="color:#007020;font-weight:700">when</span> <span style="color:#517918">:vault</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>This functionality is also available from the command line as <code>knife vault itemtype VAULT ITEM</code>.</p> <h3 id="stand-alone-usage">Stand Alone Usage</h3> <p>The <code>chef-vault</code> gem can be used as a stand-alone binary to decrypt values stored in Chef. It requires that Chef is installed on the system and that you have a valid <code>config.rb</code>. This is useful if you want to mix Chef Vault into non-Chef recipe code, for example some other script where you want to protect a password.</p> <p>It does still require that the data bag has been encrypted for the user’s or client’s pem and pushed to the Chef Infra Server. It mixes Chef into the gem and uses it to go grab the data bag.</p> <p>Use <code>chef-vault --help</code> to see all all available options</p> <h3 id="example-usage-password">Example usage (password)</h3> <pre tabindex="0" class="highlight" data-language="ruby"><code class="language-none" data-lang="none">chef-vault -v passwords -i root -a password -k /etc/chef/config.rb
</code></pre>
<h3 id="testing">Testing</h3> <p>To stub vault items in ChefSpec, use the <a href="https://rubygems.org/gems/chef-vault-testfixtures">chef-vault-testfixture</a> gem.</p> <p>To fall back to unencrypted JSON files in Test Kitchen, use the <code>chef_vault_item</code> helper in the aforementioned chef-vault cookbook.</p> <h2 id="more-information">More Information</h2> <p>For more information about <code>chef-vault</code>:</p> <ul> <li><a href="https://blog.chef.io/2016/01/21/chef-vault-what-is-it-and-what-can-it-do-for-you/">Nell Shamrell-Harringon’s blog post</a></li> <li><a href="https://www.chef.io/blog/2013/09/19/managing-secrets-with-chef-vault/">Joshua Timberman’s blog post</a></li> </ul> </div> </div> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/workstation/chef_vault/" class="_attribution-link">https://docs.chef.io/workstation/chef_vault/</a>
  </p>
</div>
