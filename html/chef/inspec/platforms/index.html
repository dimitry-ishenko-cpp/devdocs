<div id="col-content" data-swiftype-index="true"> <div id="using-chef-inspec-on-cloud-platforms"><h1>Using Chef InSpec on Cloud Platforms</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/inspec/inspec/tree/main/docs-chef-io/content/inspec/platforms.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>As of Chef InSpec 2.0, we have expanded our platform support beyond individual machines and now include support for select AWS and Azure resources.</p> <p>Using InSpec, you can use several Chef InSpec resources to audit properties of your cloud infrastructure - for example, an Amazon Web Services S3 bucket.</p> <h2 id="aws-platform-support-in-inspec">AWS Platform Support in InSpec</h2> <h3 id="setting-up-aws-credentials-for-inspec">Setting up AWS credentials for InSpec</h3> <p>Chef InSpec uses the standard AWS authentication mechanisms. Typically, you will create an IAM user specifically for auditing activities.</p> <ol> <li>Create an IAM user in the AWS console, with your choice of username. Check the box marked “Programmatic Access.”</li> <li>On the Permissions screen, choose Direct Attach. Select the AWS-managed IAM Profile named “ReadOnlyAccess.” If you wish to restrict the user further, you may do so; see individual Chef InSpec resources to identify which permissions are required.</li> <li>After generating the key, record the Access Key ID and Secret Key.</li> </ol> <h4 id="using-environment-variables-to-provide-credentials">Using Environment Variables to provide credentials</h4> <p>You may provide the credentials to Chef InSpec by setting the following environment variables: <code>AWS_REGION</code>, <code>AWS_ACCESS_KEY_ID</code>, and <code>AWS_SECRET_ACCESS_KEY</code>. You may also use <code>AWS_PROFILE</code>, or if you are using MFA, <code>AWS_SESSION_TOKEN</code>. See the <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html">AWS Command Line Interface Docs</a> for details.</p> <p>Once you have your environment variables set, you can verify your credentials by running:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">$ inspec detect -t aws://

<span style="color:#666">==</span> Platform Details
Name:      aws
Families:  cloud, api
Release:   aws-sdk-v2.10.125
</code></pre></div>
<h4 id="using-the-chef-inspec-target-option-to-provide-credentials-on-aws">Using the Chef InSpec target option to provide credentials on AWS</h4> <p>Look for a file in your home directory named <code>~/.aws/credentials</code>. If it does not exist, create it. Choose a name for your profile; here, we’re using the name ‘auditing’. Add your credentials as a new profile, in INI format:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#666">[</span>auditing<span style="color:#666">]</span>
<span style="color:#bb60d5">aws_access_key_id</span> <span style="color:#666">=</span> AKIA....
<span style="color:#bb60d5">aws_secret_access_key</span> <span style="color:#666">=</span> 1234....abcd
</code></pre></div>
<p>You may now run Chef InSpec using the <code>--target</code> / <code>-t</code> option, using the format <code>-t aws://region/profile</code>. For example, to connect to the Ohio region using a profile named ‘auditing’, use <code>-t aws://us-east-2/auditing</code>.</p> <p>To verify your credentials, run</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">$ inspec detect -t aws://

<span style="color:#666">==</span> Platform Details
Name:      aws
Families:  cloud, api
Release:   aws-sdk-v2.10.125
</code></pre></div>
<h2 id="azure-platform-support-in-inspec">Azure Platform Support in InSpec</h2> <h3 id="setting-up-azure-credentials-for-inspec">Setting up Azure credentials for InSpec</h3> <p>To use Chef InSpec Azure resources, you will need to create a Service Principal Name (SPN) for auditing an Azure subscription.</p> <p>This can be done on the command line or from the Azure Portal:</p> <ul> <li><a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-authenticate-service-principal-cli">Azure CLI</a></li> <li><a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-authenticate-service-principal">PowerShell</a></li> <li><a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-create-service-principal-portal">Azure Portal</a></li> </ul> <p>The information from the SPN can be specified either in the file <code>~/.azure/credentials</code>, as environment variables, or by using Chef InSpec target URIs.</p> <h4 id="setting-up-the-azure-credentials-file">Setting up the Azure Credentials File</h4> <p>By default, Chef InSpec is configured to look at <code>~/.azure/credentials</code>, and it should contain:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-powershell" data-lang="powershell">[&lt;SUBSCRIPTION_ID&gt;]
client_id = <span style="color:#4070a0">"&lt;CLIENT_ID&gt;"</span>
client_secret = <span style="color:#4070a0">"&lt;CLIENT_SECRET&gt;"</span>
tenant_id = <span style="color:#4070a0">"&lt;TENANT_ID&gt;"</span>
</code></pre></div>
<div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> <p>In the Azure web portal, these values are labeled differently:</p> <ul> <li>The client_id is referred to as the ‘Application ID’</li> <li>The client_secret is referred to as the ‘Key (Password Type)’</li> <li>The tenant_id is referred to as the ‘Directory ID’</li> </ul> </div> </div> <p>With the credentials are in place, you may now execute InSpec:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">inspec <span style="color:#007020">exec</span> my-inspec-profile -t azure://
</code></pre></div>
<h4 id="using-environment-variables-to-provide-credentials-1">Using Environment variables to provide credentials</h4> <p>You may also set the Azure credentials via environment variables:</p> <ul> <li><code>AZURE_SUBSCRIPTION_ID</code></li> <li><code>AZURE_CLIENT_ID</code></li> <li><code>AZURE_CLIENT_SECRET</code></li> <li><code>AZURE_TENANT_ID</code></li> </ul> <p>For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#bb60d5">AZURE_SUBSCRIPTION_ID</span><span style="color:#666">=</span><span style="color:#4070a0">"2fbdbb02-df2e-11e6-bf01-fe55135034f3"</span> <span style="color:#4070a0;font-weight:700">\
</span><span style="color:#bb60d5">AZURE_CLIENT_ID</span><span style="color:#666">=</span><span style="color:#4070a0">"58dc4f6c-df2e-11e6-bf01-fe55135034f3"</span> <span style="color:#4070a0;font-weight:700">\
</span><span style="color:#bb60d5">AZURE_CLIENT_SECRET</span><span style="color:#666">=</span><span style="color:#4070a0">"Jibr4iwwaaZwBb6W"</span> <span style="color:#4070a0;font-weight:700">\
</span><span style="color:#bb60d5">AZURE_TENANT_ID</span><span style="color:#666">=</span><span style="color:#4070a0">"6ad89b58-df2e-11e6-bf01-fe55135034f3"</span> inspec <span style="color:#007020">exec</span> my-profile -t azure://
</code></pre></div>
<h4 id="using-the-chef-inspec-target-option-to-provide-credentials-on-azure">Using the Chef InSpec target option to provide credentials on Azure</h4> <p>If you have created a <code>~/.azure/credentials</code> file as above, you may also use the Chef InSpec command line <code>--target</code> / <code>-t</code> option to select a subscription ID. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">inspec <span style="color:#007020">exec</span> my-profile -t azure://2fbdbb02-df2e-11e6-bf01-fe55135034f3
</code></pre></div>
<h2 id="gcp-platform-support-in-inspec">GCP Platform Support in InSpec</h2> <h3 id="setting-up-gcp-credentials-for-inspec">Setting up GCP credentials for InSpec</h3> <p>To use Chef InSpec GCP resources, you will need to install and configure the Google Cloud SDK. Instructions for this pre-requisite can be found in the <a href="https://cloud.google.com/sdk/docs/">Google CLoud SDK documentation</a>. Be sure that your InSpec installation is the latest version. The minimal required InSpec version is 3.0.25.</p> <h3 id="create-an-inspec-profile-that-makes-use-of-inspec-gcp">Create an InSpec profile that makes use of <code>inspec-gcp</code>.</h3> <p>With a version of InSpec above 4.0.0, it is possible to create a profile with the following command:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">$ inspec init profile --platform gcp my-profile
Create new profile at /Users/me/my-profile
 * Creating directory libraries
 * Creating file README.md
 * Creating directory controls
 * Creating file controls/example.rb
 * Creating file inspec.yml
 * Creating file inputs.yml
 * Creating file libraries/.gitkeep
</code></pre></div>
<p>Assuming the <code>inputs.yml</code> file contains your GCP project ID, this sample profile can then be executed using the following command:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">inspec <span style="color:#007020">exec</span> my-profile --input-file<span style="color:#666">=</span>my-profile/inputs.yml -t gcp://
</code></pre></div>
<h4 id="setting-up-the-gcp-credentials-file">Setting up the GCP Credentials File</h4> <p>While InSpec can use user accounts for authentication, <a href="https://cloud.google.com/docs/authentication/">Google Cloud documentation</a> recommends using service accounts. Following GCP best practices, first create a service account with the scopes appropriate for your needs. See <a href="https://cloud.google.com/docs/authentication/getting-started">these instructions</a> on creating a service account.</p> <p>Then, download the credential JSON file, e.g. <code>project-credentials.json</code>, to your workspace and run the following command to activate your service account:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">gcloud auth activate-service-account --key-file project-credentials.json
</code></pre></div>
<h4 id="using-environment-variables-to-provide-credentials-2">Using Environment variables to provide credentials</h4> <p>You may also set the GCP credentials json file via the <code>GOOGLE_APPLICATION_CREDENTIALS</code> environment variable.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#007020">export</span> <span style="color:#bb60d5">GOOGLE_APPLICATION_CREDENTIALS</span><span style="color:#666">=</span><span style="color:#4070a0">'/Users/me/.config/gcloud/myproject-1-feb7993e8660.json'</span>
</code></pre></div>
<p>Once you have your environment variables set, you can verify your credentials by running:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">$ inspec detect -t gcp://

<span style="color:#666">==</span> Platform Details

Name:      gcp
Families:  cloud, api
Release:   google-cloud-v
</code></pre></div> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/inspec/platforms/" class="_attribution-link">https://docs.chef.io/inspec/platforms/</a>
  </p>
</div>
