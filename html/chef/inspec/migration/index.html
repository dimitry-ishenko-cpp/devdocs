<div id="col-content" data-swiftype-index="true"> <div id="chef-inspec-migration-guide"><h1>Chef InSpec Migration Guide</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/inspec/inspec/tree/main/docs-chef-io/content/inspec/migration.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <h2 id="how-is-chef-inspec-different-from-serverspec">How is Chef InSpec different from Serverspec</h2> <p>We’ve written a complete blog post about that topic: <a href="https://blog.chef.io/2015/11/04/the-road-to-inspec/">The Road to InSpec</a></p> <h2 id="is-chef-inspec-suitable-for-infrastructure-testing">Is Chef InSpec suitable for infrastructure testing?</h2> <p>Chef InSpec is a framework that allows you to run infrastructure testing as well as compliance testing. The compliance features are always optional and provide customers a way to use Chef InSpec for both use-cases. To ensure we build the best infrastructure testing, we migrate our cookbooks <a href="https://github.com/chef-cookbooks">chef-cookbooks</a> to InSpec.</p> <h2 id="which-serverspec-resources-are-available-in-inspec">Which Serverspec resources are available in InSpec?</h2> <p>The following resources are available in InSpec:</p> <table> <thead> <tr> <th style="text-align:center">Serverspec</th> <th style="text-align:center">Chef InSpec</th> </tr> </thead> <tbody> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#bond"><code>bond</code></a></td> <td style="text-align:center"><a href="../resources/bond/index.html"><code>bond</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#bridge"><code>bridge</code></a></td> <td style="text-align:center"><a href="../resources/bridge/index.html"><code>bridge</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#command"><code>command</code></a></td> <td style="text-align:center"><a href="../resources/command/index.html"><code>command</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#cron"><code>cron</code></a></td> <td style="text-align:center"><a href="../resources/crontab/index.html"><code>crontab</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#docker_container"><code>docker_container</code></a></td> <td style="text-align:center"><a href="../resources/docker_container/index.html"><code>docker_container</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#docker_image"><code>docker_image</code></a></td> <td style="text-align:center"><a href="../resources/docker_image/index.html"><code>docker_image</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#file"><code>file</code></a></td> <td style="text-align:center"><a href="../resources/file/index.html"><code>file</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#group"><code>group</code></a></td> <td style="text-align:center"><a href="../resources/group/index.html"><code>group</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#host"><code>host</code></a></td> <td style="text-align:center"><a href="../resources/host/index.html"><code>host</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#interface"><code>interface</code></a></td> <td style="text-align:center"><a href="../resources/interface/index.html"><code>interface</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#iis_website"><code>iis_website</code></a></td> <td style="text-align:center"><a href="../resources/iis_site/index.html"><code>iis_site</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#iis_app_pool"><code>iis_app_pool</code></a></td> <td style="text-align:center"><a href="../resources/iis_app/index.html"><code>iis_app</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#iptables"><code>iptables</code></a></td> <td style="text-align:center"><a href="../resources/iptables/index.html"><code>iptables</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#kernel_module"><code>kernel_module</code></a></td> <td style="text-align:center"><a href="../resources/kernel_module/index.html"><code>kernel_module</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#linux_kernel_parameter"><code>linux_kernel_parameter</code></a></td> <td style="text-align:center"><a href="../resources/kernel_parameter/index.html"><code>kernel_parameter</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#mysql_config"><code>mysql_config</code></a></td> <td style="text-align:center"><a href="../resources/mysql_conf/index.html"><code>mysql_conf</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#package"><code>package</code></a></td> <td style="text-align:center"><a href="../resources/package/index.html"><code>package</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#port"><code>port</code></a></td> <td style="text-align:center"><a href="../resources/port/index.html"><code>port</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#ppa"><code>ppa</code></a></td> <td style="text-align:center"><a href="../resources/apt/index.html"><code>apt</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#process"><code>process</code></a></td> <td style="text-align:center"><a href="../resources/processes/index.html"><code>processes</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#service"><code>service</code></a></td> <td style="text-align:center"><a href="../resources/service/index.html"><code>service</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#user"><code>user</code></a></td> <td style="text-align:center"><a href="../resources/user/index.html"><code>user</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#windows_feature"><code>windows_feature</code></a></td> <td style="text-align:center"><a href="../resources/windows_feature/index.html"><code>windows_feature</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#windows_registry_key"><code>windows_registry_key</code></a></td> <td style="text-align:center"><a href="../resources/registry_key/index.html"><code>registry_key</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#x509_certificate"><code>x509_certificate</code></a></td> <td style="text-align:center"><a href="../resources/x509_certificate/index.html"><code>x509_certificate</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#yumrepo"><code>yumrepo</code></a></td> <td style="text-align:center"><a href="../resources/yum/index.html"><code>yum</code></a></td> </tr> <tr> <td style="text-align:center"><a href="http://serverspec.org/resource_types.html#zfs"><code>zfs</code></a></td> <td style="text-align:center"><a href="../resources/zfs_pool/index.html"><code>zfs_pool</code></a></td> </tr> </tbody> </table> <p>Some Serverspec resources are not available yet. We will implement those resources based on user feedback. If you need a resource that is not available in InSpec, please open an <a href="https://github.com/chef/inspec/issues">Github issue</a>. The list of resources that are not available in InSpec:</p> <ul> <li><a href="http://serverspec.org/resource_types.html#cgroup"><code>cgroup</code></a></li> <li><a href="http://serverspec.org/resource_types.html#default_gateway"><code>default_gateway</code></a></li> <li><a href="http://serverspec.org/resource_types.html#ip6tables"><code>ip6tables</code></a></li> <li><a href="http://serverspec.org/resource_types.html#ipfilter"><code>ipfilter</code></a></li> <li><a href="http://serverspec.org/resource_types.html#ipnat"><code>ipnat</code></a></li> <li><a href="http://serverspec.org/resource_types.html#linux_audit_system"><code>linux_audit_system</code></a></li> <li><a href="http://serverspec.org/resource_types.html#lxc"><code>lxc</code></a></li> <li><a href="http://serverspec.org/resource_types.html#mail_alias"><code>mail_alias</code></a></li> <li><a href="http://serverspec.org/resource_types.html#php_config"><code>php_config</code></a></li> <li><a href="http://serverspec.org/resource_types.html#routing_table"><code>routing_table</code></a></li> <li><a href="http://serverspec.org/resource_types.html#selinux"><code>selinux</code></a></li> <li><a href="http://serverspec.org/resource_types.html#selinux_module"><code>selinux_module</code></a></li> <li><a href="http://serverspec.org/resource_types.html#x509_private_key"><code>x509_private_key</code></a></li> </ul> <p>In addition Chef InSpec provides additional <a href="../resources/index.html">resources</a> that are not available in Serverspec:</p> <ul> <li><a href="../resources/apache_conf/index.html"><code>apache_conf</code></a></li> <li><a href="../resources/apt/index.html"><code>apt</code></a></li> <li><a href="../resources/audit_policy/index.html"><code>audit_policy</code></a></li> <li><a href="../resources/auditd_conf/index.html"><code>auditd_conf</code></a></li> <li><a href="../resources/bash/index.html"><code>bash</code></a></li> <li><a href="../resources/csv/index.html"><code>csv</code></a></li> <li><a href="../resources/shadow/index.html"><code>shadow</code></a></li> <li><a href="../resources/gem/index.html"><code>gem</code></a></li> <li><a href="../resources/grub_conf/index.html"><code>grub_conf</code></a></li> <li><a href="../resources/inetd_conf/index.html"><code>inetd_conf</code></a></li> <li><a href="../resources/ini/index.html"><code>ini</code></a></li> <li><a href="../resources/json/index.html"><code>json</code></a></li> <li><a href="../resources/npm/index.html"><code>npm</code></a></li> <li><a href="../resources/ntp_conf/index.html"><code>ntp_conf</code></a></li> <li><a href="../resources/oneget/index.html"><code>oneget</code></a></li> <li><a href="../resources/pip/index.html"><code>pip</code></a></li> <li><a href="../resources/powershell/index.html"><code>powershell</code></a></li> <li><a href="../resources/security_policy/index.html"><code>security_policy</code></a></li> <li><a href="../resources/ssh_config/index.html"><code>ssh_config</code></a></li> <li><a href="../resources/sshd_config/index.html"><code>sshd_config</code></a></li> <li><a href="../resources/sys_info/index.html"><code>sys_info</code></a></li> </ul> <h2 id="how-do-i-migrate-my-serverspec-tests-to-inspec">How do I migrate my Serverspec tests to InSpec</h2> <p>For most cases, the migration to Chef InSpec is pretty straight forward. First, replace the current verifier in <code>kitchen.yml</code> configuration with:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">verifier</span>:<span style="color:#062873;font-weight:700">name</span>:inspec</code></pre></div>
<p>Second, rename the directory <code>test/integration/default/serverspec</code> to <code>test/integration/default/inspec</code></p> <p>Third, remove the Serverspec-specific code from the test files.</p> <pre tabindex="0" class="highlight" data-language="ruby"><code>require 'serverspec'

# Required by serverspec
set :backend, :exec
</code></pre>
<p>Chef InSpec is now configured with Test-Kitchen:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">kitchen verify package-install-centos-72
-----&gt; Starting Kitchen <span style="color:#666">(</span>v1.14.2<span style="color:#666">)</span>
-----&gt; Verifying &lt;package-install-centos-72&gt;...
       Detected alternative framework tests <span style="color:#007020;font-weight:700">for</span> <span style="color:#4070a0">`</span>inspec<span style="color:#4070a0">`</span>
       Loaded

Target:  ssh://vagrant@127.0.0.1:2200


  PHP has
     ✔  php
     ✔  the pear.php.net channel
     ✔  the pecl.php.net channel

Test Summary: <span style="color:#40a070">3</span> successful, <span style="color:#40a070">0</span> failures, <span style="color:#40a070">0</span> skipped
       Finished verifying &lt;package-install-centos-72&gt; <span style="color:#666">(</span>0m0.40s<span style="color:#666">)</span>.
-----&gt; Kitchen is finished. <span style="color:#666">(</span>0m3.31s<span style="color:#666">)</span>
</code></pre></div>
<p>Some real-world migrations are available:</p> <ul> <li><a href="https://github.com/chef-cookbooks/docker">docker</a></li> <li><a href="https://github.com/chef-cookbooks/chef_nginx/pull/5/files">nginx</a></li> <li><a href="https://github.com/chef-cookbooks/mysql/pull/430/files">mysql</a></li> <li><a href="https://github.com/chef-cookbooks/php/pull/189/files">php</a></li> </ul> <p>Some general recommendations:</p> <ul> <li>use test-kitchen 1.14+</li> <li>in case of errors, increase the log level <code>kitchen verify package-install-centos-72 -l debug</code>
</li> </ul> <h2 id="do-i-still-need-the-backend-configuration">Do I still need the backend configuration?</h2> <p>Chef InSpec does not attach backend information to test files. All tests are defined independently of any backend. Therefore a Serverspec test file:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#007020">require</span> <span style="color:#4070a0">'serverspec'</span>

<span style="color:#60a0b0;font-style:italic"># Required by serverspec</span>
set <span style="color:#517918">:backend</span>, <span style="color:#517918">:exec</span>

describe <span style="color:#4070a0">'PHP'</span> <span style="color:#007020;font-weight:700">do</span>
  it <span style="color:#4070a0">'has php'</span> <span style="color:#007020;font-weight:700">do</span>
    expect(command(<span style="color:#4070a0">'php -v'</span>)<span style="color:#666">.</span>exit_status)<span style="color:#666">.</span>to eq(<span style="color:#40a070">0</span>)
  <span style="color:#007020;font-weight:700">end</span>

  it <span style="color:#4070a0">'has the pear.php.net channel'</span> <span style="color:#007020;font-weight:700">do</span>
    expect(command(<span style="color:#4070a0">'pear list-channels'</span>)<span style="color:#666">.</span>stdout)<span style="color:#666">.</span>to <span style="color:#007020">include</span>(<span style="color:#4070a0">'pear.php.net'</span>)
  <span style="color:#007020;font-weight:700">end</span>

  it <span style="color:#4070a0">'has the pecl.php.net channel'</span> <span style="color:#007020;font-weight:700">do</span>
    expect(command(<span style="color:#4070a0">'pear list-channels'</span>)<span style="color:#666">.</span>stdout)<span style="color:#666">.</span>to <span style="color:#007020">include</span>(<span style="color:#4070a0">'pecl.php.net'</span>)
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>will become the following Chef InSpec test file:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">describe <span style="color:#4070a0">'PHP'</span> <span style="color:#007020;font-weight:700">do</span>
  it <span style="color:#4070a0">'has php'</span> <span style="color:#007020;font-weight:700">do</span>
    expect(command(<span style="color:#4070a0">'php -v'</span>)<span style="color:#666">.</span>exit_status)<span style="color:#666">.</span>to eq(<span style="color:#40a070">0</span>)
  <span style="color:#007020;font-weight:700">end</span>

  it <span style="color:#4070a0">'has the pear.php.net channel'</span> <span style="color:#007020;font-weight:700">do</span>
    expect(command(<span style="color:#4070a0">'pear list-channels'</span>)<span style="color:#666">.</span>stdout)<span style="color:#666">.</span>to <span style="color:#007020">include</span>(<span style="color:#4070a0">'pear.php.net'</span>)
  <span style="color:#007020;font-weight:700">end</span>

  it <span style="color:#4070a0">'has the pecl.php.net channel'</span> <span style="color:#007020;font-weight:700">do</span>
    expect(command(<span style="color:#4070a0">'pear list-channels'</span>)<span style="color:#666">.</span>stdout)<span style="color:#666">.</span>to <span style="color:#007020">include</span>(<span style="color:#4070a0">'pecl.php.net'</span>)
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>As you can see, the Chef InSpec test files just focuses on tests and tries to avoid all clutter.</p> <h2 id="nested-describe-blocks">Nested describe blocks</h2> <p>Serverspec and RSpec allow you to define nested describe blocks. We did a survey and found out that most users use nested describe blocks only to improve their output report. We believe the code structure should not change to improve the output of a report. Nevertheless we understand that nested describe blocks help you to structure test code. A sample code block looks like:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">describe <span style="color:#4070a0">'chef-server-directories'</span> <span style="color:#007020;font-weight:700">do</span>
  describe file(<span style="color:#4070a0">'/etc/opscode'</span>) <span style="color:#007020;font-weight:700">do</span>
    it { should be_directory }
    it { should be_owned_by <span style="color:#4070a0">'root'</span> }
  <span style="color:#007020;font-weight:700">end</span>

  describe file(<span style="color:#4070a0">'/etc/opscode-analytics'</span>) <span style="color:#007020;font-weight:700">do</span>
    it { should be_directory }
    it { should be_owned_by <span style="color:#4070a0">'opscode'</span> }
    it { should be_grouped_into <span style="color:#4070a0">'opscode'</span> }
  <span style="color:#007020;font-weight:700">end</span>

  describe file(<span style="color:#4070a0">'/var/log/opscode'</span>) <span style="color:#007020;font-weight:700">do</span>
    it { should be_directory }
    it { should be_owned_by <span style="color:#4070a0">'opscode'</span> }
    it { should be_grouped_into <span style="color:#4070a0">'opscode'</span> }
  <span style="color:#007020;font-weight:700">end</span>

  describe file(<span style="color:#4070a0">'/var/opt/opscode'</span>) <span style="color:#007020;font-weight:700">do</span>
    it { should be_directory }
    it { should be_owned_by <span style="color:#4070a0">'root'</span> }
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>In Chef InSpec you would split up groups into files.</p> <pre tabindex="0" class="highlight" data-language="ruby"><code>tests
├── server-directories.rb
├── other-tests.rb
└── further-tests.rb
</code></pre>
<p>Each file can have a top-level description of its content:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">title <span style="color:#4070a0">"Chef Server Directories"</span>

describe file(<span style="color:#4070a0">'/etc/opscode'</span>) <span style="color:#007020;font-weight:700">do</span>
  it { should be_directory }
  it { should be_owned_by <span style="color:#4070a0">'root'</span> }
<span style="color:#007020;font-weight:700">end</span>

describe file(<span style="color:#4070a0">'/etc/opscode-analytics'</span>) <span style="color:#007020;font-weight:700">do</span>
  it { should be_directory }
  it { should be_owned_by <span style="color:#4070a0">'opscode'</span> }
  it { should be_grouped_into <span style="color:#4070a0">'opscode'</span> }
<span style="color:#007020;font-weight:700">end</span>

describe file(<span style="color:#4070a0">'/var/log/opscode'</span>) <span style="color:#007020;font-weight:700">do</span>
  it { should be_directory }
  it { should be_owned_by <span style="color:#4070a0">'opscode'</span> }
  it { should be_grouped_into <span style="color:#4070a0">'opscode'</span> }
<span style="color:#007020;font-weight:700">end</span>

describe file(<span style="color:#4070a0">'/var/opt/opscode'</span>) <span style="color:#007020;font-weight:700">do</span>
  it { should be_directory }
  it { should be_owned_by <span style="color:#4070a0">'root'</span> }
<span style="color:#007020;font-weight:700">end</span>

</code></pre></div>
<h2 id="are-you-supporting-the-expect-syntax">Are you supporting the <code>expect</code> syntax?</h2> <p>Of course. We still prefer the <code>should</code> syntax for UX reasons. We did surveys with various types of customers like devops engineers, auditors, managers. All participants who preferred the <code>expect</code> syntax have been Ruby experts. All non-Ruby developers found it easier to understand the <code>should</code> syntax.</p> <h3 id="should-syntax-with-inspec">
<code>should</code> syntax with InSpec</h3> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">describe command(<span style="color:#4070a0">'php -v'</span>) <span style="color:#007020;font-weight:700">do</span>
  its(<span style="color:#4070a0">'exit_status'</span>) { should eq <span style="color:#40a070">0</span> }
<span style="color:#007020;font-weight:700">end</span>

describe command(<span style="color:#4070a0">'pear list-channels'</span>) <span style="color:#007020;font-weight:700">do</span>
  its(<span style="color:#4070a0">'stdout'</span>) { should <span style="color:#007020">include</span>(<span style="color:#4070a0">'pear.php.net'</span>)}
<span style="color:#007020;font-weight:700">end</span>

describe command(<span style="color:#4070a0">'pear list-channels'</span>) <span style="color:#007020;font-weight:700">do</span>
  its(<span style="color:#4070a0">'stdout'</span>) { should <span style="color:#007020">include</span>(<span style="color:#4070a0">'pecl.php.net'</span>)}
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h3 id="expect-syntax-with-inspec">
<code>expect</code> syntax with InSpec</h3> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">describe <span style="color:#4070a0">'PHP'</span> <span style="color:#007020;font-weight:700">do</span>
  it <span style="color:#4070a0">'has php'</span> <span style="color:#007020;font-weight:700">do</span>
    expect(command(<span style="color:#4070a0">'php -v'</span>)<span style="color:#666">.</span>exit_status)<span style="color:#666">.</span>to eq(<span style="color:#40a070">0</span>)
  <span style="color:#007020;font-weight:700">end</span>

  it <span style="color:#4070a0">'has the pear.php.net channel'</span> <span style="color:#007020;font-weight:700">do</span>
    expect(command(<span style="color:#4070a0">'pear list-channels'</span>)<span style="color:#666">.</span>stdout)<span style="color:#666">.</span>to <span style="color:#007020">include</span>(<span style="color:#4070a0">'pear.php.net'</span>)
  <span style="color:#007020;font-weight:700">end</span>

  it <span style="color:#4070a0">'has the pecl.php.net channel'</span> <span style="color:#007020;font-weight:700">do</span>
    expect(command(<span style="color:#4070a0">'pear list-channels'</span>)<span style="color:#666">.</span>stdout)<span style="color:#666">.</span>to <span style="color:#007020">include</span>(<span style="color:#4070a0">'pecl.php.net'</span>)
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/inspec/migration/" class="_attribution-link">https://docs.chef.io/inspec/migration/</a>
  </p>
</div>
