<div id="col-content" data-swiftype-index="true"> <div id="common-resource-functionality"><h1>Common Resource Functionality</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/chef-web-docs/blob/main/content/resource_common.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>All resources (including custom resources) share a set of common actions, properties, conditional executions, notifications, and relative path options.</p> <h2 id="actions">Actions</h2> <p>The following actions may be used with any resource:</p> <dl> <dt><code>:nothing</code></dt> <dd> <p>This resource block does not act unless notified by another resource to take action. Once notified, this resource block either runs immediately or is queued up to run at the end of a Chef Infra Client run.</p> </dd> </dl> <h3 id="examples">Examples</h3> <p>The following examples show how to use common actions in a recipe.</p> <p><strong>Use the :nothing action</strong></p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">service <span style="color:#4070a0">'memcached'</span> <span style="color:#007020;font-weight:700">do</span>
  action <span style="color:#517918">:nothing</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h2 id="properties">Properties</h2> <p>The following properties are common to every resource:</p> <dl> <dt><code>compile_time</code></dt> <dd> <p><strong>Ruby Type:</strong> true, false | <strong>Default Value:</strong> <code>false</code></p> <p>Control the phase during which the resource is run on the node. Set to true to run while the resource collection is being built (the <code>compile phase</code>). Set to false to run while Chef Infra Client is configuring the node (the <code>converge phase</code>).</p> </dd> <dt><code>ignore_failure</code></dt> <dd> <p><strong>Ruby Type:</strong> true, false, :quiet | <strong>Default Value:</strong> <code>false</code></p> <p>Continue running a recipe if a resource fails for any reason. <code>:quiet</code> will not display the full stack trace and the recipe will continue to run if a resource fails.</p> </dd> <dt><code>retries</code></dt> <dd> <p><strong>Ruby Type:</strong> Integer | <strong>Default Value:</strong> <code>0</code></p> <p>The number of attempts to catch exceptions and retry the resource.</p> </dd> <dt><code>retry_delay</code></dt> <dd> <p><strong>Ruby Type:</strong> Integer | <strong>Default Value:</strong> <code>2</code></p> <p>The delay in seconds between retry attempts.</p> </dd> <dt><code>sensitive</code></dt> <dd> <p><strong>Ruby Type:</strong> true, false | <strong>Default Value:</strong> <code>false</code></p> <p>Ensure that sensitive resource data is not logged by Chef Infra Client.</p> </dd> </dl> <h3 id="examples-1">Examples</h3> <p>The following examples show how to use common properties in a recipe.</p> <p><strong>Use the ignore_failure common property</strong></p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">gem_package <span style="color:#4070a0">'syntax'</span> <span style="color:#007020;font-weight:700">do</span>
  action <span style="color:#517918">:install</span>
  ignore_failure <span style="color:#007020">true</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p><strong>Use the retries and retry_delay common properties</strong></p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">service <span style="color:#4070a0">'apache'</span> <span style="color:#007020;font-weight:700">do</span>
  action <span style="color:#666">[</span> <span style="color:#517918">:enable</span>, <span style="color:#517918">:start</span> <span style="color:#666">]</span>
  retries <span style="color:#40a070">3</span>
  retry_delay <span style="color:#40a070">5</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h2 id="guards">Guards</h2> <p>A guard property can be used to evaluate the state of a node during the execution phase of a Chef Infra Client run. Based on the results of this evaluation, a guard property is then used to tell Chef Infra Client if it should continue executing a resource. A guard property accepts either a string value or a Ruby block value:</p> <ul> <li>A string is executed as a shell command. If the command returns <code>0</code>, the guard is applied. If the command returns any other value, then the guard property is not applied. String guards in a <strong>powershell_script</strong> run Windows PowerShell commands and may return <code>true</code> in addition to <code>0</code>.</li> <li>A block is executed as Ruby code that must return either <code>true</code> or <code>false</code>. If the block returns <code>true</code>, the guard property is applied. If the block returns <code>false</code>, the guard property is not applied.</li> </ul> <p>A guard property is useful for ensuring that a resource is idempotent by allowing that resource to test for the desired state as it is being executed, and then if the desired state is present, for Chef Infra Client to do nothing.</p> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> <p>When using the <code>not_if</code> and <code>only_if</code> guards with the <strong>execute</strong> resource, the guard’s environment is inherited from the resource’s environment. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">execute <span style="color:#4070a0">'bundle install'</span> <span style="color:#007020;font-weight:700">do</span>
  cwd <span style="color:#4070a0">'/myapp'</span>
  not_if <span style="color:#4070a0">'bundle check'</span> <span style="color:#60a0b0;font-style:italic"># This is run from /myapp</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div> </div> </div> <h3 id="properties-1">Properties</h3> <p>The following properties can be used to define a guard that is evaluated during the execution phase of a Chef Infra Client run:</p> <dl> <dt><code>not_if</code></dt> <dd> <p>Prevent a resource from executing when the condition returns <code>true</code>.</p> </dd> <dt><code>only_if</code></dt> <dd> <p>Allow a resource to execute only if the condition returns <code>true</code>.</p> </dd> </dl> <h3 id="arguments">Arguments</h3> <p>The following arguments can be used with the <code>not_if</code> or <code>only_if</code> guard properties:</p> <dl> <dt><code>:user</code></dt> <dd> <p>Specify the user that a command will run as. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">not_if <span style="color:#4070a0">'grep adam /etc/passwd'</span>, <span style="color:#517918">user</span>: <span style="color:#4070a0">'adam'</span>
</code></pre></div>
</dd> <dt><code>:group</code></dt> <dd> <p>Specify the group that a command will run as. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">not_if <span style="color:#4070a0">'grep adam /etc/passwd'</span>, <span style="color:#517918">group</span>: <span style="color:#4070a0">'adam'</span>
</code></pre></div>
</dd> <dt><code>:environment</code></dt> <dd> <p>Specify a Hash of environment variables to be set. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">not_if <span style="color:#4070a0">'grep adam /etc/passwd'</span>, <span style="color:#517918">environment</span>: {
  <span style="color:#4070a0">'HOME'</span> <span style="color:#666">=&gt;</span> <span style="color:#4070a0">'/home/adam'</span>,
}
</code></pre></div>
</dd> <dt><code>:cwd</code></dt> <dd> <p>Set the current working directory before running a command. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">not_if <span style="color:#4070a0">'grep adam passwd'</span>, <span style="color:#517918">cwd</span>: <span style="color:#4070a0">'/etc'</span>
</code></pre></div>
</dd> <dt><code>:timeout</code></dt> <dd> <p>Set a timeout for a command. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">not_if <span style="color:#4070a0">'sleep 10000'</span>, <span style="color:#517918">timeout</span>: <span style="color:#40a070">10</span>
</code></pre></div>
</dd> </dl> <h3 id="not_if-examples">not_if Examples</h3> <p><strong>Update if not already updated</strong></p> <p>The following example shows how to use <code>not_if</code> to guard against running the <code>apt-get-update</code> command when a file already exists that is the same as the updated file:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">execute <span style="color:#4070a0">'apt-get-update'</span> <span style="color:#007020;font-weight:700">do</span>
  command <span style="color:#4070a0">'apt-get update'</span>
  ignore_failure <span style="color:#007020">true</span>
  not_if { <span style="color:#666">::</span><span style="color:#60add5">File</span><span style="color:#666">.</span>exist?(<span style="color:#4070a0">'/var/lib/apt/periodic/update-success-stamp'</span>) }
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p><strong>Ensure a node can resolve a host</strong></p> <p>The following example shows how to use a custom block of Ruby code to ensure that a node can resolve the host. If the node can resolve the host, Chef Infra Client will do nothing. If the node cannot resolve the host, Chef Infra Client will configure the host:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">ruby_block <span style="color:#4070a0">'ensure node can resolve API FQDN'</span> <span style="color:#007020;font-weight:700">do</span>
  block <span style="color:#007020;font-weight:700">do</span>
    fe <span style="color:#666">=</span> <span style="color:#60add5">Chef</span><span style="color:#666">::</span><span style="color:#60add5">Util</span><span style="color:#666">::</span><span style="color:#60add5">FileEdit</span><span style="color:#666">.</span>new(<span style="color:#4070a0">'/etc/hosts'</span>)
    fe<span style="color:#666">.</span>insert_line_if_no_match(<span style="color:#235388">/</span><span style="color:#70a0d0;font-style:italic">#{</span>node<span style="color:#666">[</span><span style="color:#4070a0">'chef-server'</span><span style="color:#666">][</span><span style="color:#4070a0">'api_fqdn'</span><span style="color:#666">]</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#235388">/</span>,
                               <span style="color:#4070a0">"127.0.0.1 </span><span style="color:#70a0d0;font-style:italic">#{</span>node<span style="color:#666">[</span><span style="color:#4070a0">'chef-server'</span><span style="color:#666">][</span><span style="color:#4070a0">'api_fqdn'</span><span style="color:#666">]</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">"</span>)
    fe<span style="color:#666">.</span>write_file
  <span style="color:#007020;font-weight:700">end</span>
  not_if { <span style="color:#60add5">Resolv</span><span style="color:#666">.</span>getaddress(node<span style="color:#666">[</span><span style="color:#4070a0">'chef-server'</span><span style="color:#666">][</span><span style="color:#4070a0">'api_fqdn'</span><span style="color:#666">]</span>) <span style="color:#007020;font-weight:700">rescue</span> <span style="color:#007020">false</span> }
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p><strong>Prevent installs on older versions</strong></p> <p>The following example shows how to use <code>not_if</code> to prevent ZeroMQ from being installed when the node on which the install is to occur has a version of Red Hat Enterprise Linux that is older than version 6.0:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">ark <span style="color:#4070a0">'test_autogen'</span> <span style="color:#007020;font-weight:700">do</span>
  url <span style="color:#4070a0">'https://github.com/zeromq/libzmq/tarball/master'</span>
  extension <span style="color:#4070a0">'tar.gz'</span>
  action <span style="color:#517918">:configure</span>
  not_if { platform_family?(<span style="color:#4070a0">'rhel'</span>) <span style="color:#666">&amp;&amp;</span> node<span style="color:#666">[</span><span style="color:#4070a0">'platform_version'</span><span style="color:#666">].</span>to_f <span style="color:#666">&lt;</span> <span style="color:#40a070">6</span><span style="color:#666">.</span><span style="color:#40a070">0</span> }
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p><strong>Set the administrator if not already set</strong></p> <p>The following example shows how to set the administrator for Nagios on multiple nodes, except when the package already exists on a node:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#c65d09">%w(adminpassword adminpassword-repeat)</span><span style="color:#666">.</span>each <span style="color:#007020;font-weight:700">do</span> <span style="color:#666">|</span>setting<span style="color:#666">|</span>
  execute <span style="color:#4070a0">"debconf-set-selections::</span><span style="color:#70a0d0;font-style:italic">#{</span>node<span style="color:#666">[</span><span style="color:#4070a0">'nagios'</span><span style="color:#666">][</span><span style="color:#4070a0">'server'</span><span style="color:#666">][</span><span style="color:#4070a0">'vname'</span><span style="color:#666">]</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">-cgi::</span><span style="color:#70a0d0;font-style:italic">#{</span>node<span style="color:#666">[</span><span style="color:#4070a0">'nagios'</span><span style="color:#666">][</span><span style="color:#4070a0">'server'</span><span style="color:#666">][</span><span style="color:#4070a0">'vname'</span><span style="color:#666">]</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">/</span><span style="color:#70a0d0;font-style:italic">#{</span>setting<span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">"</span> <span style="color:#007020;font-weight:700">do</span>
    command <span style="color:#4070a0">"echo </span><span style="color:#70a0d0;font-style:italic">#{</span>node<span style="color:#666">[</span><span style="color:#4070a0">'nagios'</span><span style="color:#666">][</span><span style="color:#4070a0">'server'</span><span style="color:#666">][</span><span style="color:#4070a0">'vname'</span><span style="color:#666">]</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">-cgi </span><span style="color:#70a0d0;font-style:italic">#{</span>node<span style="color:#666">[</span><span style="color:#4070a0">'nagios'</span><span style="color:#666">][</span><span style="color:#4070a0">'server'</span><span style="color:#666">][</span><span style="color:#4070a0">'vname'</span><span style="color:#666">]</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">/</span><span style="color:#70a0d0;font-style:italic">#{</span>setting<span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0"> password </span><span style="color:#70a0d0;font-style:italic">#{</span>random_initial_password<span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0"> | debconf-set-selections"</span>
    not_if <span style="color:#4070a0">"dpkg -l </span><span style="color:#70a0d0;font-style:italic">#{</span>node<span style="color:#666">[</span><span style="color:#4070a0">'nagios'</span><span style="color:#666">][</span><span style="color:#4070a0">'server'</span><span style="color:#666">][</span><span style="color:#4070a0">'vname'</span><span style="color:#666">]</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">"</span>
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h3 id="only_if-examples">only_if Examples</h3> <p><strong>Install packages only when necessary</strong></p> <p>The following example shows how to use <code>only_if</code> with one (or more) cookbook attributes to ensure that packages are only installed when necessary. In this case, three attributes exist in the <code>/attributes/default.rb</code> file: <code>use_openssl</code>, <code>use_pcre</code>, and <code>use_zlib</code>. Each of these attributes are defined as <code>false</code> by default. The <code>only_if</code> attributes are used to test for the presence of these packages on the target node before then asking Chef Infra Client to complete the process of installing these packages. If the packages are already present, Chef Infra Client will do nothing.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">package <span style="color:#4070a0">'libpcre3-dev'</span> <span style="color:#007020;font-weight:700">do</span>
  only_if { node<span style="color:#666">[</span><span style="color:#4070a0">'haproxy'</span><span style="color:#666">][</span><span style="color:#4070a0">'source'</span><span style="color:#666">][</span><span style="color:#4070a0">'use_pcre'</span><span style="color:#666">]</span> }
<span style="color:#007020;font-weight:700">end</span>

package <span style="color:#4070a0">'libssl-dev'</span> <span style="color:#007020;font-weight:700">do</span>
  only_if { node<span style="color:#666">[</span><span style="color:#4070a0">'haproxy'</span><span style="color:#666">][</span><span style="color:#4070a0">'source'</span><span style="color:#666">][</span><span style="color:#4070a0">'use_openssl'</span><span style="color:#666">]</span> }
<span style="color:#007020;font-weight:700">end</span>

package <span style="color:#4070a0">'zlib1g-dev'</span> <span style="color:#007020;font-weight:700">do</span>
  only_if { node<span style="color:#666">[</span><span style="color:#4070a0">'haproxy'</span><span style="color:#666">][</span><span style="color:#4070a0">'source'</span><span style="color:#666">][</span><span style="color:#4070a0">'use_zlib'</span><span style="color:#666">]</span> }
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p><strong>Remove a recipe if it belongs to a specific run-list</strong></p> <p>The following example shows how to use <code>only_if</code> to only remove a recipe named <code>recipe[ntp::undo]</code>, but only when that recipe is part of the <code>recipe[ntp::default]</code> run-list:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">ruby_block <span style="color:#4070a0">'remove ntp::undo from run list'</span> <span style="color:#007020;font-weight:700">do</span>
  block <span style="color:#007020;font-weight:700">do</span>
    node<span style="color:#666">.</span>run_list<span style="color:#666">.</span>remove(<span style="color:#4070a0">'recipe[ntp::undo]'</span>)
  <span style="color:#007020;font-weight:700">end</span>
  only_if { node<span style="color:#666">.</span>run_list<span style="color:#666">.</span>include?(<span style="color:#4070a0">'recipe[ntp::default]'</span>) }
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p><strong>Re-register ASP.Net if it’s already installed</strong></p> <p>The following example shows how to use <code>only_if</code> to ensure that Chef Infra Client will attempt to register ASP.NET only if the executable is installed on the system, on both 32- and 64-bit systems:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">aspnet_regiis <span style="color:#666">=</span> <span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">#{</span><span style="color:#60add5">ENV</span><span style="color:#666">[</span><span style="color:#4070a0">'WinDir'</span><span style="color:#666">]</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0;font-weight:700">\\</span><span style="color:#4070a0">Microsoft.NET</span><span style="color:#4070a0;font-weight:700">\\</span><span style="color:#4070a0">Framework</span><span style="color:#4070a0;font-weight:700">\\</span><span style="color:#4070a0">v4.0.30319</span><span style="color:#4070a0;font-weight:700">\\</span><span style="color:#4070a0">aspnet_regiis.exe"</span>
execute <span style="color:#4070a0">'Register ASP.NET v4'</span> <span style="color:#007020;font-weight:700">do</span>
  command <span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">#{</span>aspnet_regiis<span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0"> -i"</span>
  only_if { <span style="color:#666">::</span><span style="color:#60add5">File</span><span style="color:#666">.</span>exist?(aspnet_regiis) }
  action <span style="color:#517918">:nothing</span>
<span style="color:#007020;font-weight:700">end</span>

aspnet_regiis64 <span style="color:#666">=</span> <span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">#{</span><span style="color:#60add5">ENV</span><span style="color:#666">[</span><span style="color:#4070a0">'WinDir'</span><span style="color:#666">]</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0;font-weight:700">\\</span><span style="color:#4070a0">Microsoft.NET</span><span style="color:#4070a0;font-weight:700">\\</span><span style="color:#4070a0">Framework64</span><span style="color:#4070a0;font-weight:700">\\</span><span style="color:#4070a0">v4.0.30319</span><span style="color:#4070a0;font-weight:700">\\</span><span style="color:#4070a0">aspnet_regiis.exe"</span>
execute <span style="color:#4070a0">'Register ASP.NET v4 (x64)'</span> <span style="color:#007020;font-weight:700">do</span>
  command <span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">#{</span>aspnet_regiis64<span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0"> -i"</span>
  only_if { <span style="color:#666">::</span><span style="color:#60add5">File</span><span style="color:#666">.</span>exist?(aspnet_regiis64) }
  action <span style="color:#517918">:nothing</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h2 id="guard-interpreters">Guard Interpreters</h2> <p>Any resource that passes a string command may also specify the interpreter that will be used to evaluate that string command. This is done by using the <code>guard_interpreter</code> property to specify a <strong>script</strong>-based resource.</p> <h3 id="attributes">Attributes</h3> <p>The <code>guard_interpreter</code> property may be set to any of the following values:</p> <dl> <dt><code>:bash</code></dt> <dd> <p>Evaluates a string command using the <strong>bash</strong> resource.</p> </dd> <dt><code>:batch</code></dt> <dd> <p>Evaluates a string command using the <strong>batch</strong> resource. Default value (within a <strong>batch</strong> resource block): <code>:batch</code>.</p> </dd> <dt><code>:csh</code></dt> <dd> <p>Evaluates a string command using the <strong>csh</strong> resource.</p> </dd> <dt><code>:default</code></dt> <dd> <p>Default. Executes the default interpreter as identified by Chef Infra Client.</p> </dd> <dt><code>:perl</code></dt> <dd> <p>Evaluates a string command using the <strong>perl</strong> resource.</p> </dd> <dt><code>:powershell_script</code></dt> <dd> <p>Evaluates a string command using the <strong>powershell_script</strong> resource. Default value (within a <strong>powershell_script</strong> resource block): <code>:powershell_script</code>.</p> </dd> <dt><code>:python</code></dt> <dd> <p>Evaluates a string command using the <strong>python</strong> resource.</p> </dd> <dt><code>:ruby</code></dt> <dd> <p>Evaluates a string command using the <strong>ruby</strong> resource.</p> </dd> </dl> <h3 id="inheritance">Inheritance</h3> <p>The <code>guard_interpreter</code> property is set to <code>:default</code> by default for the <strong>bash</strong>, <strong>csh</strong>, <strong>perl</strong>, <strong>python</strong>, and <strong>ruby</strong> resources. When the <code>guard_interpreter</code> property is set to <code>:default</code>, <code>not_if</code> or <code>only_if</code> guard statements <strong>do not inherit</strong> properties that are defined by the <strong>script</strong>-based resource.</p> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> <p>The <strong>batch</strong> and <strong>powershell_script</strong> resources inherit properties by default. The <code>guard_interpreter</code> property is set to <code>:batch</code> or <code>:powershell_script</code> automatically when using a <code>not_if</code> or <code>only_if</code> guard statement within a <strong>batch</strong> or <strong>powershell_script</strong> resource, respectively.</p> </div> </div> <p>For example, the <code>not_if</code> guard statement in the following resource example <strong>does not inherit</strong> the <code>environment</code> property:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">bash <span style="color:#4070a0">'javatooling'</span> <span style="color:#007020;font-weight:700">do</span>
  environment <span style="color:#4070a0">'JAVA_HOME'</span> <span style="color:#666">=&gt;</span> <span style="color:#4070a0">'/usr/lib/java/jdk1.7/home'</span>
  code <span style="color:#4070a0">'java-based-daemon-ctl.sh -start'</span>
  not_if <span style="color:#4070a0">'java-based-daemon-ctl.sh -test-started'</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>and requires adding the <code>environment</code> property to the <code>not_if</code> guard statement so that it may use the <code>JAVA_HOME</code> path as part of its evaluation:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">bash <span style="color:#4070a0">'javatooling'</span> <span style="color:#007020;font-weight:700">do</span>
  environment <span style="color:#4070a0">'JAVA_HOME'</span> <span style="color:#666">=&gt;</span> <span style="color:#4070a0">'/usr/lib/java/jdk1.7/home'</span>
  code <span style="color:#4070a0">'java-based-daemon-ctl.sh -start'</span>
  not_if <span style="color:#4070a0">'java-based-daemon-ctl.sh -test-started'</span>, <span style="color:#517918">:environment</span> <span style="color:#666">=&gt;</span> <span style="color:#4070a0">'JAVA_HOME'</span> <span style="color:#666">=&gt;</span> <span style="color:#4070a0">'/usr/lib/java/jdk1.7/home'</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>To inherit properties, add the <code>guard_interpreter</code> property to the resource block and set it to the appropriate value:</p> <ul> <li>
<code>:bash</code> for <strong>bash</strong>
</li> <li>
<code>:csh</code> for <strong>csh</strong>
</li> <li>
<code>:perl</code> for <strong>perl</strong>
</li> <li>
<code>:python</code> for <strong>python</strong>
</li> <li>
<code>:ruby</code> for <strong>ruby</strong>
</li> </ul> <p>For example, using the same example as from above, but this time adding the <code>guard_interpreter</code> property and setting it to <code>:bash</code>:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">bash <span style="color:#4070a0">'javatooling'</span> <span style="color:#007020;font-weight:700">do</span>
  guard_interpreter <span style="color:#517918">:bash</span>
  environment <span style="color:#4070a0">'JAVA_HOME'</span> <span style="color:#666">=&gt;</span> <span style="color:#4070a0">'/usr/lib/java/jdk1.7/home'</span>
  code <span style="color:#4070a0">'java-based-daemon-ctl.sh -start'</span>
  not_if <span style="color:#4070a0">'java-based-daemon-ctl.sh -test-started'</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>The <code>not_if</code> statement now inherits the <code>environment</code> property and will use the <code>JAVA_HOME</code> path as part of its evaluation.</p> <h3 id="examples-2">Examples</h3> <p>For example, the following code block will ensure the command is evaluated using the default interpreter as identified by Chef Infra Client:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">resource <span style="color:#4070a0">'name'</span> <span style="color:#007020;font-weight:700">do</span>
  guard_interpreter <span style="color:#517918">:default</span>
  <span style="color:#60a0b0;font-style:italic"># code</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h2 id="lazy-evaluation">Lazy Evaluation</h2> <p>In some cases, the value for a property cannot be known until the execution phase of a Chef Infra Client run. In this situation, using lazy evaluation of property values can be helpful. Instead of a property being assigned a value, it may instead be assigned a code block. The syntax for using lazy evaluation is as follows:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">property_name lazy { code_block }
</code></pre></div>
<p>where <code>lazy</code> is used to tell Chef Infra Client to evaluate the contents of the code block later on in the resource evaluation process (instead of immediately) and <code>{ code_block }</code> is arbitrary Ruby code that provides the value.</p> <p>For example, a resource that is <strong>not</strong> doing lazy evaluation:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">template <span style="color:#4070a0">'template_name'</span> <span style="color:#007020;font-weight:700">do</span>
  <span style="color:#60a0b0;font-style:italic"># some properties</span>
  path <span style="color:#4070a0">'/foo/bar'</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>and a resource block that is doing lazy evaluation:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">template <span style="color:#4070a0">'template_name'</span> <span style="color:#007020;font-weight:700">do</span>
  <span style="color:#60a0b0;font-style:italic"># some properties</span>
  path lazy { <span style="color:#4070a0">' some Ruby code '</span> }
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>In the previous examples, the first resource uses the value <code>/foo/bar</code> and the second resource uses the value provided by the code block, as long as the contents of that code block are a valid resource property.</p> <p>The following example shows how to use lazy evaluation with template variables:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">template <span style="color:#4070a0">'/tmp/canvey_island.txt'</span> <span style="color:#007020;font-weight:700">do</span>
  source <span style="color:#4070a0">'canvey_island.txt.erb'</span>
  variables(
    lazy <span style="color:#007020;font-weight:700">do</span>
      { <span style="color:#517918">canvey_island</span>: node<span style="color:#666">.</span>run_state<span style="color:#666">[</span><span style="color:#4070a0">'sea_power'</span><span style="color:#666">]</span> }
    <span style="color:#007020;font-weight:700">end</span>
  )
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h2 id="notifications">Notifications</h2> <p>A notification is a property on a resource that listens to other resources in the resource collection and then takes actions based on the notification type (<code>notifies</code> or <code>subscribes</code>).</p> <h3 id="timers">Timers</h3> <p>A timer specifies the point during a Chef Infra Client run at which a notification is run. The following timers are available:</p> <dl> <dt><code>:before</code></dt> <dd> <p>Specifies that the action on a notified resource should be run before processing the resource block in which the notification is located.</p> </dd> <dt><code>:delayed</code></dt> <dd> <p>Default. Specifies that a notification should be queued up, and then executed at the end of a Chef Infra Client run.</p> </dd> <dt>
<code>:immediate</code>, <code>:immediately</code>
</dt> <dd> <p>Specifies that a notification should be run immediately, per resource notified.</p> </dd> </dl> <h3 id="notifies">Notifies</h3> <p>A resource may notify another resource to take action when its state changes. Specify a <code>'resource[name]'</code>, the <code>:action</code> that resource should take, and then the <code>:timer</code> for that action. A resource may notify more than one resource; use a <code>notifies</code> statement for each resource to be notified.</p> <p>If the referenced resource does not exist, an error is raised. In contrast, <code>subscribes</code> will not fail if the source resource is not found.</p> <p>The syntax for <code>notifies</code> is:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">notifies <span style="color:#517918">:action</span>, <span style="color:#4070a0">'resource[name]'</span>, <span style="color:#517918">:timer</span>
</code></pre></div>
<p>Changed in Chef Client 12.6 to use <code>:before</code> timer with the <code>notifies</code> and <code>subscribes</code> properties to specify that the action on a notified resource should be run before processing the resource block in which the notification is located.</p> <h4 id="examples-3">Examples</h4> <p>The following examples show how to use the <code>notifies</code> notification in a recipe.</p> <p><strong>Delay notifications</strong></p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">template <span style="color:#4070a0">'/etc/nagios3/configures-nagios.conf'</span> <span style="color:#007020;font-weight:700">do</span>
  <span style="color:#60a0b0;font-style:italic"># other parameters</span>
  notifies <span style="color:#517918">:run</span>, <span style="color:#4070a0">'execute[test-nagios-config]'</span>, <span style="color:#517918">:delayed</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p><strong>Notify immediately</strong></p> <p>By default, notifications are <code>:delayed</code>, that is they are queued up as they are triggered, and then executed at the very end of a Chef Infra Client run. To run an action immediately, use <code>:immediately</code>:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">template <span style="color:#4070a0">'/etc/nagios3/configures-nagios.conf'</span> <span style="color:#007020;font-weight:700">do</span>
  <span style="color:#60a0b0;font-style:italic"># other parameters</span>
  notifies <span style="color:#517918">:run</span>, <span style="color:#4070a0">'execute[test-nagios-config]'</span>, <span style="color:#517918">:immediately</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>and then Chef Infra Client would immediately run the following:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">execute <span style="color:#4070a0">'test-nagios-config'</span> <span style="color:#007020;font-weight:700">do</span>
  command <span style="color:#4070a0">'nagios3 --verify-config'</span>
  action <span style="color:#517918">:nothing</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p><strong>Notify multiple resources</strong></p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">template <span style="color:#4070a0">'/etc/chef/server.rb'</span> <span style="color:#007020;font-weight:700">do</span>
  source <span style="color:#4070a0">'server.rb.erb'</span>
  owner <span style="color:#4070a0">'root'</span>
  group <span style="color:#4070a0">'root'</span>
  mode <span style="color:#4070a0">'0755'</span>
  notifies <span style="color:#517918">:restart</span>, <span style="color:#4070a0">'service[chef-elasticsearch]'</span>, <span style="color:#517918">:delayed</span>
  notifies <span style="color:#517918">:restart</span>, <span style="color:#4070a0">'service[chef-server]'</span>, <span style="color:#517918">:delayed</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p><strong>Notify in a specific order</strong></p> <p>To notify multiple resources, and then have these resources run in a certain order, do something like the following:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">execute <span style="color:#4070a0">'foo'</span> <span style="color:#007020;font-weight:700">do</span>
  command <span style="color:#4070a0">'...'</span>
  notifies <span style="color:#517918">:create</span>, <span style="color:#4070a0">'template[baz]'</span>, <span style="color:#517918">:immediately</span>
  notifies <span style="color:#517918">:install</span>, <span style="color:#4070a0">'package[bar]'</span>, <span style="color:#517918">:immediately</span>
  notifies <span style="color:#517918">:run</span>, <span style="color:#4070a0">'execute[final]'</span>, <span style="color:#517918">:immediately</span>
<span style="color:#007020;font-weight:700">end</span>

template <span style="color:#4070a0">'baz'</span> <span style="color:#007020;font-weight:700">do</span>
  <span style="color:#666">...</span>
  notifies <span style="color:#517918">:run</span>, <span style="color:#4070a0">'execute[restart_baz]'</span>, <span style="color:#517918">:immediately</span>
<span style="color:#007020;font-weight:700">end</span>

package <span style="color:#4070a0">'bar'</span>

execute <span style="color:#4070a0">'restart_baz'</span>

execute <span style="color:#4070a0">'final'</span> <span style="color:#007020;font-weight:700">do</span>
  command <span style="color:#4070a0">'...'</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>where the sequencing will be in the same order as the resources are listed in the recipe: <code>execute 'foo'</code>, <code>template 'baz'</code>, <code>execute [restart_baz]</code>, <code>package 'bar'</code>, and <code>execute 'final'</code>.</p> <p><strong>Reload a service</strong></p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">template <span style="color:#4070a0">'/tmp/somefile'</span> <span style="color:#007020;font-weight:700">do</span>
  mode <span style="color:#4070a0">'0755'</span>
  source <span style="color:#4070a0">'somefile.erb'</span>
  notifies <span style="color:#517918">:reload</span>, <span style="color:#4070a0">'service[apache]'</span>, <span style="color:#517918">:immediately</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p><strong>Restart a service when a template is modified</strong></p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">template <span style="color:#4070a0">'/etc/www/configures-apache.conf'</span> <span style="color:#007020;font-weight:700">do</span>
  notifies <span style="color:#517918">:restart</span>, <span style="color:#4070a0">'service[apache]'</span>, <span style="color:#517918">:immediately</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p><strong>Send notifications to multiple resources</strong></p> <p>To send notifications to multiple resources, just use multiple attributes. Multiple attributes will get sent to the notified resources in the order specified.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">template <span style="color:#4070a0">'/etc/netatalk/netatalk.conf'</span> <span style="color:#007020;font-weight:700">do</span>
  notifies <span style="color:#517918">:restart</span>, <span style="color:#4070a0">'service[afpd]'</span>, <span style="color:#517918">:immediately</span>
  notifies <span style="color:#517918">:restart</span>, <span style="color:#4070a0">'service[cnid]'</span>, <span style="color:#517918">:immediately</span>
<span style="color:#007020;font-weight:700">end</span>

service <span style="color:#4070a0">'afpd'</span>
service <span style="color:#4070a0">'cnid'</span>
</code></pre></div>
<p><strong>Execute a command using a template</strong></p> <p>The following example shows how to set up IPv4 packet forwarding using the <strong>execute</strong> resource to run a command named <code>forward_ipv4</code> that uses a template defined by the <strong>template</strong> resource:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">execute <span style="color:#4070a0">'forward_ipv4'</span> <span style="color:#007020;font-weight:700">do</span>
  command <span style="color:#4070a0">'echo &gt; /proc/.../ipv4/ip_forward'</span>
  action <span style="color:#517918">:nothing</span>
<span style="color:#007020;font-weight:700">end</span>

template <span style="color:#4070a0">'/etc/file_name.conf'</span> <span style="color:#007020;font-weight:700">do</span>
  source <span style="color:#4070a0">'routing/file_name.conf.erb'</span>
  notifies <span style="color:#517918">:run</span>, <span style="color:#4070a0">'execute[forward_ipv4]'</span>, <span style="color:#517918">:delayed</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>where the <code>command</code> property for the <strong>execute</strong> resource contains the command that is to be run and the <code>source</code> property for the <strong>template</strong> resource specifies which template to use. The <code>notifies</code> property for the <strong>template</strong> specifies that the <code>execute[forward_ipv4]</code> (which is defined by the <strong>execute</strong> resource) should be queued up and run at the end of a Chef Infra Client run.</p> <p><strong>Restart a service, and then notify a different service</strong></p> <p>The following example shows how start a service named <code>example_service</code> and immediately notify the Nginx service to restart.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">service <span style="color:#4070a0">'example_service'</span> <span style="color:#007020;font-weight:700">do</span>
  action <span style="color:#517918">:start</span>
  notifies <span style="color:#517918">:restart</span>, <span style="color:#4070a0">'service[nginx]'</span>, <span style="color:#517918">:immediately</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p><strong>Restart one service before restarting another</strong></p> <p>This example uses the <code>:before</code> notification to restart the <code>php-fpm</code> service before restarting <code>nginx</code>:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">service <span style="color:#4070a0">'nginx'</span> <span style="color:#007020;font-weight:700">do</span>
  action <span style="color:#517918">:restart</span>
  notifies <span style="color:#517918">:restart</span>, <span style="color:#4070a0">'service[php-fpm]'</span>, <span style="color:#517918">:before</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>With the <code>:before</code> notification, the action specified for the <code>nginx</code> resource will not run until action has been taken on the notified resource (<code>php-fpm</code>).</p> <p><strong>Notify when a remote source changes</strong></p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">remote_file <span style="color:#4070a0">'/tmp/couch.png'</span> <span style="color:#007020;font-weight:700">do</span>
  source <span style="color:#4070a0">'http://couchdb.apache.org/img/sketch.png'</span>
  action <span style="color:#517918">:nothing</span>
<span style="color:#007020;font-weight:700">end</span>

http_request <span style="color:#4070a0">'HEAD http://couchdb.apache.org/img/sketch.png'</span> <span style="color:#007020;font-weight:700">do</span>
  message <span style="color:#4070a0">''</span>
  url <span style="color:#4070a0">'http://couchdb.apache.org/img/sketch.png'</span>
  action <span style="color:#517918">:head</span>
  <span style="color:#007020;font-weight:700">if</span> <span style="color:#666">::</span><span style="color:#60add5">File</span><span style="color:#666">.</span>exist?(<span style="color:#4070a0">'/tmp/couch.png'</span>)
    headers <span style="color:#4070a0">'If-Modified-Since'</span> <span style="color:#666">=&gt;</span> <span style="color:#60add5">File</span><span style="color:#666">.</span>mtime(<span style="color:#4070a0">'/tmp/couch.png'</span>)<span style="color:#666">.</span>httpdate
  <span style="color:#007020;font-weight:700">end</span>
  notifies <span style="color:#517918">:create</span>, <span style="color:#4070a0">'remote_file[/tmp/couch.png]'</span>, <span style="color:#517918">:immediately</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h3 id="subscribes">Subscribes</h3> <p>A resource may listen to another resource, and then take action if the state of the resource being listened to changes. Specify a <code>'resource[name]'</code>, the <code>:action</code> to be taken, and then the <code>:timer</code> for that action.</p> <p>Note that <code>subscribes</code> does not apply the specified action to the resource that it listens to - for example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">file <span style="color:#4070a0">'/etc/nginx/ssl/example.crt'</span> <span style="color:#007020;font-weight:700">do</span>
  mode <span style="color:#4070a0">'0600'</span>
  owner <span style="color:#4070a0">'root'</span>
<span style="color:#007020;font-weight:700">end</span>

service <span style="color:#4070a0">'nginx'</span> <span style="color:#007020;font-weight:700">do</span>
  subscribes <span style="color:#517918">:reload</span>, <span style="color:#4070a0">'file[/etc/nginx/ssl/example.crt]'</span>, <span style="color:#517918">:immediately</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>In this case the <code>subscribes</code> property reloads the <code>nginx</code> service whenever its certificate file, located under <code>/etc/nginx/ssl/example.crt</code>, is updated. <code>subscribes</code> does not make any changes to the certificate file itself, it merely listens for a change to the file, and executes the <code>:reload</code> action for its resource (in this example <code>nginx</code>) when a change is detected.</p> <p>If the other resource does not exist, the subscription will not raise an error. Contrast this with the stricter semantics of <code>notifies</code>, which will raise an error if the other resource does not exist.</p> <p>The syntax for <code>subscribes</code> is:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">subscribes <span style="color:#517918">:action</span>, <span style="color:#4070a0">'resource[name]'</span>, <span style="color:#517918">:timer</span>
</code></pre></div>
<h4 id="examples-4">Examples</h4> <p>The following examples show how to use the <code>subscribes</code> notification in a recipe.</p> <p><strong>Verify a configuration update</strong></p> <p>Use the <code>:nothing</code> action (common to all resources) to prevent the test from starting automatically, and then use the <code>subscribes</code> notification to run a configuration test when a change to the template is detected:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">execute <span style="color:#4070a0">'test-nagios-config'</span> <span style="color:#007020;font-weight:700">do</span>
  command <span style="color:#4070a0">'nagios3 --verify-config'</span>
  action <span style="color:#517918">:nothing</span>
  subscribes <span style="color:#517918">:run</span>, <span style="color:#4070a0">'template[/etc/nagios3/configures-nagios.conf]'</span>, <span style="color:#517918">:immediately</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p><strong>Reload a service when a template is updated</strong></p> <p>To reload a service that is based on a template, use the <strong>template</strong> and <strong>service</strong> resources together in the same recipe, similar to the following:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">template <span style="color:#4070a0">'/tmp/somefile'</span> <span style="color:#007020;font-weight:700">do</span>
  mode <span style="color:#4070a0">'0755'</span>
  source <span style="color:#4070a0">'somefile.erb'</span>
<span style="color:#007020;font-weight:700">end</span>

service <span style="color:#4070a0">'apache'</span> <span style="color:#007020;font-weight:700">do</span>
  action <span style="color:#517918">:enable</span>
  subscribes <span style="color:#517918">:reload</span>, <span style="color:#4070a0">'template[/tmp/somefile]'</span>, <span style="color:#517918">:immediately</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>where the <code>subscribes</code> notification is used to reload the service whenever the template is modified.</p> <h2 id="relative-paths">Relative Paths</h2> <p>The following relative paths can be used with any resource:</p> <dl> <dt><code>#{ENV['HOME']}</code></dt> <dd> <p>Use to return the <code>~</code> path in Linux and macOS or the <code>%HOMEPATH%</code> in Microsoft Windows.</p> </dd> </dl> <h3 id="examples-5">Examples</h3> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">template <span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">#{</span><span style="color:#60add5">ENV</span><span style="color:#666">[</span><span style="color:#4070a0">'HOME'</span><span style="color:#666">]</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">/chef-getting-started.txt"</span> <span style="color:#007020;font-weight:700">do</span>
  source <span style="color:#4070a0">'chef-getting-started.txt.erb'</span>
  mode <span style="color:#4070a0">'0755'</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h2 id="run-in-compile-phase">Run in Compile Phase</h2> <p>Chef Infra Client processes recipes in two phases:</p> <ol> <li>First, each resource in the node object is identified and a resource collection is built. All recipes are loaded in a specific order, and then the actions specified within each of them are identified. This is also referred to as the “compile phase”.</li> <li>Next, Chef Infra Client configures the system based on the order of the resources in the resource collection. Each resource then examines the node and performs the necessary steps to complete the action. This is also referred to as the “execution phase”.</li> </ol> <p>Typically, actions are processed during the execution phase of a Chef Infra Client run. However, sometimes it is necessary to run an action during the compile phase. For example, a resource can be configured to install a package during the compile phase to ensure that application is available to other resources during the execution phase.</p> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> <p>Use the <strong>chef_gem</strong> resource to install gems that are needed by Chef Infra Client during the execution phase.</p> </div> </div> <h3 id="using-the-compile_time-property">Using the compile_time property</h3> <p>Use <code>.run_action(:some_action)</code> at the end of a resource block to run the specified action during the compile phase. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">build_essential <span style="color:#4070a0">'Install compilers'</span> <span style="color:#007020;font-weight:700">do</span>
  action <span style="color:#517918">:nothing</span>
<span style="color:#007020;font-weight:700">end</span><span style="color:#666">.</span>run_action(<span style="color:#517918">:install</span>)
</code></pre></div>
<p>where <code>action</code> is set to <code>:nothing</code> to ensure the <code>run_action</code> is run during the compile phase and not later during the execution phase.</p> <p>This can be simplified by using the <code>compile_time</code> flag in Chef Infra Client 16 and later versions:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">build_essential <span style="color:#4070a0">'Install compilers'</span> <span style="color:#007020;font-weight:700">do</span>
  compile_time <span style="color:#007020">true</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>That flag both forces the resource to run at compile time and sets the converge action to <code>:nothing</code>.</p> <p>The following examples show when (and when not) to use <code>run_action</code>.</p> <p><strong>Using Custom Resources preferred to forcing to compile time</strong></p> <p>Compile time execution is often used to install gems before requiring them in recipe code.</p> <p>This is a poor pattern since gems may depend on native gems which may require installing compilers at compile time.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">build_essential <span style="color:#4070a0">'Install compilers'</span> <span style="color:#007020;font-weight:700">do</span>
  compile_time <span style="color:#007020">true</span>
<span style="color:#007020;font-weight:700">end</span>

chef_gem <span style="color:#4070a0">'aws-dsk'</span> <span style="color:#007020;font-weight:700">do</span>
  compile_time <span style="color:#007020">true</span>
<span style="color:#007020;font-weight:700">end</span>

<span style="color:#007020">require</span> <span style="color:#4070a0">'aws-sdk'</span>
</code></pre></div>
<p>A better strategy is to move the code, which requires the gem, into a custom resource. Since all the actions of custom resources run at converge time, this defers requiring the gem until later in the overall Chef Infra Client execution. Unified mode can also be used in the resource to eliminate compile/converge mode issues entirely:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">unified_mode <span style="color:#007020">true</span>

action <span style="color:#517918">:run</span> <span style="color:#007020;font-weight:700">do</span>
  build_essential <span style="color:#4070a0">'Install compilers'</span>

  chef_gem <span style="color:#4070a0">'aws-sdk'</span>

  <span style="color:#007020">require</span> <span style="color:#4070a0">'aws-sdk'</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p><strong>Download and parse a configuration file</strong></p> <p>A common use case is to download a configuration file, parse it, and then use the values in templates and to control other configuration.</p> <p>An important distinction to make is that the downloaded configuration file only exists in a temporary state to be used by the Chef Infra Client. It will not be used directly by the system or applications that are managed by the Chef Infra Client.</p> <p>To download and parse a JSON file and render it in a template, it makes sense to download the file during compile time:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">  <span style="color:#60a0b0;font-style:italic"># the remote_file is being downloaded to a temporary file</span>
  remote_file <span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">#{</span><span style="color:#60add5">Chef</span><span style="color:#666">::</span><span style="color:#60add5">Config</span><span style="color:#666">[</span><span style="color:#517918">:file_cache_path</span><span style="color:#666">]</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">/users.json"</span> <span style="color:#007020;font-weight:700">do</span>
    source <span style="color:#4070a0">"https://jsonplaceholder.typicode.com/users"</span>
    compile_time <span style="color:#007020">true</span>
  <span style="color:#007020;font-weight:700">end</span>

  <span style="color:#60a0b0;font-style:italic"># this parsing needs to happen after the remote_file is downloaded, but will</span>
  <span style="color:#60a0b0;font-style:italic"># be executed at compile time.</span>
  array <span style="color:#666">=</span> <span style="color:#60add5">JSON</span><span style="color:#666">.</span>parse(<span style="color:#60add5">IO</span><span style="color:#666">.</span>read(<span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">#{</span><span style="color:#60add5">Chef</span><span style="color:#666">::</span><span style="color:#60add5">Config</span><span style="color:#666">[</span><span style="color:#517918">:file_cache_path</span><span style="color:#666">]</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">/users.json"</span>)

  <span style="color:#60a0b0;font-style:italic"># the `array.last["phone"]` expression here will also be evaluated at compile</span>
  <span style="color:#60a0b0;font-style:italic"># time and must be lazied via wrapping the expresssion in `lazy {}`</span>
  file <span style="color:#4070a0">"/tmp/phone_number.txt"</span> <span style="color:#007020;font-weight:700">do</span>
    content array<span style="color:#666">.</span>last<span style="color:#666">[</span><span style="color:#4070a0">"phone"</span><span style="color:#666">]</span>
  <span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>This is considerably cleaner than the alternative of lazy evaluating both the parsing of the JSON and the rendering of the data into the file template, which will happen if the <code>remote_file</code> resource is not run at compile time:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">  <span style="color:#60a0b0;font-style:italic"># the execution of this is now deferred</span>
  remote_file <span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">#{</span><span style="color:#60add5">Chef</span><span style="color:#666">::</span><span style="color:#60add5">Config</span><span style="color:#666">[</span><span style="color:#517918">:file_cache_path</span><span style="color:#666">]</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">/users.json"</span> <span style="color:#007020;font-weight:700">do</span>
    source <span style="color:#4070a0">"https://jsonplaceholder.typicode.com/users"</span>
  <span style="color:#007020;font-weight:700">end</span>

  <span style="color:#60a0b0;font-style:italic"># it is necessary due to lexical scoping issues to create this variable here</span>
  array <span style="color:#666">=</span> <span style="color:#007020">nil</span>

  <span style="color:#60a0b0;font-style:italic"># the parsing of the JSON is now deferred due to the ruby_block</span>
  ruby_block <span style="color:#4070a0">"parse JSON"</span> <span style="color:#007020;font-weight:700">do</span>
    block <span style="color:#007020;font-weight:700">do</span>
      array <span style="color:#666">=</span> <span style="color:#60add5">JSON</span><span style="color:#666">.</span>parse(<span style="color:#60add5">IO</span><span style="color:#666">.</span>read(<span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">#{</span><span style="color:#60add5">Chef</span><span style="color:#666">::</span><span style="color:#60add5">Config</span><span style="color:#666">[</span><span style="color:#517918">:file_cache_path</span><span style="color:#666">]</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">/users.json"</span>)
    <span style="color:#007020;font-weight:700">end</span>
  <span style="color:#007020;font-weight:700">end</span>

  <span style="color:#60a0b0;font-style:italic"># the argument to the content property must now also be deferred</span>
  file <span style="color:#4070a0">"/tmp/phone_number.txt"</span> <span style="color:#007020;font-weight:700">do</span>
    content lazy { array<span style="color:#666">.</span>last<span style="color:#666">[</span><span style="color:#4070a0">"phone"</span><span style="color:#666">]</span> }
  <span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>This is an example of code that overuses deferred execution, uses more “lazy” evaluation, and is considerably harder to understand and write correctly.</p> <p><strong>Notifications will not work</strong></p> <p>Resources that are executed during the compile phase cannot notify other resources. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">execute <span style="color:#4070a0">'ifconfig'</span>

package <span style="color:#4070a0">'vim-enhanced'</span> <span style="color:#007020;font-weight:700">do</span>
  compile_time <span style="color:#007020">true</span>
  notifies <span style="color:#517918">:run</span>, <span style="color:#4070a0">'execute[ifconfig]'</span>, <span style="color:#517918">:immediately</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>A better approach in this type of situation is to install the package before the resource collection is built to ensure that it is available to other resources later on.</p> <p>The best approach to this problem is to use <code>unified mode</code> which eliminates the compile time and converge time distinction, while allowing notifications to work correctly.</p> <p><strong>Resources that are forced to compile time by default</strong></p> <p>The <code>ohai_hint</code> and <code>hostname</code> resources run at compile time by default.</p> <p>This is due to the fact that later resources may consume the node attributes which are set by those resources leading to excessive use of <code>lazy</code> in subsequent resources (and similar issues to the <code>remote_file</code> example above).</p> <p>The <code>chef_gem</code> resource used to execute at compile time by default, but now we recommend that users move code that executes at compile time to custom resources.</p> <h2 id="windows-file-security">Windows File Security</h2> <p>To support Microsoft Windows security, the <strong>template</strong>, <strong>file</strong>, <strong>remote_file</strong>, <strong>cookbook_file</strong>, <strong>directory</strong>, and <strong>remote_directory</strong> resources support the use of inheritance and access control lists (ACLs) within recipes.</p> <h3 id="access-control-lists-acls">Access Control Lists (ACLs)</h3> <p>The <code>rights</code> property can be used in a recipe to manage access control lists (ACLs), which allow permissions to be given to multiple users and groups. Use the <code>rights</code> property can be used as many times as necessary; Chef Infra Client will apply them to the file or directory as required. The syntax for the <code>rights</code> property is as follows:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">rights permission, principal, option_type <span style="color:#666">=&gt;</span> value
</code></pre></div>
<p>where</p> <dl> <dt><code>permission</code></dt> <dd> <p>Use to specify which rights are granted to the <code>principal</code>. The possible values are: <code>:read</code>, <code>:write</code>, <code>read_execute</code>, <code>:modify</code>, <code>:full_control</code>, or an integer.</p> </dd> <dd> <p>Integers used for permissions must match the following list <a href="https://docs.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.filesystemrights?view=windowsdesktop-5.0#fields">FileSystemRights Enum</a> fields.</p> </dd> </dl> <pre class="highlight" data-language="ruby"><code>These permissions are cumulative. If `:write` is specified, then it
includes `:read`. If `:full_control` is specified, then it includes
both `:write` and `:read`.

(For those who know the Microsoft Windows API: `:read` corresponds
to `GENERIC_READ`; `:write` corresponds to `GENERIC_WRITE`;
`:read_execute` corresponds to `GENERIC_READ` and `GENERIC_EXECUTE`;
`:modify` corresponds to `GENERIC_WRITE`, `GENERIC_READ`,
`GENERIC_EXECUTE`, and `DELETE`; `:full_control` corresponds to
`GENERIC_ALL`, which allows a user to change the owner and other
metadata about a file.)
</code></pre> <dl> <dt><code>principal</code></dt> <dd> <p>Use to specify a group or user. The principal can be specified by either name or SID. When using name, this is identical to what is entered in the login box for Microsoft Windows, such as <code>user_name</code>, <code>domain\user_name</code>, or <code>user_name@fully_qualified_domain_name</code>. When using a SID, you may use either the standard string representation of a SID (S-R-I-S-S) or one of the <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/sid-strings">SDDL string constants</a>. Chef Infra Client does not need to know if a principal is a user or a group.</p> </dd> <dt><code>option_type</code></dt> <dd> <p>A hash that contains advanced rights options. For example, the rights to a directory that only applies to the first level of children might look something like: <code>rights :write, 'domain\group_name', :one_level_deep =&gt; true</code>. Possible option types:</p> <table> <col style="width:12%"> <col style="width:87%"> <thead> <tr class="header"> <th>Option Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>:applies_to_children</code></td> <td>Specify how permissions are applied to children. Possible values: <code>true</code> to inherit both child directories and files; <code>false</code> to not inherit any child directories or files; <code>:containers_only</code> to inherit only child directories (and not files); <code>:objects_only</code> to recursively inherit files (and not child directories).</td> </tr> <tr> <td><code>:applies_to_self</code></td> <td>Indicates whether a permission is applied to the parent directory. Possible values: <code>true</code> to apply to the parent directory or file and its children; <code>false</code> to not apply only to child directories and files.</td> </tr> <tr> <td><code>:one_level_deep</code></td> <td>Indicates the depth to which permissions will be applied. Possible values: <code>true</code> to apply only to the first level of children; <code>false</code> to apply to all children.</td> </tr> </tbody> </table> </dd> </dl> <p>For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">resource <span style="color:#4070a0">'x.txt'</span> <span style="color:#007020;font-weight:700">do</span>
  rights <span style="color:#517918">:read</span>, <span style="color:#4070a0">'S-1-1-0'</span>
  rights <span style="color:#517918">:write</span>, <span style="color:#4070a0">'domain\group'</span>
  rights <span style="color:#517918">:full_control</span>, <span style="color:#4070a0">'group_name_or_user_name'</span>
  rights <span style="color:#517918">:full_control</span>, <span style="color:#4070a0">'user_name'</span>, <span style="color:#517918">applies_to_children</span>: <span style="color:#007020">true</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>or:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">rights <span style="color:#517918">:read</span>, <span style="color:#c65d09">%w(Administrators Everyone)</span>
rights <span style="color:#517918">:full_control</span>, <span style="color:#4070a0">'Users'</span>, <span style="color:#517918">applies_to_children</span>: <span style="color:#007020">true</span>
rights <span style="color:#517918">:write</span>, <span style="color:#4070a0">'Sally'</span>, <span style="color:#517918">applies_to_children</span>: <span style="color:#517918">:containers_only</span>, <span style="color:#517918">applies_to_self</span>: <span style="color:#007020">false</span>, <span style="color:#517918">one_level_deep</span>: <span style="color:#007020">true</span>
</code></pre></div>
<p>Some other important things to know when using the <code>rights</code> attribute:</p> <ul> <li>Only inherited rights remain. All existing explicit rights on the object are removed and replaced.</li> <li>If rights are not specified, nothing will be changed. Chef Infra Client does not clear out the rights on a file or directory if rights are not specified.</li> <li>Changing inherited rights can be expensive. Microsoft Windows will propagate rights to all children recursively due to inheritance. This is a normal aspect of Microsoft Windows, so consider the frequency with which this type of action is necessary and take steps to control this type of action if performance is the primary consideration.</li> </ul> <p>Use the <code>deny_rights</code> property to deny specific rights to specific users. The ordering is independent of using the <code>rights</code> property. For example, it doesn’t matter if rights are granted to everyone is placed before or after <code>deny_rights :read, ['Julian', 'Lewis']</code>, both Julian and Lewis will be unable to read the document. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">resource <span style="color:#4070a0">'x.txt'</span> <span style="color:#007020;font-weight:700">do</span>
  rights <span style="color:#517918">:read</span>, <span style="color:#4070a0">'Everyone'</span>
  rights <span style="color:#517918">:write</span>, <span style="color:#4070a0">'domain\group'</span>
  rights <span style="color:#517918">:full_control</span>, <span style="color:#4070a0">'group_name_or_user_name'</span>
  rights <span style="color:#517918">:full_control</span>, <span style="color:#4070a0">'user_name'</span>, <span style="color:#517918">applies_to_children</span>: <span style="color:#007020">true</span>
  deny_rights <span style="color:#517918">:read</span>, <span style="color:#c65d09">%w(Julian Lewis)</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>or:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">deny_rights <span style="color:#517918">:full_control</span>, <span style="color:#666">[</span><span style="color:#4070a0">'Sally'</span><span style="color:#666">]</span>
</code></pre></div>
<h3 id="inheritance-1">Inheritance</h3> <p>By default, a file or directory inherits rights from its parent directory. Most of the time this is the preferred behavior, but sometimes it may be necessary to take steps to more specifically control rights. The <code>inherits</code> property can be used to specifically tell Chef Infra Client to apply (or not apply) inherited rights from its parent directory.</p> <p>For example, the following example specifies the rights for a directory:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">directory <span style="color:#4070a0">'C:\mordor'</span> <span style="color:#007020;font-weight:700">do</span>
  rights <span style="color:#517918">:read</span>, <span style="color:#4070a0">'MORDOR\Minions'</span>
  rights <span style="color:#517918">:full_control</span>, <span style="color:#4070a0">'MORDOR\Sauron'</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>and then the following example specifies how to use inheritance to deny access to the child directory:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">directory <span style="color:#4070a0">'C:\mordor\mount_doom'</span> <span style="color:#007020;font-weight:700">do</span>
  rights <span style="color:#517918">:full_control</span>, <span style="color:#4070a0">'MORDOR\Sauron'</span>
  inherits <span style="color:#007020">false</span> <span style="color:#60a0b0;font-style:italic"># Sauron is the only person who should have any sort of access</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>If the <code>deny_rights</code> permission were to be used instead, something could slip through unless all users and groups were denied.</p> <p>Another example also shows how to specify rights for a directory:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">directory <span style="color:#4070a0">'C:\mordor'</span> <span style="color:#007020;font-weight:700">do</span>
  rights <span style="color:#517918">:read</span>, <span style="color:#4070a0">'MORDOR\Minions'</span>
  rights <span style="color:#517918">:full_control</span>, <span style="color:#4070a0">'MORDOR\Sauron'</span>
  rights <span style="color:#517918">:write</span>, <span style="color:#4070a0">'SHIRE\Frodo'</span> <span style="color:#60a0b0;font-style:italic"># Who put that there I didn't put that there</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>but then not use the <code>inherits</code> property to deny those rights on a child directory:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">directory <span style="color:#4070a0">'C:\mordor\mount_doom'</span> <span style="color:#007020;font-weight:700">do</span>
  deny_rights <span style="color:#517918">:read</span>, <span style="color:#4070a0">'MORDOR\Minions'</span> <span style="color:#60a0b0;font-style:italic"># Oops, not specific enough</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>Because the <code>inherits</code> property is not specified, Chef Infra Client will default it to <code>true</code>, which will ensure that security settings for existing files remain unchanged.</p> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/resource_common/" class="_attribution-link">https://docs.chef.io/resource_common/</a>
  </p>
</div>
