<div id="col-content" data-swiftype-index="true"> <div id="install-chef-in-an-air-gapped-environment"><h1>Install Chef in an air-gapped environment</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/chef-web-docs/blob/main/content/install_chef_air_gap.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>This guide will show you how to run a fully functional Chef environment within an <a href="https://en.wikipedia.org/wiki/Air_gap_(networking)">air-gapped</a> network.</p> <h2 id="prerequisites">Prerequisites</h2> <p>Since a variety of different practices are used to create an air-gapped network, this guide focuses solely on the implementation of Chef software - as such, it makes the following assumptions:</p> <ul> <li>You have a way to get packages to your air-gapped machines</li> <li>Machines on your air-gapped network are able to resolve each other via DNS</li> <li>A server’s Fully Qualified Domain Name (FQDN) is the name that will be used by other servers to access it</li> <li>You have a private Ruby gem mirror to supply gems as needed</li> <li>You have an artifact store for file downloads. At a minimum, it should have the following packages available: <ul> <li>Chef Workstation</li> <li>Chef Infra Client</li> <li>Chef Supermarket</li> <li>An <a href="index.html#create-an-install-script">install script</a> for Chef Infra Client</li> </ul> </li> </ul> <h3 id="required-cookbooks">Required cookbooks</h3> <p>This guide will link to the required cookbooks for each piece of software in that software’s respective section, but this is a full list of the cookbooks required to complete the entire guide:</p> <p>For Chef Supermarket:</p> <ul> <li><a href="https://supermarket.chef.io/cookbooks/supermarket-omnibus-cookbook">supermarket-omnibus-cookbook</a></li> <li><a href="https://supermarket.chef.io/cookbooks/chef-ingredient">chef-ingredient</a></li> <li><a href="https://supermarket.chef.io/cookbooks/hostsfile">hostsfile</a></li> </ul> <h3 id="required-gems">Required Gems</h3> <p>The following Ruby gems are required to install private Supermarket via the supermarket-omnibus-cookbook:</p> <ul> <li>mixlib-install</li> <li>mixlib-shellout</li> <li>mixlib-versioning</li> <li>artifactory</li> </ul> <p>These should be accessible from your Gem mirror.</p> <h3 id="create-an-install-script">Create an install script</h3> <p>An install script is used to install Chef Infra Client when bootstrapping a new node. It simply pulls the Chef Infra Client package from your artifact store, and then installs it. For example, on Debian-based Linux systems, it would look similar to this:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#007020">#!/bin/bash
</span>
<span style="color:#007020">cd</span> /tmp/
wget http://packages.example.com/chef_13.2.20-1_amd64.deb
dpkg -i chef_13.2.20-1_amd64.deb
</code></pre></div>
<p>The install script should be accessible from your artifact store.</p> <h2 id="chef-infra-server">Chef Infra Server</h2> <p>In this section you’ll install the Chef Infra Server, and create your organization and user. Note that in order to configure Supermarket later in this guide, you will need a user that is a member of the <code>admins</code> group.</p> <ol> <li> <p>Download the package from <a href="https://www.chef.io/downloads/tools/infra-server">https://www.chef.io/downloads/tools/infra-server</a>.</p> </li> <li> <p>Upload the package to the machine that will run the Chef Infra Server, and then record its location on the file system. The rest of these steps assume this location is in the <code>/tmp</code> directory.</p> </li> <li> <p>As a root user, install the Chef Infra Server package on the server, using the name of the package provided by Chef. For Red Hat Enterprise Linux and CentOS:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">sudo rpm -Uvh /tmp/chef-server-core-&lt;version&gt;.rpm
</code></pre></div>
<p>For Ubuntu:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">sudo dpkg -i /tmp/chef-server-core-&lt;version&gt;.deb
</code></pre></div>
<p>After a few minutes, the Chef Infra Server will be installed.</p> </li> <li> <p>Run the following to start all of the services:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">sudo chef-server-ctl reconfigure
</code></pre></div>
<p>Because the Chef Infra Server is composed of many different services that work together to create a functioning system, this step may take a few minutes to complete.</p> </li> <li> <p>Run the following command to create an administrator:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">sudo chef-server-ctl user-create USER_NAME FIRST_NAME LAST_NAME EMAIL <span style="color:#4070a0">'PASSWORD'</span> --filename FILE_NAME
</code></pre></div>
<p>An RSA private key is generated automatically. This is the user’s private key and should be saved to a safe location. The <code>--filename</code> option will save the RSA private key to the specified absolute path.</p> <p>For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">sudo chef-server-ctl user-create janedoe Jane Doe janed@example.com <span style="color:#4070a0">'abc123'</span> --filename /path/to/janedoe.pem
</code></pre></div> </li> <li> <p>Run the following command to create an organization:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">sudo chef-server-ctl org-create short_name <span style="color:#4070a0">'full_organization_name'</span> --association_user user_name --filename ORGANIZATION-validator.pem
</code></pre></div>
<p>For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">sudo chef-server-ctl org-create 4thcafe <span style="color:#4070a0">'Fourth Cafe, Inc.'</span> --association_user janedoe --filename /path/to/4thcafe-validator.pem
</code></pre></div>
<p>The name must begin with a lower-case letter or digit, may only contain lower-case letters, digits, hyphens, and underscores, and must be between 1 and 255 characters. For example: <code>4thcafe</code>.</p> <p>The full name must begin with a non-white space character and must be between 1 and 1023 characters. For example: <code>'Fourth Cafe, Inc.'</code>.</p> <p>The <code>--association_user</code> option will associate the <code>user_name</code> with the <code>admins</code> security group on the Chef Infra Server.</p> <p>An RSA private key is generated automatically. This is the chef-validator key and should be saved to a safe location. The <code>--filename</code> option will save the RSA private key to the specified absolute path.</p> </li> </ol> <h2 id="chef-workstation">Chef Workstation</h2> <h3 id="install-chef-workstation">Install Chef Workstation</h3> <ol> <li> <p>First, install the Chef Workstation <a href="https://www.chef.io/downloads/tools/workstation">installer package</a>. Use the appropriate tool to run the installer:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">dpkg -i chef-workstation_0.14.16-1_amd64.deb
</code></pre></div>
</li> <li> <p>Use the <code>chef generate repo</code> command to generate your Chef repo:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef generate repo chef-repo
</code></pre></div>
</li> <li> <p>Within your Chef repo, create a <code>.chef</code> directory:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">mkdir /chef-repo/.chef
</code></pre></div>
</li> <li> <p>Copy the <code>USER.pem</code> and <code>ORGANIZATION.pem</code> files from the server, and move them into the <code>.chef</code> directory.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">scp ssh-user@chef-server.example.com:/path/to/pem/files /chef-repo/.chef/
</code></pre></div>
</li> </ol> <h3 id="create-a-bootstrap-template">Create a bootstrap template</h3> <p>By default, <code>knife bootstrap</code> uses the <code>chef-full</code> template to bootstrap a node. This template contains a number of useful features, but it also attempts to pull an installation script from <code>packages.chef.io</code>. In this section, you’ll copy the contents of the <code>chef-full</code> template to a custom template, and then modify the package and Ruby gem sources.</p> <ol> <li> <p>Navigate to the <code>.chef</code> directory, and create a <code>bootstrap</code> directory within it:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">mkdir bootstrap
</code></pre></div>
</li> <li> <p>Move to the <code>bootstrap</code> directory and create a blank template file; this example will use <code>airgap.erb</code> for the template name:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">touch airgap.erb
</code></pre></div>
</li> <li> <p>Still in the <code>bootstrap</code> directory, issue the following command to copy the <code>chef-full</code> configuration to your new template:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">find /opt/chef-workstation/embedded/lib/ruby -type f -name chef-full.erb -exec cat <span style="color:#666">{}</span> <span style="color:#4070a0;font-weight:700">\;</span> &gt; airgap.erb
</code></pre></div>
<p>This command searches for the <code>chef-full</code> template file under <code>/opt/chef-workstation/embedded/lib/ruby</code>, and then outputs the contents of the file to <code>airgap.erb</code>. If you used a different template file name, be sure to replace <code>airgap.erb</code> with the template file you created during the last step.</p> </li> <li> <p>Update <code>airgap.erb</code> to replace <code>omnitruck.chef.io</code> with the URL of <code>install.sh</code> on your artifact store:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">install_sh<span style="color:#666">=</span><span style="color:#4070a0">"&lt;%= knife_config[:bootstrap_url] ? knife_config[:bootstrap_url] : "</span><span style="color:#517918">http</span>:<span style="color:#235388">//</span>packages<span style="color:#666">.</span>example<span style="color:#666">.</span>com<span style="color:#666">/</span>install<span style="color:#666">.</span>sh<span style="color:#4070a0">" %&gt;"</span>
</code></pre></div>
</li> <li> <p>Still in your text editor, locate the following line near the bottom of your <code>airgap.erb</code> file:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">cat <span style="color:#666">&gt;</span> <span style="color:#235388">/etc/</span>chef<span style="color:#666">/</span>client<span style="color:#666">.</span>rb <span style="color:#4070a0">&lt;&lt;'EOP'
</span><span style="color:#666">&lt;%=</span> config_content <span style="color:#666">%&gt;</span>
<span style="color:#60add5">EOP</span>
</code></pre></div>
<p>Beneath it, add the following, replacing <code>gems.example.com</code> with the URL of your gem mirror:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">cat <span style="color:#666">&gt;&gt;</span> <span style="color:#235388">/etc/</span>chef<span style="color:#666">/</span>client<span style="color:#666">.</span>rb <span style="color:#4070a0">&lt;&lt;'EOP'
</span>rubygems_url <span style="color:#4070a0">"http://gems.example.com"</span>
<span style="color:#60add5">EOP</span>
</code></pre></div>
<p>This appends the appropriate <code>rubygems_url</code> setting to the <code>/etc/chef/client.rb</code> file that is created during bootstrap, which ensures that your nodes use your internal gem mirror.</p> </li> </ol> <h3 id="configure-knife">Configure knife</h3> <p>Within the <code>.chef</code> directory, create a <code>config.rb</code> file and replace <code>USER</code> and <code>ORGANIZATION</code> with the user and organization that you created on your Chef Infra Server; replace <code>chef-server.example.com</code> with your Chef Infra Server URL:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">current_dir <span style="color:#666">=</span> <span style="color:#60add5">File</span><span style="color:#666">.</span>dirname(__FILE__)
node_name                <span style="color:#4070a0">'USER'</span>
client_key               <span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">#{</span>current_dir<span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">/USER.pem"</span>
validation_client_name   <span style="color:#4070a0">'ORGANIZATION-validator'</span>
validation_key           <span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">#{</span>current_dir<span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">/ORGANIZATION.pem"</span>
chef_server_url          <span style="color:#4070a0">'https://chef-server.example.com/organizations/ORGANIZATION'</span>
cookbook_path            <span style="color:#666">[</span><span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">#{</span>current_dir<span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">/../cookbooks"</span><span style="color:#666">]</span>
knife<span style="color:#666">[</span><span style="color:#517918">:bootstrap_template</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">#{</span>current_dir<span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">/bootstrap/airgap.erb"</span>
</code></pre></div>
<p>The <code>knife[:bootstrap_template]</code> option in this example allows you to specify the template that <code>knife bootstrap</code> will use by default when bootstrapping a node. It should point to your custom template within the <code>bootstrap</code> directory.</p> <p>Now that <code>knife</code> is configured, copy the SSL certificates from your Chef Infra Server to your trusted certificates:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">knife ssl fetch
</code></pre></div>
<h2 id="private-supermarket">Private Supermarket</h2> <p>Private Supermarket allows you to host your own internal version of the <a href="https://supermarket.chef.io">Chef Supermarket</a> within your air-gapped network.</p> <h3 id="requirements">Requirements</h3> <p>In this section, you will use a wrapper around the <a href="https://supermarket.chef.io/cookbooks/supermarket-omnibus-cookbook">supermarket-omnibus-cookbook</a> to install private Supermarket. The Supermarket cookbook depends upon the following cookbooks:</p> <ul> <li><a href="https://supermarket.chef.io/cookbooks/chef-ingredient">chef-ingredient</a></li> <li><a href="https://supermarket.chef.io/cookbooks/hostsfile">hostsfile</a></li> </ul> <p>The following Gems must be accessible via your Gem mirror:</p> <ul> <li>mixlib-install</li> <li>mixlib-shellout</li> <li>mixlib-versioning</li> <li>artifactory</li> </ul> <p>Your <code>cookbooks</code> directory must have all three of these cookbooks installed before you will be able to use the Supermarket cookbook wrapper. In addition the necessary cookbooks, a private Chef Supermarket has the following requirements:</p> <ul> <li>An operational Chef Infra Server to act as the OAuth 2.0 provider</li> <li>A user account on the Chef Infra Server with <code>admins</code> privileges</li> <li>A key for the user account on the Chef server</li> <li>An x86_64 Ubuntu, RHEL, or Amazon Linux host with at least 1 GB memory</li> <li>System clocks synchronized on the Chef Infra Server and Supermarket hosts</li> <li>Sufficient disk space to meet project cookbook storage capacity or credentials to store cookbooks in an Amazon Simple Storage Service (S3) bucket</li> </ul> <h3 id="configure-credentials">Configure credentials</h3> <p>First, you’ll configure Chef Identity credentials for Supermarket. Chef Identity is an OAuth 2.0 service packaged with the Chef Infra Server, that allows you to use the same credentials to access both server and Supermarket.</p> <ol> <li> <p>Log on to the Chef Infra Server via SSH and elevate to an admin-level user. If running a multi-node Chef Infra Server cluster, log on to the node acting as the primary node in the cluster.</p> </li> <li> <p>Update the <code>/etc/opscode/chef-server.rb</code> configuration file.</p> <p>To define OAuth 2 information for Chef Supermarket, create a Hash similar to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">oc_id<span style="color:#666">[</span><span style="color:#4070a0">'applications'</span><span style="color:#666">]</span> <span style="color:#666">||=</span> {}
oc_id<span style="color:#666">[</span><span style="color:#4070a0">'applications'</span><span style="color:#666">][</span><span style="color:#4070a0">'supermarket'</span><span style="color:#666">]</span> <span style="color:#666">=</span> {
  <span style="color:#4070a0">'redirect_uri'</span> <span style="color:#666">=&gt;</span> <span style="color:#4070a0">'https://supermarket.mycompany.com/auth/chef_oauth2/callback'</span>,
}
</code></pre></div> </li> <li> <p>Reconfigure the Chef Infra Server.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">sudo chef-server-ctl reconfigure
</code></pre></div>
</li> <li> <p>Retrieve Supermarket’s OAuth 2.0 client credentials:</p> <p>Depending on your Chef Infra Server version and configuration (see <a href="../server/config_rb_server_optional_settings/index.html#config-rb-server-insecure-addon-compat">chef-server.rb</a>), this can be retrieved via <a href="../ctl_chef_server/index.html#ctl-chef-server-oc-id-show-app">chef-server-ctl oc-id-show-app supermarket</a> or is located in <code>/etc/opscode/oc-id-applications/supermarket.json</code>:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-javascript" data-lang="javascript">{
  <span style="color:#4070a0">"name"</span><span style="color:#666">:</span> <span style="color:#4070a0">"supermarket"</span>,
  <span style="color:#4070a0">"uid"</span><span style="color:#666">:</span> <span style="color:#4070a0">"0bad0f2eb04e935718e081fb71asdfec3681c81acb9968a8e1e32451d08b"</span>,
  <span style="color:#4070a0">"secret"</span><span style="color:#666">:</span> <span style="color:#4070a0">"17cf1141cc971a10ce307611beda7ffadstr4f1bc98d9f9ca76b9b127879"</span>,
  <span style="color:#4070a0">"redirect_uri"</span><span style="color:#666">:</span> <span style="color:#4070a0">"https://supermarket.mycompany.com/auth/chef_oauth2/callback"</span>
}
</code></pre></div>
</li> </ol> <h3 id="create-a-wrapper">Create a Wrapper</h3> <ol> <li> <p>Generate the cookbook:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef generate cookbook my_supermarket_wrapper
</code></pre></div>
</li> <li> <p>Change directories into that cookbook:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#007020">cd</span> my_supermarket_wrapper
</code></pre></div>
</li> <li> <p>Defines the wrapper cookbook’s dependency on the <code>supermarket-omnibus-cookbook</code> cookbook. Open the <code>metadata.rb</code> file of the newly-created cookbook, and then add the following line:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">depends <span style="color:#4070a0">'supermarket-omnibus-cookbook'</span>
</code></pre></div>
</li> <li> <p>Save and close the <code>metadata.rb</code> file.</p> </li> <li> <p>Open the <code>/recipes/default.rb</code> recipe located within the newly-generated cookbook and add the following content:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">include_recipe <span style="color:#4070a0">'supermarket-omnibus-cookbook'</span>
</code></pre></div>
<p>This ensures that the <code>default.rb</code> file in the <code>supermarket-omnibus-cookbook</code> is run.</p> </li> </ol> <h3 id="define-attributes">Define Attributes</h3> <p>Define the attributes for the Chef Supermarket installation and how it connects to the Chef Infra Server. One approach would be to hard-code attributes in the wrapper cookbook’s <code>default.rb</code> recipe. A better approach is to place these attributes in a <a href="../data_bags/index.html">data bag</a>, and then reference them from the recipe. For example, the data bag could be named <code>apps</code> and then a data bag item within the data bag could be named <code>supermarket</code>. The following attributes are required:</p> <ul> <li>
<code>chef_server_url</code>: the url for your chef server.</li> <li>
<code>chef_oauth2_app_id</code>: the Chef Identity uid from <code>/etc/opscode/oc-id-applications/supermarket.json</code>
</li> <li>
<code>chef_oauth2_secret</code>: The Chef Identity secret from <code>/etc/opscode/oc-id-applications/supermarket.json</code>
</li> <li>
<code>package_url</code>: The location of the Supermarket package on your artifact store</li> </ul> <p>To define these attributes, do the following:</p> <ol> <li> <p>Open the <code>recipes/default.rb</code> file and add the following, <strong>before</strong> the <code>include_recipe</code> line that was added in the previous step. This example uses a data bag named <code>apps</code> and a data bag item named <code>supermarket</code>:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">app <span style="color:#666">=</span> data_bag_item(<span style="color:#4070a0">'apps'</span>, <span style="color:#4070a0">'supermarket'</span>)
</code></pre></div>
</li> <li> <p>Set the attributes from the data bag:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">node<span style="color:#666">.</span>override<span style="color:#666">[</span><span style="color:#4070a0">'supermarket_omnibus'</span><span style="color:#666">][</span><span style="color:#4070a0">'chef_server_url'</span><span style="color:#666">]</span> <span style="color:#666">=</span> app<span style="color:#666">[</span><span style="color:#4070a0">'chef_server_url'</span><span style="color:#666">]</span>
node<span style="color:#666">.</span>override<span style="color:#666">[</span><span style="color:#4070a0">'supermarket_omnibus'</span><span style="color:#666">][</span><span style="color:#4070a0">'chef_oauth2_app_id'</span><span style="color:#666">]</span> <span style="color:#666">=</span> app<span style="color:#666">[</span><span style="color:#4070a0">'chef_oauth2_app_id'</span><span style="color:#666">]</span>
node<span style="color:#666">.</span>override<span style="color:#666">[</span><span style="color:#4070a0">'supermarket_omnibus'</span><span style="color:#666">][</span><span style="color:#4070a0">'chef_oauth2_secret'</span><span style="color:#666">]</span> <span style="color:#666">=</span> app<span style="color:#666">[</span><span style="color:#4070a0">'chef_oauth2_secret'</span><span style="color:#666">]</span>
node<span style="color:#666">.</span>override<span style="color:#666">[</span><span style="color:#4070a0">'supermarket_omnibus'</span><span style="color:#666">][</span><span style="color:#4070a0">'package_url'</span><span style="color:#666">]</span> <span style="color:#666">=</span> app<span style="color:#666">[</span><span style="color:#4070a0">'package_url'</span><span style="color:#666">]</span>
</code></pre></div>
<p>Note that the <code>['package_url']</code> setting points to the location of the Supermarket package on your artifact store. When finished, the <code>/recipes/default.rb</code> file should have code similar to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">app <span style="color:#666">=</span> data_bag_item(<span style="color:#4070a0">'apps'</span>, <span style="color:#4070a0">'supermarket'</span>)

node<span style="color:#666">.</span>override<span style="color:#666">[</span><span style="color:#4070a0">'supermarket_omnibus'</span><span style="color:#666">][</span><span style="color:#4070a0">'chef_server_url'</span><span style="color:#666">]</span> <span style="color:#666">=</span> app<span style="color:#666">[</span><span style="color:#4070a0">'chef_server_url'</span><span style="color:#666">]</span>
node<span style="color:#666">.</span>override<span style="color:#666">[</span><span style="color:#4070a0">'supermarket_omnibus'</span><span style="color:#666">][</span><span style="color:#4070a0">'chef_oauth2_app_id'</span><span style="color:#666">]</span> <span style="color:#666">=</span> app<span style="color:#666">[</span><span style="color:#4070a0">'chef_oauth2_app_id'</span><span style="color:#666">]</span>
node<span style="color:#666">.</span>override<span style="color:#666">[</span><span style="color:#4070a0">'supermarket_omnibus'</span><span style="color:#666">][</span><span style="color:#4070a0">'chef_oauth2_secret'</span><span style="color:#666">]</span> <span style="color:#666">=</span> app<span style="color:#666">[</span><span style="color:#4070a0">'chef_oauth2_secret'</span><span style="color:#666">]</span>

include_recipe <span style="color:#4070a0">'supermarket-omnibus-cookbook'</span>
</code></pre></div>
<p>Alternatively, if you chose not to use a data bag to store these values, your <code>default.rb</code> should look similar to this:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">node<span style="color:#666">.</span>override<span style="color:#666">[</span><span style="color:#4070a0">'supermarket_omnibus'</span><span style="color:#666">][</span><span style="color:#4070a0">'chef_server_url'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'https://chef-server.example.com:443'</span>
node<span style="color:#666">.</span>override<span style="color:#666">[</span><span style="color:#4070a0">'supermarket_omnibus'</span><span style="color:#666">][</span><span style="color:#4070a0">'chef_oauth2_app_id'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'0bad0f2eb04e935718e081fb71asdfec3681c81acb9968a8e1e32451d08b'</span>
node<span style="color:#666">.</span>override<span style="color:#666">[</span><span style="color:#4070a0">'supermarket_omnibus'</span><span style="color:#666">][</span><span style="color:#4070a0">'chef_oauth2_secret'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'17cf1141cc971a10ce307611beda7ffadstr4f1bc98d9f9ca76b9b127879'</span>
node<span style="color:#666">.</span>override<span style="color:#666">[</span><span style="color:#4070a0">'supermarket_omnibus'</span><span style="color:#666">][</span><span style="color:#4070a0">'package_url'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'http://packages.example.com/supermarket_3.1.22-1_amd64.deb'</span>

include_recipe <span style="color:#4070a0">'supermarket-omnibus-cookbook'</span>
</code></pre></div>
</li> <li> <p>Save and close the <code>recipes/default.rb</code> file.</p> </li> <li> <p>Upload all of your cookbooks to the Chef Infra Server:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">knife cookbook upload <span style="color:#666">-</span>a
</code></pre></div>
</li> </ol> <h3 id="bootstrap-supermarket">Bootstrap Supermarket</h3> <p>Bootstrap the node on which Chef Supermarket is to be installed. For example, to bootstrap a node running Ubuntu on Amazon Web Services (AWS), the command is similar to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife bootstrap ip_address -N supermarket-node -x ubuntu --sudo
</code></pre></div>
<p>where:</p> <ul> <li>
<code>-N</code> defines the name of the Chef Supermarket node: <code>supermarket-node</code>
</li> <li>
<code>-x</code> defines the (ssh) user name: <code>ubuntu</code>
</li> <li>
<code>--sudo</code> ensures that sudo is used while running commands on the node during the bootstrap operation</li> </ul> <p>When the bootstrap operation is finished, do the following:</p> <ol> <li> <p>Add the wrapper cookbook’s <code>/recipes/default.rb</code> recipe to the run-list:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife node run_list <span style="color:#007020">set</span> supermarket-node recipe<span style="color:#666">[</span>my_supermarket_wrapper::default<span style="color:#666">]</span>
</code></pre></div>
<p>where <code>supermarket-node</code> is the name of the node that was just bootstrapped.</p> </li> <li> <p>Start Chef Infra Client on the newly-bootstrapped Chef Supermarket node. For example, using SSH:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">ssh ubuntu@your-supermarket-node-public-dns
</code></pre></div>
</li> <li> <p>After accessing the Chef Supermarket node, run Chef Infra Client:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">sudo chef-client
</code></pre></div>
</li> </ol> <h3 id="connect-to-supermarket">Connect to Supermarket</h3> <p>To reach the newly spun up private Chef Supermarket, the hostname must be resolvable from a workstation. For production use, the hostname should have a DNS entry in an appropriate domain that is trusted by each user’s workstation.</p> <ol> <li>Visit the Chef Supermarket hostname in the browser. A private Chef Supermarket will generate and use a self-signed certificate, if a certificate is not supplied as part of the installation process (via the wrapper cookbook).</li> <li>If an SSL notice is shown due to your self-signed certificate while connecting to Chef Supermarket via a web browser, accept the SSL certificate. A trusted SSL certificate should be used for private Chef Supermarket that is used in production.</li> <li>After opening Chef Supermarket in a web browser, click the <strong>Create Account</strong> link. A prompt to log in to the Chef Infra Server is shown. Authorize the Chef Supermarket to use the Chef Infra Server account for authentication.</li> </ol> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> The redirect URL specified for Chef Identity <strong>MUST</strong> match the FQDN hostname of the Chef Supermarket server. The URI must also be correct: <code>/auth/chef_oauth2/callback</code>. Otherwise, an error message similar to <code>The redirect uri included is not valid.</code> will be shown. </div> </div> <h3 id="configuration-updates">Configuration updates</h3> <h4 id="knife">Knife</h4> <p>Update the <code>config.rb</code> file on your workstation to use your private Supermarket:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">knife<span style="color:#666">[</span><span style="color:#517918">:supermarket_site</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'https://supermarket.example.com'</span>
</code></pre></div>
<h4 id="berkshelf">Berkshelf</h4> <p>If you’re using Berkshelf, update your <code>Berksfile</code> to replace <code>https://supermarket.chef.io</code> with the URL of your private Supermarket:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">source <span style="color:#4070a0">'https://supermarket.example.com'</span>
</code></pre></div>
<h3 id="upload-cookbooks-to-supermarket">Upload cookbooks to Supermarket</h3> <p>To upload new cookbooks to your private Supermarket, use the <code>knife supermarket share</code> command on your workstation:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">knife supermarket share chef<span style="color:#666">-</span>ingredient
</code></pre></div> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/install_chef_air_gap/" class="_attribution-link">https://docs.chef.io/install_chef_air_gap/</a>
  </p>
</div>
