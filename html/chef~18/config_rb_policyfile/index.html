<div id="col-content" data-swiftype-index="true"> <div id="policyfilerb"><h1>Policyfile.rb</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/chef-web-docs/blob/main/content/config_rb_policyfile.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>A Policyfile is a way to create immutable collections of cookbooks, cookbook dependencies, and attributes defined in a single document that is uploaded to the Chef Infra Server. The Policyfile is then associated with a group of nodes. When these nodes perform a Chef Infra Client run, they utilize recipes specified in the Policyfile.</p> <p>A Policyfile file allows you to specify in a single document the cookbook revisions and recipes that Chef Infra Client will apply. A Policyfile file is uploaded to the Chef Infra Server, where it is associated with a group of nodes. When these nodes are configured during a Chef Infra Client run, Chef Infra Client will make decisions based on your Policyfile settings and will build a run-list based on that information. A Policyfile file may be versioned, and then promoted through deployment stages to safely and reliably deploy new configuration.</p> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> For more information about Policyfile, see <a href="../policyfile/index.html">About Policyfile</a> </div> </div> <h2 id="syntax">Syntax</h2> <p>A <code>Policyfile.rb</code> is a Ruby file in which run-list and cookbook locations are specified. The syntax is as follows:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#007020">name</span> <span style="color:#4070a0">"name"</span>
run_list <span style="color:#4070a0">"ITEM"</span>, <span style="color:#4070a0">"ITEM"</span>, <span style="color:#666">...</span>
default_source <span style="color:#517918">:SOURCE_TYPE</span>, <span style="color:#666">*</span>args
cookbook <span style="color:#4070a0">"NAME"</span> <span style="color:#666">[</span>, <span style="color:#4070a0">"VERSION_CONSTRAINT"</span><span style="color:#666">]</span> <span style="color:#666">[</span>, <span style="color:#60add5">SOURCE_OPTIONS</span><span style="color:#666">]</span>
</code></pre></div>
<h2 id="settings">Settings</h2> <p>A <code>Policyfile.rb</code> file may contain the following settings:</p> <dl> <dt><code>name "name"</code></dt> <dd> <p>Required. The name of the policy. Use a name that reflects the purpose of the machines against which the policy will run.</p> </dd> <dt><code>run_list "ITEM", "ITEM", ...</code></dt> <dd> <p>Required. The run-list Chef Infra Client will use to apply the policy to one (or more) nodes.</p> </dd> <dt><code>default_source :SOURCE_TYPE, *args</code></dt> <dd> <p>The location in which any cookbooks not specified by <code>cookbook</code> are located. Possible values: <code>chef_repo</code>, <code>chef_server</code>, <code>:supermarket</code>, and <code>:artifactory</code>. Use more than one <code>default_source</code> to specify more than one location for cookbooks.</p> <p><code>default_source :supermarket</code> pulls cookbooks from the public Chef Supermarket.</p> <p><code>default_source :supermarket, "https://mysupermarket.example"</code> pulls cookbooks from a named private Chef Supermarket.</p> <p><code>default_source :chef_server, "https://chef-server.example/organizations/example"</code> pulls cookbooks from the Chef Infra Server.</p> <p><code>default_source :chef_repo, "path/to/repo"</code> pulls cookbooks from a monolithic cookbook repository. This may be a path to the top-level of a cookbook repository or to the <code>/cookbooks</code> directory within that repository.</p> <p><code>default_source :artifactory, "https://artifactory.example/api/chef/my-supermarket"</code> pulls cookbooks from an Artifactory server. Requires either <code>artifactory_api_key</code> to be set in <code>config.rb</code> or <code>ARTIFACTORY_API_KEY</code> to be set in your environment.</p> <p>Multiple cookbook sources may be specified. For example from the public Chef Supermarket and a monolithic repository:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">default_source <span style="color:#517918">:supermarket</span>
default_source <span style="color:#517918">:chef_repo</span>, <span style="color:#4070a0">'path/to/repo'</span>
</code></pre></div>
<p>or from both a public and private Chef Supermarket:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">default_source <span style="color:#517918">:supermarket</span>
default_source <span style="color:#517918">:supermarket</span>, <span style="color:#4070a0">'https://supermarket.example'</span>
</code></pre></div>
<div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> <p>If a run-list or any dependencies require a cookbook that is present in more than one source, be explicit about which source is preferred. This will ensure that a cookbook is always pulled from an expected source. For example, an internally-developed cookbook named <code>chef-client</code> will conflict with the public <code>chef-client</code> cookbook that is maintained by Chef. To specify a named source for a cookbook:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">default_source <span style="color:#517918">:supermarket</span>
default_source <span style="color:#517918">:supermarket</span>, <span style="color:#4070a0">'https://supermarket.example'</span> <span style="color:#007020;font-weight:700">do</span> <span style="color:#666">|</span>s<span style="color:#666">|</span>
  s<span style="color:#666">.</span>preferred_for <span style="color:#4070a0">'chef-client'</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>List multiple cookbooks on the same line:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">default_source <span style="color:#517918">:supermarket</span>
default_source <span style="color:#517918">:supermarket</span>, <span style="color:#4070a0">'https://supermarket.example'</span> <span style="color:#007020;font-weight:700">do</span> <span style="color:#666">|</span>s<span style="color:#666">|</span>
  s<span style="color:#666">.</span>preferred_for <span style="color:#4070a0">'chef-client'</span>, <span style="color:#4070a0">'nginx'</span>, <span style="color:#4070a0">'mysql'</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
</div> </div> </dd> <dt><code>cookbook "NAME" [, "VERSION_CONSTRAINT"] [, SOURCE_OPTIONS]</code></dt> <dd> <p>Add cookbooks to the policy, specify a version constraint, or specify an alternate source location, such as Chef Supermarket. For example, add a cookbook:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">cookbook <span style="color:#4070a0">'apache2'</span>
</code></pre></div>
<p>Specify a version constraint:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">run_list <span style="color:#4070a0">'jenkins::master'</span>

<span style="color:#60a0b0;font-style:italic"># Restrict the jenkins cookbook to version 2.x, greater than 2.1</span>
cookbook <span style="color:#4070a0">'jenkins'</span>, <span style="color:#4070a0">'~&gt; 2.1'</span>
</code></pre></div>
<p>Specify an alternate source:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">cookbook <span style="color:#4070a0">'my_app'</span>, <span style="color:#517918">path</span>: <span style="color:#4070a0">'cookbooks/my_app'</span>
</code></pre></div>
<p>or:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">cookbook <span style="color:#4070a0">'mysql'</span>, <span style="color:#517918">github</span>: <span style="color:#4070a0">'opscode-cookbooks/mysql'</span>, <span style="color:#517918">branch</span>: <span style="color:#4070a0">'master'</span>
</code></pre></div>
<p>or:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">cookbook <span style="color:#4070a0">'chef-ingredient'</span>, <span style="color:#517918">git</span>: <span style="color:#4070a0">'https://github.com/chef-cookbooks/chef-ingredient.git'</span>, <span style="color:#517918">tag</span>: <span style="color:#4070a0">'v0.12.0'</span>
</code></pre></div>
</dd> <dt><code>named_run_list "NAME", "ITEM1", "ITEM2", ...</code></dt> <dd> <p>Specify a named run-list to be used as an alternative to the override run-list. This setting should be used carefully and for specific use cases, like running a small set of recipes to quickly converge configuration for a single application on a host or for one-time setup tasks. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">named_run_list <span style="color:#517918">:update_app</span>, <span style="color:#4070a0">'my_app_cookbook::default'</span>
</code></pre></div>
</dd> <dt><code>include_policy "NAME", *args</code></dt> <dd> <p>Specify a policyfile lock to be merged with this policy. Chef Workstation supports pulling this lock from a local or remote file, from a Chef Infra Server, or from a git repository. When the policyfile lock is included, its run-list will appear before the current policyfileâ€™s run-list. This setting requires that the solved cookbooks appear as-is from the included policyfile lock. If conflicting attributes or cookbooks are provided, an error will be presented. See <a href="https://github.com/chef-boneyard/chef-rfc/blob/master/rfc097-policyfile-includes.md">RFC097</a> for the full specifications of this feature.</p> <p>Pull the policyfile lock from <code>./NAME.lock.json</code>:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">include_policy <span style="color:#4070a0">'NAME'</span>, <span style="color:#517918">path</span>: <span style="color:#4070a0">'.'</span>
</code></pre></div>
<p>Pull the policyfile lock from <code>./foo.lock.json</code>.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">include_policy <span style="color:#4070a0">'NAME'</span>, <span style="color:#517918">path</span>: <span style="color:#4070a0">'./foo.lock.json'</span>
</code></pre></div>
<p>Pull the policyfile lock <code>foo.lock.json</code> from the <code>example/foo</code> Git repository on the <code>git.example.com</code> Git server.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">include_policy <span style="color:#4070a0">'NAME'</span>, <span style="color:#517918">git</span>: <span style="color:#4070a0">'https://git.example.com/example/foo'</span>, <span style="color:#517918">path</span>: <span style="color:#4070a0">'foo.lock.json'</span>
</code></pre></div>
<p>Pull the policyfile lock from <code>./bar.lock.json</code> with revision ID â€˜revision1â€™.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">include_policy <span style="color:#4070a0">'NAME'</span>, <span style="color:#517918">policy_revision_id</span>: <span style="color:#4070a0">'revision1'</span>, <span style="color:#517918">path</span>: <span style="color:#4070a0">'./bar.lock.json'</span>
</code></pre></div>
<p>Pull the policyfile lock from a remote server <code>https://internal.example.com/foo.lock.json</code>.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">include_policy <span style="color:#4070a0">'NAME'</span>, <span style="color:#517918">remote</span>: <span style="color:#4070a0">'https://internal.example.com/foo.lock.json'</span>
</code></pre></div>
<p>Pull the policyfile lock from a remote server <code>https://internal.example.com/bar.lock.json</code> and with revision ID â€˜revision1â€™.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">include_policy <span style="color:#4070a0">'NAME'</span>, <span style="color:#517918">policy_revision_id</span>: <span style="color:#4070a0">'revision1'</span>, <span style="color:#517918">remote</span>: <span style="color:#4070a0">'https://internal.example.com/foo.lock.json'</span>
</code></pre></div>
<p>Pull the policy <code>NAME</code> with revision ID <code>revision1</code> from the <code>http://chef-server.example</code> Chef Infra Server:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">include_policy <span style="color:#4070a0">'NAME'</span>, <span style="color:#517918">policy_revision_id</span>: <span style="color:#4070a0">'revision1'</span>, <span style="color:#517918">server</span>: <span style="color:#4070a0">'http://chef-server.example'</span>
</code></pre></div>
<p>Pull the policy <code>foo</code> with revision ID <code>revision1</code>:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">include_policy <span style="color:#4070a0">'NAME'</span>, <span style="color:#517918">policy_name</span>: <span style="color:#4070a0">'foo'</span>, <span style="color:#517918">policy_revision_id</span>: <span style="color:#4070a0">'revision1'</span>, <span style="color:#517918">server</span>: <span style="color:#4070a0">'http://chef-server.example'</span>
</code></pre></div>
<p>Pull and lock the current revision for policy <code>foo</code> in policy group <code>prod</code>:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">include_policy <span style="color:#4070a0">'NAME'</span>, <span style="color:#517918">policy_name</span>: <span style="color:#4070a0">'foo'</span>, <span style="color:#517918">policy_group</span>: <span style="color:#4070a0">'prod'</span>, <span style="color:#517918">server</span>: <span style="color:#4070a0">'http://chef-server.example'</span>
</code></pre></div>
</dd> </dl> <h2 id="example">Example</h2> <p>For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#007020">name</span> <span style="color:#4070a0">'jenkins-master'</span>
run_list <span style="color:#4070a0">'java'</span>, <span style="color:#4070a0">'jenkins::master'</span>, <span style="color:#4070a0">'recipe[policyfile_demo]'</span>
default_source <span style="color:#517918">:supermarket</span>, <span style="color:#4070a0">'https://mysupermarket.example'</span>
cookbook <span style="color:#4070a0">'policyfile_demo'</span>, <span style="color:#517918">path</span>: <span style="color:#4070a0">'cookbooks/policyfile_demo'</span>
cookbook <span style="color:#4070a0">'jenkins'</span>, <span style="color:#4070a0">'~&gt; 8.2'</span>
cookbook <span style="color:#4070a0">'mysql'</span>, <span style="color:#517918">github</span>: <span style="color:#4070a0">'sous-chefs/mysql'</span>, <span style="color:#517918">branch</span>: <span style="color:#4070a0">'master'</span>
</code></pre></div> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/config_rb_policyfile/" class="_attribution-link">https://docs.chef.io/config_rb_policyfile/</a>
  </p>
</div>
