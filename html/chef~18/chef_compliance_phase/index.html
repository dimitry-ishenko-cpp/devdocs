<div id="col-content" data-swiftype-index="true"> <div id="about-the-compliance-phase"><h1>About the Compliance Phase</h1></div>  <div class="prose"> <p><a href="https://github.com/chef/chef-web-docs/blob/main/content/chef_compliance_phase.md">[edit on GitHub]</a></p> <p>Chef Infra Client’s Compliance Phase lets you automatically execute compliance audits and view the results as part of any Chef Infra Client run. The Compliance Phase of the Chef Infra Client run replaces the legacy <a href="https://supermarket.chef.io/cookbooks/audit">audit cookbook</a> and works with your existing audit cookbook attributes, and you can also set it up for new cookbooks. This additional phase gives you the latest compliance capabilities without having to manage cookbook dependencies or juggle versions during Chef Infra Client updates.</p> <p>Existing audit cookbook users can migrate to the new Compliance Phase by removing the audit cookbook from their run_list and setting the <code>node['audit']['compliance_phase']</code> attribute to <code>true</code>.</p> <p>The Compliance Phase replaces the <code>audit cookbook</code> by integrating InSpec compliance checks into the <a href="../chef_client_overview/index.html">Chef Infra Client run</a> The Compliance Phase is designed to run on any node in your system that is set up–or <a href="../install_bootstrap/index.html">“bootstrapped”</a>–for a <code>chef-client</code> run.</p> <h2 id="upgrade-to-compliance-phase-from-audit-cookbook">Upgrade to Compliance Phase from Audit Cookbook</h2> <p>The Compliance Phase requires Chef Infra Client 17 or higher.</p> <p>If your system is configured to use the <code>audit cookbook</code>, make these changes to switch to the Compliance Phase:</p> <ol> <li> <p>Set the <code>node['audit']['compliance_phase']</code> attribute to <code>true</code> through a Policyfile or cookbook attributes file.</p> </li> <li> <p>Remove the <code>audit cookbook</code> from your <a href="../run_lists/index.html">‘run-list’</a>.</p> </li> <li> <p>On your next Chef Infra Client run, you should see the Compliance Phase results.</p> </li> </ol> <h2 id="set-up-the-compliance-phase-in-new-cookbooks">Set up the Compliance Phase in new Cookbooks</h2> <h3 id="enable-the-compliance-phase">Enable the Compliance Phase</h3> <p>The Compliance Phase is enabled by setting the <code>node['audit']['compliance_phase']</code> attribute to <code>true</code> through cookbook attributes or Policyfiles. To enable Compliance Phase using cookbook attributes add the following line to the <code>attributes/default.rb</code> file in your cookbook.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'compliance_phase'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">true</span>
</code></pre></div>
<h3 id="set-inspec-profiles">Set InSpec Profiles</h3> <p>Setting one or more Chef InSpec profiles enables the compliance phase in a Chef Infra Client run. The presence of this configuration in your attributes file instructs Chef Infra Client to fetch and execute the specific Chef InSpec profiles and write the results to disk using the default <code>cli</code> and <code>json-file</code> reporters.</p> <p>Retrieve <a href="../inspec/profiles/index.html">‘Chef InSpec profiles’</a> from Chef Automate, Supermarket, a local file, GitHub, or over HTTP with the <code>node['audit']['profiles']</code> attribute.</p> <p>The following examples:</p> <ul> <li>Retrieve profiles from Chef Automate, Supermarket, a local file, GitHub, or over HTTP.</li> <li>Display the results on the command line using the default <code>cli</code> reporter.</li> <li>Write the results to disk using the default <code>json-file</code> reporter to <code>&lt;chef_cache_path&gt;/compliance_reports/compliance-&lt;timestamp&gt;.json</code>.</li> </ul> 
<ul class="tabs" data-tabs id="compliance-phase-profile-panel"> <li class="tabs-title is-active"> <a href="#automate-panel" aria-selected="true">Automate</a> </li> <li class="tabs-title"> <a data-tabs-target="supermarket-panel" href="#supermarket-panel">Supermarket</a> </li> <li class="tabs-title"> <a data-tabs-target="local-path-panel" href="#local-path-panel">File</a> </li> <li class="tabs-title"> <a data-tabs-target="git-panel" href="#git-panel">GitHub</a> </li> <li class="tabs-title"> <a data-tabs-target="http-panel" href="#http-panel">HTTP</a> </li> </ul> <div class="tabs-content" data-tabs-content="compliance-phase-profile-panel"> <div class="tabs-panel is-active" id="automate-panel">
<div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># Invoke the Compliance Phase</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'compliance_phase'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">true</span>
<span style="color:#60a0b0;font-style:italic"># Set profile locations</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'profiles'</span><span style="color:#666">][</span><span style="color:#4070a0">'linux-baseline'</span><span style="color:#666">]</span> <span style="color:#666">=</span> {
  <span style="color:#4070a0">'compliance'</span>: <span style="color:#4070a0">'user/linux-baseline'</span>,
  <span style="color:#4070a0">'version'</span>: <span style="color:#4070a0">'2.1.0'</span>
}
</code></pre></div> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> Fetching profiles from Automate requires setting <code>data_collector.server_url</code> and <code>data_collector.token</code> in your <code>client.rb</code> to fetch profiles from Chef Automate. This configuration is described in more detail in the Chef Automate <a href="../automate/data_collection/index.html">data collector documentation</a>. </div> </div> </div> <div class="tabs-panel" id="supermarket-panel"><div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># Invoke the Compliance Phase</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'compliance_phase'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">true</span>
<span style="color:#60a0b0;font-style:italic"># Set profile locations</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'profiles'</span><span style="color:#666">][</span><span style="color:#4070a0">'ssh'</span><span style="color:#666">]</span> <span style="color:#666">=</span> {
  <span style="color:#4070a0">'supermarket'</span>: <span style="color:#4070a0">'hardening/ssh-hardening'</span>
}
</code></pre></div></div> <div class="tabs-panel" id="local-path-panel"><div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># Invoke the Compliance Phase</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'compliance_phase'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">true</span>
<span style="color:#60a0b0;font-style:italic"># Set profile locations</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'profiles'</span><span style="color:#666">][</span><span style="color:#4070a0">'4thcafe/win2012_audit'</span><span style="color:#666">]</span> <span style="color:#666">=</span> {
  <span style="color:#4070a0">'path'</span>: <span style="color:#4070a0">'E:/profiles/win2012_audit'</span>
}
</code></pre></div></div> <div class="tabs-panel" id="git-panel"><div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># Invoke the Compliance Phase</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'compliance_phase'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">true</span>
<span style="color:#60a0b0;font-style:italic"># Set profile locations</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'profiles'</span><span style="color:#666">][</span><span style="color:#4070a0">'ssl'</span><span style="color:#666">]</span> <span style="color:#666">=</span> {
  <span style="color:#4070a0">'git'</span>: <span style="color:#4070a0">'https://github.com/dev-sec/ssl-benchmark.git'</span>
}
</code></pre></div></div> <div class="tabs-panel" id="http-panel"><div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># Invoke the Compliance Phase</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'compliance_phase'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">true</span>
<span style="color:#60a0b0;font-style:italic"># Set profile locations</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'profiles'</span><span style="color:#666">][</span><span style="color:#4070a0">'ssh2'</span><span style="color:#666">]</span> <span style="color:#666">=</span> {
  <span style="color:#4070a0">'url'</span>: <span style="color:#4070a0">'https://github.com/dev-sec/tests-ssh-hardening/archive/master.zip'</span>
}
</code></pre></div></div> </div> <h3 id="fetch-profiles">Fetch Profiles</h3> <p>Set the fetcher attribute with <code>default['audit']['fetcher']</code> to retrieve InSpec compliance profiles from either Chef Automate or Chef Infra Server in addition to the location defined by <code>default ['audit']['profile']</code>. Left unset, the Compliance Phase defaults to the <a href="../inspec/profiles/index.html#profile-dependencies">fetchers included in Chef InSpec</a>. Chef Infra and Chef InSpec fetchers are mutually exclusive so, you can only use one of these configurations.</p> <p>The following examples:</p> <ul> <li>Retrieve the ‘ssh’ profile from Chef Supermarket.</li> <li>Fetch additional profiles from Chef Automate or Chef Server.</li> <li>Display the results on the command line using the default <code>cli</code> reporter.</li> <li>Write the results to disk using the default <code>json-file</code> reporter to <code>&lt;chef_cache_path&gt;/compliance_reports/compliance-&lt;timestamp&gt;.json</code>.</li> </ul> 
<ul class="tabs" data-tabs id="compliance-phase-fetcher-panel"> <li class="tabs-title is-active"> <a href="#automate-fetcher" aria-selected="true">Automate</a> </li> <li class="tabs-title"> <a data-tabs-target="server-fetcher" href="#server-fetcher">Infra Server</a> </li> </ul> <div class="tabs-content" data-tabs-content="compliance-phase-fetcher-panel"> <div class="tabs-panel is-active" id="automate-fetcher">
<div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># Invoke the Compliance Phase</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'compliance_phase'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">true</span>
<span style="color:#60a0b0;font-style:italic"># Set profile location</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'profiles'</span><span style="color:#666">][</span><span style="color:#4070a0">'ssh'</span><span style="color:#666">]</span> <span style="color:#666">=</span> {
<span style="color:#4070a0">'supermarket'</span>: <span style="color:#4070a0">'hardening/ssh-hardening'</span>
}
<span style="color:#60a0b0;font-style:italic"># Fetch additional profiles</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'fetcher'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'chef-automate'</span>
</code></pre></div> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> Fetching profiles from Automate requires setting <code>data_collector.server_url</code> and <code>data_collector.token</code> in your <code>client.rb</code> to fetch profiles from Chef Automate. This configuration is described in more detail in the Chef Automate <a href="../automate/data_collection/index.html">data collector documentation</a>. </div> </div> </div> <div class="tabs-panel" id="server-fetcher"><div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># Invoke the Compliance Phase</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'compliance_phase'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">true</span>
<span style="color:#60a0b0;font-style:italic"># Set profile location</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'profiles'</span><span style="color:#666">][</span><span style="color:#4070a0">'ssh'</span><span style="color:#666">]</span> <span style="color:#666">=</span> {
<span style="color:#4070a0">'supermarket'</span>: <span style="color:#4070a0">'hardening/ssh-hardening'</span>
}
<span style="color:#60a0b0;font-style:italic"># Fetch additional profiles</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'fetcher'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'chef-server'</span>
</code></pre></div></div> </div> <h3 id="reporters">Reporters</h3> <p>Reporters control what is done with the resulting report after the Chef InSpec run. Either a single value or a list of multiple values is supported. The default is the <code>cli</code> and <code>json-file</code> reporters.</p> <p>Reporters can send Compliance Phase results to:</p> <ul> <li>Chef Automate proxied by Chef Infra Server.</li> <li>Directly to Chef Automate (requires additional authentication).</li> <li>The terminal if Chef Infra Client is run interactively by a user.</li> <li>A file on disk.</li> </ul> <p>The following examples:</p> <ul> <li>Retrieve the ‘ssh’ profile from Chef Supermarket</li> <li>Fetch additional profiles from Chef Automate</li> <li>Send the results to Chef Automate, Chef Automate proxied by Chef Infra Server, or to a file on disk.</li> </ul> 
<ul class="tabs" data-tabs id="compliance-phase-reporter-panel"> <li class="tabs-title is-active"> <a href="#automate-reporter" aria-selected="true">Automate</a> </li> <li class="tabs-title"> <a data-tabs-target="server-reporter" href="#server-reporter">Automate via Infra Server</a> </li> <li class="tabs-title"> <a data-tabs-target="local-reporter" href="#local-reporter">File</a> </li> </ul> <div class="tabs-content" data-tabs-content="compliance-phase-reporter-panel"> <div class="tabs-panel is-active" id="automate-reporter">
<div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># Invoke the Compliance Phase</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'compliance_phase'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">true</span>
<span style="color:#60a0b0;font-style:italic"># Set profile location</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'profiles'</span><span style="color:#666">][</span><span style="color:#4070a0">'ssh'</span><span style="color:#666">]</span> <span style="color:#666">=</span> {
<span style="color:#4070a0">'supermarket'</span>: <span style="color:#4070a0">'hardening/ssh-hardening'</span>
}
<span style="color:#60a0b0;font-style:italic"># Fetch additional profiles</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'fetcher'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'chef-automate'</span>
<span style="color:#60a0b0;font-style:italic"># Set reporter</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'reporter'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'chef-automate'</span>
</code></pre></div> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> Reporting Compliance Phase results directly to Chef Automate requires setting <code>data_collector.server_url</code> and <code>data_collector.token</code> in your <code>client.rb</code> to fetch profiles from Chef Automate. This configuration is described in more detail in the Chef Automate <a href="../automate/data_collection/index.html">‘data collector documentation’</a>. </div> </div> </div> <div class="tabs-panel" id="server-reporter"><div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># Invoke the Compliance Phase</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'compliance_phase'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">true</span>
<span style="color:#60a0b0;font-style:italic"># Set profile location</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'profiles'</span><span style="color:#666">][</span><span style="color:#4070a0">'ssh'</span><span style="color:#666">]</span> <span style="color:#666">=</span> {
<span style="color:#4070a0">'supermarket'</span>: <span style="color:#4070a0">'hardening/ssh-hardening'</span>
}
<span style="color:#60a0b0;font-style:italic"># Fetch additional profiles</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'fetcher'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'chef-automate'</span>
<span style="color:#60a0b0;font-style:italic"># Set reporter</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'reporter'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'chef-server-automate'</span>
</code></pre></div></div> <div class="tabs-panel" id="local-reporter">
<div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># Invoke the Compliance Phase</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'compliance_phase'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">true</span>
<span style="color:#60a0b0;font-style:italic"># Set profile location</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'profiles'</span><span style="color:#666">][</span><span style="color:#4070a0">'ssh'</span><span style="color:#666">]</span> <span style="color:#666">=</span> {
<span style="color:#4070a0">'supermarket'</span>: <span style="color:#4070a0">'hardening/ssh-hardening'</span>
}
<span style="color:#60a0b0;font-style:italic"># Fetch additional profiles</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'fetcher'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'chef-automate'</span>
<span style="color:#60a0b0;font-style:italic"># Set two reporters</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'reporter'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'json-file'</span>, <span style="color:#4070a0">'cli'</span>
<span style="color:#60a0b0;font-style:italic"># Set the location of the json-file output</span>
<span style="color:#60a0b0;font-style:italic"># Note that the location attribute uses json_file</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'json_file'</span><span style="color:#666">][</span><span style="color:#4070a0">'location'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'/file/path/report.json'</span>
</code></pre></div>
<p>The default <code>json-file</code> path is: <code>&lt;chef_cache_path&gt;/compliance_reports/compliance-&lt;timestamp&gt;.json</code>.</p> <p>The path will also be output to the Chef Infra Client log:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#666">[</span><span style="color:#4070a0">'2017-08-29T00:22:10+00:00'</span><span style="color:#666">]</span> INFO: Reporting to json-file
<span style="color:#666">[</span><span style="color:#4070a0">'2017-08-29T00:22:10+00:00'</span><span style="color:#666">]</span> INFO: Writing report to /opt/kitchen/cache/compliance-reports/compliance-20170829002210.json
<span style="color:#666">[</span><span style="color:#4070a0">'2017-08-29T00:22:10+00:00'</span><span style="color:#666">]</span> INFO: Report handlers <span style="color:#007020">complete</span>
</code></pre></div>
</div> </div> <h2 id="customize-profiles">Customize Profiles</h2> <p>You can upload profiles to Chef Automate using the <a href="https://docs.chef.io/automate/api/#operation/Create">Chef Automate API</a> or the <code>inspec compliance</code> command.</p> <h3 id="waivers">Waivers</h3> <p>Use <a href="../inspec/waivers/index.html">‘waivers’</a> to mark individual failing controls as administratively accepted, either on a temporary or permanent basis.</p> <p>To use waivers:</p> <ol> <li>Prepare a YAML waiver file.</li> <li>Deliver the waiver file to the node in a <a href="../resources/cookbook_file/index.html">‘cookbook_file’</a> or <a href="../resources/remote_file/index.html">‘remote_file’</a>.</li> <li>Set the <code>waiver_file</code> attribute for the compliance phase to that location. For example:</li> </ol> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'waiver_file'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">"waivers.yaml"</span>
</code></pre></div>
<h3 id="external-data">External Data</h3> <p>InSpec profiles should be self-contained and independent from external data. In some cases, a profile’s test may exhibit different behavior depending on aspects of the node being tested and in these cases, you may want to use external data. Chef InSpec profiles accept <a href="../inspec/inputs/index.html">‘inputs’</a> that let you customize the test.</p> <h4 id="inspec-input">InSpec Input</h4> <p>You can pass <a href="../inspec/inputs/index.html">‘Chef InSpec inputs’</a> to the Chef InSpec runner. Chef InSpec inputs were previously called <code>attributes</code> and you will set them in an <code>['audit']['attributes']</code> hash in your attributes file. Any data added to <code>['audit']['attributes']</code> as a hash is passed to Chef InSpec as individual attributes.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'attributes'</span><span style="color:#666">]</span> <span style="color:#666">=</span> {
  <span style="color:#517918">first_input</span>: <span style="color:#4070a0">'some value'</span>,
  <span style="color:#517918">second_input</span>: <span style="color:#4070a0">'another value'</span>,
}
</code></pre></div>
<h4 id="chef-node-data">Chef Node Data</h4> <p>There are two primary ways to pass Chef Infra node data to Chef InSpec run during the compliance phase.</p> <h5 id="explicitly-pass-necessary-data-recommended">Explicitly pass necessary data (recommended)</h5> <p>Any data added to the <code>node['audit']['attributes']</code> hash will be passed as individual Chef InSpec attributes. This provides a clean interface between the Chef Infra client run and Chef InSpec profile, allowing for easy assignment of default values in the InSpec profile. This method is especially recommended if the Chef InSpec profile is expected to be used outside of the context of Compliance Phase so it’s made explicit to profile consumers what attributes are necessary. Set the attributes in your cookbook attributes file and then use them in your InSpec profile.</p> <p>Set the attributes in a cookbook attributes file:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">node<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'attributes'</span><span style="color:#666">]</span>{
  <span style="color:#4070a0">'key1'</span> <span style="color:#666">=</span> <span style="color:#4070a0">'value1'</span>,
  <span style="color:#4070a0">'debug_enabled'</span> <span style="color:#666">=</span> node<span style="color:#666">[</span><span style="color:#4070a0">'my_cookbook'</span><span style="color:#666">][</span><span style="color:#4070a0">'debug_enabled'</span><span style="color:#666">]</span>,
  <span style="color:#4070a0">'environment'</span> <span style="color:#666">=</span> node<span style="color:#666">.</span>chef_environment
}
</code></pre></div>
<p>Use the attributes in an InSpec profile:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">environment <span style="color:#666">=</span> attribute(<span style="color:#4070a0">'environment'</span>, <span style="color:#517918">description</span>: <span style="color:#4070a0">'The Chef Infra environment for the node'</span>, <span style="color:#517918">default</span>: <span style="color:#4070a0">'dev'</span>)

control <span style="color:#4070a0">'debug-disabled-in-production'</span> <span style="color:#007020;font-weight:700">do</span>
  title <span style="color:#4070a0">'Debug logs disabled in production'</span>
  desc <span style="color:#4070a0">'Debug logs contain potentially sensitive information and should not be on in production.'</span>
  impact <span style="color:#40a070">1</span><span style="color:#666">.</span><span style="color:#40a070">0</span>

  describe file(<span style="color:#4070a0">'/path/to/my/app/config'</span>) <span style="color:#007020;font-weight:700">do</span>
    its(<span style="color:#4070a0">'content'</span>) { should_not <span style="color:#007020">include</span> <span style="color:#4070a0">"debug=true"</span> }
  <span style="color:#007020;font-weight:700">end</span>

  only_if { environment <span style="color:#666">==</span> <span style="color:#4070a0">'production'</span> }
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h4 id="use-the-chef-infra-node-object">Use the Chef Infra Node Object</h4> <p>Compliance Phase can be configured to pass the Chef Infra node object as a Chef InSpec attribute named <code>chef_node</code>.</p> <p>While using the <code>chef_node</code> object provides the ability to write more flexible profiles, it is very difficult to reuse these profiles outside of the Compliance Phase. To reuse these profiles, you will need to understand how to pass in a single attribute containing Chef Infra-like data. We recommend passing external data explicitly whenever possible.</p> <p>To use this option, first enable it in a wrapper cookbook or similar:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">node<span style="color:#666">.</span>override<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'chef_node_attribute_enabled'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">true</span>
</code></pre></div>
<p>&amp;mldr; and then use it in your profile:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">chef_node <span style="color:#666">=</span> attribute(<span style="color:#4070a0">'chef_node'</span>, <span style="color:#517918">description</span>: <span style="color:#4070a0">'Chef Node'</span>)

control <span style="color:#4070a0">'no-password-auth-in-prod'</span> <span style="color:#007020;font-weight:700">do</span>
  title <span style="color:#4070a0">'No Password Authentication in Production'</span>
  desc <span style="color:#4070a0">'Password authentication is allowed in all environments except production'</span>
  impact <span style="color:#40a070">1</span><span style="color:#666">.</span><span style="color:#40a070">0</span>

  describe sshd_config <span style="color:#007020;font-weight:700">do</span>
    its(<span style="color:#4070a0">'PasswordAuthentication'</span>) { should cmp <span style="color:#4070a0">'No'</span> }
  <span style="color:#007020;font-weight:700">end</span>

  only_if { chef_node<span style="color:#666">[</span><span style="color:#4070a0">'chef_environment'</span><span style="color:#666">]</span> <span style="color:#666">==</span> <span style="color:#4070a0">'production'</span> }
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h2 id="useful-compliance-phase-attributes">Useful Compliance Phase Attributes</h2> <h3 id="audit-enforcer">audit-enforcer</h3> <p>A special reporter that causes the compliance run to raise an error and immediately terminates the Chef Infra Client run if any control of any Chef InSpec profile fails. If you specify multiple reporters, place the <code>audit-enforcer</code> at the end of the list, allowing the other reporters to generate their output prior to run termination. Example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># fail on error</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'reporter'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'audit-enforcer'</span><span style="color:#666">.</span>
</code></pre></div>
<h3 id="chef_node_attribute_enabled">chef_node_attribute_enabled</h3> <p>If enabled, a hash representation of the Chef Infra node object will be sent to an input named <code>chef_node</code>. Default: false</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># enable sending a hash representation of the Chef Infra node object</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'chef_node_attribute_enabled'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">true</span>
</code></pre></div>
<h3 id="compliance_phase">compliance_phase</h3> <p>Enable the built-in compliance phase run. Possible values: true, false, nil</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># Turn on Compliance Phase</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span>'</span>compliance_phase<span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">true</span>
</code></pre></div>
<h3 id="control_results_limit">control_results_limit</h3> <p>The list of results per control will be truncated to this amount to reduce the size of reports. A summary of removed results will be sent with each impacted control. Defaults to <code>50</code>.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># allow 100 results</span>
 default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'control_results_limit'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#40a070">100</span>
</code></pre></div>
<h3 id="fetcher">fetcher</h3> <p>Controls the location for additional profile locations for Chef InSpec profiles default fetch locations provided through the <code>[audit][profiles]</code> attribute. Accepted values: nil, ‘chef-server’, ‘chef-automate’.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># fetch additional profiles from Chef Server</span>
default<span style="color:#666">[</span>audit<span style="color:#666">][</span>fetcher<span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'chef-server'</span>
</code></pre></div>
<h3 id="insecure">insecure</h3> <p>Setting the attribute <code>default['audit']['insecure']</code> to <code>true</code> will skip SSL certificate verification for the <code>chef-automate</code> and <code>chef-server-automate</code> reporters. This allows connections to HTTPS endpoints with self-signed ssl certificates. Default is <code>false</code></p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># allow self-signed certificates</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'insecure'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">true</span>
</code></pre></div>
<h3 id="json_file">json_file</h3> <p>The location on disk that Chef InSpec’s json reports are saved to when using the ‘json-file’ reporter. Defaults to: <code>&lt;chef_cache_path&gt;/compliance_reports/compliance-&lt;timestamp&gt;.json</code></p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'reporter'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'json-file'</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'json_file'</span><span style="color:#666">][</span><span style="color:#4070a0">'location'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'/path/to/file.json'</span>
</code></pre></div>
<h3 id="inspec_backend_cache">inspec_backend_cache</h3> <p>Chef InSpec caches the results of commands executed on the node during the compliance phase. Caching improves the compliance phase performance when slower-running commands are executed multiple times during a Chef Infra Client run. Disable this feature if your Chef InSpec profile runs a command multiple times expecting different output during the run. Default: true. Example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># Disable caching of commands</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'inspec_backend_cache'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">false</span>
</code></pre></div>
<h3 id="profiles">profiles</h3> <p>Chef InSpec Compliance profiles to be used for scanning nodes.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># use the ssh-hardening profile from Supermarket</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'profiles'</span><span style="color:#666">][</span><span style="color:#4070a0">'ssh'</span><span style="color:#666">]</span> <span style="color:#666">=</span> {
  <span style="color:#4070a0">'supermarket'</span>: <span style="color:#4070a0">'hardening/ssh-hardening'</span>
  }
</code></pre></div>
<h3 id="quiet">quiet</h3> <p>Controls verbosity of the Chef InSpec runner. Defaults to <code>true</code>. To turn this off, set the attribute <code>default['audit']['quiet']</code> to <code>false</code>.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># verbose</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'quiet'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">false</span>
</code></pre></div>
<h3 id="reporter">reporter</h3> <p>Controls what is done with the resulting report after the Chef InSpec run. Accepts a single string value or an array of multiple values. The ‘cli’ reporter mimics the InSpec command line output in your terminal, which lets you see your system’s compliance status at the end of the Compliance Phase. Accepted values: ‘chef-server-automate’, ‘chef-automate’, ‘json-file’, ‘audit-enforcer’, ‘cli’</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># set the reporter to Chef Automate</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'reporter'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'chef-automate'</span>, <span style="color:#4070a0">'cli'</span>
</code></pre></div>
<h3 id="run_time_limit">run_time_limit</h3> <p>Control results that have a <code>run_time</code> below this limit will be stripped of the <code>start_time</code> and <code>run_time</code> fields to reduce the size of reports. Defaults to <code>1.0</code>. Set this attribute with <code>default['audit']['run_time_limit']</code>.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># allow 5 minutes run time</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'run_time_limit'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#40a070">5</span><span style="color:#666">.</span><span style="color:#40a070">0</span>
</code></pre></div>
<h3 id="result_include_backtrace">result_include_backtrace</h3> <p>When a Chef InSpec resource throws an exception, results contain a short error message and a detailed ruby stacktrace of the error. Default: false (does not send backtrace). Example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># include backtrace</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'result_include_backtrace'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">true</span>
</code></pre></div>
<h3 id="result_message_limit">result_message_limit</h3> <p>Truncates any control result messages exceeding this character limit. Chef Automate has a 4 MB report size limit and cannot ingest reports exceeding this limitation. Chef InSpec will append this text at the end of any truncated messages: <code>[Truncated to 10000 characters]</code> Default: 10000.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span>'</span>result_message_limit<span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#40a070">10000</span>
</code></pre></div>
<h3 id="server">server</h3> <p>When reporting to a Chef Automate instance proxied via Chef Infra Server, the Compliance Phase can be configured to use a different URL than the <code>chef_server_url</code> configured in <code>client.rb</code>. This is enabled with the attribute <code>default['audit']['server']</code>.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'server'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'https://server.4thcafe.com'</span><span style="color:#666">.</span>
</code></pre></div>
<h3 id="waiver_file">waiver_file</h3> <p>A string path or an array of paths to Chef InSpec waiver files.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'waiver_file'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'path/to/waiver.yml'</span><span style="color:#666">.</span>
</code></pre></div>
<h2 id="errors-and-troubleshooting">Errors and Troubleshooting</h2> <h3 id="cache-results">Cache Results</h3> <p>Chef InSpec caches the results of commands executed on the node during the compliance phase. Caching improves the compliance phase performance when slower-running commands are executed multiple times during a Chef Infra Client run. Disable this feature if your Chef InSpec profile runs a command multiple times expecting different output during the run. Default: true. Example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60a0b0;font-style:italic"># Disable caching of commands</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'inspec_backend_cache'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">false</span>
</code></pre></div>
<h3 id="chef-inspec-report-size-limits">Chef InSpec Report Size Limits</h3> <p>The size of the report being generated from running the Compliance Phase is influenced by a few factors like:</p> <ul> <li>number of controls and tests in a profile</li> <li>number of profile failures for the node</li> <li>controls metadata (title, description, tags, etc)</li> <li>number of resources (users, processes, etc) that are being tested</li> </ul> <p>Depending on your setup, there are some limits you need to be aware of. A common one is Chef Infra Server default (1MB) request size. Exceeding this limit will reject the report with <code>ERROR: 413 "Request Entity Too Large"</code>. For more details about these limits, please refer to <a href="#413-request-entity-too-large">‘the documentation on troubleshooting 413 errors’</a>.</p> <h3 id="http-errors">HTTP Errors</h3> <h4 id="401-403-unauthorized---bad-clock">401, 403 Unauthorized - bad clock</h4> <p>Occasionally, the system date/time will drift between client and server. If this drift is greater than a couple of minutes, the Chef Infra Server will throw a 401 unauthorized and the request will not be forwarded to the Chef Automate server.</p> <p>On the Chef Infra Server you can see this in the following logs:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text"># chef-server-ctl tail

==&gt; /var/log/opscode/nginx/access.log &lt;==
192.168.200.102 - - ['28/Aug/2016:14:57:36 +0000']  "GET /organizations/4thcafe/nodes/vagrant-c0971990 HTTP/1.1" 401 "0.004" 93 "-" "Chef Client/12.14.38 (ruby-2.3.1-p112; ohai-8.19.2; x86_64-linux; +https://chef.io)" "127.0.0.1:8000" "401" "0.003" "12.14.38" "algorithm=sha1;version=1.1;" "vagrant-c0971990" "2013-09-25T15:00:14Z" "2jmj7l5rSw0yVb/vlWAYkK/YBwk=" 1060

==&gt; /var/log/opscode/opscode-erchef/crash.log &lt;==
2016-08-28 14:57:36 =ERROR REPORT====
{&lt;&lt;"method=GET; path=/organizations/4thcafe/nodes/vagrant-c0971990; status=401; "&gt;&gt;,"Unauthorized"}

==&gt; /var/log/opscode/opscode-erchef/erchef.log &lt;==
2016-08-28 14:57:36.521 ['error'] {&lt;&lt;"method=GET; path=/organizations/4thcafe/nodes/vagrant-c0971990; status=401; "&gt;&gt;,"Unauthorized"}

==&gt; /var/log/opscode/opscode-erchef/current &lt;==
2016-08-28_14:57:36.52659 ['error'] {&lt;&lt;"method=GET; path=/organizations/4thcafe/nodes/vagrant-c0971990; status=401; "&gt;&gt;,"Unauthorized"}

==&gt; /var/log/opscode/opscode-erchef/requests.log.1 &lt;==
2016-08-28T14:57:36Z erchef@127.0.0.1 method=GET; path=/organizations/4thcafe/nodes/vagrant-c0971990; status=401; req_id=g3IAA2QAEGVyY2hlZkAxMjcuMC4wLjEBAAOFrgAAAAAAAAAA; org_name=4thcafe; msg=bad_clock; couchdb_groups=false; couchdb_organizations=false; couchdb_containers=false; couchdb_acls=false; 503_mode=false; couchdb_associations=false; couchdb_association_requests=false; req_time=1; user=vagrant-c0971990; req_api_version=1;
</code></pre></div>
<p>Additionally, the chef_gate log will contain a similar message:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text"># /var/log/opscode/chef_gate/current
2016-08-28_15:01:34.88702 ['GIN'] 2016/08/28 - 15:01:34 | 401 |   13.650403ms | 192.168.200.102 |   POST    /compliance/organizations/4thcafe/inspec
2016-08-28_15:01:34.88704 Error #01: Authentication failed. Please check your system's clock.
</code></pre></div>
<h4 id="401-token-and-refresh-token-authentication">401 Token and Refresh Token Authentication</h4> <p>In the event of a malformed or unset token, the Chef Automate server will log the token error:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text">==&gt; /var/log/chef-compliance/core/current &lt;==
2016-08-28_20:41:46.17496 20:41:46.174 ERR =&gt; Token authentication: %!(EXTRA *errors.errorString=malformed JWS, only 1 segments)
2016-08-28_20:41:46.17498 ['GIN'] 2016/08/28 - 20:41:46 | 401 |      53.824us | 192.168.200.102 |   GET     /owners/base/compliance/linux/tar

==&gt; /var/log/chef-compliance/nginx/compliance.access.log &lt;==
192.168.200.102 - - ['28/Aug/2016:21:23:46 +0000'] "GET /api/owners/base/compliance/linux/tar HTTP/1.1" 401 0 "-" "Ruby"
</code></pre></div>
<h4 id="413-request-entity-too-large">413 Request Entity Too Large</h4> <p>This error indicates that you have exceeded limit the <code>erchef</code> request size in Chef Infra Server. The default for versions before 13.0 was 1MB. Starting with version 13.0 the default is 2MB.</p> <p>To resolve this error, set the <code>opscode_erchef['max_request_size']</code> in Chef Infra Server’s <code>/etc/opscode/chef-server.rb</code> to a larger amount. This example sets the limit to 3MB:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">opscode_erchef<span style="color:#666">[</span><span style="color:#4070a0">'max_request_size'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#40a070">3000000</span>
</code></pre></div>
<p>Then run <code>chef-server-ctl reconfigure</code> to apply this change.</p> <h5 id="413-error-logs">413 Error Logs</h5> <p>The 413 “Request Entity Too Large” error appears in both the stacktrace and the Chef Infra Server Nginx logs.</p> 
<ul class="tabs" data-tabs id="compliance-413-panel"> <li class="tabs-title is-active"> <a href="#413-stacktrace" aria-selected="true">Stacktrace</a> </li> <li class="tabs-title"> <a data-tabs-target="413-server-nginx" href="#413-server-nginx">Nginx logs</a> </li> </ul> <div class="tabs-content" data-tabs-content="compliance-413-panel"> <div class="tabs-panel is-active" id="413-stacktrace">
<p>The stacktrace shows the 413 error:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text">Running handlers:
['2017-12-21T16:21:15+00:00'] WARN: Compliance report size is 1.71 MB.
['2017-12-21T16:21:15+00:00'] ERROR: 413 "Request Entity Too Large" (Net::HTTPServerException)
/opt/chef/embedded/lib/ruby/2.4.0/net/http/response.rb:122:in `error!'
/opt/chef/embedded/lib/ruby/gems/2.4.0/gems/chef-13.6.4/lib/chef/http.rb:152:in `request'
/opt/chef/embedded/lib/ruby/gems/2.4.0/gems/chef-13.6.4/lib/chef/http.rb:131:in `post'
/var/chef/cache/cookbooks/audit/libraries/reporters/cs_automate.rb:37:in `block in send_report'
...
</code></pre></div>
</div> <div class="tabs-panel" id="413-server-nginx">
<p>The Chef Infra Server Nginx log confirms the <code>413</code> error:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text">==&gt; /var/log/opscode/nginx/access.log &lt;==
192.168.56.40 - - ['21/Dec/2017:11:35:30 +0000']  "POST /organizations/eu_org/data-collector HTTP/1.1" 413 "0.803" 64 "-" "Chef Client/13.6.4 (ruby-2.4.2-p198; ohai-13.6.0; x86_64-linux; +https://chef.io)" "-" "-" "-" "13.6.4" "algorithm=sha1;version=1.1;" "bootstrapped-node" "2017-12-21T11:35:31Z" "GR6RyPvKkZDaGyQDYCPfoQGS8G4=" 1793064
</code></pre></div>
</div> </div> <h2 id="chef-automate-backend-errors">Chef Automate Backend Errors</h2> <p>Chef Automate sets the <code>logstash</code> limit to 10% of the system memory automatically as part of the <code>automate-ctl reconfigure</code> command execution. You have reached the java heap size(<code>-Xmx</code>) limit of <code>logstash</code> if a Chef InSpec report does not become available in Chef Automate and this error is in the <code>logstash</code> logs:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text">/var/log/delivery/logstash/current
2017-12-21_13:59:54.69949 DEBUG: Ruby filter is processing an 'inspec_profile' event
2017-12-21_14:00:16.51553 java.lang.OutOfMemoryError: Java heap space
2017-12-21_14:00:16.51556 Dumping heap to /opt/delivery/embedded/logstash/heapdump.hprof ...
2017-12-21_14:00:16.51556 Unable to create /opt/delivery/embedded/logstash/heapdump.hprof: File exists
2017-12-21_14:00:18.50676 Error: Your application used more memory than the safety cap of 383M.
2017-12-21_14:00:18.50694 Specify -J-Xmx####m to increase it (#### = cap size in MB).
2017-12-21_14:00:18.50703 Specify -w for full OutOfMemoryError stack trace
</code></pre></div> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/chef_compliance_phase/" class="_attribution-link">https://docs.chef.io/chef_compliance_phase/</a>
  </p>
</div>
