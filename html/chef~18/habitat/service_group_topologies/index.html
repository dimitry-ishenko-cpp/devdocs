<div id="col-content" data-swiftype-index="true"> <div id="service-group-topologies"><h1>Service Group Topologies</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/habitat-sh/habitat/tree/main/components/docs-chef-io/content/habitat/service_group_topologies.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>A topology describes the intended relationship between peers within a service group. Two topologies ship with Chef Habitat by default: <strong>standalone</strong> and <strong>leader-follower</strong>. The leader-follower topology employs <a href="../sup_crypto/index.html">leader election</a> to define a leader.</p> <h2 id="standalone">Standalone</h2> <p>The standalone topology is what a Supervisor starts with by default if no topology is specified, or if the topology is explicitly specified with <code>--topology standalone</code> when starting the Supervisor. The standalone topology means that the service group members do not have any defined relationship with one another, other than sharing the same configuration.</p> <h2 id="leader-follower-topology">Leader-follower Topology</h2> <p>In a leader-follower topology, one of the members of the service group is elected the leader, and the other members of that service group become the followers of that leader. This topology is common for database systems like MySQL or PostgreSQL, where applications send writes to one member, and those writes are replicated to one or more read replicas.</p> <p>As with any topology using leader election, you must start at least three peers using the <code>--topology leader</code> flag to the Supervisor.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">hab sup run --topology leader --group production
hab svc load &lt;ORIGIN&gt;/&lt;NAME&gt;
</code></pre></div>
<p>The first Supervisor will block until it has quorum. You would start additional members by pointing them at the ring, using the <code>--peer</code> argument:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">hab sup run --topology leader --group production --peer 192.168.5.4
hab svc load &lt;ORIGIN&gt;/&lt;NAME&gt;
</code></pre></div>
<div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> The <code>--peer</code> service does not need a peer that is in the same service group; it merely needs to be in the same ring with the other member(s). </div> </div> <p>Once you have quorum, one member is elected a leader, the Supervisors in the service group update the service’s configuration in concordance with the policy defined at package build time, and the service group starts up.</p> <h3 id="defining-leader-and-follower-behavior-in-plans">Defining Leader and Follower Behavior in Plans</h3> <p>Chef Habitat allows you to use the same immutable package in different deployment scenarios. In this example, a configuration template with conditional logic will make the running application to behave differently based on whether it is a leader or a follower:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-handlebars" data-lang="handlebars"><span style="color:#007020">{{</span><span style="color:#007020;font-weight:700">#if</span> <span style="color:#bb60d5">svc.me.follower</span><span style="color:#007020">}}</span>
   <span style="color:#007020">{{</span><span style="color:#007020;font-weight:700">#with</span> <span style="color:#bb60d5">svc.leader</span> <span style="color:#bb60d5">as</span> <span>|</span><span style="color:#bb60d5">leader</span><span>|</span><span style="color:#007020">}}</span>
     replicaof <span style="color:#007020">{{</span><span style="color:#bb60d5">leader.sys.ip</span><span style="color:#007020">}}</span> <span style="color:#007020">{{</span><span style="color:#bb60d5">leader.cfg.port</span><span style="color:#007020">}}</span>
   <span style="color:#007020">{{</span><span style="color:#007020;font-weight:700">/with</span><span style="color:#007020">}}</span>
<span style="color:#007020">{{</span><span style="color:#007020;font-weight:700">/if</span><span style="color:#007020">}}</span>
</code></pre></div>
<p>This logic says that if this peer is a follower, it will become a read replica of the IP and port of service leader (<code>svc.leader</code>), which is found by service discovery through the ring. However, if this peer is the leader, the entire list of statements here evaluate to empty text – meaning that the peer starts up as the leader.</p> <h2 id="robustness-network-boundaries-and-recovering-from-partitions">Robustness, Network Boundaries and Recovering from Partitions</h2> <p>Within a leader-follower topology, it is possible to get into a partitioned state where nodes are unable to achieve quorum. To solve this, use a permanent peer to heal the netsplit. Pass the <code>--permanent-peer</code> option, or it’s short form <code>-I</code>, to make a Supervisor act as a permanent peer.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">hab sup run --topology leader --group production --permanent-peer
hab svc load &lt;ORIGIN&gt;/&lt;NAME&gt;
</code></pre></div>
<p>When a Supervisor is instructed to act as a permanent peer, the other Supervisors will attempt to connect with the permanent peer and achieve quorum even if the permanent peer is confirmed to be dead.</p> <p>The notion of a permanent peer is an extension to the original <a href="http://www.cs.cornell.edu/projects/Quicksilver/public_pdfs/SWIM.pdf">SWIM</a> gossip protocol. It can add robustness provided everyone has a permanent member on both sides of the split.</p> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/habitat/service_group_topologies/" class="_attribution-link">https://docs.chef.io/habitat/service_group_topologies/</a>
  </p>
</div>
