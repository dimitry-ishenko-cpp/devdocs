<div id="col-content" data-swiftype-index="true"> <div id="kubernetes"><h1>Kubernetes</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/habitat-sh/habitat/tree/main/components/docs-chef-io/content/habitat/kubernetes.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p><a href="https://kubernetes.io/">Kubernetes</a> is an open source container cluster manager that is available as a stand-alone platform or embedded in several distributed platforms including <a href="https://cloud.google.com/container-engine/">Google’s Container Engine</a>, <a href="https://aws.amazon.com/eks/">AWS Elastic Kubernetes Service</a>, <a href="https://azure.microsoft.com/services/kubernetes-service/">Azure Kubernetes Service</a>, and <a href="https://openshift.com/">Red Hat OpenShift</a>. Chef Habitat and Kubernetes are complementary. While Kubernetes provides a platform for deployment, scaling, and operations of application containers across clusters of hosts, Chef Habitat manages the build pipeline and lifecycle of those application containers.</p> <h2 id="chef-habitat-on-kubernetes">Chef Habitat on Kubernetes</h2> <p>Chef Habitat can export your package as a Docker container that runs on Kubernetes in the form of a pod. Additionally, a Chef Habitat bastion pod provides essential gossip ring features like service discovery (binds), secrets and the required <a href="../sup_networks/index.html">initial peer</a> to all other pods.</p> <p>Chef Habitat robustly deploys the bastion pod with a Kubernetes stateful set, persistent volume, and liveness checking, which ensures node availability and ring data persistence. The Kubernetes stateful set comes with an attached Kubernetes service that makes discoverable with DNS. Each namespace should contain a single service and stateful set.</p> <h2 id="deploy-the-chef-habitat-bastion-on-kubernetes">Deploy the Chef Habitat Bastion on Kubernetes</h2> <p>Complete examples may be downloaded from <a href="../pattern_library/index.html#kubernetes-bastion-ring-pattern">this folder</a></p> <p>To explain how this works, let’s break down the hab-bastion.yaml file:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">apiVersion</span>:v1<span style="color:#062873;font-weight:700">kind</span>:Service<span style="color:#062873;font-weight:700">metadata</span>:<span style="color:#062873;font-weight:700">name</span>:hab-bastion<span style="color:#062873;font-weight:700">spec</span>:<span style="color:#062873;font-weight:700">ports</span>:- <span style="color:#062873;font-weight:700">name</span>:gossip-listener<span style="color:#062873;font-weight:700">protocol</span>:UDP<span style="color:#062873;font-weight:700">port</span>:<span style="color:#40a070">9638</span><span style="color:#062873;font-weight:700">targetPort</span>:<span style="color:#40a070">9638</span>- <span style="color:#062873;font-weight:700">name</span>:http-gateway<span style="color:#062873;font-weight:700">protocol</span>:TCP<span style="color:#062873;font-weight:700">port</span>:<span style="color:#40a070">9631</span><span style="color:#062873;font-weight:700">targetPort</span>:<span style="color:#40a070">9631</span><span style="color:#062873;font-weight:700">selector</span>:<span style="color:#062873;font-weight:700">app</span>:hab-bastion<span style="color:#062873;font-weight:700">clusterIP</span>:None</code></pre></div>
<p>This service definition creates a virtual IP (VIP), opening access to the Chef Habitat service that runs on the pod.</p> <ul> <li>The habitat gossip port (9638/UDP) listener</li> <li>The habitat http-gateway (9631/TCP) listener</li> <li>makes service name available in DNS (as <code>hab-bastion</code> or <code>hab-bastion.namespace-name</code>, etc) and discoverable by any pod</li> </ul> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">apiVersion</span>:apps/v1<span style="color:#062873;font-weight:700">kind</span>:StatefulSet<span style="color:#062873;font-weight:700">metadata</span>:<span style="color:#062873;font-weight:700">name</span>:hab-bastion<span style="color:#062873;font-weight:700">spec</span>:<span style="color:#062873;font-weight:700">spec</span>:<span style="color:#062873;font-weight:700">securityContext</span>:<span style="color:#062873;font-weight:700">fsGroup</span>:<span style="color:#40a070">42</span></code></pre></div>
<p>This section sets the group ownership for the persistent volume mount point so the Habitat Supervisor can write to it. The Habitat user (<code>hab</code>) by default has the uid <code>42</code> and the gid <code>42</code>.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">containers</span>:- <span style="color:#062873;font-weight:700">name</span>:hab-bastion<span style="color:#062873;font-weight:700">image</span>:mydockerorigin/hab_bastion:latest<span style="color:#062873;font-weight:700">args</span>:- <span style="color:#4070a0">'--permanent-peer'</span></code></pre></div>
<p>The <code>image:</code> line defines the source of the docker container. In this case, the instructions create an image from a Chef Habitat plan using the <code>hab pkg export docker</code> command. It only runs the Chef Habitat Supervisor (hab-sup) service. The argument <code>--permanent-peer</code> instructs the Supervisor to act as a permanent peer.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">resources</span>:<span style="color:#062873;font-weight:700">requests</span>:<span style="color:#062873;font-weight:700">memory</span>:<span style="color:#4070a0">"100Mi"</span><span style="color:#062873;font-weight:700">cpu</span>:<span style="color:#4070a0">"100m"</span><span style="color:#60a0b0;font-style:italic"># equivalent to 0.1 of a CPU core</span></code></pre></div>
<p>Resource requests are important because they give instructions to the Kubernetes scheduler–without them, you might overload some nodes while under-using others.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">ports</span>:- <span style="color:#062873;font-weight:700">name</span>:gossip-listener<span style="color:#062873;font-weight:700">protocol</span>:UDP<span style="color:#062873;font-weight:700">containerPort</span>:<span style="color:#40a070">9638</span>- <span style="color:#062873;font-weight:700">name</span>:http-gateway<span style="color:#062873;font-weight:700">protocol</span>:TCP<span style="color:#062873;font-weight:700">containerPort</span>:<span style="color:#40a070">9631</span><span style="color:#062873;font-weight:700">readinessProbe</span>:<span style="color:#062873;font-weight:700">httpGet</span>:<span style="color:#062873;font-weight:700">path</span>:/<span style="color:#062873;font-weight:700">port</span>:<span style="color:#40a070">9631</span><span style="color:#062873;font-weight:700">initialDelaySeconds</span>:<span style="color:#40a070">5</span><span style="color:#062873;font-weight:700">periodSeconds</span>:<span style="color:#40a070">10</span><span style="color:#062873;font-weight:700">livenessProbe</span>:<span style="color:#062873;font-weight:700">httpGet</span>:<span style="color:#062873;font-weight:700">path</span>:/<span style="color:#062873;font-weight:700">port</span>:<span style="color:#40a070">9631</span><span style="color:#062873;font-weight:700">initialDelaySeconds</span>:<span style="color:#40a070">15</span><span style="color:#062873;font-weight:700">periodSeconds</span>:<span style="color:#40a070">20</span></code></pre></div>
<p>The <code>livenessProbe</code> tells Kubernetes if the pod is healthy or not. If not, the pod gets restarted. The <code>readinessProbe</code> signals to Kubernetes that the pod has started up successfully.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">volumeMounts</span>:- <span style="color:#062873;font-weight:700">name</span>:hab-bastion<span style="color:#062873;font-weight:700">mountPath</span>:/hab/sup<span style="color:#062873;font-weight:700">volumeClaimTemplates</span>:- <span style="color:#062873;font-weight:700">metadata</span>:<span style="color:#062873;font-weight:700">name</span>:hab-bastion<span style="color:#062873;font-weight:700">spec</span>:<span style="color:#062873;font-weight:700">accessModes</span>:[<span style="color:#4070a0">"ReadWriteOnce"</span>]<span style="color:#60a0b0;font-style:italic"># uncomment if you don't have a default StorageClass</span><span style="color:#60a0b0;font-style:italic"># storageClassName: "standard"</span><span style="color:#062873;font-weight:700">resources</span>:<span style="color:#062873;font-weight:700">requests</span>:<span style="color:#062873;font-weight:700">storage</span>:10Gi</code></pre></div>
<p>All of the Habitat Supervisor’s state data is stored under <code>/hab/sup</code> - we mount this on a persistent volume so it gets re-attached if the pod is ever rescheduled. The data persists!</p> <h2 id="create-a-kubernetes-deployment-that-works-with-the-bastion">Create a Kubernetes Deployment That Works with the Bastion</h2> <p>The following is an example of a Kubernetes <code>Stateful Set</code> built from the CockroachDB plan. The Bastion pattern uses the <code>--peer hab-bastion</code> configuration arguments to instruct the Kubernetes pods to use the <code>hab-bastion</code> service as a DNS-resolvable host name.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml">+++<span style="color:#062873;font-weight:700">apiVersion</span>:apps/v1<span style="color:#062873;font-weight:700">kind</span>:StatefulSet<span style="color:#062873;font-weight:700">metadata</span>:<span style="color:#062873;font-weight:700">name</span>:cockroachdb<span style="color:#062873;font-weight:700">spec</span>:<span style="color:#062873;font-weight:700">selector</span>:<span style="color:#062873;font-weight:700">matchLabels</span>:<span style="color:#062873;font-weight:700">app</span>:cockroachdb<span style="color:#062873;font-weight:700">serviceName</span>:cockroachdb<span style="color:#062873;font-weight:700">replicas</span>:<span style="color:#40a070">3</span><span style="color:#062873;font-weight:700">template</span>:<span style="color:#062873;font-weight:700">metadata</span>:<span style="color:#062873;font-weight:700">labels</span>:<span style="color:#062873;font-weight:700">app</span>:cockroachdb<span style="color:#062873;font-weight:700">spec</span>:<span style="color:#062873;font-weight:700">terminationGracePeriodSeconds</span>:<span style="color:#40a070">10</span><span style="color:#062873;font-weight:700">securityContext</span>:<span style="color:#062873;font-weight:700">fsGroup</span>:<span style="color:#40a070">42</span><span style="color:#062873;font-weight:700">containers</span>:- <span style="color:#062873;font-weight:700">name</span>:cockroachdb<span style="color:#062873;font-weight:700">image</span>:irvingpop/cockroach:latest<span style="color:#062873;font-weight:700">args</span>:- --peer- hab-bastion- --topology- leader<span style="color:#062873;font-weight:700">resources</span>:<span style="color:#062873;font-weight:700">requests</span>:<span style="color:#062873;font-weight:700">memory</span>:<span style="color:#4070a0">"300Mi"</span><span style="color:#062873;font-weight:700">cpu</span>:<span style="color:#4070a0">"500m"</span><span style="color:#062873;font-weight:700">ports</span>:- <span style="color:#062873;font-weight:700">name</span>:http<span style="color:#062873;font-weight:700">containerPort</span>:<span style="color:#40a070">8080</span>- <span style="color:#062873;font-weight:700">name</span>:cockroachdb<span style="color:#062873;font-weight:700">containerPort</span>:<span style="color:#40a070">26257</span><span style="color:#062873;font-weight:700">volumeMounts</span>:- <span style="color:#062873;font-weight:700">name</span>:cockroachdb-data<span style="color:#062873;font-weight:700">mountPath</span>:/hab/svc/cockroach/data<span style="color:#062873;font-weight:700">volumeClaimTemplates</span>:- <span style="color:#062873;font-weight:700">metadata</span>:<span style="color:#062873;font-weight:700">name</span>:cockroachdb-data<span style="color:#062873;font-weight:700">spec</span>:<span style="color:#062873;font-weight:700">accessModes</span>:[<span style="color:#4070a0">"ReadWriteOnce"</span>]<span style="color:#062873;font-weight:700">resources</span>:<span style="color:#062873;font-weight:700">requests</span>:<span style="color:#062873;font-weight:700">storage</span>:10Gi</code></pre></div>
<h2 id="bare-kubernetes">Bare Kubernetes</h2> <p>If your packages don’t require communication with the Chef Habitat Supervisor ring, such as binds, secrets, etc., then you can execute your packages directly on the cluster. You can deploy Chef Habitat packages exported as containers to Kubernetes with the <a href="http://kubernetes.io/docs/user-guide/pods/single-container/"><code>kubectl</code> command</a>. Using the <a href="../pkg_exports/index.html#exporting-to-docker">Docker exporter</a> to create a containerized application, you can launch the container like this example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">$ kubectl run mytutorial --image<span style="color:#666">=</span>myorigin/mytutorial --port<span style="color:#666">=</span><span style="color:#40a070">8080</span>
</code></pre></div>
<p>Assuming you’re using the Docker image pulled from <code>myorigin/mytutorial</code>, port 8080 on the container should be accessible. Pass networking ports exposed by Chef Habitat with <code>kubectl run</code> as <code>--port</code> options. In this example, the <code>kubectl get</code> command is:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">$ kubectl get pods -l <span style="color:#bb60d5">run</span><span style="color:#666">=</span>mytutorial
</code></pre></div>
<h2 id="docker-and-aci">Docker and ACI</h2> <p>Chef Habitat packages can be exported in both Docker and ACI formats (as well as others). Kubernetes currently supports the Docker runtime and integration of the rkt container runtime (an implementation of the App Container spec) is under active development.</p> <h2 id="environment-variables-and-networking">Environment Variables and Networking</h2> <p>Kubernetes supports passing <a href="https://kubernetes.io/docs/user-guide/environment-guide/">environment variables</a> into containers.</p> <h2 id="related-reading">Related Reading</h2> <ul> <li><a href="../pkg_exports/index.html">Export a Chef Habitat package</a></li> <li><a href="../habitat_cli/index.html">Chef Habitat CLI</a></li> </ul> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/habitat/kubernetes/" class="_attribution-link">https://docs.chef.io/habitat/kubernetes/</a>
  </p>
</div>
