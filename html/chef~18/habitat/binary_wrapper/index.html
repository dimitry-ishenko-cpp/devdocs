<div id="col-content" data-swiftype-index="true"> <div id="binary-wrapper-packages"><h1>Binary Wrapper Packages</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/habitat-sh/habitat/tree/main/components/docs-chef-io/content/habitat/binary_wrapper.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>While Chef Habitat provides the best behavior for applications that can be compiled from source into the Chef Habitat ecosystem, it can also bring the same management benefits to applications distributed in binary-only form.</p> <p>You can write plans to package up these binary artifacts with minimal special handling. This article covers some tips and tricks for getting this software into Chef Habitat.</p> <h2 id="override-the-build-phases-you-dont-need">Override The Build Phases You Don’t Need</h2> <p>A Chef Habitat package build proceeds in phases: download, verification, unpacking (where you would also patch source code, if you had it), build, and finally installation. Each of these phases has <a href="../build_phase_callbacks/index.html">default behavior</a> within the build system.</p> <p>When building binary packages, you override the behavior of phases that do not apply to you. At the very minimum, you must override the <code>do_build</code> and <code>do_install</code> phases, for example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#666">(</span>...<span style="color:#666">)</span>
do_build<span style="color:#666">()</span> <span style="color:#666">{</span>
  <span style="color:#60a0b0;font-style:italic"># relocate library dependencies here, if needed -- see next topic</span>
  <span style="color:#007020;font-weight:700">return</span> <span style="color:#40a070">0</span>
<span style="color:#666">}</span>

do_install<span style="color:#666">()</span> <span style="color:#666">{</span>
  mkdir -p <span style="color:#bb60d5">$pkg_prefix</span>/bin
  cp <span style="color:#bb60d5">$PLAN_CONTEXT</span>/bin/hello_world <span style="color:#bb60d5">$pkg_prefix</span>/bin/hello_world
  chmod +x <span style="color:#bb60d5">$pkg_prefix</span>/bin/hello_world
<span style="color:#666">}</span>
</code></pre></div>
<h2 id="relocate-hard-coded-library-dependencies-if-possible">Relocate Hard-Coded Library Dependencies If Possible</h2> <p>On Linux, many binaries hardcode library dependencies to <code>/lib</code> or <code>/lib64</code> inside their ELF symbol table. Unfortunately, this means that Chef Habitat is unable to provide dependency isolation guarantees if packages are dependent on any operating system’s libraries in those directories. These Chef Habitat packages will also fail to run in minimal environments like containers built using <code>hab-pkg-export-docker</code>, because there will not be a <code>glibc</code> inside <code>/lib</code> or <code>/lib64</code>.</p> <blockquote> <p>Note: On Windows, library dependency locations are not maintained in a binary file’s headers. See <a href="https://msdn.microsoft.com/library/windows/desktop/ms682586(v=vs.85).aspx">this MSDN article</a> for a complete explanation of how Windows binaries are located. However, it’s typically sufficient to ensure that the dependent binaries are on the <code>PATH</code>. You should make sure to include all dependencies in the <code>pkg_deps</code> of a <code>plan.ps1</code> to ensure all of their respective <code>DLL</code>s are accessible by your application.</p> </blockquote> <p>Most binaries compiled in a full Linux environment have a hard dependency on <code>/lib/ld-linux.so</code> or <code>/lib/ld-linux-x86_64.so</code>. In order to relocate this dependency to the Chef Habitat-provided variant, which is provided by <code>core/glibc</code>, use the <code>patchelf(1)</code> utility within your plan:</p> <ol> <li>Declare a build-time dependency on <code>core/patchelf</code> as part of your <code>pkg_build_deps</code> line.</li> <li>Invoke <code>patchelf</code> on any binaries with this problem during the <code>do_install()</code> phase. For example:</li> </ol> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">patchelf --interpreter <span style="color:#4070a0">"</span><span style="color:#007020;font-weight:700">$(</span>pkg_path_for core/glibc<span style="color:#007020;font-weight:700">)</span><span style="color:#4070a0">/lib/ld-linux-x86-64.so.2"</span> <span style="color:#4070a0;font-weight:700">\
</span>  <span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">${</span><span style="color:#bb60d5">pkg_prefix</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">/bin/somebinary"</span>
</code></pre></div>
<ol start="3"> <li>The binary may have other hardcoded dependencies on its own libraries that you may need to relocate using other flags to <code>patchelf</code> like <code>--rpath</code>. For example, Oracle Java provides additional libraries in <code>lib/amd64/jli</code> that you will need to relocate to the Chef Habitat location:</li> </ol> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#007020">export</span> <span style="color:#bb60d5">LD_RUN_PATH</span><span style="color:#666">=</span><span style="color:#bb60d5">$LD_RUN_PATH</span>:<span style="color:#bb60d5">$pkg_prefix</span>/lib/amd64/jli
patchelf --interpreter <span style="color:#4070a0">"</span><span style="color:#007020;font-weight:700">$(</span>pkg_path_for core/glibc<span style="color:#007020;font-weight:700">)</span><span style="color:#4070a0">/lib/ld-linux-x86-64.so.2"</span> <span style="color:#4070a0;font-weight:700">\
</span>  --set-rpath <span style="color:#70a0d0;font-style:italic">${</span><span style="color:#bb60d5">LD_RUN_PATH</span><span style="color:#70a0d0;font-style:italic">}</span> <span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">${</span><span style="color:#bb60d5">pkg_prefix</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">/bin/java"</span>
</code></pre></div>
<ol start="4"> <li>For more information, please see the <a href="https://nixos.org/patchelf.html">patchelf</a> documentation.</li> </ol> <h2 id="relocating-library-dependencies">Relocating library dependencies</h2> <p>In some situations it will be impossible for you to relocate library dependencies using <code>patchelf</code> as above. For example, if the version of <code>glibc</code> the software requires is different than that provided by an available version of <code>glibc</code> in a Chef Habitat package, attempting to <code>patchelf</code> the program will cause execution to fail due to ABI incompatibility.</p> <p>Your software vendor’s support policy might also prohibit you from modifying software that they ship you.</p> <p>In these situations, you will have to give up Chef Habitat’s guarantees of complete dependency isolation and continue to rely on the library dependencies provided by the host operating system. However, you can continue to use the features of the Chef Habitat Supervisor that provide uniform manageability across your entire fleet of applications.</p> <h2 id="fixing-hardcoded-interpreters">Fixing hardcoded interpreters</h2> <p>Binary packages often come with other utility scripts that have their interpreter, or “shebang”, line (first line of a script) hardcoded to a path that will not exist under Chef Habitat. Examples are: <code>#!/bin/sh</code>, <code>#!/bin/bash</code>, <code>#!/bin/env</code> or <code>#!/usr/bin/perl</code>. It is necessary to modify these to point to the Chef Habitat-provided versions, and also declare a runtime dependency in your plan on the corresponding Chef Habitat package (for example, <code>core/perl</code>).</p> <p>Use the <code>fix_interpreter</code> function within your plan to correct these interpreter lines during any phase, but most likely your <code>do_build</code> phase. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">fix_interpreter <span style="color:#70a0d0;font-style:italic">${</span><span style="color:#bb60d5">target</span><span style="color:#70a0d0;font-style:italic">}</span> core/coreutils bin/env
</code></pre></div>
<p>The arguments to <code>fix_interpreter</code> are the file (represented here by <code>${target}</code>) you are trying to fix, the origin/name pair of the Chef Habitat package that provides that interpreter, and the interpreter pattern to search and replace in the target.</p> <p>If you have many files you need to fix, or the binary package automatically generates scripts with hardcoded shebang lines, you may need to simply symlink Chef Habitat’s version into where the binary package expects it to go:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">ln -sv <span style="color:#007020;font-weight:700">$(</span>pkg_path_for coreutils<span style="color:#007020;font-weight:700">)</span>/bin/env /usr/bin/env
</code></pre></div>
<p>This is a last resort as it breaks the dependency isolation guarantees of Chef Habitat.</p> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/habitat/binary_wrapper/" class="_attribution-link">https://docs.chef.io/habitat/binary_wrapper/</a>
  </p>
</div>
