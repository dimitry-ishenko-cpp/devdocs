<div id="col-content" data-swiftype-index="true"> <div id="single-service-updates"><h1>Single Service Updates</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/habitat-sh/habitat/tree/main/components/docs-chef-io/content/habitat/service_updates.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>One of the key features of Chef Habitat is the ability to define an immutable package with a default configuration which can then be updated dynamically at runtime. You can update service configuration on two levels: individual services (for testing purposes), or a service group.</p> <h2 id="apply-configuration-updates-to-an-individual-service">Apply Configuration Updates to an Individual Service</h2> <p>When starting a single service, you can provide alternate configuration values to those specified in <code>default.toml</code>.</p> <h3 id="using-a-_usertoml_-file">Using a <em>user.toml</em> File</h3> <p>You can supply a <code>user.toml</code> containing any configuration data that you want to override default values. This file should be placed in the Chef Habitat <code>user</code> directory under the <code>config</code> subdirectory of the specific service directory that owns the configuration data. For example, to override the default configuration of the <code>myservice</code> service, this <code>user.toml</code> would be located at <code>/hab/user/myservice/config/user.toml</code>.</p> <h3 id="using-an-environment-variable">Using an Environment Variable</h3> <p>Override default configuration data through the use of an environment variable with the following format:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#bb60d5">HAB_PACKAGENAME</span><span style="color:#666">=</span><span style="color:#4070a0">'{"keyname1":"newvalue1", "tablename1":{"keyname2":"newvalue2"}}'</span>
</code></pre></div>
<div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#bb60d5">HAB_MYTUTORIALAPP</span><span style="color:#666">=</span><span style="color:#4070a0">'{"message":"Chef Habitat rocks!"}'</span> hab run &lt;origin&gt;/&lt;packagename&gt;
</code></pre></div>
<div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> The syntax used for applying configuration through environment variables can be either JSON or TOML, but TOML is preferred. The package name in the environment variable must be uppercase, any dashes must be replaced with underscores. </div> </div> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> Variables must be set when the Supervisor process starts, not when the service is loaded, which may require a bit of planning on the part of the Chef Habitat user. </div> </div> <p>For multiline environment variables, such as those in a TOML table or nested key value pairs, it can be easier to place your changes in a file and pass the file in. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#bb60d5">HAB_MYTUTORIALAPP</span><span style="color:#666">=</span><span style="color:#4070a0">"</span><span style="color:#007020;font-weight:700">$(</span>cat my-env-stuff.toml<span style="color:#007020;font-weight:700">)</span><span style="color:#4070a0">"</span> hab run
hab svc load &lt;origin&gt;/mytutorialapp
</code></pre></div>
<p>Or, for <a href="../sup_run/index.html#starting-the-supervisor">testing scenarios and containerized workflows</a>:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#bb60d5">HAB_MYTUTORIALAPP</span><span style="color:#666">=</span><span style="color:#4070a0">"</span><span style="color:#007020;font-weight:700">$(</span>cat my-env-stuff.toml<span style="color:#007020;font-weight:700">)</span><span style="color:#4070a0">"</span> hab run &lt;origin&gt;/mytutorialapp
</code></pre></div>
<p>The main advantage of applying configuration updates to an individual service through an environment variable is that you can quickly test configuration settings to see how your service behaves at runtime. The disadvantages of this method are that configuration changes have to be applied when the Supervisor itself starts up, and you have to restart a running Supervisor (and thus, all services it may be running) in order to change these settings again.</p> <h2 id="apply-configuration-updates-to-all-services-in-a-service-group">Apply Configuration Updates to all Services in a Service Group</h2> <p>Similar to specifying updates to individual settings at runtime, you can apply multiple configuration changes to an entire service group at runtime. These configuration updates can be sent in the clear or encrypted in gossip messages through <a href="../sup_secure/index.html">wire encryption</a>. Configuration updates to a service group will trigger a restart of the services as new changes are applied throughout the group.</p> <h3 id="usage">Usage</h3> <p>When submitting a configuration update to a service group, you must specify the following:</p> <ul> <li>a Supervisor to connect to</li> <li>the version number of the configuration update</li> <li>the new configuration</li> </ul> <p>Configuration updates can be either TOML passed into stdin, or passed in a TOML file that is referenced in <a href="../habitat_cli/index.html#hab-config-apply"><code>hab config apply</code></a>.</p> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> Configuration updates for service groups must be versioned. The version number must be an integer that starts at one and must be incremented with every subsequent update to the same service group. <em>If the version number is less than or equal to the current version number, the change(s) will not be applied.</em> </div> </div> <p>Here are some examples of how to apply configuration changes through both the shell and through a TOML file.</p> <p><strong>Stdin</strong></p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#007020">echo</span> <span style="color:#4070a0">'buffersize = 16384'</span> | hab config apply --remote-sup<span style="color:#666">=</span>hab1.mycompany.com myapp.prod <span style="color:#40a070">1</span>
</code></pre></div>
<p><strong>TOML file</strong></p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">hab config apply --remote-sup<span style="color:#666">=</span>hab1.mycompany.com myapp.prod <span style="color:#40a070">1</span> /tmp/newconfig.toml
</code></pre></div>
<p>Your output would look something like this:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">» Setting new configuration version <span style="color:#40a070">1</span> <span style="color:#007020;font-weight:700">for</span> myapp.prod
Ω Creating service configuration
↑ Applying via peer 172.18.0.2:9632
★ Applied configuration
</code></pre></div>
<p>The services in the myapp.prod service group will restart.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">myapp.prod<span style="color:#666">(</span>SR<span style="color:#666">)</span>: Service configuration updated from butterfly: acd2c21580748d38f64a014f964f19a0c1547955e4c86e63bf641a4e142b2200
hab-sup<span style="color:#666">(</span>SC<span style="color:#666">)</span>: Updated myapp.conf a85c2ed271620f895abd3f8065f265e41f198973317cc548a016f3eb60c7e13c
myapp.prod<span style="color:#666">(</span>SV<span style="color:#666">)</span>: Stopping
...
myapp.prod<span style="color:#666">(</span>SV<span style="color:#666">)</span>: Starting
</code></pre></div>
<div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> As with all Supervisor interaction commands, if you do not specify <code>--remote-sup</code>, <code>hab config apply</code> will attempt to connect to a Supervisor running on the same host. </div> </div> <h3 id="encryption">Encryption</h3> <p>Configuration updates can be encrypted for the service group they are intended. To do so, pass the <code>--user</code> option with the name of your user key, and the <code>--org</code> option with the organization of the service group. If you have the public key for the service group, the data will be encrypted for that key, signed with your user key, and sent to the ring.</p> <p>It will then be stored encrypted in memory, and decrypted on disk.</p> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/habitat/service_updates/" class="_attribution-link">https://docs.chef.io/habitat/service_updates/</a>
  </p>
</div>
