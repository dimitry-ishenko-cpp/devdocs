<div id="col-content" data-swiftype-index="true"> <div id="chef-infra-client-security"><h1>Chef Infra Client Security</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/chef-web-docs/blob/main/content/chef_client_security.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>The Chef Infra Server API handles all communication between Chef Infra Client or Chef Workstation. The Chef Infra Server API is an authenticated REST API, which means all requests require authentication and authorization. The Chef Infra tools such as <code>knife</code> and <code>chef-server</code> commands use the Chef Infra Server API for you.</p> <h2 id="authentication">Authentication</h2> <p>The authentication process ensures that Chef Infra Server only responds to requests made by trusted users or clients. Chef Infra Server uses public key encryption. You create the public and private keys when you configure <a href="../config_rb_client/index.html">Chef Infra Client</a> or setup <a href="../workstation/getting_started/index.html#setup-chef-credentials">Chef Workstation</a>.</p> <ul> <li>Chef Infra Server stores the public key</li> <li>Chef Workstation saves the private key in <code>~/.chef/</code>
</li> <li>Chef Infra Client saves the private key in <code>/etc/chef</code>
</li> </ul> <p>Both Chef Infra Client and Chef Workstation communicate with the Chef Infra Server using the Chef Infra Server API. Each time that Chef Infra Client or Chef Workstation makes a request to Chef Infra Server, they use a special group of HTTP headers and sign the rest with their private key. The Chef Infra Server then uses the public key to verify the headers and the contents.</p> <h3 id="chef-validator">chef-validator</h3> <p>Every request made by Chef Infra Client to the Chef Infra Server must be an authenticated request using the Chef Infra Server API and a private key. When Chef Infra Client makes a request to the Chef Infra Server, Chef Infra Client authenticates each request using a private key located in <code>/etc/chef/client.pem</code>.</p> <p>The private key does not yet exist the first time that Chef Infra Client runs from a new node.</p> <p>During the first Chef Infra Client run:</p> <ol> <li>Chef Infra Client uses the chef-validator private key, located in <code>/etc/chef/validation.pem</code> to register with Chef Infra Server</li> <li>Chef Infra Server assigns Chef Infra Client a private key for all future authentication requests to the Chef Infra Server</li> <li>Chef Infra Client saves the private key on the node as <code>/etc/chef/client.pem</code>
</li> </ol> <p>If the request to communicate with Chef Infra Server with the chef-validator key fails, then the entire first Chef Infra Client run fails.</p> <p>After the first completed Chef Infra Client run, delete the chef-validator private key at <code>/etc/chef/validation.pem</code></p> <h2 id="ssl-certificates">SSL Certificates</h2> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> The following information applies to on-premises Chef Infra Server and does not apply to Hosted Chef. </div> </div> <p>Chef Infra Server 12 and later enables SSL verification by default for all requests made to the server, such as those made by knife and Chef Infra Client. The certificate that is generated during the installation of the Chef Infra Server is self-signed, which means the certificate is not signed by a trusted certificate authority (CA) recognized by Chef Infra Client. The certificate generated by the Chef Infra Server must be downloaded to any machine from which knife and/or Chef Infra Client will make requests to the Chef Infra Server.</p> <p>For example, without downloading the SSL certificate, the following knife command:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife client list
</code></pre></div>
<p>responds with an error similar to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">ERROR: SSL Validation failure connecting to host: chef-server.example.com ...
ERROR: OpenSSL::SSL::SSLError: SSL_connect <span style="color:#bb60d5">returned</span><span style="color:#666">=</span><span style="color:#40a070">1</span> <span style="color:#bb60d5">errno</span><span style="color:#666">=</span><span style="color:#40a070">0</span> <span style="color:#bb60d5">state</span><span style="color:#666">=</span>SSLv3 ...
</code></pre></div>
<p>This is by design and will occur until a verifiable certificate is added to the machine from which the request is sent.</p> <h3 id="cheftrusted_certs"><code>/.chef/trusted_certs</code></h3> <p>The <code>/.chef/trusted_certs</code> directory stores trusted SSL certificates used to access the Chef Infra Server:</p> <ul> <li>On each workstation, this directory is the location into which SScertificates are placed after they are downloaded from the CheInfra Server using the <code>knife ssl fetch</code> subcommand</li> <li>On every node, this directory is the location into which SSLcertificates are placed when a node has been bootstrapped with ChefInfra Client from a workstation</li> </ul> <h3 id="ssl_cert_file">SSL_CERT_FILE</h3> <p>Use the <code>SSL_CERT_FILE</code> environment variable to specify the location for the SSL certificate authority (CA) bundle for Chef Infra Client.</p> <p>A value for <code>SSL_CERT_FILE</code> is not set by default. Unless updated, the locations in which Chef Infra will look for SSL certificates are:</p> <ul> <li>Chef Infra Client: <code>/opt/chef/embedded/ssl/certs/cacert.pem</code>
</li> <li>Chef Workstation: <code>/opt/chef-workstation/embedded/ssl/certs/cacert.pem</code>
</li> </ul> <p>To use a custom CA bundle, update the environment variable to specify the path to the custom CA bundle. The first step to troubleshoot a failing SSL certificate is to verify the location of the <code>SSL_CERT_FILE</code>.</p> <h3 id="clientrb-settings">client.rb Settings</h3> <p>Use following client.rb settings to manage SSL certificate preferences:</p> <table> <col style="width:40%"> <col style="width:60%"> <thead> <tr class="header"> <th>Setting</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>local_key_generation</code></td> <td>Whether the Chef Infra Server or Chef Infra Client generates the private/public key pair. When <code>true</code>, Chef Infra Client generates the key pair, and then sends the public key to the Chef Infra Server. Default value: <code>true</code>.</td> </tr> <tr> <td><code>ssl_ca_file</code></td> <td>The file for the OpenSSL key. Chef Infra Client generates this setting automatically.</td> </tr> <tr> <td><code>ssl_ca_path</code></td> <td>The location of the OpenSSL key file. Chef Infra Client generates this setting automatically.</td> </tr> <tr> <td><code>ssl_client_cert</code></td> <td>The OpenSSL X.509 certificate for mutual certificate validation. Required for mutual certificate validation on the Chef Infra Server. Default value: <code>nil</code>.</td> </tr> <tr> <td><code>ssl_client_key</code></td> <td>The OpenSSL X.509 key used for mutual certificate validation. Required for mutual certificate validation on the Chef Infra Server. Default value: <code>nil</code>.</td> </tr> <tr> <td><p><code>ssl_verify_mode</code></p></td> <td>
<p>Set the verification mode for HTTPS requests. The recommended setting is<code>:verify_peer</code>. Depending on your OpenSSL configuration, you may need to set the <code>ssl_ca_path</code>. Default value: <code>:verify_peer</code>.</p> <ul> <li>Use <code>:verify_none</code> to run without validating any SSL certificates.</li> <li>Use <code>:verify_peer</code> to validate all SSL certificates, including the Chef Infra Server connections, S3 connections, and any HTTPS <strong>remote_file</strong> resource URLs used in a Chef Infra Client run.</li> </ul> </td> </tr> <tr> <td><code>verify_api_cert</code></td> <td>Verify the SSL certificate on the Chef Infra Server. Set to <code>true</code>, Chef Infra Client always verifies the SSL certificate. Set to <code>false</code>, Chef Infra Client uses <code>ssl_verify_mode</code> to determine if the SSL certificate requires verification. Default value: <code>false</code>.</td> </tr> </tbody> </table> <h3 id="knife-subcommands">Knife Subcommands</h3> <p>The Chef Infra Client includes two knife commands for managing SSL certificates:</p> <ul> <li>Use <a href="../workstation/knife_ssl_check/index.html">knife ssl check</a> to troubleshoot SS certificate issues</li> <li>Use <a href="../workstation/knife_ssl_fetch/index.html">knife ssl fetch</a> to pull down a certificate from the Chef Infra Server to the <code>/.chef/trusted_certs</code> directory on the workstation.</li> </ul> <p>After the workstation has the correct SSL certificate, bootstrap operations from that workstation will use the certificate in the <code>/.chef/trusted_certs</code> directory during the bootstrap operation.</p> <h4 id="knife-ssl-check">knife ssl check</h4> <p>Run the <code>knife ssl check</code> subcommand to verify the state of the SSL certificate, and then use the response to help troubleshoot issues that may be present.</p> <h5 id="verified">Verified</h5> <p>If the SSL certificate can be verified, the response to</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife ssl check
</code></pre></div>
<p>is similar to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">Connecting to host chef-server.example.com:443
Successfully verified certificates from <span style="color:#4070a0">'chef-server.example.com'</span>
</code></pre></div>
<h5 id="unverified">Unverified</h5> <p>If the SSL certificate cannot be verified, the response to</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife ssl check
</code></pre></div>
<p>is similar to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">Connecting to host chef-server.example.com:443
ERROR: The SSL certificate of chef-server.example.com could not be verified
Certificate issuer data:
  /C<span style="color:#666">=</span>US/ST<span style="color:#666">=</span>WA/L<span style="color:#666">=</span>S/O<span style="color:#666">=</span>Corp/OU<span style="color:#666">=</span>Ops/CN<span style="color:#666">=</span>chef-server.example.com/emailAddress<span style="color:#666">=</span>you@example.com

Configuration Info:

OpenSSL Configuration:
* Version: OpenSSL 1.0.2u  <span style="color:#40a070">20</span> Dec <span style="color:#40a070">2019</span>
* Certificate file: /opt/chef-workstation/embedded/ssl/cert.pem
* Certificate directory: /opt/chef-workstation/embedded/ssl/certs
Chef SSL Configuration:
* ssl_ca_path: nil
* ssl_ca_file: nil
* trusted_certs_dir: <span style="color:#4070a0">"/Users/grantmc/Downloads/chef-repo/.chef/trusted_certs"</span>

TO FIX THIS ERROR:

If the server you are connecting to uses a self-signed certificate,
you must configure chef to trust that certificate.

By default, the certificate is stored in the following location on the
host where your Chef Infra Server runs:

  /var/opt/opscode/nginx/ca/SERVER_HOSTNAME.crt

Copy that file to your trusted_certs_dir <span style="color:#666">(</span>currently:

  /Users/grantmc/Downloads/chef-repo/.chef/trusted_certs<span style="color:#666">)</span>

using SSH/SCP or some other secure method, <span style="color:#007020;font-weight:700">then</span> re-run this <span style="color:#007020">command</span> to
confirm that the certificate is now trusted.
</code></pre></div>
<h4 id="knife-ssl-fetch">knife ssl fetch</h4> <p>Run the <code>knife ssl fetch</code> to download the self-signed certificate from the Chef Infra Server to the <code>/.chef/trusted_certs</code> directory on a workstation.</p> <h5 id="verify-checksums">Verify Checksums</h5> <p>The SSL certificate that is downloaded to the <code>/.chef/trusted_certs</code> directory should be verified to ensure that it is, in fact, the same certificate as the one located on the Chef Infra Server. This can be done by comparing the SHA-256 checksums.</p> <ol> <li> <p>View the checksum on the Chef Infra Server:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">ssh ubuntu@chef-server.example.com sudo sha256sum /var/opt/opscode/nginx/ca/chef-server.example.com.crt
</code></pre></div>
<p>The response is similar to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">&lt;ABC123checksum&gt;  /var/opt/opscode/nginx/ca/chef-server.example.com.crt
</code></pre></div>
</li> <li> <p>View the checksum on the workstation:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">gsha256sum .chef/trusted_certs/chef-server.example.com.crt
</code></pre></div>
<p>The response is similar to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">&lt;ABC123checksum&gt;  .chef/trusted_certs/chef-server.example.com.crt
</code></pre></div>
</li> <li> <p>Verify that the checksum values are identical.</p> </li> </ol> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/chef_client_security/" class="_attribution-link">https://docs.chef.io/chef_client_security/</a>
  </p>
</div>
