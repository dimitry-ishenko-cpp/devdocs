<div id="col-content" data-swiftype-index="true"> <div id="kitchenyml"><h1>kitchen.yml</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/chef-workstation/blob/main/docs-chef-io/content/workstation/config_yml_kitchen.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>Use <a href="https://kitchen.ci/">Test Kitchen</a> to automatically test cookbook data across any combination of platforms and test suites:</p> <ul> <li>Defined in a kitchen.yml file</li> <li>Uses a driver plugin architecture</li> <li>Supports cookbook testing across many cloud providers and virtualization technologies</li> <li>Supports all common testing frameworks that are used by the Ruby community</li> <li>Uses a comprehensive set of base images provided by <a href="https://github.com/chef/bento">Bento</a>
</li> </ul> <p>Use a kitchen.yml file to define what is required to run Test Kitchen, including drivers, provisioners, platforms, and test suites.</p> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> This topic details functionality that is packaged with Chef Workstation. See <a href="https://kitchen.ci/docs/getting-started/introduction/">https://kitchen.ci/docs/getting-started/introduction/</a> for more information about Test Kitchen. </div> </div> <h2 id="syntax">Syntax</h2> <p>The basic structure of a kitchen.yml file is as follows:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">driver</span>:<span style="color:#062873;font-weight:700">name</span>:driver_name<span style="color:#062873;font-weight:700">provisioner</span>:<span style="color:#062873;font-weight:700">name</span>:provisioner_name<span style="color:#062873;font-weight:700">verifier</span>:<span style="color:#062873;font-weight:700">name</span>:verifier_name<span style="color:#062873;font-weight:700">transport</span>:<span style="color:#062873;font-weight:700">name</span>:transport_name<span style="color:#062873;font-weight:700">platforms</span>:- <span style="color:#062873;font-weight:700">name</span>:platform-version<span style="color:#062873;font-weight:700">driver</span>:<span style="color:#062873;font-weight:700">name</span>:driver_name- <span style="color:#062873;font-weight:700">name</span>:platform-version<span style="color:#062873;font-weight:700">suites</span>:- <span style="color:#062873;font-weight:700">name</span>:suite_name<span style="color:#062873;font-weight:700">run_list</span>:- recipe[cookbook_name::recipe_name]<span style="color:#062873;font-weight:700">attributes</span>:{<span style="color:#062873;font-weight:700">foo</span>:<span style="color:#4070a0">"bar"</span>}<span style="color:#062873;font-weight:700">excludes</span>:- platform-version- <span style="color:#062873;font-weight:700">name</span>:suite_name<span style="color:#062873;font-weight:700">driver</span>:<span style="color:#062873;font-weight:700">name</span>:driver_name<span style="color:#062873;font-weight:700">run_list</span>:- recipe[cookbook_name::recipe_name]<span style="color:#062873;font-weight:700">attributes</span>:{<span style="color:#062873;font-weight:700">foo</span>:<span style="color:#4070a0">"bar"</span>}<span style="color:#062873;font-weight:700">includes</span>:- platform-version</code></pre></div>
<p>where:</p> <ul> <li> <p><code>driver_name</code> is the name of a driver that will be used to create platform instances used during cookbook testing. This is the default driver used for all platforms and suites <strong>unless</strong> a platform or suite specifies a <code>driver</code> to override the default driver for that platform or suite; a driver specified for a suite will override a driver set for a platform</p> </li> <li> <p><code>provisioner_name</code> specifies how Chef Infra Client will be simulated during testing. <code>chef_zero</code> and <code>chef_solo</code> are the most common provisioners used for testing cookbooks</p> </li> <li> <p><code>verifier_name</code> specifies which application to use when running tests, such as <code>inspec</code></p> </li> <li> <p><code>transport_name</code> specifies which transport to use when executing commands remotely on the test instance. <code>winrm</code> is the default transport on Windows. The <code>ssh</code> transport is the default on all other operating systems.</p> </li> <li> <p><code>platform-version</code> is the name of a platform on which Test Kitchen will perform cookbook testing, for example, <code>ubuntu-20.04</code> or <code>centos-7</code>; depending on the platform, additional driver details—for example, instance names and URLs used with cloud platforms like OpenStack or Amazon EC2—may be required</p> </li> <li> <p><code>platforms</code> may define Chef Infra Server attributes that are common to the collection of test suites</p> </li> <li> <p><code>suites</code> is a collection of test suites, with each <code>suite_name</code> grouping defining an aspect of a cookbook to be tested. Each <code>suite_name</code> must specify a run-list, for example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#517918">run_list</span>:
  <span style="color:#666">-</span> recipe<span style="color:#666">[</span>cookbook_name<span style="color:#666">::</span>default<span style="color:#666">]</span>
  <span style="color:#666">-</span> recipe<span style="color:#666">[</span>cookbook_name<span style="color:#666">::</span>recipe_name<span style="color:#666">]</span>
</code></pre></div>
</li> <li> <p>Each <code>suite_name</code> grouping may specify <code>attributes</code> as a Hash: <code>{ foo: "bar" }</code></p> </li> <li> <p>A <code>suite_name</code> grouping may use <code>excludes</code> and <code>includes</code> to exclude/include one (or more) platforms. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#517918">excludes</span>:
   <span style="color:#666">-</span> platform<span style="color:#666">-</span>version
   <span style="color:#666">-</span> platform<span style="color:#666">-</span>version       <span style="color:#60a0b0;font-style:italic"># for additional platforms</span>
</code></pre></div>
</li> </ul> <p>For example, a very simple kitchen.yml file:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">driver</span>:<span style="color:#062873;font-weight:700">name</span>:vagrant<span style="color:#062873;font-weight:700">provisioner</span>:<span style="color:#062873;font-weight:700">name</span>:chef_zero<span style="color:#062873;font-weight:700">platforms</span>:- <span style="color:#062873;font-weight:700">name</span>:ubuntu-20.04- <span style="color:#062873;font-weight:700">name</span>:centos-8- <span style="color:#062873;font-weight:700">name</span>:debian-10<span style="color:#062873;font-weight:700">suites</span>:- <span style="color:#062873;font-weight:700">name</span>:default<span style="color:#062873;font-weight:700">run_list</span>:- recipe[apache::httpd]<span style="color:#062873;font-weight:700">excludes</span>:- debian-10</code></pre></div>
<p>This file uses HashiCorp Vagrant as the driver, which requires no additional configuration because it’s the default driver used by Test Kitchen, chef-zero as the provisioner, and a single (default) test suite that runs on Ubuntu 20.04, and CentOS 7.</p> <h2 id="provisioner-settings">Provisioner Settings</h2> <p>Test Kitchen can configure the chef-zero provisioner with the following Chef-specific settings:</p> <table> <col style="width:40%"> <col style="width:60%"> <thead> <tr class="header"> <th>Setting</th> <th>Description</th> </tr> </thead> <tbody> <tr class="odd"> <td><code>attributes</code></td> <td>Chef attributes for use in the suite</td> </tr> <tr class="even"> <td><code>chef_client_path</code></td> <td>Chef Infra Client provisioner only.</td> </tr> <tr class="odd"> <td><code>chef_metadata_url</code></td> <td><strong>This will be deprecated in a future version.</strong></td> </tr> <tr class="even"> <td><code>chef_omnibus_install_options</code></td> <td>Use to specify the package to be installed. Possible values: <code>-P chef</code> (for Chef Infra Client) and <code>-P chef-workstation</code> (for the Chef Infra Client that is packaged as part of Chef Workstation). Use <code>-n</code> to specify the nightly build. For example: <code>-P chef-workstation</code> or <code>-n -P chef-workstation</code>. <strong>This will be deprecated in a future version.</strong> See the <code>product_name</code>, <code>product_version</code>, and <code>channel</code> settings instead.</td> </tr> <tr class="odd"> <td><code>chef_omnibus_root</code></td> <td>Default value: <code>/etc/opt</code> for UNIX and Linux, <code>$env:systemdrive\\opscode\\chef</code> on Microsoft Windows.</td> </tr> <tr class="even"> <td><code>chef_omnibus_url</code></td> <td>The URL for an <code>install.sh</code> script that will install Chef Infra Client on the machine under test. Default value: <code>https://omnitruck.chef.io/install.sh</code>. <strong>This will be deprecated in a future version.</strong>
</td> </tr> <tr class="odd"> <td><code>chef_solo_path</code></td> <td>chef-solo provisioner only.</td> </tr> <tr class="even"> <td><code>chef_zero_host</code></td> <td>Chef Infra Client provisioner only.</td> </tr> <tr class="odd"> <td><code>chef_zero_port</code></td> <td>Chef Infra Client provisioner only. The port on which chef-zero is to listen.</td> </tr> <tr class="even"> <td><p><code>client_rb</code></p></td> <td>
<p>Chef Infra Client provisioner only. A list of client.rb file settings. For example:</p> <div class="sourceCode" id="cb1"><pre class="sourceCode yaml highlight" data-language="ruby"><code class="sourceCode yaml"><span id="cb1-1"><span class="fu">client_rb</span><span class="kw">:</span></span>
<span id="cb1-2"><span class="fu">log_level</span><span class="kw">:</span><span class="at"> :warn</span></span></code></pre></div>
</td> </tr> <tr class="odd"> <td><code>clients_path</code></td> <td>The relative path to the directory in which client data is located. This data must be defined as JSON.</td> </tr> <tr class="even"> <td><code>cookbook_files_glob</code></td> <td>A file glob (pattern) that matches files considered to be part of the cookbook. (Typically, this value does not need to be modified from the default.)</td> </tr> <tr class="odd"> <td><code>data_path</code></td> <td>Use to specify the path from which non-cookbook files are copied to a Kitchen instance.</td> </tr> <tr class="even"> <td><code>data_bags_path</code></td> <td>The relative path to a directory in which data bags and data bag items are defined. This data must be structured as if it were in the chef-repo.</td> </tr> <tr class="odd"> <td><code>deprecations_as_errors</code></td> <td>Set to <span class="title-ref">true</span> to treat deprecation warning messages as error messages.</td> </tr> <tr class="even"> <td><code>driver</code></td> <td>Use to specify a driver for a platform. This will override the default driver.</td> </tr> <tr class="odd"> <td><code>enforce_idempotency</code></td> <td>Use with <code>multiple_converge</code> &gt; 1. Set to <code>true</code> to force test-kitchen to fail if last converge has any updated resources.</td> </tr> <tr class="even"> <td><code>encrypted_data_bag_secret_key_path</code></td> <td>The path to an RSA key file that is used to decrypt encrypted data bag items.</td> </tr> <tr class="odd"> <td><code>environments_path</code></td> <td>The relative path to the directory in which environment data is located. This data must be defined as JSON.</td> </tr> <tr class="even"> <td><code>http_proxy</code></td> <td>The proxy server for HTTP connections.</td> </tr> <tr class="odd"> <td><code>https_proxy</code></td> <td>The proxy server for HTTPS connections.</td> </tr> <tr class="even"> <td><code>no_proxy</code></td> <td>The comma-separated exception list of host patterns to exclude from proxying.</td> </tr> <tr class="odd"> <td><code>install_msi_url</code></td> <td>An alternate URL for a Windows MSI package that will install Chef Infra Client on the machine under test. <strong>This will be deprecated in a future version.</strong> Use the <code>download_url</code> setting instead.</td> </tr> <tr class="even"> <td><code>json_attributes</code></td> <td>Chef Infra Client provisioner only.</td> </tr> <tr class="odd"> <td><code>log_file</code></td> <td></td> </tr> <tr class="even"> <td><code>multiple_converge</code></td> <td>Number of times to converge the node. Defaults to 1.</td> </tr> <tr class="odd"> <td><code>nodes_path</code></td> <td>The relative path to the directory in which node data is located. This data must be defined as JSON.</td> </tr> <tr class="even"> <td><code>require_chef_omnibus</code></td> <td>Use to install the latest version of Chef Infra Client on a node. Set to <code>true</code> to install the latest version, <code>false</code> to not install Chef Infra Client (assumes the box already has it installed), or a version specifier like <code>15.3.12</code> to install a particular version, or simply <code>15</code> to install the latest 15.x package. When set to <code>true</code> or a version number, the <code>chef_omnibus_url</code> may be used to specify the URL of the <code>install.sh</code> that installs the specified version of Chef Infra Client. Default value: <code>true</code>. <strong>This will be deprecated in a future version.</strong> See the <code>product_version</code> and <code>install_strategy</code> settings.</td> </tr> <tr class="odd"> <td><code>roles_path</code></td> <td>The relative path to the directory in which role data is located. This data must be defined as JSON.</td> </tr> <tr class="even"> <td><code>root_path</code></td> <td>The directory in which Kitchen will stage all content on the target node. This directory should be large enough to store all the content and must be writable. (Typically, this value does not need to be modified from the default value.) Default value: <code>/tmp/kitchen</code>.</td> </tr> <tr class="odd"> <td><code>ruby_bindir</code></td> <td>Chef Infra Client provisioner only.</td> </tr> <tr class="even"> <td><code>run_list</code></td> <td></td> </tr> <tr class="odd"> <td><code>solo_rb</code></td> <td>chef-solo provisioner only.</td> </tr> <tr class="even"> <td><code>retry_on_exit_code</code></td> <td>Takes an array of exit codes to indicate that kitchen should retry the converge command. Default value: <code>[35, 213]</code>.</td> </tr> <tr class="odd"> <td><code>max_retries</code></td> <td>Number of times to retry the converge before passing along the failed status. Defaults value: 1.</td> </tr> <tr class="even"> <td><code>wait_for_retry</code></td> <td>Number of seconds to wait between converge attempts. Default value: 30.</td> </tr> </tbody> </table> <p>These settings may be added to the <code>provisioner</code> section of the kitchen.yml file when the provisioner is chef-zero or chef-solo.</p> <h3 id="new-provisioner-settings">New Provisioner Settings</h3> <table> <col style="width:15%"> <col style="width:55%"> <col style="width:5%"> <col style="width:25%"> <thead> <tr class="header"> <th>New Setting</th> <th>Description</th> <th>Default</th> <th>Replaces</th> </tr> </thead> <tbody> <tr class="odd"> <td><code>product_name</code></td> <td>
<code>chef</code> or <code>chef-workstation</code>. This setting must be specified in order to use the new settings. Using this setting overrides Test Kitchen's default behavior based on the <code>require_chef_omnibus</code> setting.</td> <td></td> <td><code>chef_omnibus_install_options</code></td> </tr> <tr class="even"> <td><code>product_version</code></td> <td>Product version number. Supports partial version numbers.</td> <td><code>latest</code></td> <td><code>require_chef_omnibus</code></td> </tr> <tr class="odd"> <td><code>channel</code></td> <td>Artifact repository name. <code>stable</code>, <code>current</code> or <code>unstable</code>.</td> <td><code>stable</code></td> <td><code>chef_omnibus_install_options</code></td> </tr> <tr class="even"> <td><code>install_strategy</code></td> <td>Product install strategy. <code>once</code> (Don't install if any product installation detected), <code>always</code> or <code>skip</code>.</td> <td><code>once</code></td> <td><code>require_chef_omnibus</code></td> </tr> <tr class="odd"> <td><code>download_url</code></td> <td>Direct package URL. Supports all platforms.</td> <td></td> <td><code>install_msi_url</code></td> </tr> <tr class="even"> <td><code>checksum</code></td> <td>Optional setting when using <code>download_url</code>. Validates SHA256 checksum after download.</td> <td></td> <td></td> </tr> <tr class="odd"> <td><code>platform</code></td> <td>Override platform.</td> <td>&lt;auto detected&gt;</td> <td></td> </tr> <tr class="even"> <td><code>platform_version</code></td> <td>Override platform platform.</td> <td>&lt;auto detected&gt;</td> <td></td> </tr> <tr class="odd"> <td><code>architecture</code></td> <td>Override platform architecture.</td> <td>&lt;auto detected&gt;</td> <td></td> </tr> <tr class="even"> <td><code>always_update_cookbooks</code></td> <td>Updates the policyfile.lock.json when changes are made to the cookbook. Supports <code>true</code> or <code>false</code> </td> <td>&lt;auto detected&gt;</td> <td></td> </tr> </tbody> </table> <h2 id="transport-settings">Transport Settings</h2> <p>Kitchen can configure a transport with the following settings for either <code>ssh</code> or <code>winrm</code> transports:</p> <table> <col style="width:40%"> <col style="width:60%"> <thead> <tr class="header"> <th>Setting</th> <th>Description</th> </tr> </thead> <tbody> <tr class="odd"> <td><code>connection_retries</code></td> <td>Maximum number of times to retry after a failed attempt to open a connection. The default is 5.</td> </tr> <tr class="even"> <td><code>connection_retry_sleep</code></td> <td>Number of seconds to wait until attempting to make another connection after a failure.</td> </tr> <tr class="odd"> <td><code>max_wait_until_ready</code></td> <td>Maximum number of attempts to determine if the test instance is ready to accept commands. This defaults to 600.</td> </tr> <tr class="even"> <td><code>password</code></td> <td>The password used for authenticating to the test instance.</td> </tr> <tr class="odd"> <td><code>port</code></td> <td>The port used to connect to the test instance. This defaults to <code>22</code> for the <code>ssh</code> transport and <code>5985</code> or <code>5986</code> for <code>winrm</code> using <code>http</code> or <code>https</code> respectively.</td> </tr> <tr class="even"> <td><code>username</code></td> <td>The username used for authenticating to the test instance. This defaults to <code>administrator</code> for the <code>winrm</code> transport and <code>root</code> for the <code>ssh</code> transport. Some drivers may change this default.</td> </tr> </tbody> </table> <p>These settings may be added to the <code>transport</code> section of the kitchen.yml file when the transport is SSH:</p> <table> <col style="width:40%"> <col style="width:60%"> <thead> <tr class="header"> <th>Setting</th> <th>Description</th> </tr> </thead> <tbody> <tr class="odd"> <td><code>compression</code></td> <td>Wether or not to use compression. The default is <code>false</code>.</td> </tr> <tr class="even"> <td><code>compression_level</code></td> <td>The default is 6 if <code>compression</code> is <code>true</code>.</td> </tr> <tr class="odd"> <td><code>connection_timeout</code></td> <td>Defaults to 15.</td> </tr> <tr class="even"> <td><code>keepalive</code></td> <td>Defaults to <code>true</code>.</td> </tr> <tr class="odd"> <td><code>keepalive_interval</code></td> <td>Defaults to 60.</td> </tr> <tr class="even"> <td><code>max_ssh_sessions</code></td> <td>Maximum number of parallel ssh sessions.</td> </tr> <tr class="odd"> <td><code>ssh_key</code></td> <td>Path to an ssh key identity file.</td> </tr> </tbody> </table> <p>These settings may be added to the <code>transport</code> section of the kitchen.yml file when the transport is WinRM:</p> <table> <col style="width:40%"> <col style="width:60%"> <thead> <tr class="header"> <th>Setting</th> <th>Description</th> </tr> </thead> <tbody> <tr class="odd"> <td><code>elevated</code></td> <td>When <code>true</code>, all commands are executed via a scheduled task. This may eliminate access denied errors related to double hop authentication, interacting with windows updates and installing some MSIs such as sql server and .net runtimes. Defaults to <code>false</code>.</td> </tr> <tr class="even"> <td><code>elevated_password</code></td> <td>The password used by the identity running the scheduled task. This may be <code>null</code> in the case of service accounts. Defaults to <code>password</code>.</td> </tr> <tr class="odd"> <td><code>elevated_username</code></td> <td>The identity that the task runs under. This may also be set to service accounts such as <code>System</code>. This defaults to <code>username</code>.</td> </tr> <tr class="even"> <td><code>rdp_port</code></td> <td>Port used making <code>rdp</code> connections for <code>kitchen login</code> commands. Defaults to 3389.</td> </tr> <tr class="odd"> <td><code>winrm_transport</code></td> <td>The transport type used by winrm as explained <a href="https://github.com/WinRb/WinRM">here</a>. The default is <code>negotiate</code>. <code>ssl</code> and <code>plaintext</code> are also acceptable values.</td> </tr> </tbody> </table> <h3 id="work-with-proxies">Work with Proxies</h3> <p>The environment variables <code>http_proxy</code>, <code>https_proxy</code>, and <code>ftp_proxy</code> are honored by Test Kitchen for proxies. The client.rb file is read to look for proxy configuration settings. If <code>http_proxy</code>, <code>https_proxy</code>, and <code>ftp_proxy</code> are specified in the client.rb file, Chef Infra Client will configure the <code>ENV</code> variable based on these (and related) settings. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">http_proxy <span style="color:#4070a0">'http://proxy.example.org:8080'</span>
http_proxy_user <span style="color:#4070a0">'myself'</span>
http_proxy_pass <span style="color:#4070a0">'Password1'</span>
</code></pre></div>
<p>will be set to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60add5">ENV</span><span style="color:#666">[</span><span style="color:#4070a0">'http_proxy'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'http://myself:Password1@proxy.example.org:8080'</span>
</code></pre></div>
<p>Test Kitchen also supports <code>http_proxy</code> and <code>https_proxy</code> in the <code>kitchen.yml</code> file. You can set them manually or have them read from your local environment variables:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">driver</span>:<span style="color:#062873;font-weight:700">name</span>:vagrant<span style="color:#062873;font-weight:700">provisioner</span>:<span style="color:#062873;font-weight:700">name</span>:chef_zero<span style="color:#60a0b0;font-style:italic"># Set proxy settings manually, or</span><span style="color:#062873;font-weight:700">http_proxy</span>:<span style="color:#4070a0">'http://user:password@server:port'</span><span style="color:#062873;font-weight:700">https_proxy</span>:<span style="color:#4070a0">'http://user:password@server:port'</span><span style="color:#60a0b0;font-style:italic"># Read from local environment variables</span><span style="color:#062873;font-weight:700">http_proxy</span>:&lt;%= ENV['http_proxy'] %&gt;<span style="color:#062873;font-weight:700">https_proxy</span>:&lt;%= ENV['https_proxy'] %&gt;</code></pre></div>
<p>This will not set the proxy environment variables for applications other than Chef. The Vagrant plugin, <a href="http://tmatilai.github.io/vagrant-proxyconf/">vagrant-proxyconf</a>, can be used to set the proxy environment variables for applications inside the VM.</p> <h2 id="chef-infra-client-settings">Chef Infra Client Settings</h2> <p>A kitchen.yml file may define Chef Infra Client-specific settings, such as whether to require the Chef installer or the URL from which Chef Infra Client is downloaded, or to override settings in the client.rb file:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">provisioner</span>:<span style="color:#062873;font-weight:700">name</span>:chef_zero *or* chef_solo<span style="color:#062873;font-weight:700">require_chef_omnibus</span>:<span style="color:#007020;font-weight:700">true</span><span style="color:#062873;font-weight:700">chef_omnibus_url</span>:https://www.chef.io/chef/install.sh<span style="color:#0e84b5;font-weight:700">...</span><span style="color:#062873;font-weight:700">suites</span>:- <span style="color:#062873;font-weight:700">name</span>:config<span style="color:#062873;font-weight:700">run_list</span>:...<span style="color:#062873;font-weight:700">attributes</span>:<span style="color:#062873;font-weight:700">chef_client</span>:<span style="color:#062873;font-weight:700">load_gems</span>:<span style="color:#062873;font-weight:700">chef-handler-updated-resources</span>:<span style="color:#062873;font-weight:700">require_name</span>:<span style="color:#4070a0">"chef/handler/updated_resources"</span><span style="color:#062873;font-weight:700">config</span>:<span style="color:#062873;font-weight:700">log_level</span>:<span style="color:#4070a0">":debug"</span><span style="color:#062873;font-weight:700">ssl_verify_mode</span>:<span style="color:#4070a0">":verify_peer"</span><span style="color:#062873;font-weight:700">start_handlers</span>:[{<span style="color:#062873;font-weight:700">class</span>:<span style="color:#4070a0">"SimpleReport::UpdatedResources"</span><span style="color:#062873;font-weight:700">, arguments</span>:[]}]<span style="color:#062873;font-weight:700">report_handlers</span>:[{<span style="color:#062873;font-weight:700">class</span>:<span style="color:#4070a0">"SimpleReport::UpdatedResources"</span><span style="color:#062873;font-weight:700">, arguments</span>:[]}]<span style="color:#062873;font-weight:700">exception_handlers</span>:[{<span style="color:#062873;font-weight:700">class</span>:<span style="color:#4070a0">"SimpleReport::UpdatedResources"</span><span style="color:#062873;font-weight:700">, arguments</span>:[]}]<span style="color:#062873;font-weight:700">ohai</span>:<span style="color:#062873;font-weight:700">disabled_plugins</span>:[<span style="color:#4070a0">"passwd"</span>]</code></pre></div>
<p>where:</p> <ul> <li>
<code>require_chef_omnibus</code> is used to ensure that the Chef installer will be used to install Chef Infra Client to all platform instances; <code>require_chef_omnibus</code> may also be set to <code>latest</code>, which means the newest version of Chef Infra Client for that platform will be used for cookbook testing</li> <li>
<code>chef_omnibus_url</code> is used to specify the URL from which Chef Infra Client is downloaded</li> <li>All of the <code>attributes</code> for the <code>config</code> test suite contain specific client.rb settings for use with this test suite</li> </ul> <h2 id="driver-settings">Driver Settings</h2> <p>Driver-specific configuration settings may be required. Use a block similar to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">driver</span>:<span style="color:#062873;font-weight:700">name</span>:driver_name<span style="color:#062873;font-weight:700">optional_settings</span>:values</code></pre></div>
<p>Specific <code>optional_settings: values</code> may be specified.</p> <h3 id="bento">Bento</h3> <p><a href="https://github.com/chef/bento">Bento</a> is a Chef Software project that produces base testing VirtualBox, Parallels, and VMware boxes for multiple operating systems for use with Test Kitchen. By default, Test Kitchen uses the base images provided by Bento although custom images may also be built using HashiCorp Packer.</p> <h3 id="drivers">Drivers</h3> <p>Test Kitchen uses a driver plugin architecture to enable Test Kitchen to test instances on cloud providers such as Amazon EC2, Google Compute Engine, and Microsoft Azure. You can also test on multiple local hypervisors, such as VMware, Hyper-V, or VirtualBox.</p> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> <p>Chef Workstation includes many common Test Kitchen drivers.</p> </div> </div> <p>Most drivers have driver-specific configuration settings that must be added to the kitchen.yml file before Test Kitchen will be able to use that platform during cookbook testing. For information about these driver-specific settings, please refer to the driver-specific documentation.</p> <p>Some popular drivers:</p> <table> <col style="width:25%"> <col style="width:75%"> <thead> <tr class="header"> <th>Driver Plugin</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><a href="https://github.com/test-kitchen/kitchen-azurerm">kitchen-azurerm</a></td> <td>A driver for Microsoft Azure.</td> </tr> <tr> <td><a href="https://github.com/test-kitchen/kitchen-cloudstack">kitchen-cloudstack</a></td> <td>A driver for CloudStack.</td> </tr> <tr> <td><a href="https://github.com/test-kitchen/kitchen-digitalocean">kitchen-digitalocean</a></td> <td>A driver for DigitalOcean. This driver ships in Chef Workstation.</td> </tr> <tr> <td><a href="https://github.com/test-kitchen/kitchen-dokken">kitchen-dokken</a></td> <td>A driver for Docker. This driver ships in Chef Workstation.</td> </tr> <tr> <td><a href="https://github.com/test-kitchen/kitchen-dsc">kitchen-dsc</a></td> <td>A driver for Windows PowerShell Desired State Configuration (DSC).</td> </tr> <tr> <td><a href="https://github.com/test-kitchen/kitchen-ec2">kitchen-ec2</a></td> <td>A driver for Amazon EC2. This driver ships in Chef Workstation.</td> </tr> <tr> <td><a href="https://github.com/test-kitchen/kitchen-google">kitchen-google</a></td> <td>A driver for Google Compute Engine. This driver ships in Chef Workstation</td> </tr> <tr> <td><a href="https://github.com/test-kitchen/kitchen-hyperv">kitchen-hyperv</a></td> <td>A driver for Microsoft Hyper-V Server. This driver ships in Chef Workstation.</td> </tr> <tr> <td><a href="https://github.com/test-kitchen/kitchen-openstack">kitchen-openstack</a></td> <td>A driver for OpenStack. This driver ships in Chef Workstation.</td> </tr> <tr> <td><a href="https://github.com/test-kitchen/kitchen-rackspace">kitchen-rackspace</a></td> <td>A driver for Rackspace.</td> </tr> <tr> <td><a href="https://github.com/test-kitchen/kitchen-vagrant">kitchen-vagrant</a></td> <td>A driver for HashiCorp Vagrant. This driver ships in Chef Workstation.</td> </tr> </tbody> </table> <h3 id="kitchen-vagrant">kitchen-vagrant</h3> <p>The <code>kitchen-vagrant</code> driver for Kitchen generates a single Vagrantfile for each instance of Kitchen in a sandboxed directory. The <code>kitchen-vagrant</code> driver supports VirtualBox and VMware Fusion, requires Vagrant 1.1.0 (or higher), and is the default driver for Test Kitchen.</p> <p>The following attributes are used to configure <code>kitchen-vagrant</code> for Chef:</p> <table> <col style="width:12%"> <col style="width:87%"> <thead> <tr class="header"> <th>Attribute</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>box</code></td> <td>Required. Use to specify the box on which Vagrant will run. Default value: computed from the platform name of the instance.</td> </tr> <tr> <td><code>box_check_update</code></td> <td>Use to check for box updates. Default value: <code>false</code>.</td> </tr> <tr> <td><code>box_url</code></td> <td>Use to specify the URL at which the configured box is located. Default value: computed from the platform name of the instance, but only when the Vagrant provider is VirtualBox- or VMware-based.</td> </tr> <tr> <td><code>communicator</code></td> <td>Use to override the <code>config.vm.communicator</code> setting in Vagrant. For example, when a base box is a Microsoft Windows operating system that does not have SSH installed and enabled, Vagrant will not be able to boot without a custom Vagrant file. Default value: <code>nil</code> (assumes SSH is available).</td> </tr> <tr> <td><code>customize</code></td> <td>A hash of key-value pairs that define customizations that should be made to the Vagrant virtual machine. For example: <code>customize: memory: 1024 cpuexecutioncap: 50</code>.</td> </tr> <tr> <td><code>guest</code></td> <td>Use to specify the <code>config.vm.guest</code> setting in the default Vagrantfile.</td> </tr> <tr> <td><code>gui</code></td> <td>Use to enable the graphical user interface for the defined platform. This is passed to the <code>config.vm.provider</code> setting in Vagrant, but only when the Vagrant provider is VirtualBox- or VMware-based.</td> </tr> <tr> <td><code>network</code></td> <td>Use to specify an array of network customizations to be applied to the virtual machine. Default value: <code>[]</code>. For example: <code>network: - ["forwarded_port", {guest: 80, host: 8080}] - ["private_network", {ip: "192.168.33.33"}]</code>.</td> </tr> <tr> <td><code>pre_create_command</code></td> <td>Use to run a command immediately prior to <code>vagrant up --no-provisioner</code>.</td> </tr> <tr> <td><code>provider</code></td> <td>Use to specify the Vagrant provider. This value must match a provider name in Vagrant.</td> </tr> <tr> <td><code>provision</code></td> <td>Use to provision Vagrant when the instance is created. This is useful if the operating system needs customization during provisioning. Default value: <code>false</code>.</td> </tr> <tr> <td><code>ssh_key</code></td> <td>Use to specify the private key file used for SSH authentication.</td> </tr> <tr> <td><code>synced_folders</code></td> <td>Use to specify a collection of synchronized folders on each Vagrant instance. Source paths are relative to the Kitchen root path. Default value: <code>[]</code>. For example: <code>synced_folders: - ["data/%{instance_name}", "/opt/instance_data"] - ["/host_path", "/vm_path", "create: true, type: :nfs"]</code>.</td> </tr> <tr> <td><code>vagrantfile_erb</code></td> <td>Use to specify an alternate Vagrant Embedded Ruby (ERB) template to be used by this driver.</td> </tr> <tr> <td><code>vagrantfiles</code></td> <td>An array of paths to one (or more) Vagrant files to be merged with the default Vagrant file. The paths may be absolute or relative to the kitchen.yml file.</td> </tr> <tr> <td><code>vm_hostname</code></td> <td>Use to specify the internal hostname for the instance. This is not required when connecting to a Vagrant virtual machine. Set this to <code>false</code> to prevent this value from being rendered in the default Vagrantfile. Default value: computed from the platform name of the instance.</td> </tr> </tbody> </table> <p>The <code>kitchen-vagrant</code> driver can predict the box name for Vagrant and the download URL that have been published by Chef. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#517918">platforms</span>:
<span style="color:#666">-</span> <span style="color:#007020">name</span>: ubuntu<span style="color:#666">-</span><span style="color:#40a070">18</span><span style="color:#666">.</span><span style="color:#40a070">04</span>
<span style="color:#666">-</span> <span style="color:#007020">name</span>: ubuntu<span style="color:#666">-</span><span style="color:#40a070">20</span><span style="color:#666">.</span><span style="color:#40a070">04</span>
<span style="color:#666">-</span> <span style="color:#007020">name</span>: centos<span style="color:#666">-</span><span style="color:#40a070">7</span>
<span style="color:#666">-</span> <span style="color:#007020">name</span>: centos<span style="color:#666">-</span><span style="color:#40a070">8</span>
<span style="color:#666">-</span> <span style="color:#007020">name</span>: debian<span style="color:#666">-</span><span style="color:#40a070">10</span>
</code></pre></div>
<p>which will generate a configuration file similar to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#517918">platforms</span>:
<span style="color:#666">-</span> <span style="color:#007020">name</span>: ubuntu<span style="color:#666">-</span><span style="color:#40a070">18</span><span style="color:#666">.</span><span style="color:#40a070">04</span>
  <span style="color:#517918">driver</span>:
    <span style="color:#517918">box</span>: bento<span style="color:#666">/</span>ubuntu<span style="color:#666">-</span><span style="color:#40a070">18</span><span style="color:#666">.</span><span style="color:#40a070">04</span>
<span style="color:#666">-</span> <span style="color:#007020">name</span>: ubuntu<span style="color:#666">-</span><span style="color:#40a070">20</span><span style="color:#666">.</span><span style="color:#40a070">04</span>
  <span style="color:#517918">driver</span>:
    <span style="color:#517918">box</span>: bento<span style="color:#666">/</span>ubuntu<span style="color:#666">-</span><span style="color:#40a070">20</span><span style="color:#666">.</span><span style="color:#40a070">04</span>
<span style="color:#60a0b0;font-style:italic"># ...</span>
</code></pre></div>
<h2 id="examples">Examples</h2> <p>The following examples show actual kitchen.yml files used in Chef-maintained cookbooks.</p> <h3 id="chef-chef-workstation">Chef, Chef Workstation</h3> <p>The following example shows the provisioner settings needed to install Chef Workstation, and then use the version of Chef that is embedded in Chef Workstation to converge the node.</p> <p>To install the latest version of Chef Workstation:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">provisioner</span>:...<span style="color:#062873;font-weight:700">chef_omnibus_install_options</span>:-P chef-workstation<span style="color:#062873;font-weight:700">chef_omnibus_root</span>:/opt/chef-workstation</code></pre></div>
<p>and to install a specific version of Chef Workstation:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">provisioner</span>:...<span style="color:#062873;font-weight:700">chef_omnibus_install_options</span>:-P chef-workstation<span style="color:#062873;font-weight:700">chef_omnibus_root</span>:/opt/chef-workstation<span style="color:#062873;font-weight:700">require_chef_omnibus</span>:<span style="color:#40a070">0.9</span></code></pre></div>
<h3 id="microsoft-windows-platform">Microsoft Windows Platform</h3> <p>The following example shows platform settings for the Microsoft Windows platform:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">platforms</span>:- <span style="color:#062873;font-weight:700">name</span>:eval-win2012r2-standard<span style="color:#062873;font-weight:700">os_type</span>:windows<span style="color:#062873;font-weight:700">transport</span>:<span style="color:#062873;font-weight:700">name</span>:winrm<span style="color:#062873;font-weight:700">elevated</span>:<span style="color:#007020;font-weight:700">true</span></code></pre></div>
<p>If <code>name</code> begins with <code>win</code> then the <code>os_type</code> defaults to <code>windows</code>. The <code>winrm</code> transport is the default on Windows operating systems. Here <code>elevated</code> is true which runs windows commands via a scheduled task to imitate a local user.</p> <h3 id="chef-infra-client-cookbook">Chef Infra Client Cookbook</h3> <p>The following kitchen.yml file is part of the <code>chef-client</code> cookbook and ensures Chef Infra Client is configured correctly.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">driver</span>:<span style="color:#062873;font-weight:700">name</span>:vagrant<span style="color:#062873;font-weight:700">provisioner</span>:<span style="color:#062873;font-weight:700">name</span>:chef_zero<span style="color:#062873;font-weight:700">platforms</span>:- <span style="color:#062873;font-weight:700">name</span>:centos-8- <span style="color:#062873;font-weight:700">name</span>:fedora-latest- <span style="color:#062873;font-weight:700">name</span>:ubuntu-1804- <span style="color:#062873;font-weight:700">name</span>:ubuntu-2004<span style="color:#062873;font-weight:700">suites</span>:- <span style="color:#062873;font-weight:700">name</span>:service_init<span style="color:#062873;font-weight:700">run_list</span>:- recipe[minitest-handler]- recipe[chef-client::config]- recipe[chef-client_test::service_init]- recipe[chef-client::init_service]<span style="color:#062873;font-weight:700">attributes</span>:{}- <span style="color:#062873;font-weight:700">name</span>:service_runit<span style="color:#062873;font-weight:700">run_list</span>:- recipe[minitest-handler]- recipe[runit]- recipe[chef-client_test::service_runit]- recipe[chef-client::runit_service]<span style="color:#062873;font-weight:700">attributes</span>:{}- <span style="color:#062873;font-weight:700">name</span>:service_upstart<span style="color:#062873;font-weight:700">run_list</span>:- recipe[minitest-handler]- recipe[chef-client_test::service_upstart]- recipe[chef-client::upstart_service]<span style="color:#062873;font-weight:700">excludes</span>:[<span style="color:#4070a0">"centos-5.9"</span>]<span style="color:#062873;font-weight:700">attributes</span>:{}- <span style="color:#062873;font-weight:700">name</span>:cron<span style="color:#062873;font-weight:700">run_list</span>:- recipe[minitest-handler]- recipe[chef-client::cron]<span style="color:#062873;font-weight:700">attributes</span>:{}- <span style="color:#062873;font-weight:700">name</span>:delete_validation<span style="color:#062873;font-weight:700">run_list</span>:- recipe[chef-client::delete_validation]<span style="color:#062873;font-weight:700">attributes</span>:{}</code></pre></div>
<h3 id="chef-splunk-cookbook">chef-splunk Cookbook</h3> <p>The following kitchen.yml file is part of the <code>chef-splunk</code> cookbook and is used to help ensure the installation of the Splunk client and server is done correctly.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">driver</span>:<span style="color:#062873;font-weight:700">name</span>:vagrant<span style="color:#062873;font-weight:700">customize</span>:<span style="color:#062873;font-weight:700">memory</span>:<span style="color:#40a070">1024</span><span style="color:#062873;font-weight:700">provisioner</span>:<span style="color:#062873;font-weight:700">name</span>:chef_zero<span style="color:#062873;font-weight:700">platforms</span>:- <span style="color:#062873;font-weight:700">name</span>:ubuntu-18.04- <span style="color:#062873;font-weight:700">name</span>:ubuntu-20.04- <span style="color:#062873;font-weight:700">name</span>:centos-7- <span style="color:#062873;font-weight:700">name</span>:centos-8<span style="color:#062873;font-weight:700">suites</span>:- <span style="color:#062873;font-weight:700">name</span>:client<span style="color:#062873;font-weight:700">run_list</span>:- recipe[chef-splunk::default]- recipe[test::default]<span style="color:#062873;font-weight:700">attributes</span>:<span style="color:#062873;font-weight:700">dev_mode</span>:<span style="color:#007020;font-weight:700">true</span><span style="color:#062873;font-weight:700">splunk</span>:<span style="color:#062873;font-weight:700">accept_license</span>:<span style="color:#007020;font-weight:700">true</span>- <span style="color:#062873;font-weight:700">name</span>:server<span style="color:#062873;font-weight:700">run_list</span>:- recipe[chef-splunk::default]<span style="color:#062873;font-weight:700">attributes</span>:<span style="color:#062873;font-weight:700">dev_mode</span>:<span style="color:#007020;font-weight:700">true</span><span style="color:#062873;font-weight:700">splunk</span>:<span style="color:#062873;font-weight:700">is_server</span>:<span style="color:#007020;font-weight:700">true</span><span style="color:#062873;font-weight:700">accept_license</span>:<span style="color:#007020;font-weight:700">true</span><span style="color:#062873;font-weight:700">ssl_options</span>:<span style="color:#062873;font-weight:700">enable_ssl</span>:<span style="color:#007020;font-weight:700">true</span></code></pre></div>
<h3 id="yum-cookbook">yum Cookbook</h3> <p>The following kitchen.yml file is part of the <code>yum</code> cookbook:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">driver</span>:<span style="color:#062873;font-weight:700">name</span>:vagrant<span style="color:#062873;font-weight:700">provisioner</span>:<span style="color:#062873;font-weight:700">name</span>:chef_zero<span style="color:#062873;font-weight:700">platforms</span>:- <span style="color:#062873;font-weight:700">name</span>:centos-7- <span style="color:#062873;font-weight:700">name</span>:centos-8- <span style="color:#062873;font-weight:700">name</span>:fedora-latest<span style="color:#062873;font-weight:700">suites</span>:- <span style="color:#062873;font-weight:700">name</span>:default<span style="color:#062873;font-weight:700">run_list</span>:- recipe[yum::default]- recipe[yum_test::test_repo]</code></pre></div>
<h3 id="platform-attributes">Platform Attributes</h3> <p>The following kitchen.yml file sets up a simple tiered configuration of the Chef Infra Server, including two front-end servers, a single back-end server, and two add-ons (Chef Push Jobs and Chef management console). The <code>platforms</code> block uses an <code>attributes</code> section to define Chef server-specific attributes that are used by all three test suites:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">driver</span>:<span style="color:#062873;font-weight:700">name</span>:vagrant<span style="color:#062873;font-weight:700">provisioner</span>:<span style="color:#062873;font-weight:700">name</span>:chef_zero<span style="color:#062873;font-weight:700">platforms</span>:- <span style="color:#062873;font-weight:700">name</span>:ubuntu-18.04<span style="color:#062873;font-weight:700">attributes</span>:<span style="color:#062873;font-weight:700">chef-server</span>:<span style="color:#062873;font-weight:700">api_fqdn</span>:backend.chef-server.com<span style="color:#062873;font-weight:700">backend</span>:<span style="color:#062873;font-weight:700">fqdn</span>:backend.chef-server.com<span style="color:#062873;font-weight:700">ipaddress</span>:<span style="color:#40a070">123.456.789.0</span><span style="color:#062873;font-weight:700">frontends</span>:<span style="color:#062873;font-weight:700">frontend1.chef-server.com</span>:<span style="color:#40a070">123.456.789.0</span><span style="color:#062873;font-weight:700">frontend2.chef-server.com</span>:<span style="color:#40a070">123.456.789.0</span><span style="color:#062873;font-weight:700">urls</span>:<span style="color:#062873;font-weight:700">private_chef</span>:http://123.456.789.0/path/to/private-chef_11.1.4-1_amd64.deb<span style="color:#062873;font-weight:700">manage</span>:http://123.456.789.0/path/to/opscode-manage_1.3.1-1_amd64.deb<span style="color:#062873;font-weight:700">push_jobs</span>:http://123.456.789.0/path/to/opscode-push-jobs-server_1.1.1-1_amd64.deb<span style="color:#062873;font-weight:700">suites</span>:- <span style="color:#062873;font-weight:700">name</span>:frontend1<span style="color:#062873;font-weight:700">driver</span>:<span style="color:#062873;font-weight:700">vm_hostname</span>:frontend1.chef-server.com<span style="color:#062873;font-weight:700">network</span>:- [<span style="color:#4070a0">"private_network"</span>,{<span style="color:#062873;font-weight:700">ip</span>:<span style="color:#4070a0">"123.456.789.0"</span>}]<span style="color:#062873;font-weight:700">customize</span>:<span style="color:#062873;font-weight:700">memory</span>:<span style="color:#40a070">2048</span><span style="color:#062873;font-weight:700">cpus</span>:<span style="color:#40a070">2</span><span style="color:#062873;font-weight:700">run_list</span>:- recipe[chef-server::configfile]- recipe[chef-server::ntp]- recipe[chef-server::server]- recipe[chef-server::frontend]- <span style="color:#062873;font-weight:700">name</span>:frontend2<span style="color:#062873;font-weight:700">driver</span>:<span style="color:#062873;font-weight:700">vm_hostname</span>:frontend2.chef-server.com<span style="color:#062873;font-weight:700">network</span>:- [<span style="color:#4070a0">"private_network"</span>,{<span style="color:#062873;font-weight:700">ip</span>:<span style="color:#4070a0">"123.456.789.0"</span>}]<span style="color:#062873;font-weight:700">customize</span>:<span style="color:#062873;font-weight:700">memory</span>:<span style="color:#40a070">2048</span><span style="color:#062873;font-weight:700">cpus</span>:<span style="color:#40a070">2</span><span style="color:#062873;font-weight:700">run_list</span>:- recipe[chef-server::configfile]- recipe[chef-server::ntp]- recipe[chef-server::server]- recipe[chef-server::frontend]- <span style="color:#062873;font-weight:700">name</span>:backend<span style="color:#062873;font-weight:700">driver</span>:<span style="color:#062873;font-weight:700">vm_hostname</span>:backend.chef-server.com<span style="color:#062873;font-weight:700">network</span>:- [<span style="color:#4070a0">"private_network"</span>,{<span style="color:#062873;font-weight:700">ip</span>:<span style="color:#4070a0">"123.456.789.0"</span>}]<span style="color:#062873;font-weight:700">customize</span>:<span style="color:#062873;font-weight:700">memory</span>:<span style="color:#40a070">8192</span><span style="color:#062873;font-weight:700">cpus</span>:<span style="color:#40a070">4</span><span style="color:#062873;font-weight:700">run_list</span>:- recipe[chef-server::configfile]- recipe[chef-server::ntp]- recipe[chef-server::server]- recipe[chef-server::backend]</code></pre></div>
<h3 id="kitchen-converge-on-system-reboot">Kitchen Converge On System Reboot</h3> <p>Test-Kitchen can handle reboots (when initiated from Chef Infra Client) by setting <code>retry_on_exit_code</code>, <code>max_retries</code> and <code>wait_for_retry</code> attributes on the provisioner in <code>kitchen.yml</code> file as follows :</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:700">provisioner</span>:<span style="color:#062873;font-weight:700">name</span>:chef_zero<span style="color:#062873;font-weight:700">retry_on_exit_code</span>:- <span style="color:#40a070">35</span><span style="color:#60a0b0;font-style:italic"># 35 is the exit code signaling that the node is rebooting</span>- <span style="color:#40a070">1</span><span style="color:#062873;font-weight:700">max_retries</span>:<span style="color:#40a070">1</span><span style="color:#062873;font-weight:700">client_rb</span>:<span style="color:#062873;font-weight:700">exit_status</span>::enabled<span style="color:#60a0b0;font-style:italic"># Opt-in to the standardized exit codes</span><span style="color:#062873;font-weight:700">client_fork</span>:<span style="color:#007020;font-weight:700">false</span><span style="color:#60a0b0;font-style:italic"># Forked instances don't return the real exit code</span></code></pre></div>
<p><strong>One note on Linux nodes</strong>: The shutdown command blocks (as opposed to the Windows variant which registers the reboot and returns right away), so once the timeout period passes, Chef Infra Client and the node are in a race to see who can exit/shutdown first - so you may or may not get the exit code out of Linux instances. In that case, you can add <code>1</code> to the <code>retry_on_exit_code</code> array and that should catch both cases.</p> <p>Please refer <a href="https://symfony.com/doc/current/components/yaml/yaml_format.html#collections">YAML documentation</a> to set <code>retry_on_exit_code</code> attribute.</p> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/workstation/config_yml_kitchen/" class="_attribution-link">https://docs.chef.io/workstation/config_yml_kitchen/</a>
  </p>
</div>
