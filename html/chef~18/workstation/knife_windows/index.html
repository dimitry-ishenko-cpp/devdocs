<div id="col-content" data-swiftype-index="true"> <div id="knife-windows"><h1>Knife Windows</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/chef-workstation/blob/main/docs-chef-io/content/workstation/knife_windows.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <h2 id="knife-windows-overview">Knife Windows Overview</h2> <p>The <code>knife windows</code> subcommand is used to interact with Windows systems managed by Chef Infra. Nodes are configured using WinRM, which allows external applications to call native objects like batch scripts, Windows PowerShell scripts, or scripting library variables. The <code>knife windows</code> subcommand supports NTLM and Kerberos methods of authentication.</p> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> Review the list of <a href="../knife_options/index.html">common options</a> available to this (and all) knife subcommands and plugins. </div> </div> <h3 id="requirements">Requirements</h3> <p>This subcommand requires WinRM to be installed, and then configured correctly, including ensuring the correct ports are open. For more information, see: <a href="https://docs.microsoft.com/en-us/windows/desktop/WinRM/installation-and-configuration-for-windows-remote-management">https://docs.microsoft.com/en-us/windows/desktop/WinRM/installation-and-configuration-for-windows-remote-management</a> and/or <a href="https://support.microsoft.com/en-us/help/968930/windows-management-framework-core-package-windows-powershell-2-0-and-w">https://support.microsoft.com/en-us/help/968930/windows-management-framework-core-package-windows-powershell-2-0-and-w</a>. Use the quick configuration option in WinRM to allow outside connections and the entire network path from knife (and the workstation). Run the following on the Windows target:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">C:<span style="color:#4070a0;font-weight:700">\&gt;</span> winrm quickconfig -q
</code></pre></div>
<p>Often commands can take longer than the default <code>MaxTimeoutms</code> WinRM configuration setting. Increase this value to <code>1800000</code> (30 minutes).</p> <p>To update this setting, run the following command on the Windows target:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">C:<span style="color:#4070a0;font-weight:700">\&gt;</span> winrm <span style="color:#007020">set</span> winrm/config <span style="color:#4070a0">'@{MaxTimeoutms="1800000"}'</span>
</code></pre></div>
<p>Ensure that the Windows Firewall is configured to allow WinRM connections between the workstation and the Chef Infra Server. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">C:<span style="color:#4070a0;font-weight:700">\&gt;</span> netsh advfirewall firewall <span style="color:#007020">set</span> rule <span style="color:#bb60d5">name</span><span style="color:#666">=</span><span style="color:#4070a0">"Windows Remote Management (HTTP-In)"</span> <span style="color:#bb60d5">profile</span><span style="color:#666">=</span>public <span style="color:#bb60d5">protocol</span><span style="color:#666">=</span>tcp <span style="color:#bb60d5">localport</span><span style="color:#666">=</span><span style="color:#40a070">5985</span> <span style="color:#bb60d5">remoteip</span><span style="color:#666">=</span>localsubnet new <span style="color:#bb60d5">remoteip</span><span style="color:#666">=</span>any
</code></pre></div>
<h3 id="negotiate-ntlm">Negotiate, NTLM</h3> <p>When knife is executed from a Microsoft Windows system, it is no longer necessary to make additional configuration of the WinRM listener on the target node to enable successful authentication from the workstation. It is sufficient to have a WinRM listener on the remote node configured to use the default configuration for <code>winrm quickconfig</code>. This is because <code>knife windows</code> supports the Microsoft Windows negotiate protocol, including NTLM authentication, which matches the authentication requirements for the default configuration of the WinRM listener.</p> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> To use Negotiate or NTLM to authenticate as the user specified by the <code>--winrm-user</code> option, include the userâ€™s Microsoft Windows domain, using the format <code>domain\user</code>, where the backslash (<code>\</code>) separates the domain from the user. </div> </div> <p>For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife winrm web1.cloudapp.net <span style="color:#4070a0">'dir'</span> -x <span style="color:#4070a0">'proddomain\webuser'</span> -P <span style="color:#4070a0">'password'</span>
</code></pre></div>
<p>and:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife winrm db1.cloudapp.net <span style="color:#4070a0">'dir'</span> -x <span style="color:#4070a0">'.\localadmin'</span> -P <span style="color:#4070a0">'password'</span>
</code></pre></div>
<h3 id="domain-authentication">Domain Authentication</h3> <p>The <code>knife windows</code> plugin supports Microsoft Windows domain authentication. This requires:</p> <ul> <li>An SSL certificate on the target node</li> <li>The certificate details can be viewed and its <a href="https://docs.microsoft.com/en-us/dotnet/framework/wcf/feature-details/how-to-view-certificates-with-the-mmc-snap-in">thumbprint hex values copied</a>
</li> </ul> <p>To create the listener over HTTPS, run the following command on the Windows target:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">C:<span style="color:#4070a0;font-weight:700">\&gt;</span> winrm create winrm/config/Listener?Address<span style="color:#666">=</span>IP:&lt;ip_address&gt;+Transport<span style="color:#666">=</span>HTTPS @<span style="color:#666">{</span><span style="color:#bb60d5">Hostname</span><span style="color:#666">=</span><span style="color:#4070a0">"&lt;fqdn&gt;"</span>;<span style="color:#bb60d5">CertificateThumbprint</span><span style="color:#666">=</span><span style="color:#4070a0">"&lt;hexidecimal_thumbprint_value&gt;"</span><span style="color:#666">}</span>
</code></pre></div>
<p>where the <code>CertificateThumbprint</code> is the thumbprint hex value copied from the certificate details. (The hex value may require that spaces be removed before passing them to the node using the <code>knife windows</code> plugin.) WinRM 2.0 uses port <code>5985</code> for HTTP and port <code>5986</code> for HTTPS traffic, by default.</p> <p>To validate communication with the Windows system using domain authentication run:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife winrm <span style="color:#4070a0">'node1.domain.com'</span> <span style="color:#4070a0">'dir'</span> -m -x domain<span style="color:#4070a0;font-weight:700">\\</span>administrator -P <span style="color:#4070a0">'super_secret_password'</span> -p <span style="color:#40a070">5986</span>
</code></pre></div>
<h2 id="cert-generate">cert generate</h2> <p>Use the <code>cert generate</code> argument to generate certificates for use with WinRM SSL listeners. This argument also generates a related public key file (in .pem format) to validate communication between listeners that are configured to use the generated certificate.</p> <h3 id="syntax">Syntax</h3> <p>This argument has the following syntax:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife windows cert generate FILE_PATH <span style="color:#666">(</span>options<span style="color:#666">)</span>
</code></pre></div>
<h3 id="options">Options</h3> <p>This argument has the following options:</p> <dl> <dt>
<code>-cp PASSWORD</code>, <code>--cert-passphrase PASSWORD</code>
</dt> <dd> <p>The password for the SSL certificate.</p> </dd> <dt>
<code>-cv MONTHS</code>, <code>--cert-validity MONTHS</code>
</dt> <dd> <p>The number of months for which a certificate is valid. Default value: <code>24</code>.</p> </dd> <dt>
<code>-h HOSTNAME</code>, <code>--hostname HOSTNAME</code>
</dt> <dd> <p>The hostname for the listener. For example, <code>--hostname something.mydomain.com</code> or <code>*.mydomain.com</code>. Default value: <code>*</code>.</p> </dd> <dt>
<code>-k LENGTH</code>, <code>--key-length LENGTH</code>
</dt> <dd> <p>The length of the key. Default value: <code>2048</code>.</p> </dd> <dt>
<code>-o PATH</code>, <code>--output-file PATH</code>
</dt> <dd> <p>The location in which the <code>winrmcert.b64</code>, <code>winrmcert.pem</code>, and <code>winrmcert.pfx</code> files are generated. For example: <code>--output-file /home/.winrm/server_cert</code> will create <code>server_cert.b64</code>, <code>server_cert.pem</code>, and <code>server_cert.pfx</code> in the <code>server_cert</code> directory. Default location: <code>current_directory/winrmcert</code>.</p> </dd> </dl> <h2 id="cert-install">cert install</h2> <p>Use the <code>cert install</code> argument to install a certificate (such as one generated by the <code>cert generate</code> argument) into the Microsoft Windows certificate store so that it may be used as the SSL certificate by a WinRM listener.</p> <h3 id="syntax-1">Syntax</h3> <p>This argument has the following syntax:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife windows cert install CERT <span style="color:#666">[</span>CERT<span style="color:#666">]</span> <span style="color:#666">(</span>options<span style="color:#666">)</span>
</code></pre></div>
<h3 id="options-1">Options</h3> <p>This argument has the following options:</p> <dl> <dt>
<code>-cp PASSWORD</code>, <code>--cert-passphrase PASSWORD</code>
</dt> <dd> <p>The password for the SSL certificate.</p> </dd> </dl> <h2 id="listener-create">listener create</h2> <p>Use the <code>listener create</code> argument to create a WinRM listener on the Microsoft Windows platform.</p> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> This command may only be used on the Microsoft Windows platform. </div> </div> <h3 id="syntax-2">Syntax</h3> <p>This argument has the following syntax:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife windows listener create <span style="color:#666">(</span>options<span style="color:#666">)</span>
</code></pre></div>
<h3 id="options-2">Options</h3> <p>This argument has the following options:</p> <dl> <dt>
<code>-c CERT_PATH</code>, <code>--cert-install CERT_PATH</code>
</dt> <dd> <p>Add the specified certificate to the store before creating the listener.</p> </dd> <dt>
<code>-cp PASSWORD</code>, <code>--cert-passphrase PASSWORD</code>
</dt> <dd> <p>The password for the SSL certificate.</p> </dd> <dt>
<code>-h HOST_NAME</code>, <code>--hostname HOST_NAME</code>
</dt> <dd> <p>The hostname for the listener. For example, <code>--hostname something.mydomain.com</code> or <code>*.mydomain.com</code>. Default value: <code>*</code>.</p> </dd> <dt>
<code>-p PORT</code>, <code>--port PORT</code>
</dt> <dd> <p>The WinRM port. Default value: <code>5986</code>.</p> </dd> <dt>
<code>-t THUMBPRINT</code>, <code>--cert-thumbprint THUMBPRINT</code>
</dt> <dd> <p>The thumbprint of the SSL certificate. Required when the <code>--cert-install</code> option is not part of a command.</p> </dd> </dl> <h2 id="winrm">winrm</h2> <p>Use the <code>winrm</code> argument to create a connection to one or more remote machines. As each connection is created, a password must be provided. This argument uses the same syntax as the <code>search</code> subcommand.</p> <p>WinRM requires that a target node be accessible via the ports configured to support access via HTTP or HTTPS.</p> <h3 id="syntax-3">Syntax</h3> <p>This argument has the following syntax:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife winrm SEARCH_QUERY SSH_COMMAND <span style="color:#666">(</span>options<span style="color:#666">)</span>
</code></pre></div>
<h3 id="options-3">Options</h3> <p>This argument has the following options:</p> <dl> <dt>
<code>-a ATTR</code>, <code>--attribute ATTR</code>
</dt> <dd> <p>The attribute used when opening a connection. The default attribute is the FQDN of the host. Other possible values include a public IP address, a private IP address, or a hostname.</p> </dd> <dt>
<code>-C NUM</code>, <code>--concurrency NUM</code>
</dt> <dd> <p>Changed in knife-windows 1.9.0. The number of allowed concurrent connections. Defaults to 1.</p> </dd> <dt>
<code>-f CA_TRUST_FILE</code>, <code>--ca-trust-file CA_TRUST_FILE</code>
</dt> <dd> <p>Optional. The certificate authority (CA) trust file used for SSL transport.</p> </dd> <dt>
<code>-p PORT</code>, <code>--winrm-port PORT</code>
</dt> <dd> <p>The WinRM port. The TCP port on the remote system to which <code>knife windows</code> commands that are made using WinRM are sent. Default: <code>5986</code> when <code>--winrm-transport</code> is set to <code>ssl</code>, otherwise <code>5985</code>.</p> </dd> <dt>
<code>-P PASSWORD</code>, <code>--winrm-password PASSWORD</code>
</dt> <dd> <p>The WinRM password.</p> </dd> <dt>
<code>-R KERBEROS_REALM</code>, <code>--kerberos-realm KERBEROS_REALM</code>
</dt> <dd> <p>Optional. The administrative domain to which a user belongs.</p> </dd> <dt><code>--returns CODES</code></dt> <dd> <p>A comma-delimited list of return codes that indicate the success or failure of the command that was run remotely.</p> </dd> <dt>
<code>-S KERBEROS_SERVICE</code>, <code>--kerberos-service KERBEROS_SERVICE</code>
</dt> <dd> <p>Optional. The service principal used during Kerberos-based authentication.</p> </dd> <dt><code>SEARCH_QUERY</code></dt> <dd> <p>The search query used to return a list of servers to be accessed using SSH and the specified <code>SSH_COMMAND</code>. This option uses the same syntax as the search subcommand.</p> </dd> <dt><code>SSH_COMMAND</code></dt> <dd> <p>The command to be run against the results of a search query.</p> </dd> <dt><code>--session-timeout MINUTES</code></dt> <dd> <p>The amount of time (in minutes) for the maximum length of a WinRM session.</p> </dd> <dt><code>--ssl-peer-fingerprint FINGERPRINT</code></dt> <dd> <p>SSL Cert Fingerprint to bypass normal cert chain checks</p> </dd> <dt>
<code>-t TRANSPORT</code>, <code>--winrm-transport TRANSPORT</code>
</dt> <dd> <p>The WinRM transport type. Possible values: <code>ssl</code> or <code>plaintext</code>.</p> </dd> <dt>
<code>-T</code>, <code>--keytab-file KEYTAB_FILE</code>
</dt> <dd> <p>The keytab file that contains the encryption key required by Kerberos-based authentication.</p> </dd> <dt><code>--winrm-authentication-protocol PROTOCOL</code></dt> <dd> <p>The authentication protocol to be used during WinRM communication. Possible values: <code>basic</code>, <code>kerberos</code> or <code>negotiate</code>. Default value: <code>negotiate</code>.</p> </dd> <dt><code>--winrm-codepage Codepage</code></dt> <dd> <p>The codepage to use for the WinRM Command Shell</p> </dd> <dt><code>--winrm-shell SHELL</code></dt> <dd> <p>The WinRM shell type. Valid choices are <code>cmd</code>, <code>powershell</code> or <code>elevated</code>. Default value: <code>cmd</code>. The <code>elevated</code> shell is similar to the <code>powershell</code> option, but runs the powershell command from a scheduled task.</p> </dd> <dt><code>--winrm-ssl-verify-mode MODE</code></dt> <dd> <p>The peer verification mode that is used during WinRM communication. Possible values: <code>verify_none</code> or <code>verify_peer</code>. Default value: <code>verify_peer</code>.</p> </dd> <dt>
<code>-x USERNAME</code>, <code>--winrm-user USERNAME</code>
</dt> <dd> <p>The WinRM user name.</p> </dd> </dl> <h2 id="examples">Examples</h2> <p><strong>Find Uptime for Web Servers</strong></p> <p>To find the uptime of all web servers, enter:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife winrm <span style="color:#4070a0">"role:web"</span> <span style="color:#4070a0">"net stats srv"</span> -x Administrator -P password
</code></pre></div>
<p><strong>Force a Chef Infra Client run</strong></p> <p>To force a Chef Infra Client run:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife winrm <span style="color:#4070a0">'ec2-50-xx-xx-124.amazonaws.com'</span> <span style="color:#4070a0">'chef-client -c c:/chef/client.rb'</span> -m -x admin -P <span style="color:#4070a0">'password'</span>
ec2-50-xx-xx-124.amazonaws.com <span style="color:#666">[</span>date<span style="color:#666">]</span> INFO: Starting Chef Run <span style="color:#666">(</span>Version 0.9.12<span style="color:#666">)</span>
ec2-50-xx-xx-124.amazonaws.com <span style="color:#666">[</span>date<span style="color:#666">]</span> WARN: Node ip-0A502FFB has an empty run list.
ec2-50-xx-xx-124.amazonaws.com <span style="color:#666">[</span>date<span style="color:#666">]</span> INFO: Chef Run <span style="color:#007020">complete</span> in 4.383966 seconds
ec2-50-xx-xx-124.amazonaws.com <span style="color:#666">[</span>date<span style="color:#666">]</span> INFO: cleaning the checksum cache
ec2-50-xx-xx-124.amazonaws.com <span style="color:#666">[</span>date<span style="color:#666">]</span> INFO: Running report handlers
ec2-50-xx-xx-124.amazonaws.com <span style="color:#666">[</span>date<span style="color:#666">]</span> INFO: Report handlers <span style="color:#007020">complete</span>
</code></pre></div>
<p>Where in the examples above, <code>[date]</code> represents the date and time the long entry was created. For example: <code>[Fri, 04 Mar 2011 22:00:53 +0000]</code>.</p> <p><strong>Generate an SSL certificate, and then create a listener</strong></p> <p>Use the <code>listener create</code>, <code>cert generate</code>, and <code>cert install</code> arguments to create a new listener and assign it a newly-generated SSL certificate. First, make sure that WinRM is enabled on the machine. Do so by running the following command on the Windows node:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">C:<span style="color:#4070a0;font-weight:700">\&gt;</span> winrm quickconfig
</code></pre></div>
<p>Create the SSL certificate</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife windows cert generate --domain myorg.org --output-file <span style="color:#bb60d5">$env</span>:userprofile/winrmcerts/winrm-ssl
</code></pre></div>
<p>This command may be run on any machine and will output three file types: <code>.b64</code>, <code>.pem</code>, and <code>.pfx</code>.</p> <p>Next, create the SSL listener:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife windows listener create --hostname *.myorg.org --cert-install <span style="color:#bb60d5">$env</span>:userprofile/winrmcerts/winrm-ssl.pfx
</code></pre></div>
<p>This will use the same <code>.pfx</code> file that was output by the <code>cert generate</code> argument. If the command is run on a different machine from that which generated the certificates, the required certificate files must first be transferred securely to the system on which the listener will be created. (Use the <code>cert install</code> argument to install a certificate on a machine.)</p> <p>The SSL listener is created and should be listening on TCP port <code>5986</code>, which is the default WinRM SSL port.</p> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/workstation/knife_windows/" class="_attribution-link">https://docs.chef.io/workstation/knife_windows/</a>
  </p>
</div>
