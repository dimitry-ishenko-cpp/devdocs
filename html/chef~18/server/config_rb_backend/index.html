<div id="col-content" data-swiftype-index="true"> <div id="chef-backendrb-settings"><h1>chef-backend.rb Settings</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/chef-server/blob/main/docs-chef-io/content/server/config_rb_backend.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <div class="admonition-warning">
<p class="admonition-warning-title">Warning</p>
<div class="admonition-warning-text"> <p>Chef Backend is <a href="../../versions/index.html#deprecated-products-and-versions">deprecated</a> and no longer under active development. Contact your Chef account representative for information about migrating to Chef Automate HA.</p> <p>This document is no longer maintained.</p> </div>
</div> <h2 id="chef-backendrb-options">chef-backend.rb Options</h2> <p>Run <code>chef-backend-ctl gen-sample-backend-config</code> to generate the <code>chef-backend.rb</code> file. This will control most of the various feature and configuration flags going into a Chef HA backend node. A number of these options control the reliability, stability, and uptime of the backend PostgreSQL databases, the Elasticsearch index, and the leader election system. Please refrain from changing them unless you have been advised to do so.</p> <dl> <dt>The following settings are the only settings you should modify without guidance:</dt> <dt><code>fqdn</code></dt> <dd>Host name of this node.</dd> <dt><code>hide_sensitive</code></dt> <dd>Set to <code>false</code> if you wish to print deltas of sensitive files and templates during <code>chef-backend-ctl reconfigure</code> runs.</dd> <dd>Default value: <code>true</code>.</dd> <dt><code>ip_version</code></dt> <dd>Set to either <code>'ipv4'</code> or <code>'ipv6'</code>.</dd> <dd>Default value: <code>'ipv4'</code>.</dd> <dt><code>publish_address</code></dt> <dd>Externally resolvable IP address of this back-end node.</dd> </dl> <h3 id="common-runit-flags-for-any-backend-service">Common ‘Runit’ Flags for Any Backend Service</h3> <p>See <a href="https://github.com/chef-cookbooks/runit">https://github.com/chef-cookbooks/runit</a> for details. Many of the flags are repeated across the various backend services, but they are only documented once at the top here. The same defaults are used unless specified below.</p> <dl> <dt><code>postgresql.enable</code></dt> <dd>Sets up and runs the postgresql service.</dd> <dd>Default value: <code>true</code>.</dd> <dt><code>postgresql.environment</code></dt> <dd>A hash of environment variables with their values as content used in the service’s env directory.</dd> <dt><code>postgresql.log_directory</code></dt> <dd>The directory where the <code>svlogd</code> log service will run.</dd> <dd>Default value: <code>'/var/log/chef-backend/postgresql/&lt;version&gt;'</code>.</dd> <dt><code>postgresql.log_rotation.file_maxbytes</code></dt> <dd>The maximum size a log file can grow to before it is automatically rotated.</dd> <dd>Default value: <code>104857600</code> (100MB).</dd> <dt><code>postgresql.log_rotation.num_to_keep</code></dt> <dd>The maximum number of log files that will be retained after rotation.</dd> <dd>Default value: <code>10</code>.</dd> <dt><code>etcd.enable</code></dt> <dd>Sets up and runs the etcd service.</dd> <dd>Default value: <code>true</code>.</dd> <dt><code>etcd.log_directory</code></dt> <dd>The directory where the <code>svlogd</code> log service will run.</dd> <dd>Default value: <code>'/var/log/chef-backend/etcd'</code>.</dd> <dt><code>etcd.log_rotation.file_maxbytes</code></dt> <dd>The maximum size a log file can grow to before it is automatically rotated.</dd> <dd>Default value: <code>104857600</code> (100MB).</dd> <dt><code>etcd.log_rotation.num_to_keep</code></dt> <dd>The maximum number of log files that will be retained after rotation.</dd> <dd>Default value: <code>10</code>.</dd> <dt><code>elasticsearch.enable</code></dt> <dd>Sets up and runs the elasticsearch service.</dd> <dd>Default value: <code>true</code>.</dd> <dt><code>elasticsearch.log_directory</code></dt> <dd>The directory where the <code>svlogd</code> log service will run. Also affects <code>path.logs</code> in the Elasticsearch configuration YAML.</dd> <dd>Default value: <code>'/var/log/chef-backend/elasticsearch'</code>.</dd> <dt><code>elasticsearch.log_rotation.file_maxbytes</code></dt> <dd>The maximum size a log file can grow to before it is automatically rotated.</dd> <dd>Default value: <code>104857600</code> (100MB).</dd> <dt><code>elasticsearch.log_rotation.num_to_keep</code></dt> <dd>The maximum number of log files that will be retained after rotation.</dd> <dd>Default value: <code>10</code>.</dd> <dt><code>leaderl.enable</code></dt> <dd>Sets up and runs the leaderl service.</dd> <dd>Default value: <code>true</code>.</dd> <dt><code>leaderl.log_directory</code></dt> <dd>The directory where the <code>svlogd</code> log service will run.</dd> <dd>Default value: <code>'/var/log/chef-backend/leaderl'</code>.</dd> <dt><code>leaderl.start_down</code></dt> <dd>The default state of the runit service to <code>down</code> by creating <code>&lt;sv_dir&gt;/down</code> file.</dd> <dd>Default value: <code>true</code>.</dd> <dt><code>leaderl.log_rotation.file_maxbytes</code></dt> <dd>The maximum size a log file can grow to before it is automatically rotated.</dd> <dd>Default value: <code>104857600</code> (100MB).</dd> <dt><code>leaderl.log_rotation.num_to_keep</code></dt> <dd>The maximum number of log files that will be retained after rotation.</dd> <dd>Default value: <code>10</code>.</dd> </dl> <h3 id="postgresql-settings">PostgreSQL Settings</h3> <dl> <dt><code>postgresql.db_superuser</code></dt> <dd>Super user account to create. Password is in <code>chef-backend-secrets.json</code>.</dd> <dd>Default value: <code>'chef_pgsql'</code>.</dd> <dt><code>postgresql.md5_auth_cidr_addresses</code></dt> <dd>A list of authorized addresses from which other backend nodes can connect to perform streaming replication. <code>samehost</code> and <code>samenet</code> are special symbols to allow connections from the this node’s IP address and its subnet. You may also use <code>all</code> to match any IP address. You may specify a hostname or IP address in CIDR format (<code>172.20.143.89/32</code> for a single host, or <code>172.20.143.0/24</code> for a small network. See <a href="https://www.postgresql.org/docs/9.5/static/auth-pg-hba-conf.html">https://www.postgresql.org/docs/9.5/static/auth-pg-hba-conf.html</a> for alternative formats.</dd> <dd>Default value: <code>["samehost", "samenet"]</code>.</dd> <dt><code>postgresql.replication_user</code></dt> <dd>Username used by postgres streaming replicator when accessing this node.</dd> <dd>Default value: <code>'replicator'</code>.</dd> <dt><code>postgresql.username</code></dt> <dd>System username that the postgres process will run as.</dd> <dd>Default value: <code>'chef_pgsql'</code>.</dd> </dl> <h3 id="postgresql-settings-given-to-postgresqlconf">PostgreSQL Settings Given to <code>postgresql.conf</code>
</h3> <p>See <a href="https://www.postgresql.org/docs/9.5/static/runtime-config.html">PostgreSQL’s documentation</a> for details. Some defaults are provided:</p> <dl> <dt><code>postgresql.archive_command</code></dt> <dd>Default value: <code>''</code>.</dd> <dt><code>postgresql.archive_mode</code></dt> <dd>Default value: <code>'off'</code>.</dd> <dt><code>postgresql.archive_timeout</code></dt> <dd>Default value: <code>0</code>.</dd> <dt><code>postgresql.checkpoint_completion_target</code></dt> <dd>Default value: <code>0.5</code>.</dd> <dt><code>postgresql.checkpoint_timeout</code></dt> <dd>Default value: <code>'5min'</code>.</dd> <dt><code>postgresql.checkpoint_warning</code></dt> <dd>Default value: <code>'30s'</code>.</dd> <dt><code>postgresql.effective_cache_size</code></dt> <dd>Automatically calculated based on available memory.</dd> <dt><code>postgresql.hot_standby</code></dt> <dd>Default value: <code>'on'</code>.</dd> <dt><code>postgresql.keepalives_count</code></dt> <dd>Sets <code>tcp_keepalives_count</code>.</dd> <dd>Default value: <code>2</code>.</dd> <dt><code>postgresql.keepalives_idle</code></dt> <dd>Sets <code>tcp_keepalives_idle</code>.</dd> <dd>Default value: <code>60</code>.</dd> <dt><code>postgresql.keepalives_interval</code></dt> <dd>Sets <code>tcp_keepalives_interval</code>.</dd> <dd>Default value: <code>15</code>.</dd> <dt><code>postgresql.log_checkpoints</code></dt> <dd>Default value: <code>true</code>.</dd> <dt><code>postgresql.log_min_duration_statement</code></dt> <dd>Default value: <code>-1</code>.</dd> <dt><code>postgresql.max_connections</code></dt> <dd>Default value: <code>350</code>.</dd> <dt><code>postgresql.max_replication_slots</code></dt> <dd>Default value: <code>12</code>.</dd> <dt><code>postgresql.max_wal_senders</code></dt> <dd>Default value: <code>12</code>.</dd> <dt><code>postgresql.max_wal_size</code></dt> <dd>Default value: <code>64</code>.</dd> <dt><code>postgresql.min_wal_size</code></dt> <dd>Default value: <code>5</code>.</dd> <dt><code>postgresql.port</code></dt> <dd>Default value: <code>5432</code>.</dd> <dt><code>postgresql.shared_buffers</code></dt> <dd>Automatically calculated based on available memory.</dd> <dt><code>postgresql.wal_keep_segments</code></dt> <dd>Default value: <code>32</code>.</dd> <dt><code>postgresql.wal_level</code></dt> <dd>Default value: <code>'hot_standby'</code>.</dd> <dt><code>postgresql.wal_log_hints</code></dt> <dd>Default value: <code>on</code>.</dd> <dt><code>postgresql.work_mem</code></dt> <dd>Default value: <code>'8MB'</code>.</dd> </dl> <h3 id="etcd-settings">etcd Settings</h3> <dl> <dt><code>etcd.client_port</code></dt> <dd>Port to use for ETCD_LISTEN_CLIENT_URLS and ETCD_ADVERTISE_CLIENT_URLS.</dd> <dd>Default value: <code>2379</code>.</dd> <dt><code>etcd.peer_port</code></dt> <dd>Port to use for ETCD_LISTEN_PEER_URLS and ETCD_ADVERTISE_PEER_URLS.</dd> <dd>Default value: <code>2380</code>.</dd> </dl> <p>The following settings relate to etcd’s consensus protocol. Chef Backend builds its own leader election on top of etcd’s consensus protocol. Updating these settings may be advisable if you are seeing frequent failover events as a result of spurious etcd connection timeouts. The current defaults assume a high-latency environment, such as those you might find if deploying Chef Backend to various cloud providers.</p> <dl> <dt><code>etcd.heartbeat_interval</code></dt> <dd>ETCD_HEARTBEAT_INTERVAL in milliseconds. This is the frequency at which the leader will send heartbeats to followers. etcd’s documentation recommends that this is set roughly to the round-trip times between members.</dd> <dd>Default value: <code>500</code>, (<code>100</code> by default before Chef Backend 1.2).</dd> <dt><code>etcd.election_timeout</code></dt> <dd>ETCD_ELECTION_TIMEOUT in milliseconds. This controls how long an etcd node will wait for heartbeat before triggering an election. Per etcd’s documentation, this should be 5 to 10 times larger than the <code>etcd.heartbeat_interval</code>. Increasing <code>etcd.election_timeout</code> increases the time it will take for <code>etcd</code> to detect a failure.</dd> <dd>Default value: <code>5000</code>, (<code>1000</code> by default before Chef Backend 1.2).</dd> <dt><code>etcd.snapshot_count</code></dt> <dd>ETCD_SNAPSHOT_COUNT which is the number of committed transactions to trigger a snapshot to disk.</dd> <dd>Default value: <code>5000</code>.</dd> <dt><code>etcd.ionice.class</code></dt> <dd>etcd must be able to write to disk with minimal latency. If your cluster does not meet the <a href="../install_server_ha/index.html#hardware-requirements">disk requirements</a>, e.g. you are running Chef Backend on virtual machines with shared disks, this settings should be changed to ‘1’ (real-time scheduling) to mitigate unnecessary failovers under high latency conditions.</dd> <dd>Default value: <code>2</code>.</dd> <dd>New in Chef Backend 2.2.</dd> <dt><code>etcd.ionice.level</code></dt> <dd>This may be changed for further tuning to specific environments if <code>etcd.ionice.class</code> is changed, but in almost all cases it should not be modified.</dd> <dd>Default value: <code>0</code>.</dd> <dd>New in Chef Backend 2.2.</dd> </dl> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> Even though the defaults assume a high-latency environment, cloud deployments should be restricted to the same datacenter, or in AWS, in the same region. This means that geographically-dispersed cluster deployments are not supported. Multiple Availability Zones <em>are</em> supported as long as they are in the same region. </div> </div> <p>See <a href="https://etcd.io/docs/latest/tuning/">etcd’s documentation on tunables</a> for more information.</p> <h3 id="elasticsearch-jvm-settings">Elasticsearch JVM Settings</h3> <dl> <dt><code>elasticsearch.heap_size</code></dt> <dd>Automatically computed by Elasticsearch based on available memory. Specify in MB if you wish to override.</dd> <dt><code>elasticsearch.java_opts</code></dt> <dd>Flags to directly pass to the JVM when launching Elasticsearch. If you override a heap flag here, the setting here takes precedence.</dd> <dt><code>elasticsearch.new_size</code></dt> <dd>Java heap’s new generation size.</dd> </dl> <h3 id="elasticsearch-configuration">Elasticsearch Configuration</h3> <p>See <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/settings.html">Elasticsearch’s configuration documentation</a> for additional information.</p> <dl> <dt><code>elasticsearch.plugins_directory</code></dt> <dd>Sets the <code>path.plugins</code> value.</dd> <dd>Default value: <code>'/var/opt/chef-backend/elasticsearch/plugins'</code>.</dd> <dt><code>elasticsearch.port</code></dt> <dd>Sets the <code>http.port</code> value.</dd> <dd>Default value: <code>9200</code>.</dd> <dt><code>elasticsearch.scripts_directory</code></dt> <dd>Sets the <code>path.scripts</code> value.</dd> <dd>Default value: <code>'/var/opt/chef-backend/elasticsearch/scripts'</code>.</dd> </dl> <h3 id="chef-ha-backend-leader-management-service-settings">Chef HA Backend Leader Management Service Settings</h3> <dl> <dt><code>leaderl.db_timeout</code></dt> <dd>Socket timeout when connecting to PostgreSQL in milliseconds.</dd> <dd>Default value: <code>2000</code>.</dd> <dt><code>leaderl.http_acceptors</code></dt> <dd>HTTP threads that responds to monitoring and leadership status requests from HAProxy.</dd> <dd>Default value: <code>10</code>.</dd> <dt><code>leaderl.http_address</code></dt> <dd>The address that leaderl listens on. This address should not be <code>127.0.0.1</code>. It should be reachable from any front-end node.</dd> <dd>Default value: <code>'0.0.0.0'</code>.</dd> <dt><code>leaderl.http_port</code></dt> <dd>Default value: <code>7331</code>.</dd> <dt><code>leaderl.leader_ttl_seconds</code></dt> <dd>The number of seconds it takes the leader key to expire. Increasing this value will increase the amount of time the cluster will take to recognize a failed leader. Lowering this value may lead to frequent leadership changes and thrashing.</dd> <dd>Default value: <code>30</code>. (<code>10</code> by default before Chef Backend 1.2).</dd> <dt><code>leaderl.required_active_followers</code></dt> <dd>The number of followers that must be syncing via a PostgreSQL replication slot before a new leader will return 200 to /leader HTTP requests. If an existing leader fails to maintain this quorum of followers, the /leader endpoint will return 503 but active connections will still be able to complete their writes to the database.</dd> <dd>Default value: <code>0</code>.</dd> <dt><code>leaderl.runsv_group</code></dt> <dd>The group that sensitive password files will belong to. This is used internally for test purposes and should never be modified otherwise.</dd> <dd>Default value: <code>'chef_pgsql'</code>.</dd> <dt><code>leaderl.status_internal_update_interval_seconds</code></dt> <dd>How often we check for a change in the leader service’s status in seconds.</dd> <dd>Default value: <code>5</code>.</dd> <dt><code>leaderl.status_post_update_interval_seconds</code></dt> <dd>How often etcd is updated with the leader service’s current status in seconds.</dd> <dd>Default value: <code>10</code>.</dd> <dt><code>leaderl.username</code></dt> <dd>System username that the leaderl process will run as. Usually the same as <code>postgresql.username</code>.</dd> <dd>Default value: <code>'chef_pgsql'</code>.</dd> <dt><code>leaderl.log_rotation.max_messages_per_second</code></dt> <dd>Rate limit for the number of messages that the Erlang error_logger will output.</dd> <dd>Default value: <code>1000</code>.</dd> <dt><code>leaderl.etcd_pool.ibrowse_options</code></dt> <dd>Internal options to affect how requests to etcd are made (see <a href="https://github.com/cmullaparthi/ibrowse/blob/master/doc/ibrowse.html">https://github.com/cmullaparthi/ibrowse/blob/master/doc/ibrowse.html</a>).</dd> <dt><code>leaderl.epmd_monitor.check_interval</code></dt> <dd>How often to check that leaderl is registered with the Erlang Port Mapping Daemon (epmd) in milliseconds.</dd> <dd>Default value: <code>60000</code>.</dd> </dl> <h3 id="chef-ha-backend-leader-health-status-settings">Chef HA Backend Leader Health Status Settings</h3> <dl> <dt><code>leaderl.health_check.interval_seconds</code></dt> <dd>How frequently to poll the service for health status in seconds. We recommend setting this to at least 5 times the value of <code>leaderl.leader_ttl_seconds</code>.</dd> <dd>Default value: <code>5</code>, (<code>2</code> by default before version Chef Backend 1.2).</dd> <dt><code>leaderl.health_check.max_bytes_behind_leader</code></dt> <dd>Limit on maximum different between elected leader and current node in bytes.</dd> <dd>Default value: <code>52428800</code> (50MB).</dd> <dt><code>leaderl.health_check.max_elasticsearch_failures</code></dt> <dd>Number of Elasticsearch API failures allowed before health check fails.</dd> <dd>Default value: <code>5</code>.</dd> <dt><code>leaderl.health_check.max_etcd_failures</code></dt> <dd>Number of etcd failures allowed before health check fails.</dd> <dd>Default value: <code>5</code>.</dd> <dt><code>leaderl.health_check.max_pgsql_failures</code></dt> <dd>Number of PostgreSQL connection failures allowed before health check fails.</dd> <dd>Default value: <code>5</code>.</dd> <dt><code>leaderl.health_check.fatal_system_checks</code></dt> <dd>Whether or not system check failures (such as disk space failures) will result in the node being marked ineligible for leadership.</dd> <dd>Default value: <code>false</code>.</dd> <dd>New in Chef Backend 1.4.</dd> <dt><code>leaderl.health_check.disk_paths</code></dt> <dd>An array containing the paths to check for sufficient disk space.</dd> <dd>Default value: <code>[/var/log/chef-backend, /var/opt/chef-backend]</code>.</dd> <dd>New in Chef Backend 1.4.</dd> <dt><code>leaderl.health_check.disk_min_space_mb</code></dt> <dd>The minimum amount of disk space (in megabytes) required for a disk health check to pass.</dd> <dd>Default value: <code>250</code>.</dd> <dd>New in Chef Backend 1.4.</dd> </dl> <h3 id="chef-ha-backend-leader-connection-pool-settings">Chef HA Backend Leader Connection Pool Settings</h3> <p>See <a href="https://github.com/seth/pooler/blob/master/README.org">https://github.com/seth/pooler/blob/master/README.org</a> for details. These are internal settings that affect the responsiveness, uptime and reliability of the backend cluster. They should not be modified unless you are advised to do so by Support.</p> <dl> <dt><code>leaderl.etcd_pool.cull_interval_seconds</code></dt> <dd>Default value: <code>60</code>.</dd> <dt><code>leaderl.etcd_pool.http_timeout_ms</code></dt> <dd>Default value: <code>5000</code>.</dd> <dt><code>leaderl.etcd_pool.init_count</code></dt> <dd>Default value: <code>10</code>.</dd> <dt><code>leaderl.etcd_pool.max_age_seconds</code></dt> <dd>Default value: <code>60</code>.</dd> <dt><code>leaderl.etcd_pool.max_connection_duration_seconds</code></dt> <dd>Default value: <code>300</code>.</dd> <dt><code>leaderl.etcd_pool.max_count</code></dt> <dd>Default value: <code>10</code>.</dd> </dl> <h3 id="ssl-settings">SSL Settings</h3> <p>If <code>certificate</code> and <code>certificate_key</code> are nil, the SSL Certificate will be auto-generated using the other parameters provided. Otherwise, they are on-disk locations to user-provided certificate.</p> <dl> <dt><code>ssl.certificate</code></dt> <dd>Provide this path if you have a pre-generated SSL cert.</dd> <dt><code>ssl.certificate_key</code></dt> <dd>Provide this path if you have a pre-generated SSL cert.</dd> <dt><code>ssl.ciphers</code></dt> <dd>Ordered list of allowed SSL ciphers. This will be updated based on security considerations and the version of OpenSSL being shipped.</dd> <dt><code>ssl.company_name</code></dt> <dd>The name of your organization.</dd> <dt><code>ssl.country_name</code></dt> <dd>The two-character country code.</dd> <dt><code>ssl.data_dir</code></dt> <dd>Where certificates will be stored.</dd> <dd>Default value: <code>'/var/opt/chef-backend/ssl/'</code>.</dd> <dt><code>ssl.duration</code></dt> <dd>The duration of the certificate in days.</dd> <dd>Default value: <code>3650</code> (10 years).</dd> <dt><code>ssl.key_length</code></dt> <dd>Default value: <code>2048</code>.</dd> <dt><code>ssl.organizational_unit_name</code></dt> <dd>The name of the division in your organization.</dd> </dl> <h2 id="chef-backend-ctl">chef-backend-ctl</h2> <p>The Chef Infra Server backend HA cluster includes a command-line utility named chef-backend-ctl. This command-line tool is used to manage the Chef Infra Server backend HA cluster, start and stop individual services, and tail Chef Infra Server log files. For more information, see the <a href="../ctl_chef_backend/index.html">chef-backend-ctl documentation</a>.</p> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/server/config_rb_backend/" class="_attribution-link">https://docs.chef.io/server/config_rb_backend/</a>
  </p>
</div>
