<div id="col-content" data-swiftype-index="true"> <div id="high-availability-upgrade-to-chef-backend-2"><h1>High Availability: Upgrade to Chef Backend 2</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/chef-server/blob/main/docs-chef-io/content/server/upgrade_server_ha_v2.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <div class="admonition-warning">
<p class="admonition-warning-title">Warning</p>
<div class="admonition-warning-text"> <p>Chef Backend is <a href="../../versions/index.html#deprecated-products-and-versions">deprecated</a> and no longer under active development. Contact your Chef account representative for information about migrating to Chef Automate HA.</p> <p>This document is no longer maintained.</p> </div>
</div> <p>This topic describes the process of upgrading a high availability Chef Infra Server cluster.</p> <p>The Chef Infra Server 14 upgrade process requires downtime for stopping the server, installing the new package, and then upgrading the server, which will include an automatic Elasticsearch reindexing operation for existing Solr users. We estimate the reindexing operation will take 2 minutes for each 1000 nodes, but the it could take more time, depending on your server hardware and the complexity of your Chef data.</p> <h2 id="overview">Overview</h2> <p>These instructions cover the process of upgrading a Chef Backend cluster. Please refer to the appropriate directions for the version of Chef Backend that you are using and the version that you intend to upgrade to:</p> <h2 id="update-chef-backend">Update Chef Backend</h2> <p>The minor version update is appropriate for all upgrades of a Chef Backend cluster within a version. For example, updating from 1.x to 1.x or 2.x to 2.x.</p> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> The procedure assumes that the new chef-backend package has been copied to all of the nodes. </div> </div> <h3 id="step-1-block-failover">Step 1: Block Failover</h3> <p>We donâ€™t want the cluster to fail over to a follower that is in the process of being updated. So we start by disabling failover:</p> <ol> <li>Run <code>chef-backend-ctl set-cluster-failover off</code>
</li> </ol> <h3 id="step-2-update-the-followers">Step 2: Update the followers</h3> <p>Followers should be updated sequentially. Upgrading them simultaneously is not supported and may result in data loss. Verify the successful rejoin after each upgrade.</p> <ol> <li> <p>Install the new chef-backend package:</p> <p>RHEL and CentOS:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">yum install PATH_TO_FILE.rpm
</code></pre></div>
<p>Debian and Ubuntu:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">dpkg -i PATH_TO_FILE.deb
</code></pre></div>
<p>You may also want to look at the chef-ingredient cookbook to automate downloading and installing the latest package.</p> </li> <li> <p>Run the upgrade command:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-backend-ctl upgrade
</code></pre></div>
</li> </ol> <p>The update command will make any changes necessary to start the new service and verify that the updated node has rejoined the cluster.</p> <p>Repeat the previous steps in this section for each remaining follower.</p> <h3 id="step-3-update-the-leader">Step 3: Update the leader</h3> <p>Unblock failover, trigger failover, block it again.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">% chef-backend-ctl set-cluster-failover on
% chef-backend-ctl upgrade --failover
% chef-backend-ctl set-cluster-failover off
</code></pre></div>
<h3 id="step-4-re-enable-failover">Step 4: Re-enable failover</h3> <p>Allow failover again:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-backend-ctl set-cluster-failover on
</code></pre></div>
<h3 id="step-5-verify-the-cluster-is-stable">Step 5: Verify the cluster is stable</h3> <p>Check the status of the cluster:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-backend-ctl status
</code></pre></div>
<h2 id="chef-backend-1x-to-2x-upgrade">Chef Backend 1.x to 2.x Upgrade</h2> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> Upgrading from Chef Backend 1.x to Chef Backend 2.x requires full cluster downtime. </div> </div> <ol> <li> <p>Identify the node with the <strong>leader</strong> role using the <code>chef-backend-ctl cluster-status</code> command:</p> <pre tabindex="0" class="highlight" data-language="ruby"><code class="language-none" data-lang="none">Name       IP              GUID                              Role      PG        ES
backend-1  192.168.33.215  dc0c6ea77a751f94037cd950e8451fa3  leader    leader    not_master
backend-2  192.168.33.216  008782c59d3628b6bb7f43556ac0c66c  follower  follower  not_master
backend-3  192.168.33.217  1af654172b1830927a571d9a5ba7965b  follower  follower  master
</code></pre>
<p>In this example, <code>backend-1</code> is the <strong>leader</strong> node, as indicated by its role in the <strong>Role</strong> column.</p> </li> <li> <p>Install the new Chef Backend package on all nodes in the cluster:</p> <p>RHEL and CentOS:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">yum install PATH_TO_FILE.rpm
</code></pre></div>
<p>Debian and Ubuntu:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">dpkg -i PATH_TO_FILE.deb
</code></pre></div>
</li> <li> <p>On the leader, run the following command to take the node down for the upgrade:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-backend-ctl down-for-upgrade
</code></pre></div>
</li> <li> <p>Then issue the same command on the follower nodes:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-backend-ctl down-for-upgrade
</code></pre></div>
</li> <li> <p>Initiate the upgrade on the follower nodes first:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-backend-ctl upgrade
</code></pre></div>
</li> <li> <p>Then initiate the upgrade on the leader node:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-backend-ctl upgrade
</code></pre></div>
</li> <li> <p>On any Chef Infra Server frontend nodes using the Chef Backend cluster upgraded in the previous steps, run:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-server-ctl reconfigure
</code></pre></div>
</li> <li> <p>To continue the upgrades on Chef Infra Server frontend nodes using this backend cluster, see <a href="../install_server_ha/index.html#upgrading-chef-infra-server-on-the-frontend-machines">Upgrade Frontends Associated with a Chef Backend Cluster</a>.</p> </li> </ol> <h2 id="drbdkeepalived-ha-to-chef-backend-2x">DRBD/Keepalived HA to Chef Backend 2.x</h2> <p>DRBD configurations are no longer supported. See <a href="../../versions/index.html#end-of-life-eol">End of Life Products</a>.</p> <p>For a guide to migrating to Chef Backend from DRBD see the <a href="https://blog.chef.io/2018/04/06/best-practices-for-migrating-your-chef-server/">Best Best Practices for Migrating Your Chef Server</a> webinar from the <a href="https://blog.chef.io/">Chef Blog</a>.</p> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/server/upgrade_server_ha_v2/" class="_attribution-link">https://docs.chef.io/server/upgrade_server_ha_v2/</a>
  </p>
</div>
