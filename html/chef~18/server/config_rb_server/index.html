<div id="col-content" data-swiftype-index="true"> <div id="chef-serverrb-settings"><h1>chef-server.rb Settings</h1></div>  <div id="chef-product-version-dropdown" data-chef-product-key="chef-server" data-default-version="chef-server_14"> <label id="chef-product-version-dropdown-label" for="chef_product">Version:</label> <select id="chef-product-version-dropdown-select" name="chef_product" onchange="selectProductVersion()"><option data-product="chef-server" data-version="14" value="chef-server_14"> Chef Infra Server 14 </option>
<option data-product="chef-server" data-version="13.2" value="chef-server_13_2"> Chef Infra Server 13.2 </option></select> </div> <div class="prose"> <div class="chef-product-version chef-server_14"> <p data-swiftype-index="false"> <a href="https://github.com/chef/chef-server/blob/main/docs-chef-io/content/server/v14/config_rb_server.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> The <code>/etc/opscode/chef-server.rb</code> file contains all of the non-default configuration settings used by the Chef Infra Server. The default settings are built into the Chef Infra Server configuration and should only be added to the <code>chef-server.rb</code> file to apply non-default values. These configuration settings are processed when the <code>chef-server-ctl reconfigure</code> command is run. The <code>chef-server.rb</code> file is a Ruby file, which means that conditional statements can be used within it. <h2 id="use-conditions-14">Use Conditions</h2> <p>Use a <code>case</code> statement to apply different values based on whether the setting exists on the front-end or back-end servers. Add code to the server configuration file similar to the following:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">role_name <span style="color:#666">=</span> <span style="color:#60add5">ChefServer</span><span style="color:#666">[</span><span style="color:#4070a0">'servers'</span><span style="color:#666">][</span>node<span style="color:#666">[</span><span style="color:#4070a0">'fqdn'</span><span style="color:#666">]][</span><span style="color:#4070a0">'role'</span><span style="color:#666">]</span>
<span style="color:#007020;font-weight:700">case</span> role_name
<span style="color:#007020;font-weight:700">when</span> <span style="color:#4070a0">'backend'</span>
  <span style="color:#60a0b0;font-style:italic"># backend-specific configuration here</span>
<span style="color:#007020;font-weight:700">when</span> <span style="color:#4070a0">'frontend'</span>
  <span style="color:#60a0b0;font-style:italic"># frontend-specific configuration here</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div> <h2 id="recommended-settings-14">Recommended Settings</h2> <p>The following settings are typically added to the server configuration file (no equal sign is necessary to set the value):</p> <dl> <dt><code>api_fqdn</code></dt> <dd> <p>The FQDN for the Chef Infra Server. This setting is not in the server configuration file by default. When added, its value should be equal to the FQDN for the service URI used by the Chef Infra Server. For example: <code>api_fqdn "chef.example.com"</code>.</p> </dd> <dt><code>bootstrap</code></dt> <dd> <p>Default value: <code>true</code>.</p> </dd> <dt><code>ip_version</code></dt> <dd> <p>Use to set the IP version: <code>"ipv4"</code> or <code>"ipv6"</code>. When set to <code>"ipv6"</code>, the API listens on IPv6 and front end and back end services communicate via IPv6 when a high availability configuration is used. When configuring for IPv6 in a high availability configuration, be sure to set the netmask on the IPv6 <code>backend_vip</code> attribute. Default value: <code>"ipv4"</code>.</p> </dd> <dt><code>notification_email</code></dt> <dd> <p>Default value: <code>info@example.com</code>.</p> </dd> </dl> <h3 id="nginx-ssl-protocols-14">NGINX SSL Protocols</h3> <p>The following settings are often modified from the default as part of the tuning effort for the <strong>nginx</strong> service and to configure the Chef Infra Server to use SSL certificates:</p> <dl> <dt><code>nginx['ssl_certificate']</code></dt> <dd> <p>The SSL certificate used to verify communication over HTTPS. Default value: <code>nil</code>.</p> </dd> <dt><code>nginx['ssl_certificate_key']</code></dt> <dd> <p>The certificate key used for SSL communication. Default value: <code>nil</code>.</p> </dd> <dt><code>nginx['ssl_ciphers']</code></dt> <dd> <p>The list of supported cipher suites that are used to establish a secure connection. To favor AES256 with ECDHE forward security, drop the <code>RC4-SHA:RC4-MD5:RC4:RSA</code> prefix. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_ciphers'</span><span style="color:#666">]</span> <span style="color:#666">=</span>  <span style="color:#4070a0">"HIGH:MEDIUM:!LOW:!kEDH: \
</span><span style="color:#4070a0">                         !aNULL:!ADH:!eNULL:!EXP: \
</span><span style="color:#4070a0">                         !SSLv2:!SEED:!CAMELLIA: \
</span><span style="color:#4070a0">                         !PSK"</span>
</code></pre></div>
</dd> <dt><code>nginx['ssl_protocols']</code></dt> <dd> <p>The SSL protocol versions that are enabled for the Chef Infra Server API. Starting with Chef Infra Server 14.3, this value defaults to <code>'TLSv1.2'</code> for enhanced security. Previous releases defaulted to <code>'TLSv1 TLSv1.1 TLSv1.2'</code>, which allowed for less secure SSL connections. TLS 1.2 is supported on Chef Infra Client 10.16.4 and later on Linux, Unix, and macOS, and on Chef Infra Client 12.8 and later on Windows. If it is necessary to support these older end-of-life Chef Infra Client releases, set this value to <code>'TLSv1.1 TLSv1.2'</code>.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_protocols'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'TLSv1.2'</span>
</code></pre></div>
</dd> </dl> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> <p>See <a href="https://www.openssl.org/docs/man1.0.2/man1/ciphers.html">https://www.openssl.org/docs/man1.0.2/man1/ciphers.html</a> for more information about the values used with the <code>nginx['ssl_ciphers']</code> and <code>nginx['ssl_protocols']</code> settings.</p> </div> </div> <p>For example, after copying the SSL certificate files to the Chef Infra Server, update the <code>nginx['ssl_certificate']</code> and <code>nginx['ssl_certificate_key']</code> settings to specify the paths to those files, and then (optionally) update the <code>nginx['ssl_ciphers']</code> and <code>nginx['ssl_protocols']</code> settings to reflect the desired level of hardness for the Chef Infra Server:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_certificate'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'/etc/pki/tls/private/name.of.pem'</span>
nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_certificate_key'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'/etc/pki/tls/private/name.of.key'</span>
nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_ciphers'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'HIGH:MEDIUM:!LOW:!kEDH:!aNULL:!ADH:!eNULL:!EXP:!SSLv2:!SEED:!CAMELLIA:!PSK'</span>
nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_protocols'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'TLSv1.2'</span>
</code></pre></div> <h2 id="optional-settings-14">Optional Settings</h2> <p>The following settings are often used for performance tuning of the Chef Infra Server in larger installations.</p> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> <p>When changes are made to the chef-server.rb file the Chef Infra Server must be reconfigured by running the following command:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-server-ctl reconfigure
</code></pre></div> </div> </div> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> Review the full list of <a href="../config_rb_server_optional_settings/index.html">optional settings</a> that can be added to the chef-server.rb file. Many of these optional settings should not be added without first consulting with Chef support. </div> </div> <h3 id="bookshelf-14">bookshelf</h3> <p>The following setting is often modified from the default as part of the tuning effort for the <strong>bookshelf</strong> service:</p> <dl> <dt><code>bookshelf['vip']</code></dt> <dd> <p>The virtual IP address. Default value: <code>node['fqdn']</code>.</p> </dd> </dl> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> To <a href="../index.html#aws-settings">configure the server for external cookbook storage</a>, updates are made to settings for both the <strong>bookshelf</strong> and <strong>opscode-erchef</strong> services. </div> </div> <h3 id="opscode-account-14">opscode-account</h3> <p>The following setting is often modified from the default as part of the tuning effort for the <strong>opscode-account</strong> service:</p> <dl> <dt><code>opscode_account['worker_processes']</code></dt> <dd> <p>The number of allowed worker processes. This value should be increased if requests made to the <strong>opscode-account</strong> service are timing out, but only if the front-end machines have available CPU and RAM. Default value: <code>4</code>.</p> </dd> </dl> <h3 id="opscode-erchef-14">opscode-erchef</h3> <p>The following settings are often modified from the default as part of the tuning effort for the <strong>opscode-erchef</strong> service:</p> <dl> <dt><code>opscode_erchef['db_pool_size']</code></dt> <dd> <p>The number of open connections to PostgreSQL that are maintained by the service. If failures indicate that the <strong>opscode-erchef</strong> service ran out of connections, try increasing the <code>postgresql['max_connections']</code> setting. If failures persist, then increase this value (in small increments) and also increase the value for <code>postgresql['max_connections']</code>. Default value: <code>20</code>.</p> </dd> <dt><code>opscode_erchef['s3_url_ttl']</code></dt> <dd> <p>The amount of time (in seconds) before connections to the server expire. If Chef Infra Client runs are timing out, increase this setting to <code>3600</code>, and then adjust again if necessary. Default value: <code>900</code>.</p> </dd> <dt><code>opscode_erchef['strict_search_result_acls']</code></dt> <dd> <p>Use to specify that search results only return objects to which an actor (user, client, etc.) has read access, as determined by ACL settings. This affects all searches. When <code>true</code>, the performance of the Chef management console may increase because it enables the Chef management console to skip redundant ACL checks. To ensure the Chef management console is configured properly, after this setting has been applied with a <code>chef-server-ctl reconfigure</code> run <code>chef-manage-ctl reconfigure</code> to ensure the Chef management console also picks up the setting. Default value: <code>false</code>.</p> </dd> </dl> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> <p>When <code>true</code>, <code>opscode_erchef['strict_search_result_acls']</code> affects all search results and any actor (user, client, etc.) that does not have read access to a search result will not be able to view it. For example, this could affect search results returned during a Chef Infra Client runs if a Chef Infra Client does not have permission to read the information.</p> </div> </div> <h4 id="data-collector-14">Data Collector</h4> <p>The following settings are often modified from the default as part of the tuning effort for the <strong>data_collector</strong> <strong>opscode-erchef</strong> application:</p> <dl> <dt><code>data_collector['http_max_count']</code></dt> <dd> <p>The maximum worker count for the HTTP connection pool that is used by the data collector. If failures indicate that <strong>opscode-erchef</strong> application has run out of HTTP connections for the <strong>data_collector</strong> then increase this value. Default value: <span class="title-ref">100</span>.</p> </dd> </dl> <h3 id="postgresql-14">postgresql</h3> <p>The following setting is often modified from the default as part of the tuning effort for the <strong>postgresql</strong> service:</p> <dl> <dt><code>postgresql['max_connections']</code></dt> <dd> <p>The maximum number of allowed concurrent connections. This value should only be tuned when the <code>opscode_erchef['db_pool_size']</code> value used by the <strong>opscode-erchef</strong> service is modified. Default value: <code>350</code>. If there are more than two front end machines in a cluster, the <code>postgresql['max_connections']</code> setting should be increased. The increased value depends on the number of machines in the front end, but also the number of services that are running on each of these machines.</p> <ul> <li>Each front end machine always runs the <strong>oc_bifrost</strong> and <strong>opscode-erchef</strong> services.</li> <li>The Reporting add-on adds the <strong>reporting</strong> service.</li> </ul> <p>Each of these services requires 25 connections, above the default value.</p> <p>Use the following formula to help determine what the increased value should be:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">new_value <span style="color:#666">=</span> current_value <span style="color:#666">+</span> <span style="color:#666">[</span>
            (<span style="color:#60a0b0;font-style:italic"># of front end machines - 2) * (25 * # of services)</span>
         <span style="color:#666">]</span>
</code></pre></div>
<p>For example, if the current value is 350, there are four front end machines, and all add-ons are installed, then the formula looks like:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#40a070">550</span> <span style="color:#666">=</span> <span style="color:#40a070">350</span> <span style="color:#666">+</span> <span style="color:#666">[</span>(<span style="color:#40a070">4</span> <span style="color:#666">-</span> <span style="color:#40a070">2</span>) <span style="color:#666">*</span> (<span style="color:#40a070">25</span> <span style="color:#666">*</span> <span style="color:#40a070">4</span>)<span style="color:#666">]</span>
</code></pre></div>
</dd> </dl> <dl> <dt><code>postgresql['sslmode']</code></dt> <dd> <p>SSL encryption mode between the Chef Infra Server and PostgreSQL. Valid settings are <code>'disable'</code> and <code>'require'</code>. Default value: <code>'disable'</code>.</p> </dd> </dl> </div> <div class="chef-product-version chef-server_13_2"> <div class="chef-product-version-not-newest"> <p><strong>Note:</strong> You are viewing documentation for an older version of <span class="chef-product-version-name">Chef Infra Server</span>.</p> </div> <p data-swiftype-index="false"> <a href="https://github.com/chef/chef-server/blob/main/docs-chef-io/content/server/v13_2/config_rb_server.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> The <code>/etc/opscode/chef-server.rb</code> file contains all of the non-default configuration settings used by the Chef Infra Server. The default settings are built into the Chef Infra Server configuration and should only be added to the <code>chef-server.rb</code> file to apply non-default values. These configuration settings are processed when the <code>chef-server-ctl reconfigure</code> command is run. The <code>chef-server.rb</code> file is a Ruby file, which means that conditional statements can be used within it. <h2 id="use-conditions-13_2">Use Conditions</h2> <p>Use a <code>case</code> statement to apply different values based on whether the setting exists on the front-end or back-end servers. Add code to the server configuration file similar to the following:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">role_name <span style="color:#666">=</span> <span style="color:#60add5">ChefServer</span><span style="color:#666">[</span><span style="color:#4070a0">'servers'</span><span style="color:#666">][</span>node<span style="color:#666">[</span><span style="color:#4070a0">'fqdn'</span><span style="color:#666">]][</span><span style="color:#4070a0">'role'</span><span style="color:#666">]</span>
<span style="color:#007020;font-weight:700">case</span> role_name
<span style="color:#007020;font-weight:700">when</span> <span style="color:#4070a0">'backend'</span>
  <span style="color:#60a0b0;font-style:italic"># backend-specific configuration here</span>
<span style="color:#007020;font-weight:700">when</span> <span style="color:#4070a0">'frontend'</span>
  <span style="color:#60a0b0;font-style:italic"># frontend-specific configuration here</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div> <h2 id="recommended-settings-13_2">Recommended Settings</h2> <p>The following settings are typically added to the server configuration file (no equal sign is necessary to set the value):</p> <dl> <dt><code>api_fqdn</code></dt> <dd> <p>The FQDN for the Chef Infra Server. This setting is not in the server configuration file by default. When added, its value should be equal to the FQDN for the service URI used by the Chef Infra Server. For example: <code>api_fqdn "chef.example.com"</code>.</p> </dd> <dt><code>bootstrap</code></dt> <dd> <p>Default value: <code>true</code>.</p> </dd> <dt><code>ip_version</code></dt> <dd> <p>Use to set the IP version: <code>"ipv4"</code> or <code>"ipv6"</code>. When set to <code>"ipv6"</code>, the API listens on IPv6 and front end and back end services communicate via IPv6 when a high availability configuration is used. When configuring for IPv6 in a high availability configuration, be sure to set the netmask on the IPv6 <code>backend_vip</code> attribute. Default value: <code>"ipv4"</code>.</p> </dd> <dt><code>notification_email</code></dt> <dd> <p>Default value: <code>info@example.com</code>.</p> </dd> </dl> <h3 id="nginx-ssl-protocols-13_2">NGINX SSL Protocols</h3> <p>The following settings are often modified from the default as part of the tuning effort for the <strong>nginx</strong> service and to configure the Chef Infra Server to use SSL certificates:</p> <dl> <dt><code>nginx['ssl_certificate']</code></dt> <dd> <p>The SSL certificate used to verify communication over HTTPS. Default value: <code>nil</code>.</p> </dd> <dt><code>nginx['ssl_certificate_key']</code></dt> <dd> <p>The certificate key used for SSL communication. Default value: <code>nil</code>.</p> </dd> <dt><code>nginx['ssl_ciphers']</code></dt> <dd> <p>The list of supported cipher suites that are used to establish a secure connection. To favor AES256 with ECDHE forward security, drop the <code>RC4-SHA:RC4-MD5:RC4:RSA</code> prefix. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_ciphers'</span><span style="color:#666">]</span> <span style="color:#666">=</span>  <span style="color:#4070a0">"HIGH:MEDIUM:!LOW:!kEDH: \
</span><span style="color:#4070a0">                         !aNULL:!ADH:!eNULL:!EXP: \
</span><span style="color:#4070a0">                         !SSLv2:!SEED:!CAMELLIA: \
</span><span style="color:#4070a0">                         !PSK"</span>
</code></pre></div>
</dd> <dt><code>nginx['ssl_protocols']</code></dt> <dd> <p>The SSL protocol versions that are enabled for the Chef Infra Server API. For enhanced security set this value to <code>'TLSv1.2'</code>. TLS 1.2 is supported on Chef Infra Client 10.16.4 and later on Linux, Unix, and macOS, and on Chef Infra Client 12.8 and later on Windows. If it is necessary to support these older end-of-life Chef Infra Client releases, set this value to <code>'TLSv1.1 TLSv1.2'</code>.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_protocols'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'TLSv1.2'</span>
</code></pre></div>
</dd> </dl> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> <p>See <a href="https://www.openssl.org/docs/man1.0.2/man1/ciphers.html">https://www.openssl.org/docs/man1.0.2/man1/ciphers.html</a> for more information about the values used with the <code>nginx['ssl_ciphers']</code> and <code>nginx['ssl_protocols']</code> settings.</p> </div> </div> <p>For example, after copying the SSL certificate files to the Chef Infra Server, update the <code>nginx['ssl_certificate']</code> and <code>nginx['ssl_certificate_key']</code> settings to specify the paths to those files, and then (optionally) update the <code>nginx['ssl_ciphers']</code> and <code>nginx['ssl_protocols']</code> settings to reflect the desired level of hardness for the Chef Infra Server:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_certificate'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'/etc/pki/tls/private/name.of.pem'</span>
nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_certificate_key'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'/etc/pki/tls/private/name.of.key'</span>
nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_ciphers'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'HIGH:MEDIUM:!LOW:!kEDH:!aNULL:!ADH:!eNULL:!EXP:!SSLv2:!SEED:!CAMELLIA:!PSK'</span>
nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_protocols'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'TLSv1.2'</span>
</code></pre></div> <h2 id="optional-settings-13_2">Optional Settings</h2> <p>The following settings are often used for performance tuning of the Chef Infra Server in larger installations.</p> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> <p>When changes are made to the chef-server.rb file the Chef Infra Server must be reconfigured by running the following command:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-server-ctl reconfigure
</code></pre></div> </div> </div> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> Review the full list of <a href="../config_rb_server_optional_settings/index.html">optional settings</a> that can be added to the chef-server.rb file. Many of these optional settings should not be added without first consulting with Chef support. </div> </div> <h3 id="bookshelf-13_2">bookshelf</h3> <p>The following setting is often modified from the default as part of the tuning effort for the <strong>bookshelf</strong> service:</p> <dl> <dt><code>bookshelf['vip']</code></dt> <dd> <p>The virtual IP address. Default value: <code>node['fqdn']</code>.</p> </dd> </dl> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> To <a href="../index.html#aws-settings">configure the server for external cookbook storage</a>, updates are made to settings for both the <strong>bookshelf</strong> and <strong>opscode-erchef</strong> services. </div> </div> <h3 id="opscode-account-13_2">opscode-account</h3> <p>The following setting is often modified from the default as part of the tuning effort for the <strong>opscode-account</strong> service:</p> <dl> <dt><code>opscode_account['worker_processes']</code></dt> <dd> <p>The number of allowed worker processes. This value should be increased if requests made to the <strong>opscode-account</strong> service are timing out, but only if the front-end machines have available CPU and RAM. Default value: <code>4</code>.</p> </dd> </dl> <h3 id="opscode-erchef-13_2">opscode-erchef</h3> <p>The following settings are often modified from the default as part of the tuning effort for the <strong>opscode-erchef</strong> service:</p> <dl> <dt><code>opscode_erchef['db_pool_size']</code></dt> <dd> <p>The number of open connections to PostgreSQL that are maintained by the service. If failures indicate that the <strong>opscode-erchef</strong> service ran out of connections, try increasing the <code>postgresql['max_connections']</code> setting. If failures persist, then increase this value (in small increments) and also increase the value for <code>postgresql['max_connections']</code>. Default value: <code>20</code>.</p> </dd> <dt><code>opscode_erchef['s3_url_ttl']</code></dt> <dd> <p>The amount of time (in seconds) before connections to the server expire. If Chef Infra Client runs are timing out, increase this setting to <code>3600</code>, and then adjust again if necessary. Default value: <code>900</code>.</p> </dd> <dt><code>opscode_erchef['strict_search_result_acls']</code></dt> <dd> <p>Use to specify that search results only return objects to which an actor (user, client, etc.) has read access, as determined by ACL settings. This affects all searches. When <code>true</code>, the performance of the Chef management console may increase because it enables the Chef management console to skip redundant ACL checks. To ensure the Chef management console is configured properly, after this setting has been applied with a <code>chef-server-ctl reconfigure</code> run <code>chef-manage-ctl reconfigure</code> to ensure the Chef management console also picks up the setting. Default value: <code>false</code>.</p> </dd> </dl> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> <p>When <code>true</code>, <code>opscode_erchef['strict_search_result_acls']</code> affects all search results and any actor (user, client, etc.) that does not have read access to a search result will not be able to view it. For example, this could affect search results returned during a Chef Infra Client runs if a Chef Infra Client does not have permission to read the information.</p> </div> </div> <h4 id="data-collector-13_2">Data Collector</h4> <p>The following settings are often modified from the default as part of the tuning effort for the <strong>data_collector</strong> <strong>opscode-erchef</strong> application:</p> <dl> <dt><code>data_collector['http_max_count']</code></dt> <dd> <p>The maximum worker count for the HTTP connection pool that is used by the data collector. If failures indicate that <strong>opscode-erchef</strong> application has run out of HTTP connections for the <strong>data_collector</strong> then increase this value. Default value: <span class="title-ref">100</span>.</p> </dd> </dl> <h3 id="opscode-expander-13_2">opscode-expander</h3> <p>The following setting is often modified from the default as part of the tuning effort for the <strong>opscode-expander</strong> service:</p> <dl> <dt><code>opscode_expander['nodes']</code></dt> <dd> <p>The number of allowed worker processes. The <strong>opscode-expander</strong> service runs on the back-end and feeds data to the <strong>opscode-solr</strong> service, which creates and maintains search data used by the Chef Infra Server. Additional memory may be required by these worker processes depending on the frequency and volume of Chef Infra Client runs across the organization, but only if the back-end machines have available CPU and RAM. Default value: <code>2</code>.</p> </dd> </dl> <h3 id="opscode-solr4-13_2">opscode-solr4</h3> The following sections describe ways of tuning the <strong>opscode-solr4</strong> service to improve performance around large node sizes, available memory, and update frequencies. <h4 id="available-memory-13_2">Available Memory</h4> <p>Use the following configuration setting to help ensure that Apache Solr does not run out of memory:</p> <dl> <dt><code>opscode_solr4['heap_size']</code></dt> <dd> <p>The amount of memory (in MBs) available to Apache Solr. If there is not enough memory available, search queries made by nodes to Apache Solr may fail. The amount of memory that must be available also depends on the number of nodes in the organization, the frequency of search queries, and other characteristics that are unique to each organization. In general, as the number of nodes increases, so does the amount of memory.</p> </dd> </dl> <p>If Apache Solr is running out of memory, the <code>/var/log/opscode/opscode-solr4/current</code> log file will contain a message similar to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">SEVERE: java.lang.OutOfMemoryError: Java heap space
</code></pre></div>
<p>The default value for <code>opscode_solr4['heap_size']</code> should work for many organizations, especially those with fewer than 25 nodes. For organizations with more than 25 nodes, set this value to 25% of system memory or <code>1024</code>, whichever is smaller. For very large configurations, increase this value to 25% of system memory or <code>4096</code>, whichever is smaller. This value should not exceed <code>8192</code>.</p> <h4 id="large-node-sizes-13_2">Large Node Sizes</h4> <p>The maximum field length setting for Apache Solr should be greater than any expected node object file sizes in order for them to be successfully added to the search index. If a node object file is greater than the maximum field length, the node object will be indexed up to the maximum, but the part of the file past that limit will not be indexed. If this occurs, it will seem as if nodes disappear from the search index. To ensure that large node file sizes are indexed properly, verify the following configuration settings:</p> <dl> <dt><code>nginx['client_max_body_size']</code></dt> <dd> <p>The maximum accepted body size for a client request, as indicated by the <code>Content-Length</code> request header. When the maximum accepted body size is greater than this value, a <code>413 Request Entity Too Large</code> error is returned. Default value: <code>250m</code>.</p> </dd> </dl> <p>and</p> <dl> <dt><code>opscode_erchef['max_request_size']</code></dt> <dd> <p>When the request body size is greater than this value, a 413 Request Entity Too Large error is returned. Default value: <code>2000000</code>.</p> </dd> </dl> <p>to ensure that those settings are not part of the reasons for incomplete indexing, and then update the following setting so that its value is greater than the expected node file sizes:</p> <dl> <dt><code>opscode_solr4['max_field_length']</code></dt> <dd> <p>The maximum field length (in number of tokens/terms). If a field length exceeds this value, Apache Solr may not be able to complete building the index. Default value: <code>100000</code> (increased from the Apache Solr default value of <code>10000</code>).</p> </dd> </dl> <p>Use the <code>wc</code> command to get the byte count of a large node object file. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">wc -c NODE_NAME.json
</code></pre></div>
<p>and then ensure there is a buffer beyond that value. For example, verify the size of the largest node object file:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">wc -c nodebsp2016.json
</code></pre></div>
<p>which returns <code>154516</code>. Update the <code>opscode_solr4['max_field_length']</code> setting to have a value greater than the returned value. For example: <code>180000</code>.</p> <p>If you don’t have a node object file available then you can get an approximate size of the node data by running the following command on a node.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">ohai | wc -c
</code></pre></div> <h4 id="update-frequency-13_2">Update Frequency</h4> <p>At the end of every Chef Infra Client run, the node object is saved to the Chef Infra Server. From the Chef Infra Server, each node object is then added to the <code>SOLR</code> search index. This process is asynchronous. By default, node objects are committed to the search index every 60 seconds or per 1000 node objects, whichever occurs first.</p> <p>When data is committed to the Apache Solr index, all incoming updates are blocked. If the duration between updates is too short, it is possible for the rate at which updates are asked to occur to be faster than the rate at which objects can be actually committed.</p> <p>Use the following configuration setting to improve the indexing performance of node objects:</p> <dl> <dt><code>opscode_solr4['commit_interval']</code></dt> <dd> <p>The frequency (in seconds) at which node objects are added to the Apache Solr search index. Default value: <code>60000</code> (every 60 seconds).</p> </dd> <dt><code>opscode_solr4['max_commit_docs']</code></dt> <dd> <p>The frequency (in documents) at which node objects are added to the Apache Solr search index. Default value: <code>1000</code> (every 1000 documents).</p> </dd> </dl> <h3 id="postgresql-13_2">postgresql</h3> <p>The following setting is often modified from the default as part of the tuning effort for the <strong>postgresql</strong> service:</p> <dl> <dt><code>postgresql['max_connections']</code></dt> <dd> <p>The maximum number of allowed concurrent connections. This value should only be tuned when the <code>opscode_erchef['db_pool_size']</code> value used by the <strong>opscode-erchef</strong> service is modified. Default value: <code>350</code>. If there are more than two front end machines in a cluster, the <code>postgresql['max_connections']</code> setting should be increased. The increased value depends on the number of machines in the front end, but also the number of services that are running on each of these machines.</p> <ul> <li>Each front end machine always runs the <strong>oc_bifrost</strong> and <strong>opscode-erchef</strong> services.</li> <li>The Reporting add-on adds the <strong>reporting</strong> service.</li> </ul> <p>Each of these services requires 25 connections, above the default value.</p> <p>Use the following formula to help determine what the increased value should be:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">new_value <span style="color:#666">=</span> current_value <span style="color:#666">+</span> <span style="color:#666">[</span>
            (<span style="color:#60a0b0;font-style:italic"># of front end machines - 2) * (25 * # of services)</span>
         <span style="color:#666">]</span>
</code></pre></div>
<p>For example, if the current value is 350, there are four front end machines, and all add-ons are installed, then the formula looks like:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#40a070">550</span> <span style="color:#666">=</span> <span style="color:#40a070">350</span> <span style="color:#666">+</span> <span style="color:#666">[</span>(<span style="color:#40a070">4</span> <span style="color:#666">-</span> <span style="color:#40a070">2</span>) <span style="color:#666">*</span> (<span style="color:#40a070">25</span> <span style="color:#666">*</span> <span style="color:#40a070">4</span>)<span style="color:#666">]</span>
</code></pre></div>
</dd> </dl> <dl> <dt><code>postgresql['sslmode']</code></dt> <dd> <p>SSL encryption mode between the Chef Infra Server and PostgreSQL. Valid settings are <code>'disable'</code> and <code>'require'</code>. Default value: <code>'disable'</code>.</p> </dd> </dl> </div> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/server/config_rb_server/" class="_attribution-link">https://docs.chef.io/server/config_rb_server/</a>
  </p>
</div>
