<div id="col-content" data-swiftype-index="true"> <div id="security"><h1>Security</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/chef-server/blob/main/docs-chef-io/content/server/server_security.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>This guide covers the security features available in Chef Infra Server.</p> <h2 id="ssl-certificates">SSL Certificates</h2> <p>Initial configuration of the Chef Infra Server is done automatically using a self-signed certificate to create the certificate and private key files for Nginx. This section details the process for updating a Chef Infra Server’s SSL certificate.</p> <h3 id="automatic-installation-recommended">Automatic Installation (recommended)</h3> <p>The Chef Infra Server can be configured to use SSL certificates by adding the following settings to the server configuration file:</p> <table> <col style="width:40%"> <col style="width:60%"> <thead> <tr class="header"> <th>Setting</th> <th>Description</th> </tr> </thead> <tbody> <tr class="odd"> <td><code>nginx['ssl_certificate']</code></td> <td>The SSL certificate used to verify communication over HTTPS.</td> </tr> <tr class="even"> <td><code>nginx['ssl_certificate_key']</code></td> <td>The certificate key used for SSL communication.</td> </tr> </tbody> </table> <p>and then setting their values to define the paths to the certificate and key.</p> <p>For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_certificate'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'/etc/pki/tls/certs/your-host.crt'</span>
nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_certificate_key'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'/etc/pki/tls/private/your-host.key'</span>
</code></pre></div>
<p>Save the file, and then run the following command:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">sudo chef-server-ctl reconfigure
</code></pre></div>
<p>For more information about the server configuration file, see <a href="../config_rb_server/index.html">chef-server.rb</a>.</p> <h3 id="manual-installation">Manual Installation</h3> <p>SSL certificates can be updated manually by placing the certificate and private key file obtained from the certifying authority in the correct files, after the initial configuration of Chef Infra Server.</p> <p>The locations of the certificate and private key files are:</p> <ul> <li><code>/var/opt/opscode/nginx/ca/FQDN.crt</code></li> <li><code>/var/opt/opscode/nginx/ca/FQDN.key</code></li> </ul> <p>Because the FQDN has already been configured, do the following:</p> <ol> <li> <p>Replace the contents of <code>/var/opt/opscode/nginx/ca/FQDN.crt</code> and <code>/var/opt/opscode/nginx/ca/FQDN.key</code> with the certifying authority’s files.</p> </li> <li> <p>Reconfigure the Chef Infra Server:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-server-ctl reconfigure
</code></pre></div>
</li> <li> <p>Restart the Nginx service to load the new key and certificate:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-server-ctl restart nginx
</code></pre></div>
</li> </ol> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> The FQDN for the Chef Infra Server should be resolvable, lowercase, and have fewer than 64 characters including the domain suffix, when using OpenSSL, as OpenSSL requires the <code>CN</code> in a certificate to be no longer than 64 characters. </div> </div> <h3 id="ssl-protocols">SSL Protocols</h3> <p>The following settings are often modified from the default as part of the tuning effort for the <strong>nginx</strong> service and to configure the Chef Infra Server to use SSL certificates:</p> <dl> <dt><code>nginx['ssl_certificate']</code></dt> <dd> <p>The SSL certificate used to verify communication over HTTPS. Default value: <code>nil</code>.</p> </dd> <dt><code>nginx['ssl_certificate_key']</code></dt> <dd> <p>The certificate key used for SSL communication. Default value: <code>nil</code>.</p> </dd> <dt><code>nginx['ssl_ciphers']</code></dt> <dd> <p>The list of supported cipher suites that are used to establish a secure connection. To favor AES256 with ECDHE forward security, drop the <code>RC4-SHA:RC4-MD5:RC4:RSA</code> prefix. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_ciphers'</span><span style="color:#666">]</span> <span style="color:#666">=</span>  <span style="color:#4070a0">"HIGH:MEDIUM:!LOW:!kEDH: \
</span><span style="color:#4070a0">                         !aNULL:!ADH:!eNULL:!EXP: \
</span><span style="color:#4070a0">                         !SSLv2:!SEED:!CAMELLIA: \
</span><span style="color:#4070a0">                         !PSK"</span>
</code></pre></div>
</dd> <dt><code>nginx['ssl_protocols']</code></dt> <dd> <p>The SSL protocol versions that are enabled for the Chef Infra Server API. For enhanced security set this value to <code>'TLSv1.2'</code>. TLS 1.2 is supported on Chef Infra Client 10.16.4 and later on Linux, Unix, and macOS, and on Chef Infra Client 12.8 and later on Windows. If it is necessary to support these older end-of-life Chef Infra Client releases, set this value to <code>'TLSv1.1 TLSv1.2'</code>. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_protocols'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'TLSv1.2'</span>
</code></pre></div>
</dd> </dl> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> <p>See <a href="https://www.openssl.org/docs/man1.0.2/man1/ciphers.html">https://www.openssl.org/docs/man1.0.2/man1/ciphers.html</a> for more information about the values used with the <code>nginx['ssl_ciphers']</code> and <code>nginx['ssl_protocols']</code> settings.</p> </div> </div> <p>For example, after copying the SSL certificate files to the Chef Infra Server, update the <code>nginx['ssl_certificate']</code> and <code>nginx['ssl_certificate_key']</code> settings to specify the paths to those files, and then (optionally) update the <code>nginx['ssl_ciphers']</code> and <code>nginx['ssl_protocols']</code> settings to reflect the desired level of hardness for the Chef Infra Server:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_certificate'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'/etc/pki/tls/private/name.of.pem'</span>
nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_certificate_key'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'/etc/pki/tls/private/name.of.key'</span>
nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_ciphers'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'HIGH:MEDIUM:!LOW:!kEDH:!aNULL:!ADH:!eNULL:!EXP:!SSLv2:!SEED:!CAMELLIA:!PSK'</span>
nginx<span style="color:#666">[</span><span style="color:#4070a0">'ssl_protocols'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'TLSv1 TLSv1.1 TLSv1.2'</span>
</code></pre></div>
<p><strong>Example: Configure SSL Keys for Nginx</strong></p> <p>The following example shows how the Chef Infra Server sets up and configures SSL certificates for Nginx. The cipher suite used by Nginx <a href="../config_rb_server/index.html#ssl-protocols">is configurable</a> using the <code>ssl_protocols</code> and <code>ssl_ciphers</code> settings.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">ssl_keyfile <span style="color:#666">=</span> <span style="color:#60add5">File</span><span style="color:#666">.</span>join(nginx_ca_dir, <span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">#{</span>node<span style="color:#666">[</span><span style="color:#4070a0">'private_chef'</span><span style="color:#666">][</span><span style="color:#4070a0">'nginx'</span><span style="color:#666">][</span><span style="color:#4070a0">'server_name'</span><span style="color:#666">]</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">.key"</span>)
ssl_crtfile <span style="color:#666">=</span> <span style="color:#60add5">File</span><span style="color:#666">.</span>join(nginx_ca_dir, <span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">#{</span>node<span style="color:#666">[</span><span style="color:#4070a0">'private_chef'</span><span style="color:#666">][</span><span style="color:#4070a0">'nginx'</span><span style="color:#666">][</span><span style="color:#4070a0">'server_name'</span><span style="color:#666">]</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">.crt"</span>)
ssl_signing_conf <span style="color:#666">=</span> <span style="color:#60add5">File</span><span style="color:#666">.</span>join(nginx_ca_dir, <span style="color:#4070a0">"</span><span style="color:#70a0d0;font-style:italic">#{</span>node<span style="color:#666">[</span><span style="color:#4070a0">'private_chef'</span><span style="color:#666">][</span><span style="color:#4070a0">'nginx'</span><span style="color:#666">][</span><span style="color:#4070a0">'server_name'</span><span style="color:#666">]</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">-ssl.conf"</span>)

<span style="color:#007020;font-weight:700">unless</span> <span style="color:#666">::</span><span style="color:#60add5">File</span><span style="color:#666">.</span>exist?(ssl_keyfile) <span style="color:#666">&amp;&amp;</span> <span style="color:#666">::</span><span style="color:#60add5">File</span><span style="color:#666">.</span>exist?(ssl_crtfile) <span style="color:#666">&amp;&amp;</span> <span style="color:#666">::</span><span style="color:#60add5">File</span><span style="color:#666">.</span>exist?(ssl_signing_conf)
  file ssl_keyfile <span style="color:#007020;font-weight:700">do</span>
    owner <span style="color:#4070a0">'root'</span>
    group <span style="color:#4070a0">'root'</span>
    mode <span style="color:#4070a0">'0755'</span>
    content <span style="color:#4070a0">'/opt/opscode/embedded/bin/openssl genrsa 2048'</span>
    not_if { <span style="color:#666">::</span><span style="color:#60add5">File</span><span style="color:#666">.</span>exist?(ssl_keyfile) }
  <span style="color:#007020;font-weight:700">end</span>

  file ssl_signing_conf <span style="color:#007020;font-weight:700">do</span>
    owner <span style="color:#4070a0">'root'</span>
    group <span style="color:#4070a0">'root'</span>
    mode <span style="color:#4070a0">'0755'</span>
    not_if { <span style="color:#666">::</span><span style="color:#60add5">File</span><span style="color:#666">.</span>exist?(ssl_signing_conf) }
    content <span style="color:#4070a0">&lt;&lt;-EOH
</span>  <span style="color:#666">[</span> req <span style="color:#666">]</span>
  distinguished_name <span style="color:#666">=</span> req_distinguished_name
  prompt <span style="color:#666">=</span> no
  <span style="color:#666">[</span> req_distinguished_name <span style="color:#666">]</span>
  C                      <span style="color:#666">=</span> <span style="color:#60a0b0;font-style:italic">#{node['private_chef']['nginx']['ssl_country_name']}</span>
  <span style="color:#60add5">ST</span>                     <span style="color:#666">=</span> <span style="color:#60a0b0;font-style:italic">#{node['private_chef']['nginx']['ssl_state_name']}</span>
  L                      <span style="color:#666">=</span> <span style="color:#60a0b0;font-style:italic">#{node['private_chef']['nginx']['ssl_locality_name']}</span>
  O                      <span style="color:#666">=</span> <span style="color:#60a0b0;font-style:italic">#{node['private_chef']['nginx']['ssl_company_name']}</span>
  <span style="color:#60add5">OU</span>                     <span style="color:#666">=</span> <span style="color:#60a0b0;font-style:italic">#{node['private_chef']['nginx']['ssl_organizational_unit_name']}</span>
  <span style="color:#60add5">CN</span>                     <span style="color:#666">=</span> <span style="color:#60a0b0;font-style:italic">#{node['private_chef']['nginx']['server_name']}</span>
  emailAddress           <span style="color:#666">=</span> <span style="color:#60a0b0;font-style:italic">#{node['private_chef']['nginx']['ssl_email_address']}</span>
  <span style="color:#60add5">EOH</span>
  <span style="color:#007020;font-weight:700">end</span>

  ruby_block <span style="color:#4070a0">'create crtfile'</span> <span style="color:#007020;font-weight:700">do</span>
    block <span style="color:#007020;font-weight:700">do</span>
      r <span style="color:#666">=</span> <span style="color:#60add5">Chef</span><span style="color:#666">::</span><span style="color:#60add5">Resource</span><span style="color:#666">::</span><span style="color:#60add5">File</span><span style="color:#666">.</span>new(ssl_crtfile, run_context)
      r<span style="color:#666">.</span>owner <span style="color:#4070a0">'root'</span>
      r<span style="color:#666">.</span>group <span style="color:#4070a0">'root'</span>
      r<span style="color:#666">.</span>mode <span style="color:#4070a0">'0755'</span>
      r<span style="color:#666">.</span>content <span style="color:#4070a0">"/opt/opscode/embedded/bin/openssl req -config '</span><span style="color:#70a0d0;font-style:italic">#{</span>ssl_signing_conf<span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">' -new -x509 -nodes -sha1 -days 3650 -key '</span><span style="color:#70a0d0;font-style:italic">#{</span>ssl_keyfile<span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">'"</span>
      r<span style="color:#666">.</span>not_if { <span style="color:#666">::</span><span style="color:#60add5">File</span><span style="color:#666">.</span>exist?(ssl_crtfile) }
      r<span style="color:#666">.</span>run_action(<span style="color:#517918">:create</span>)
    <span style="color:#007020;font-weight:700">end</span>
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h3 id="knife-chef-infra-client">Knife, Chef Infra Client</h3> <p>Chef Infra Server 12 and later enables SSL verification by default for all requests made to the server, such as those made by knife and Chef Infra Client. The certificate that is generated during the installation of the Chef Infra Server is self-signed, which means the certificate is not signed by a trusted certificate authority (CA) recognized by Chef Infra Client. The certificate generated by the Chef Infra Server must be downloaded to any machine from which knife and/or Chef Infra Client will make requests to the Chef Infra Server.</p> <p>For example, without downloading the SSL certificate, the following knife command:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">knife client list
</code></pre></div>
<p>responds with an error similar to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">ERROR: SSL Validation failure connecting to host: chef-server.example.com ...
ERROR: OpenSSL::SSL::SSLError: SSL_connect <span style="color:#bb60d5">returned</span><span style="color:#666">=</span><span style="color:#40a070">1</span> <span style="color:#bb60d5">errno</span><span style="color:#666">=</span><span style="color:#40a070">0</span> <span style="color:#bb60d5">state</span><span style="color:#666">=</span>SSLv3 ...
</code></pre></div>
<p>This is by design and will occur until a verifiable certificate is added to the machine from which the request is sent.</p> <p>See <a href="../../chef_client_security/index.html#ssl-certificates">Chef Infra Client SSL Certificates</a> for more information on how knife and Chef Infra Client use SSL certificates generated by the Chef Infra Server.</p> <h3 id="private-certificate-authority">Private Certificate Authority</h3> <p>If an organization is using an internal certificate authority, then the root certificate will not appear in any <code>cacerts.pem</code> file that ships by default with operating systems and web browsers. Because of this, no currently deployed system will be able to verify certificates that are issued in this manner. To allow other systems to trust certificates from an internal certificate authority, this root certificate will need to be configured so that other systems can follow the chain of authority back to the root certificate. (An intermediate certificate is not enough because the root certificate is not already globally known.)</p> <p>To use an internal certificate authority, append the server–optionally, any intermediate certificate as well–and root certificates into a single <code>.crt</code> file. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">cat server.crt <span style="color:#666">[</span>intermediate.crt<span style="color:#666">]</span> root.crt &gt;&gt; /var/opt/opscode/nginx/ca/FQDN.crt
</code></pre></div>
<p>Check your combined certificate’s validity on the Chef Infra Server:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">openssl verify -verbose -purpose sslserver -CAfile cacert.pem  /var/opt/opscode/nginx/ca/FQDN.crt
</code></pre></div>
<p>The cacert.pem should contain only your root CA’s certificate file. This is not the usual treatment, but mimics how Chef Workstation behaves after a <code>knife ssl fetch</code> followed by a <code>knife ssl verify</code>.</p> <h3 id="intermediate-certificates">Intermediate Certificates</h3> <p>For use with 3rd party certificate providers, for example, Verisign.</p> <p>To use an intermediate certificate, append both the server and intermediate certificates into a single <code>.crt</code> file. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">cat server.crt intermediate.crt &gt;&gt; /var/opt/opscode/nginx/ca/FQDN.crt
</code></pre></div>
<h3 id="verify-certificate-was-signed-by-proper-key">Verify Certificate Was Signed by Proper Key</h3> <p>It’s possible that a certificate/key mismatch can occur during the CertificateSigningRequest (CSR) process. During a CSR, the original key for the server in question should always be used. If the output of the following commands don’t match, then it’s possible the CSR for a new key for this host was generated using a random key or a newly generated key. The symptoms of this issue will look like the following in the nginx log files:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">nginx: <span style="color:#666">[</span>emerg<span style="color:#666">]</span> SSL_CTX_use_PrivateKey_file<span style="color:#666">(</span><span style="color:#4070a0">"/var/opt/opscode/nginx/ca/YOUR_HOSTNAME.key"</span><span style="color:#666">)</span> failed <span style="color:#666">(</span>SSL: error:0B080074:x509    certificate routines:X509_check_private_key:key values mismatch<span style="color:#666">)</span>
</code></pre></div>
<p>Here’s how to tell for sure when the configured certificate doesn’t match the key</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#60a0b0;font-style:italic">## openssl x509 -in /var/opt/opscode/nginx/ca/chef-432.lxc.crt -noout -modulus | openssl sha1</span>
<span style="color:#666">(</span>stdin<span style="color:#666">)=</span> 05b4f62e52fe7ce2351ff81d3e1060c0cdf1fa24

<span style="color:#60a0b0;font-style:italic">## openssl rsa -in /var/opt/opscode/nginx/ca/chef-432.lxc.key -noout -modulus | openssl sha1</span>
<span style="color:#666">(</span>stdin<span style="color:#666">)=</span> 05b4f62e52fe7ce2351ff81d3e1060c0cdf1fa24
</code></pre></div>
<p>To fix this, you will need to generate a new CSR using the original key for the server, the same key that was used to produce the CSR for the previous certificates. Install that new certificates along with the original key and the mismatch error should go away.</p> <h3 id="regenerate-certificates">Regenerate Certificates</h3> <p>SSL certificates should be regenerated periodically. This is an important part of protecting the Chef Infra Server from vulnerabilities and helps to prevent the information stored on the Chef Infra Server from being compromised.</p> <p>To regenerate SSL certificates:</p> <ol> <li> <p>Run the following command:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-server-ctl stop
</code></pre></div>
</li> <li> <p>The Chef Infra Server can regenerate them. These certificates will be located in <code>/var/opt/opscode/nginx/ca/</code> and will be named after the FQDN for the Chef Infra Server. To determine the FQDN for the server, run the following command:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">hostname -f
</code></pre></div>
<p>Please delete the files found in the ca directory with names like this <code>$FQDN.crt</code> and <code>$FQDN.key</code>.</p> </li> <li> <p>If your organization has provided custom SSL certificates to the Chef Infra Server, the locations of that custom certificate and private key are defined in <code>/etc/opscode/chef-server.rb</code> as values for the <code>nginx['ssl_certificate']</code> and <code>nginx['ssl_certificate_key']</code> settings. Delete the files referenced in those two settings and regenerate new keys using the same authority.</p> </li> <li> <p>Run the following command, Chef server-generated SSL certificates will automatically be created if necessary:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-server-ctl reconfigure
</code></pre></div>
</li> <li> <p>Run the following command:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-server-ctl start
</code></pre></div>
</li> </ol> <h2 id="chef-infra-server-credentials-management">Chef Infra Server Credentials Management</h2> <p>Chef Infra Server limits where it writes service passwords and keys to disk. In the default configuration, credentials are only written to files in <code>/etc/opscode</code>.</p> <p>By default, Chef Infra Server still writes service credentials to multiple locations inside <code>/etc/opscode</code>. This is designed to maintain compatibility with add-ons. The <code>insecure_addon_compat</code> configuration option in <code>/etc/opscode/chef-server.rb</code>, allows you to further restrict where credentials are written. <code>insecure_addon_compat</code> can be used if you are not using add-ons, or if you are using the latest add-on versions. Setting <code>insecure_addon_compat</code> to <code>false</code> writes credentials to only one location: <code>/etc/opscode/private-chef-secrets.json</code>.</p> <p>User-provided secrets (such as the password for an external PostgreSQL instance) can still be set in <code>/etc/opscode/chef-server.rb</code> or via the <a href="../ctl_chef_server/index.html#ctl-chef-server-secrets-management">Secrets Management</a> commands. These commands allow you to provide external passwords without including them in your configuration file.</p> <h3 id="add-on-compatibility">Add-on Compatibility</h3> <p>The following table lists which add-on versions support the more restrictive <code>insecure_addon_compat false</code> setting. These versions <strong>require</strong> Chef Server 12.14.0 or greater:</p> <table> <col style="width:50%"> <col style="width:50%"> <thead> <tr class="header"> <th>Add-on Name</th> <th>Minimum Version</th> </tr> </thead> <tbody> <tr class="odd"> <td>Chef Backend</td> <td><em>all</em></td> </tr> <tr class="even"> <td>Chef Manage</td> <td>2.5.0</td> </tr> </tbody> </table> <p>These newer add-ons will also write all of their secrets to <code>/etc/opscode/private-chef-secrets.json</code>. Older versions of the add-ons will still write their configuration to locations in <code>/etc</code> and <code>/var/opt</code>.</p> <h3 id="etcopscodeprivate-chef-secretsjson">/etc/opscode/private-chef-secrets.json</h3> <p><code>/etc/opscode/private-chef-secrets.json</code>’s default permissions allow only the root user to read or write the file. This file contains all of the secrets for access to the Chef server’s underlying data stores and thus access to it should be restricted to trusted users.</p> <p>While the file does not contain passwords in plaintext, it is not safe to share with untrusted users. The format of the secrets file allows Chef Infra Server deployments to conform to regulations that forbid the appearance of sensitive data in plain text in configuration files; however, it does not make the file meaningfully more secure.</p> <h2 id="ssl-encryption-between-chef-infra-server-and-external-postgresql">SSL Encryption Between Chef Infra Server and External PostgreSQL</h2> <p>Chef Infra Server can encrypt traffic between Chef Infra Server and an external PostgreSQL server over SSL. These instructions are not all-encompassing and assume some familiarity with PostgreSQL administration, configuration, and troubleshooting. Consult the <a href="https://www.postgresql.org/docs/9.6/ssl-tcp.html">PostgreSQL documentation</a> for more information.</p> <p>The following is a typical scenario for enabling encryption between a machine running Chef Infra Server and an external machine running PostgreSQL. Both machines must be networked together and accessible to the user.</p> <ol> <li> <p>Run the following command on both machines to gain root access:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">sudo -i
</code></pre></div>
</li> <li> <p>Ensure that <a href="https://www.openssl.org">OpenSSL</a> is installed on the PostgreSQL machine.</p> </li> <li> <p>Ensure that SSL support is compiled in on PostgreSQL. This applies whether you are compiling your own source or using a pre-compiled binary.</p> </li> <li> <p>Place SSL certificates in the proper directories on the PostgreSQL machine and ensure they have correct filenames, ownerships, and permissions.</p> </li> <li> <p>Enable SSL on PostgreSQL by editing the <code>postgresql.conf</code> file. Set <code>ssl = on</code> and specify the paths to the SSL certificates:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text">ssl=on

ssl_cert_file='/path/to/cert/file'
ssl_key_file='/path/to/key/file'
</code></pre></div>
</li> <li> <p>To prevent PostgreSQL from accepting non-SSL connections, edit <code>pg_hba.conf</code> on the PostgreSQL machine and change the relevant Chef Infra Server connections to <code>hostssl</code>.</p> <p>Here is a sample <code>pg_hba.conf</code> file with <span class="title-ref">hostssl</span> connections for Chef Infra Server (the contents of your <code>pg_hba.conf</code> will be different):</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text"># "local" is for Unix domain socket connections only
local      all             all                                     peer

# IPv4 local connections:
hostssl    all             all             127.0.0.1/32            md5

# IPv6 local connections:
hostssl    all             all             ::1/128                 md5

# nonlocal connections
hostssl    all             all            192.168.33.100/32        md5
</code></pre></div>
</li> <li> <p>Restart PostgreSQL. This can typically be done with the following command on the PostgreSQL machine:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">/path/to/postgresql/postgresql restart
</code></pre></div>
</li> <li> <p>Edit <code>/etc/opscode/chef-server.rb</code> on the Chef Infra Server and ad the following line:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">postgresql<span style="color:#666">[</span><span style="color:#4070a0">'sslmode'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'require'</span>
</code></pre></div>
</li> <li> <p>Run reconfigure on the Chef Infra Server:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-server-ctl reconfigure
</code></pre></div>
</li> <li> <p>Verify that SSL is enabled and that SSL connections are up between Chef Infra Server and your running PostgreSQL instance. One way to do this is to log into the PostgreSQL database from the Chef Infra Server by running <code>chef-server-ctl psql</code> and then examine the SSL state using SQL queries.</p> <p>Start a psql session:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash">chef-server-ctl psql opscode_chef
</code></pre></div>
<p>From the psql session, enter <code>postgres=# show ssl;</code> which will show if ssl is enabled:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-sql" data-lang="sql">postgres<span style="color:#666">=#</span><span style="color:#007020;font-weight:700">show</span>ssl;ssl<span style="color:#60a0b0;font-style:italic">-----
</span><span style="color:#007020;font-weight:700">on</span>(<span style="color:#40a070">1</span><span style="color:#007020;font-weight:700">row</span>)</code></pre></div>
<p>Then enter <code>postgres=# select * from pg_stat_ssl;</code> which will return true (<code>t</code>) in rows with SSL connections:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-sql" data-lang="sql">postgres<span style="color:#666">=#</span><span style="color:#007020;font-weight:700">select</span><span style="color:#666">*</span><span style="color:#007020;font-weight:700">from</span>pg_stat_ssl;pid<span style="color:#666">|</span>ssl<span style="color:#666">|</span><span style="color:#007020;font-weight:700">version</span><span style="color:#666">|</span>cipher<span style="color:#666">|</span>bits<span style="color:#666">|</span>compression<span style="color:#666">|</span>clientdn<span style="color:#60a0b0;font-style:italic">-------+-----+---------+-----------------------------+------+-------------+----------
</span><span style="color:#40a070">16083</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16084</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16085</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16086</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16087</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16088</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16089</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16090</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16091</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16092</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16093</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16094</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16095</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16096</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16097</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16098</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16099</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16100</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16101</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16102</span><span style="color:#666">|</span>t<span style="color:#666">|</span>TLSv1.<span style="color:#40a070">2</span><span style="color:#666">|</span>ECDHE<span style="color:#666">-</span>RSA<span style="color:#666">-</span>AES256<span style="color:#666">-</span>GCM<span style="color:#666">-</span>SHA384<span style="color:#666">|</span><span style="color:#40a070">256</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#40a070">16119</span><span style="color:#666">|</span>f<span style="color:#666">|</span><span style="color:#666">|</span><span style="color:#666">|</span><span style="color:#666">|</span><span style="color:#666">|</span>(<span style="color:#40a070">21</span><span style="color:#007020;font-weight:700">rows</span>)</code></pre></div>
</li> </ol> <h2 id="key-rotation">Key Rotation</h2> <p>See the <a href="../ctl_chef_server/index.html#key-rotation">chef-server-ctl key rotation commands</a> for more information about user key management.</p> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/server/server_security/" class="_attribution-link">https://docs.chef.io/server/server_security/</a>
  </p>
</div>
