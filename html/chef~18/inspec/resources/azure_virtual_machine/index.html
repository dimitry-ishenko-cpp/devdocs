<div id="col-content" data-swiftype-index="true"> <div id="azure_virtual_machine-resource"><h1>azure_virtual_machine resource</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/inspec/inspec/tree/main/docs-chef-io/content/inspec/resources/azure_virtual_machine.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>Use the <code>azure_virtual_machine</code> Chef InSpec audit resource to ensure that a Virtual Machine has been provisioned correctly.</p> <h2 id="availability">Availability</h2> <h3 id="installation">Installation</h3> <p>This resource is distributed along with Chef InSpec itself. You can use it automatically.</p> <h3 id="version">Version</h3> <p>This resource first became available in v2.0.16 of InSpec.</p> <h2 id="syntax">Syntax</h2> <p>The name of the machine and the resource group are required as properties to the resource.</p> <pre class="highlight" data-language="ruby"><code>describe azure_virtual_machine(group_name: 'MyResourceGroup', name: 'MyVM') do
  its('property') { should eq 'value' }
end
</code></pre> <p>where</p> <ul> <li>
<code>MyVm</code> is the name of the virtual machine as seen in Azure; it is <strong>not</strong> the hostname of the machine</li> <li>
<code>MyResourceGroup</code> is the name of the machine’s resource group</li> <li>
<code>property</code> is one of the resource properties</li> <li>
<code>value</code> is the expected output from the matcher</li> </ul> <h2 id="examples">Examples</h2> <p>The following examples show to use this Chef InSpec audit resource.</p> <h3 id="check-that-the-first-data-disk-is-of-the-correct-size">Check that the first data disk is of the correct size</h3> <pre class="highlight" data-language="ruby"><code>describe azure_virtual_machine_data_disk(group_name: 'InSpec-Azure', name: 'Linux-Internal-VM').where(number: 1) do
  its('size') { should cmp &gt;= 15 }
end
</code></pre> <h2 id="parameters">Parameters</h2> <ul> <li><code>group_name</code></li> <li><code>name</code></li> <li><code>apiversion</code></li> </ul> <p>The options that can be passed to the resource are as follows.</p> <h3 id="group_name-required">
<code>group_name</code> (required)</h3> <p>Use this parameter to define the Azure Resource Group to be tested.</p> <pre class="highlight" data-language="ruby"><code>describe azure_virtual_machine_data_disk(group_name: 'InSpec-Azure') do
    ...
end
</code></pre> <h3 id="name"><code>name</code></h3> <p>Use this parameter to define the name of the Azure resource to test.</p> <pre class="highlight" data-language="ruby"><code>describe azure_virtual_machine_data_disk(group_name: 'InSpec-Azure', name: 'Windows-Internal-VM') do
    ...
end
</code></pre> <h3 id="apiversion"><code>apiversion</code></h3> <p>The API Version to use when querying the resource. Defaults to the latest version for the resource.</p> <pre class="highlight" data-language="ruby"><code>describe azure_virtual_machine_data_disk(group_name: 'InSpec-Azure', name: 'Windows-Internal-VM', apiversion: '2.0') do
    ...
end
</code></pre> <p>These options can also be set using the environment variables:</p> <ul> <li><code>AZURE_RESOURCE_GROUP_NAME</code></li> <li><code>AZURE_RESOURCE_NAME</code></li> <li><code>AZURE_RESOURCE_API_VERSION</code></li> </ul> <p>When the options have been set as well as the environment variables, the environment variables take priority.</p> <h2 id="properties">Properties</h2> <ul> <li>
<code>type</code>, <code>location</code>, <code>name</code>, <code>publisher</code>, <code>offer</code>, <code>sku</code>, <code>os_type</code>, <code>os_disk_name</code>, <code>have_managed_osdisk</code>, <code>caching</code>, <code>create_option</code>, <code>disk_size_gb</code>, <code>have_data_disks</code>, <code>data_disk_count</code> , <code>storage_account_type</code>, <code>vm_size</code>, <code>computer_name</code>, <code>admin_username</code>, <code>have_nics</code>, <code>nic_count</code>, <code>connected_nics</code>, <code>have_password_authentication</code>, <code>password_authentication?</code>, <code>have_custom_data</code>, <code>custom_data?</code>, <code>have_ssh_keys</code>, <code>ssh_keys?</code>, <code>ssh_key_count</code>, <code>ssh_keys</code>, <code>have_boot_diagnostics</code>, <code>boot_diagnostics_storage_uri</code>
</li> </ul> <h2 id="property-examples">Property Examples</h2> <p>This Chef InSpec audit resource has the following properties that can be tested:</p> <h3 id="type">type</h3> <p>The Azure Resource type. For a virtual machine this will always return <code>Microsoft.Compute/virtualMachines</code></p> <pre class="highlight" data-language="ruby"><code>its('type') { should cmp 'Microsoft.Compute/virtualMachines' }
</code></pre> <h3 id="location">location</h3> <p>Where the machine is located</p> <pre class="highlight" data-language="ruby"><code>its('location') { should eq 'westeurope' }
</code></pre> <h3 id="name-1">name</h3> <p>Name of the Virtual Machine in Azure. Be aware that this is not the computer name or hostname, rather the name of the machine when seen in the Azure Portal.</p> <pre class="highlight" data-language="ruby"><code>its('name') { should cmp 'InSpec-Azure' }
</code></pre> <h3 id="publisher">publisher</h3> <p>The publisher of this machine’s build image.</p> <p><code>nil</code> if the machine was created from a custom image.</p> <pre class="highlight" data-language="ruby"><code>its('publisher') { should cmp 'MicrosoftWindowsServer' }
</code></pre> <h3 id="offer">offer</h3> <p>The offer from the publisher of the build image.</p> <p><code>nil</code> if the machine was created from a custom image.</p> <pre class="highlight" data-language="ruby"><code>its('offer') { should cmp 'WindowsServer' }
</code></pre> <h3 id="sku">sku</h3> <p>The item from the publisher that was used to create the image.</p> <p><code>nil</code> if the machine was created from a custom image.</p> <pre class="highlight" data-language="ruby"><code>its('sku') { should cmp '2016-Datacenter' }
</code></pre> <h3 id="os_type">os_type</h3> <p>Test that returns the classification in Azure of the operating system type. Usually either <code>Linux</code> or <code>Windows</code>.</p> <pre class="highlight" data-language="ruby"><code>its('os_type') { should cmp 'Windows' }
</code></pre> <h3 id="os_disk_name">os_disk_name</h3> <p>Return the name of the operating system disk attached to the machine.</p> <pre class="highlight" data-language="ruby"><code>its('os_disk_name') { should cmp 'Windows-Internal-OSDisk-MD' }
</code></pre> <h3 id="caching">caching</h3> <p>Returns the type of caching that has been set on the operating system disk.</p> <pre class="highlight" data-language="ruby"><code>its('caching') { should cmp 'ReadWrite' }
</code></pre> <h3 id="create_option">create_option</h3> <p>When the operating system disk is created, how it was created is set as a property. This property returns how the disk was created.</p> <pre class="highlight" data-language="ruby"><code>its('create_option') { should cmp 'FromImage' }
</code></pre> <h3 id="disk_size_gb">disk_size_gb</h3> <p>Returns the size of the operating system disk.</p> <pre class="highlight" data-language="ruby"><code>its('disk_size_gb') { should be &gt;= 30 }
</code></pre> <h3 id="data_disk_count">data_disk_count</h3> <p>Return the number of data disks that are attached to the machine</p> <h3 id="storage_account_type">storage_account_type</h3> <p>This provides the storage account type for a machine that is using managed disks for the operating system disk.</p> <pre class="highlight" data-language="ruby"><code>its('storage_account_type') { should cmp 'Standard_LRS' }
</code></pre> <h3 id="vm_size">vm_size</h3> <p>The size of the machine in Azure</p> <pre class="highlight" data-language="ruby"><code>its('vm_size') { should eq 'Standard_DS2_v2' }
</code></pre> <h3 id="computer_name">computer_name</h3> <p>The name of the machine. This is what was assigned to the machine during deployment and is what <em>should</em> be returned by the <code>hostname</code> command.</p> <pre class="highlight" data-language="ruby"><code>its('computer_name') { should cmp 'win-internal-1' }
</code></pre> <h3 id="admin_username">admin_username</h3> <p>The admin username that was assigned to the machine</p> <p>NOTE: Azure does not allow the use of <code>Administrator</code> as the admin username on a Windows machine</p> <pre class="highlight" data-language="ruby"><code>its('admin_username') { should cmp 'azure' }
</code></pre> <h3 id="nic_count">nic_count</h3> <p>The number of network interface cards that have been attached to the machine</p> <pre class="highlight" data-language="ruby"><code>its('nic_count') { should eq 1 }
</code></pre> <h3 id="connected_nics">connected_nics</h3> <p>This returns an array of the NIC ids that are connected to the machine. This means that it possible to check that the machine has the correct NIC(s) attached and thus on the correct subnet.</p> <pre class="highlight" data-language="ruby"><code>its('connected_nics') { should include /Inspec-NIC-1/ }
</code></pre> <p>Note the use of the regular expression here. This is because the NIC id is a long string that contains the subscription id, resource group, machine id as well as other things. By using the regular expression the NIC can be checked without breaking this string up. It also means that other tests can be performed.</p> <p>An example of the id string is <code>/subscriptions/1e0b427a-d58b-494e-ae4f-ee558463ebbf/resourceGroups/Inspec-Azure/providers/Microsoft.Network/networkInterfaces/Inspec-NIC-1</code></p> <h3 id="password_authentication">password_authentication?</h3> <p>Boolean to state of password authentication is enabled or not for the admin user.</p> <pre class="highlight" data-language="ruby"><code>its('password_authentication?') { should be false }
</code></pre> <p>This only applies to Linux machines and will always return <code>true</code> on Windows.</p> <h3 id="custom_data">custom_data</h3> <p>Boolean to state if the machine has custom data or not</p> <pre class="highlight" data-language="ruby"><code>its('custom_data') { should be true }
</code></pre> <h3 id="ssh_keys">ssh_keys?</h3> <p>Boolean to state of the machine is accessible using SSH keys</p> <pre class="highlight" data-language="ruby"><code>its('ssh_keys?') { should be true }
</code></pre> <p>### ssh_key_count</p> <p>Returns how many SSH keys have been applied to the machine.</p> <p>This only applies to Linux machines and will always return <code>0</code> on Windows.</p> <pre class="highlight" data-language="ruby"><code>its('ssh_key_count') { should eq '0' }
</code></pre> <h3 id="ssh_keys-1">ssh_keys</h3> <p>Returns an array of the keys that are assigned to the machine. This checks if the correct keys are assigned.</p> <p>Most SSH public keys have a signature at the end of them that can be tested. For example:</p> <pre class="highlight" data-language="ruby"><code>its('ssh_keys') { should include /azure@inspec.local/ }
</code></pre> <h3 id="boot_diagnostics_storage_uri">boot_diagnostics_storage_uri</h3> <p>If boot diagnostics are enabled for the machine they will be saved in a storage account. This method returns the URI for the storage account.</p> <pre class="highlight" data-language="ruby"><code>its('boot_diagnostics_storage_uri') { should match 'ghjgjhgjg' }
</code></pre> <h2 id="matchers">Matchers</h2> <p>There are a number of built in comparison operators that are available to test the result with an expected value.</p> <p>For information on all that are available please refer to the <a href="../../matchers/index.html">Chef InSpec Matchers Reference</a> page.</p> <h3 id="boot_diagnostics">boot_diagnostics?</h3> <p>Boolean test to see if boot diagnostics have been enabled on the machine</p> <pre class="highlight" data-language="ruby"><code>it { should have_boot_diagnostics }
</code></pre> <h3 id="have_custom_data">have_custom_data</h3> <p>Returns a boolean stating if the machine has custom data assigned to it.</p> <pre class="highlight" data-language="ruby"><code>it { should have_custom_data }
</code></pre> <h3 id="have_data_disks">have_data_disks</h3> <p>Denotes if the machine has data disks attached to it or not.</p> <pre class="highlight" data-language="ruby"><code>it { should have_data_disks }
</code></pre> <h3 id="have_managed_osdisk">have_managed_osdisk</h3> <p>Determine if the operating system disk is a Managed Disks or not.</p> <p>This test can be used in the following way:</p> <pre class="highlight" data-language="ruby"><code>it { should have_managed_osdisk }
</code></pre> <h3 id="have_nics">have_nics</h3> <p>Returns a boolean to state if the machine has NICs connected or not.</p> <p>This can be used in the following way:</p> <pre class="highlight" data-language="ruby"><code>it { should have_nics }
</code></pre> <h3 id="have_password_authentication">have_password_authentication</h3> <p>Returns a boolean to denote if the machine is accessible using a password.</p> <pre class="highlight" data-language="ruby"><code>it { should have_password_authentication }
</code></pre> <h3 id="have_ssh_keys">have_ssh_keys</h3> <p>Boolean to state if the machine has SSH keys assigned to it</p> <pre class="highlight" data-language="ruby"><code>it { should have_ssh_keys }
</code></pre> <p>For a Windows machine this will always be false.</p> <h2 id="tags">Tags</h2> <p>It is possible to test the tags that have been assigned to the resource. There are a number of properties that can be called to check that it has tags, that it has the correct number and that the correct ones are assigned.</p> <h3 id="have_tags">have_tags</h3> <p>This is a simple test to see if the machine has tags assigned to it or not.</p> <pre class="highlight" data-language="ruby"><code>it { should have_tags }
</code></pre> <h3 id="tag_count">tag_count</h3> <p>Returns the number of tags that are assigned to the resource</p> <pre class="highlight" data-language="ruby"><code>its ('tag_count') { should eq 2 }
</code></pre> <h3 id="tags-1">tags</h3> <p>It is possible to check if a specific tag has been set on the resource.</p> <pre class="highlight" data-language="ruby"><code>its('tags') { should include 'Owner' }
</code></pre> <h3 id="xxx_tag">xxx_tag</h3> <p>To get the value of the tag, a number of tests have been created from the tags that are set.</p> <p>For example, if the following tag is set on a resource:</p> <ul> <li>owner: J.G. Jingleheimerschmidt</li> </ul> <p>Then a test is available called <code>Owner_tag</code>.</p> <pre class="highlight" data-language="ruby"><code>its('owner_tag') { should cmp 'J.G. Jingleheimerschmidt' }
</code></pre> <p>Note: The tag name is case sensitive which makes the test case sensitive. E.g. <code>owner_tag</code> does not equal <code>Owner_tag</code>.</p> <h2 id="references">References</h2> <ul> <li><a href="https://github.com/Azure/azure-sdk-for-ruby/tree/main/management/azure_mgmt_resources">Azure Ruby SDK - Resources</a></li> <li><a href="https://github.com/chef/inspec/blob/fc990346f2438690f0ac36a9f6606e61574a79b8/test/azure/verify/controls/virtual_machine_external_vm.rb">Virtual Machine External VM</a></li> <li><a href="https://github.com/chef/inspec/blob/fc990346f2438690f0ac36a9f6606e61574a79b8/test/azure/verify/controls/virtual_machine_internal_vm.rb">Virtual Machine Internal VM</a></li> </ul> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/inspec/resources/azure_virtual_machine/" class="_attribution-link">https://docs.chef.io/inspec/resources/azure_virtual_machine/</a>
  </p>
</div>
