<div id="col-content" data-swiftype-index="true"> <div id="chef-inspec-profile-style-guide"><h1>Chef InSpec Profile Style Guide</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/inspec/inspec/tree/main/docs-chef-io/content/inspec/style.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>This is a set of recommended Chef InSpec rules you should use when writing controls.</p> <h2 id="control-files">Control Files</h2> <h3 id="place-control-files-in-controls-and-end-them-with-rb">Place control files in <code>controls/</code> and end them with <code>.rb</code>
</h3> <p>Most syntax highlighters will render Chef InSpec files correctly across a wide list of tools.</p> <p>Avoid:</p> <ul> <li><code>controls/ssh_config</code></li> <li><code>controls/ssh/config.rb</code></li> </ul> <p>Use:</p> <ul> <li><code>controls/ssh_config.rb</code></li> <li><code>controls/ssh_config.rb</code></li> </ul> <h3 id="avoid-controlscontrol-in-your-control-filenames">Avoid <code>controls</code>/<code>control</code> in your control filenames</h3> <p>Using <code>controls</code> in the filename creates unnecessary clutter when reading it. Keep the names short and concise.</p> <p>Avoid:</p> <ul> <li><code>controls/ssh_controls.rb</code></li> </ul> <p>Use:</p> <ul> <li><code>controls/ssh.rb</code></li> </ul> <h2 id="code-style">Code Style</h2> <h3 id="avoid-unnecessary-parentheses-in-matchers">Avoid unnecessary parentheses in matchers</h3> <p>Adding additional parentheses is not required and provides more readability if it is not used:</p> <p>Avoid:</p> <ul> <li><code>it { should eq(value) }</code></li> </ul> <p>Use:</p> <ul> <li><code>it { should eq value }</code></li> </ul> <p>The exception are matchers that require additional arguments or named arguments.</p> <h2 id="controls">Controls</h2> <h3 id="avoid-wrapping-controls-in-conditional-statements">Avoid wrapping controls in conditional statements</h3> <p>This will create dynamic profiles whose controls depend on the execution. The problem here is that we cannot render the profile or provide its information before scanning a system. We want to be able to inform users of the contents of their profiles before they run them. It is valid to skip controls that are not necessary for a system, as long as you do it via <code>only_if</code> conditions. Ruby’s internal conditionals will hide parts of the profile to static analysis and should thus be avoided.</p> <p>Avoid:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#007020;font-weight:700">if</span> package(<span style="color:#4070a0">'..'</span>)<span style="color:#666">.</span>installed?
  control <span style="color:#4070a0">"package-test1"</span> <span style="color:#007020;font-weight:700">do</span>
    <span style="color:#666">..</span>
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>Use:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">control <span style="color:#4070a0">"package-test1"</span> <span style="color:#007020;font-weight:700">do</span>
  only_if { package(<span style="color:#4070a0">'..'</span>)<span style="color:#666">.</span>installed? }
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>Avoid:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#007020;font-weight:700">case</span> inspec<span style="color:#666">.</span>platform<span style="color:#666">.</span>name
<span style="color:#007020;font-weight:700">when</span> <span style="color:#235388">/centos/</span>
  include_controls <span style="color:#4070a0">'centos-profile'</span>
<span style="color:#666">...</span>
</code></pre></div>
<p>Instead use the <code>supports</code> attribute in the <code>inspec.yml</code> of the profile you want to include:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#517918">supports</span>:
  <span style="color:#666">-</span> platform<span style="color:#666">-</span><span style="color:#007020">name</span>: centos
</code></pre></div>
<p>Now whenever you run the base profile you can just <code>include_controls 'centos-profile'</code>. It will only run the included profiles is the platform matches the supported platform.</p> <h3 id="avoid-dynamic-elements-in-the-control-ids">Avoid dynamic elements in the control IDs</h3> <p>Control IDs are used to map test results to the tests and profiles. Dynamic control IDs make it impossible to map results back, since the identifier which connects tests and results may change in the process.</p> <p>Avoid:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">control <span style="color:#4070a0">"test-file-</span><span style="color:#70a0d0;font-style:italic">#{</span><span style="color:#007020">name</span><span style="color:#70a0d0;font-style:italic">}</span><span style="color:#4070a0">"</span> <span style="color:#007020;font-weight:700">do</span>
  <span style="color:#666">..</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>Use:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">control <span style="color:#4070a0">"test-all-files"</span> <span style="color:#007020;font-weight:700">do</span>
  <span style="color:#666">..</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>Sometimes you may create controls from a static list of elements. If this list stays the same no matter what system is scanned, it may be ok to do so and use it as a generator for static controls.</p> <h3 id="avoid-ruby-system-calls">Avoid Ruby system calls</h3> <p>Ruby code is executed on the system that runs InSpec. This allows Chef InSpec to work without Ruby and RubyGems being required on remote targets (servers or containers). System calls are often used to interact with the local OS or remote endpoints from a local installation.</p> <p>Chef InSpec tests, however, are designed to be universally executable on all types of runtimes, including local and remote execution. We want to give users the ability to take an OS profile and execute it remotely or locally.</p> <h3 id="avoid-shelling-out">Avoid shelling out</h3> <p>Avoid:</p> <ul> <li><code>`ls`</code></li> <li><code>system("ls")</code></li> <li><code>IO.popen("ls")</code></li> </ul> <p>Use:</p> <ul> <li>
<code>command("ls")</code> or <code>powershell("Get-ChildItem")</code>
</li> </ul> <p>Ruby’s command executors will only run locally. Imagine a test like this:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">describe <span style="color:#4070a0">`whoami`</span> <span style="color:#007020;font-weight:700">do</span>
  it { should cmp <span style="color:#4070a0">"bob</span><span style="color:#4070a0;font-weight:700">\n</span><span style="color:#4070a0">"</span> }
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>If you run this test on your local system and happen to be using Bob’s account it will succeed. But if you were to run it against <code>--target alice@remote-host.com</code> it will still report that the user is bob instead of alice.</p> <p>Instead, do this:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">describe command(<span style="color:#4070a0">'whoami'</span>) <span style="color:#007020;font-weight:700">do</span>
  its(<span style="color:#4070a0">'stdout'</span>) { should cmp <span style="color:#4070a0">"bob</span><span style="color:#4070a0;font-weight:700">\n</span><span style="color:#4070a0">"</span> }
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>If the profile is pointed to a remote endpoint using the <code>command</code> resource will run it on the remote OS.</p> <h3 id="avoid-ruby-io-on-files">Avoid Ruby IO on files</h3> <p>Similar to the command interactions these files will only be read locally with Ruby’s internal calls. If you run this test against a remote target it won’t read the file from the remote endpoint, but from the local OS instead. Use the <code>file</code> resource to read files on the target system.</p> <p>Avoid:</p> <ul> <li><code>File.new("filename").read</code></li> <li><code>File.read("filename")</code></li> <li><code>IO.read("filename")</code></li> </ul> <p>Use:</p> <ul> <li><code>file("filename")</code></li> </ul> <p>In general, try to avoid Ruby’s IO calls from within Chef InSpec controls and use Chef InSpec resources instead.</p> <h3 id="avoid-ruby-gem-dependencies-in-controls">Avoid Ruby gem dependencies in controls</h3> <p>In addition to avoiding system-level gems and modules you should also limit the use of external dependencies to resource packs or plugins. Gems need to be resolved, installed, vendored, and protected from conflicts. We aim to avoid exposing this complexity to users of InSpec, to make it a great tool even if you are not a developer.</p> <p>Plugins should declare gem dependencies in their gemspec, and then rely on the plugin installation facility to install and manage dependencies.</p> <h3 id="avoid-debugging-calls-in-production">Avoid debugging calls (in production)</h3> <p>One of the best way to develop and explore tests is the interactive debugging shell <code>pry</code> (see [Interactive Debugging with Pry] (/inspec/dsl_inspec/#interactive-debugging-with-pry) at the end of this page). However, after you finish your profile make sure you have no interactive statements included anymore. Sometimes interactive calls are hidden behind conditionals (<code>if</code> statements) that are harder to reach. These calls can easily cause trouble when an automated profiles runs into an interactive <code>pry</code> call that stops the execution and waits for user input.</p> <p>Avoid:</p> <ul> <li>
<code>binding.pry</code> in production profiles</li> </ul> <p>Use:</p> <ul> <li>Use debugging calls during development only</li> </ul> <p>Also you may find it helpful to use the Chef InSpec logging interface:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60add5">Inspec</span><span style="color:#666">::</span><span style="color:#60add5">Log</span><span style="color:#666">.</span>info(<span style="color:#4070a0">'Hi'</span>)
</code></pre></div>
<h4 id="9-favor-cmp-over-eq">9. Favor <code>cmp</code> over <code>eq</code>
</h4> <p>The <code>cmp</code> matcher handles type conversions, case insensitive comparisons, converting strings to versions (e.g. ‘7.35.0-1ubuntu2.10’), and many other troublesome things. Unless you want an exact match (if so use the <code>eq</code> matcher) then the <code>cmp</code> matcher should be used.</p> <p>For example, this:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">describe passwd<span style="color:#666">.</span>uids(<span style="color:#40a070">0</span>) <span style="color:#007020;font-weight:700">do</span>
  its(<span style="color:#4070a0">'users'</span>) { should cmp <span style="color:#4070a0">'root'</span> }
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>is preferred over:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">describe passwd<span style="color:#666">.</span>uids(<span style="color:#40a070">0</span>) <span style="color:#007020;font-weight:700">do</span>
  its(<span style="color:#4070a0">'users'</span>) { should eq <span style="color:#666">[</span><span style="color:#4070a0">'root'</span><span style="color:#666">]</span> }
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>See the <a href="../matchers/index.html#cmp"><code>cmp</code> matcher documentation</a> for more examples.</p> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/inspec/style/" class="_attribution-link">https://docs.chef.io/inspec/style/</a>
  </p>
</div>
