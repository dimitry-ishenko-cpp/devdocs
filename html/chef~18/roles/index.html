<div id="col-content" data-swiftype-index="true"> <div id="about-roles"><h1>About Roles</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/chef-web-docs/blob/main/content/roles.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>A role is a way to define certain patterns and processes that exist across nodes in an organization as belonging to a single job function. Each role consists of zero (or more) attributes and a run-list. Each node can have zero (or more) roles assigned to it. When a role is run against a node, the configuration details of that node are compared against the attributes of the role, and then the contents of that role’s run-list are applied to the node’s configuration details. When a Chef Infra Client runs, it merges its own attributes and run-lists with those contained within each assigned role.</p> <h2 id="role-attributes">Role Attributes</h2> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> Attributes can be configured in cookbooks (attribute files and recipes), roles, and environments. In addition, Ohai collects attribute data about each node at the start of a Chef Infra Client run. See <a href="../attributes/index.html">Attributes</a> for more information about how all of these attributes fit together. </div> </div> <p>An attribute can be defined in a role and then used to override the default settings on a node. When a role is applied during a Chef Infra Client run, these attributes are compared to the attributes that are already present on the node. When the role attributes take precedence over the default attributes, Chef Infra Client applies those new settings and values during a Chef Infra Client run.</p> <p>A role attribute can only be set to be a default attribute or an override attribute. A role attribute cannot be set to be a normal attribute. Use the <code>default_attribute</code> and <code>override_attribute</code> methods in the <code>.rb</code> attributes file or the <code>default_attributes</code> and <code>override_attributes</code> hashes in a JSON data file.</p> <h3 id="attribute-types">Attribute Types</h3> <p>There are two types of attributes that can be used with roles:</p> <table> <col style="width:40%"> <col style="width:60%"> <thead> <tr class="header"> <th>Attribute Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>default</code></td> <td> A <code>default</code> attribute is automatically reset at the start of every Chef Infra Client run and has the lowest attribute precedence. Use <code>default</code> attributes as often as possible in cookbooks. </td> </tr> <tr> <td><code>override</code></td> <td> An <code>override</code> attribute is automatically reset at the start of every Chef Infra Client run and has a higher attribute precedence than <code>default</code>, <code>force_default</code>, and <code>normal</code> attributes. An <code>override</code> attribute is most often specified in a recipe, but can be specified in an attribute file, for a role, and/or for an environment. A cookbook should be authored so that it uses <code>override</code> attributes only when required. </td> </tr> </tbody> </table> <h2 id="role-formats">Role Formats</h2> <p>Role data is stored in two formats: as a Ruby file that contains domain-specific language and as JSON data.</p> <h3 id="chef-language">Chef Language</h3> <p>Ruby is a simple programming language:</p> <ul> <li>Chef uses Ruby as its reference language to define the patterns that are found in resources, recipes, and cookbooks</li> <li>Use these patterns to configure, deploy, and manage nodes across the network</li> </ul> <p>Ruby is also a powerful and complete programming language:</p> <ul> <li>Use the Ruby programming language to make decisions about what should happen to specific resources and recipes</li> <li>Extend Chef in any manner that your organization requires</li> </ul> <p>To learn more about Ruby, see:</p> <ul> <li><a href="https://www.ruby-lang.org/en/documentation/">Ruby Documentation</a></li> <li><a href="https://www.ruby-doc.org/stdlib/">Ruby Standard Library Documentation</a></li> </ul> <p>Domain-specific Ruby attributes:</p> <table> <col style="width:40%"> <col style="width:60%"> <thead> <tr class="header"> <th>Setting</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><p><code>default_attributes</code></p></td> <td>
<p>Optional. A set of attributes to be applied to all nodes, assuming the node does not already have a value for the attribute. This is useful for setting global defaults that can then be overridden for specific nodes. If more than one role attempts to set a default value for the same attribute, the last role applied is the role to set the attribute value. When nested attributes are present, they are preserved. For example, to specify that a node that has the attribute <code>apache2</code> should listen on ports 80 and 443 (unless ports are already specified):</p> <div class="sourceCode" id="cb1"><pre class="sourceCode ruby highlight" data-language="ruby"><code class="sourceCode ruby"><span id="cb1-1">default_attributes <span class="st">'apache2'</span> =&gt; {</span>
<span id="cb1-2">  <span class="st">'listen_ports'</span> =&gt; [ <span class="st">'80'</span>, <span class="st">'443'</span> ]</span>
<span id="cb1-3">}</span></code></pre></div>
</td> </tr> <tr> <td><p><code>description</code></p></td> <td>
<p>A description of the functionality that is covered. For example:</p> <div class="sourceCode" id="cb2"><pre class="sourceCode ruby highlight" data-language="ruby"><code class="sourceCode ruby"><span id="cb2-1">description <span class="st">'The base role for systems that serve HTTP traffic'</span></span></code></pre></div>
</td> </tr> <tr> <td><p><code>env_run_lists</code></p></td> <td>
<p>Optional. A list of environments, each specifying a recipe or a role to be applied to that environment. This setting must specify the <code>_default</code> environment. If the <code>_default</code> environment is set to <code>[]</code> or <code>nil</code>, then the run-list is empty. For example:</p> <div class="sourceCode" id="cb3"><pre class="sourceCode ruby highlight" data-language="ruby"><code class="sourceCode ruby"><span id="cb3-1">env_run_lists <span class="st">'prod'</span> =&gt; [<span class="st">'recipe[apache2]'</span>],</span>
<span id="cb3-2">              <span class="st">'staging'</span> =&gt; [<span class="st">'recipe[apache2::staging]'</span></span></code></pre></div> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> Using <code>env_run_lists</code> with roles is discouraged as it can be difficult to maintain over time. Instead, consider using multiple roles to define the required behavior. </div> </div> </td> </tr> <tr> <td><p><code>name</code></p></td> <td>
<p>A unique name within the organization. Each name must be made up of letters (upper- and lower-case), numbers, underscores, and hyphens: [A-Z][a-z][0-9] and [_-]. Spaces are not allowed. For example:</p> <div class="sourceCode" id="cb4"><pre class="sourceCode ruby highlight" data-language="ruby"><code class="sourceCode ruby"><span id="cb4-1">name <span class="st">'dev01-24'</span></span></code></pre></div>
</td> </tr> <tr> <td><p><code>override_attributes</code></p></td> <td>
<p>Optional. A set of attributes to be applied to all nodes, even if the node already has a value for an attribute. This is useful for ensuring that certain attributes always have specific values. If more than one role attempts to set an override value for the same attribute, the last role applied wins. When nested attributes are present, they are preserved. For example:</p> <div class="sourceCode" id="cb5"><pre class="sourceCode ruby highlight" data-language="ruby"><code class="sourceCode ruby"><span id="cb5-1">override_attributes <span class="st">'apache2'</span> =&gt; {</span>
<span id="cb5-2">  <span class="st">'max_children'</span> =&gt; <span class="st">'50'</span></span>
<span id="cb5-3">}</span></code></pre></div> <p>The parameters in a Ruby file are Ruby method calls, so parentheses can be used to provide clarity when specifying numerous or deeply-nested attributes. For example:</p> <div class="sourceCode" id="cb6"><pre class="sourceCode ruby highlight" data-language="ruby"><code class="sourceCode ruby"><span id="cb6-1">override_attributes(</span>
<span id="cb6-2">  <span class="st">:apache2</span> =&gt; {</span>
<span id="cb6-3">    <span class="st">:prefork</span> =&gt; { <span class="st">:min_spareservers</span> =&gt; <span class="ch">'5'</span> }</span>
<span id="cb6-4">  }</span>
<span id="cb6-5">)</span></code></pre></div> <p>Or:</p> <div class="sourceCode" id="cb7"><pre class="sourceCode ruby highlight" data-language="ruby"><code class="sourceCode ruby"><span id="cb7-1">override_attributes(</span>
<span id="cb7-2">  <span class="st">:apache2</span> =&gt; {</span>
<span id="cb7-3">    <span class="st">:prefork</span> =&gt; { <span class="st">:min_spareservers</span> =&gt; <span class="ch">'5'</span> }</span>
<span id="cb7-4">  },</span>
<span id="cb7-5">  <span class="st">:tomcat</span> =&gt; {</span>
<span id="cb7-6">    <span class="st">:worker_threads</span> =&gt; <span class="st">'100'</span></span>
<span id="cb7-7">  }</span>
<span id="cb7-8">)</span></code></pre></div>
</td> </tr> <tr> <td><p><code>run_list</code></p></td> <td>
<p>A list of recipes and/or roles to be applied and the order in which they are to be applied. For example, the following run-list:</p> <div class="sourceCode" id="cb8"><pre class="sourceCode ruby highlight" data-language="ruby"><code class="sourceCode ruby"><span id="cb8-1">run_list <span class="st">'recipe[apache2]'</span>,</span>
<span id="cb8-2">         <span class="st">'recipe[apache2::mod_ssl]'</span>,</span>
<span id="cb8-3">         <span class="st">'role[monitor]'</span></span></code></pre></div> <p>would apply the <code>apache2</code> recipe first, then the <code>apache2::mod_ssl</code> recipe, and then the <code>role[monitor]</code> recipe.</p>
</td> </tr> </tbody> </table> <p>Each role must be saved as a ruby file the <code>roles/</code> subdirectory of the chef-repo. (If the repository does not have this subdirectory, then create it using knife.) Each Ruby file should have the .rb suffix. A complete role has the following syntax:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-javascript" data-lang="javascript">name <span style="color:#4070a0">"role_name"</span>
description <span style="color:#4070a0">"role_description"</span>
run_list <span style="color:#4070a0">"recipe[name]"</span>, <span style="color:#4070a0">"recipe[name::attribute]"</span>, <span style="color:#4070a0">"recipe[name::attribute]"</span>
env_run_lists <span style="color:#4070a0">"name"</span> =&gt; [<span style="color:#4070a0">"recipe[name]"</span>], <span style="color:#4070a0">"environment_name"</span> =&gt; [<span style="color:#4070a0">"recipe[name::attribute]"</span>]
default_attributes <span style="color:#4070a0">"node"</span> =&gt; { <span style="color:#4070a0">"attribute"</span> =&gt; [ <span style="color:#4070a0">"value"</span>, <span style="color:#4070a0">"value"</span>, <span style="color:#4070a0">"etc."</span> ] }
override_attributes <span style="color:#4070a0">"node"</span> =&gt; { <span style="color:#4070a0">"attribute"</span> =&gt; [ <span style="color:#4070a0">"value"</span>, <span style="color:#4070a0">"value"</span>, <span style="color:#4070a0">"etc."</span> ] }
</code></pre></div>
<p>where both default and override attributes are optional and at least one run-list (with at least one run-list item) is specified. For example, a role named <code>webserver</code> that has a run-list that defines actions for three different roles, and for certain roles takes extra steps (such as the <code>apache2</code> role listening on ports 80 and 443):</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-javascript" data-lang="javascript">name <span style="color:#4070a0">"webserver"</span>
description <span style="color:#4070a0">"The base role for systems that serve HTTP traffic"</span>
run_list <span style="color:#4070a0">"recipe[apache2]"</span>, <span style="color:#4070a0">"recipe[apache2::mod_ssl]"</span>, <span style="color:#4070a0">"role[monitor]"</span>
env_run_lists <span style="color:#4070a0">"prod"</span> =&gt; [<span style="color:#4070a0">"recipe[apache2]"</span>], <span style="color:#4070a0">"staging"</span> =&gt; [<span style="color:#4070a0">"recipe[apache2::staging]"</span>], <span style="color:#4070a0">"_default"</span> =&gt; []
default_attributes <span style="color:#4070a0">"apache2"</span> =&gt; { <span style="color:#4070a0">"listen_ports"</span> =&gt; [ <span style="color:#4070a0">"80"</span>, <span style="color:#4070a0">"443"</span> ] }
override_attributes <span style="color:#4070a0">"apache2"</span> =&gt; { <span style="color:#4070a0">"max_children"</span> =&gt; <span style="color:#4070a0">"50"</span> }
</code></pre></div>
<h3 id="json">JSON</h3> <p>The JSON format for roles maps directly to the domain-specific Ruby format: same settings, attributes, and values, and a similar structure and organization. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-javascript" data-lang="javascript">{
  <span style="color:#4070a0">"name"</span><span style="color:#666">:</span> <span style="color:#4070a0">"webserver"</span>,
  <span style="color:#4070a0">"chef_type"</span><span style="color:#666">:</span> <span style="color:#4070a0">"role"</span>,
  <span style="color:#4070a0">"json_class"</span><span style="color:#666">:</span> <span style="color:#4070a0">"Chef::Role"</span>,
  <span style="color:#4070a0">"default_attributes"</span><span style="color:#666">:</span> {
    <span style="color:#4070a0">"apache2"</span><span style="color:#666">:</span> {
      <span style="color:#4070a0">"listen_ports"</span><span style="color:#666">:</span> [
        <span style="color:#4070a0">"80"</span>,
        <span style="color:#4070a0">"443"</span>
      ]
    }
  },
  <span style="color:#4070a0">"description"</span><span style="color:#666">:</span> <span style="color:#4070a0">"The base role for systems that serve HTTP traffic"</span>,
  <span style="color:#4070a0">"run_list"</span><span style="color:#666">:</span> [
    <span style="color:#4070a0">"recipe[apache2]"</span>,
    <span style="color:#4070a0">"recipe[apache2::mod_ssl]"</span>,
    <span style="color:#4070a0">"role[monitor]"</span>
  ],
  <span style="color:#4070a0">"env_run_lists"</span> <span style="color:#666">:</span> {
    <span style="color:#4070a0">"production"</span> <span style="color:#666">:</span> [],
    <span style="color:#4070a0">"preprod"</span> <span style="color:#666">:</span> [],
    <span style="color:#4070a0">"dev"</span><span style="color:#666">:</span> [
      <span style="color:#4070a0">"role[base]"</span>,
      <span style="color:#4070a0">"recipe[apache]"</span>,
      <span style="color:#4070a0">"recipe[apache::copy_dev_configs]"</span>,
    ],
    <span style="color:#4070a0">"test"</span><span style="color:#666">:</span> [
      <span style="color:#4070a0">"role[base]"</span>,
      <span style="color:#4070a0">"recipe[apache]"</span>
    ]
  },
  <span style="color:#4070a0">"override_attributes"</span><span style="color:#666">:</span> {
    <span style="color:#4070a0">"apache2"</span><span style="color:#666">:</span> {
      <span style="color:#4070a0">"max_children"</span><span style="color:#666">:</span> <span style="color:#4070a0">"50"</span>
    }
  }
}
</code></pre></div>
<p>The JSON format has two additional settings:</p> <table> <col style="width:40%"> <col style="width:60%"> <thead> <tr class="header"> <th>Setting</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>chef_type</code></td> <td>Always set this to <code>role</code>. Use this setting for any custom process that consumes role objects outside of Ruby.</td> </tr> <tr> <td><code>json_class</code></td> <td>Always set this to <code>Chef::Role</code>. The Chef Infra Client uses this setting to auto-inflate a role object. If objects are being rebuilt outside of Ruby, ignore it.</td> </tr> </tbody> </table> <h2 id="manage-roles">Manage Roles</h2> <p>There are several ways to manage roles:</p> <ul> <li>knife can be used to create, edit, view, list, tag, and delete roles.</li> <li>The Chef Infra Client can be used to manage role data using the command line and JSON files (that contain a hash, the elements of which are added as role attributes). In addition, the <code>run_list</code> setting allows roles and/or recipes to be added to the role.</li> <li>The open source Chef Infra Server can be used to manage role data using the command line and JSON files (that contain a hash, the elements of which are added as role attributes). In addition, the <code>run_list</code> setting allows roles and/or recipes to be added to the role.</li> <li>The Chef Infra Server API can be used to create and manage roles directly, although using knife directly is the most common way to manage roles.</li> <li>The command line can also be used with JSON files and third-party services, such as Amazon EC2, where the JSON files can contain per-instance metadata stored in a file on-disk and then read by chef-solo or Chef Infra Client as required.</li> </ul> <p>By creating and editing files using the Chef Language (Ruby) or JSON, you can dynamically generate role data. Roles created and edited using files are compatible with all versions of Chef, including chef-solo. Roles created and edited using files can be kept in version source control, which also keeps a history of what changed when. When roles are created and edited using files, they should not be managed using knife, as changes will be overwritten.</p> <p>A run-list that is associated with a role can be edited using the Chef management console add-on. The canonical source of a role’s data is stored on the Chef Infra Server, which means that keeping role data in version source control can be challenging.</p> <p>If roles are created and managed using knife and then arbitrarily updated uploaded through JSON data, that action will overwrite the previous work with knife. It is strongly recommended to keep to one process and not switch back and forth.</p> <h3 id="set-per-environment-run-lists">Set Per-environment Run-lists</h3> <p>A per-environment run-list is a run-list that is associated with a role and a specific environment. More than one environment can be specified in a role, but each specific environment may be associated with only one run-list. If a run-list is not specified, the default run-list will be used. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-javascript" data-lang="javascript">{
  <span style="color:#4070a0">"name"</span><span style="color:#666">:</span> <span style="color:#4070a0">"webserver"</span>,
  <span style="color:#4070a0">"default_attributes"</span><span style="color:#666">:</span> {
  },
  <span style="color:#4070a0">"json_class"</span><span style="color:#666">:</span> <span style="color:#4070a0">"Chef::Role"</span>,
  <span style="color:#4070a0">"env_run_lists"</span><span style="color:#666">:</span> {
    <span style="color:#4070a0">"production"</span><span style="color:#666">:</span> [],
    <span style="color:#4070a0">"preprod"</span><span style="color:#666">:</span> [],
    <span style="color:#4070a0">"test"</span><span style="color:#666">:</span> [ <span style="color:#4070a0">"role[base]"</span>, <span style="color:#4070a0">"recipe[apache]"</span>, <span style="color:#4070a0">"recipe[apache::copy_test_configs]"</span> ],
    <span style="color:#4070a0">"dev"</span><span style="color:#666">:</span> [ <span style="color:#4070a0">"role[base]"</span>, <span style="color:#4070a0">"recipe[apache]"</span>, <span style="color:#4070a0">"recipe[apache::copy_dev_configs]"</span> ]
    },
  <span style="color:#4070a0">"run_list"</span><span style="color:#666">:</span> [ <span style="color:#4070a0">"role[base]"</span>, <span style="color:#4070a0">"recipe[apache]"</span> ],
  <span style="color:#4070a0">"description"</span><span style="color:#666">:</span> <span style="color:#4070a0">"The webserver role"</span>,
  <span style="color:#4070a0">"chef_type"</span><span style="color:#666">:</span> <span style="color:#4070a0">"role"</span>,
  <span style="color:#4070a0">"override_attributes"</span><span style="color:#666">:</span> {
  }
}
</code></pre></div>
<p>where:</p> <ul> <li>
<code>webserver</code> is the name of the role</li> <li>
<code>env_run_lists</code> is a hash of per-environment run-lists for <code>production</code>, <code>preprod</code>, <code>test</code>, and <code>dev</code>
</li> <li>
<code>production</code> and <code>preprod</code> use the default run-list because they do not have a per-environment run-list</li> <li>
<code>run_list</code> defines the default run-list</li> </ul> <h3 id="delete-from-run-list">Delete from Run-list</h3> <p>When an environment is deleted, it will remain within a run-list for a role until it is removed from that run-list. If a new environment is created that has an identical name to an environment that was deleted, a run-list that contains an old environment name will use the new one.</p> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/roles/" class="_attribution-link">https://docs.chef.io/roles/</a>
  </p>
</div>
