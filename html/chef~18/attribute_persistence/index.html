<div id="col-content" data-swiftype-index="true"> <div id="attribute-persistence"><h1>Attribute Persistence</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/chef-web-docs/blob/main/content/attribute_persistence.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>All attributes except for normal attributes are reset at the beginning of a Chef Infra Client run. Attributes set via <code>chef-client -j</code> with a JSON file have normal precedence and are persisted between Chef Infra Client runs. Chef Infra Client rebuilds these attributes using automatic attributes collected by Ohai at the beginning of each Chef Infra Client run, and then uses default and override attributes that are specified in cookbooks, roles, environments, and Policyfiles. All attributes are then merged and applied to the node according to attribute precedence. The attributes that were applied to the node are saved to the Chef Infra Server as part of the node object at the conclusion of each Chef Infra Client run.</p> <h2 id="limiting-attribute-persistence">Limiting Attribute Persistence</h2> <p>Some organizations find it helpful to control attribute data stored to the Chef Infra Server in order to limit the disk and CPU resources used when processing unused attributes. For example, your organization may find the data from the Ohai <code>Package</code> plugin useful when writing cookbooks, but you don’t see the need in saving ~100k of package information for each Chef Infra Client run. By limiting the data that is saved to the Chef Infra Server, it will still be available on the node within cookbooks, but won’t be saved to the Chef Infra Server where it is available in searches.</p> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> <p>In Chef Infra Client 16.3 the node Blacklist and Whitelist features were renamed to Blocklist and Allowlist. For backwards compatibility the old configuration values will continue to work, but this document will describe the Blocklist and Allowlist names. See each section below for the appropriate legacy configuration values if you are running legacy clients in your organization.</p> <p>Legacy config mapping:</p> <ul> <li>automatic_attribute_blacklist -&gt; blocked_automatic_attributes</li> <li>default_attribute_blacklist -&gt; blocked_default_attributes</li> <li>normal_attribute_blacklist -&gt; blocked_normal_attributes</li> <li>override_attribute_blacklist -&gt; blocked_override_attributes</li> <li>automatic_attribute_whitelist -&gt; allowed_automatic_attributes</li> <li>default_attribute_whitelist -&gt; allowed_default_attributes</li> <li>normal_attribute_whitelist -&gt; allowed_normal_attributes</li> <li>override_attribute_whitelist -&gt; allowed_override_attributes</li> <li>enforce_path_sanity -&gt; enforce_default_paths</li> </ul> </div> </div> <h3 id="attribute-blocklist">Attribute Blocklist</h3> <div class="admonition-warning">
<p class="admonition-warning-title">Warning</p>
<div class="admonition-warning-text"> <p>When attribute blocklist settings are used, any attribute defined in a blocklist will not be saved to the Chef Infra Server and any attribute that is not defined in a blocklist will be saved. Each attribute type must be blocklisted independently of the other attribute types. For example, if <code>blocked_automatic_attributes</code> defines attributes that will not be saved, but <code>blocked_normal_attributes</code>, <code>blocked_default_attributes</code>, and <code>blocked_override_attributes</code> are not defined, then all normal attributes, default attributes, and override attributes will be saved, as well as the automatic attributes that were not specifically excluded through blocklisting.</p> </div>
</div> <p>Attributes that should not be saved by a node may be blocklisted in the <a href="../config_rb_client/index.html">client.rb</a> file. The blocklist is a Hash of keys that specify each attribute to be filtered out.</p> <p>Attributes are blocklisted by attribute type, with each attribute type being blocklisted independently. Each attribute type—<code>automatic</code>, <code>default</code>, <code>normal</code>, and <code>override</code>—may define blocklists by using the following settings in the client.rb file:</p> <table> <col style="width:40%"> <col style="width:60%"> <thead> <tr class="header"> <th>Setting</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>blocked_automatic_attributes</code></td> <td>A hash that blocklists <code>automatic</code> attributes, preventing blocklisted attributes from being saved. For example: <code>['network/interfaces/eth0']</code>. Default value: <code>nil</code>, all attributes are saved. If the array is empty, all attributes are saved.</td> </tr> <tr> <td><code>blocked_default_attributes</code></td> <td>A hash that blocklists <code>default</code> attributes, preventing blocklisted attributes from being saved. For example: <code>['filesystem/dev/disk0s2/size']</code>. Default value: <code>nil</code>, all attributes are saved. If the array is empty, all attributes are saved.</td> </tr> <tr> <td><code>blocked_normal_attributes</code></td> <td>A hash that blocklists <code>normal</code> attributes, preventing blocklisted attributes from being saved. For example: <code>['filesystem/dev/disk0s2/size']</code>. Default value: <code>nil</code>, all attributes are saved. If the array is empty, all attributes are saved.</td> </tr> <tr> <td><code>blocked_override_attributes</code></td> <td>A hash that blocklists <code>override</code> attributes, preventing blocklisted attributes from being saved. For example: <code>['map - autohome/size']</code>. Default value: <code>nil</code>, all attributes are saved. If the array is empty, all attributes are saved.</td> </tr> </tbody> </table> <h4 id="blocklisting-ohai-automatic-attributes">Blocklisting Ohai (automatic) Attributes</h4> <p>The recommended practice is to use <code>blocked_automatic_attributes</code> to block attributes populated by Ohai’s system information gathering. Ohai gathers a large number of attributes that can consume a signicant amount of storage space on the Chef Infra Server. Many of these attributes may be considered highly valuable, while others could be blocklisted without any impact to data available in search. Normal, default, and override attributes are typically much more important attributes used within cookbooks and are more likely to cause issues if they are blocklisted incorrectly.</p> <p>For example, automatic attribute data similar to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-javascript" data-lang="javascript">{
  <span style="color:#4070a0">"filesystem"</span> =&gt; {
    <span style="color:#4070a0">"/dev/disk0s2"</span> =&gt; {
      <span style="color:#4070a0">"size"</span> =&gt; <span style="color:#4070a0">"10mb"</span>
    },
    <span style="color:#4070a0">"map - autohome"</span> =&gt; {
      <span style="color:#4070a0">"size"</span> =&gt; <span style="color:#4070a0">"10mb"</span>
    }
  },
  <span style="color:#4070a0">"network"</span> =&gt; {
    <span style="color:#4070a0">"interfaces"</span> =&gt; {
      <span style="color:#4070a0">"eth0"</span> =&gt; {...},
      <span style="color:#4070a0">"eth1"</span> =&gt; {...},
    }
  }
}
</code></pre></div>
<p>To blocklist the <code>filesystem</code> attributes and allow the other attributes to be saved, update the client.rb file:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">blocked_automatic_attributes <span style="color:#666">[</span><span style="color:#4070a0">'filesystem'</span><span style="color:#666">]</span>
</code></pre></div>
<p>When a blocklist is defined, any attribute of that type that is not specified in that attribute blocklist <strong>will</strong> be saved. So based on the previous blocklist for automatic attributes, the <code>filesystem</code> and <code>map - autohome</code> attributes will not be saved, but the <code>network</code> attributes will.</p> <p>For attributes that contain slashes (<code>/</code>) within the attribute value, such as the <code>filesystem</code> attribute <code>'/dev/diskos2'</code>, use an array. For</p> <p>example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">blocked_automatic_attributes <span style="color:#666">[[</span><span style="color:#4070a0">'filesystem'</span>, <span style="color:#4070a0">'/dev/diskos2'</span><span style="color:#666">]]</span>
</code></pre></div>
<h3 id="attribute-allowlist">Attribute Allowlist</h3> <div class="admonition-warning">
<p class="admonition-warning-title">Warning</p>
<div class="admonition-warning-text"> <p>When attribute allowlist settings are used, only the attributes defined in a allowlist will be saved and any attribute that is not defined in a allowlist will not be saved. Each attribute type is allowlisted independently of the other attribute types. For example, if <code>automatic_attribute_allowlist</code> defines attributes to be saved, but <code>normal_attribute_allowlist</code>, <code>default_attribute_allowlist</code>, and <code>override_attribute_allowlist</code> are not defined, then all normal attributes, default attributes, and override attributes are saved, as well as the automatic attributes that were specifically included through allowlisting.</p> </div>
</div> <p>Attributes that should be saved by a node may be allowlisted in the client.rb file. The allowlist is a hash of keys that specifies each attribute to be saved.</p> <p>Attributes are allowlisted by attribute type, with each attribute type being allowlisted independently. Each attribute type—<code>automatic</code>, <code>default</code>, <code>normal</code>, and <code>override</code>—may define allowlists by using the following settings in the client.rb file:</p> <table> <col style="width:40%"> <col style="width:60%"> <thead> <tr class="header"> <th>Setting</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>allowed_automatic_attributes</code></td> <td>A hash that allowlists <code>automatic</code> attributes, preventing non-allowlisted attributes from being saved. For example: <code>['network/interfaces/eth0']</code>. Default value: <code>nil</code>, all attributes are saved. If the hash is empty, no attributes are saved.</td> </tr> <tr> <td><code>allowed_default_attributes</code></td> <td>A hash that allowlists <code>default</code> attributes, preventing non-allowlisted attributes from being saved. For example: <code>['filesystem/dev/disk0s2/size']</code>. Default value: <code>nil</code>, all attributes are saved. If the hash is empty, no attributes are saved.</td> </tr> <tr> <td><code>allowed_normal_attributes</code></td> <td>A hash that allowlists <code>normal</code> attributes, preventing non-allowlisted attributes from being saved. For example: <code>['filesystem/dev/disk0s2/size']</code>. Default value: <code>nil</code>, all attributes are saved. If the hash is empty, no attributes are saved.</td> </tr> <tr> <td><code>allowed_override_attributes</code></td> <td>A hash that allowlists <code>override</code> attributes, preventing non-allowlisted attributes from being saved. For example: <code>['map - autohome/size']</code>. Default value: <code>nil</code>, all attributes are saved. If the hash is empty, no attributes are saved.</td> </tr> </tbody> </table> <h4 id="allowlisting-ohai-automatic-attributes">Allowlisting Ohai (automatic) Attributes</h4> <p>The recommended practice is to use <code>allowed_automatic_attributes</code> to allow specific attributes populated by Ohai’s system information gathering. Ohai gathers a large number of attributes that can consume a signicant amount of storage space on the Chef Infra Server. Many of these attributes may be considered highly valuable, while others could be skipped without any impact to data available in search. Normal, default, and override attributes are typically much more important attributes used within cookbooks and are more likely to cause issues if they are ommited from an allowlist incorrectly.</p> <p>For example, automatic attribute data similar to:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-javascript" data-lang="javascript">{
  <span style="color:#4070a0">"filesystem"</span> =&gt; {
    <span style="color:#4070a0">"/dev/disk0s2"</span> =&gt; {
      <span style="color:#4070a0">"size"</span> =&gt; <span style="color:#4070a0">"10mb"</span>
    },
    <span style="color:#4070a0">"map - autohome"</span> =&gt; {
      <span style="color:#4070a0">"size"</span> =&gt; <span style="color:#4070a0">"10mb"</span>
    }
  },
  <span style="color:#4070a0">"network"</span> =&gt; {
    <span style="color:#4070a0">"interfaces"</span> =&gt; {
      <span style="color:#4070a0">"eth0"</span> =&gt; {...},
      <span style="color:#4070a0">"eth1"</span> =&gt; {...},
    }
  }
}
</code></pre></div>
<p>To allowlist the <code>network</code> attributes and prevent the other attributes from being saved, update the client.rb file:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">allowed_automatic_attributes <span style="color:#666">[</span><span style="color:#4070a0">'network/interfaces/'</span><span style="color:#666">]</span>
</code></pre></div>
<p>When a allowlist is defined, any attribute of that type that is not specified in that attribute allowlist <strong>will not</strong> be saved. So based on the previous allowlist for automatic attributes, the <code>filesystem</code> and <code>map - autohome</code> attributes will not be saved, but the <code>network</code> attributes will.</p> <p>Leave the value empty to prevent all attributes of that attribute type from being saved:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">allowed_automatic_attributes <span style="color:#666">[]</span>
</code></pre></div>
<p>For attributes that contain slashes (<code>/</code>) within the attribute value, such as the <code>filesystem</code> attribute <code>'/dev/diskos2'</code>, use an array. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">allowed_automatic_attributes <span style="color:#666">[[</span><span style="color:#4070a0">'filesystem'</span>, <span style="color:#4070a0">'/dev/diskos2'</span><span style="color:#666">]]</span>
</code></pre></div> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/attribute_persistence/" class="_attribution-link">https://docs.chef.io/attribute_persistence/</a>
  </p>
</div>
