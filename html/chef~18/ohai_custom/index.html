<div id="col-content" data-swiftype-index="true"> <div id="writing-ohai-custom-plugins"><h1>Writing Ohai Custom Plugins</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/chef-web-docs/blob/main/content/ohai_custom.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>You can write custom Ohai plugins to collect additional configuration attributes with Ohai to provide to Chef Infra Client during runs.</p> <p>Ohai plugins are written in Ruby with a plugin DSL documented below. Being written in Ruby provides access to all Ruby’s built-in functionality, as well as 3rd party gem functionality. Plugins can parse the output of any local command on the node, or they can fetch data from external APIs. Examples of plugins that users have written: - A plugin to gather node information including data center, rack, and rack position from an inventory server - A plugin to gather additional RAID array information from a controller utility - A plugin to gather hardware warranty information from a vendor API</p> <p>See <a href="../ohai/index.html">About Ohai</a> for information on Ohai configuration and usage.</p> <h2 id="install-ohai-plugins">Install Ohai Plugins</h2> <p>Install custom Ohai plugins by creating an <code>ohai</code> directory in your cookbook and saving your plugin code to this location.</p> <p>To migrate custom Ohai plugins from the deprecated ohai cookbook:</p> <ol> <li>Create an <code>ohai</code> directory in your cookbook</li> <li>Move your plugin into the <code>ohai</code> directory</li> <li>Remove the outdated custom Ohai plugin installation code from your code</li> </ol> <p>Chef Infra Client will move the file into the correct location, load it, and return the data in the next configuration run. Chef Infra Client will provide other cookbooks that depend on the custom Ohai plugin with the correct data.</p> <h2 id="syntax">Syntax</h2> <p>The syntax for an Ohai plugin is as follows:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60add5">Ohai</span><span style="color:#666">.</span>plugin(<span style="color:#517918">:Name</span>) <span style="color:#007020;font-weight:700">do</span>
  provides <span style="color:#4070a0">'attribute'</span>, <span style="color:#4070a0">'attribute/subattribute'</span>
  depends <span style="color:#4070a0">'attribute'</span>, <span style="color:#4070a0">'attribute'</span>

  <span style="color:#007020;font-weight:700">def</span> <span style="color:#06287e">shared_method</span>
    <span style="color:#60a0b0;font-style:italic"># some Ruby code that defines the shared method</span>
    attribute my_data
  <span style="color:#007020;font-weight:700">end</span>

  collect_data(<span style="color:#517918">:default</span>) <span style="color:#007020;font-weight:700">do</span>
    <span style="color:#60a0b0;font-style:italic"># some Ruby code</span>
    attribute my_data
  <span style="color:#007020;font-weight:700">end</span>

  collect_data(<span style="color:#517918">:platform</span><span style="color:#666">...</span>) <span style="color:#007020;font-weight:700">do</span>
    <span style="color:#60a0b0;font-style:italic"># some Ruby code that defines platform-specific requirements</span>
    attribute my_data
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>where</p> <ul> <li>Required. <code>(:Name)</code> is used to identify the plugin; when two plugins have the same <code>(:Name)</code>, those plugins are joined together and run as if they were a single plugin. This value must be a valid Ruby class name, starting with a capital letter and containing only alphanumeric characters</li> <li>Required. <code>provides</code> is a comma-separated list of one (or more) attributes that are defined by this plugin. This attribute will become an automatic attribute (<code>node['attribute']</code>) after it is collected by Ohai at the start of a Chef Infra Client run. An attribute can also be defined using an <code>attribute/subattribute</code> pattern</li> <li>
<code>depends</code> is a comma-separated list of one (or more) attributes that are collected by another plugin; as long as the value is collected by another Ohai plugin, it can be used by any plugin</li> <li>
<code>shared_method</code> defines code that can be shared among one (or more) <code>collect_data</code> blocks; for example, instead of defining a mash for each <code>collect_data</code> block, the code can be defined as a shared method, and then called from any <code>collect_data</code> block</li> <li>
<code>collect_data</code> is a block of Ruby code that is called by Ohai when it runs; one (or more) <code>collect_data</code> blocks can be defined in a plugin, but only a single <code>collect_data</code> block is ever run.</li> <li>
<code>collect_data(:default)</code> is the code block that runs when a node’s platform is not defined by a platform-specific <code>collect_data</code> block</li> <li>
<code>collect_data(:platform)</code> is a platform-specific code block that is run when a match exists between the node’s platform and this <code>collect_data</code> block; only one <code>collect_data</code> block may exist for each platform; possible values: <code>:aix</code>, <code>:darwin</code>, <code>:freebsd</code>, <code>:linux</code>, <code>:openbsd</code>, <code>:netbsd</code>, <code>:solaris2</code>, <code>:windows</code>, or any other value from <code>RbConfig::CONFIG['host_os']</code>
</li> <li>
<code>my_data</code> is string (<code>a string value</code>) or an empty mash (<code>{ :setting_a =&gt; 'value_a', :setting_b =&gt; 'value_b' }</code>). This is used to define the data that should be collected by the plugin</li> </ul> <p>For example, the following plugin looks up data on virtual machines hosted in Amazon EC2, Google Compute Engine, Rackspace, Eucalyptus, Linode, OpenStack, and Microsoft Azure:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60add5">Ohai</span><span style="color:#666">.</span>plugin(<span style="color:#517918">:Cloud</span>) <span style="color:#007020;font-weight:700">do</span>
  provides <span style="color:#4070a0">'cloud'</span>

  depends <span style="color:#4070a0">'ec2'</span>
  depends <span style="color:#4070a0">'gce'</span>
  depends <span style="color:#4070a0">'rackspace'</span>
  depends <span style="color:#4070a0">'eucalyptus'</span>
  depends <span style="color:#4070a0">'linode'</span>
  depends <span style="color:#4070a0">'openstack'</span>
  depends <span style="color:#4070a0">'azure'</span>

  <span style="color:#007020;font-weight:700">def</span> <span style="color:#06287e">create_objects</span>
    cloud <span style="color:#60add5">Mash</span><span style="color:#666">.</span>new
    cloud<span style="color:#666">[</span><span style="color:#517918">:public_ips</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#666">[]</span>
    cloud<span style="color:#666">[</span><span style="color:#517918">:private_ips</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#666">[]</span>
  <span style="color:#007020;font-weight:700">end</span>

  <span style="color:#666">...</span>

  <span style="color:#007020;font-weight:700">def</span> <span style="color:#06287e">on_gce?</span>
    gce <span style="color:#666">!=</span> <span style="color:#007020">nil</span>
  <span style="color:#007020;font-weight:700">end</span>

  <span style="color:#007020;font-weight:700">def</span> <span style="color:#06287e">get_gce_values</span>
    cloud<span style="color:#666">[</span><span style="color:#517918">:public_ipv4</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#666">[]</span>
    cloud<span style="color:#666">[</span><span style="color:#517918">:local_ipv4</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#666">[]</span>

    public_ips <span style="color:#666">=</span> gce<span style="color:#666">[</span><span style="color:#4070a0">'instance'</span><span style="color:#666">][</span><span style="color:#4070a0">'networkInterfaces'</span><span style="color:#666">].</span>collect <span style="color:#007020;font-weight:700">do</span> <span style="color:#666">|</span>interface<span style="color:#666">|</span>
      <span style="color:#007020;font-weight:700">if</span> interface<span style="color:#666">.</span>has_key?(<span style="color:#4070a0">'accessConfigs'</span>)
        interface<span style="color:#666">[</span><span style="color:#4070a0">'accessConfigs'</span><span style="color:#666">].</span>collect{<span style="color:#666">|</span>ac<span style="color:#666">|</span> ac<span style="color:#666">[</span><span style="color:#4070a0">'externalIp'</span><span style="color:#666">]</span>}
      <span style="color:#007020;font-weight:700">end</span>
    <span style="color:#007020;font-weight:700">end</span><span style="color:#666">.</span>flatten<span style="color:#666">.</span>compact

    private_ips <span style="color:#666">=</span> gce<span style="color:#666">[</span><span style="color:#4070a0">'instance'</span><span style="color:#666">][</span><span style="color:#4070a0">'networkInterfaces'</span><span style="color:#666">].</span>collect <span style="color:#007020;font-weight:700">do</span> <span style="color:#666">|</span>interface<span style="color:#666">|</span>
      interface<span style="color:#666">[</span><span style="color:#4070a0">'ip'</span><span style="color:#666">]</span>
    <span style="color:#007020;font-weight:700">end</span><span style="color:#666">.</span>compact

    cloud<span style="color:#666">[</span><span style="color:#517918">:public_ips</span><span style="color:#666">]</span> <span style="color:#666">+=</span> public_ips
    cloud<span style="color:#666">[</span><span style="color:#517918">:private_ips</span><span style="color:#666">]</span> <span style="color:#666">+=</span> private_ips
    cloud<span style="color:#666">[</span><span style="color:#517918">:public_ipv4</span><span style="color:#666">]</span> <span style="color:#666">+=</span>  public_ips
    cloud<span style="color:#666">[</span><span style="color:#517918">:public_hostname</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">nil</span>
    cloud<span style="color:#666">[</span><span style="color:#517918">:local_ipv4</span><span style="color:#666">]</span> <span style="color:#666">+=</span> private_ips
    cloud<span style="color:#666">[</span><span style="color:#517918">:local_hostname</span><span style="color:#666">]</span> <span style="color:#666">=</span> gce<span style="color:#666">[</span><span style="color:#4070a0">'instance'</span><span style="color:#666">][</span><span style="color:#4070a0">'hostname'</span><span style="color:#666">]</span>
    cloud<span style="color:#666">[</span><span style="color:#517918">:provider</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'gce'</span>
  <span style="color:#007020;font-weight:700">end</span>

  <span style="color:#666">...</span>

  <span style="color:#60a0b0;font-style:italic"># with following similar code blocks for each cloud provider</span>
</code></pre></div>
<p>where</p> <ul> <li>
<code>provides</code> defines the <code>cloud</code> attribute, which is then turned into an object using the <code>create_objects</code> shared method, which then generates a hash based on public or private IP addresses</li> <li>For Google Compute Engine the <code>cloud</code> attribute data is populated into a hash based on the IP address for the node</li> </ul> <p>To see the rest of the code in this plugin, go to: <a href="https://github.com/chef/ohai/blob/main/lib/ohai/plugins/cloud.rb">https://github.com/chef/ohai/blob/main/lib/ohai/plugins/cloud.rb</a>.</p> <h2 id="ohai-methods">Ohai Methods</h2> <p>The Ohai DSL is a Ruby DSL that is used to define an Ohai plugin and to ensure that Ohai collects the right data at the start of every Chef Infra Client run. The Ohai DSL is a small DSL with a single method that is specific to Ohai plugins. Because the Ohai DSL is a Ruby DSL, anything that can be done using Ruby can also be done when defining an Ohai plugin.</p> <h3 id="collect_data">collect_data</h3> <p>The <code>collect_data</code> method is a block of Ruby code that is called by Ohai when it runs. One (or more) <code>collect_data</code> blocks can be defined in a plugin, but only a single <code>collect_data</code> block is ever run. The <code>collect_data</code> block that is run is determined by the platform on which the node is running, which is then matched up against the available <code>collect_data</code> blocks in the plugin.</p> <ul> <li>A <code>collect_data(:default)</code> block is used when Ohai is not able to match the platform of the node with a <code>collect_data(:platform)</code> block in the plugin</li> <li>A <code>collect_data(:platform)</code> block is required for each platform that requires non-default behavior</li> </ul> <p>When Ohai runs, if there isn’t a matching <code>collect_data</code> block for a platform, the <code>collect_data(:default)</code> block is used. The syntax for the <code>collect_data</code> method is:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">collect_data(<span style="color:#517918">:default</span>) <span style="color:#007020;font-weight:700">do</span>
  <span style="color:#60a0b0;font-style:italic"># some Ruby code</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>or:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">collect_data(<span style="color:#517918">:platform</span>) <span style="color:#007020;font-weight:700">do</span>
  <span style="color:#60a0b0;font-style:italic"># some Ruby code</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>where:</p> <ul> <li>
<code>:default</code> is the name of the default <code>collect_data</code> block</li> <li>
<code>:platform</code> is the name of a platform, such as <code>:aix</code> for AIX or <code>:windows</code> for Microsoft Windows</li> </ul> <h4 id="use-a-mash">Use a Mash</h4> <p>Use a mash to store data. This is done by creating a new mash, and then setting an attribute to it. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">provides <span style="color:#4070a0">'name_of_mash'</span>
name_of_mash <span style="color:#60add5">Mash</span><span style="color:#666">.</span>new
name_of_mash<span style="color:#666">[</span><span style="color:#517918">:attribute</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'value'</span>
</code></pre></div>
<h4 id="examples">Examples</h4> <p>The following examples show how to use the <code>collect_data</code> block:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60add5">Ohai</span><span style="color:#666">.</span>plugin(<span style="color:#517918">:Azure</span>) <span style="color:#007020;font-weight:700">do</span>
  provides <span style="color:#4070a0">'azure'</span>

  collect_data <span style="color:#007020;font-weight:700">do</span>
    azure_metadata_from_hints <span style="color:#666">=</span> hint?(<span style="color:#4070a0">'azure'</span>)
    <span style="color:#007020;font-weight:700">if</span> azure_metadata_from_hints
      <span style="color:#60add5">Ohai</span><span style="color:#666">::</span><span style="color:#60add5">Log</span><span style="color:#666">.</span>debug(<span style="color:#4070a0">'azure_metadata_from_hints is present.'</span>)
      azure <span style="color:#60add5">Mash</span><span style="color:#666">.</span>new
      azure_metadata_from_hints<span style="color:#666">.</span>each {<span style="color:#666">|</span>k, v<span style="color:#666">|</span> azure<span style="color:#666">[</span>k<span style="color:#666">]</span> <span style="color:#666">=</span> v }
    <span style="color:#007020;font-weight:700">else</span>
      <span style="color:#60add5">Ohai</span><span style="color:#666">::</span><span style="color:#60add5">Log</span><span style="color:#666">.</span>debug(<span style="color:#4070a0">'No hints present for azure.'</span>)
      <span style="color:#007020">false</span>
    <span style="color:#007020;font-weight:700">end</span>
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>or:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#007020">require</span> <span style="color:#4070a0">'ohai/mixin/ec2_metadata'</span>
<span style="color:#007020">extend</span> <span style="color:#60add5">Ohai</span><span style="color:#666">::</span><span style="color:#60add5">Mixin</span><span style="color:#666">::</span><span style="color:#60add5">Ec2Metadata</span>

<span style="color:#60add5">Ohai</span><span style="color:#666">.</span>plugin <span style="color:#007020;font-weight:700">do</span>
  provides <span style="color:#4070a0">'openstack'</span>

  collect_data <span style="color:#007020;font-weight:700">do</span>
    <span style="color:#007020;font-weight:700">if</span> hint?(<span style="color:#4070a0">'openstack'</span>) <span style="color:#666">||</span> hint?(<span style="color:#4070a0">'hp'</span>)
      <span style="color:#60add5">Ohai</span><span style="color:#666">::</span><span style="color:#60add5">Log</span><span style="color:#666">.</span>debug(<span style="color:#4070a0">'ohai openstack'</span>)
      openstack <span style="color:#60add5">Mash</span><span style="color:#666">.</span>new
      <span style="color:#007020;font-weight:700">if</span> can_metadata_connect?(<span style="color:#60add5">EC2_METADATA_ADDR</span>,<span style="color:#40a070">80</span>)
        <span style="color:#60add5">Ohai</span><span style="color:#666">::</span><span style="color:#60add5">Log</span><span style="color:#666">.</span>debug(<span style="color:#4070a0">'connecting to the OpenStack metadata service'</span>)
        <span style="color:#007020">self</span><span style="color:#666">.</span>fetch_metadata<span style="color:#666">.</span>each {<span style="color:#666">|</span>k, v<span style="color:#666">|</span> openstack<span style="color:#666">[</span>k<span style="color:#666">]</span> <span style="color:#666">=</span> v }
        <span style="color:#007020;font-weight:700">case</span>
        <span style="color:#007020;font-weight:700">when</span> hint?(<span style="color:#4070a0">'hp'</span>)
          openstack<span style="color:#666">[</span><span style="color:#4070a0">'provider'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'hp'</span>
        <span style="color:#007020;font-weight:700">else</span>
          openstack<span style="color:#666">[</span><span style="color:#4070a0">'provider'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'openstack'</span>
        <span style="color:#007020;font-weight:700">end</span>
      <span style="color:#007020;font-weight:700">else</span>
        <span style="color:#60add5">Ohai</span><span style="color:#666">::</span><span style="color:#60add5">Log</span><span style="color:#666">.</span>debug(<span style="color:#4070a0">'unable to connect to the OpenStack metadata service'</span>)
      <span style="color:#007020;font-weight:700">end</span>
    <span style="color:#007020;font-weight:700">else</span>
      <span style="color:#60add5">Ohai</span><span style="color:#666">::</span><span style="color:#60add5">Log</span><span style="color:#666">.</span>debug(<span style="color:#4070a0">'NOT ohai openstack'</span>)
    <span style="color:#007020;font-weight:700">end</span>
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h3 id="require">require</h3> <p>The <code>require</code> method is a standard Ruby method that can be used to list files that may be required by a platform, such as an external class library. As a best practice, even though the <code>require</code> method is often used at the top of a Ruby file, it is recommended that the use of the <code>require</code> method be used as part of the platform-specific <code>collect_data</code> block. For example, the Ruby WMI is required with Microsoft Windows:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">collect_data(<span style="color:#517918">:windows</span>) <span style="color:#007020;font-weight:700">do</span>
  <span style="color:#007020">require</span> <span style="color:#4070a0">'ruby-wmi'</span>
  <span style="color:#60add5">WIN32OLE</span><span style="color:#666">.</span>codepage <span style="color:#666">=</span> <span style="color:#60add5">WIN32OLE</span><span style="color:#666">::</span><span style="color:#60add5">CP_UTF8</span>

  kernel <span style="color:#60add5">Mash</span><span style="color:#666">.</span>new

  host <span style="color:#666">=</span> <span style="color:#60add5">WMI</span><span style="color:#666">::</span><span style="color:#60add5">Win32_OperatingSystem</span><span style="color:#666">.</span>find(<span style="color:#517918">:first</span>)
  kernel<span style="color:#666">[</span><span style="color:#517918">:os_info</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#60add5">Mash</span><span style="color:#666">.</span>new
  host<span style="color:#666">.</span>properties_<span style="color:#666">.</span>each <span style="color:#007020;font-weight:700">do</span> <span style="color:#666">|</span><span style="color:#007020">p</span><span style="color:#666">|</span>
    kernel<span style="color:#666">[</span><span style="color:#517918">:os_info</span><span style="color:#666">][</span><span style="color:#007020">p</span><span style="color:#666">.</span>name<span style="color:#666">.</span>wmi_underscore<span style="color:#666">.</span>to_sym<span style="color:#666">]</span> <span style="color:#666">=</span> host<span style="color:#666">.</span>send(<span style="color:#007020">p</span><span style="color:#666">.</span>name)
  <span style="color:#007020;font-weight:700">end</span>

  <span style="color:#666">...</span>

<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>Ohai will attempt to fully qualify the name of any class by prepending <code>Ohai::</code> to the loaded class. For example both:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#007020">require</span> <span style="color:#60add5">Ohai</span><span style="color:#666">::</span><span style="color:#60add5">Mixin</span><span style="color:#666">::</span><span style="color:#60add5">ShellOut</span>
</code></pre></div>
<p>and:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#007020">require</span> <span style="color:#60add5">Mixin</span><span style="color:#666">::</span><span style="color:#60add5">ShellOut</span>
</code></pre></div>
<p>are both understood by the Ohai in the same way: <code>Ohai::Mixin::ShellOut</code>.</p> <p>When a class is an external class (and therefore should not have <code>Ohai::</code> prepended), use <code>::</code> to let the Ohai know. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#666">::</span><span style="color:#60add5">External</span><span style="color:#666">::</span><span style="color:#60add5">Class</span><span style="color:#666">::</span><span style="color:#60add5">Library</span>
</code></pre></div>
<h4 id="common-directory">/common Directory</h4> <p>The <code>/common</code> directory stores code that is used across all Ohai plugins. For example, a file in the <code>/common</code> directory named <code>virtualization.rb</code> that includes code like the following:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#007020;font-weight:700">module</span> <span style="color:#0e84b5;font-weight:700">Ohai</span>
  <span style="color:#007020;font-weight:700">module</span> <span style="color:#0e84b5;font-weight:700">Common</span>
    <span style="color:#007020;font-weight:700">module</span> <span style="color:#0e84b5;font-weight:700">Virtualization</span>

      <span style="color:#007020;font-weight:700">def</span> <span style="color:#06287e">host?</span>(virtualization)
        <span style="color:#666">!</span>virtualization<span style="color:#666">.</span>nil? <span style="color:#666">&amp;&amp;</span> virtualization<span style="color:#666">[</span><span style="color:#517918">:role</span><span style="color:#666">].</span>eql?(<span style="color:#4070a0">'host'</span>)
      <span style="color:#007020;font-weight:700">end</span>

      <span style="color:#007020;font-weight:700">def</span> <span style="color:#06287e">open_virtconn</span>(<span style="color:#007020">system</span>)
        <span style="color:#007020;font-weight:700">begin</span>
          <span style="color:#007020">require</span> <span style="color:#4070a0">'libvirt'</span>
          <span style="color:#007020">require</span> <span style="color:#4070a0">'hpricot'</span>
        <span style="color:#007020;font-weight:700">rescue</span> <span style="color:#60add5">LoadError</span> <span style="color:#666">=&gt;</span> e
          <span style="color:#60add5">Ohai</span><span style="color:#666">::</span><span style="color:#60add5">Log</span><span style="color:#666">.</span>debug(<span style="color:#4070a0">'Cannot load gem: #{e}.'</span>)
        <span style="color:#007020;font-weight:700">end</span>

        emu <span style="color:#666">=</span> (<span style="color:#007020">system</span><span style="color:#666">.</span>eql?(<span style="color:#4070a0">'kvm'</span>) ? <span style="color:#4070a0">'qemu'</span> : <span style="color:#007020">system</span>)
        virtconn <span style="color:#666">=</span> <span style="color:#60add5">Libvirt</span><span style="color:#666">::</span>open_read_only(<span style="color:#4070a0">'#{emu}:///system'</span>)
      <span style="color:#007020;font-weight:700">end</span>

      <span style="color:#666">...</span>

      <span style="color:#007020;font-weight:700">def</span> <span style="color:#06287e">networks</span>(virtconn)
        networks <span style="color:#666">=</span> <span style="color:#60add5">Mash</span><span style="color:#666">.</span>new
        virtconn<span style="color:#666">.</span>list_networks<span style="color:#666">.</span>each <span style="color:#007020;font-weight:700">do</span> <span style="color:#666">|</span>n<span style="color:#666">|</span>
          nv <span style="color:#666">=</span> virtconn<span style="color:#666">.</span>lookup_network_by_name n
          networks<span style="color:#666">[</span>n<span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#60add5">Mash</span><span style="color:#666">.</span>new
          networks<span style="color:#666">[</span>n<span style="color:#666">][</span><span style="color:#517918">:xml_desc</span><span style="color:#666">]</span> <span style="color:#666">=</span> (nv<span style="color:#666">.</span>xml_desc<span style="color:#666">.</span>split(<span style="color:#4070a0">'\n'</span>)<span style="color:#666">.</span>collect {<span style="color:#666">|</span>line<span style="color:#666">|</span> line<span style="color:#666">.</span>strip})<span style="color:#666">.</span>join
          <span style="color:#666">[</span><span style="color:#4070a0">'bridge_name'</span>,<span style="color:#4070a0">'uuid'</span><span style="color:#666">].</span>each {<span style="color:#666">|</span>a<span style="color:#666">|</span> networks<span style="color:#666">[</span>n<span style="color:#666">][</span>a<span style="color:#666">]</span> <span style="color:#666">=</span> nv<span style="color:#666">.</span>send(a)}
          <span style="color:#60a0b0;font-style:italic">#xdoc = Hpricot networks[n][:xml_desc]</span>
        <span style="color:#007020;font-weight:700">end</span>
        networks
      <span style="color:#007020;font-weight:700">end</span>

      <span style="color:#666">...</span>

    <span style="color:#007020;font-weight:700">end</span>
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>can then be leveraged in a plugin by using the <code>require</code> method to require the <code>virtualization.rb</code> file and then later calling each of the methods in the required module:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#007020">require</span> <span style="color:#4070a0">'ohai/common/virtualization'</span>

<span style="color:#60add5">Ohai</span><span style="color:#666">.</span>plugin(<span style="color:#517918">:Virtualization</span>) <span style="color:#007020;font-weight:700">do</span>
  <span style="color:#007020">include</span> <span style="color:#60add5">Ohai</span><span style="color:#666">::</span><span style="color:#60add5">Common</span><span style="color:#666">::</span><span style="color:#60add5">Virtualization</span>

  provides <span style="color:#4070a0">'virtualization'</span>
  <span style="color:#c65d09">%w{ capabilities domains networks storage }</span><span style="color:#666">.</span>each <span style="color:#007020;font-weight:700">do</span> <span style="color:#666">|</span>subattr<span style="color:#666">|</span>
    provides <span style="color:#4070a0">'virtualization/#{subattr}'</span>
  <span style="color:#007020;font-weight:700">end</span>

  collect_data(<span style="color:#517918">:linux</span>) <span style="color:#007020;font-weight:700">do</span>
    virtualization <span style="color:#60add5">Mash</span><span style="color:#666">.</span>new

    <span style="color:#666">...</span>

    <span style="color:#007020;font-weight:700">if</span> host?(virtualization)
      v <span style="color:#666">=</span> open_virtconn(virtualization<span style="color:#666">[</span><span style="color:#517918">:system</span><span style="color:#666">]</span>)

      virtualization<span style="color:#666">[</span><span style="color:#517918">:libvirt_version</span><span style="color:#666">]</span> <span style="color:#666">=</span> libvirt_version(v)
      virtualization<span style="color:#666">[</span><span style="color:#517918">:nodeinfo</span><span style="color:#666">]</span> <span style="color:#666">=</span> nodeinfo(v)
      virtualization<span style="color:#666">[</span><span style="color:#517918">:uri</span><span style="color:#666">]</span> <span style="color:#666">=</span> uri(v)
      virtualization<span style="color:#666">[</span><span style="color:#517918">:capabilities</span><span style="color:#666">]</span> <span style="color:#666">=</span> capabilities(v)
      virtualization<span style="color:#666">[</span><span style="color:#517918">:domains</span><span style="color:#666">]</span> <span style="color:#666">=</span> domains(v)
      virtualization<span style="color:#666">[</span><span style="color:#517918">:networks</span><span style="color:#666">]</span> <span style="color:#666">=</span> networks(v)
      virtualization<span style="color:#666">[</span><span style="color:#517918">:storage</span><span style="color:#666">]</span> <span style="color:#666">=</span> storage(v)

      close_virtconn(v)
    <span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h3 id="shared-methods">Shared Methods</h3> <p>Use shared methods to define objects for use in <code>collect_data</code> blocks, such as a data structure, a hash, or a mash. The syntax for a shared method is:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#007020;font-weight:700">def</span> <span style="color:#06287e">a_shared_method</span>
  <span style="color:#60a0b0;font-style:italic"># some Ruby code that defines the shared method</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>The following example declares a shared <code>cloud</code> method to collect data about cloud providers based on the type of IP address and then uses the <code>cloud</code> object to collect data from different cloud providers.</p> <p>Create <code>cloud</code> objects based on the type of IP address:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#007020;font-weight:700">def</span> <span style="color:#06287e">create_objects</span>
  cloud <span style="color:#60add5">Mash</span><span style="color:#666">.</span>new
  cloud<span style="color:#666">[</span><span style="color:#517918">:public_ips</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">Array</span><span style="color:#666">.</span>new
  cloud<span style="color:#666">[</span><span style="color:#517918">:private_ips</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">Array</span><span style="color:#666">.</span>new
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>Use <code>cloud</code> object to collect Linode data:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#007020;font-weight:700">def</span> <span style="color:#06287e">get_linode_values</span>
  cloud<span style="color:#666">[</span><span style="color:#517918">:public_ips</span><span style="color:#666">]</span> <span style="color:#666">&lt;&lt;</span> linode<span style="color:#666">[</span><span style="color:#4070a0">'public_ip'</span><span style="color:#666">]</span>
  cloud<span style="color:#666">[</span><span style="color:#517918">:private_ips</span><span style="color:#666">]</span> <span style="color:#666">&lt;&lt;</span> linode<span style="color:#666">[</span><span style="color:#4070a0">'private_ip'</span><span style="color:#666">]</span>
  cloud<span style="color:#666">[</span><span style="color:#517918">:public_ipv4</span><span style="color:#666">]</span> <span style="color:#666">=</span> linode<span style="color:#666">[</span><span style="color:#4070a0">'public_ipv4'</span><span style="color:#666">]</span>
  cloud<span style="color:#666">[</span><span style="color:#517918">:public_hostname</span><span style="color:#666">]</span> <span style="color:#666">=</span> linode<span style="color:#666">[</span><span style="color:#4070a0">'public_hostname'</span><span style="color:#666">]</span>
  cloud<span style="color:#666">[</span><span style="color:#517918">:local_ipv4</span><span style="color:#666">]</span> <span style="color:#666">=</span> linode<span style="color:#666">[</span><span style="color:#4070a0">'local_ipv4'</span><span style="color:#666">]</span>
  cloud<span style="color:#666">[</span><span style="color:#517918">:local_hostname</span><span style="color:#666">]</span> <span style="color:#666">=</span> linode<span style="color:#666">[</span><span style="color:#4070a0">'local_hostname'</span><span style="color:#666">]</span>
  cloud<span style="color:#666">[</span><span style="color:#517918">:provider</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'linode'</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<p>Use the <code>cloud</code> object to collect Azure data:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#007020;font-weight:700">def</span> <span style="color:#06287e">get_azure_values</span>
  cloud<span style="color:#666">[</span><span style="color:#517918">:vm_name</span><span style="color:#666">]</span> <span style="color:#666">=</span> azure<span style="color:#666">[</span><span style="color:#4070a0">'vm_name'</span><span style="color:#666">]</span>
  cloud<span style="color:#666">[</span><span style="color:#517918">:public_ips</span><span style="color:#666">]</span> <span style="color:#666">&lt;&lt;</span> azure<span style="color:#666">[</span><span style="color:#4070a0">'public_ip'</span><span style="color:#666">]</span>
  cloud<span style="color:#666">[</span><span style="color:#517918">:public_fqdn</span><span style="color:#666">]</span> <span style="color:#666">=</span> azure<span style="color:#666">[</span><span style="color:#4070a0">'public_fqdn'</span><span style="color:#666">]</span>
  cloud<span style="color:#666">[</span><span style="color:#517918">:public_ssh_port</span><span style="color:#666">]</span> <span style="color:#666">=</span> azure<span style="color:#666">[</span><span style="color:#4070a0">'public_ssh_port'</span><span style="color:#666">]</span> <span style="color:#007020;font-weight:700">if</span> azure<span style="color:#666">[</span><span style="color:#4070a0">'public_ssh_port'</span><span style="color:#666">]</span>
  cloud<span style="color:#666">[</span><span style="color:#517918">:public_winrm_port</span><span style="color:#666">]</span> <span style="color:#666">=</span> azure<span style="color:#666">[</span><span style="color:#4070a0">'public_winrm_port'</span><span style="color:#666">]</span> <span style="color:#007020;font-weight:700">if</span> azure<span style="color:#666">[</span><span style="color:#4070a0">'public_winrm_port'</span><span style="color:#666">]</span>
  cloud<span style="color:#666">[</span><span style="color:#517918">:provider</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'azure'</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h2 id="logging">Logging</h2> <p>Use the <code>Ohai::Log</code> class in an Ohai plugin to define log entries that are created by Ohai. The syntax for a log message is as follows:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60add5">Ohai</span><span style="color:#666">::</span><span style="color:#60add5">Log</span><span style="color:#666">.</span>log_type(<span style="color:#4070a0">'message'</span>)
</code></pre></div>
<p>where</p> <ul> <li>
<code>log_type</code> can be <code>.debug</code>, <code>.info</code>, <code>.warn</code>, <code>.error</code>, or <code>.fatal</code>
</li> <li>
<code>'message'</code> is the message that is logged.</li> </ul> <p>For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60add5">Ohai</span><span style="color:#666">.</span>plugin <span style="color:#007020;font-weight:700">do</span>
  provides <span style="color:#4070a0">'openstack'</span>

  collect_data <span style="color:#007020;font-weight:700">do</span>
    <span style="color:#007020;font-weight:700">if</span> hint?(<span style="color:#4070a0">'openstack'</span>) <span style="color:#666">||</span> hint?(<span style="color:#4070a0">'hp'</span>)
      <span style="color:#60add5">Ohai</span><span style="color:#666">::</span><span style="color:#60add5">Log</span><span style="color:#666">.</span>debug(<span style="color:#4070a0">'ohai openstack'</span>)
      openstack <span style="color:#60add5">Mash</span><span style="color:#666">.</span>new
      <span style="color:#007020;font-weight:700">if</span> can_metadata_connect?(<span style="color:#60add5">EC2_METADATA_ADDR</span>,<span style="color:#40a070">80</span>)
        <span style="color:#60add5">Ohai</span><span style="color:#666">::</span><span style="color:#60add5">Log</span><span style="color:#666">.</span>debug(<span style="color:#4070a0">'connecting to the OpenStack metadata service'</span>)
        <span style="color:#007020">self</span><span style="color:#666">.</span>fetch_metadata<span style="color:#666">.</span>each {<span style="color:#666">|</span>k, v<span style="color:#666">|</span> openstack<span style="color:#666">[</span>k<span style="color:#666">]</span> <span style="color:#666">=</span> v }
        <span style="color:#007020;font-weight:700">case</span>
        <span style="color:#007020;font-weight:700">when</span> hint?(<span style="color:#4070a0">'hp'</span>)
          openstack<span style="color:#666">[</span><span style="color:#4070a0">'provider'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'hp'</span>
        <span style="color:#007020;font-weight:700">else</span>
          openstack<span style="color:#666">[</span><span style="color:#4070a0">'provider'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'openstack'</span>
        <span style="color:#007020;font-weight:700">end</span>
      <span style="color:#007020;font-weight:700">else</span>
        <span style="color:#60add5">Ohai</span><span style="color:#666">::</span><span style="color:#60add5">Log</span><span style="color:#666">.</span>debug(<span style="color:#4070a0">'unable to connect to the OpenStack metadata service'</span>)
      <span style="color:#007020;font-weight:700">end</span>
    <span style="color:#007020;font-weight:700">else</span>
      <span style="color:#60add5">Ohai</span><span style="color:#666">::</span><span style="color:#60add5">Log</span><span style="color:#666">.</span>debug(<span style="color:#4070a0">'NOT ohai openstack'</span>)
    <span style="color:#007020;font-weight:700">end</span>
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h3 id="rescue">rescue</h3> <p>Use the <code>rescue</code> clause to make sure that a log message is always provided. For example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#007020;font-weight:700">rescue</span> <span style="color:#60add5">LoadError</span> <span style="color:#666">=&gt;</span> e
  <span style="color:#60add5">Ohai</span><span style="color:#666">::</span><span style="color:#60add5">Log</span><span style="color:#666">.</span>debug(<span style="color:#4070a0">'ip_scopes: cannot load gem, plugin disabled: #{e}'</span>)
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h2 id="examples-1">Examples</h2> <p>The following examples show different ways of building Ohai plugins.</p> <h3 id="collect_data-blocks">collect_data Blocks</h3> <p>The following Ohai plugin uses multiple <code>collect_data</code> blocks and shared methods to define platforms:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60add5">Ohai</span><span style="color:#666">.</span>plugin(<span style="color:#517918">:Hostname</span>) <span style="color:#007020;font-weight:700">do</span>
  provides <span style="color:#4070a0">'domain'</span>, <span style="color:#4070a0">'fqdn'</span>, <span style="color:#4070a0">'hostname'</span>

  <span style="color:#007020;font-weight:700">def</span> <span style="color:#06287e">from_cmd</span>(cmd)
    so <span style="color:#666">=</span> shell_out(cmd)
    so<span style="color:#666">.</span>stdout<span style="color:#666">.</span>split($/)<span style="color:#666">[</span><span style="color:#40a070">0</span><span style="color:#666">]</span>
  <span style="color:#007020;font-weight:700">end</span>

  <span style="color:#007020;font-weight:700">def</span> <span style="color:#06287e">collect_domain</span>
    <span style="color:#007020;font-weight:700">if</span> fqdn
      fqdn <span style="color:#666">=~</span> <span style="color:#235388">/.+?\.(.*)/</span>
      domain $1
    <span style="color:#007020;font-weight:700">end</span>
  <span style="color:#007020;font-weight:700">end</span>

  collect_data(<span style="color:#517918">:aix</span>, <span style="color:#517918">:hpux</span>) <span style="color:#007020;font-weight:700">do</span>
    hostname from_cmd(<span style="color:#4070a0">'hostname -s'</span>)
    fqdn from_cmd(<span style="color:#4070a0">'hostname'</span>)
    domain collect_domain
  <span style="color:#007020;font-weight:700">end</span>

  collect_data(<span style="color:#517918">:darwin</span>, <span style="color:#517918">:netbsd</span>, <span style="color:#517918">:openbsd</span>) <span style="color:#007020;font-weight:700">do</span>
    hostname from_cmd(<span style="color:#4070a0">'hostname -s'</span>)
    fqdn from_cmd(<span style="color:#4070a0">'hostname'</span>)
    domain collect_domain
  <span style="color:#007020;font-weight:700">end</span>

  collect_data(<span style="color:#517918">:freebsd</span>) <span style="color:#007020;font-weight:700">do</span>
    hostname from_cmd(<span style="color:#4070a0">'hostname -s'</span>)
    fqdn from_cmd(<span style="color:#4070a0">'hostname -f'</span>)
    domain collect_domain
  <span style="color:#007020;font-weight:700">end</span>

  collect_data(<span style="color:#517918">:linux</span>) <span style="color:#007020;font-weight:700">do</span>
    hostname from_cmd(<span style="color:#4070a0">'hostname -s'</span>)
    <span style="color:#007020;font-weight:700">begin</span>
      fqdn from_cmd(<span style="color:#4070a0">'hostname --fqdn'</span>)
    <span style="color:#007020;font-weight:700">rescue</span>
      <span style="color:#60add5">Ohai</span><span style="color:#666">::</span><span style="color:#60add5">Log</span><span style="color:#666">.</span>debug(<span style="color:#4070a0">'hostname -f returned an error, probably no domain is set'</span>)
    <span style="color:#007020;font-weight:700">end</span>
    domain collect_domain
  <span style="color:#007020;font-weight:700">end</span>

  collect_data(<span style="color:#517918">:solaris2</span>) <span style="color:#007020;font-weight:700">do</span>
    <span style="color:#007020">require</span> <span style="color:#4070a0">'socket'</span>

    hostname from_cmd(<span style="color:#4070a0">'hostname'</span>)

    fqdn_lookup <span style="color:#666">=</span> <span style="color:#60add5">Socket</span><span style="color:#666">.</span>getaddrinfo(hostname, <span style="color:#007020">nil</span>, <span style="color:#007020">nil</span>, <span style="color:#007020">nil</span>, <span style="color:#007020">nil</span>, <span style="color:#60add5">Socket</span><span style="color:#666">::</span><span style="color:#60add5">AI_CANONNAME</span>)<span style="color:#666">.</span>first<span style="color:#666">[</span><span style="color:#40a070">2</span><span style="color:#666">]</span>
    <span style="color:#007020;font-weight:700">if</span> fqdn_lookup<span style="color:#666">.</span>split(<span style="color:#4070a0">'.'</span>)<span style="color:#666">.</span>length <span style="color:#666">&gt;</span> <span style="color:#40a070">1</span>
      <span style="color:#60a0b0;font-style:italic"># we received an fqdn</span>
      fqdn fqdn_lookup
    <span style="color:#007020;font-weight:700">else</span>
      <span style="color:#60a0b0;font-style:italic"># default to assembling one</span>
      h <span style="color:#666">=</span> from_cmd(<span style="color:#4070a0">'hostname'</span>)
      d <span style="color:#666">=</span> from_cmd(<span style="color:#4070a0">'domainname'</span>)
      fqdn <span style="color:#4070a0">'#{h}.#{d}'</span>
    <span style="color:#007020;font-weight:700">end</span>

    domain collect_domain
  <span style="color:#007020;font-weight:700">end</span>

  collect_data(<span style="color:#517918">:windows</span>) <span style="color:#007020;font-weight:700">do</span>
    <span style="color:#007020">require</span> <span style="color:#4070a0">'ruby-wmi'</span>
    <span style="color:#007020">require</span> <span style="color:#4070a0">'socket'</span>

    host <span style="color:#666">=</span> <span style="color:#60add5">WMI</span><span style="color:#666">::</span><span style="color:#60add5">Win32_ComputerSystem</span><span style="color:#666">.</span>find(<span style="color:#517918">:first</span>)
    hostname <span style="color:#4070a0">'#{host.Name}'</span>

    info <span style="color:#666">=</span> <span style="color:#60add5">Socket</span><span style="color:#666">.</span>gethostbyname(<span style="color:#60add5">Socket</span><span style="color:#666">.</span>gethostname)
    <span style="color:#007020;font-weight:700">if</span> info<span style="color:#666">.</span>first <span style="color:#666">=~</span> <span style="color:#235388">/.+?\.(.*)/</span>
      fqdn info<span style="color:#666">.</span>first
    <span style="color:#007020;font-weight:700">else</span>
      <span style="color:#60a0b0;font-style:italic"># host is not in dns. optionally use:</span>
      <span style="color:#60a0b0;font-style:italic"># C:\WINDOWS\system32\drivers\etc\hosts</span>
      fqdn <span style="color:#60add5">Socket</span><span style="color:#666">.</span>gethostbyaddr(info<span style="color:#666">.</span>last)<span style="color:#666">.</span>first
    <span style="color:#007020;font-weight:700">end</span>

   domain collect_domain
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h3 id="use-a-mixin-library">Use a mixin Library</h3> <p>The following Ohai example shows a plugin can use a <code>mixin</code> library and also depend on another plugin:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#007020">require</span> <span style="color:#4070a0">'ohai/mixin/os'</span>

<span style="color:#60add5">Ohai</span><span style="color:#666">.</span>plugin(<span style="color:#517918">:Os</span>) <span style="color:#007020;font-weight:700">do</span>
  provides <span style="color:#4070a0">'os'</span>, <span style="color:#4070a0">'os_version'</span>
  depends <span style="color:#4070a0">'kernel'</span>

  collect_data <span style="color:#007020;font-weight:700">do</span>
    os collect_os
    os_version kernel<span style="color:#666">[</span><span style="color:#517918">:release</span><span style="color:#666">]</span>
  <span style="color:#007020;font-weight:700">end</span>
<span style="color:#007020;font-weight:700">end</span>
</code></pre></div>
<h3 id="get-kernel-values">Get Kernel Values</h3> <p>The following Ohai example shows part of a file that gets initial kernel attribute values:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby"><span style="color:#60add5">Ohai</span><span style="color:#666">.</span>plugin(<span style="color:#517918">:Kernel</span>) <span style="color:#007020;font-weight:700">do</span>
  provides <span style="color:#4070a0">'kernel'</span>, <span style="color:#4070a0">'kernel/modules'</span>

  <span style="color:#007020;font-weight:700">def</span> <span style="color:#06287e">init_kernel</span>
    kernel <span style="color:#60add5">Mash</span><span style="color:#666">.</span>new
    <span style="color:#666">[[</span><span style="color:#4070a0">'uname -s'</span>, <span style="color:#517918">:name</span><span style="color:#666">]</span>, <span style="color:#666">[</span><span style="color:#4070a0">'uname -r'</span>, <span style="color:#517918">:release</span><span style="color:#666">]</span>,
    <span style="color:#666">[</span><span style="color:#4070a0">'uname -v'</span>, <span style="color:#517918">:version</span><span style="color:#666">]</span>, <span style="color:#666">[</span><span style="color:#4070a0">'uname -m'</span>, <span style="color:#517918">:machine</span><span style="color:#666">]].</span>each <span style="color:#007020;font-weight:700">do</span> <span style="color:#666">|</span>cmd, property<span style="color:#666">|</span>
      so <span style="color:#666">=</span> shell_out(cmd)
      kernel<span style="color:#666">[</span>property<span style="color:#666">]</span> <span style="color:#666">=</span> so<span style="color:#666">.</span>stdout<span style="color:#666">.</span>split($/)<span style="color:#666">[</span><span style="color:#40a070">0</span><span style="color:#666">]</span>
    <span style="color:#007020;font-weight:700">end</span>
    kernel
  <span style="color:#007020;font-weight:700">end</span>

  <span style="color:#666">...</span>

  collect_data(<span style="color:#517918">:darwin</span>) <span style="color:#007020;font-weight:700">do</span>
    kernel init_kernel
    kernel<span style="color:#666">[</span><span style="color:#517918">:os</span><span style="color:#666">]</span> <span style="color:#666">=</span> kernel<span style="color:#666">[</span><span style="color:#517918">:name</span><span style="color:#666">]</span>

    so <span style="color:#666">=</span> shell_out(<span style="color:#4070a0">'sysctl -n hw.optional.x86_64'</span>)
    <span style="color:#007020;font-weight:700">if</span> so<span style="color:#666">.</span>stdout<span style="color:#666">.</span>split($/)<span style="color:#666">[</span><span style="color:#40a070">0</span><span style="color:#666">].</span>to_i <span style="color:#666">==</span> <span style="color:#40a070">1</span>
      kernel<span style="color:#666">[</span><span style="color:#517918">:machine</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'x86_64'</span>
    <span style="color:#007020;font-weight:700">end</span>

    modules <span style="color:#666">=</span> <span style="color:#60add5">Mash</span><span style="color:#666">.</span>new
    so <span style="color:#666">=</span> shell_out(<span style="color:#4070a0">'kextstat -k -l'</span>)
    so<span style="color:#666">.</span>stdout<span style="color:#666">.</span>lines <span style="color:#007020;font-weight:700">do</span> <span style="color:#666">|</span>line<span style="color:#666">|</span>
      <span style="color:#007020;font-weight:700">if</span> line <span style="color:#666">=~</span> <span style="color:#235388">/(\d+)\s+(\d+)\s+0x[0-9a-f]+\s+0x([0-9a-f]+)\s+0x[0-9a-f]+\s+([a-zA-Z0-9\.]+) \(([0-9\.]+)\)/</span>
        kext<span style="color:#666">[</span>$4<span style="color:#666">]</span> <span style="color:#666">=</span> { <span style="color:#517918">:version</span> <span style="color:#666">=&gt;</span> $5, <span style="color:#517918">:size</span> <span style="color:#666">=&gt;</span> $3<span style="color:#666">.</span>hex, <span style="color:#517918">:index</span> <span style="color:#666">=&gt;</span> $1, <span style="color:#517918">:refcount</span> <span style="color:#666">=&gt;</span> $2 }
      <span style="color:#007020;font-weight:700">end</span>
    <span style="color:#007020;font-weight:700">end</span>

    kernel<span style="color:#666">[</span><span style="color:#517918">:modules</span><span style="color:#666">]</span> <span style="color:#666">=</span> modules
  <span style="color:#007020;font-weight:700">end</span>

  <span style="color:#666">...</span>
</code></pre></div> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/ohai_custom/" class="_attribution-link">https://docs.chef.io/ohai_custom/</a>
  </p>
</div>
