<div id="col-content" data-swiftype-index="true"> <div id="restore"><h1>Restore</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/automate/blob/master/components/docs-chef-io/content/automate/restore.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <p>Restore Chef Automate from a <a href="index.html#restore-from-a-filesystem-backup">filesystem backup</a>, an <a href="index.html#restore-from-an-aws-s3-backup">Amazon S3 bucket backup</a>, or a <a href="index.html#restore-from-a-google-cloud-storage-backup">Google Cloud Storage (GCS) bucket backup</a>.</p> <p>Before restoring a Chef Automate installation, see how to <a href="../backup/index.html">configure your backups</a>.</p> <h2 id="prerequisites">Prerequisites</h2> <ol> <li> <p>On the restore host, download and unzip the Chef Automate command-line tool:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">     curl https://packages.chef.io/files/current/latest/chef-automate-cli/chef-automate_linux_amd64.zip | gunzip - &gt; chef-automate <span style="color:#666">&amp;&amp;</span> chmod +x chef-automate
</code></pre></div>
</li> <li> <p>To restore from <strong>filesystem backups</strong>, Chef Automate requires access to a backup directory in the <a href="../backup/index.html#backup-to-a-filesystem">configured location</a>. Ensure access for the backup type used:</p> <ol> <li>To restore <a href="../backup/index.html#backup-to-a-filesystem">a network-attached filesystem backup</a>, mount the shared backup directory to the same mount point configured at the time of the backup.</li> <li>To restore <a href="../backup/index.html#backup-to-a-filesystem">a backup directory that is not a network-attached filesystem</a>, copy the backup directory to the configured location at the time of the backup.</li> <li>To restore a <a href="../backup/index.html#store-a-filesystem-backup-in-a-single-file-archive">single-file backup archive</a>, copy your archive to the restore host and extract it to the configured backup directory.</li> </ol> </li> <li> <p>To restore a backup to a host with a different fully qualified domain name (FQDN) than the original backup host, create a <code>patch.toml</code> file that specifies the new FQDN and provide it at restore time:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">     [global.v1]
     fqdn = <span style="color:#4070a0">"&lt;new-fqdn&gt;"</span>

     <span style="color:#60a0b0;font-style:italic"># To provide a cert and key for the restore host, uncomment and fill</span>
     <span style="color:#60a0b0;font-style:italic"># these sections.</span>
     <span style="color:#60a0b0;font-style:italic"># [[global.v1.frontend_tls]]</span>
     <span style="color:#60a0b0;font-style:italic"># The TLS certificate for the load balancer frontend.</span>
     <span style="color:#60a0b0;font-style:italic"># cert = """-----BEGIN CERTIFICATE-----</span>
     <span style="color:#60a0b0;font-style:italic"># &lt;certificate-for-new-fqdn&gt;</span>
     <span style="color:#60a0b0;font-style:italic"># -----END CERTIFICATE-----</span>
     <span style="color:#60a0b0;font-style:italic"># """</span>

     <span style="color:#60a0b0;font-style:italic"># The TLS RSA key for the load balancer frontend.</span>
     <span style="color:#60a0b0;font-style:italic"># key = """-----BEGIN RSA PRIVATE KEY-----</span>
     <span style="color:#60a0b0;font-style:italic"># &lt;key-for-new-fqdn&gt;</span>
     <span style="color:#60a0b0;font-style:italic"># -----END RSA PRIVATE KEY-----</span>
     <span style="color:#60a0b0;font-style:italic"># """</span>
</code></pre></div>
</li> <li> <p>To restore a backup to a machine with less memory than the original system, adjust for the appropriate lower memory settings by creating a <code>patch.toml</code> file that specifies the heapsize, and providing the file at restore time:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">  [elasticsearch.v1.sys.runtime]
    heapsize = <span style="color:#4070a0">"4096m"</span>
    <span style="color:#60a0b0;font-style:italic"># Use "m" for megabytes and "g" for gigabytes</span>
</code></pre></div>
</li> </ol> <h2 id="restore-from-a-filesystem-backup">Restore From a Filesystem Backup</h2> <p>Meet the required <a href="index.html#prerequisites">prerequisites</a> before beginning your restore process.</p> <h3 id="restore-in-an-internet-connected-environment">Restore in an Internet-Connected Environment</h3> <p>If you have <a href="../backup/index.html#backup-to-a-filesystem">configured the backup directory</a> to a directory other than the default directory (<code>/var/opt/chef-automate/backups</code>), you must supply the backup directory. Without a backup ID, Chef Automate uses the most recent backup in the backup directory.</p> <p>To restore on a new host, run:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">chef-automate backup restore &lt;/path/to/backups/&gt;BACKUP_ID
</code></pre></div>
<p>To restore on an existing Chef Automate host by overwriting the existing installation with the backup, run:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">chef-automate backup restore &lt;/path/to/backups/&gt;BACKUP_ID --skip-preflight
</code></pre></div>
<p>Use the <code>--patch-config</code> option with a <a href="index.html#prerequisites">configuration patch file</a> to restore to a host with a different FQDN than that of the backup host:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">chef-automate backup restore &lt;/path/to/backups/&gt;BACKUP_ID --patch-config &lt;/path/to/patch.toml&gt; --skip-preflight
</code></pre></div>
<p>Restores from a filesystem backup may fail with incorrect directory permissions. Run the <a href="../cli_chef_automate/index.html#chef-automate-backup-fix-repo-permissions"><code>fix-repo-permissions</code> command</a> to address such issues:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">sudo chef-automate backup fix-repo-permissions &lt;path&gt;
</code></pre></div>
<h3 id="restore-in-an-airgapped-environment">Restore in an Airgapped Environment</h3> <p>To restore a backup of an <a href="../airgapped_installation/index.html">airgapped installation</a>, you must specify the <a href="../airgapped_installation/index.html#create-an-airgap-installation-bundle">Airgap Installation Bundle</a> used by the installation. If you have <a href="../backup/index.html#backup-to-a-filesystem">configured the backup directory</a> to a directory that is not the default <code>/var/opt/chef-automate/backups</code>, then you must supply the backup directory. If you do not provide a backup ID, Chef Automate uses the most recent backup in the backup directory.</p> <p>To restore on a new host, run:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">chef-automate backup restore --airgap-bundle &lt;/path/to/bundle&gt; &lt;/path/to/backups/&gt;BACKUP_ID
</code></pre></div>
<p>To restore on an existing Chef Automate host, run:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">chef-automate backup restore --airgap-bundle &lt;/path/to/bundle&gt; &lt;/path/to/backups/&gt;BACKUP_ID --skip-preflight
</code></pre></div>
<p>To restore using AWS S3 on an existing Chef Automate host, run:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">chef-automate backup restore --airgap-bundle &lt;/path/to/bundle&gt; s3://bucket_name/&lt;/path/to/backups/&gt;BACKUP_ID --skip-preflight
</code></pre></div>
<p>To restore using Google Cloud Storage (GCS) on an existing Chef Automate host, run:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">chef-automate backup restore --airgap-bundle &lt;/path/to/bundle&gt; gs://bucket_name/&lt;/path/to/backups/&gt;BACKUP_ID --skip-preflight
</code></pre></div>
<p>Use the <code>--patch-config</code> option with a <a href="index.html#prerequisites">configuration patch file</a> to restore to a host with a different FQDN than that of the backup host.</p> <p>Restores from a filesystem backup may fail with incorrect directory permissions. Run the <a href="../cli_chef_automate/index.html#chef-automate-backup-fix-repo-permissions"><code>fix-repo-permissions</code> command</a> to address such issues:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">sudo chef-automate backup fix-repo-permissions &lt;path&gt;
</code></pre></div>
<h2 id="restore-from-an-aws-s3-backup">Restore From an AWS S3 Backup</h2> <p>Meet the required <a href="index.html#prerequisites">prerequisites</a> before beginning your restore process.</p> <p>See how to <a href="../backup/index.html#backup-to-aws-s3">back up to AWS S3</a>.</p> <p>To restore from an AWS S3 bucket backup on a new host, run:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">chef-automate backup restore s3://bucket_name/path/to/backups/BACKUP_ID
</code></pre></div>
<p>To restore from an AWS S3 bucket backup on an existing Chef Automate host, run:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">chef-automate backup restore s3://bucket_name/path/to/backups/BACKUP_ID --skip-preflight
</code></pre></div>
<p>Use the <code>--patch-config</code> option with a <a href="index.html#prerequisites">configuration patch file</a> to restore to a host with a different FQDN than that of the backup host:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">chef-automate backup restore s3://bucket_name/path/to/backups/BACKUP_ID --patch-config &lt;/path/to/patch.toml&gt; --skip-preflight
</code></pre></div>
<p>A successful restore shows the timestamp of the backup used at the end of the status output:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">Success: Restored backup <span style="color:#40a070">20180517223558</span>
</code></pre></div>
<h2 id="restore-from-a-google-cloud-storage-backup">Restore From a Google Cloud Storage Backup</h2> <p>Meet the required <a href="index.html#prerequisites">prerequisites</a> before beginning your restore process.</p> <p>See how to <a href="../backup/index.html#backup-to-gcs">back up to GCS</a>.</p> <p>To restore from a Google Cloud Storage (GCS) bucket backup on a new host, run:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">chef-automate backup restore gs://bucket_name/path/to/backups/BACKUP_ID
</code></pre></div>
<p>To restore from a Google Cloud Storage (GCS) bucket backup on an existing Chef Automate host, run:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">chef-automate backup restore gs://bucket_name/path/to/backups/BACKUP_ID --skip-preflight
</code></pre></div>
<p>Use the <code>--patch-config</code> option with a <a href="index.html#prerequisites">configuration patch file</a> to restore to a host with a different FQDN than that of the backup host:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">chef-automate backup restore gs://bucket_name/path/to/backups/BACKUP_ID --patch-config &lt;/path/to/patch.toml&gt; --skip-preflight
</code></pre></div>
<p>A successful restore shows the timestamp of the backup used at the end of the status output:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">Success: Restored backup <span style="color:#40a070">20180517223558</span>
</code></pre></div>
<h2 id="troubleshooting">Troubleshooting</h2> <p>Set the log level to <code>debug</code> before re-running a failed restore to output debug info to the Chef Automate log:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">chef-automate debug set-log-level deployment-service debug
</code></pre></div>
<h2 id="references">References</h2> <p>See the <a href="../cli_chef_automate/index.html#chef-automate-backup-restore"><code>chef-automate backup restore</code> command reference</a>.</p> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/automate/restore/" class="_attribution-link">https://docs.chef.io/automate/restore/</a>
  </p>
</div>
