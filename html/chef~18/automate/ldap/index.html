<div id="col-content" data-swiftype-index="true"> <div id="ldap"><h1>LDAP</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/automate/blob/master/components/docs-chef-io/content/automate/ldap.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <h2 id="authentication-via-existing-identity-management-systems">Authentication via Existing Identity Management Systems</h2> <p>Chef Automate can integrate with existing LDAP services to authenticate users in Chef Automate, and thus use their existing group memberships to determine their Chef Automate permissions.</p> <p>Chef Automate supports using both local users and externally managed users from an external identity provider (IdP). Both <em>one</em> LDAP service (or MSAD for simplified configuration of Active Directory setups) and <em>one</em> SAML IdP can be used. You do not need to configure an external IdP if you simply want to create users and teams local to Chef Automate. See the <a href="../users/index.html">Users</a> documentation for additional information.</p> <p>Chef Automate uses <a href="https://github.com/dexidp/dex">Dex</a> to support LDAP integrations. To configure authentication for your Chef Automate installation, create a TOML file that contains the partial LDAP configuration. Then run <code>chef-automate config patch &lt;/path/to/your-file.toml&gt;</code> to deploy your change.</p> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> You may only integrate one IdP using SAML and one IdP using LDAP at a time. Chef Automate does not support using <em>two</em> SAML IdPs or <em>two</em> LDAP services simultaneously. </div> </div> <p>Switching between a Microsoft AD configuration and generic LDAP configuration will not affect your policies, as they are both LDAP configurations. However, switching between either of those configurations and a SAML configuration will require you to adjust the <a href="../iam_v2_overview/index.html">IAM</a> policy membership.</p> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> Local, MSAD, and LDAP users will have their Chef Automate sessions refreshed while their Chef Automate browser window remains open or until they sign out directly. </div> </div> <h2 id="supported-identity-management-systems">Supported Identity Management Systems</h2> <ul> <li>Azure Active Directory</li> <li>Microsoft Active Directory (MSAD)</li> </ul> <h2 id="overview">Overview</h2> <p>This is documentation for configuring Chef Automate’s Lightweight Directory Application Protocol (LDAP) and Microsoft Active Directory (MSAD) integrations. LDAP is an established and open standard protocol for interacting with directory servers. A directory server stores information–in this case information for authenticating and authorizing users–in a tree of entries. (It is not a relational database.)</p> <h2 id="microsoft-active-directory">Microsoft Active Directory</h2> <p>Microsoft Active Directory (MSAD) is a type of directory server that supports LDAP. Chef Automate comes with a default LDAP configuration for MSAD. The Chef Automate default MSAD configuration is a minimal configuration for standard MSAD systems, which you can extend by overriding default values and using additional configuration options. Chef Automate’s default configuration for Microsoft AD is specific to LDAP. To configure Microsoft AD using SAML, see the <a href="../saml/index.html">SAML documentation</a>.</p> <h2 id="changing-chef-automate-configuration">Changing Chef Automate Configuration</h2> <p>If you need to change your configured external identity provider settings, replace your existing configuration by following these steps:</p> <ol> <li>Run <code>chef-automate config show config.toml</code>.</li> <li>Edit <code>config.toml</code> to replace the <code>dex.v1.sys.connectors</code> section with the configuration values for your new identity provider.</li> <li>Run <code>chef-automate config set config.toml</code> to set your updated configuration.</li> </ol> <h3 id="minimal-msad-configuration">Minimal MSAD Configuration</h3> <dl> <dt>base_user_search_dn</dt> <dd>“your base user search DN”</dd> <dt>base_group_search_dn</dt> <dd>“your base group search DN”</dd> <dt>bind_dn</dt> <dd>“your bind_dn”</dd> <dt>bind_password</dt> <dd>“your bind_password” <p><code>bind_password</code> may also be passed via the <code>AUTOMATE_SECRET_MSAD_PASSWORD</code> environment variable when running <code>chef-automate</code> commands.</p> </dd> <dt>ca_contents</dt> <dd>Your certificate authority (CA) certificate contents. You can provide multiple PEM-encoded CA certs. Optional. <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml"><span style="color:#60a0b0;font-style:italic"># Example ca_contents setting:</span>
ca_contents = <span style="color:#4070a0">"""-----BEGIN CERTIFICATE-----
</span><span style="color:#4070a0">MIICsDCCAhmgAwIBAgIJAJxMopMJbhPkMA0GCSqGSIb
</span><span style="color:#4070a0">...
</span><span style="color:#4070a0">X0uRzUPlpTtd5tYFs43nKqxJT6s=
</span><span style="color:#4070a0">-----END CERTIFICATE-----"""</span>
</code></pre></div>
</dd> <dt>host</dt> <dd>The domain name of your directory server, for example <code>"ldap.corp.com"</code>. Default port: <code>636</code>. Override the port by appending it to the host setting, <code>"ldap.corp.com:10636"</code>
</dd> </dl> <h4 id="minimal-msad-configtoml">Minimal MSAD config.toml</h4> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">[dex.v1.sys.connectors.msad_ldap]
host = <span style="color:#4070a0">"&lt;your host&gt;"</span>
bind_dn = <span style="color:#4070a0">"&lt;your bind_dn&gt;"</span>
bind_password = <span style="color:#4070a0">"&lt;your bind_password&gt;"</span>
base_user_search_dn = <span style="color:#4070a0">"&lt;your base user search DN&gt;"</span>
base_group_search_dn = <span style="color:#4070a0">"&lt;your base group search DN&gt;"</span>
ca_contents = <span style="color:#4070a0">"&lt;your ca contents&gt;"</span> <span style="color:#60a0b0;font-style:italic"># optional, but recommended</span>
</code></pre></div>
<h3 id="full-msad-configuration">Full MSAD Configuration</h3> <p>The MSAD configuration is an LDAP configuration with more provided default values that are commonly a good fit for Active Directory. Override any single default value by uncommenting it in the configuration and setting its value:</p> <dl> <dt>email_attr</dt> <dd>“mail”</dd> <dt>filter_groups_by_user_attr</dt> <dd>“member”</dd> <dt>filter_groups_by_user_value</dt> <dd>“DN”</dd> <dt>group_query_filter</dt> <dd>“(objectClass=group)”</dd> <dt>group_display_name_attr</dt> <dd>“displayName”</dd> <dt>insecure_no_ssl</dt> <dd>false</dd> </dl> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> Connecting to an LDAP service without TLS is not recommended. </div> </div> <dl> <dt>user_display_name_attr</dt> <dd>“displayName”</dd> <dt>user_id_attr</dt> <dd>“sAMAccountName”</dd> <dt>user_query_filter</dt> <dd>“(objectClass=person)”</dd> <dt>username_attr</dt> <dd>“sAMAccountName”</dd> </dl> <h4 id="example-full-msad-configtoml">Example Full MSAD config.toml</h4> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">[dex.v1.sys.connectors.msad_ldap]
host = <span style="color:#4070a0">"&lt;your host&gt;"</span>
bind_dn = <span style="color:#4070a0">"&lt;your bind_dn&gt;"</span>
bind_password = <span style="color:#4070a0">"&lt;your bind_password&gt;"</span>
base_user_search_dn = <span style="color:#4070a0">"&lt;your base user search DN&gt;"</span>
base_group_search_dn = <span style="color:#4070a0">"&lt;your base group search DN&gt;"</span>
ca_contents = <span style="color:#4070a0">"&lt;your ca contents&gt;"</span> <span style="color:#60a0b0;font-style:italic"># optional</span>

<span style="color:#60a0b0;font-style:italic"># MSAD default values (uncomment to override a specific one)</span>
<span style="color:#60a0b0;font-style:italic"># insecure_no_ssl = false</span>
<span style="color:#60a0b0;font-style:italic"># user_query_filter = "(objectClass=person)"</span>
<span style="color:#60a0b0;font-style:italic"># user_id_attr = "sAMAccountName"</span>
<span style="color:#60a0b0;font-style:italic"># username_attr = "sAMAccountName"</span>
<span style="color:#60a0b0;font-style:italic"># email_attr = "mail"</span>
<span style="color:#60a0b0;font-style:italic"># user_display_name_attr = "displayName"</span>
<span style="color:#60a0b0;font-style:italic"># group_query_filter = "(objectClass=group)"</span>
<span style="color:#60a0b0;font-style:italic"># filter_groups_by_user_value = "DN"</span>
<span style="color:#60a0b0;font-style:italic"># filter_groups_by_user_attr = "member"</span>
<span style="color:#60a0b0;font-style:italic"># group_display_name_attr = "displayName"</span>
</code></pre></div>
<h2 id="extended-ldap-settings">Extended LDAP Settings</h2> <p>For those who do not use Microsoft AD or require greater control over their configuration, Chef Automate has the following customizable LDAP configuration settings:</p> <dl> <dt>base_group_search_dn</dt> <dd>“your base group search DN”</dd> <dt>base_user_search_dn</dt> <dd>“your base user search DN”</dd> <dt>bind_dn</dt> <dd>“your bind_dn”</dd> <dt>bind_password</dt> <dd>“your bind_password”</dd> <dt>ca_contents</dt> <dd>“your ca contents”</dd> <dt>email_attr</dt> <dd>“your email attribute”</dd> <dt>filter_groups_by_user_attr</dt> <dd>“groups to filter by user attribute”</dd> <dt>filter_groups_by_user_value</dt> <dd>“groups to filter by user value”</dd> <dt>group_display_name_attr</dt> <dd>“group display name attribute”</dd> <dt>group_query_filter</dt> <dd>“your group query filter”</dd> <dt>host</dt> <dd>“your host”</dd> </dl> <p>insecure_no_ssl :true or false</p> <dl> <dt>user_query_filter</dt> <dd>“your user query filter”</dd> <dt>username_attr</dt> <dd>“your username attribute”</dd> <dt>user_id_attr</dt> <dd>“your userid attribute”</dd> <dt>user_display_name_attr</dt> <dd>“your user display name attribute”</dd> </dl> <h3 id="example-extended-ldap-configtoml">Example Extended LDAP config.toml</h3> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">[dex.v1.sys.connectors.ldap]
<span style="color:#60a0b0;font-style:italic"># authentication options</span>
ca_contents = <span style="color:#4070a0">"&lt;your ca contents&gt;"</span>
host = <span style="color:#4070a0">"&lt;your host&gt;"</span>
bind_dn = <span style="color:#4070a0">"&lt;your bind_dn&gt;"</span>
bind_password = <span style="color:#4070a0">"&lt;your bind_password&gt;"</span>
insecure_no_ssl = <span style="color:#007020;font-weight:700">true</span> or <span style="color:#007020;font-weight:700">false</span>

<span style="color:#60a0b0;font-style:italic"># ldapsearch options</span>
base_user_search_dn = <span style="color:#4070a0">"&lt;your base user search DN&gt;"</span>
user_query_filter = <span style="color:#4070a0">"&lt;your user query filter&gt;"</span>
username_attr = <span style="color:#4070a0">"&lt;your username attribute&gt;"</span>
user_id_attr = <span style="color:#4070a0">"&lt;your userid attribute&gt;"</span>
email_attr = <span style="color:#4070a0">"&lt;your email attribute&gt;"</span>
user_display_name_attr = <span style="color:#4070a0">"&lt;your user display name attribute&gt;"</span>
base_group_search_dn = <span style="color:#4070a0">"&lt;your base group search DN&gt;"</span>
group_query_filter = <span style="color:#4070a0">"&lt;your group query filter&gt;"</span>
filter_groups_by_user_attr = <span style="color:#4070a0">"&lt;groups to filter by user attribute&gt;"</span>
filter_groups_by_user_value = <span style="color:#4070a0">"&lt;groups to filter by user value&gt;"</span>
group_display_name_attr = <span style="color:#4070a0">"&lt;group display name attribute&gt;"</span>
</code></pre></div>
<p>See the <a href="index.html">LDAP</a> for more information on configuration fields. You have the full extent of TOML is at your disposal for declaring configuration fields.</p> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> Connecting to an LDAP service without TLS is not recommended. </div> </div> <p>However, if you wish to integrate with an LDAP server with TLS disabled:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">insecure_no_ssl = <span style="color:#007020;font-weight:700">true</span>
</code></pre></div>
<h3 id="sign-in-with-ldap">Sign In with LDAP</h3> <p>Once the user has provided a username and password at the sign in screen, Chef Automate goes through a sequence of operations to complete the sign in:</p> <ol> <li><a href="#connect">Connect</a></li> <li><a href="#bind">Bind</a></li> <li><a href="#user-search">User Search</a></li> <li><a href="#signin-bind">Sign in Bind</a></li> <li><a href="#group-search">Group Search</a></li> </ol> <h4 id="authorization-with-ldap">Authorization with LDAP</h4> <p>Chef Automate supports defining permissions for LDAP users and their groups. See <a href="../iam_v2_overview/index.html#members-and-policies">IAM members and policies</a>.</p> <h4 id="connect">Connect</h4> <p>Chef Automate first needs to establish a TCP connection to your LDAP service, secured by TLS. It will connect to the host configured in your TOML configuration, for example:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">host = <span style="color:#4070a0">"ldap.corp.com"</span>
</code></pre></div>
<p>Automate uses port <code>636</code> by default. To override the port, append it to the host setting, e.g.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">host = <span style="color:#4070a0">"ldap.corp.com:10636"</span>
</code></pre></div>
<p>Whether the validity of the server’s TLS certificate will be enforced depends on the TLS setup: if you provide a certificate authority’s (CA) certificate(s), Chef Automate will only communicate with the LDAP service if the certificate provided by the host can be validated using the CA certificate(s).</p> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> Connecting to an LDAP service without TLS is not recommended. </div> </div> <p>However, if you wish to integrate with an LDAP server with TLS disabled:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">insecure_no_ssl = <span style="color:#007020;font-weight:700">true</span>
</code></pre></div>
<p>See <a href="#troubleshoot-your-connection">Troubleshoot your Connection</a> for common issues related to <em>Connect</em>.</p> <h4 id="bind">Bind</h4> <p>Chef Automate then authenticates with (or “binds to”) the LDAP service using <em>bind credentials</em>. In your configuration TOML file, these would be (for example):</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">bind_dn = <span style="color:#4070a0">"cn=service_account,dc=corp,dc=com"</span>
bind_password = <span style="color:#4070a0">"i&lt;3ldap"</span>
</code></pre></div>
<p>If your LDAP server supports <em>anonymous bind</em>, and you want to use that, unset both bind DN and password:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">bind_dn = <span style="color:#4070a0">""</span>
bind_password = <span style="color:#4070a0">""</span>
</code></pre></div>
<p>Wrap special characters in a bind_password in triple single quotes.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">bind_password = <span style="color:#4070a0">'''$p3c"i'</span><span>@</span>l <span>!</span> <span>%</span><span style="color:#60a0b0;font-style:italic">#'''</span>
</code></pre></div>
<p>See <a href="#troubleshoot-bind">Troubleshoot Bind</a> for common issues related to <em>Bind</em>.</p> <h4 id="user-search">User Search</h4> <p>After binding successfully, Chef Automate will try to obtain the directory name of the user that is trying to sign in.</p> <p>To do so, it will search, using the configured <em>base</em> <code>base_user_search_dn</code>, for an entry such that <code>username_attr</code> equals the username that attempted to sign in.</p> <p>If configured, it will retrieve additional attributes, using the configured names (<code>user_id_attr</code>, <code>email_attr</code>, and <code>user_display_name_attr</code>). See <a href="../configuration/index.html#ldap">Configuration: LDAP</a> for an overview.</p> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> <p>The <code>ldapsearch</code> command line corresponding to <em>User Search</em> is</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">ldapsearch -h <span style="color:#bb60d5">$host</span> -D <span style="color:#bb60d5">$bind_dn</span> -w <span style="color:#bb60d5">$bind_password</span> <span style="color:#4070a0;font-weight:700">\
</span>  -s sub <span style="color:#4070a0;font-weight:700">\
</span>  -b <span style="color:#bb60d5">$base_user_search_dn</span> <span style="color:#4070a0;font-weight:700">\
</span>  <span style="color:#4070a0">"(</span><span style="color:#bb60d5">$username_attr</span><span style="color:#4070a0">=</span><span style="color:#bb60d5">$username</span><span style="color:#4070a0">)"</span> <span style="color:#4070a0;font-weight:700">\
</span>  <span style="color:#bb60d5">$user_id_attr</span> <span style="color:#bb60d5">$user_display_name_attr</span> <span style="color:#bb60d5">$email_attr</span>
</code></pre></div>
<p>where <code>username</code> is what was typed into the <strong>username input box</strong> in the Sign in form.</p> </div> </div> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> If the LDAP search fails to retrieve the configured attributes, the sign in process will fail. </div> </div> <p>See <a href="#troubleshoot-user-search">Troubleshoot User Search</a> for common issues related to <em>User Search</em>.</p> <h5 id="filtering-which-users-can-sign-in">Filtering Which Users Can Sign In</h5> <p>You can further restrict the user search by providing a valid LDAP filter to <code>user_query_filter</code>. For example,</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">user_query_filter = <span style="color:#4070a0">"(objectClass=person)"</span>
</code></pre></div>
<p>which will be concatenated with the search filter constructed from the provided username in the sign in screen. The contents of <code>user_query_filter</code> gets expanded to <code>(&amp;&lt;user_query_filter_value&gt;)</code> so you can pass in multiple filters.</p> <p>For example, if you wanted to only allow people that were members of a specific Active Directory group to sign in to Chef Automate, you could define a <code>user_query_filter</code> with multiple filters like:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">user_query_filter = <span style="color:#4070a0">"(objectClass=person)(memberof=CN=YourGroupToFilterOn,OU=Users,DC=YourDomain,DC=com)"</span>
</code></pre></div>
<p>This filter says “only allow people who are members of YourGroupToFilterOn to sign in to Chef Automate”. When a user tries to sign in, they would only be authorized if they were found after the filter is applied:</p> <pre tabindex="0" class="highlight" data-language="ruby"><code class="language-LDIF" data-lang="LDIF">(&amp;(objectClass=person)(memberof=CN=YourGroupToFilterOn,OU=Users,DC=YourDomain,DC=com))
</code></pre>
<div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> <p>The <code>ldapsearch</code> command line corresponding to <em>User Search</em> with restricted groups is</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">ldapsearch -h <span style="color:#bb60d5">$host</span> -D <span style="color:#bb60d5">$bind_dn</span> -w <span style="color:#bb60d5">$bind_password</span> <span style="color:#4070a0;font-weight:700">\
</span>  -s sub <span style="color:#4070a0;font-weight:700">\
</span>  -b <span style="color:#bb60d5">$base_user_search_dn</span> <span style="color:#4070a0;font-weight:700">\
</span>  <span style="color:#4070a0">"(&amp;</span><span style="color:#bb60d5">$user_query_filter</span><span style="color:#4070a0">(</span><span style="color:#bb60d5">$username_attr</span><span style="color:#4070a0">=</span><span style="color:#bb60d5">$username</span><span style="color:#4070a0">))"</span>
</code></pre></div>
<p>where <code>username</code> is what was typed into the username input box in the Sign in form.</p> </div> </div> <p>See <a href="#ldapsearch-example-queries"><code>ldapsearch</code> Example Queries</a> for an example on using <code>ldapsearch</code>, and different directory layouts.</p> <h4 id="sign-in-bind">Sign In Bind</h4> <p>When the search for a user directory entry has succeeded, the LDAP connector will attempt to bind as the user entry, using the supplied password.</p> <p>For example, if the sign in using <code>jane:janespassword</code> has resulted in a successful user search, returning <code>cn=jane,ou=People,dc=corp,dc=com</code>, the next step will be to <em>bind again</em> using that DN, and the password <code>janespassword</code>.</p> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> <p>The <code>ldapsearch</code> command line corresponding to <em>User Search</em> is</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">ldapsearch -h <span style="color:#bb60d5">$host</span> -D <span style="color:#bb60d5">$user_dn</span> -w <span style="color:#bb60d5">$password</span>
</code></pre></div>
<p>where <code>user_dn</code> is the DN of the user that was returned in <a href="#user-search">User Search</a>, and <code>password</code> is what was typed into the <strong>password input box</strong> in the Sign in form.</p> <p>Note that <code>result: 32 No such object</code> is the successful response here, a failed sign in bind using <code>ldapsearch</code> returns:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">ldap_bind: Invalid credentials <span style="color:#666">(</span>49<span style="color:#666">)</span>
        additional info: INVALID_CREDENTIALS: Bind failed: Cannot authenticate user <span style="color:#bb60d5">uid</span><span style="color:#666">=</span>test2,ou<span style="color:#666">=</span>users,ou<span style="color:#666">=</span>system
</code></pre></div> </div> </div> <p>See <a href="#troubleshoot-sign-in-bind">Troubleshoot Sign In Bind</a> for common issues related to <em>Sign_In_Bind</em>.</p> <h4 id="group-search">Group Search</h4> <p>Finally, after the user has been authenticated, their internal record is enriched with LDAP-provided groups. This happens by executing another search using the same bind DN and password that was used for user search.</p> <p>Similar to user search, a base DN has to be provided; and the result can be restricted by providing an additional filter:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">base_group_search_dn = <span style="color:#4070a0">"ou=Groups,dc=corp,dc=com"</span>
group_query_filter = <span style="color:#4070a0">"(objectClass=group)"</span>
</code></pre></div>
<p>The correct configuration settings again depend on your directory server’s schema; see the example configs below.</p> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> The <code>base_group_search_dn</code> setting is optional. However, if it is not provided, users authenticating via LDAP (or MSAD) will not be members of any teams. </div> </div> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> <p>The <code>ldapsearch</code> command line corresponding to <em>Group Search</em> is</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">ldapsearch -h <span style="color:#bb60d5">$host</span> -D <span style="color:#bb60d5">$bind_dn</span> -w <span style="color:#bb60d5">$bind_password</span> <span style="color:#4070a0;font-weight:700">\
</span>  -s sub <span style="color:#4070a0;font-weight:700">\
</span>  -b <span style="color:#bb60d5">$base_group_search_dn</span> <span style="color:#4070a0;font-weight:700">\
</span>  <span style="color:#4070a0">"(</span><span style="color:#bb60d5">$filter_groups_by_user_attr</span><span style="color:#4070a0">=</span><span style="color:#bb60d5">$user_attr</span><span style="color:#4070a0">)"</span> <span style="color:#4070a0;font-weight:700">\
</span>  <span style="color:#bb60d5">$group_display_name_attr</span>
</code></pre></div>
<p>where <code>user_attr</code> is the <code>$filter_groups_by_user_value</code> of the user that was returned in <a href="#user-search">User Search</a>.</p> </div> </div> <p>See <a href="#troubleshoot-group-search">Troubleshoot Group Search</a> for common issues related to <em>Group Search</em>.</p> <h4 id="configuration-overview">Configuration Overview</h4> <p>See below for the full configuration and additional details about all LDAP configuration options.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">[dex.v1.sys.connectors.ldap]
  <span style="color:#60a0b0;font-style:italic">###</span>
   <span style="color:#60a0b0;font-style:italic"># Configuration for querying your LDAP server</span>
   <span style="color:#60a0b0;font-style:italic">###</span>
   ca_contents = <span style="color:#4070a0">"&lt;your ca contents&gt;"</span>
   host = <span style="color:#4070a0">"&lt;your host&gt;"</span>

   <span style="color:#60a0b0;font-style:italic"># The DN and password you wish to bind to your LDAP server to search for</span>
   <span style="color:#60a0b0;font-style:italic"># users to authenticate for Chef Automate (and also to search for their group membership).</span>
   <span style="color:#60a0b0;font-style:italic"># Example: "uid=seviceaccount,cn=users,dc=example,dc=com"</span>
   bind_dn = <span style="color:#4070a0">"&lt;your bind_dn&gt;"</span>

   <span style="color:#60a0b0;font-style:italic"># bind_password may also be passed via the AUTOMATE_SECRET_LDAP_PASSWORD environment</span>
   <span style="color:#60a0b0;font-style:italic"># variable when running `chef-automate` commands.</span>
   bind_password = <span style="color:#4070a0">"&lt;your bind_password&gt;"</span>

   <span style="color:#60a0b0;font-style:italic">###</span>
   <span style="color:#60a0b0;font-style:italic"># User Query (search for LDAP users to authenticate for Chef Automate)</span>
   <span style="color:#60a0b0;font-style:italic">###</span>
   <span style="color:#60a0b0;font-style:italic"># The base DN to start the user query.</span>
   <span style="color:#60a0b0;font-style:italic"># Chef Automate will use this as the base DN on which to search for users to authenticate against your LDAP server.</span>
   <span style="color:#60a0b0;font-style:italic"># Example: "cn=users,dc=example,dc=com"</span>
   base_user_search_dn = <span style="color:#4070a0">"&lt;your base user search DN&gt;"</span>

   <span style="color:#60a0b0;font-style:italic"># The LDAP field used to filter the query for users to authenticate for Chef Automate.</span>
   <span style="color:#60a0b0;font-style:italic"># Example: Setting this to "uid" would result in a filter of "(uid=&lt;username_for_user_trying_to_authenticate&gt;)".</span>
   username_attr = <span style="color:#4070a0">"&lt;your username attribute&gt;"</span>

   <span style="color:#60a0b0;font-style:italic"># Optional: LDAP query filter to apply when searching for users to authenticate.</span>
   <span style="color:#60a0b0;font-style:italic"># This will be combined with username_attr filter above.</span>
   <span style="color:#60a0b0;font-style:italic"># Example: Setting this to "(objectClass=person)" will filter on human actors only.</span>
   user_query_filter = <span style="color:#4070a0">"&lt;your user query filter&gt;"</span>

   <span style="color:#60a0b0;font-style:italic">###</span>
   <span style="color:#60a0b0;font-style:italic"># Populating the Chef Automate User via LDAP</span>
   <span style="color:#60a0b0;font-style:italic">###</span>
   <span style="color:#60a0b0;font-style:italic"># Determines which LDAP field populates the username in a user's Chef Automate session on successful authentication.</span>
   user_id_attr = <span style="color:#4070a0">"&lt;your userid attribute&gt;"</span>

   <span style="color:#60a0b0;font-style:italic"># Optional: determines which LDAP field populates the email in a user's Chef Automate session on successful authentication.</span>
   <span style="color:#60a0b0;font-style:italic"># Defaults to "user_id_attr" if not specified.</span>
   email_attr = <span style="color:#4070a0">"&lt;your email attribute&gt;"</span>

   <span style="color:#60a0b0;font-style:italic"># Optional: determines which LDAP field populates the display name in a user's Chef Automate session on successful authentication.</span>
   <span style="color:#60a0b0;font-style:italic"># Defaults to "name" if not specified.</span>
   user_display_name_attr = <span style="color:#4070a0">"&lt;your user display name attribute&gt;"</span>

   <span style="color:#60a0b0;font-style:italic">###</span>
   <span style="color:#60a0b0;font-style:italic"># Group Query (search for LDAP group membership for an authenticated user)</span>
   <span style="color:#60a0b0;font-style:italic">###</span>
   <span style="color:#60a0b0;font-style:italic"># The base DN to start the group membership query.</span>
   <span style="color:#60a0b0;font-style:italic"># Chef Automate will use this as the base DN on which to search for LDAP group membership for a specific LDAP user.</span>
   <span style="color:#60a0b0;font-style:italic"># Example: "cn=groups,dc=freeipa,dc=example,dc=com"</span>
   base_group_search_dn = <span style="color:#4070a0">"&lt;your base group search DN&gt;"</span>

   <span style="color:#60a0b0;font-style:italic"># The following two fields are used to match a user to a group.</span>
   <span style="color:#60a0b0;font-style:italic"># If the defaults are used, then you end up with a group membership</span>
   <span style="color:#60a0b0;font-style:italic"># filter of "(&amp;(objectClass=group)(member=&lt;user's DN&gt;))".</span>
   <span style="color:#60a0b0;font-style:italic"># Optional: The LDAP field by which you wish to filter group membership.</span>
   <span style="color:#60a0b0;font-style:italic"># Defaults to "member".</span>
   filter_groups_by_user_attr = <span style="color:#4070a0">"&lt;groups to filter by user attribute&gt;"</span>
   <span style="color:#60a0b0;font-style:italic"># Optional: The LDAP field from the authenticated user you wish to use as input to the above filter.</span>
   <span style="color:#60a0b0;font-style:italic"># Defaults to "DN".</span>
   filter_groups_by_user_value = <span style="color:#4070a0">"&lt;groups to filter by user value&gt;"</span>

   <span style="color:#60a0b0;font-style:italic"># Optional: Additional LDAP filter you can define to further filter group membership results.</span>
   group_query_filter = <span style="color:#4070a0">"&lt;your group query filter&gt;"</span>

   <span style="color:#60a0b0;font-style:italic"># The LDAP field on the group you wish to use as the Chef Automate Team name for the group.</span>
   <span style="color:#60a0b0;font-style:italic"># Defaults to "name".</span>
   group_display_name_attr = <span style="color:#4070a0">"&lt;group display name attribute&gt;"</span>
</code></pre></div>
<h5 id="example-configs">Example Configs</h5> <p>Depending on your directory’s schema, different Group Search settings are required:</p> <p>If your directory looks like this</p> <pre tabindex="0" class="highlight" data-language="ruby"><code class="language-LDIF" data-lang="LDIF">dn: dc=corp,dc=com
objectClass: dcObject
objectClass: organization
o: Example Company
dc: corp

dn: ou=People,dc=corp,dc=com
objectClass: organizationalUnit
ou: People

dn: cn=jane,ou=People,dc=corp,dc=com
objectClass: person
objectClass: inetOrgPerson
sn: doe
cn: jane

dn: cn=john,ou=People,dc=corp,dc=com
objectClass: person
objectClass: inetOrgPerson
sn: doe
cn: john

# Groups
dn: ou=Groups,dc=corp,dc=com
objectClass: organizationalUnit
ou: Groups

dn: cn=admins,ou=Groups,dc=corp,dc=com
objectClass: groupOfNames
cn: admins
member: cn=john,ou=People,dc=corp,dc=com
member: cn=jane,ou=People,dc=corp,dc=com

dn: cn=developers,ou=Groups,dc=corp,dc=com
objectClass: groupOfNames
cn: developers
member: cn=jane,ou=People,dc=corp,dc=com
</code></pre>
<p>then the following would be required:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">base_user_search = <span style="color:#4070a0">"ou=People,dc=corp,dc=com"</span>
username_attr = <span style="color:#4070a0">"cn"</span>
user_id_attr = <span style="color:#4070a0">"cn"</span>
user_display_name_attr = <span style="color:#4070a0">"cn"</span>

base_group_search = <span style="color:#4070a0">"ou=Groups,dc=corp,dc=com"</span>
filter_groups_by_user_value = <span style="color:#4070a0">"DN"</span>
filter_groups_by_user_attr = <span style="color:#4070a0">"member"</span> <span style="color:#60a0b0;font-style:italic"># default</span>
group_display_name_attr = <span style="color:#4070a0">"cn"</span>
</code></pre></div>
<p>However, if your schema looks like this – with no list of members in your group entries:</p> <pre tabindex="0" class="highlight" data-language="ruby"><code class="language-LDIF" data-lang="LDIF">dn: dc=corp,dc=com
objectClass: dcObject
objectClass: organization
o: Example Company
dc: corp

dn: ou=People,dc=corp,dc=com
objectClass: organizationalUnit
ou: People

dn: cn=jane,ou=People,dc=corp,dc=com
objectClass: person
objectClass: inetOrgPerson
sn: doe
cn: jane
departmentNumber: 1000
departmentNumber: 1001

dn: cn=john,ou=People,dc=corp,dc=com
objectClass: person
objectClass: inetOrgPerson
sn: doe
cn: john
departmentNumber: 1000
departmentNumber: 1002

dn: ou=Groups,dc=corp,dc=com
objectClass: organizationalUnit
ou: Groups

dn: cn=admins,ou=Groups,dc=corp,dc=com
objectClass: posixGroup
cn: admins
gidNumber: 1000

dn: cn=developers,ou=Groups,dc=corp,dc=com
objectClass: posixGroup
cn: developers
gidNumber: 1001

dn: cn=designers,ou=Groups,dc=corp,dc=com
objectClass: posixGroup
cn: designers
gidNumber: 1002
</code></pre>
<p>You will need different settings to tie users and groups together:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">base_user_search = <span style="color:#4070a0">"ou=People,dc=corp,dc=com"</span>
username_attr = <span style="color:#4070a0">"cn"</span>
user_id_attr = <span style="color:#4070a0">"cn"</span>
user_display_name_attr = <span style="color:#4070a0">"cn"</span>

base_group_search = <span style="color:#4070a0">"ou=Groups,dc=corp,dc=com"</span>
filter_groups_by_user_value = <span style="color:#4070a0">"departmentNumber"</span>
filter_groups_by_user_attr = <span style="color:#4070a0">"gidNumber"</span>
group_display_name_attr = <span style="color:#4070a0">"cn"</span>
</code></pre></div>
<h3 id="troubleshooting">Troubleshooting</h3> <p>The following section will lay down some indicators to determine which step of the sign in process has failed.</p> <h4 id="troubleshoot-your-connection">Troubleshoot your Connection</h4> <p>If the host or port was wrong, or Chef Automate was not able to reach the LDAP service, the sign in screen will display</p> <blockquote> <p>Internal Server Error</p> <p>Login error.</p> </blockquote> <p>In the logs (<code>journalctl -u chef-automate</code>), you will find a line from <code>automate-dex.default</code> like this – note that for readability, the timestamp and service name has been removed from this example log):</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text">level=error msg="Failed to login user: failed to connect: LDAP Result Code 200 \"\": dial tcp 192.168.33.223:10637: getsockopt: connection refused"
</code></pre></div>
<p>Note that the log contains the <em>IP address</em> even when the LDAP server was configured via hostname. Double-checking that can be helpful to exclude issues in domain-name resolution.</p> <p>Issues in TLS verification manifest in the same way, but the log indicates that:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text">level=error msg="Failed to login user: failed to connect: LDAP Result Code 200 \"\": x509: certificate is valid for localhost, not dex-dev.test"
</code></pre></div>
<h4 id="troubleshoot-bind">Troubleshoot Bind</h4> <p>Issues in bind manifest in the same way (“Internal Server Error”) as Connect issues. However, they differ in what gets logged:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text">level=error msg="Failed to login user: ldap: initial bind for user \"cn=service_account,dc=corp,dc=com\" failed: LDAP Result Code 49 \"Invalid Credentials\": "
</code></pre></div>
<h4 id="troubleshoot-user-search">Troubleshoot User Search</h4> <p>There’s two main ways the user search could fail, and they lead to different sign in failures: One is queries that cannot be executed at all, leading to</p> <blockquote> <p>Internal Server Error</p> <p>Login error.</p> </blockquote> <p>in the browser and a line like</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text">level=info msg="performing ldap search ou=Peoples,dc=example,dc=org sub (cn=jane)"
level=error msg="Failed to login user: ldap: search with filter \"(cn=jane)\" failed: LDAP Result Code 32 \"No Such Object\": "
</code></pre></div>
<p>in the logs.</p> <p>One possible cause (whose logs you see here) is a misconfigured <code>base_user_search_dn</code>.</p> <p>When the user search is executed successfully, but fails to return a useful user record, the browser will show the sign in prompt with an error banner saying</p> <blockquote> <p>Username or password is incorrect.</p> </blockquote> <p>In the logs, you will find more information. There is a line informing you about the actual <em>search</em> query,</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text">level=info msg="performing ldap search ou=People,dc=corp,dc=com sub (cnn=jane)"
</code></pre></div>
<p>together with an entry saying that nothing was returned by the attempted query:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text">level=error msg="ldap: no results returned for filter: \"(cnn=jane)\""
</code></pre></div>
<p>In this example output, the <code>username_attr</code> was set to <code>cnn</code> (not <code>cn</code>).</p> <p>Since there is no way for the LDAP integration to determine whether a configuration was <em>wrong</em> or the provided user does not exist, the sign in UI can only assume that the credentials were invalid.</p> <p>Note that invalid entries for <code>user_query_filter</code> will lead to queries that return no entries, too. Setting</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">user_query_filter = <span style="color:#4070a0">"(objectClass=person)"</span>
</code></pre></div>
<p>will lead to the following logs:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text">level=info msg="performing ldap search ou=People,dc=example,dc=org sub (&amp;(objectClass=person(cn=jane))" connector=LDAP
level=error msg="ldap: no results returned for filter: \"(&amp;(objectClass=person(cn=jane))\"" connector=LDAP
</code></pre></div>
<div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> User search also fails if more than one user is returned. </div> </div> <p>Ensure that a search for <code>username_attr</code> with the given search base can only return one user. Something like this could happen (simplified for demonstration):</p> <pre tabindex="0" class="highlight" data-language="ruby"><code class="language-LDIF" data-lang="LDIF">dn: cn=jane,ou=Denver,ou=People,dc=corp,dc=com
sn: doe
cn: jane
username: jdoe

dn: cn=john,ou=Boston,ou=People,dc=corp,dc=com
sn: doe
cn: john
username: jdoe
</code></pre>
<p>with</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">base_user_search_dn = <span style="color:#4070a0">"ou=People,dc=corp,dc=com"</span>
username_attr = <span style="color:#4070a0">"username"</span>
</code></pre></div>
<p>neither Jane Doe nor her brother could sign in to Chef Automate. There would be a log indicating that multiple users have been returned.</p> <p>This situation would be averted by setting <code>username_attr = "cn"</code>; or by restricting <code>base_user_search_dn</code>, if you only want to allow people from one of either cities to use Chef Automate.</p> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> Attributes that have been configured, but are not found in the results, lead to user search failures, too. Note that this also affects default values. </div> </div> <p>Finally, a successful user search logs a line like the following:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text">level=info msg="username \"jane\" mapped to entry cn=jane,ou=People,dc=corp,dc=com"
</code></pre></div>
<h4 id="troubleshoot-sign-in-bind">Troubleshoot Sign In Bind</h4> <p>Failures in sign in bind that are not caused by invalid credentials will lead to</p> <blockquote> <p>Internal Server Error</p> <p>Login error.</p> </blockquote> <p>accompanied by a log line with more details, starting with <code>Failed to sign in user</code>.</p> <h4 id="troubleshoot-group-search">Troubleshoot Group Search</h4> <p>Failures in retrieving a user’s groups will inhibit their sign in with</p> <blockquote> <p>Internal Server Error</p> <p>Login error.</p> </blockquote> <p>and logs like</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text">level=info msg="performing ldap search ou=Groups,dc=example,dc=org sub (member=cn=jane,ou=People,dc=example,dc=org)"
level=error msg="Failed to login user: ldap: failed to query groups: ldap: search failed: LDAP Result Code 32 \"No Such Object\": "
</code></pre></div>
<p>This, for example, is what you see when the <code>base_group_search_dn</code> does not exist (<code>"ou=Groups,dc=..."</code>).</p> <p>However, contrary to how <em>User Search</em> works, an empty result from <em>Group Search</em> will not inhibit sign in, it will merely not populate the user’s internal record with any groups.</p> <p>A successful sign in causes log entries like the following:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text">level=info msg="performing ldap search ou=People,dc=corp,dc=com sub (cn=jane)"
level=info msg="username \"jane\" mapped to entry cn=jane,ou=People,dc=corp,dc=com"
level=info msg="performing ldap search ou=Groups,dc=corp,dc=com sub (member=cn=jane,ou=People,dc=corp,dc=com)"
level=info msg="login successful: connector \"ldap\", username=\"jane\", email=\"janedoe@example.com\", groups=[\"admins\" \"developers\"]"
</code></pre></div>
<p>and subsequent API authorization request logs containing the user’s <em>subjects</em>:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-text" data-lang="text">level=info msg="Authorization Query" action=search resource="compliance:profiles" result=true subject="[team:ldap:admins team:ldap:developers user:ldap:jane]"
</code></pre></div>
<h4 id="ldapsearch-example-queries">
<code>ldapsearch</code> Example Queries</h4> <p>For debugging purposes it can be useful to execute LDAP queries manually using the <code>ldapsearch</code> utility. On Ubuntu, it is provided via <code>ldap-utils</code> (i.e., <code>sudo apt-get install ldap-utils</code>). In what follows, we will outline an example directory layout, and the <code>ldapsearch</code> queries corresponding to the different phases.</p> <p>The <em>User Search</em> query looks like this, with comments referencing the configurables for LDAP integration:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">ldapsearch -H ldap://ldap-server:636/ <span style="color:#4070a0;font-weight:700">\ </span> <span style="color:#60a0b0;font-style:italic"># host</span>
  -D <span style="color:#bb60d5">cn</span><span style="color:#666">=</span>service_account,dc<span style="color:#666">=</span>corp,dc<span style="color:#666">=</span>com <span style="color:#4070a0;font-weight:700">\ </span><span style="color:#60a0b0;font-style:italic"># bind_dn</span>
  -w admin <span style="color:#4070a0;font-weight:700">\ </span>                            <span style="color:#60a0b0;font-style:italic"># bind_password</span>
  -b <span style="color:#bb60d5">ou</span><span style="color:#666">=</span>People,dc<span style="color:#666">=</span>corp,dc<span style="color:#666">=</span>com <span style="color:#4070a0;font-weight:700">\ </span>         <span style="color:#60a0b0;font-style:italic"># base_user_search_dn</span>
  -s sub <span style="color:#4070a0;font-weight:700">\
</span>  <span style="color:#4070a0">'(cn=jane)'</span>                            <span style="color:#60a0b0;font-style:italic"># (username_attr=what-was-provided-via-sign-in-form)</span>
</code></pre></div>
<p>When using anonymous bind:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">ldapsearch -H ldap://ldap-server:636/ <span style="color:#4070a0;font-weight:700">\ </span><span style="color:#60a0b0;font-style:italic"># host</span>
  -b <span style="color:#bb60d5">ou</span><span style="color:#666">=</span>People,dc<span style="color:#666">=</span>corp,dc<span style="color:#666">=</span>com <span style="color:#4070a0;font-weight:700">\ </span>        <span style="color:#60a0b0;font-style:italic"># base_user_search_dn</span>
  -s sub <span style="color:#4070a0;font-weight:700">\
</span>  <span style="color:#4070a0">'(cn=jane)'</span>                           <span style="color:#60a0b0;font-style:italic"># (username_attr=what-was-provided-via-sign-in-form)</span>
</code></pre></div>
<p>If you have configured a <code>user_query_filter</code>, it is wrapped into the filter argument:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">  <span style="color:#4070a0">'(&amp;(objectClass=person)(cn=jane))'</span>    <span style="color:#60a0b0;font-style:italic"># (&amp;user_query_filter(username_attr=what-was-provided-via-sign-in-form))</span>
</code></pre></div>
<p>Once a user directory entry has been retrieved, the password can be verified, and the group query can be constructed from it:</p> <p>Let us assume we have gotten the entry for user <code>jane</code>:</p> <pre tabindex="0" class="highlight" data-language="ruby"><code class="language-LDIF" data-lang="LDIF"># jane, People, corp.com
dn: cn=jane,ou=People,dc=corp,dc=com
objectClass: person
objectClass: inetOrgPerson
sn: doe
cn: jane
</code></pre>
<p>then the password verification can be simulated by</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">ldapsearch -H ldap://ldap-server:636/ <span style="color:#4070a0;font-weight:700">\ </span><span style="color:#60a0b0;font-style:italic"># host</span>
  -b <span style="color:#bb60d5">cn</span><span style="color:#666">=</span>jane,ou<span style="color:#666">=</span>People,dc<span style="color:#666">=</span>corp,dc<span style="color:#666">=</span>com <span style="color:#4070a0;font-weight:700">\ </span><span style="color:#60a0b0;font-style:italic"># always the entry's DN</span>
  -w janespassword                      <span style="color:#60a0b0;font-style:italic"># as provided via sign in from</span>
</code></pre></div>
<p>where any non-failure result (such as <code>32 No such object</code>) would indicate valid credentials.</p> <p>Finally, the group search query for that user entry looks like</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">ldapsearch -H ldap://ldapserver:636/ <span style="color:#4070a0;font-weight:700">\ </span>       <span style="color:#60a0b0;font-style:italic"># host</span>
  -D <span style="color:#bb60d5">cn</span><span style="color:#666">=</span>service_account,dc<span style="color:#666">=</span>corp,dc<span style="color:#666">=</span>com <span style="color:#4070a0;font-weight:700">\ </span>     <span style="color:#60a0b0;font-style:italic"># bind_dn</span>
  -w admin <span style="color:#4070a0;font-weight:700">\ </span>                                 <span style="color:#60a0b0;font-style:italic"># bind_password</span>
  -b <span style="color:#bb60d5">ou</span><span style="color:#666">=</span>Groups,dc<span style="color:#666">=</span>corp,dc<span style="color:#666">=</span>com <span style="color:#4070a0;font-weight:700">\ </span>              <span style="color:#60a0b0;font-style:italic"># base_group_search_dn</span>
  -s sub <span style="color:#4070a0;font-weight:700">\
</span>  <span style="color:#4070a0">'(member=cn=jane,ou=People,dc=corp,dc=com)'</span> <span style="color:#60a0b0;font-style:italic"># (filter_groups_by_user_attr=[that attr of user entry])</span>
</code></pre></div>
<p>With an additional <code>group_query_filter</code>, the final filter is</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">  <span style="color:#4070a0">'(&amp;(objectClass=group)(member=cn=jane,ou=People,dc=corp,dc=com))'</span> <span style="color:#60a0b0;font-style:italic"># (&amp;group_query_filter(filter_groups_by_user_attr=[...])</span>
</code></pre></div>
<p>Note: if the user entry contains more than one <code>filter_groups_by_user_attr</code> attribute, multiple queries will be executed, and their results combined.</p> <h4 id="other-common-issues">Other Common Issues</h4> <p>If a user, following a sign in through LDAP or SAML, sees a</p> <blockquote> <p>502 Bad Gateway</p> </blockquote> <p>error page, the group information collected for the user exceeds some internal limits.</p> <p>This can have two causes: the user having too many groups, or referencing LDAP groups by distinguished names (DN). The latter can cause little information (e.g. the group name <em>“admins”</em>) to grow out of proportion (e.g. <em>“cn=admins,ou=DeptA,ou=CityB,ou=StateWA,dc=subcorp,dc=corp,dc=com”</em>). This can be mitigated by changing the <code>group_display_name_attr</code> from <code>DN</code> to <code>cn</code> (common name). Note that for authorization purposes, that is also advisable. LDAP-provided groups are referenced in policies using <code>team:ldap:&lt;group-name&gt;</code>. Thus <code>team:ldap:admins</code> is handier than <code>team:ldap:cn=admins,ou=DeptA,ou=CityB,ou=StateWA,dc=subcorp,dc=corp,dc=com</code>.</p> <p>The other cause, having too many groups for a user, can be addressed by using the <code>group_query_filter</code> to restrict the group results (for all users). Anything expressible in an LDAP search query and supported by the LDAP service can be configured there. For example, given a flat list of groups in a directory service like</p> <pre tabindex="0" class="highlight" data-language="ruby"><code class="language-LDIF" data-lang="LDIF">cn=group1,ou=Groups,dc=corp,dc=com
cn=group2,ou=Groups,dc=corp,dc=com
cn=group3,ou=Groups,dc=corp,dc=com
cn=group4,ou=Groups,dc=corp,dc=com
cn=group5,ou=Groups,dc=corp,dc=com
</code></pre>
<p>a <code>group_query_filter</code> of <code>(|(cn=group1)(cn=group2))</code> would restrict the group search results to either one of those groups. Note that this has no implications on which users get authenticated; it only affects the groups recognized by Chef Automate. For example, given users Jane and Jack, where Jane is a member of <code>group1</code> and <code>group3</code>, and Jack of <code>group3</code> and <code>group4</code>: Jane’s groups would resolve to <code>group1</code> only, and Jack would have no groups – but still be able to access Chef Automate. In a similar manner, selected groups could be excluded from the results explicitly, by using a filter like <code>(!cn=group2)</code></p> <p>Given a more structured directory service layout, including multiple trees of groups, further options become possible: Assuming the layout is like</p> <pre tabindex="0" class="highlight" data-language="ruby"><code class="language-LDIF" data-lang="LDIF">cn=group1,ou=AGroups,dc=corp,dc=com
cn=group2,ou=AGroups,dc=corp,dc=com
cn=group3,ou=BGroups,dc=corp,dc=com
cn=group4,ou=BGroups,dc=corp,dc=com
cn=group5,ou=CGroups,dc=corp,dc=com
</code></pre>
<p>you can use your directory server’s query capabilities to restrict the results to a subtree. The concrete details depend on the product in use; for example in servers supporting <em>extensible match</em>, all group entries below <code>AGroups</code> and <code>BGroups</code> could be retrieved using a <code>group_query_filter</code> of <code>(|(ou:dn:=AGroups)(ou:dn:=BGroups))</code>.</p> <p>See <a href="http://ldapwiki.com/wiki/ExtensibleMatch">LDAP Wiki Extensible Match Search Filter</a> for details.</p> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/automate/ldap/" class="_attribution-link">https://docs.chef.io/automate/ldap/</a>
  </p>
</div>
