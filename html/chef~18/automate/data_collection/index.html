<div id="col-content" data-swiftype-index="true"> <div id="data-collection"><h1>Data Collection</h1></div>  <div class="prose"> <p data-swiftype-index="false"> <a href="https://github.com/chef/automate/blob/master/components/docs-chef-io/content/automate/data_collection.md" alt="Link to page on GitHub repository">[edit on GitHub]</a> </p> <h1 id="audit-cookbook--inspec--automate-2-versions-support-matrix">Audit Cookbook + InSpec + Automate 2 Versions Support Matrix</h1> <p>Refer to the <a href="https://github.com/chef-cookbooks/audit#chef-automate">following Supported Versions list</a> to confirm a full set of working versions for your chef-client, Audit cookbook, InSpec, and Automate 2. When these do not match up, ingestion problems can occur because the messages will not show up in the expected format.</p> <h1 id="node-run-and-audit-data-collection">Node Run and Audit Data Collection</h1> <p>Nodes can send their run data to Chef Automate. There are two steps to getting data collection running in Chef Automate:</p> <ol> <li> <p>You must first have an API token. You have two options:</p> <ul> <li>
<a href="../api_tokens/index.html#creating-api-tokens">Create a new API token</a> and add the API token to the Ingest policy, preferably at time of creation.</li> <li>Or you can <a href="#existing-data-collector-token-setup">use your existing data collector token</a> if you are migrating from Chef Automate 1.</li> </ul> </li> <li> <p>Once you have an API token, you can either:</p> <ul> <li>
<a href="#configure-your-chef-infra-server-to-send-data-to-chef-automate">Configure your Chef Infra Server to point to Chef Automate</a>. <strong>If you are using Chef Infra Server, this is the recommended method of sending data to Chef Automate.</strong>
</li> <li>Or, you can have <a href="#configure-your-chef-client-to-send-data-to-chef-automate-without-chef-server">Chef Infra Client send the data directly to Chef Automate</a>.</li> </ul> </li> </ol> <h2 id="existing-data-collector-token-setup">Set Up an Existing Chef Automate 1 Data Collector Token in Chef Automate 2</h2> <h3 id="porting-the-existing-chef-automate-1-data-collector-token-to-chef-automate-2">Porting the Existing Chef Automate 1 Data Collector Token to Chef Automate 2</h3> <p>If you are migrating from Chef Automate 1, you probably have already deployed a data collector token on either your Chef Infra Servers or your Chef Infra Clients. To re-use your existing data collector token from your Chef Automate 1 installation, you need to perform the configuration change outlined here.</p> <p>For this process, you need the existing token (let’s call it <code>A1_DC_TOKEN</code>), and access to the machine running the <code>chef-automate</code> CLI client.</p> <p>Create a file (in this example, <code>data-collector-token.toml</code>) containing your existing token:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">[auth_n.v1.sys.service]
a1_data_collector_token = <span style="color:#4070a0">"&lt;A1_DC_TOKEN&gt;"</span>
</code></pre></div>
<p>Now apply that configuration to your Chef Automate 2 deployment:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-bash" data-lang="bash"><span style="color:#60a0b0;font-style:italic"># chef-automate config patch data-collector-token.toml</span>

<span style="color:#666">[</span>...output omitted...<span style="color:#666">]</span>

Success: Configuration patched
</code></pre></div>
<p>The system will notice that configuration change after a short interval. From that point on, requests using the <code>x-data-collector-token: &lt;A1_DC_TOKEN&gt;</code> header will be accepted. When logged in with admin permissions, you will also find your added token in <code>https://automate.example.com/admin/tokens</code>, under the name</p> <blockquote> <p>Legacy data collector token ported from A1</p> </blockquote> <p>Now that you have a valid API token, you’ll need to <a href="#configure-your-chef-infra-server-to-send-data-to-chef-automate">update your Chef Infra Server data collector configuration</a> if you are using a Chef Infra Server. Otherwise, you must <a href="#configure-your-chef-client-to-send-data-to-chef-automate-without-chef-server">configure your Chef Infra Clients to send data directly to Chef Automate</a>.</p> <h2 id="configure-your-chef-infra-server-to-send-data-to-chef-automate">Configure your Chef Infra Server to Send Data to Chef Automate</h2> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> Multiple Chef Infra Servers can send data to a single Chef Automate server. </div> </div> <p>In addition to forwarding Chef run data to Chef Automate, Chef Infra Server will send messages to Chef Automate whenever an action is taken on a Chef Infra Server object, such as when a cookbook is uploaded to the Chef Infra Server or when a user edits a role.</p> <p>In order to have Chef Infra Server send run data from connected Chef Infra Clients, set the data collection proxy attribute to <code>true</code>.</p> <h3 id="setting-up-data-collection-on-chef-infra-server-deployed-with-the-chef-automate-installer">Setting Up Data Collection on Chef Infra Server Deployed with the Chef Automate Installer</h3> <p>This step sets up data collection from a standalone Chef Infra Server deployed with the Chef Automate Installer to a separate Chef Automate server.</p> <p>Open the <code>config.toml</code> file and include the external automate configuration settings:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-toml" data-lang="toml">[global.v1.external.automate]
  enable = <span style="color:#007020;font-weight:700">true</span>
  node = <span style="color:#4070a0">"https://&lt;automate server url&gt;"</span>
[global.v1.external.automate.auth]
  token = <span style="color:#4070a0">"&lt;data-collector token&gt;"</span>
[global.v1.external.automate.ssl]
  server_name = <span style="color:#4070a0">"&lt;server name from the automate server ssl cert&gt;"</span>
  root_cert = <span style="color:#4070a0">"""&lt;pem format root CA cert&gt;
</span><span style="color:#4070a0">"""</span>
[auth_n.v1.sys.service]
  a1_data_collector_token = <span style="color:#4070a0">"&lt;data-collector token&gt;"</span>
[erchef.v1.sys.data_collector]
   enabled = <span style="color:#007020;font-weight:700">true</span>
</code></pre></div>
<p>Then, run <code>chef-automate config patch config.toml</code>.</p> <h3 id="setting-up-data-collection-on-chef-infra-server-versions-1214-and-higher">Setting Up Data Collection on Chef Infra Server Versions 12.14 and Higher</h3> <p>Instead of setting the token directly in <code>/etc/opscode/chef-server.rb</code> as was done in older versions of the Chef Infra Server, we’ll use the <code>set-secret</code> command, so that your API token does not live in plaintext in a file:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">sudo chef-server-ctl set-secret data_collector token <span style="color:#4070a0">'&lt;API_TOKEN_FROM_STEP_1&gt;'</span>
sudo chef-server-ctl restart nginx
sudo chef-server-ctl restart opscode-erchef
</code></pre></div>
<p>Next, configure the Chef Infra Server for data collection forwarding by adding the following setting to <code>/etc/opscode/chef-server.rb</code>:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">data_collector<span style="color:#666">[</span><span style="color:#4070a0">'root_url'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'https://automate.example.com/data-collector/v0/'</span>
<span style="color:#60a0b0;font-style:italic"># Add for Chef Infra Client run forwarding</span>
data_collector<span style="color:#666">[</span><span style="color:#4070a0">'proxy'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#007020">true</span>
<span style="color:#60a0b0;font-style:italic"># Add for compliance scanning</span>
profiles<span style="color:#666">[</span><span style="color:#4070a0">'root_url'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'https://automate.example.com'</span>
<span style="color:#60a0b0;font-style:italic"># Save and close the file</span>
</code></pre></div>
<p>To apply the changes, run:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">sudo chef-server-ctl reconfigure
</code></pre></div>
<h3 id="setting-up-chef-infra-client-to-send-compliance-scan-data-through-the-chef-infra-server-to-chef-automate">Setting Up Chef Infra Client to Send Compliance Scan Data Through the Chef Infra Server to Chef Automate</h3> <p>Now that the Chef Infra Server is configured for data collection, you can also enable Compliance Scanning</p> <p>on your Chef Infra Clients via the <a href="https://github.com/chef-cookbooks/audit">Audit Cookbook</a>.</p> <ul> <li>Set the following attributes for the audit cookbook:</li> </ul> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'reporter'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'chef-server-automate'</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'fetcher'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'chef-server'</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'profiles'</span><span style="color:#666">].</span>push(
  <span style="color:#4070a0">'name'</span>: <span style="color:#4070a0">'cis-centos7-level2'</span>,
  <span style="color:#4070a0">'compliance'</span>: <span style="color:#4070a0">'user-name/cis-centos7-level2'</span> <span style="color:#60a0b0;font-style:italic"># in the ui for automate, this value is the identifier for the profile</span>
)
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'interval'</span><span style="color:#666">]</span> <span style="color:#666">=</span> {
  <span style="color:#4070a0">'enabled'</span>: <span style="color:#007020">true</span>
  <span style="color:#4070a0">'time'</span>: <span style="color:#40a070">1440</span>  <span style="color:#60a0b0;font-style:italic"># once a day, the default value</span>
}
</code></pre></div>
<p>Now, any node with <code>audit::default</code> its runlist will fetch and report data to and from Chef Automate via the Chef Infra Server. Please see the audit cookbook for an <a href="https://github.com/chef-cookbooks/audit">exhaustive list of configuration options</a>.</p> <h3 id="additional-chef-infra-server-data-collection-configuration-options">Additional Chef Infra Server Data Collection Configuration Options</h3> <table> <thead> <tr> <th>Option</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr> <td><code>data_collector['proxy']</code></td> <td>If set to true, Chef Infra Server will proxy all requests sent to /data-collector to the configured Chef Automate <code>data_collector['root_url']</code>. Note that this route does not check the request signature and add the right data_collector token, but just proxies the Chef Automate endpoint as-is.</td> <td>Default: <code>nil</code>
</td> </tr> <tr> <td><code>data_collector['timeout']</code></td> <td>Timeout in milliseconds to abort an attempt to send a message to the Chef Automate server.</td> <td>Default: <code>30000</code>
</td> </tr> <tr> <td><code>data_collector['http_init_count']</code></td> <td>Number of Chef Automate HTTP workers Chef Infra Server should start.</td> <td>Default: <code>25</code>
</td> </tr> <tr> <td><code>data_collector['http_max_count']</code></td> <td>Maximum number of Chef Automate HTTP workers Chef Infra Server should allow to exist at any time.</td> <td>Default: <code>100</code>
</td> </tr> <tr> <td><code>data_collector['http_max_age']</code></td> <td>Maximum age a Chef Automate HTTP worker should be allowed to live, specified as an Erlang tuple.</td> <td>Default: <code>{70, sec}</code>
</td> </tr> <tr> <td><code>data_collector['http_cull_interval']</code></td> <td>How often Chef Infra Server should cull aged-out Chef Automate HTTP workers that have exceeded their <code>http_max_age</code>, specified as an Erlang tuple.</td> <td>Default: <code>{1, min}</code>
</td> </tr> <tr> <td><code>data_collector['http_max_connection_duration']</code></td> <td>Maximum duration an HTTP connection is allowed to exist before it is terminated, specified as an Erlang tuple.</td> <td>Default: <code>{70, sec}</code>
</td> </tr> </tbody> </table> <h2 id="configure-your-chef-infra-client-to-send-data-to-chef-automate-without-chef-infra-server">Configure your Chef Infra Client to Send Data to Chef Automate without Chef Infra Server</h2> <p>If you do not use a Chef Infra Server in your environment (if you only use <code>chef-solo</code>, for example), you</p> <p>can configure your Chef Infra Clients to send their run data to Chef Automate directly by performing the following:</p> <ol> <li> <p>Add Chef Automate SSL certificate to <code>trusted_certs</code> directory.</p> </li> <li> <p>Configure Chef Infra Client to use the Data Collector endpoint and API token in Chef Automate.</p> </li> </ol> <h3 id="add-chef-automate-certificate-to-trusted_certs-directory">Add Chef Automate certificate to <code>trusted_certs</code> directory</h3> <p><strong>Note:</strong> This step only applies to self-signed SSL certificates. If you are using an SSL certificate signed by a valid certificate authority, you may skip this step.</p> <p>Chef requires that the self-signed Chef Automate SSL certificate (<code>HOSTNAME.crt</code>) is located in the <code>/etc/chef/trusted_certs</code> directory on any node that wants to send data to Chef Automate. This directory is the location into which SSL certificates are placed when a node has been bootstrapped with chef-client.</p> <p>To fetch the certificate onto your workstation, use <code>knife ssl fetch</code> and pass in the URL of the Chef Automate server. You can then use utilities such as <code>scp</code> or <code>rsync</code> to copy the downloaded cert files from your <code>.chef/trusted_certs</code> directory to the <code>/etc/chef/trusted_certs</code> directory on the nodes in your infrastructure that will be sending data directly to the Chef Automate server.</p> <h3 id="configure-chef-infra-client-to-use-the-data-collector-endpoint-in-chef-automate">Configure Chef Infra Client to Use the Data Collector Endpoint in Chef Automate</h3> <div class="admonition-warning"> <p class="admonition-warning-title">Warning</p> <div class="admonition-warning-text"> Chef version 12.12.15 or greater is required. </div> </div> <p>The data collector functionality is used by the Chef Infra Client to send node and converge data to Chef Automate. This feature works for Chef Infra Client, as well as both the default and legacy modes of <code>chef-solo</code>.</p> <p>To send node, converge, and compliance data to Chef Automate, modify your Chef config (that is <code>client.rb</code>, <code>solo.rb</code>, or add an additional config file in an appropriate directory, such as <code>client.d</code>) to contain the following configuration:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">data_collector<span style="color:#666">.</span>server_url <span style="color:#4070a0">"https://automate.example.com/data-collector/v0/"</span>
data_collector<span style="color:#666">.</span>token <span style="color:#4070a0">'&lt;API_TOKEN_FROM_STEP_1&gt;'</span>
</code></pre></div>
<h3 id="setting-up-chef-infra-client-to-send-compliance-scan-data-directly-to-chef-automate">Setting Up Chef Infra Client to Send Compliance Scan Data Directly to Chef Automate</h3> <p>Now that the Chef Infra Client is configured for data collection, you can also enable Compliance Scanning on via the <a href="https://github.com/chef-cookbooks/audit">Audit Cookbook</a>.</p> <ul> <li>Set the following attributes for the audit cookbook:</li> </ul> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-ruby" data-lang="ruby">default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'reporter'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'chef-automate'</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'fetcher'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'chef-automate'</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'token'</span><span style="color:#666">]</span> <span style="color:#666">=</span> <span style="color:#4070a0">'&lt;API_TOKEN_FROM_STEP_1&gt;'</span>
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'profiles'</span><span style="color:#666">].</span>push(
  <span style="color:#4070a0">'name'</span>: <span style="color:#4070a0">'cis-centos7-level2'</span>,
  <span style="color:#4070a0">'compliance'</span>: <span style="color:#4070a0">'user-name/cis-centos7-level2'</span> <span style="color:#60a0b0;font-style:italic"># in the ui for automate, this value is the identifier for the profile</span>
)
default<span style="color:#666">[</span><span style="color:#4070a0">'audit'</span><span style="color:#666">][</span><span style="color:#4070a0">'interval'</span><span style="color:#666">]</span> <span style="color:#666">=</span> {
  <span style="color:#4070a0">'enabled'</span>: <span style="color:#007020">true</span>
  <span style="color:#4070a0">'time'</span>: <span style="color:#40a070">1440</span>  <span style="color:#60a0b0;font-style:italic"># once a day, the default value</span>
}
</code></pre></div>
<p>Now, any node with <code>audit::default</code> its runlist will fetch and report data directly to and from Chef Automate. Please see the audit cookbook for an <a href="https://github.com/chef-cookbooks/audit">exhaustive list of configuration options</a>.</p> <h4 id="additional-chef-infra-client-data-collection-configuration-options">Additional Chef Infra Client Data Collection Configuration Options</h4> <table> <thead> <tr> <th>Configuration</th> <th>Description</th> <th>Options</th> <th>Default</th> </tr> </thead> <tbody> <tr> <td><code>data_collector.mode</code></td> <td>The mode in which the data collector is allowed to operate. This can be used to run data collector only when running as Chef solo but not when using Chef Infra Client.</td> <td>
<code>:solo</code>, <code>:client</code>, or <code>:both</code>
</td> <td><code>:both</code></td> </tr> <tr> <td><code>data_collector.raise_on_failure</code></td> <td>When the data collector cannot send the “starting a run” message to the data collector server, the data collector will be disabled for that run. In some situations, such as highly-regulated environments, it may be more reasonable to Prevents data collection when the data collector cannot send the “starting a run” message to the data collector server. In these situations, setting this value to <code>true</code> will cause the Chef run to raise an exception before starting any converge activities.</td> <td>
<code>true</code>, <code>false</code>
</td> <td><code>false</code></td> </tr> <tr> <td><code>data_collector.organization</code></td> <td>A user-supplied organization string that can be sent in payloads generated by the data collector when Chef is run in Solo mode. This allows users to associate their Solo nodes with faux organizations without the nodes being connected to an actual Chef Infra Server.</td> <td><code>string</code></td> <td><code>none</code></td> </tr> </tbody> </table> <h2 id="troubleshooting-my-data-does-not-show-up-in-the-user-interface">Troubleshooting: My Data Does Not Show Up in the User Interface</h2> <p>Organizations without associated nodes will not show up on the Chef Automate <em>Nodes</em> page. A node is not associated with Automate until a Chef Infra Client run has completed. This is also true for roles, cookbooks, recipes, attributes, resources, node names, and environments but does not highlight them in the UI. This is designed to keep the UI focused on the nodes in your cluster.</p> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/automate/data_collection/" class="_attribution-link">https://docs.chef.io/automate/data_collection/</a>
  </p>
</div>
