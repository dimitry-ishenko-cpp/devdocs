<div id="col-content" data-swiftype-index="true"> <div id="enrolling-the-devices"><h1>Enrolling the devices</h1></div>  <div class="prose"> <div class="admonition-note"> <p class="admonition-note-title">Note</p> <div class="admonition-note-text"> The application management documentation for Chef Desktop is under active development. Check back for upcoming enhancements and improvements. </div> </div> <h2 id="introduction">Introduction</h2> <p>The Chef Desktop management pattern allows you to manage all your macOS devices using a MicroMDM server for a fully automated experience.</p> <p>If you have not done so, read <a href="../../desktop_pattern/index.html">The Chef Desktop Development Pattern</a> to familiarize yourself with some of the basic steps for getting started. We will repeat a number of those steps here.</p> <h2 id="overview">Overview</h2> <p>This document describes how to set up the following things:</p> <ul> <li>Install Chef Infra Server and Chef Automate</li> <li>Build your local repo and test Chef Desktop</li> <li>Build the InstallApplications package.</li> <li>Build the MDM server</li> <li>Build and deploy Munki to deploy apps to the laptops</li> </ul> <h2 id="setting-up-the-mdm">Setting up the MDM</h2> <p>We need a Mobile Device Management (MDM) service to capture macOS machines as they boot, and to securely connect and push applications and configuration settings to them. In this document we use MicroMDM, but there are others on the market like VMware Airwatch, SimpleMDM, and others.</p> <p>Your configuration and setup may begin like this:</p> <ol> <li> <p>Stand up a new Linux instance in Azure or AWS and ensure that you use SSH keys for authentication rather than passwords.</p> </li> <li> <p>Once the instance is running, upgrade the installed packages:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-powershell" data-lang="powershell">sudo <span style="color:#007020">apt-get</span> update &amp;&amp; sudo <span style="color:#007020">apt-get</span> upgrade -y
sudo reboot
</code></pre></div>
</li> <li> <p>Create a micromdm directory on the drive.</p> </li> <li> <p>Clone MicroMDM from Github:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-powershell" data-lang="powershell"><span style="color:#007020">curl </span>-L https<span>:</span>//github.com/micromdm/micromdm/releases/download/v1.6.0/micromdm_v1.6.0.zip
</code></pre></div>
</li> <li> <p>Open a terminal window on the Linux box.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-powershell" data-lang="powershell">sudo <span style="color:#007020">apt-get</span> install unzip
unzip micromdm_v1.6.0.zip
<span style="color:#007020">cd </span>/micromdm/build/linux
./mdmctl config <span style="color:#007020">set </span>-name &lt;some name&gt; -api-token &lt;password&gt; -server-url https<span>:</span>//somefqdn
</code></pre></div>
<p>Where:</p> <dl> <dt><code>-name</code></dt> <dd>is the label you choose to identify your MicroMDM server</dd> <dt><code>-api-token</code></dt> <dd>is a password you will use to connect to your server to configure it</dd> <dt><code>-server-url</code></dt> <dd>is the publicly accessible IP or FQDN of your created server</dd> </dl> </li> <li> <p>Start the MDM and note the password you use. You will need this password with <code>mdmctl</code> to configure the server.</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-powershell" data-lang="powershell">sudo ./micromdm serve -server-url https<span>:</span>//somefqdn/ -api-key &lt;password&gt;
</code></pre></div>
</li> <li> <p>There are three important certificates on your MDM server:</p> <ul> <li>A TLS capable certificate that allows you to connect to your MDM server via port 443.</li> <li>An APNS certificate, which is a Push certificate, that allows your MDM server to talk to your macOS clients.</li> <li>A DEP certificate that allows your MDM server to talk to deploy.apple.com and accept incoming boot requests from Appleâ€™s servers.</li> </ul> </li> </ol> <h3 id="securing-the-mdm">Securing the MDM</h3> <p>Read this <a href="https://github.com/micromdm/micromdm/blob/main/docs/user-guide/quickstart.md">guide</a> which describes the steps necessary to create both the DEP and APNS certificates that you need for your MicroMDM server.</p> <h2 id="initial-app-deployment-to-a-node">Initial App Deployment to a Node</h2> <p><code>InstallApplication</code> is a stage in the Apple setup process that occurs between the time the display shows up for the user and when the user reaches the desktop for the first time.</p> <p><a href="https://github.com/macadmins/installapplications">InstallApplications</a> (plural) is a corresponding application that will install applications or settings during that stage of configuration.</p> <ol> <li> <p>Start by loading these apps on your macOS machines:</p> <ul> <li> <p>The current release of Chef Infra Client</p> </li> <li> <p>DepNotify</p> <p><a href="https://gitlab.com/Mactroll/DEPNotify">Depnotify</a> is an open source tool that tells users how much more time their macOS machine needs to install applications before they can starting using it.</p> </li> <li> <p>Caffeinate</p> <p><a href="https://ss64.com/osx/caffeinate.html">Caffeinate</a> keeps the desktop active so that the screensaver does not turn on during installation. The screensaver will turn off network connections and break the setup if it activates.</p> </li> <li> <p><a href="../../../install_bootstrap/index.html">Chef Bootstrap</a></p> <p>The last thing we pull down is a python script to configure the <code>chef/client.rb</code> file and run <code>chef-client</code> the first time to configure the laptop to its desired state and keep it in that state.</p> </li> </ul> </li> <li> <p>Install the latest version of <a href="https://github.com/macadmins/installapplications">InstallApplications</a>.</p> </li> <li> <p>Modify the LaunchDaemon plist to look like the <a href="#example-munki-catalog">first example</a> below. Notice that we updated the JSONUrl and a couple of the identity sections. Also notice that we enabled some of the commands needed to properly populate DepNotify so it displays useful information to the user.</p> </li> <li> <p>Modify the build-info.json file on the identity line to correctly reference your developer certificate. Read the <a href="https://github.com/erikng/installapplications/wiki/Packaging">InstallApplications documentation</a> for information about the type of accounts that Apple requires to install packages.</p> </li> <li> <p>Use <code>munkipkg</code> to create the actual pkg file. See the <a href="https://github.com/munki/munki-pkg">munkipkg documentation</a> for instructions.</p> </li> <li> <p>Upload the compiled package to your MDM server.</p> </li> <li> <p>Issue the following commands on your MDM:</p> <div class="highlight"><pre tabindex="0" class="highlight" data-language="ruby"><code class="language-shell" data-lang="shell">~/mdm/build/linux/mdmctl apply app -pkg ~/Desktop/mdmvid/InstallApplications.pkg -sign <span style="color:#4070a0">"Developer ID Installer: groob (myid)"</span> -upload

<span style="color:#666">[</span>WARNING<span style="color:#666">]</span> package signing only implemented on macOS. An unsigned macOS package will not install with MDM.
</code></pre></div>
</li> <li> <p>In the example above, the developer ID should match the one you specify in the <code>build-info</code> file below.</p> </li> </ol> <h2 id="signing-your-apps">Signing Your Apps</h2> <p>Sign and/or notarize everything that the MDM server touches.</p> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef&trade; Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs.chef.io/desktop/zero_touch/macos/" class="_attribution-link">https://docs.chef.io/desktop/zero_touch/macos/</a>
  </p>
</div>
