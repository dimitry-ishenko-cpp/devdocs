<h1>Content Security Policy</h1>
<div class="section-content">
<p>Extensions developed with WebExtension APIs have a Content Security Policy (CSP) applied to them by default. This restricts the sources from which they can load code such as <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script">&lt;script&gt;</a> and disallows potentially unsafe practices such as using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval"><code>eval()</code></a>. This article briefly explains what a CSP is, what the default policy is and what it means for an extension, and how an extension can change the default CSP.</p> <p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">Content Security Policy</a> (CSP) is a mechanism to help prevent websites from inadvertently executing malicious content. A website specifies a CSP using an HTTP header sent from the server. The CSP is mostly concerned with specifying legitimate sources of various types of content, such as scripts or embedded plugins. For example, a website can use it to specify that the browser should only execute JavaScript served from the website itself, and not from any other sources. A CSP can also instruct the browser to disallow potentially unsafe practices, such as the use of <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval"><code>eval()</code></a>.</p> <p>Like websites, extensions can load content from different sources. For example, a browser action's popup is specified as an HTML document, and it can include JavaScript and CSS from different sources, just like a normal web page:</p> <div class="code-example"><pre data-language="html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--Some HTML content here--&gt;</span>
    <span class="token comment">&lt;!--
      Include a third-party script.
      See also https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity.
    --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span>
      <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://code.jquery.com/jquery-2.2.4.js<span class="token punctuation">"</span></span>
      <span class="token attr-name">integrity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sha256-iT6Q9iMJYuQiMWNd9lDyBUStIq/8PuOW33aOqmvFpqI=<span class="token punctuation">"</span></span>
      <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Include my popup's own script--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>popup.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</pre></div> <p>Compared to a website, extensions have access to additional privileged APIs, so if they are compromised by malicious code, the risks are greater. For this reason:</p> <ul> <li>a fairly strict content security policy is applied to extensions by default. See <a href="#default_content_security_policy">default content security policy</a>.</li> <li>the extension's author can change the default policy using the <code>content_security_policy</code> manifest.json key, but there are restrictions on the policies that are allowed. See <a href="manifest.json/content_security_policy.html"><code>content_security_policy</code></a>.</li> </ul>
</div>
<section aria-labelledby="default_content_security_policy"><h2 id="default_content_security_policy">Default content security policy</h2>
<div class="section-content">
<p>The default content security policy for extensions using Manifest V2 is:</p> <pre class="notranslate">"script-src 'self'; object-src 'self';"
</pre> <p>While for extensions using Manifest V3, the default content security policy is:</p> <pre class="notranslate">"script-src 'self'; upgrade-insecure-requests;"
</pre> <p>These policies are applied to any extension that has not explicitly set its own content security policy using the <a href="manifest.json/content_security_policy.html"><code>content_security_policy</code></a> manifest.json key. It has the following consequences:</p> <ul> <li><a href="#location_of_script_and_object_resources">You may only load &lt;script&gt; and &lt;object&gt; resources that are local to the extension.</a></li> <li><a href="#eval_and_friends">The extension is not allowed to evaluate strings as JavaScript.</a></li> <li><a href="#inline_javascript">Inline JavaScript is not executed.</a></li> <li><a href="#webassembly">WebAssembly cannot be used by default.</a></li> <li><a href="#upgrade_insecure_network_requests_in_manifest_v3">Insecure network requests are upgraded in Manifest V3.</a></li> </ul>
</div></section><section aria-labelledby="location_of_script_and_object_resources"><h3 id="location_of_script_and_object_resources">Location of script and object resources</h3>
<div class="section-content">
<p>Under the default CSP, you can only load code that is local to the extension. The CSP limits <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src"><code>script-src</code></a> to secure sources only, which covers <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script">&lt;script&gt;</a> resources, <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules">ES6 modules</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers">web workers</a>. In browsers that support obsolete <a href="https://developer.mozilla.org/en-US/docs/Glossary/Plugin">plugins</a>, the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/object-src"><code>object-src</code></a> directive is also restricted. For more information on object-src in extensions, see the WECG issue <a href="https://github.com/w3c/webextensions/issues/204" target="_blank">Remove object-src from the CSP (at least in MV3)</a>).</p> <p>For example, consider a line like this in an extension's document:</p> <div class="code-example"><pre data-language="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://code.jquery.com/jquery-2.2.4.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</pre></div> <p>This doesn't load the requested resource: it fails silently, and any object that you expect to be present from the resource is not found. There are two main solutions to this:</p> <ul> <li>download the resource, package it in your extension, and refer to this version of the resource.</li> <li>allow the remote origin you need using the <a href="manifest.json/content_security_policy.html"><code>content_security_policy</code></a> key or, in Manifest V3, the <code>content_scripts</code> property.</li> </ul>
</div></section><section aria-labelledby="eval_and_friends"><h3 id="eval_and_friends">eval() and friends</h3>
<div class="section-content">
<p>Under the default CSP, extensions cannot evaluate strings as JavaScript. This means that the following are not permitted:</p> <div class="code-example"><pre data-language="js"><span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"console.log('some output');"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre></div> <div class="code-example"><pre data-language="js"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token string">"alert('Hello World!');"</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre></div> <div class="code-example"><pre data-language="js"><span class="token keyword">const</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">"console.log('foo');"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre></div>
</div></section><section aria-labelledby="inline_javascript"><h3 id="inline_javascript">Inline JavaScript</h3>
<div class="section-content">
<p>Under the default CSP, inline JavaScript is not executed. This disallows both JavaScript placed directly in <code>&lt;script&gt;</code> tags and inline event handlers, meaning that the following are not permitted:</p> <div class="code-example"><pre data-language="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</pre></div> <div class="code-example"><pre data-language="html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>Click me!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</pre></div> <p>If you are currently using code like <code>&lt;body onload="main()"&gt;</code> to run your script when the page has loaded, listen for <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/DOMContentLoaded_event">DOMContentLoaded</a> or <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/load_event">load</a> instead.</p>
</div></section><section aria-labelledby="webassembly"><h3 id="webassembly">WebAssembly</h3>
<div class="section-content">
<p>Extensions wishing to use <a href="https://developer.mozilla.org/en-US/docs/WebAssembly">WebAssembly</a> require <code>'wasm-unsafe-eval'</code> to be specified in the <code>script-src</code> directive.</p> <p>From Firefox 102 and Chrome 103, <code>'wasm-unsafe-eval'</code> can be included in the <a href="manifest.json/content_security_policy.html"><code>content_security_policy</code></a> manifest.json key to enable the use of WebAssembly in extensions.</p> <p>Manifest V2 extensions in Firefox can use WebAssembly without <code>'wasm-unsafe-eval'</code> in their CSP for backward compatibility. However, this behavior isn't guaranteed, see <a href="https://bugzil.la/1770909" target="_blank">Firefox bug 1770909</a>. Extensions using WebAssembly are therefore encouraged to declare <code>'wasm-unsafe-eval'</code> in their CSP.</p> <p>For Chrome, extensions cannot use WebAssembly in version 101 or earlier. In 102, extensions can use WebAssembly (the same behavior as Firefox 101 and earlier). From version 103, extensions can use WebAssembly if they include <code>'wasm-unsafe-eval'</code> in the <code>content_security_policy</code> in the manifest key.</p>
</div></section><section aria-labelledby="upgrade_insecure_network_requests_in_manifest_v3"><h3 id="upgrade_insecure_network_requests_in_manifest_v3">Upgrade insecure network requests in Manifest V3</h3>
<div class="section-content">
<p>Extensions should use <code>https:</code> and <code>wss:</code> when communicating with external servers. To encourage this as the standard behavior, the default Manifest V3 CSP includes the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/upgrade-insecure-requests"><code>upgrade-insecure-requests</code></a> directive. This directive automatically upgrades network requests to <code>http:</code> to use <code>https:</code>.</p> <p>While requests are automatically updated, it is still recommended to use <code>https:</code>-URLs in the extension's source code where possible. In particular, entries in the <a href="manifest.json/host_permissions.html"><code>host_permissions</code> section of manifest.json</a> should start with <code>https://</code> or <code>*://</code> instead of only <code>http://</code>.</p> <p>Manifest V3 Extensions that need to make <code>http:</code> or <code>ws:</code> requests can opt out of this behavior by overriding the default CSP using the <a href="manifest.json/content_security_policy.html"><code>content_security_policy</code></a> manifest.json key with a policy that excludes the <code>upgrade-insecure-requests</code> directive. However, to comply with the <a href="https://extensionworkshop.com/documentation/publish/add-on-policies/#security-compliance-and-blocking" target="_blank">security requirements</a> of the Add-on Policies, all user data must be transmitted securely.</p>
</div></section><section aria-labelledby="csp_for_content_scripts"><h2 id="csp_for_content_scripts">CSP for content scripts</h2>
<div class="section-content">
<p> In Manifest V2, content scripts have no CSP. As of Manifest V3, content scripts share the default CSP as extensions. It is currently not possible to specify a separate CSP for content scripts (<a href="https://bugzil.la/1581611#c10" target="_blank">source</a>). </p> <p> The extent to which the CSP controls loads from content scripts varies by browser. In Firefox, JavaScript features such as eval are restricted by the extension CSP. Generally, most DOM-based APIs are subjected to the CSP of the web page. In Chrome, many DOM APIs are covered by the extension CSP instead of the web page's CSP (<a href="https://crbug.com/896041" target="_blank">crbug 896041</a>). </p>
</div></section><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2005&ndash;2023 MDN contributors.<br>Licensed under the Creative Commons Attribution-ShareAlike License v2.5 or later.<br>
    <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_Security_Policy" class="_attribution-link">https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_Security_Policy</a>
  </p>
</div>
