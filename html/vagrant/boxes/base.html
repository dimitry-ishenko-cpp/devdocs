<h1 id="creating-a-base-box">  Creating a Base Box </h1> <p>There are a special category of boxes known as "base boxes." These boxes contain the bare minimum required for Vagrant to function, are generally not made by repackaging an existing Vagrant environment (hence the "base" in the "base box").</p> <p>For example, the Ubuntu boxes provided by the Vagrant project (such as "precise64") are base boxes. They were created from a minimal Ubuntu install from an ISO, rather than repackaging an existing environment.</p> <p>Base boxes are extremely useful for having a clean slate starting point from which to build future development environments. The Vagrant project hopes in the future to be able to provide base boxes for many more operating systems. Until then, this page documents how you can create your own base box.</p> <blockquote class="alert alert-warning"> <p><strong>Advanced topic!</strong> Creating a base box can be a time consuming and tedious process, and is not recommended for new Vagrant users. If you are just getting started with Vagrant, we recommend trying to find existing base boxes to use first.</p> </blockquote>
<h2 id="what-39-s-in-a-base-box-">  What's in a Base Box? </h2> <p>A base box typically consists of only a bare minimum set of software for Vagrant to function. As an example, a Linux box may contain only the following:</p> <ul> <li>Package manager </li> <li>SSH </li> <li>SSH user so Vagrant can connect </li> <li>Perhaps Chef, Puppet, etc. but not strictly required. </li> </ul> <p>In addition to this, each <a href="../providers/index.html">provider</a> may require additional software. For example, if you are making a base box for VirtualBox, you will want to include the VirtualBox guest additions so that shared folders work properly. But if you are making an AWS base box, this is not required.</p> <h2 id="creating-a-base-box-1">  Creating a Base Box </h2> <p>Creating a base box is actually provider-specific. This means that depending on if you are using VirtualBox, VMware, AWS, etc. the process for creating a base box is different. Because of this, this one document cannot be a full guide to creating a base box.</p> <p>This page will document some general guidelines for creating base boxes, however, and will link to provider-specific guides for creating base boxes.</p> <p>Provider-specific guides for creating base boxes are linked below:</p> <ul> <li>
<a href="../docker/boxes.html">Docker Base Boxes</a> </li> <li>
<a href="../hyperv/boxes.html">Hyper-V Base Boxes</a> </li> <li>
<a href="../vmware/boxes.html">VMware Base Boxes</a> </li> <li>
<a href="../virtualbox/boxes.html">VirtualBox Base Boxes</a> </li> </ul> <h3 id="packer-and-vagrant-cloud">  Packer and Vagrant Cloud </h3> <p>We strongly recommend using <a href="https://www.packer.io">Packer</a> to create reproducible builds for your base boxes, as well as automating the builds. Read more about <a href="https://www.packer.io/guides/packer-on-cicd/build-image-in-cicd.html">automating Vagrant box creation with Packer</a> in the Packer documentation.</p> <h3 id="disk-space">  Disk Space </h3> <p>When creating a base box, make sure the user will have enough disk space to do interesting things, without being annoying. For example, in VirtualBox, you should create a dynamically resizing drive with a large maximum size. This causes the actual footprint of the drive to be small initially, but to dynamically grow towards the max size as disk space is needed, providing the most flexibility for the end user.</p> <p>If you are creating an AWS base box, do not force the AMI to allocate terabytes of EBS storage, for example, since the user can do that on their own. But you should default to mounting ephemeral drives, because they're free and provide a lot of disk space.</p> <h3 id="memory">  Memory </h3> <p>Like disk space, finding the right balance of the default amount of memory is important. For most providers, the user can modify the memory with the Vagrantfile, so do not use too much by default. It would be a poor user experience (and mildly shocking) if a <code>vagrant up</code> from a base box instantly required many gigabytes of RAM. Instead, choose a value such as 512MB, which is usually enough to play around and do interesting things with a Vagrant machine, but can easily be increased when needed.</p> <h3 id="peripherals-audio-usb-etc-">  Peripherals (Audio, USB, etc.) </h3> <p>Disable any non-necessary hardware in a base box such as audio and USB controllers. These are generally unnecessary for Vagrant usage and, again, can be easily added via the Vagrantfile in most cases.</p> <h2 id="default-user-settings">  Default User Settings </h2> <p>Just about every aspect of Vagrant can be modified. However, Vagrant does expect some defaults which will cause your base box to "just work" out of the box. You should create these as defaults if you intend to publicly distribute your box.</p> <p>If you are creating a base box for private use, you should try <em>not</em> to follow these, as they open up your base box to security risks (known users, passwords, private keys, etc.).</p> <h3 id="quot-vagrant-quot-user">  "vagrant" User </h3> <p>By default, Vagrant expects a "vagrant" user to SSH into the machine as. This user should be setup with the <a href="https://github.com/hashicorp/vagrant/tree/master/keys">insecure keypair</a> that Vagrant uses as a default to attempt to SSH. Also, even though Vagrant uses key-based authentication by default, it is a general convention to set the password for the "vagrant" user to "vagrant". This lets people login as that user manually if they need to.</p> <p>To configure SSH access with the insecure keypair, place the public key into the <code>~/.ssh/authorized_keys</code> file for the "vagrant" user. Note that OpenSSH is very picky about file permissions. Therefore, make sure that <code>~/.ssh</code> has <code>0700</code> permissions and the authorized keys file has <code>0600</code> permissions.</p> <p>When Vagrant boots a box and detects the insecure keypair, it will automatically replace it with a randomly generated keypair for additional security while the box is running.</p> <h3 id="root-password-quot-vagrant-quot-">  Root Password: "vagrant" </h3> <p>Vagrant does not actually use or expect any root password. However, having a generally well known root password makes it easier for the general public to modify the machine if needed.</p> <p>Publicly available base boxes usually use a root password of "vagrant" to keep things easy.</p> <h3 id="password-less-sudo">  Password-less Sudo </h3> <p>This is <strong>important!</strong>. Many aspects of Vagrant expect the default SSH user to have passwordless sudo configured. This lets Vagrant configure networks, mount synced folders, install software, and more.</p> <p>To begin, some minimal installations of operating systems do not even include <code>sudo</code> by default. Verify that you install <code>sudo</code> in some way.</p> <p>After installing sudo, configure it (usually using <code>visudo</code>) to allow passwordless sudo for the "vagrant" user. This can be done with the following line at the end of the configuration file:</p> <div class="highlight"><pre class="highlight plaintext">vagrant ALL=(ALL) NOPASSWD: ALL
</pre></div>
<p>Additionally, Vagrant does not use a pty or tty by default when connected via SSH. You will need to make sure there is no line that has <code>requiretty</code> in it. Remove that if it exists. This allows sudo to work properly without a tty. Note that you <em>can</em> configure Vagrant to request a pty, which lets you keep this configuration. But Vagrant by default does not do this.</p> <h3 id="ssh-tweaks">  SSH Tweaks </h3> <p>In order to keep SSH speedy even when your machine or the Vagrant machine is not connected to the internet, set the <code>UseDNS</code> configuration to <code>no</code> in the SSH server configuration.</p> <p>This avoids a reverse DNS lookup on the connecting SSH client which can take many seconds.</p> <h2 id="windows-boxes">  Windows Boxes </h2> <p>Supported Windows guest operating systems: - Windows 7 - Windows 8 - Windows Server 2008 - Windows Server 2008 R2 - Windows Server 2012 - Windows Server 2012 R2</p> <p>Windows Server 2003 and Windows XP are <em>not</em> supported, but if you are a die hard XP fan <a href="https://stackoverflow.com/a/18593425/18475">this</a> may help you.</p> <h3 id="base-windows-configuration">  Base Windows Configuration </h3> <ul> <li>Turn off UAC </li> <li>Disable complex passwords </li> <li>Disable "Shutdown Tracker" </li> <li>Disable "Server Manager" starting at login (for non-Core) </li> </ul> <p>In addition to disabling UAC in the control panel, you also must disable UAC in the registry. This may vary from Windows version to Windows version, but Windows 8/8.1 use the command below. This will allow some things like automated Puppet installs to work within Vagrant Windows base boxes.</p> <div class="highlight"><pre class="highlight plaintext">reg add HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA /d 0 /t REG_DWORD /f /reg:64
</pre></div>
<h3 id="base-winrm-configuration">  Base WinRM Configuration </h3> <p>To enable and configure WinRM you will need to set the WinRM service to auto-start and allow unencrypted basic auth (obviously this is not secure). Run the following commands from a regular Windows command prompt:</p> <div class="highlight"><pre class="highlight plaintext">winrm quickconfig -q
winrm set winrm/config/winrs @{MaxMemoryPerShellMB="512"}
winrm set winrm/config @{MaxTimeoutms="1800000"}
winrm set winrm/config/service @{AllowUnencrypted="true"}
winrm set winrm/config/service/auth @{Basic="true"}
sc config WinRM start= auto
</pre></div>
<h3 id="additional-winrm-1-1-configuration">  Additional WinRM 1.1 Configuration </h3> <p>These additional configuration steps are specific to Windows Server 2008 (WinRM 1.1). For Windows Server 2008 R2, Windows 7 and later versions of Windows you can ignore this section.</p> <ol> <li>Ensure the Windows PowerShell feature is installed </li> <li>Change the WinRM port to 5985 or upgrade to WinRM 2.0 </li> </ol> <p>The following commands will change the WinRM 1.1 port to what's expected by Vagrant:</p> <div class="highlight"><pre class="highlight plaintext">netsh firewall add portopening TCP 5985 "Port 5985"
winrm set winrm/config/listener?Address=*+Transport=HTTP @{Port="5985"}
</pre></div>
<h2 id="other-software">  Other Software </h2> <p>At this point, you have all the common software you absolutely <em>need</em> for your base box to work with Vagrant. However, there is some additional software you can install if you wish.</p> <p>While we plan on it in the future, Vagrant still does not install Chef or Puppet automatically when using those provisioners. Users can use a shell provisioner to do this, but if you want Chef/Puppet to just work out of the box, you will have to install them in the base box.</p> <p>Installing this is outside the scope of this page, but should be fairly straightforward.</p> <p>In addition to this, feel free to install and configure any other software you want available by default for this base box.</p> <h2 id="packaging-the-box">  Packaging the Box </h2> <p>Packaging the box into a <code>box</code> file is provider-specific. Please refer to the provider-specific documentation for creating a base box. Some provider-specific guides are linked to towards the top of this page.</p> <h2 id="distributing-the-box">  Distributing the Box </h2> <p>You can distribute the box file however you would like. However, if you want to support versioning, putting multiple providers at a single URL, pushing updates, analytics, and more, we recommend you add the box to <a href="https://www.vagrantup.com/docs/vagrant-cloud">HashiCorp's Vagrant Cloud</a>.</p> <p>You can upload both public and private boxes to this service.</p> <h2 id="testing-the-box">  Testing the Box </h2> <p>To test the box, pretend you are a new user of Vagrant and give it a shot:</p> <div class="highlight"><pre class="highlight plaintext">$ vagrant box add --name my-box /path/to/the/new.box
...
$ vagrant init my-box
...
$ vagrant up
...
</pre></div>
<p>If you made a box for some other provider, be sure to specify the <code>--provider</code> option to <code>vagrant up</code>. If the up succeeded, then your box worked!</p><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2010&ndash;2018 Mitchell Hashimoto<br>Licensed under the MPL 2.0 License.<br>
    <a href="https://www.vagrantup.com/docs/boxes/base.html" class="_attribution-link">https://www.vagrantup.com/docs/boxes/base.html</a>
  </p>
</div>
