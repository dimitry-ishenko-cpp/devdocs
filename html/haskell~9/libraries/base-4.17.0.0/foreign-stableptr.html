<h1 class="caption">Foreign.StablePtr</h1>
<div class="_haskell-api">
<table class="info">
<tr>
<th valign="top">Copyright</th>
<td>(c) The University of Glasgow 2001</td>
</tr>
<tr>
<th>License</th>
<td>BSD-style (see the file libraries/base/LICENSE)</td>
</tr>
<tr>
<th>Maintainer</th>
<td>ffi@haskell.org</td>
</tr>
<tr>
<th>Stability</th>
<td>provisional</td>
</tr>
<tr>
<th>Portability</th>
<td>portable</td>
</tr>
<tr>
<th>Safe Haskell</th>
<td>Trustworthy</td>
</tr>
<tr>
<th>Language</th>
<td>Haskell2010</td>
</tr>
</table>
<div id="table-of-contents"><div id="contents-list">
<h4 class="caption" onclick="window.scrollTo(0,0)">Contents</h4>
<ul><li>
<a href="#g:1">Stable references to Haskell values</a><ul><li><a href="#g:2">The C-side interface</a></li></ul>
</li></ul>
</div></div>
<div id="description">
<h4 class="caption">Description</h4>
<p>This module is part of the Foreign Function Interface (FFI) and will usually be imported via the module <a href="foreign.html">Foreign</a>.</p>
</div>
<a href="#g:1" id="g:1"><h2>Stable references to Haskell values</h2></a><p class="src">data <a id="t:StablePtr" class="def">StablePtr</a> a <a href="https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/base-4.17.0.0/src/GHC.Stable.html#StablePtr" class="link">Source</a> </p>
<p>A <em>stable pointer</em> is a reference to a Haskell expression that is guaranteed not to be affected by garbage collection, i.e., it will neither be deallocated nor will the value of the stable pointer itself change during garbage collection (ordinary references may be relocated during garbage collection). Consequently, stable pointers can be passed to foreign code, which can treat it as an opaque reference to a Haskell value.</p>
<p>A value of type <code>StablePtr a</code> is a stable pointer to a Haskell expression of type <code>a</code>.</p>
<div class="subs instances">
<h5 class="instances details-toggle-control details-toggle" data-details-id="i:StablePtr">Instances</h5>
<details id="i:StablePtr" open="open"><summary class="hide-when-js-enabled">Instances details</summary><table>
<tr>
<td class="src clearfix">
 <a href="foreign-storable.html#t:Storable" title="Foreign.Storable">Storable</a> (<a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a) <a href="https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/base-4.17.0.0/src/Foreign.Storable.html#line-194" class="link">Source</a> </td>
<td class="doc"><p><span class="version">Since: base-2.1</span></p></td>
</tr>
<tr><td colspan="2"><details id="i:id:StablePtr:Storable:1"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="foreign-storable.html">Foreign.Storable</a></p> <div class="subs methods">
<h4 class="caption">Methods</h4>
<p class="src"><a href="#v:sizeOf">sizeOf</a> :: <a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a -&gt; <a href="data-int.html#t:Int" title="Data.Int">Int</a> <a href="https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/base-4.17.0.0/src/Foreign.Storable.html#sizeOf" class="link">Source</a> </p>
<p class="src"><a href="#v:alignment">alignment</a> :: <a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a -&gt; <a href="data-int.html#t:Int" title="Data.Int">Int</a> <a href="https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/base-4.17.0.0/src/Foreign.Storable.html#alignment" class="link">Source</a> </p>
<p class="src"><a href="#v:peekElemOff">peekElemOff</a> :: <a href="foreign-ptr.html#t:Ptr" title="Foreign.Ptr">Ptr</a> (<a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a) -&gt; <a href="data-int.html#t:Int" title="Data.Int">Int</a> -&gt; <a href="system-io.html#t:IO" title="System.IO">IO</a> (<a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a) <a href="https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/base-4.17.0.0/src/Foreign.Storable.html#peekElemOff" class="link">Source</a> </p>
<p class="src"><a href="#v:pokeElemOff">pokeElemOff</a> :: <a href="foreign-ptr.html#t:Ptr" title="Foreign.Ptr">Ptr</a> (<a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a) -&gt; <a href="data-int.html#t:Int" title="Data.Int">Int</a> -&gt; <a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a -&gt; <a href="system-io.html#t:IO" title="System.IO">IO</a> () <a href="https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/base-4.17.0.0/src/Foreign.Storable.html#pokeElemOff" class="link">Source</a> </p>
<p class="src"><a href="#v:peekByteOff">peekByteOff</a> :: <a href="foreign-ptr.html#t:Ptr" title="Foreign.Ptr">Ptr</a> b -&gt; <a href="data-int.html#t:Int" title="Data.Int">Int</a> -&gt; <a href="system-io.html#t:IO" title="System.IO">IO</a> (<a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a) <a href="https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/base-4.17.0.0/src/Foreign.Storable.html#peekByteOff" class="link">Source</a> </p>
<p class="src"><a href="#v:pokeByteOff">pokeByteOff</a> :: <a href="foreign-ptr.html#t:Ptr" title="Foreign.Ptr">Ptr</a> b -&gt; <a href="data-int.html#t:Int" title="Data.Int">Int</a> -&gt; <a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a -&gt; <a href="system-io.html#t:IO" title="System.IO">IO</a> () <a href="https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/base-4.17.0.0/src/Foreign.Storable.html#pokeByteOff" class="link">Source</a> </p>
<p class="src"><a href="#v:peek">peek</a> :: <a href="foreign-ptr.html#t:Ptr" title="Foreign.Ptr">Ptr</a> (<a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a) -&gt; <a href="system-io.html#t:IO" title="System.IO">IO</a> (<a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a) <a href="https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/base-4.17.0.0/src/Foreign.Storable.html#peek" class="link">Source</a> </p>
<p class="src"><a href="#v:poke">poke</a> :: <a href="foreign-ptr.html#t:Ptr" title="Foreign.Ptr">Ptr</a> (<a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a) -&gt; <a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a -&gt; <a href="system-io.html#t:IO" title="System.IO">IO</a> () <a href="https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/base-4.17.0.0/src/Foreign.Storable.html#poke" class="link">Source</a> </p>
</div></details></td></tr>
<tr>
<td class="src clearfix">
 <a href="data-eq.html#t:Eq" title="Data.Eq">Eq</a> (<a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a) <a href="https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/base-4.17.0.0/src/GHC.Stable.html#line-107" class="link">Source</a> </td>
<td class="doc"><p><span class="version">Since: base-2.1</span></p></td>
</tr>
<tr><td colspan="2"><details id="i:id:StablePtr:Eq:2"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="ghc-stable.html">GHC.Stable</a></p> <div class="subs methods">
<h4 class="caption">Methods</h4>
<p class="src"><a href="#v:-61--61-">(==)</a> :: <a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a -&gt; <a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a -&gt; <a href="data-bool.html#t:Bool" title="Data.Bool">Bool</a> <a href="https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/ghc-prim-0.9.0/src/GHC.Classes.html#%3D%3D" class="link">Source</a> </p>
<p class="src"><a href="#v:-47--61-">(/=)</a> :: <a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a -&gt; <a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a -&gt; <a href="data-bool.html#t:Bool" title="Data.Bool">Bool</a> <a href="https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/ghc-prim-0.9.0/src/GHC.Classes.html#%2F%3D" class="link">Source</a> </p>
</div></details></td></tr>
</table></details>
</div>
<p class="src"><a id="v:newStablePtr" class="def">newStablePtr</a> :: a -&gt; <a href="system-io.html#t:IO" title="System.IO">IO</a> (<a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a) <a href="https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/base-4.17.0.0/src/GHC.Stable.html#newStablePtr" class="link">Source</a> </p>
<p>Create a stable pointer referring to the given Haskell value.</p>
<p class="src"><a id="v:deRefStablePtr" class="def">deRefStablePtr</a> :: <a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a -&gt; <a href="system-io.html#t:IO" title="System.IO">IO</a> a <a href="https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/base-4.17.0.0/src/GHC.Stable.html#deRefStablePtr" class="link">Source</a> </p>
<p>Obtain the Haskell value referenced by a stable pointer, i.e., the same value that was passed to the corresponding call to <code><a href="foreign-stableptr.html#v:newStablePtr" title="Foreign.StablePtr">newStablePtr</a></code>. If the argument to <code><a href="foreign-stableptr.html#v:deRefStablePtr" title="Foreign.StablePtr">deRefStablePtr</a></code> has already been freed using <code><a href="foreign-stableptr.html#v:freeStablePtr" title="Foreign.StablePtr">freeStablePtr</a></code>, the behaviour of <code><a href="foreign-stableptr.html#v:deRefStablePtr" title="Foreign.StablePtr">deRefStablePtr</a></code> is undefined.</p>
<p class="src"><a id="v:freeStablePtr" class="def">freeStablePtr</a> :: <a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a -&gt; <a href="system-io.html#t:IO" title="System.IO">IO</a> () <a href="https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/base-4.17.0.0/src/GHC.Stable.html#freeStablePtr" class="link">Source</a> </p>
<p>Dissolve the association between the stable pointer and the Haskell value. Afterwards, if the stable pointer is passed to <code><a href="foreign-stableptr.html#v:deRefStablePtr" title="Foreign.StablePtr">deRefStablePtr</a></code> or <code><a href="foreign-stableptr.html#v:freeStablePtr" title="Foreign.StablePtr">freeStablePtr</a></code>, the behaviour is undefined. However, the stable pointer may still be passed to <code><a href="foreign-stableptr.html#v:castStablePtrToPtr" title="Foreign.StablePtr">castStablePtrToPtr</a></code>, but the <code><a href="foreign-ptr.html#v:Ptr" title="Foreign.Ptr">Ptr</a> ()</code> value returned by <code><a href="foreign-stableptr.html#v:castStablePtrToPtr" title="Foreign.StablePtr">castStablePtrToPtr</a></code>, in this case, is undefined (in particular, it may be <code><a href="foreign-ptr.html#v:nullPtr" title="Foreign.Ptr">nullPtr</a></code>). Nevertheless, the call to <code><a href="foreign-stableptr.html#v:castStablePtrToPtr" title="Foreign.StablePtr">castStablePtrToPtr</a></code> is guaranteed not to diverge.</p>
<p class="src"><a id="v:castStablePtrToPtr" class="def">castStablePtrToPtr</a> :: <a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a -&gt; <a href="foreign-ptr.html#t:Ptr" title="Foreign.Ptr">Ptr</a> () <a href="https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/base-4.17.0.0/src/GHC.Stable.html#castStablePtrToPtr" class="link">Source</a> </p>
<p>Coerce a stable pointer to an address. No guarantees are made about the resulting value, except that the original stable pointer can be recovered by <code><a href="foreign-stableptr.html#v:castPtrToStablePtr" title="Foreign.StablePtr">castPtrToStablePtr</a></code>. In particular, the address might not refer to an accessible memory location and any attempt to pass it to the member functions of the class <code><a href="foreign-storable.html#v:Storable" title="Foreign.Storable">Storable</a></code> leads to undefined behaviour.</p>
<p class="src"><a id="v:castPtrToStablePtr" class="def">castPtrToStablePtr</a> :: <a href="foreign-ptr.html#t:Ptr" title="Foreign.Ptr">Ptr</a> () -&gt; <a href="foreign-stableptr.html#t:StablePtr" title="Foreign.StablePtr">StablePtr</a> a <a href="https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/base-4.17.0.0/src/GHC.Stable.html#castPtrToStablePtr" class="link">Source</a> </p>
<p>The inverse of <code><a href="foreign-stableptr.html#v:castStablePtrToPtr" title="Foreign.StablePtr">castStablePtrToPtr</a></code>, i.e., we have the identity</p>
<pre>sp == castPtrToStablePtr (castStablePtrToPtr sp)</pre>
<p>for any stable pointer <code>sp</code> on which <code><a href="foreign-stableptr.html#v:freeStablePtr" title="Foreign.StablePtr">freeStablePtr</a></code> has not been executed yet. Moreover, <code><a href="foreign-stableptr.html#v:castPtrToStablePtr" title="Foreign.StablePtr">castPtrToStablePtr</a></code> may only be applied to pointers that have been produced by <code><a href="foreign-stableptr.html#v:castStablePtrToPtr" title="Foreign.StablePtr">castStablePtrToPtr</a></code>.</p>
<a href="#g:2" id="g:2"><h3>The C-side interface</h3></a><p>The following definition is available to C programs inter-operating with Haskell code when including the header <code>HsFFI.h</code>.</p>
<pre>typedef void *HsStablePtr;  /* C representation of a StablePtr */</pre>
<p>Note that no assumptions may be made about the values representing stable pointers. In fact, they need not even be valid memory addresses. The only guarantee provided is that if they are passed back to Haskell land, the function <code><a href="foreign-stableptr.html#v:deRefStablePtr" title="Foreign.StablePtr">deRefStablePtr</a></code> will be able to reconstruct the Haskell value referred to by the stable pointer.</p>
</div><div class="_attribution">
  <p class="_attribution-p">
    &copy; The University of Glasgow and others<br>Licensed under a BSD-style license (see top of the page).<br>
    <a href="https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/base-4.17.0.0/Foreign-StablePtr.html" class="_attribution-link">https://downloads.haskell.org/~ghc/9.4.2/docs/libraries/base-4.17.0.0/Foreign-StablePtr.html</a>
  </p>
</div>
