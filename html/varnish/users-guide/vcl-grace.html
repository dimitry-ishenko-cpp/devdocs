<h1 id="users-guide-handling-misbehaving-servers">Grace mode and keep</h1> <p>Sometimes you want Varnish to serve content that is somewhat stale instead of waiting for a fresh object from the backend. For example, if you run a news site, serving a main page that is a few seconds old is not a problem if this gives your site faster load times.</p> <p>In Varnish this is achieved by using <code>grace mode</code>. A related idea is <code>keep</code>, which is also explained here.</p> <section id="grace-mode"> <h2>Grace mode</h2> <p>When several clients are requesting the same page Varnish will send one request to the backend and place the others on hold while fetching one copy from the backend. In some products this is called request coalescing and Varnish does this automatically.</p> <p>If you are serving thousands of hits per second the queue of waiting requests can get huge. There are two potential problems - one is a thundering herd problem - suddenly releasing a thousand threads to serve content might send the load sky high. Secondly - nobody likes to wait.</p> <p>Setting an object’s <code>grace</code> to a positive value tells Varnish that it should serve the object to clients for some time after the TTL has expired, while Varnish fetches a new version of the object. The default value is controlled by the runtime parameter <code>default_grace</code>.</p> </section> <section id="keep"> <h2>Keep</h2> <p>Setting an object’s <code>keep</code> tells Varnish that it should keep an object in the cache for some additional time. The reasons to set <code>keep</code> is to use the object to construct a conditional GET backend request (with If-Modified-Since: and/or Ìf-None-Match: headers), allowing the backend to reply with a 304 Not Modified response, which may be more efficient on the backend and saves re-transmitting the unchanged body.</p> <p>The values are additive, so if grace is 10 seconds and keep is 1 minute, then objects will survive in cache for 70 seconds after the TTL has expired.</p> </section> <section id="setting-grace-and-keep"> <h2>Setting grace and keep</h2> <p>We can use VCL to make Varnish keep all objects for 10 minutes beyond their TTL with a grace period of 2 minutes:</p> <pre data-language="python">sub vcl_backend_response {
     set beresp.grace = 2m;
     set beresp.keep = 8m;
}
</pre> </section> <section id="the-effect-of-grace-and-keep"> <h2>The effect of grace and keep</h2> <p>For most users setting the default grace and/or a suitable grace for each object is enough. The default VCL will do the right thing and behave as described above. However, if you want to customize how Varnish behaves, then you should know some of the details on how this works.</p> <p>When <code>sub vcl_recv</code> ends with <code>return (lookup)</code> (which is the default behavior), Varnish will look for a matching object in its cache. Then, if it only found an object whose TTL has run out, Varnish will consider the following:</p> <ul class="simple"> <li>Is there already an ongoing backend request for the object?</li> <li>Is the object within the <code>grace period</code>?</li> </ul> <p>Then, Varnish reacts using the following rules:</p> <ul class="simple"> <li>If the <code>grace period</code> has run out and there is no ongoing backend request, then <code>sub vcl_miss</code> is called immediately, and the object will be used as a 304 candidate.</li> <li>If the <code>grace period</code> has run out and there is an ongoing backend request, then the request will wait until the backend request finishes.</li> <li>If there is no backend request for the object, one is scheduled.</li> <li>Assuming the object will be delivered, <code>sub vcl_hit</code> is called immediately.</li> </ul> <p>Note that the backend fetch happens asynchronously, and the moment the new object is in it will replace the one we’ve already got.</p> <p>If you do not define your own <code>sub vcl_hit</code>, then the default one is used. It looks like this:</p> <pre data-language="python">sub vcl_hit {
     return (deliver);
}
</pre> <p>Note that the condition <code>obj.ttl + obj.grace &gt; 0s</code> will (in <code>sub
vcl_hit</code>) always evaluate to true. In earlier versions (6.0.0 and earlier), this was not the case, and a test in the builtin VCL was necessary to make sure that “keep objects” (objects in the cache where both TTL and grace had run out) would not be delivered to the clients.</p> <p>In the current version, when there are only “keep objects” available, <code>sub vcl_miss</code> will be called, and a fetch for a new object will be initiated.</p> </section> <section id="misbehaving-servers"> <h2>Misbehaving servers</h2> <p>A key feature of Varnish is its ability to shield you from misbehaving web- and application servers.</p> <p>If you have enabled <a class="reference internal" href="vcl-backends.html#users-guide-advanced-backend-servers-health"><span class="std std-ref">Health checks</span></a> you can check if the backend is sick and modify the behavior when it comes to grace. This can done in the following way:</p> <pre data-language="python">sub vcl_backend_response {
     set beresp.grace = 24h;
     // no keep - the grace should be enough for 304 candidates
}

sub vcl_recv {
     if (std.healthy(req.backend_hint)) {
          // change the behavior for healthy backends: Cap grace to 10s
          set req.grace = 10s;
     }
}
</pre> <p>In the example above, the special variable <code>req.grace</code> is set. The effect is that, when the backend is healthy, objects with grace above 10 seconds will have an <code>effective</code> grace of 10 seconds. When the backend is sick, the default VCL kicks in, and the long grace is used.</p> <p>Additionally, you might want to stop cache insertion when a backend fetch returns an <code>5xx</code> error:</p> <pre data-language="python">sub vcl_backend_response {
     if (beresp.status &gt;= 500 &amp;&amp; bereq.is_bgfetch) {
          return (abandon);
     }
}
</pre> </section> <section id="summary"> <h2>Summary</h2> <p>Grace mode allows Varnish to deliver slightly stale content to clients while getting a fresh version from the backend. The result is faster load times at lower cost.</p> <p>It is possible to limit the grace during lookup by setting <code>req.grace</code> and then change the behavior when it comes to grace. Often this is done to change the <code>effective</code> grace depending on the health of the backend.</p> </section><div class="_attribution">
  <p class="_attribution-p">
    Copyright &copy; 2006 Verdens Gang AS<br>Copyright &copy; 2006&ndash;2020 Varnish Software AS<br>Licensed under the BSD-2-Clause License.<br>
    <a href="https://varnish-cache.org/docs/7.4/users-guide/vcl-grace.html" class="_attribution-link">https://varnish-cache.org/docs/7.4/users-guide/vcl-grace.html</a>
  </p>
</div>
