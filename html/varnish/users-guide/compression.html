<h1 id="users-guide-compression">Compression</h1> <p>In Varnish 3.0 we introduced native support for compression, using gzip encoding. <em>Before</em> 3.0, Varnish would never compress objects.</p> <p>In Varnish 4.0 compression defaults to “on”, meaning that it tries to be smart and do the sensible thing.</p> <p>If you don’t want Varnish tampering with the encoding you can disable compression all together by setting the parameter <code>http_gzip_support</code> to false. Please see man <a class="reference internal" href="../reference/varnishd.html#varnishd-1"><span class="std std-ref">varnishd</span></a> for details.</p> <section id="default-behaviour"> <h2>Default behaviour</h2> <p>The default behaviour is active when the <code>http_gzip_support</code> parameter is set to “on” and neither <code>beresp.do_gzip</code> nor <code>beresp.do_gunzip</code> are used in VCL.</p> <p>Unless returning from <code>vcl_recv</code> with <code>pipe</code> or <code>pass</code>, Varnish modifies <code>req.http.Accept-Encoding</code>: if the client supports gzip <code>req.http.Accept-Encoding</code> is set to “gzip”, otherwise the header is removed.</p> <p>Unless the request is a <code>pass</code>, Varnish sets <code>bereq.http.Accept-Encoding</code> to “gzip” before <code>vcl_backend_fetch</code> runs, so the header can be changed in VCL.</p> <p>If the server responds with gzip’ed content it will be stored in memory in its compressed form and <code>Accept-Encoding</code> will be added to the <code>Vary</code> header.</p> <p>To clients supporting gzip, compressed content is delivered unmodified.</p> <p>For clients not supporting gzip, compressed content gets decompressed on the fly while delivering it. The <code>Content-Encoding</code> response header gets removed and any <code>Etag</code> gets weakened (by prepending “W/”).</p> <p>For Vary Lookups, <code>Accept-Encoding</code> is ignored.</p> </section> <section id="compressing-content-if-backends-don-t"> <h2>Compressing content if backends don’t</h2> <p>You can tell Varnish to compress content before storing it in cache in <code>vcl_backend_response</code> by setting <code>beresp.do_gzip</code> to “true”, like this:</p> <pre data-language="python">sub vcl_backend_response {
    if (beresp.http.content-type ~ "text") {
        set beresp.do_gzip = true;
    }
}
</pre> <p>With <code>beresp.do_gzip</code> set to “true”, Varnish will make the following changes to the headers of the resulting object before inserting it in the cache:</p> <ul class="simple"> <li>set <code>obj.http.Content-Encoding</code> to “gzip”</li> <li>add “Accept-Encoding” to <code>obj.http.Vary</code>, unless already present</li> <li>weaken any <code>Etag</code> (by prepending “W/”)</li> </ul> <p>Generally, Varnish doesn’t use much CPU so it might make more sense to have Varnish spend CPU cycles compressing content than doing it in your web- or application servers, which are more likely to be CPU-bound.</p> <p>Please make sure that you don’t try to compress content that is uncompressable, like JPG, GIF and MP3 files. You’ll only waste CPU cycles.</p> </section> <section id="uncompressing-content-before-entering-the-cache"> <h2>Uncompressing content before entering the cache</h2> <p>You can also uncompress content before storing it in cache by setting <code>beresp.do_gunzip</code> to “true”. One use case for this feature is to work around badly configured backends uselessly compressing already compressed content like JPG images (but fixing the misbehaving backend is always the better option).</p> <p>With <code>beresp.do_gunzip</code> set to “true”, Varnish will make the following changes to the headers of the resulting object before inserting it in the cache:</p> <ul class="simple"> <li>remove <code>obj.http.Content-Encoding</code>
</li> <li>weaken any <code>Etag</code> (by prepending “W/”)</li> </ul> </section> <section id="gzip-and-esi"> <h2>GZIP and ESI</h2> <p>If you are using Edge Side Includes (ESI) you’ll be happy to note that ESI and GZIP work together really well. Varnish will magically decompress the content to do the ESI-processing, then recompress it for efficient storage and delivery.</p> </section> <section id="turning-off-gzip-support"> <h2>Turning off gzip support</h2> <p>When the <code>http_gzip_support</code> parameter is set to “off”, Varnish does not do any of the header alterations documented above, handles <code>Vary: Accept-Encoding</code> like it would for any other <code>Vary</code> value and ignores <code>beresp.do_gzip</code> and <code>beresp.do_gunzip</code>.</p> </section> <section id="a-random-outburst"> <h2>A random outburst</h2> <p>Poul-Henning Kamp has written <a class="reference internal" href="https://varnish-cache.org/docs/7.4/phk/gzip.html#phk-gzip"><span class="std std-ref">How GZIP, and GZIP+ESI works in Varnish</span></a> which talks a bit more about how the implementation works.</p> </section><div class="_attribution">
  <p class="_attribution-p">
    Copyright &copy; 2006 Verdens Gang AS<br>Copyright &copy; 2006&ndash;2020 Varnish Software AS<br>Licensed under the BSD-2-Clause License.<br>
    <a href="https://varnish-cache.org/docs/7.4/users-guide/compression.html" class="_attribution-link">https://varnish-cache.org/docs/7.4/users-guide/compression.html</a>
  </p>
</div>
