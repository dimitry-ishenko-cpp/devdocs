<h1 id="users-guide-increasing-your-hitrate">Achieving a high hitrate</h1> <p>Now that Varnish is up and running you can access your web application through Varnish. Unless your application is specifically written to work behind a web accelerator you’ll probably need to do some changes to either the configuration or the application in order to get a high hitrate in Varnish.</p> <p>Varnish will not cache your data unless it’s absolutely sure it is safe to do so. So, for you to understand how Varnish decides if and how to cache a page, we’ll guide you through a couple of tools that you should find useful to understand what is happening in your Varnish setup.</p> <p>Note that you need a tool to see the HTTP headers that fly between Varnish and the backend. On the Varnish server, the easiest way to do this is to use <a class="reference internal" href="../reference/varnishlog.html#varnishlog-1"><span class="std std-ref">varnishlog</span></a> and <a class="reference internal" href="../reference/varnishtop.html#varnishtop-1"><span class="std std-ref">varnishtop</span></a> but sometimes a client-side tool makes sense. Here are the ones we commonly use.</p> <section id="tool-varnishtop"> <h2>Tool: varnishtop</h2> <p>You can use varnishtop to identify what URLs are hitting the backend the most. <code>varnishtop -i BereqURL</code> is an essential command, showing you the top requests Varnish is sending to the backend. You can see some other examples of <a class="reference internal" href="../reference/varnishtop.html#varnishtop-1"><span class="std std-ref">varnishtop</span></a> usage in <a class="reference internal" href="operation-statistics.html#users-guide-statistics"><span class="std std-ref">Statistics</span></a>.</p> </section> <section id="tool-varnishlog"> <h2>Tool: varnishlog</h2> <p>When you have identified an URL which is frequently sent to the backend you can use <a class="reference internal" href="../reference/varnishlog.html#varnishlog-1"><span class="std std-ref">varnishlog</span></a> to have a look at the request. <code>varnishlog -q 'ReqURL ~ "^/foo/bar"'</code> will show you the requests coming from the client matching <code>/foo/bar</code>.</p> <p>For more information on how <a class="reference internal" href="../reference/varnishlog.html#varnishlog-1"><span class="std std-ref">varnishlog</span></a> works please see <a class="reference internal" href="operation-logging.html#users-guide-logging"><span class="std std-ref">Logging in Varnish</span></a> or then man page.</p> </section> <section id="tool-lwp-request"> <h2>Tool: lwp-request</h2> <p><code>lwp-request</code> is tool that is a part of The World-Wide Web library for Perl. It’s a couple of really basic programs that can execute an HTTP request and show you the result. We mostly use the two programs, <code>GET</code> and <code>HEAD</code>.</p> <p>vg.no was the first site to use Varnish and the people running Varnish there are quite clueful. So it’s interesting to look at their HTTP Headers. Let’s send a GET request for their home page:</p> <pre data-language="python">$ GET -H 'Host: www.vg.no' -Used http://vg.no/
GET http://vg.no/
Host: www.vg.no
User-Agent: lwp-request/5.834 libwww-perl/5.834

200 OK
Cache-Control: must-revalidate
Refresh: 600
Title: VG Nett - Forsiden - VG Nett
X-Age: 463
X-Cache: HIT
X-Rick-Would-Never: Let you down
X-VG-Jobb: http://www.finn.no/finn/job/fulltime/result?keyword=vg+multimedia Merk:HeaderNinja
X-VG-Korken: http://www.youtube.com/watch?v=Fcj8CnD5188
X-VG-WebCache: joanie
X-VG-WebServer: leon
</pre> <p>OK. Lets look at what <code>GET</code> does. <code>GET</code> usually sends off HTTP 0.9 requests, which lack the ‘Host’ header. So we add a ‘Host’ header with the ‘-H’ option. ‘-U’ print request headers, ‘-s’ prints response status, ‘-e’ prints response headers and ‘-d’ discards the actual content. We don’t really care about the content, only the headers.</p> <p>As you can see, VG adds quite a bit of information in their headers. Some of the headers, like the ‘X-Rick-Would-Never’ are specific to vg.no and their somewhat odd sense of humour. Others, like the ‘X-VG-Webcache’ are for debugging purposes.</p> <p>So, to check whether a site sets cookies for a specific URL, just do:</p> <pre data-language="python">GET -Used http://example.com/ |grep ^Set-Cookie
</pre> </section> <section id="tool-live-http-headers"> <h2>Tool: Live HTTP Headers</h2> <p>There is also a plugin for Firefox called <code>Live HTTP Headers</code>. This plugin can show you what headers are being sent and received. <code>Live HTTP Headers</code> can be found at <a class="reference external" href="https://addons.mozilla.org/en-US/firefox/addon/3829/">https://addons.mozilla.org/en-US/firefox/addon/3829/</a> or by googling “Live HTTP Headers”.</p> </section><div class="_attribution">
  <p class="_attribution-p">
    Copyright &copy; 2006 Verdens Gang AS<br>Copyright &copy; 2006&ndash;2020 Varnish Software AS<br>Licensed under the BSD-2-Clause License.<br>
    <a href="https://varnish-cache.org/docs/7.4/users-guide/increasing-your-hitrate.html" class="_attribution-link">https://varnish-cache.org/docs/7.4/users-guide/increasing-your-hitrate.html</a>
  </p>
</div>
