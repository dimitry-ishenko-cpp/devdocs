<h1 id="vsl-query-7">vsl-query</h1> <section id="varnish-vsl-query-expressions"> <h2>Varnish VSL Query Expressions</h2> <dl class="field-list simple"> <dt class="field-odd">Manual section<span class="colon">:</span>
</dt> <dd class="field-odd">
<p>7</p> </dd> </dl> <section id="overview"> <h3>OVERVIEW</h3> <p>The Varnish VSL Query Expressions extracts transactions from the Varnish shared memory log, and perform queries on the transactions before reporting matches.</p> <p>A transaction is a set of log lines that belongs together, e.g. a client request or a backend request. The API monitors the log, and collects all log records that make up a transaction before reporting on that transaction. Transactions can also be grouped, meaning backend transactions are reported together with the client transaction that initiated it.</p> <p>A query is run on a group of transactions. A query expression is true if there is a log record within the group that satisfies the condition. It is false only if none of the log records satisfies the condition. Query expressions can be combined using boolean functions. In addition to log records, it is possible to query transaction ids (vxid) in query.</p> </section> <section id="grouping"> <h3>GROUPING</h3> <p>When grouping transactions, there is a hierarchy structure showing which transaction initiated what. The level increases by one on an ‘initiated by’ relation, so for example a backend transaction will have one higher level than the client transaction that initiated it on a cache miss. Request restart transactions don’t get their level increased to make it predictable.</p> <p>Levels start counting at 1, except when using raw where it will always be 0.</p> <p>The grouping modes are:</p> <ul> <li>
<p><code>session</code></p> <p>All transactions initiated by a client connection are reported together. Client connections are open ended when using HTTP keep-alives, so it is undefined when the session will be reported. If the transaction timeout period is exceeded an incomplete session will be reported. Non-transactional data (vxid == 0) is not reported.</p> </li> <li>
<p><code>request</code></p> <p>Transactions are grouped by request, where the set will include the request itself as well as any backend requests or ESI-subrequests. Session data and non-transactional data (vxid == 0) is not reported.</p> </li> <li>
<p><code>vxid</code></p> <p>Transactions are not grouped, so each vxid is reported in its entirety. Sessions, requests, ESI-requests and backend requests are all reported individually. Non-transactional data is not reported (vxid == 0). This is the default.</p> </li> <li>
<p><code>raw</code></p> <p>Every log record will make up a transaction of its own. All data, including non-transactional data will be reported.</p> </li> </ul> <section id="transaction-hierarchy"> <h4>Transaction Hierarchy</h4> <p>Example transaction hierarchy using request grouping mode</p> <pre data-language="python">Lvl 1: Client request (cache miss)
  Lvl 2: Backend request
  Lvl 2: ESI subrequest (cache miss)
    Lvl 3: Backend request
    Lvl 3: Backend request (VCL restart)
    Lvl 3: ESI subrequest (cache miss)
      Lvl 4: Backend request
  Lvl 2: ESI subrequest (cache hit)
</pre> </section> </section> <section id="memory-usage"> <h3>MEMORY USAGE</h3> <p>The API will use pointers to shared memory log data as long as possible to keep memory usage at a minimum. But as the shared memory log is a ring buffer, data will get overwritten eventually, so the API creates local copies of referenced log data when varnishd comes close to overwriting still unreported content.</p> <p>This process avoids loss of log data in many scenarios, but it is not failsafe: Overruns where varnishd “overtakes” the log reader process in the ring buffer can still happen when API clients cannot keep up reading and/or copying, for instance due to output blocking.</p> <p>Though being unrelated to grouping in principle, copying of log data is particularly relevant for session grouping together with long lasting client connections - for this grouping, the logging API client process is likely to consume relevant amounts of memory. As the vxid grouping also logs (potentially long lasting) sessions, it is also likely to require memory for copies of log entries, but far less than session grouping.</p> </section> <section id="query-language"> <h3>QUERY LANGUAGE</h3> <p>A query expression consists of record selection criteria, and optionally an operator and a value to match against the selected records.</p> <pre data-language="python">&lt;record selection criteria&gt; &lt;operator&gt; &lt;operand&gt;
</pre> <p>Additionally, a query expression can occur on the transaction itself rather than log records belonging to the transaction.</p> <pre data-language="python">vxid &lt;numerical operator&gt; &lt;integer&gt;
</pre> <p>A <code>vxid</code> query allows you to directly target a specific transacion, whose id can be obtained from an <code>X-Varnish</code> HTTP header, the default “guru meditation” error page, or <code>Begin</code> and <code>Link</code> log records.</p> <p>A query must fit on a single line, but it is possible to pass multiple queries at once, one query per line. Empty lines are ignored, and the list of queries is treated as if the ‘or’ operator was used to combine them.</p> <p>For example this list of queries:</p> <pre data-language="python"># catch varnish errors
*Error

# catch backend errors
BerespStatus &gt;= 500
</pre> <p>is identical to this query:</p> <pre data-language="python">(*Error) or (BerespStatus &gt;= 500)
</pre> <p>Comments can be used and will be ignored, they start with the <code>'#'</code> character, which may be more useful when the query is read from a file.</p> <p>For very long queries that couldn’t easily be split into multiple queries it is possible to break them into multiple lines with a backslash preceding an end of line.</p> <p>For example this query:</p> <pre data-language="python">BerespStatus &gt;= 500
</pre> <p>is identical to this query:</p> <pre data-language="python">BerespStatus \
&gt;= \
500
</pre> <p>A backslash-newline sequence doesn’t continue a comment on the next line and isn’t allowed in a quoted string.</p> <section id="record-selection-criteria"> <h4>Record selection criteria</h4> <p>The record selection criteria determines what kind records from the transaction group the expression applies to. Syntax:</p> <pre data-language="python">{level}taglist:record-prefix[field]
</pre> <p>Taglist is mandatory, the other components are optional.</p> <p>The level limits the expression to a transaction at that level. If left unspecified, the expression is applied to transactions at all levels. Level is a positive integer or zero. If level is followed by a ‘+’ character, it expresses greater than or equal. If level is followed by a ‘-’, it expresses less than or equal.</p> <p>The taglist is a comma-separated list of VSL record tags that this expression should be checked against. Each list element can be a tag name or a tag glob. Globs allow a ‘*’ either in the beginning of the name or at the end, and will select all tags that match either the prefix or subscript. A single ‘*’ will select all tags.</p> <p>The record prefix will further limit the matches to those records that has this prefix as their first part of the record content followed by a colon. The part of the log record matched against will then be limited to what follows the prefix and colon. This is useful when matching against specific HTTP headers. The record prefix matching is done case insensitive.</p> <p>The field will, if present, treat the log record as a white space separated list of fields, and only the nth part of the record will be matched against. Fields start counting at 1.</p> <p>An expression using only a record selection criteria will be true if there is any record in the transaction group that is selected by the criteria.</p> </section> <section id="operators"> <h4>Operators</h4> <p>The following matching operators are available:</p> <ul> <li>
<p>== != &lt; &lt;= &gt; &gt;=</p> <p>Numerical comparison. The record contents will be converted to either an integer or a float before comparison, depending on the type of the operand.</p> </li> <li>
<p>eq ne</p> <p>String comparison. ‘eq’ tests string equality, ‘ne’ tests for not equality.</p> </li> <li>
<p>~ !~</p> <p>Regular expression matching. ‘~’ is a positive match, ‘!~’ is a non-match.</p> </li> </ul> </section> <section id="operand"> <h4>Operand</h4> <p>The operand is the value the selected records will be matched against.</p> <p>An operand can be quoted or unquoted. Quotes can be either single or double quotes, and for quoted operands a backslash can be used to escape the quotes.</p> <p>Unquoted operands can only consist of the following characters:</p> <pre data-language="python">a-z A-Z 0-9 + - _ . *
</pre> <p>The following types of operands are available:</p> <ul> <li>
<p>Integer</p> <p>A number without any fractional part, valid for the numerical comparison operators. The integer type is used when the operand does not contain any period (.) nor exponent (e) characters. However if the record evaluates as a float, only its integral part is used for the comparison.</p> </li> <li>
<p>Float</p> <p>A number with a fractional part, valid for the numerical comparison operators. The float type is used when the operand does contain a period (.) or exponent (e) character.</p> </li> <li>
<p>String</p> <p>A sequence of characters, valid for the string equality operators.</p> </li> <li>
<p>Regular expression</p> <p>A PCRE2 regular expression. Valid for the regular expression operators.</p> </li> </ul> </section> <section id="boolean-functions"> <h4>Boolean functions</h4> <p>Query expressions can be linked together using boolean functions. The following are available, in decreasing precedence:</p> <ul> <li>
<p>not &lt;expr&gt;</p> <p>Inverts the result of &lt;expr&gt;</p> </li> <li>
<p>&lt;expr1&gt; and &lt;expr2&gt;</p> <p>True only if both expr1 and expr2 are true</p> </li> <li>
<p>&lt;expr1&gt; or &lt;expr2&gt;</p> <p>True if either of expr1 or expr2 is true</p> </li> </ul> <p>Expressions can be grouped using parenthesis.</p> </section> </section> <section id="query-expression-examples"> <h3>QUERY EXPRESSION EXAMPLES</h3> <ul> <li>
<p>Transaction group contains a request URL that equals to “/foo”</p> <pre data-language="python">ReqURL eq "/foo"
</pre> </li> <li>
<p>Transaction group contains a request cookie header</p> <pre data-language="python">ReqHeader:cookie
</pre> </li> <li>
<p>Transaction group doesn’t contain a request cookie header</p> <pre data-language="python">not ReqHeader:cookie
</pre> </li> <li>
<p>Client request where internal handling took more than 800ms.:</p> <pre data-language="python">Timestamp:Process[2] &gt; 0.8
</pre> </li> <li>
<p>Transaction group contains a request user-agent header that contains “iPod” and the request delivery time exceeds 1 second</p> <pre data-language="python">ReqHeader:user-agent ~ "iPod" and Timestamp:Resp[2] &gt; 1.
</pre> </li> <li>
<p>Transaction group contains a backend response status larger than or equal to 500</p> <pre data-language="python">BerespStatus &gt;= 500
</pre> </li> <li>
<p>Transaction group contains a request response status of 304, but where the request did not contain an if-modified-since header</p> <pre data-language="python">RespStatus == 304 and not ReqHeader:if-modified-since
</pre> </li> <li>
<p>Transactions that have had backend failures or long delivery time on their ESI subrequests. (Assumes request grouping mode).</p> <pre data-language="python">BerespStatus &gt;= 500 or {2+}Timestamp:Process[2] &gt; 1.
</pre> </li> <li>
<p>Log non-transactional errors. (Assumes raw grouping mode).</p> <pre data-language="python">vxid == 0 and Error
</pre> </li> </ul> </section> <section id="history"> <h3>HISTORY</h3> <p>This document was initially written by Martin Blix Grydeland and amended by others.</p> </section> <section id="copyright"> <h3>COPYRIGHT</h3> <p>This document is licensed under the same licence as Varnish itself. See LICENCE for details.</p> <ul class="simple"> <li>Copyright (c) 2006 Verdens Gang AS</li> <li>Copyright (c) 2006-2015 Varnish Software AS</li> </ul> </section> </section><div class="_attribution">
  <p class="_attribution-p">
    Copyright &copy; 2006 Verdens Gang AS<br>Copyright &copy; 2006&ndash;2020 Varnish Software AS<br>Licensed under the BSD-2-Clause License.<br>
    <a href="https://varnish-cache.org/docs/7.4/reference/vsl-query.html" class="_attribution-link">https://varnish-cache.org/docs/7.4/reference/vsl-query.html</a>
  </p>
</div>
