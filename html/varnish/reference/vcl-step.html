<h1 id="vcl-step-7">VCL-steps</h1> <section id="built-in-subroutines"> <h2>Built-in subroutines</h2> <dl class="field-list simple"> <dt class="field-odd">Manual section<span class="colon">:</span>
</dt> <dd class="field-odd">
<p>7</p> </dd> </dl> <section id="description"> <h3>DESCRIPTION</h3> <p>Various built-in subroutines are called during processing of client and backend requests as well as upon <code>vcl.load</code> and <code>vcl.discard</code>.</p> <p>See <a class="reference internal" href="states.html#reference-states"><span class="std std-ref">Varnish Processing States</span></a> for a detailed graphical overview of the states and how they relate to core code functions and VCL subroutines.</p> <p>Built-in subroutines always terminate with a <code>return (&lt;action&gt;)</code>, where <code>&lt;action&gt;</code> determines how processing continues in the request processing state machine.</p> <p>The behaviour of actions is identical or at least similar across subroutines, so differences are only documented where relevant.</p> <p>Common actions are documented in <a class="reference internal" href="#vcl-actions"><span class="std std-ref">VCL Actions</span></a> in the next section. Actions specific to only one or some subroutines are documented in <a class="reference internal" href="#id7"><span class="std std-ref">VCL Steps</span></a>.</p> <p>A default behavior is provided for all <a class="reference internal" href="states.html#reference-states"><span class="std std-ref">Varnish Processing States</span></a> in the <a class="reference internal" href="../users-guide/vcl-built-in-code.html#vcl-built-in-code"><span class="std std-ref">Built-in VCL</span></a> code.</p> </section> <section id="vcl-actions"> <h3 id="id1">VCL Actions</h3> <p>Actions are used with the <code>return(&lt;action&gt;)</code> keyword, which returns control from subroutines back to varnish. The action determines how processing in varnish continues as shown in <a class="reference internal" href="states.html#reference-states"><span class="std std-ref">Varnish Processing States</span></a>.</p> <p>Common actions are documented here, while additional actions specific to only one or some subroutines are documented in the next section <a class="reference internal" href="#id7"><span class="std std-ref">VCL Steps</span></a> as well as which action can be used from which built in subroutine.</p> <section id="common-actions-for-the-client-and-backend-side"> <h4>Common actions for the client and backend side</h4> <section id="fail"> <h5 id="id2"><code>fail</code></h5>  <p>Transition to <a class="reference internal" href="#vcl-synth"><span class="std std-ref">vcl_synth</span></a> on the client side as for <code>return(synth(503, "VCL Failed"))</code>, but with any request state changes undone as if <code>std.rollback()</code> was called and forcing a connection close.</p> <p>Intended for fatal errors, for which only minimal error handling is possible.</p>  </section> </section> <section id="common-actions-for-the-client-side"> <h4>Common actions for the client side</h4> <section id="synth-status-code-reason"> <h5 id="synth"><code>synth(status code, reason)</code></h5>  <p>Transition to <a class="reference internal" href="#vcl-synth"><span class="std std-ref">vcl_synth</span></a> with <code>resp.status</code> and <code>resp.reason</code> being preset to the arguments of <code>synth()</code>.</p>  </section> <section id="pass"> <h5 id="id3"><code>pass</code></h5>  <p>Switch to pass mode, making the current request not use the cache and not putting its response into it. Control will eventually pass to <a class="reference internal" href="#vcl-pass"><span class="std std-ref">vcl_pass</span></a>.</p>  </section> <section id="pipe"> <h5 id="id4"><code>pipe</code></h5>  <p>Switch to pipe mode. Control will eventually pass to <a class="reference internal" href="#vcl-pipe"><span class="std std-ref">vcl_pipe</span></a>.</p>  </section> <section id="restart"> <h5 id="id5"><code>restart</code></h5>  <p>Restart the transaction. Increases the <code>req.restarts</code> counter.</p> <p>If the number of restarts is higher than the <em>max_restarts</em> parameter, control is passed to <a class="reference internal" href="#vcl-synth"><span class="std std-ref">vcl_synth</span></a> as for <code>return(synth(503, "Too many restarts"))</code></p> <p>For a restart, all modifications to <code>req</code> attributes are preserved except for <code>req.restarts</code> and <code>req.xid</code>, which need to change by design.</p>  </section> </section> <section id="common-actions-for-the-backend-side"> <h4>Common actions for the backend side</h4> <section id="abandon"> <h5 id="id6"><code>abandon</code></h5>  <p>Abandon the backend request. Unless the backend request was a background fetch, control is passed to <a class="reference internal" href="#vcl-synth"><span class="std std-ref">vcl_synth</span></a> on the client side with <code>resp.status</code> preset to 503.</p>  </section> </section> </section> <section id="id7"> <h3 id="id8">VCL Steps</h3> <section id="client-side"> <h4>Client side</h4> <section id="vcl-recv"> <h5 id="id9">vcl_recv</h5> <p>Called at the beginning of a request, after the complete request has been received and parsed, after a <code>restart</code> or as the result of an ESI include.</p> <p>Its purpose is to decide whether or not to serve the request, possibly modify it and decide on how to process it further. A backend hint may be set as a default for the backend processing side.</p> <p>The <code>vcl_recv</code> subroutine may terminate with calling <code>return()</code> on one of the following keywords:</p>    </section> <section id="vcl-pipe"> <h5 id="id10">vcl_pipe</h5> <p>Called upon entering pipe mode. In this mode, the request is passed on to the backend, and any further data from both the client and backend is passed on unaltered until either end closes the connection. Basically, Varnish will degrade into a simple TCP proxy, shuffling bytes back and forth. For a connection in pipe mode, no other VCL subroutine will ever get called after <code>vcl_pipe</code>.</p> <p>The <code>vcl_pipe</code> subroutine may terminate with calling <code>return()</code> with one of the following keywords:</p>    </section> <section id="vcl-pass"> <h5 id="id11">vcl_pass</h5> <p>Called upon entering pass mode. In this mode, the request is passed on to the backend, and the backendâ€™s response is passed on to the client, but is not entered into the cache. Subsequent requests submitted over the same client connection are handled normally.</p> <p>The <code>vcl_pass</code> subroutine may terminate with calling <code>return()</code> with one of the following keywords:</p>    </section> <section id="vcl-hash"> <h5 id="id12">vcl_hash</h5> <p>Called after <code>vcl_recv</code> to create a hash value for the request. This is used as a key to look up the object in Varnish.</p> <p>The <code>vcl_hash</code> subroutine may terminate with calling <code>return()</code> with one of the following keywords:</p>    </section> <section id="vcl-purge"> <h5 id="id13">vcl_purge</h5> <p>Called after the purge has been executed and all its variants have been evicted.</p> <p>The <code>vcl_purge</code> subroutine may terminate with calling <code>return()</code> with one of the following keywords:</p>    </section> <section id="vcl-miss"> <h5 id="id14">vcl_miss</h5> <p>Called after a cache lookup if the requested document was not found in the cache or if <a class="reference internal" href="#vcl-hit"><span class="std std-ref">vcl_hit</span></a> returned <code>fetch</code>.</p> <p>Its purpose is to decide whether or not to attempt to retrieve the document from the backend. A backend hint may be set as a default for the backend processing side.</p> <p>The <code>vcl_miss</code> subroutine may terminate with calling <code>return()</code> with one of the following keywords:</p>    </section> <section id="vcl-hit"> <h5 id="id15">vcl_hit</h5> <p>Called when a cache lookup is successful. The object being hit may be stale: It can have a zero or negative <code>ttl</code> with only <code>grace</code> or <code>keep</code> time left.</p> <p>The <code>vcl_hit</code> subroutine may terminate with calling <code>return()</code> with one of the following keywords:</p>    </section> <section id="vcl-deliver"> <h5 id="id16">vcl_deliver</h5> <p>Called before any object except a <code>vcl_synth</code> result is delivered to the client.</p> <p>The <code>vcl_deliver</code> subroutine may terminate with calling <code>return()</code> with one of the following keywords:</p>    </section> <section id="vcl-synth"> <h5 id="id17">vcl_synth</h5> <p>Called to deliver a synthetic object. A synthetic object is generated in VCL, not fetched from the backend. Its body may be constructed using the <code>synthetic()</code> function.</p> <p>A <code>vcl_synth</code> defined object never enters the cache, contrary to a <a class="reference internal" href="#vcl-backend-error"><span class="std std-ref">vcl_backend_error</span></a> defined object, which may end up in cache.</p> <p>The subroutine may terminate with calling <code>return()</code> with one of the following keywords:</p>    </section> </section> <section id="backend-side"> <h4>Backend Side</h4> <section id="vcl-backend-fetch"> <h5 id="id18">vcl_backend_fetch</h5> <p>Called before sending the backend request. In this subroutine you typically alter the request before it gets to the backend.</p> <p>The <code>vcl_backend_fetch</code> subroutine may terminate with calling <code>return()</code> with one of the following keywords:</p>    <p>Before calling <code>vcl_backend_fetch</code>, Varnish core prepares the <code>bereq</code> backend request as follows:</p> <ul class="simple"> <li>
<p>Unless the request is a <code>pass</code>,</p> <ul> <li>set <code>bereq.method</code> to <code>GET</code> and <code>bereq.proto</code> to <code>HTTP/1.1</code> and</li> <li>set <code>bereq.http.Accept_Encoding</code> to <code>gzip</code> if <a class="reference internal" href="varnishd.html#ref-param-http-gzip-support"><span class="std std-ref">http_gzip_support</span></a> is enabled.</li> </ul> </li> <li>If there is an existing cache object to be revalidated, set <code>bereq.http.If-Modified-Since</code> from its <code>Last-Modified</code> header and/or set <code>bereq.http.If-None-Match</code> from its <code>Etag</code> header</li> <li>Set <code>bereq.http.X-Varnish</code> to the current transaction id (<code>vxid</code>)</li> </ul> <p>These changes can be undone or modified in <code>vcl_backend_fetch</code> before the backend request is issued.</p> <p>In particular, to cache non-GET requests, <code>req.method</code> needs to be saved to a header or variable in <a class="reference internal" href="#vcl-recv"><span class="std std-ref">vcl_recv</span></a> and restored to <code>bereq.method</code>. Notice that caching non-GET requests typically also requires changing the cache key in <a class="reference internal" href="#vcl-hash"><span class="std std-ref">vcl_hash</span></a> e.g. by also hashing the request method and/or request body.</p> <p>HEAD request can be satisfied from cached GET responses.</p> </section> <section id="vcl-backend-response"> <h5 id="id19">vcl_backend_response</h5> <p>Called after the response headers have been successfully retrieved from the backend.</p> <p>The <code>vcl_backend_response</code> subroutine may terminate with calling <code>return()</code> with one of the following keywords:</p>    </section> <section id="vcl-backend-error"> <h5 id="id20">vcl_backend_error</h5> <p>This subroutine is called if we fail the backend fetch or if <em>max_retries</em> has been exceeded.</p> <p>Returning with <a class="reference internal" href="#abandon"><span class="std std-ref">abandon</span></a> does not leave a cache object.</p> <p>If returning with <code>deliver</code> and a <code>beresp.ttl &gt; 0s</code>, a synthetic cache object is generated in VCL, whose body may be constructed using the <code>synthetic()</code> function.</p> <p>When there is a waiting list on the object, the default <code>ttl</code> will be positive (currently one second), set before entering <code>vcl_backend_error</code>. This is to avoid request serialization and hammering on a potentially failing backend.</p> <p>Since these synthetic objects are cached in these special circumstances, be cautious with putting private information there. If you really must, then you need to explicitly set <code>beresp.ttl</code> to zero in <code>vcl_backend_error</code>.</p> <p>The <code>vcl_backend_error</code> subroutine may terminate with calling <code>return()</code> with one of the following keywords:</p>    </section> </section> <section id="during-vcl-load-vcl-discard"> <h4>During vcl.load / vcl.discard</h4> <section id="vcl-init"> <h5 id="id21">vcl_init</h5> <p>Called when VCL is loaded, before any requests pass through it. Typically used to initialize VMODs.</p> <p>The <code>vcl_init</code> subroutine may terminate with calling <code>return()</code> with one of the following keywords:</p>    </section> <section id="vcl-fini"> <h5 id="id22">vcl_fini</h5> <p>Called when VCL is discarded only after all requests have exited the VCL. Typically used to clean up VMODs.</p> <p>The <code>vcl_fini</code> subroutine may terminate with calling <code>return()</code> with one of the following keywords:</p>    </section> </section> </section> <section id="see-also"> <h3>SEE ALSO</h3> <ul class="simple"> <li><a class="reference internal" href="varnishd.html#varnishd-1"><span class="std std-ref">varnishd</span></a></li> <li><a class="reference internal" href="vcl.html#vcl-7"><span class="std std-ref">VCL</span></a></li> </ul> </section> <section id="copyright"> <h3>COPYRIGHT</h3> <p>This document is licensed under the same license as Varnish itself. See LICENSE for details.</p> <ul class="simple"> <li>Copyright (c) 2006 Verdens Gang AS</li> <li>Copyright (c) 2006-2021 Varnish Software AS</li> </ul> </section> </section><div class="_attribution">
  <p class="_attribution-p">
    Copyright &copy; 2006 Verdens Gang AS<br>Copyright &copy; 2006&ndash;2020 Varnish Software AS<br>Licensed under the BSD-2-Clause License.<br>
    <a href="https://varnish-cache.org/docs/7.4/reference/vcl-step.html" class="_attribution-link">https://varnish-cache.org/docs/7.4/reference/vcl-step.html</a>
  </p>
</div>
