<h1>   <span>Changelog for v3.x</span> </h1> <h2 id="v3-8-4-2022-06-04" class="section-heading">  v3.8.4 (2022-06-04) </h2> <h3 id="enhancements" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Multi] Add <code class="inline">one/2</code> and <code class="inline">all/2</code> functions</li>
<li>[Ecto.Query] Support <code class="inline">literal(...)</code> in <code class="inline">fragment</code>
</li>
</ul>
<h3 id="bug-fix" class="section-heading">  Bug fix </h3> <ul><li>[Ecto.Schema] Make sure fields are inspected in the correct order in Elixir v1.14+</li></ul>
<h2 id="v3-8-3-2022-05-11" class="section-heading">  v3.8.3 (2022-05-11) </h2> <h3 id="bug-fix-1" class="section-heading">  Bug fix </h3> <ul>
<li>[Ecto.Query] Allow source aliases to be used in <code class="inline">type/2</code>
</li>
<li>[Ecto.Schema] Avoid "undefined behaviour/struct" warnings and errors during compilation</li>
</ul>
<h2 id="v3-8-2-2022-05-05" class="section-heading">  v3.8.2 (2022-05-05) </h2> <h3 id="bug-fix-2" class="section-heading">  Bug fix </h3> <ul>
<li>[Ecto.Adapter] Do not require adapter metadata to be raw maps</li>
<li>[Ecto.Association] Respect <code class="inline">join_where</code> in many to many <code class="inline">on_replace</code> deletes</li>
<li>[Ecto.Changeset] Check if list is in <code class="inline">empty_values</code> before nested validations</li>
</ul>
<h2 id="v3-8-1-2022-04-27" class="section-heading">  v3.8.1 (2022-04-27) </h2> <h3 id="bug-fix-3" class="section-heading">  Bug fix </h3> <ul><li>[Ecto.Query] Fix regression where a join's on parameter on <code class="inline">update_all</code> was out of order</li></ul>
<h2 id="v3-8-0-2022-04-26" class="section-heading">  v3.8.0 (2022-04-26) </h2> <p>Ecto v3.8 requires Elixir v1.10+.</p>
<h3 id="enhancements-1" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto] Add new Embedded chapter to Introductory guides</li>
<li>[Ecto.Changeset] Allow custom <code class="inline">:error_key</code> in unique_constraint</li>
<li>[Ecto.Changeset] Add <code class="inline">:match</code> option to all constraint functions</li>
<li>[Ecto.Query] Support dynamic aliases</li>
<li>[Ecto.Query] Allow using <code class="inline">type/2</code> with virtual fields</li>
<li>[Ecto.Query] Suggest alternatives to inexistent fields in queries</li>
<li>[Ecto.Query] Support passing queries using subqueries to <code class="inline">insert_all</code>
</li>
<li>[Ecto.Repo] Allow <code class="inline">stacktrace: true</code> so stacktraces are included in telemetry events and logs</li>
<li>[Ecto.Schema] Validate options given to schema fields</li>
</ul>
<h3 id="bug-fixes" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Changeset] Address regression on <code class="inline">validate_subset</code> no longer working with custom array types</li>
<li>[Ecto.Changeset] <strong>Potentially breaking change</strong>: Detect <code class="inline">empty_values</code> inside lists when casting. This may cause issues if you were relying on the casting of empty values (by default, only <code class="inline">""</code>).</li>
<li>[Ecto.Query] Handle atom list sigils in <code class="inline">select</code>
</li>
<li>[Ecto.Query] Improve tracking of <code class="inline">select_merge</code> inside subqueries</li>
<li>[Ecto.Repo] Properly handle literals in queries given to <code class="inline">insert_all</code>
</li>
<li>[Ecto.Repo] Don't surface persisted data as changes on embed updates</li>
<li>[Ecto.Schema] Preserve parent prefix on join tables</li>
</ul>
<h2 id="v3-7-2-2022-03-13" class="section-heading">  v3.7.2 (2022-03-13) </h2> <h3 id="enhancements-2" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Schema] Add option to skip validations for default values</li>
<li>[Ecto.Query] Allow coalesce in <code class="inline">type/2</code>
</li>
<li>[Ecto.Query] Support parameterized types in type/2</li>
<li>[Ecto.Query] Allow arbitrary parentheses in query expressions</li>
</ul>
<h2 id="v3-7-1-2021-08-27" class="section-heading">  v3.7.1 (2021-08-27) </h2> <h3 id="enhancements-3" class="section-heading">  Enhancements </h3> <ul><li>[Ecto.Embedded] Make <a href="ecto.embedded.html"><code class="inline">Ecto.Embedded</code></a> public and describe struct fields</li></ul>
<h3 id="bug-fixes-1" class="section-heading">  Bug fixes </h3> <ul><li>[Ecto.Repo] Make sure parent changeset is included in changes for <code class="inline">insert</code>/<code class="inline">update</code>/<code class="inline">delete</code> when there are errors processing the parent itself</li></ul>
<h2 id="v3-7-0-2021-08-19" class="section-heading">  v3.7.0 (2021-08-19) </h2> <h3 id="enhancements-4" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Changeset] Add <a href="ecto.changeset.html#traverse_validations/2"><code class="inline">Ecto.Changeset.traverse_validations/2</code></a>
</li>
<li>[Ecto.Enum] Add <a href="ecto.enum.html#mappings/2"><code class="inline">Ecto.Enum.mappings/2</code></a> and <a href="ecto.enum.html#dump_values/2"><code class="inline">Ecto.Enum.dump_values/2</code></a>
</li>
<li>[Ecto.Query] Add support for dynamic <code class="inline">as(^as)</code> and <code class="inline">parent_as(^as)</code>
</li>
<li>[Ecto.Repo] Add stale changeset to <a href="ecto.staleentryerror.html"><code class="inline">Ecto.StaleEntryError</code></a> fields</li>
<li>[Ecto.Schema] Add support for <code class="inline">@schema_context</code> to set context metadata on schema definition</li>
</ul>
<h3 id="bug-fixes-2" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Changeset] Fix changeset inspection not redacting when embedded</li>
<li>[Ecto.Changeset] Use semantic comparison on <code class="inline">validate_inclusion</code>, <code class="inline">validate_exclusion</code>, and <code class="inline">validate_subset</code>
</li>
<li>[Ecto.Enum] Raise on duplicate values in <a href="ecto.enum.html"><code class="inline">Ecto.Enum</code></a>
</li>
<li>[Ecto.Query] Make sure <code class="inline">hints</code> are included in the query cache</li>
<li>[Ecto.Repo] Support placeholders in <code class="inline">insert_all</code> without schemas</li>
<li>[Ecto.Repo] Wrap in a subquery when query given to <code class="inline">Repo.aggregate</code> has combination</li>
<li>[Ecto.Repo] Fix CTE subqueries not finding parent bindings</li>
<li>[Ecto.Repo] Return changeset with assocs if any of the assocs are invalid</li>
</ul>
<h2 id="v3-6-2-2021-05-28" class="section-heading">  v3.6.2 (2021-05-28) </h2> <h3 id="enhancements-5" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Query] Support macros in <code class="inline">with_cte</code>
</li>
<li>[Ecto.Repo] Add <a href="ecto.repo.html#all_running/0"><code class="inline">Ecto.Repo.all_running/0</code></a> to list all running repos</li>
</ul>
<h3 id="bug-fixes-3" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Query] Do not omit nil fields in a subquery select</li>
<li>[Ecto.Query] Allow <code class="inline">parent_as</code> to look for an alias all the way up across subqueries</li>
<li>[Ecto.Query] Raise if a nil value is given to a query from a nested map parameter</li>
<li>[Ecto.Query] Fix <code class="inline">insert_all</code> when using both <code class="inline">:on_conflict</code> and <code class="inline">:placeholders</code>
</li>
<li>[mix ecto.load] Do not pass <code class="inline">--force</code> to underlying compile task</li>
</ul>
<h2 id="v3-6-1-2021-04-12" class="section-heading">  v3.6.1 (2021-04-12) </h2> <h3 id="enhancements-6" class="section-heading">  Enhancements </h3> <ul><li>[Ecto.Changeset] Allow the <code class="inline">:query</code> option in <code class="inline">unsafe_validate_unique</code>
</li></ul>
<h3 id="bug-fixes-4" class="section-heading">  Bug fixes </h3> <ul><li>[Ecto.Changeset] Add the relation id in <code class="inline">apply_changes</code> if the relation key exists (instead of hardcoding it to <code class="inline">id</code>)</li></ul>
<h2 id="v3-6-0-2021-04-03" class="section-heading">  v3.6.0 (2021-04-03) </h2> <h3 id="enhancements-7" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Changeset] Support <code class="inline">:repo_opts</code> in <code class="inline">unsafe_validate_unique</code>
</li>
<li>[Ecto.Changeset] Add a validation error if trying to cast a cardinality one embed/assoc with anything other than a map or keyword list</li>
<li>[Ecto.Enum] Allow enums to map to custom values</li>
<li>[Ecto.Multi] Add <a href="ecto.multi.html#put/3"><code class="inline">Ecto.Multi.put/3</code></a> for directly storing values</li>
<li>[Ecto.Query] <strong>Potentially breaking change</strong>: optimize <code class="inline">many_to_many</code> queries so it no longer load intermediary tables in more occasions. This may cause issues if you are using <a href="ecto.html#assoc/2"><code class="inline">Ecto.assoc/2</code></a> to load <code class="inline">many_to_many</code> associations and then trying to access intermediate bindings (which is discouraged but it was possible)</li>
<li>[Ecto.Repo] Allow <code class="inline">insert_all</code> to be called with a query instead of rows</li>
<li>[Ecto.Repo] Add <code class="inline">:placeholders</code> support to <code class="inline">insert_all</code> to avoid sending the same value multiple times</li>
<li>[Ecto.Schema] Support <code class="inline">:preload_order</code> on <code class="inline">has_many</code> and <code class="inline">many_to_many</code> associations</li>
<li>[Ecto.UUID] Add bang UUID conversion methods</li>
<li>[Ecto.Query] The <code class="inline">:hints</code> option now accepts dynamic values when supplied as tuples</li>
<li>[Ecto.Query] Support <code class="inline">select: map(source, fields)</code> where <code class="inline">source</code> is a fragment</li>
<li>[Ecto.Query] Allow referring to the parent query in a join's subquery select via <code class="inline">parent_as</code>
</li>
<li>[mix ecto] Support file and line interpolation on <code class="inline">ECTO_EDITOR</code>
</li>
</ul>
<h3 id="bug-fixes-5" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Changeset] Change <code class="inline">apply_changes/1</code> to add the relation to the <code class="inline">struct.relation_id</code> if relation struct is persisted</li>
<li>[Ecto.Query] Remove unnecessary INNER JOIN in many to many association query</li>
<li>[Ecto.Query] Allow parametric types to be interpolated in queries</li>
<li>[Ecto.Schema] Raise <a href="https://hexdocs.pm/elixir/ArgumentError.html"><code class="inline">ArgumentError</code></a> when default has invalid type</li>
</ul>
<h2 id="v3-5-8-2021-02-21" class="section-heading">  v3.5.8 (2021-02-21) </h2> <h3 id="enhancements-8" class="section-heading">  Enhancements </h3> <ul><li>[Ecto.Query] Support map/2 on fragments and subqueries</li></ul>
<h2 id="v3-5-7-2021-02-07" class="section-heading">  v3.5.7 (2021-02-07) </h2> <h3 id="bug-fixes-6" class="section-heading">  Bug fixes </h3> <ul><li>[Ecto.Query] Fixes param ordering issue on dynamic queries with subqueries</li></ul>
<h2 id="v3-5-6-2021-01-20" class="section-heading">  v3.5.6 (2021-01-20) </h2> <h3 id="enhancements-9" class="section-heading">  Enhancements </h3> <ul><li>[Ecto.Schema] Support <code class="inline">on_replace: :delete_if_exists</code> on associations</li></ul>
<h3 id="bug-fixes-7" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Query] Allow unary minus operator in query expressions</li>
<li>[Ecto.Schema] Allow nil values on typed maps</li>
</ul>
<h2 id="v3-5-5-2020-11-12" class="section-heading">  v3.5.5 (2020-11-12) </h2> <h3 id="enhancements-10" class="section-heading">  Enhancements </h3> <ul><li>[Ecto.Query] Add support for subqueries operators: <code class="inline">all</code>, <code class="inline">any</code>, and <code class="inline">exists</code>
</li></ul>
<h3 id="bug-fixes-8" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Changeset] Use association source on <code class="inline">put_assoc</code> with maps/keywords</li>
<li>[Ecto.Enum] Add <code class="inline">cast</code> clause for nil values on <a href="ecto.enum.html"><code class="inline">Ecto.Enum</code></a>
</li>
<li>[Ecto.Schema] Allow nested type <code class="inline">:any</code> for non-virtual fields</li>
</ul>
<h2 id="v3-5-4-2020-10-28" class="section-heading">  v3.5.4 (2020-10-28) </h2> <h3 id="enhancements-11" class="section-heading">  Enhancements </h3> <ul>
<li>[mix ecto.drop] Provide <code class="inline">--force-drop</code> for databases that may support it</li>
<li>[guides] Add new "Multi tenancy with foreign keys" guide</li>
</ul>
<h3 id="bug-fixes-9" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Changeset] Make keys optional in specs</li>
<li>[Ecto.Enum] Make sure <code class="inline">values/2</code> works for virtual fields</li>
<li>[Ecto.Query] Fix missing type on CTE queries that select a single field</li>
</ul>
<h2 id="v3-5-3-2020-10-21" class="section-heading">  v3.5.3 (2020-10-21) </h2> <h3 id="bug-fixes-10" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Query] Do not reset parameter counter for nested CTEs</li>
<li>[Ecto.Type] Fix regression where array type with nils could no longer be cast/load/dump</li>
<li>[Ecto.Type] Fix CaseClauseError when casting a decimal with a binary remainder</li>
</ul>
<h2 id="v3-5-2-2020-10-12" class="section-heading">  v3.5.2 (2020-10-12) </h2> <h3 id="enhancements-12" class="section-heading">  Enhancements </h3> <ul><li>[Ecto.Repo] Add Repo.reload/2 and Repo.reload!/2</li></ul>
<h3 id="bug-fixes-11" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Changeset] Fix "<strong>schema</strong>/1 is undefined or private" error while inspecting a schemaless changeset</li>
<li>[Ecto.Repo] Invoke <a href="ecto.repo.html#c:default_options/1"><code class="inline">Ecto.Repo.default_options/1</code></a> per entry-point operation</li>
</ul>
<h2 id="v3-5-1-2020-10-08" class="section-heading">  v3.5.1 (2020-10-08) </h2> <h3 id="enhancements-13" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Changeset] Warn if there are duplicate IDs in the parent schema for <code class="inline">cast_assoc/3</code>/<code class="inline">cast_embed/3</code>
</li>
<li>[Ecto.Schema] Allow <code class="inline">belongs_to</code> to accept options for parameterized types</li>
</ul>
<h3 id="bug-fixes-12" class="section-heading">  Bug fixes </h3> <ul><li>[Ecto.Query] Keep field types when using a subquery with source</li></ul>
<h2 id="v3-5-0-2020-10-03" class="section-heading">  v3.5.0 (2020-10-03) </h2> <p>v3.5 requires Elixir v1.8+.</p>
<h3 id="bug-fixes-13" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Changeset] Ensure <code class="inline">:empty_values</code> in <code class="inline">cast/4</code> does not automatically propagate to following cast calls. If you want a given set of <code class="inline">:empty_values</code> to apply to all <code class="inline">cast/4</code> calls, change the value stored in <code class="inline">changeset.empty_values</code> instead</li>
<li>[Ecto.Changeset] <strong>Potentially breaking change</strong>: Do not force repository updates to happen when using <code class="inline">optimistic_lock</code>. The lock field will only be incremented if the record has other changes. If no changes, nothing happens.</li>
<li>[Ecto.Changeset] Do not automatically share empty values across <code class="inline">cast/3</code> calls</li>
<li>[Ecto.Query] Consider query prefix in cte/combination query cache</li>
<li>[Ecto.Query] Allow the entry to be marked as nil when using left join with subqueries</li>
<li>[Ecto.Query] Support subqueries inside dynamic expressions</li>
<li>[Ecto.Repo] Fix preloading when using dynamic repos and the sandbox in automatic mode</li>
<li>[Ecto.Repo] Do not duplicate collections when associations are preloaded for repeated elements</li>
</ul>
<h3 id="enhancements-14" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Enum] Add <a href="ecto.enum.html"><code class="inline">Ecto.Enum</code></a> as a custom parameterized type</li>
<li>[Ecto.Query] Allow <code class="inline">:prefix</code> in <code class="inline">from</code> to be set to nil</li>
<li>[Ecto.Query] Do not restrict subqueries in <code class="inline">where</code> to map/struct types</li>
<li>[Ecto.Query] Allow atoms in query without interpolation in order to support Ecto.Enum</li>
<li>[Ecto.Schema] Do not validate uniqueness if there is a prior error on the field</li>
<li>[Ecto.Schema] Allow <code class="inline">redact: true</code> in <code class="inline">field</code>
</li>
<li>[Ecto.Schema] Support parameterized types via <a href="ecto.parameterizedtype.html"><code class="inline">Ecto.ParameterizedType</code></a>
</li>
<li>[Ecto.Schema] Rewrite embeds and assocs as parameterized types. This means <code class="inline">__schema__(:type, assoc_or_embed)</code> now returns a parameterized type. To check if something is an association, use <code class="inline">__schema__(:assocs)</code> or <code class="inline">__schema__(:embeds)</code> instead</li>
</ul>
<h2 id="v3-4-6-2020-08-07" class="section-heading">  v3.4.6 (2020-08-07) </h2> <h3 id="enhancements-15" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Query] Allow <code class="inline">count/0</code> on <code class="inline">type/2</code>
</li>
<li>[Ecto.Multi] Support anonymous functions in multiple functions</li>
</ul>
<h3 id="bug-fixes-14" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Query] Consider booleans as literals in unions, subqueries, ctes, etc</li>
<li>[Ecto.Schema] Generate IDs for nested embeds</li>
</ul>
<h2 id="v3-4-5-2020-06-14" class="section-heading">  v3.4.5 (2020-06-14) </h2> <h3 id="enhancements-16" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Changeset] Allow custom error key in <code class="inline">unsafe_validate_unique</code>
</li>
<li>[Ecto.Changeset] Improve performance when casting large params maps</li>
</ul>
<h3 id="bug-fixes-15" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Changeset] Improve error message for invalid <code class="inline">cast_assoc</code>
</li>
<li>[Ecto.Query] Fix inspecting query with fragment CTE</li>
<li>[Ecto.Query] Fix inspecting dynamics with aliased bindings</li>
<li>[Ecto.Query] Improve error message when selecting a single atom</li>
<li>[Ecto.Repo] Reduce data-copying when preloading multiple associations</li>
<li>[Ecto.Schema] Do not define a compile-time dependency for schema in <code class="inline">:join_through</code>
</li>
</ul>
<h2 id="v3-4-4-2020-05-11" class="section-heading">  v3.4.4 (2020-05-11) </h2> <h3 id="enhancements-17" class="section-heading">  Enhancements </h3> <ul><li>[Ecto.Schema] Add <code class="inline">join_where</code> support to <code class="inline">many_to_many</code>
</li></ul>
<h2 id="v3-4-3-2020-04-27" class="section-heading">  v3.4.3 (2020-04-27) </h2> <h3 id="enhancements-18" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Query] Support <code class="inline">as/1</code> and <code class="inline">parent_as/1</code> for lazy named bindings and to allow parent references from subqueries</li>
<li>[Ecto.Query] Support <code class="inline">x in subquery(query)</code>
</li>
</ul>
<h3 id="bug-fixes-16" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Query] Do not raise for missing assocs if :force is given to preload</li>
<li>[Ecto.Repo] Return error from <code class="inline">Repo.delete</code> on invalid changeset from <code class="inline">prepare_changeset</code>
</li>
</ul>
<h2 id="v3-4-2-2020-04-10" class="section-heading">  v3.4.2 (2020-04-10) </h2> <h3 id="enhancements-19" class="section-heading">  Enhancements </h3> <ul><li>[Ecto.Changeset] Support multiple fields in <code class="inline">unique_constraint/3</code>
</li></ul>
<h2 id="v3-4-1-2020-04-08" class="section-heading">  v3.4.1 (2020-04-08) </h2> <h3 id="enhancements-20" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto] Add <a href="ecto.html#embedded_load/3"><code class="inline">Ecto.embedded_load/3</code></a> and <a href="ecto.html#embedded_dump/2"><code class="inline">Ecto.embedded_dump/2</code></a>
</li>
<li>[Ecto.Query] Improve error message on invalid JSON expressions</li>
<li>[Ecto.Repo] Emit <code class="inline">[:ecto, :repo, :init]</code> telemetry event upon Repo init</li>
</ul>
<h3 id="bug-fixes-17" class="section-heading">  Bug fixes </h3> <ul><li>[Ecto.Query] Do not support JSON selectors on <code class="inline">type/2</code>
</li></ul>
<h3 id="deprecations" class="section-heading">  Deprecations </h3> <ul><li>[Ecto.Repo] Deprecate <code class="inline">conflict_target: {:constraint, _}</code>. It is a discouraged approach and <code class="inline">{:unsafe_fragment, _}</code> is still available if someone definitely needs it</li></ul>
<h2 id="v3-4-0-2020-03-24" class="section-heading">  v3.4.0 (2020-03-24) </h2> <p>v3.4 requires Elixir v1.7+.</p>
<h3 id="enhancements-21" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Query] Allow dynamic queries in CTE and improve error message</li>
<li>[Ecto.Query] Add <a href="ecto.query.api.html#json_extract_path/2"><code class="inline">Ecto.Query.API.json_extract_path/2</code></a> and JSON path support to query syntax. For example, <code class="inline">posts.metadata["tags"][0]["name"]</code> will return the name of the first tag stored in the <code class="inline">:map</code> metadata field</li>
<li>[Ecto.Repo] Add new <code class="inline">default_options/1</code> callback to repository</li>
<li>[Ecto.Repo] Support passing <code class="inline">:telemetry_options</code> to repository operations</li>
</ul>
<h3 id="bug-fixes-18" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Changeset] Properly add validation annotation to <code class="inline">validate_acceptance</code>
</li>
<li>[Ecto.Query] Raise if there is loaded non-empty association data without related key when preloading. This typically means not all fields have been loaded in a query</li>
<li>[Ecto.Schema] Show meaningful error in case <code class="inline">schema</code> is invoked twice in an <a href="ecto.schema.html"><code class="inline">Ecto.Schema</code></a>
</li>
</ul>
<h2 id="v3-3-4-2020-02-27" class="section-heading">  v3.3.4 (2020-02-27) </h2> <h3 id="bug-fixes-19" class="section-heading">  Bug fixes </h3> <ul>
<li>[mix ecto] Do not rely on map ordering when parsing repos</li>
<li>[mix ecto.gen.repo] Improve error message when a repo is not given</li>
</ul>
<h2 id="v3-3-3-2020-02-14" class="section-heading">  v3.3.3 (2020-02-14) </h2> <h3 id="enhancements-22" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Query] Support fragments in <code class="inline">lock</code>
</li>
<li>[Ecto.Query] Handle <code class="inline">nil</code> in <code class="inline">select_merge</code> with similar semantics to SQL databases (i.e. it simply returns <code class="inline">nil</code> itself)</li>
</ul>
<h2 id="v3-3-2-2020-01-28" class="section-heading">  v3.3.2 (2020-01-28) </h2> <h3 id="enhancements-23" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Changeset] Only bump optimistic lock in case of success</li>
<li>[Ecto.Query] Allow macros in Ecto window expressions</li>
<li>[Ecto.Schema] Support <code class="inline">:join_defaults</code> on <code class="inline">many_to_many</code> associations</li>
<li>[Ecto.Schema] Allow MFargs to be given to association <code class="inline">:defaults</code>
</li>
<li>[Ecto.Type] Add <code class="inline">Ecto.Type.embedded_load</code> and <code class="inline">Ecto.Type.embedded_dump</code>
</li>
</ul>
<h3 id="bug-fixes-20" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Repo] Ignore empty hostname when parsing database url (Elixir v1.10 support)</li>
<li>[Ecto.Repo] Rewrite combinations on Repo.exists? queries</li>
<li>[Ecto.Schema] Respect child <code class="inline">@schema_prefix</code> in <code class="inline">cast_assoc</code>
</li>
<li>[mix ecto.gen.repo] Use <code class="inline">config_path</code> when writing new config in <a href="mix.tasks.ecto.gen.repo.html"><code class="inline">mix ecto.gen.repo</code></a>
</li>
</ul>
<h2 id="v3-3-1-2019-12-27" class="section-heading">  v3.3.1 (2019-12-27) </h2> <h3 id="enhancements-24" class="section-heading">  Enhancements </h3> <ul><li>[Ecto.Query.WindowAPI] Support <code class="inline">filter/2</code>
</li></ul>
<h3 id="bug-fixes-21" class="section-heading">  Bug fixes </h3> <ul><li>[Ecto.Query.API] Fix <code class="inline">coalesce/2</code> usage with mixed types</li></ul>
<h2 id="v3-3-0-2019-12-11" class="section-heading">  v3.3.0 (2019-12-11) </h2> <h3 id="enhancements-25" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Adapter] Add <code class="inline">storage_status/1</code> callback to <code class="inline">Ecto.Adapters.Storage</code> behaviour</li>
<li>[Ecto.Changeset] Add <a href="ecto.changeset.html#apply_action!/2"><code class="inline">Ecto.Changeset.apply_action!/2</code></a>
</li>
<li>[Ecto.Changeset] Remove actions restriction in <a href="ecto.changeset.html#apply_action/2"><code class="inline">Ecto.Changeset.apply_action/2</code></a>
</li>
<li>[Ecto.Repo] Introduce <code class="inline">c:Ecto.Repo.aggregate/2</code>
</li>
<li>[Ecto.Repo] Support <code class="inline">{:replace_all_except, fields}</code> in <code class="inline">:on_conflict</code>
</li>
</ul>
<h3 id="bug-fixes-22" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Query] Make sure the <code class="inline">:prefix</code> option in <code class="inline">:from</code>/<code class="inline">:join</code> also cascades to subqueries</li>
<li>[Ecto.Query] Make sure the <code class="inline">:prefix</code> option in <code class="inline">:join</code> also cascades to queries</li>
<li>[Ecto.Query] Use database returned values for literals. Previous Ecto versions knew literals from queries should not be discarded for combinations but, even if they were not discarded, we would ignore the values returned by the database</li>
<li>[Ecto.Repo] Do not wrap schema operations in a transaction if already inside a transaction. We have also removed the <strong>private</strong> option called <code class="inline">:skip_transaction</code>
</li>
</ul>
<h3 id="deprecations-1" class="section-heading">  Deprecations </h3> <ul><li>[Ecto.Repo] <code class="inline">:replace_all_except_primary_keys</code> is deprecated in favor of <code class="inline">{:replace_all_except, fields}</code> in <code class="inline">:on_conflict</code>
</li></ul>
<h2 id="v3-2-5-2019-11-03" class="section-heading">  v3.2.5 (2019-11-03) </h2> <h3 id="bug-fixes-23" class="section-heading">  Bug fixes </h3> <ul><li>[Ecto.Query] Fix a bug where executing some queries would leak the <code class="inline">{:maybe, ...}</code> type</li></ul>
<h2 id="v3-2-4-2019-11-02" class="section-heading">  v3.2.4 (2019-11-02) </h2> <h3 id="bug-fixes-24" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Query] Improve error message on invalid join binding</li>
<li>[Ecto.Query] Make sure the <code class="inline">:prefix</code> option in <code class="inline">:join</code> also applies to through associations</li>
<li>[Ecto.Query] Invoke custom type when loading aggregations from the database (but fallback to database value if it can't be cast)</li>
<li>[mix ecto.gen.repo] Support Elixir v1.9 style configs</li>
</ul>
<h2 id="v3-2-3-2019-10-17" class="section-heading">  v3.2.3 (2019-10-17) </h2> <h3 id="bug-fixes-25" class="section-heading">  Bug fixes </h3> <ul><li>[Ecto.Changeset] Do not convert enums given to <code class="inline">validate_inclusion</code> to a list</li></ul>
<h3 id="enhancements-26" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Changeset] Improve error message on non-atom keys to change/put_change</li>
<li>[Ecto.Changeset] Allow :with to be given as a <code class="inline">{module, function, args}</code> tuple on <code class="inline">cast_association/cast_embed</code>
</li>
<li>[Ecto.Changeset] Add <code class="inline">fetch_change!/2</code> and <code class="inline">fetch_field!/2</code>
</li>
</ul>
<h2 id="v3-2-2-2019-10-01" class="section-heading">  v3.2.2 (2019-10-01) </h2> <h3 id="bug-fixes-26" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Query] Fix keyword arguments given to <code class="inline">:on</code> when a bind is not given to join</li>
<li>[Ecto.Repo] Make sure a preload given to an already preloaded has_many :through is loaded</li>
</ul>
<h2 id="v3-2-1-2019-09-17" class="section-heading">  v3.2.1 (2019-09-17) </h2> <h3 id="enhancements-27" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Changeset] Add rollover logic for default incrementer in <code class="inline">optimistic_lock</code>
</li>
<li>[Ecto.Query] Also expand macros when used inside <code class="inline">type/2</code>
</li>
</ul>
<h3 id="bug-fixes-27" class="section-heading">  Bug fixes </h3> <ul><li>[Ecto.Query] Ensure queries with non-cacheable queries in CTEs/combinations are also not-cacheable</li></ul>
<h2 id="v3-2-0-2019-09-07" class="section-heading">  v3.2.0 (2019-09-07) </h2> <p>v3.2 requires Elixir v1.6+.</p>
<h3 id="enhancements-28" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Query] Add common table expressions support <code class="inline">with_cte/3</code> and <code class="inline">recursive_ctes/2</code>
</li>
<li>[Ecto.Query] Allow <code class="inline">dynamic/3</code> to be used in <code class="inline">order_by</code>, <code class="inline">distinct</code>, <code class="inline">group_by</code>, as well as in <code class="inline">partition_by</code>, <code class="inline">order_by</code>, and <code class="inline">frame</code> inside <code class="inline">windows</code>
</li>
<li>[Ecto.Query] Allow filters in <code class="inline">type/2</code> expressions</li>
<li>[Ecto.Repo] Merge options given to the repository into the changeset <code class="inline">repo_opts</code> and assign it back to make it available down the chain</li>
<li>[Ecto.Repo] Add <code class="inline">prepare_query/3</code> callback that is invoked before query operations</li>
<li>[Ecto.Repo] Support <code class="inline">:returning</code> option in <code class="inline">Ecto.Repo.update/2</code>
</li>
<li>[Ecto.Repo] Support passing a one arity function to <code class="inline">Ecto.Repo.transaction/2</code>, where the argument is the current repo</li>
<li>[Ecto.Type] Add a new <code class="inline">embed_as/1</code> callback to <a href="ecto.type.html"><code class="inline">Ecto.Type</code></a> that allows adapters to control embedding behaviour</li>
<li>[Ecto.Type] Add <code class="inline">use Ecto.Type</code> for convenience that implements the new required callbacks</li>
</ul>
<h3 id="bug-fixes-28" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Association] Ensure we delete an association before inserting when replacing on <code class="inline">has_one</code>
</li>
<li>[Ecto.Query] Do not allow interpolated <code class="inline">nil</code> in literal keyword list when building query</li>
<li>[Ecto.Query] Do not remove literals from combinations, otherwise UNION/INTERSECTION queries may not match the number of values in <code class="inline">select</code>
</li>
<li>[Ecto.Query] Do not attempt to merge at compile-time non-keyword lists given to <code class="inline">select_merge</code>
</li>
<li>[Ecto.Repo] Do not override <code class="inline">:through</code> associations on preload unless forcing</li>
<li>[Ecto.Repo] Make sure prefix option cascades to combinations and recursive queries</li>
<li>[Ecto.Schema] Use OS time without drift when generating timestamps</li>
<li>[Ecto.Type] Allow any datetime in <code class="inline">datetime_add</code>
</li>
</ul>
<h2 id="v3-1-7-2019-06-27" class="section-heading">  v3.1.7 (2019-06-27) </h2> <h3 id="bug-fixes-29" class="section-heading">  Bug fixes </h3> <ul><li>[Ecto.Changeset] Make sure <code class="inline">put_assoc</code> with empty changeset propagates on insert</li></ul>
<h2 id="v3-1-6-2019-06-19" class="section-heading">  v3.1.6 (2019-06-19) </h2> <h3 id="enhancements-29" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Repo] Add <code class="inline">:read_only</code> repositories</li>
<li>[Ecto.Schema] Also validate options given to <code class="inline">:through</code> associations</li>
</ul>
<h3 id="bug-fixes-30" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Changeset] Do not mark <code class="inline">put_assoc</code> from <code class="inline">[]</code> to <code class="inline">[]</code> or from <code class="inline">nil</code> to <code class="inline">nil</code> as change</li>
<li>[Ecto.Query] Remove named binding when excluding joins</li>
<li>[mix ecto.gen.repo] Use <code class="inline">:config_path</code> instead of hardcoding to <code class="inline">config/config.exs</code>
</li>
</ul>
<h2 id="v3-1-5-2019-06-06" class="section-heading">  v3.1.5 (2019-06-06) </h2> <h3 id="enhancements-30" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Repo] Allow <code class="inline">:default_dynamic_repo</code> option on <code class="inline">use Ecto.Repo</code>
</li>
<li>[Ecto.Schema] Support <code class="inline">{:fragment, ...}</code> in the <code class="inline">:where</code> option for associations</li>
</ul>
<h3 id="bug-fixes-31" class="section-heading">  Bug fixes </h3> <ul><li>[Ecto.Query] Fix handling of literals in combinators (union, except, intersection)</li></ul>
<h2 id="v3-1-4-2019-05-07" class="section-heading">  v3.1.4 (2019-05-07) </h2> <h3 id="bug-fixes-32" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Changeset] Convert validation enums to lists before adding them as validation metadata</li>
<li>[Ecto.Schema] Properly propagate prefix to join_through source in many_to_many associations</li>
</ul>
<h2 id="v3-1-3-2019-04-30" class="section-heading">  v3.1.3 (2019-04-30) </h2> <h3 id="enhancements-31" class="section-heading">  Enhancements </h3> <ul><li>[Ecto.Changeset] Expose the enum that was validated against in errors from enum-based validations</li></ul>
<h2 id="v3-1-2-2019-04-24" class="section-heading">  v3.1.2 (2019-04-24) </h2> <h3 id="enhancements-32" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Query] Add support for <code class="inline">type+over</code>
</li>
<li>[Ecto.Schema] Allow schema fields to be excluded from queries</li>
</ul>
<h3 id="bug-fixes-33" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Changeset] Do not list a field as changed if it is updated to its original value</li>
<li>[Ecto.Query] Keep literal numbers and bitstring in subqueries and unions</li>
<li>[Ecto.Query] Improve error message for invalid <code class="inline">type/2</code> expression</li>
<li>[Ecto.Query] Properly count interpolations in <code class="inline">select_merge/2</code>
</li>
</ul>
<h2 id="v3-1-1-2019-04-04" class="section-heading">  v3.1.1 (2019-04-04) </h2> <h3 id="bug-fixes-34" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto] Do not require Jason (i.e. it should continue to be an optional dependency)</li>
<li>[Ecto.Repo] Make sure <code class="inline">many_to_many</code> and <a href="ecto.multi.html"><code class="inline">Ecto.Multi</code></a> work with dynamic repos</li>
</ul>
<h2 id="v3-1-0-2019-04-02" class="section-heading">  v3.1.0 (2019-04-02) </h2> <p>v3.1 requires Elixir v1.5+.</p>
<h3 id="enhancements-33" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Changeset] Add <code class="inline">not_equal_to</code> option for <code class="inline">validate_number</code>
</li>
<li>[Ecto.Query] Improve error message for missing <code class="inline">fragment</code> arguments</li>
<li>[Ecto.Query] Improve error message on missing struct key for structs built in <code class="inline">select</code>
</li>
<li>[Ecto.Query] Allow dynamic named bindings</li>
<li>[Ecto.Repo] Add dynamic repository support with <code class="inline">Ecto.Repo.put_dynamic_repo/1</code> and <code class="inline">Ecto.Repo.get_dynamic_repo/0</code> (experimental)</li>
<li>[Ecto.Type] Cast naive_datetime/utc_datetime strings without seconds</li>
</ul>
<h3 id="bug-fixes-35" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Changeset] Do not run <code class="inline">unsafe_validate_unique</code> query unless relevant fields were changed</li>
<li>[Ecto.Changeset] Raise if an unknown field is given on <a href="ecto.changeset.html#change/2"><code class="inline">Ecto.Changeset.change/2</code></a>
</li>
<li>[Ecto.Changeset] Expose the type that was validated in errors generated by <code class="inline">validate_length/3</code>
</li>
<li>[Ecto.Query] Add support for <code class="inline">field/2</code> as first element of <code class="inline">type/2</code> and alias as second element of <code class="inline">type/2</code>
</li>
<li>[Ecto.Query] Do not attempt to assert types of named bindings that are not known at compile time</li>
<li>[Ecto.Query] Properly cast boolean expressions in select</li>
<li>[Mix.Ecto] Load applications during repo lookup so their app environment is available</li>
</ul>
<h3 id="deprecations-2" class="section-heading">  Deprecations </h3> <ul><li>[Ecto.LogEntry] Fully deprecate previously soft deprecated API</li></ul>
<h2 id="v3-0-7-2019-02-06" class="section-heading">  v3.0.7 (2019-02-06) </h2> <h3 id="bug-fixes-36" class="section-heading">  Bug fixes </h3> <ul><li>[Ecto.Query] <code class="inline">reverse_order</code> reverses by primary key if no order is given</li></ul>
<h2 id="v3-0-6-2018-12-31" class="section-heading">  v3.0.6 (2018-12-31) </h2> <h3 id="enhancements-34" class="section-heading">  Enhancements </h3> <ul><li>[Ecto.Query] Add <code class="inline">reverse_order/1</code>
</li></ul>
<h3 id="bug-fixes-37" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Multi] Raise better error message on accidental rollback inside <a href="ecto.multi.html"><code class="inline">Ecto.Multi</code></a>
</li>
<li>[Ecto.Query] Properly merge deeply nested preloaded joins</li>
<li>[Ecto.Query] Raise better error message on missing select on schemaless queries</li>
<li>[Ecto.Schema] Fix parameter ordering in assoc <code class="inline">:where</code>
</li>
</ul>
<h2 id="v3-0-5-2018-12-08" class="section-heading">  v3.0.5 (2018-12-08) </h2> <h3 id="backwards-incompatible-changes" class="section-heading">  Backwards incompatible changes </h3> <ul><li>[Ecto.Schema] The <code class="inline">:where</code> option added in Ecto 3.0.0 had a major flaw and it has been reworked in this version. This means a tuple of three elements can no longer be passed to <code class="inline">:where</code>, instead a keyword list must be given. Check the "Filtering associations" section in <code class="inline">has_many/3</code> docs for more information</li></ul>
<h3 id="bug-fixes-38" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Query] Do not raise on lists of tuples that are not keywords. Instead, let custom Ecto.Type handle them</li>
<li>[Ecto.Query] Allow <code class="inline">prefix: nil</code> to be given to subqueries</li>
<li>[Ecto.Query] Use different cache keys for unions/intersections/excepts</li>
<li>[Ecto.Repo] Fix support for upserts with <code class="inline">:replace</code> without a schema</li>
<li>[Ecto.Type] Do not lose precision when casting <code class="inline">utc_datetime_usec</code> with a time zone different than Etc/UTC</li>
</ul>
<h2 id="v3-0-4-2018-11-29" class="section-heading">  v3.0.4 (2018-11-29) </h2> <h3 id="enhancements-35" class="section-heading">  Enhancements </h3> <ul>
<li>[Decimal] Bump decimal dependency</li>
<li>[Ecto.Repo] Remove unused <code class="inline">:pool_timeout</code>
</li>
</ul>
<h2 id="v3-0-3-2018-11-20" class="section-heading">  v3.0.3 (2018-11-20) </h2> <h3 id="enhancements-36" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Changeset] Add <code class="inline">count: :bytes</code> option in <code class="inline">validate_length/3</code>
</li>
<li>[Ecto.Query] Support passing <a href="ecto.query.html"><code class="inline">Ecto.Query</code></a> in <code class="inline">Ecto.Repo.insert_all</code>
</li>
</ul>
<h3 id="bug-fixes-39" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Type] Respect adapter types when loading/dumping arrays and maps</li>
<li>[Ecto.Query] Ensure no bindings in order_by when using combinations in <a href="ecto.query.html"><code class="inline">Ecto.Query</code></a>
</li>
<li>[Ecto.Repo] Ensure adapter is compiled (instead of only loaded) before invoking it</li>
<li>[Ecto.Repo] Support new style child spec from adapters</li>
</ul>
<h2 id="v3-0-2-2018-11-17" class="section-heading">  v3.0.2 (2018-11-17) </h2> <h3 id="bug-fixes-40" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.LogEntry] Bring old Ecto.LogEntry APIs back for compatibility</li>
<li>[Ecto.Repo] Consider non-joined fields when merging preloaded assocs only at root</li>
<li>[Ecto.Repo] Take field sources into account in :replace_all_fields upsert option</li>
<li>[Ecto.Type] Convert <code class="inline">:utc_datetime</code> to <a href="https://hexdocs.pm/elixir/DateTime.html"><code class="inline">DateTime</code></a> when sending it to adapters</li>
</ul>
<h2 id="v3-0-1-2018-11-03" class="section-heading">  v3.0.1 (2018-11-03) </h2> <h3 id="bug-fixes-41" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Query] Ensure parameter order is preserved when using more than 32 parameters</li>
<li>[Ecto.Query] Consider query prefix when planning association joins</li>
<li>[Ecto.Repo] Consider non-joined fields as unique parameters when merging preloaded query assocs</li>
</ul>
<h2 id="v3-0-0-2018-10-29" class="section-heading">  v3.0.0 (2018-10-29) </h2> <p>Note this version includes changes from <code class="inline">ecto</code> and <code class="inline">ecto_sql</code> but in future releases all <code class="inline">ecto_sql</code> entries will be listed in their own CHANGELOG.</p>
<h3 id="enhancements-37" class="section-heading">  Enhancements </h3> <ul>
<li>[Ecto.Adapters.MySQL] Add ability to specify cli_protocol for <code class="inline">ecto.create</code> and <code class="inline">ecto.drop</code> commands</li>
<li>[Ecto.Adapters.PostgreSQL] Add ability to specify maintenance database name for PostgreSQL adapter for <code class="inline">ecto.create</code> and <code class="inline">ecto.drop</code> commands</li>
<li>[Ecto.Changeset] Store constraint name in error metadata for constraints</li>
<li>[Ecto.Changeset] Add <code class="inline">validations/1</code> and <code class="inline">constraints/1</code> instead of allowing direct access on the struct fields</li>
<li>[Ecto.Changeset] Add <code class="inline">:force_update</code> option when casting relations, to force an update even if there are no changes</li>
<li>[Ecto.Migration] Migrations now lock the migrations table in order to avoid concurrent migrations in a cluster. The type of lock can be configured via the <code class="inline">:migration_lock</code> repository configuration and defaults to "FOR UPDATE" or disabled if set to nil</li>
<li>[Ecto.Migration] Add <code class="inline">:migration_default_prefix</code> repository configuration</li>
<li>[Ecto.Migration] Add reversible version of <code class="inline">remove/2</code> subcommand</li>
<li>[Ecto.Migration] Add support for non-empty arrays as defaults in migrations</li>
<li>[Ecto.Migration] Add support for logging notices/alerts/warnings when running migrations (only supported by Postgres currently)</li>
<li>[Ecto.Migrator] Warn when migrating and there is a higher version already migrated in the database</li>
<li>[Ecto.Multi] Add support for anonymous functions in <code class="inline">insert/4</code>, <code class="inline">update/4</code>, <code class="inline">insert_or_update/4</code>, and <code class="inline">delete/4</code>
</li>
<li>[Ecto.Query] Support tuples in <code class="inline">where</code> and <code class="inline">having</code>, allowing queries such as <code class="inline">where: {p.foo, p.bar} &gt; {^foo, ^bar}</code>
</li>
<li>[Ecto.Query] Support arithmetic operators in queries as a thin layer around the DB functionality</li>
<li>[Ecto.Query] Allow joins in queries to be named via <code class="inline">:as</code> and allow named bindings</li>
<li>[Ecto.Query] Support excluding specific join types in <code class="inline">exclude/2</code>
</li>
<li>[Ecto.Query] Allow virtual field update in subqueries</li>
<li>[Ecto.Query] Support <code class="inline">coalesce/2</code> in queries, such as <code class="inline">select: coalesce(p.title, p.old_title)</code>
</li>
<li>[Ecto.Query] Support <code class="inline">filter/2</code> in queries, such as <code class="inline">select: filter(count(p.id), p.public == true)</code>
</li>
<li>[Ecto.Query] The <code class="inline">:prefix</code> and <code class="inline">:hints</code> options are now supported on both <code class="inline">from</code> and <code class="inline">join</code> expressions</li>
<li>[Ecto.Query] Support <code class="inline">:asc_nulls_last</code>, <code class="inline">:asc_nulls_first</code>, <code class="inline">:desc_nulls_last</code>, and <code class="inline">:desc_nulls_first</code> in <code class="inline">order_by</code>
</li>
<li>[Ecto.Query] Allow variables (sources) to be given in queries, for example, useful for invoking functions, such as <code class="inline">fragment("some_function(?)", p)</code>
</li>
<li>[Ecto.Query] Add support for <code class="inline">union</code>, <code class="inline">union_all</code>, <code class="inline">intersection</code>, <code class="inline">intersection_all</code>, <code class="inline">except</code> and <code class="inline">except_all</code>
</li>
<li>[Ecto.Query] Add support for <code class="inline">windows</code> and <code class="inline">over</code>
</li>
<li>[Ecto.Query] Raise when comparing a string with a charlist during planning</li>
<li>[Ecto.Repo] Only start transactions if an association or embed has changed, this reduces the overhead during repository operations</li>
<li>[Ecto.Repo] Support <code class="inline">:replace_all_except_primary_key</code> as <code class="inline">:on_conflict</code> strategy</li>
<li>[Ecto.Repo] Support <code class="inline">{:replace, fields}</code> as <code class="inline">:on_conflict</code> strategy</li>
<li>[Ecto.Repo] Support <code class="inline">:unsafe_fragment</code> as <code class="inline">:conflict_target</code>
</li>
<li>[Ecto.Repo] Support <code class="inline">select</code> in queries given to <code class="inline">update_all</code> and <code class="inline">delete_all</code>
</li>
<li>[Ecto.Repo] Add <code class="inline">Repo.exists?/2</code>
</li>
<li>[Ecto.Repo] Add <code class="inline">Repo.checkout/2</code> - useful when performing multiple operations in short-time to interval, allowing the pool to be bypassed</li>
<li>[Ecto.Repo] Add <code class="inline">:stale_error_field</code> to <code class="inline">Repo.insert/update/delete</code> that converts <a href="ecto.staleentryerror.html"><code class="inline">Ecto.StaleEntryError</code></a> into a changeset error. The message can also be set with <code class="inline">:stale_error_message</code>
</li>
<li>[Ecto.Repo] Preloading now only sorts results by the relationship key instead of sorting by the whole struct</li>
<li>[Ecto.Schema] Allow <code class="inline">:where</code> option to be given to <code class="inline">has_many</code>/<code class="inline">has_one</code>/<code class="inline">belongs_to</code>/<code class="inline">many_to_many</code>
</li>
</ul>
<h3 id="bug-fixes-42" class="section-heading">  Bug fixes </h3> <ul>
<li>[Ecto.Inspect] Do not fail when inspecting query expressions which have a number of bindings more than bindings available</li>
<li>[Ecto.Migration] Keep double underscores on autogenerated index names to be consistent with changesets</li>
<li>[Ecto.Query] Fix <a href="ecto.query.api.html#map/2"><code class="inline">Ecto.Query.API.map/2</code></a> for single nil column with join</li>
<li>[Ecto.Migration] Ensure <code class="inline">create_if_not_exists</code> is properly reversible</li>
<li>[Ecto.Repo] Allow many_to_many associations to be preloaded via a function (before the behaviour was erratic)</li>
<li>[Ecto.Schema] Make autogen ID loading work with custom type</li>
<li>[Ecto.Schema] Make <code class="inline">updated_at</code> have the same value as <code class="inline">inserted_at</code>
</li>
<li>[Ecto.Schema] Ensure all fields are replaced with <code class="inline">on_conflict: :replace_all/:replace_all_except_primary_key</code> and not only the fields sent as changes</li>
<li>[Ecto.Type] Return <code class="inline">:error</code> when casting NaN or infinite decimals</li>
<li>[mix ecto.migrate] Properly run migrations after ECTO_EDITOR changes</li>
<li>[mix ecto.migrations] List migrated versions even if the migration file is deleted</li>
<li>[mix ecto.load] The task now fails on SQL errors on Postgres</li>
</ul>
<h3 id="deprecations-3" class="section-heading">  Deprecations </h3> <p>Although Ecto 3.0 is a major bump version, the functionality below emits deprecation warnings to ease the migration process. The functionality below will be removed in future Ecto 3.1+ releases.</p>
<ul>
<li>[Ecto.Changeset] Passing a list of binaries to <code class="inline">cast/3</code> is deprecated, please pass a list of atoms instead</li>
<li>[Ecto.Multi] <a href="ecto.multi.html#run/3"><code class="inline">Ecto.Multi.run/3</code></a> now receives the repo in which the transaction is executing as the first argument to functions, and the changes so far as the second argument</li>
<li>[Ecto.Query] <code class="inline">join/5</code> now expects <code class="inline">on: expr</code> as last argument instead of simply <code class="inline">expr</code>. This was done in order to properly support the <code class="inline">:as</code>, <code class="inline">:hints</code> and <code class="inline">:prefix</code> options</li>
<li>[Ecto.Repo] The <code class="inline">:returning</code> option for <code class="inline">update_all</code> and <code class="inline">delete_all</code> has been deprecated as those statements now support <code class="inline">select</code> clauses</li>
<li>[Ecto.Repo] Passing <code class="inline">:adapter</code> via config is deprecated in favor of passing it on <code class="inline">use Ecto.Repo</code>
</li>
<li>[Ecto.Repo] The <code class="inline">:loggers</code> configuration is deprecated in favor of "Telemetry Events"</li>
</ul>
<h3 id="backwards-incompatible-changes-1" class="section-heading">  Backwards incompatible changes </h3> <ul>
<li>[Ecto.DateTime] <code class="inline">Ecto.Date</code>, <code class="inline">Ecto.Time</code> and <code class="inline">Ecto.DateTime</code> were previously deprecated and have now been removed</li>
<li>[Ecto.DataType] <code class="inline">Ecto.DataType</code> protocol has been removed</li>
<li>[Ecto.Migration] Automatically inferred index names may differ in Ecto v3.0 for indexes on complex column names</li>
<li>[Ecto.Multi] <a href="ecto.multi.html#run/5"><code class="inline">Ecto.Multi.run/5</code></a> now receives the repo in which the transaction is executing as the first argument to functions, and the changes so far as the second argument</li>
<li>[Ecto.Query] A <code class="inline">join</code> no longer wraps <code class="inline">fragment</code> in parentheses. In some cases, such as common table expressions, you will have to explicitly wrap the fragment in parens.</li>
<li>[Ecto.Repo] The <code class="inline">on_conflict: :replace_all</code> option now will also send fields with default values to the database. If you prefer the old behaviour that only sends the changes in the changeset, you can set it to <code class="inline">on_conflict: {:replace, Map.keys(changeset.changes)}</code> (this change is also listed as a bug fix)</li>
<li>[Ecto.Repo] The repository operations are no longer called from association callbacks - this behaviour was not guaranteed in previous versions but we are listing as backwards incompatible changes to help with users relying on this behaviour</li>
<li>[Ecto.Repo] <code class="inline">:pool_timeout</code> is no longer supported in favor of a new queue system described in <code class="inline">DBConnection.start_link/2</code> under "Queue config". For most users, configuring <code class="inline">:timeout</code> is enough, as it now includes both queue and query time</li>
<li>[Ecto.Schema] <code class="inline">:time</code>, <code class="inline">:naive_datetime</code> and <code class="inline">:utc_datetime</code> no longer keep microseconds information. If you want to keep microseconds, use <code class="inline">:time_usec</code>, <code class="inline">:naive_datetime_usec</code>, <code class="inline">:utc_datetime_usec</code>
</li>
<li>[Ecto.Schema] The <code class="inline">@schema_prefix</code> option now only affects the <code class="inline">from</code>/<code class="inline">join</code> of where the schema is used and no longer the whole query</li>
<li>[Ecto.Schema.Metadata] The <code class="inline">source</code> key no longer returns a tuple of the schema_prefix and the table/collection name. It now returns just the table/collection string. You can now access the schema_prefix via the <code class="inline">prefix</code> key.</li>
<li>[Mix.Ecto] <code class="inline">Mix.Ecto.ensure_started/2</code> has been removed. However, in Ecto 2.2 the <a href="mix.ecto.html"><code class="inline">Mix.Ecto</code></a> module was not considered part of the public API and should not have been used but we are listing this for guidance.</li>
</ul>
<h3 id="adapter-changes" class="section-heading">  Adapter changes </h3> <ul>
<li>[Ecto.Adapter] Split <a href="ecto.adapter.html"><code class="inline">Ecto.Adapter</code></a> into <a href="ecto.adapter.queryable.html"><code class="inline">Ecto.Adapter.Queryable</code></a> and <a href="ecto.adapter.schema.html"><code class="inline">Ecto.Adapter.Schema</code></a> to provide more granular repository APIs</li>
<li>[Ecto.Adapter] The <code class="inline">:sources</code> field in <code class="inline">query_meta</code> now contains three elements tuples with <code class="inline">{source, schema, prefix}</code> in order to support <code class="inline">from</code>/<code class="inline">join</code> prefixes (#2572)</li>
<li>[Ecto.Adapter] The database types <code class="inline">time</code>, <code class="inline">utc_datetime</code> and <code class="inline">naive_datetime</code> should translate to types with seconds precision while the database types <code class="inline">time_usec</code>, <code class="inline">utc_datetime_usec</code> and <code class="inline">naive_datetime_usec</code> should have microseconds precision (#2291)</li>
<li>[Ecto.Adapter] The <code class="inline">on_conflict</code> argument for <code class="inline">insert</code> and <code class="inline">insert_all</code> no longer receives a <code class="inline">{:replace_all, list(), atom()}</code> tuple. Instead, it receives a <code class="inline">{fields :: [atom()], list(), atom()}</code> where <code class="inline">fields</code> is a list of atoms of the fields to be replaced (#2181)</li>
<li>[Ecto.Adapter] <code class="inline">insert</code>/<code class="inline">update</code>/<code class="inline">delete</code> now receive both <code class="inline">:source</code> and <code class="inline">:prefix</code> fields instead of a single <code class="inline">:source</code> field with both <code class="inline">source</code> and <code class="inline">prefix</code> in it (#2490)</li>
<li>[Ecto.Adapter.Migration] A new <code class="inline">lock_for_migration/4</code> callback has been added. It is implemented by default by <code class="inline">Ecto.Adapters.SQL</code> (#2215)</li>
<li>[Ecto.Adapter.Migration] The <code class="inline">execute_ddl</code> should now return <code class="inline">{:ok, []}</code> to make space for returning notices/hints/warnings in the future (adapters leveraging <code class="inline">Ecto.Adapters.SQL</code> do not have to perform any change)</li>
<li>[Ecto.Query] The <code class="inline">from</code> field in <a href="ecto.query.html"><code class="inline">Ecto.Query</code></a> now returns a <code class="inline">Ecto.Query.FromExpr</code> with the <code class="inline">:source</code> field, unifying the behaviour in <code class="inline">from</code> and <code class="inline">join</code> expressions (#2497)</li>
<li>[Ecto.Query] Tuple expressions are now supported in queries. For example, <code class="inline">where: {p.foo, p.bar} &gt; {p.bar, p.baz}</code> should translate to <code class="inline">WHERE (p.foo, p.bar) &gt; (p.bar, p.baz)</code> in SQL databases. Adapters should be changed to handle <code class="inline">{:{}, meta, exprs}</code> in the query AST (#2344)</li>
<li>[Ecto.Query] Adapters should support the following arithmetic operators in queries <code class="inline">+</code>, <code class="inline">-</code>, <code class="inline">*</code> and <code class="inline">/</code> (#2400)</li>
<li>[Ecto.Query] Adapters should support <code class="inline">filter/2</code> in queries, as in <code class="inline">select: filter(count(p.id), p.public == true)</code> (#2487)</li>
</ul>
<h2 id="previous-versions" class="section-heading">  Previous versions </h2> <ul><li>See the CHANGELOG.md <a href="https://github.com/elixir-ecto/ecto/blob/v2.2/CHANGELOG.md">in the v2.2 branch</a>
</li></ul> <div class="bottom-actions"> <div class="bottom-actions-item"> <a href="api-reference.html" class="bottom-actions-button" rel="prev"> <span class="subheader">  Previous Page </span> <span class="title"> API Reference </span> </a> </div> <div class="bottom-actions-item"> <a href="getting-started.html" class="bottom-actions-button" rel="next"> <span class="subheader"> Next Page  </span> <span class="title"> Getting Started </span> </a> </div> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2013 Plataformatec<br>&copy; 2020 Dashbit<br>Licensed under the Apache License, Version 2.0.<br>
    <a href="https://hexdocs.pm/ecto/changelog.html" class="_attribution-link">https://hexdocs.pm/ecto/changelog.html</a>
  </p>
</div>
