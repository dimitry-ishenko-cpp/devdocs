<section id="s-queryset-api-reference"> <h1 id="queryset-api-reference">QuerySet API reference</h1> <p>This document describes the details of the <code>QuerySet</code> API. It builds on the material presented in the <a class="reference internal" href="../../topics/db/models.html"><span class="doc">model</span></a> and <a class="reference internal" href="../../topics/db/queries.html"><span class="doc">database query</span></a> guides, so you’ll probably want to read and understand those documents before reading this one.</p> <p>Throughout this reference we’ll use the <a class="reference internal" href="../../topics/db/aggregation.html#queryset-model-example"><span class="std std-ref">example blog models</span></a> presented in the <a class="reference internal" href="../../topics/db/queries.html"><span class="doc">database query guide</span></a>.</p> <section id="s-when-querysets-are-evaluated"> <h2 id="id1">When <code>QuerySet</code>s are evaluated</h2> <p>Internally, a <code>QuerySet</code> can be constructed, filtered, sliced, and generally passed around without actually hitting the database. No database activity actually occurs until you do something to evaluate the queryset.</p> <p>You can evaluate a <code>QuerySet</code> in the following ways:</p> <ul> <li>
<p><strong>Iteration.</strong> A <code>QuerySet</code> is iterable, and it executes its database query the first time you iterate over it. For example, this will print the headline of all entries in the database:</p> <pre data-language="python">for e in Entry.objects.all():
    print(e.headline)
</pre> <p>Note: Don’t use this if all you want to do is determine if at least one result exists. It’s more efficient to use <a class="reference internal" href="#django.db.models.query.QuerySet.exists" title="django.db.models.query.QuerySet.exists"><code>exists()</code></a>.</p> </li> <li>
<p><strong>Asynchronous iteration.</strong> A <code>QuerySet</code> can also be iterated over using <code>async for</code>:</p> <pre data-language="python">async for e in Entry.objects.all():
    results.append(e)
</pre> <p>Both synchronous and asynchronous iterators of QuerySets share the same underlying cache.</p> </li> <li>
<p><strong>Slicing.</strong> As explained in <a class="reference internal" href="../../topics/db/queries.html#limiting-querysets"><span class="std std-ref">Limiting QuerySets</span></a>, a <code>QuerySet</code> can be sliced, using Python’s array-slicing syntax. Slicing an unevaluated <code>QuerySet</code> usually returns another unevaluated <code>QuerySet</code>, but Django will execute the database query if you use the “step” parameter of slice syntax, and will return a list. Slicing a <code>QuerySet</code> that has been evaluated also returns a list.</p> <p>Also note that even though slicing an unevaluated <code>QuerySet</code> returns another unevaluated <code>QuerySet</code>, modifying it further (e.g., adding more filters, or modifying ordering) is not allowed, since that does not translate well into SQL and it would not have a clear meaning either.</p> </li> <li>
<strong>Pickling/Caching.</strong> See the following section for details of what is involved when <a class="reference internal" href="#pickling-querysets">pickling QuerySets</a>. The important thing for the purposes of this section is that the results are read from the database.</li> <li>
<strong>repr().</strong> A <code>QuerySet</code> is evaluated when you call <code>repr()</code> on it. This is for convenience in the Python interactive interpreter, so you can immediately see your results when using the API interactively.</li> <li>
<p><strong>len().</strong> A <code>QuerySet</code> is evaluated when you call <code>len()</code> on it. This, as you might expect, returns the length of the result list.</p> <p>Note: If you only need to determine the number of records in the set (and don’t need the actual objects), it’s much more efficient to handle a count at the database level using SQL’s <code>SELECT COUNT(*)</code>. Django provides a <a class="reference internal" href="#django.db.models.query.QuerySet.count" title="django.db.models.query.QuerySet.count"><code>count()</code></a> method for precisely this reason.</p> </li> <li>
<p><strong>list().</strong> Force evaluation of a <code>QuerySet</code> by calling <code>list()</code> on it. For example:</p> <pre data-language="python">entry_list = list(Entry.objects.all())
</pre> </li> <li>
<p><strong>bool().</strong> Testing a <code>QuerySet</code> in a boolean context, such as using <code>bool()</code>, <code>or</code>, <code>and</code> or an <code>if</code> statement, will cause the query to be executed. If there is at least one result, the <code>QuerySet</code> is <code>True</code>, otherwise <code>False</code>. For example:</p> <pre data-language="python">if Entry.objects.filter(headline="Test"):
    print("There is at least one Entry with the headline Test")
</pre> <p>Note: If you only want to determine if at least one result exists (and don’t need the actual objects), it’s more efficient to use <a class="reference internal" href="#django.db.models.query.QuerySet.exists" title="django.db.models.query.QuerySet.exists"><code>exists()</code></a>.</p> </li> </ul> <section id="s-pickling-querysets"> <h3 id="id2">Pickling <code>QuerySet</code>s</h3> <p>If you <a class="reference external" href="https://docs.python.org/3/library/pickle.html#module-pickle" title="(in Python v3.13)"><code>pickle</code></a> a <code>QuerySet</code>, this will force all the results to be loaded into memory prior to pickling. Pickling is usually used as a precursor to caching and when the cached queryset is reloaded, you want the results to already be present and ready for use (reading from the database can take some time, defeating the purpose of caching). This means that when you unpickle a <code>QuerySet</code>, it contains the results at the moment it was pickled, rather than the results that are currently in the database.</p> <p>If you only want to pickle the necessary information to recreate the <code>QuerySet</code> from the database at a later time, pickle the <code>query</code> attribute of the <code>QuerySet</code>. You can then recreate the original <code>QuerySet</code> (without any results loaded) using some code like this:</p> <pre data-language="pycon">&gt;&gt;&gt; import pickle
&gt;&gt;&gt; query = pickle.loads(s)  # Assuming 's' is the pickled string.
&gt;&gt;&gt; qs = MyModel.objects.all()
&gt;&gt;&gt; qs.query = query  # Restore the original 'query'.
</pre> <p>The <code>query</code> attribute is an opaque object. It represents the internals of the query construction and is not part of the public API. However, it is safe (and fully supported) to pickle and unpickle the attribute’s contents as described here.</p> <div class="admonition-restrictions-on-queryset-values-list admonition"> <p class="admonition-title">Restrictions on <code>QuerySet.values_list()</code></p> <p>If you recreate <a class="reference internal" href="#django.db.models.query.QuerySet.values_list" title="django.db.models.query.QuerySet.values_list"><code>QuerySet.values_list()</code></a> using the pickled <code>query</code> attribute, it will be converted to <a class="reference internal" href="#django.db.models.query.QuerySet.values" title="django.db.models.query.QuerySet.values"><code>QuerySet.values()</code></a>:</p> <pre data-language="pycon">&gt;&gt;&gt; import pickle
&gt;&gt;&gt; qs = Blog.objects.values_list("id", "name")
&gt;&gt;&gt; qs
&lt;QuerySet [(1, 'Beatles Blog')]&gt;
&gt;&gt;&gt; reloaded_qs = Blog.objects.all()
&gt;&gt;&gt; reloaded_qs.query = pickle.loads(pickle.dumps(qs.query))
&gt;&gt;&gt; reloaded_qs
&lt;QuerySet [{'id': 1, 'name': 'Beatles Blog'}]&gt;
</pre> </div> <div class="admonition-you-can-t-share-pickles-between-versions admonition"> <p class="admonition-title">You can’t share pickles between versions</p> <p>Pickles of <code>QuerySets</code> are only valid for the version of Django that was used to generate them. If you generate a pickle using Django version N, there is no guarantee that pickle will be readable with Django version N+1. Pickles should not be used as part of a long-term archival strategy.</p> <p>Since pickle compatibility errors can be difficult to diagnose, such as silently corrupted objects, a <code>RuntimeWarning</code> is raised when you try to unpickle a queryset in a Django version that is different than the one in which it was pickled.</p> </div> </section> </section> <section id="s-queryset-api"> <h2 id="id3">
<code>QuerySet</code> API</h2> <p>Here’s the formal declaration of a <code>QuerySet</code>:</p> <dl class="py class"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet">
<code>class QuerySet(model=None, query=None, using=None, hints=None)</code> <a class="reference external" href="https://github.com/django/django/blob/stable/5.2.x/django/db/models/query.py#L277"><span class="viewcode-link">[source]</span></a>
</dt> <dd>
<p>Usually when you’ll interact with a <code>QuerySet</code> you’ll use it by <a class="reference internal" href="../../topics/db/queries.html#chaining-filters"><span class="std std-ref">chaining filters</span></a>. To make this work, most <code>QuerySet</code> methods return new querysets. These methods are covered in detail later in this section.</p> <p>The <code>QuerySet</code> class has the following public attributes you can use for introspection:</p> <dl class="py attribute"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.ordered">
<code>ordered</code> <a class="reference external" href="https://github.com/django/django/blob/stable/5.2.x/django/db/models/query.py#L1798"><span class="viewcode-link">[source]</span></a>
</dt> <dd>
<p><code>True</code> if the <code>QuerySet</code> is ordered — i.e. has an <a class="reference internal" href="#django.db.models.query.QuerySet.order_by" title="django.db.models.query.QuerySet.order_by"><code>order_by()</code></a> clause or a default ordering on the model. <code>False</code> otherwise.</p> </dd>
</dl> <dl class="py attribute"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.db">
<code>db</code> <a class="reference external" href="https://github.com/django/django/blob/stable/5.2.x/django/db/models/query.py#L1819"><span class="viewcode-link">[source]</span></a>
</dt> <dd>
<p>The database that will be used if this query is executed now.</p> </dd>
</dl> <div class="admonition note"> <p class="admonition-title">Note</p> <p>The <code>query</code> parameter to <a class="reference internal" href="#django.db.models.query.QuerySet" title="django.db.models.query.QuerySet"><code>QuerySet</code></a> exists so that specialized query subclasses can reconstruct internal query state. The value of the parameter is an opaque representation of that query state and is not part of a public API.</p> </div> </dd>
</dl> <section id="s-methods-that-return-new-querysets"> <h3 id="methods-that-return-new-querysets">Methods that return new <code>QuerySet</code>s</h3> <p>Django provides a range of <code>QuerySet</code> refinement methods that modify either the types of results returned by the <code>QuerySet</code> or the way its SQL query is executed.</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>These methods do not run database queries, therefore they are <strong>safe to</strong> <strong>run in asynchronous code</strong>, and do not have separate asynchronous versions.</p> </div> <section id="s-filter"> <h4 id="filter"><code>filter()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.filter">
<code>filter(*args, **kwargs)</code> </dt> 
</dl> <p>Returns a new <code>QuerySet</code> containing objects that match the given lookup parameters.</p> <p>The lookup parameters (<code>**kwargs</code>) should be in the format described in <a class="reference internal" href="#id4">Field lookups</a> below. Multiple parameters are joined via <code>AND</code> in the underlying SQL statement.</p> <p>If you need to execute more complex queries (for example, queries with <code>OR</code> statements), you can use <a class="reference internal" href="#django.db.models.Q" title="django.db.models.Q"><code>Q objects</code></a> (<code>*args</code>).</p> </section> <section id="s-exclude"> <h4 id="exclude"><code>exclude()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.exclude">
<code>exclude(*args, **kwargs)</code> </dt> 
</dl> <p>Returns a new <code>QuerySet</code> containing objects that do <em>not</em> match the given lookup parameters.</p> <p>The lookup parameters (<code>**kwargs</code>) should be in the format described in <a class="reference internal" href="#id4">Field lookups</a> below. Multiple parameters are joined via <code>AND</code> in the underlying SQL statement, and the whole thing is enclosed in a <code>NOT()</code>.</p> <p>This example excludes all entries whose <code>pub_date</code> is later than 2005-1-3 AND whose <code>headline</code> is “Hello”:</p> <pre data-language="python">Entry.objects.exclude(pub_date__gt=datetime.date(2005, 1, 3), headline="Hello")
</pre> <p>In SQL terms, that evaluates to:</p> <pre data-language="sql">SELECT ...
WHERE NOT (pub_date &gt; '2005-1-3' AND headline = 'Hello')
</pre> <p>This example excludes all entries whose <code>pub_date</code> is later than 2005-1-3 OR whose headline is “Hello”:</p> <pre data-language="python">Entry.objects.exclude(pub_date__gt=datetime.date(2005, 1, 3)).exclude(headline="Hello")
</pre> <p>In SQL terms, that evaluates to:</p> <pre data-language="sql">SELECT ...
WHERE NOT pub_date &gt; '2005-1-3'
AND NOT headline = 'Hello'
</pre> <p>Note the second example is more restrictive.</p> <p>If you need to execute more complex queries (for example, queries with <code>OR</code> statements), you can use <a class="reference internal" href="#django.db.models.Q" title="django.db.models.Q"><code>Q objects</code></a> (<code>*args</code>).</p> </section> <section id="s-annotate"> <h4 id="annotate"><code>annotate()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.annotate">
<code>annotate(*args, **kwargs)</code> </dt> 
</dl> <p>Annotates each object in the <code>QuerySet</code> with the provided list of <a class="reference internal" href="expressions.html"><span class="doc">query expressions</span></a>. An expression may be a simple value, a reference to a field on the model (or any related models), or an aggregate expression (averages, sums, etc.) that has been computed over the objects that are related to the objects in the <code>QuerySet</code>.</p> <p>Each argument to <code>annotate()</code> is an annotation that will be added to each object in the <code>QuerySet</code> that is returned.</p> <p>The aggregation functions that are provided by Django are described in <a class="reference internal" href="#id6">Aggregation Functions</a> below.</p> <p>Annotations specified using keyword arguments will use the keyword as the alias for the annotation. Anonymous arguments will have an alias generated for them based upon the name of the aggregate function and the model field that is being aggregated. Only aggregate expressions that reference a single field can be anonymous arguments. Everything else must be a keyword argument.</p> <p>For example, if you were manipulating a list of blogs, you may want to determine how many entries have been made in each blog:</p> <pre data-language="pycon">&gt;&gt;&gt; from django.db.models import Count
&gt;&gt;&gt; q = Blog.objects.annotate(Count("entry"))
# The name of the first blog
&gt;&gt;&gt; q[0].name
'Blogasaurus'
# The number of entries on the first blog
&gt;&gt;&gt; q[0].entry__count
42
</pre> <p>The <code>Blog</code> model doesn’t define an <code>entry__count</code> attribute by itself, but by using a keyword argument to specify the aggregate function, you can control the name of the annotation:</p> <pre data-language="pycon">&gt;&gt;&gt; q = Blog.objects.annotate(number_of_entries=Count("entry"))
# The number of entries on the first blog, using the name provided
&gt;&gt;&gt; q[0].number_of_entries
42
</pre> <p>For an in-depth discussion of aggregation, see <a class="reference internal" href="../../topics/db/aggregation.html"><span class="doc">the topic guide on Aggregation</span></a>.</p> </section> <section id="s-alias"> <h4 id="alias"><code>alias()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.alias">
<code>alias(*args, **kwargs)</code> </dt> 
</dl> <p>Same as <a class="reference internal" href="#django.db.models.query.QuerySet.annotate" title="django.db.models.query.QuerySet.annotate"><code>annotate()</code></a>, but instead of annotating objects in the <code>QuerySet</code>, saves the expression for later reuse with other <code>QuerySet</code> methods. This is useful when the result of the expression itself is not needed but it is used for filtering, ordering, or as a part of a complex expression. Not selecting the unused value removes redundant work from the database which should result in better performance.</p> <p>For example, if you want to find blogs with more than 5 entries, but are not interested in the exact number of entries, you could do this:</p> <pre data-language="pycon">&gt;&gt;&gt; from django.db.models import Count
&gt;&gt;&gt; blogs = Blog.objects.alias(entries=Count("entry")).filter(entries__gt=5)
</pre> <p><code>alias()</code> can be used in conjunction with <a class="reference internal" href="#django.db.models.query.QuerySet.annotate" title="django.db.models.query.QuerySet.annotate"><code>annotate()</code></a>, <a class="reference internal" href="#django.db.models.query.QuerySet.exclude" title="django.db.models.query.QuerySet.exclude"><code>exclude()</code></a>, <a class="reference internal" href="#django.db.models.query.QuerySet.filter" title="django.db.models.query.QuerySet.filter"><code>filter()</code></a>, <a class="reference internal" href="#django.db.models.query.QuerySet.order_by" title="django.db.models.query.QuerySet.order_by"><code>order_by()</code></a>, and <a class="reference internal" href="#django.db.models.query.QuerySet.update" title="django.db.models.query.QuerySet.update"><code>update()</code></a>. To use aliased expression with other methods (e.g. <a class="reference internal" href="#django.db.models.query.QuerySet.aggregate" title="django.db.models.query.QuerySet.aggregate"><code>aggregate()</code></a>), you must promote it to an annotation:</p> <pre data-language="python">Blog.objects.alias(entries=Count("entry")).annotate(
    entries=F("entries"),
).aggregate(Sum("entries"))
</pre> <p><a class="reference internal" href="#django.db.models.query.QuerySet.filter" title="django.db.models.query.QuerySet.filter"><code>filter()</code></a> and <a class="reference internal" href="#django.db.models.query.QuerySet.order_by" title="django.db.models.query.QuerySet.order_by"><code>order_by()</code></a> can take expressions directly, but expression construction and usage often does not happen in the same place (for example, <code>QuerySet</code> method creates expressions, for later use in views). <code>alias()</code> allows building complex expressions incrementally, possibly spanning multiple methods and modules, refer to the expression parts by their aliases and only use <a class="reference internal" href="#django.db.models.query.QuerySet.annotate" title="django.db.models.query.QuerySet.annotate"><code>annotate()</code></a> for the final result.</p> </section> <section id="s-order-by"> <h4 id="order-by"><code>order_by()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.order_by">
<code>order_by(*fields)</code> </dt> 
</dl> <p>By default, results returned by a <code>QuerySet</code> are ordered by the ordering tuple given by the <code>ordering</code> option in the model’s <code>Meta</code>. You can override this on a per-<code>QuerySet</code> basis by using the <code>order_by</code> method.</p> <p>Example:</p> <pre data-language="python">Entry.objects.filter(pub_date__year=2005).order_by("-pub_date", "headline")
</pre> <p>The result above will be ordered by <code>pub_date</code> descending, then by <code>headline</code> ascending. The negative sign in front of <code>"-pub_date"</code> indicates <em>descending</em> order. Ascending order is implied. To order randomly, use <code>"?"</code>, like so:</p> <pre data-language="python">Entry.objects.order_by("?")
</pre> <p>Note: <code>order_by('?')</code> queries may be expensive and slow, depending on the database backend you’re using.</p> <p>To order by a field in a different model, use the same syntax as when you are querying across model relations. That is, the name of the field, followed by a double underscore (<code>__</code>), followed by the name of the field in the new model, and so on for as many models as you want to join. For example:</p> <pre data-language="python">Entry.objects.order_by("blog__name", "headline")
</pre> <p>If you try to order by a field that is a relation to another model, Django will use the default ordering on the related model, or order by the related model’s primary key if there is no <a class="reference internal" href="options.html#django.db.models.Options.ordering" title="django.db.models.Options.ordering"><code>Meta.ordering</code></a> specified. For example, since the <code>Blog</code> model has no default ordering specified:</p> <pre data-language="python">Entry.objects.order_by("blog")
</pre> <p>…is identical to:</p> <pre data-language="python">Entry.objects.order_by("blog__id")
</pre> <p>If <code>Blog</code> had <code>ordering = ['name']</code>, then the first queryset would be identical to:</p> <pre data-language="python">Entry.objects.order_by("blog__name")
</pre> <p>You can also order by <a class="reference internal" href="expressions.html"><span class="doc">query expressions</span></a> by calling <a class="reference internal" href="expressions.html#django.db.models.Expression.asc" title="django.db.models.Expression.asc"><code>asc()</code></a> or <a class="reference internal" href="expressions.html#django.db.models.Expression.desc" title="django.db.models.Expression.desc"><code>desc()</code></a> on the expression:</p> <pre data-language="python">Entry.objects.order_by(Coalesce("summary", "headline").desc())
</pre> <p><a class="reference internal" href="expressions.html#django.db.models.Expression.asc" title="django.db.models.Expression.asc"><code>asc()</code></a> and <a class="reference internal" href="expressions.html#django.db.models.Expression.desc" title="django.db.models.Expression.desc"><code>desc()</code></a> have arguments (<code>nulls_first</code> and <code>nulls_last</code>) that control how null values are sorted.</p> <p>Be cautious when ordering by fields in related models if you are also using <a class="reference internal" href="#django.db.models.query.QuerySet.distinct" title="django.db.models.query.QuerySet.distinct"><code>distinct()</code></a>. See the note in <a class="reference internal" href="#django.db.models.query.QuerySet.distinct" title="django.db.models.query.QuerySet.distinct"><code>distinct()</code></a> for an explanation of how related model ordering can change the expected results.</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>It is permissible to specify a multi-valued field to order the results by (for example, a <a class="reference internal" href="fields.html#django.db.models.ManyToManyField" title="django.db.models.ManyToManyField"><code>ManyToManyField</code></a> field, or the reverse relation of a <a class="reference internal" href="fields.html#django.db.models.ForeignKey" title="django.db.models.ForeignKey"><code>ForeignKey</code></a> field).</p> <p>Consider this case:</p> <pre data-language="python">class Event(Model):
    parent = models.ForeignKey(
        "self",
        on_delete=models.CASCADE,
        related_name="children",
    )
    date = models.DateField()


Event.objects.order_by("children__date")
</pre> <p>Here, there could potentially be multiple ordering data for each <code>Event</code>; each <code>Event</code> with multiple <code>children</code> will be returned multiple times into the new <code>QuerySet</code> that <code>order_by()</code> creates. In other words, using <code>order_by()</code> on the <code>QuerySet</code> could return more items than you were working on to begin with - which is probably neither expected nor useful.</p> <p>Thus, take care when using multi-valued field to order the results. <strong>If</strong> you can be sure that there will only be one ordering piece of data for each of the items you’re ordering, this approach should not present problems. If not, make sure the results are what you expect.</p> </div> <p>There’s no way to specify whether ordering should be case sensitive. With respect to case-sensitivity, Django will order results however your database backend normally orders them.</p> <p>You can order by a field converted to lowercase with <a class="reference internal" href="database-functions.html#django.db.models.functions.Lower" title="django.db.models.functions.Lower"><code>Lower</code></a> which will achieve case-consistent ordering:</p> <pre data-language="python">Entry.objects.order_by(Lower("headline").desc())
</pre> <p>If you don’t want any ordering to be applied to a query, not even the default ordering, call <a class="reference internal" href="#django.db.models.query.QuerySet.order_by" title="django.db.models.query.QuerySet.order_by"><code>order_by()</code></a> with no parameters.</p> <p>You can tell if a query is ordered or not by checking the <a class="reference internal" href="#django.db.models.query.QuerySet.ordered" title="django.db.models.query.QuerySet.ordered"><code>QuerySet.ordered</code></a> attribute, which will be <code>True</code> if the <code>QuerySet</code> has been ordered in any way.</p> <p>Each <code>order_by()</code> call will clear any previous ordering. For example, this query will be ordered by <code>pub_date</code> and not <code>headline</code>:</p> <pre data-language="python">Entry.objects.order_by("headline").order_by("pub_date")
</pre> <div class="admonition warning"> <p class="admonition-title">Warning</p> <p>Ordering is not a free operation. Each field you add to the ordering incurs a cost to your database. Each foreign key you add will implicitly include all of its default orderings as well.</p> <p>If a query doesn’t have an ordering specified, results are returned from the database in an unspecified order. A particular ordering is guaranteed only when ordering by a set of fields that uniquely identify each object in the results. For example, if a <code>name</code> field isn’t unique, ordering by it won’t guarantee objects with the same name always appear in the same order.</p> </div> </section> <section id="s-reverse"> <h4 id="reverse"><code>reverse()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.reverse">
<code>reverse()</code> </dt> 
</dl> <p>Use the <code>reverse()</code> method to reverse the order in which a queryset’s elements are returned. Calling <code>reverse()</code> a second time restores the ordering back to the normal direction.</p> <p>To retrieve the “last” five items in a queryset, you could do this:</p> <pre data-language="python">my_queryset.reverse()[:5]
</pre> <p>Note that this is not quite the same as slicing from the end of a sequence in Python. The above example will return the last item first, then the penultimate item and so on. If we had a Python sequence and looked at <code>seq[-5:]</code>, we would see the fifth-last item first. Django doesn’t support that mode of access (slicing from the end), because it’s not possible to do it efficiently in SQL.</p> <p>Also, note that <code>reverse()</code> should generally only be called on a <code>QuerySet</code> which has a defined ordering (e.g., when querying against a model which defines a default ordering, or when using <a class="reference internal" href="#django.db.models.query.QuerySet.order_by" title="django.db.models.query.QuerySet.order_by"><code>order_by()</code></a>). If no such ordering is defined for a given <code>QuerySet</code>, calling <code>reverse()</code> on it has no real effect (the ordering was undefined prior to calling <code>reverse()</code>, and will remain undefined afterward).</p> </section> <section id="s-distinct"> <h4 id="distinct"><code>distinct()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.distinct">
<code>distinct(*fields)</code> </dt> 
</dl> <p>Returns a new <code>QuerySet</code> that uses <code>SELECT DISTINCT</code> in its SQL query. This eliminates duplicate rows from the query results.</p> <p>By default, a <code>QuerySet</code> will not eliminate duplicate rows. In practice, this is rarely a problem, because simple queries such as <code>Blog.objects.all()</code> don’t introduce the possibility of duplicate result rows. However, if your query spans multiple tables, it’s possible to get duplicate results when a <code>QuerySet</code> is evaluated. That’s when you’d use <code>distinct()</code>.</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>Any fields used in an <a class="reference internal" href="#django.db.models.query.QuerySet.order_by" title="django.db.models.query.QuerySet.order_by"><code>order_by()</code></a> call are included in the SQL <code>SELECT</code> columns. This can sometimes lead to unexpected results when used in conjunction with <code>distinct()</code>. If you order by fields from a related model, those fields will be added to the selected columns and they may make otherwise duplicate rows appear to be distinct. Since the extra columns don’t appear in the returned results (they are only there to support ordering), it sometimes looks like non-distinct results are being returned.</p> <p>Similarly, if you use a <a class="reference internal" href="#django.db.models.query.QuerySet.values" title="django.db.models.query.QuerySet.values"><code>values()</code></a> query to restrict the columns selected, the columns used in any <a class="reference internal" href="#django.db.models.query.QuerySet.order_by" title="django.db.models.query.QuerySet.order_by"><code>order_by()</code></a> (or default model ordering) will still be involved and may affect uniqueness of the results.</p> <p>The moral here is that if you are using <code>distinct()</code> be careful about ordering by related models. Similarly, when using <code>distinct()</code> and <a class="reference internal" href="#django.db.models.query.QuerySet.values" title="django.db.models.query.QuerySet.values"><code>values()</code></a> together, be careful when ordering by fields not in the <a class="reference internal" href="#django.db.models.query.QuerySet.values" title="django.db.models.query.QuerySet.values"><code>values()</code></a> call.</p> </div> <p>On PostgreSQL only, you can pass positional arguments (<code>*fields</code>) in order to specify the names of fields to which the <code>DISTINCT</code> should apply. This translates to a <code>SELECT DISTINCT ON</code> SQL query. Here’s the difference. For a normal <code>distinct()</code> call, the database compares <em>each</em> field in each row when determining which rows are distinct. For a <code>distinct()</code> call with specified field names, the database will only compare the specified field names.</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>When you specify field names, you <em>must</em> provide an <code>order_by()</code> in the <code>QuerySet</code>, and the fields in <code>order_by()</code> must start with the fields in <code>distinct()</code>, in the same order.</p> <p>For example, <code>SELECT DISTINCT ON (a)</code> gives you the first row for each value in column <code>a</code>. If you don’t specify an order, you’ll get some arbitrary row.</p> </div> <p>Examples (those after the first will only work on PostgreSQL):</p> <pre data-language="pycon">&gt;&gt;&gt; Author.objects.distinct()
[...]

&gt;&gt;&gt; Entry.objects.order_by("pub_date").distinct("pub_date")
[...]

&gt;&gt;&gt; Entry.objects.order_by("blog").distinct("blog")
[...]

&gt;&gt;&gt; Entry.objects.order_by("author", "pub_date").distinct("author", "pub_date")
[...]

&gt;&gt;&gt; Entry.objects.order_by("blog__name", "mod_date").distinct("blog__name", "mod_date")
[...]

&gt;&gt;&gt; Entry.objects.order_by("author", "pub_date").distinct("author")
[...]
</pre> <div class="admonition note"> <p class="admonition-title">Note</p> <p>Keep in mind that <a class="reference internal" href="#django.db.models.query.QuerySet.order_by" title="django.db.models.query.QuerySet.order_by"><code>order_by()</code></a> uses any default related model ordering that has been defined. You might have to explicitly order by the relation <code>_id</code> or referenced field to make sure the <code>DISTINCT ON</code> expressions match those at the beginning of the <code>ORDER BY</code> clause. For example, if the <code>Blog</code> model defined an <a class="reference internal" href="options.html#django.db.models.Options.ordering" title="django.db.models.Options.ordering"><code>ordering</code></a> by <code>name</code>:</p> <pre data-language="python">Entry.objects.order_by("blog").distinct("blog")
</pre> <p>…wouldn’t work because the query would be ordered by <code>blog__name</code> thus mismatching the <code>DISTINCT ON</code> expression. You’d have to explicitly order by the relation <code>_id</code> field (<code>blog_id</code> in this case) or the referenced one (<code>blog__pk</code>) to make sure both expressions match.</p> </div> </section> <section id="s-values"> <h4 id="values"><code>values()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.values">
<code>values(*fields, **expressions)</code> </dt> 
</dl> <p>Returns a <code>QuerySet</code> that returns dictionaries, rather than model instances, when used as an iterable.</p> <p>Each of those dictionaries represents an object, with the keys corresponding to the attribute names of model objects.</p> <p>This example compares the dictionaries of <code>values()</code> with the normal model objects:</p> <pre data-language="pycon"># This list contains a Blog object.
&gt;&gt;&gt; Blog.objects.filter(name__startswith="Beatles")
&lt;QuerySet [&lt;Blog: Beatles Blog&gt;]&gt;

# This list contains a dictionary.
&gt;&gt;&gt; Blog.objects.filter(name__startswith="Beatles").values()
&lt;QuerySet [{'id': 1, 'name': 'Beatles Blog', 'tagline': 'All the latest Beatles news.'}]&gt;
</pre> <p>The <code>values()</code> method takes optional positional arguments, <code>*fields</code>, which specify field names to which the <code>SELECT</code> should be limited. If you specify the fields, each dictionary will contain only the field keys/values for the fields you specify. If you don’t specify the fields, each dictionary will contain a key and value for every field in the database table.</p> <p>Example:</p> <pre data-language="pycon">&gt;&gt;&gt; Blog.objects.values()
&lt;QuerySet [{'id': 1, 'name': 'Beatles Blog', 'tagline': 'All the latest Beatles news.'}]&gt;
&gt;&gt;&gt; Blog.objects.values("id", "name")
&lt;QuerySet [{'id': 1, 'name': 'Beatles Blog'}]&gt;
</pre> <p>The <code>values()</code> method also takes optional keyword arguments, <code>**expressions</code>, which are passed through to <a class="reference internal" href="#django.db.models.query.QuerySet.annotate" title="django.db.models.query.QuerySet.annotate"><code>annotate()</code></a>:</p> <pre data-language="pycon">&gt;&gt;&gt; from django.db.models.functions import Lower
&gt;&gt;&gt; Blog.objects.values(lower_name=Lower("name"))
&lt;QuerySet [{'lower_name': 'beatles blog'}]&gt;
</pre> <p>You can use built-in and <a class="reference internal" href="../../howto/custom-lookups.html"><span class="doc">custom lookups</span></a> in ordering. For example:</p> <pre data-language="pycon">&gt;&gt;&gt; from django.db.models import CharField
&gt;&gt;&gt; from django.db.models.functions import Lower
&gt;&gt;&gt; CharField.register_lookup(Lower)
&gt;&gt;&gt; Blog.objects.values("name__lower")
&lt;QuerySet [{'name__lower': 'beatles blog'}]&gt;
</pre> <p>An aggregate within a <code>values()</code> clause is applied before other arguments within the same <code>values()</code> clause. If you need to group by another value, add it to an earlier <code>values()</code> clause instead. For example:</p> <pre data-language="pycon">&gt;&gt;&gt; from django.db.models import Count
&gt;&gt;&gt; Blog.objects.values("entry__authors", entries=Count("entry"))
&lt;QuerySet [{'entry__authors': 1, 'entries': 20}, {'entry__authors': 1, 'entries': 13}]&gt;
&gt;&gt;&gt; Blog.objects.values("entry__authors").annotate(entries=Count("entry"))
&lt;QuerySet [{'entry__authors': 1, 'entries': 33}]&gt;
</pre> <p>A few subtleties that are worth mentioning:</p> <ul> <li>
<p>If you have a field called <code>foo</code> that is a <a class="reference internal" href="fields.html#django.db.models.ForeignKey" title="django.db.models.ForeignKey"><code>ForeignKey</code></a>, the default <code>values()</code> call will return a dictionary key called <code>foo_id</code>, since this is the name of the hidden model attribute that stores the actual value (the <code>foo</code> attribute refers to the related model). When you are calling <code>values()</code> and passing in field names, you can pass in either <code>foo</code> or <code>foo_id</code> and you will get back the same thing (the dictionary key will match the field name you passed in).</p> <p>For example:</p> <pre data-language="pycon">&gt;&gt;&gt; Entry.objects.values()
&lt;QuerySet [{'blog_id': 1, 'headline': 'First Entry', ...}, ...]&gt;

&gt;&gt;&gt; Entry.objects.values("blog")
&lt;QuerySet [{'blog': 1}, ...]&gt;

&gt;&gt;&gt; Entry.objects.values("blog_id")
&lt;QuerySet [{'blog_id': 1}, ...]&gt;
</pre> </li> <li>When using <code>values()</code> together with <a class="reference internal" href="#django.db.models.query.QuerySet.distinct" title="django.db.models.query.QuerySet.distinct"><code>distinct()</code></a>, be aware that ordering can affect the results. See the note in <a class="reference internal" href="#django.db.models.query.QuerySet.distinct" title="django.db.models.query.QuerySet.distinct"><code>distinct()</code></a> for details.</li> <li>If you use a <code>values()</code> clause after an <a class="reference internal" href="#django.db.models.query.QuerySet.extra" title="django.db.models.query.QuerySet.extra"><code>extra()</code></a> call, any fields defined by a <code>select</code> argument in the <a class="reference internal" href="#django.db.models.query.QuerySet.extra" title="django.db.models.query.QuerySet.extra"><code>extra()</code></a> must be explicitly included in the <code>values()</code> call. Any <a class="reference internal" href="#django.db.models.query.QuerySet.extra" title="django.db.models.query.QuerySet.extra"><code>extra()</code></a> call made after a <code>values()</code> call will have its extra selected fields ignored.</li> <li>Calling <a class="reference internal" href="#django.db.models.query.QuerySet.only" title="django.db.models.query.QuerySet.only"><code>only()</code></a> and <a class="reference internal" href="#django.db.models.query.QuerySet.defer" title="django.db.models.query.QuerySet.defer"><code>defer()</code></a> after <code>values()</code> doesn’t make sense, so doing so will raise a <code>TypeError</code>.</li> <li>
<p>Combining transforms and aggregates requires the use of two <a class="reference internal" href="#django.db.models.query.QuerySet.annotate" title="django.db.models.query.QuerySet.annotate"><code>annotate()</code></a> calls, either explicitly or as keyword arguments to <a class="reference internal" href="#django.db.models.query.QuerySet.values" title="django.db.models.query.QuerySet.values"><code>values()</code></a>. As above, if the transform has been registered on the relevant field type the first <a class="reference internal" href="#django.db.models.query.QuerySet.annotate" title="django.db.models.query.QuerySet.annotate"><code>annotate()</code></a> can be omitted, thus the following examples are equivalent:</p> <pre data-language="pycon">&gt;&gt;&gt; from django.db.models import CharField, Count
&gt;&gt;&gt; from django.db.models.functions import Lower
&gt;&gt;&gt; CharField.register_lookup(Lower)
&gt;&gt;&gt; Blog.objects.values("entry__authors__name__lower").annotate(entries=Count("entry"))
&lt;QuerySet [{'entry__authors__name__lower': 'test author', 'entries': 33}]&gt;
&gt;&gt;&gt; Blog.objects.values(entry__authors__name__lower=Lower("entry__authors__name")).annotate(
...     entries=Count("entry")
... )
&lt;QuerySet [{'entry__authors__name__lower': 'test author', 'entries': 33}]&gt;
&gt;&gt;&gt; Blog.objects.annotate(entry__authors__name__lower=Lower("entry__authors__name")).values(
...     "entry__authors__name__lower"
... ).annotate(entries=Count("entry"))
&lt;QuerySet [{'entry__authors__name__lower': 'test author', 'entries': 33}]&gt;
</pre> </li> </ul> <p>It is useful when you know you’re only going to need values from a small number of the available fields and you won’t need the functionality of a model instance object. It’s more efficient to select only the fields you need to use.</p> <p>Finally, note that you can call <code>filter()</code>, <code>order_by()</code>, etc. after the <code>values()</code> call, that means that these two calls are identical:</p> <pre data-language="python">Blog.objects.values().order_by("id")
Blog.objects.order_by("id").values()
</pre> <p>The people who made Django prefer to put all the SQL-affecting methods first, followed (optionally) by any output-affecting methods (such as <code>values()</code>), but it doesn’t really matter. This is your chance to really flaunt your individualism.</p> <p>You can also refer to fields on related models with reverse relations through <code>OneToOneField</code>, <code>ForeignKey</code> and <code>ManyToManyField</code> attributes:</p> <pre data-language="pycon">&gt;&gt;&gt; Blog.objects.values("name", "entry__headline")
&lt;QuerySet [{'name': 'My blog', 'entry__headline': 'An entry'},
     {'name': 'My blog', 'entry__headline': 'Another entry'}, ...]&gt;
</pre> <div class="admonition warning"> <p class="admonition-title">Warning</p> <p>Because <a class="reference internal" href="fields.html#django.db.models.ManyToManyField" title="django.db.models.ManyToManyField"><code>ManyToManyField</code></a> attributes and reverse relations can have multiple related rows, including these can have a multiplier effect on the size of your result set. This will be especially pronounced if you include multiple such fields in your <code>values()</code> query, in which case all possible combinations will be returned.</p> </div> <div class="admonition-special-values-for-jsonfield-on-sqlite admonition"> <p class="admonition-title">Special values for <code>JSONField</code> on SQLite</p> <p>Due to the way the <code>JSON_EXTRACT</code> and <code>JSON_TYPE</code> SQL functions are implemented on SQLite, and lack of the <code>BOOLEAN</code> data type, <code>values()</code> will return <code>True</code>, <code>False</code>, and <code>None</code> instead of <code>"true"</code>, <code>"false"</code>, and <code>"null"</code> strings for <a class="reference internal" href="fields.html#django.db.models.JSONField" title="django.db.models.JSONField"><code>JSONField</code></a> key transforms.</p> </div> <div class="versionchanged"> <span class="title">Changed in Django 5.2:</span> <p>The <code>SELECT</code> clause generated when using <code>values()</code> was updated to respect the order of the specified <code>*fields</code> and <code>**expressions</code>.</p> </div> </section> <section id="s-values-list"> <h4 id="values-list"><code>values_list()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.values_list">
<code>values_list(*fields, flat=False, named=False)</code> </dt> 
</dl> <p>This is similar to <code>values()</code> except that instead of returning dictionaries, it returns tuples when iterated over. Each tuple contains the value from the respective field or expression passed into the <code>values_list()</code> call — so the first item is the first field, etc. For example:</p> <pre data-language="pycon">&gt;&gt;&gt; Entry.objects.values_list("id", "headline")
&lt;QuerySet [(1, 'First entry'), ...]&gt;
&gt;&gt;&gt; from django.db.models.functions import Lower
&gt;&gt;&gt; Entry.objects.values_list("id", Lower("headline"))
&lt;QuerySet [(1, 'first entry'), ...]&gt;
</pre> <p>If you only pass in a single field, you can also pass in the <code>flat</code> parameter. If <code>True</code>, this will mean the returned results are single values, rather than 1-tuples. An example should make the difference clearer:</p> <pre data-language="pycon">&gt;&gt;&gt; Entry.objects.values_list("id").order_by("id")
&lt;QuerySet[(1,), (2,), (3,), ...]&gt;

&gt;&gt;&gt; Entry.objects.values_list("id", flat=True).order_by("id")
&lt;QuerySet [1, 2, 3, ...]&gt;
</pre> <p>It is an error to pass in <code>flat</code> when there is more than one field.</p> <p>You can pass <code>named=True</code> to get results as a <a class="reference external" href="https://docs.python.org/3/library/collections.html#collections.namedtuple" title="(in Python v3.13)"><code>namedtuple()</code></a>:</p> <pre data-language="pycon">&gt;&gt;&gt; Entry.objects.values_list("id", "headline", named=True)
&lt;QuerySet [Row(id=1, headline='First entry'), ...]&gt;
</pre> <p>Using a named tuple may make use of the results more readable, at the expense of a small performance penalty for transforming the results into a named tuple.</p> <p>If you don’t pass any values to <code>values_list()</code>, it will return all the fields in the model, in the order they were declared.</p> <p>A common need is to get a specific field value of a certain model instance. To achieve that, use <code>values_list()</code> followed by a <code>get()</code> call:</p> <pre data-language="pycon">&gt;&gt;&gt; Entry.objects.values_list("headline", flat=True).get(pk=1)
'First entry'
</pre> <p><code>values()</code> and <code>values_list()</code> are both intended as optimizations for a specific use case: retrieving a subset of data without the overhead of creating a model instance. This metaphor falls apart when dealing with many-to-many and other multivalued relations (such as the one-to-many relation of a reverse foreign key) because the “one row, one object” assumption doesn’t hold.</p> <p>For example, notice the behavior when querying across a <a class="reference internal" href="fields.html#django.db.models.ManyToManyField" title="django.db.models.ManyToManyField"><code>ManyToManyField</code></a>:</p> <pre data-language="pycon">&gt;&gt;&gt; Author.objects.values_list("name", "entry__headline")
&lt;QuerySet [('Noam Chomsky', 'Impressions of Gaza'),
 ('George Orwell', 'Why Socialists Do Not Believe in Fun'),
 ('George Orwell', 'In Defence of English Cooking'),
 ('Don Quixote', None)]&gt;
</pre> <p>Authors with multiple entries appear multiple times and authors without any entries have <code>None</code> for the entry headline.</p> <p>Similarly, when querying a reverse foreign key, <code>None</code> appears for entries not having any author:</p> <pre data-language="pycon">&gt;&gt;&gt; Entry.objects.values_list("authors")
&lt;QuerySet [('Noam Chomsky',), ('George Orwell',), (None,)]&gt;
</pre> <div class="admonition-special-values-for-jsonfield-on-sqlite admonition"> <p class="admonition-title">Special values for <code>JSONField</code> on SQLite</p> <p>Due to the way the <code>JSON_EXTRACT</code> and <code>JSON_TYPE</code> SQL functions are implemented on SQLite, and lack of the <code>BOOLEAN</code> data type, <code>values_list()</code> will return <code>True</code>, <code>False</code>, and <code>None</code> instead of <code>"true"</code>, <code>"false"</code>, and <code>"null"</code> strings for <a class="reference internal" href="fields.html#django.db.models.JSONField" title="django.db.models.JSONField"><code>JSONField</code></a> key transforms.</p> </div> <div class="versionchanged"> <span class="title">Changed in Django 5.2:</span> <p>The <code>SELECT</code> clause generated when using <code>values_list()</code> was updated to respect the order of the specified <code>*fields</code>.</p> </div> </section> <section id="s-dates"> <h4 id="dates"><code>dates()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.dates">
<code>dates(field, kind, order='ASC')</code> </dt> 
</dl> <p>Returns a <code>QuerySet</code> that evaluates to a list of <a class="reference external" href="https://docs.python.org/3/library/datetime.html#datetime.date" title="(in Python v3.13)"><code>datetime.date</code></a> objects representing all available dates of a particular kind within the contents of the <code>QuerySet</code>.</p> <p><code>field</code> should be the name of a <code>DateField</code> of your model. <code>kind</code> should be either <code>"year"</code>, <code>"month"</code>, <code>"week"</code>, or <code>"day"</code>. Each <a class="reference external" href="https://docs.python.org/3/library/datetime.html#datetime.date" title="(in Python v3.13)"><code>datetime.date</code></a> object in the result list is “truncated” to the given <code>type</code>.</p> <ul class="simple"> <li>
<code>"year"</code> returns a list of all distinct year values for the field.</li> <li>
<code>"month"</code> returns a list of all distinct year/month values for the field.</li> <li>
<code>"week"</code> returns a list of all distinct year/week values for the field. All dates will be a Monday.</li> <li>
<code>"day"</code> returns a list of all distinct year/month/day values for the field.</li> </ul> <p><code>order</code>, which defaults to <code>'ASC'</code>, should be either <code>'ASC'</code> or <code>'DESC'</code>. This specifies how to order the results.</p> <p>Examples:</p> <pre data-language="pycon">&gt;&gt;&gt; Entry.objects.dates("pub_date", "year")
[datetime.date(2005, 1, 1)]
&gt;&gt;&gt; Entry.objects.dates("pub_date", "month")
[datetime.date(2005, 2, 1), datetime.date(2005, 3, 1)]
&gt;&gt;&gt; Entry.objects.dates("pub_date", "week")
[datetime.date(2005, 2, 14), datetime.date(2005, 3, 14)]
&gt;&gt;&gt; Entry.objects.dates("pub_date", "day")
[datetime.date(2005, 2, 20), datetime.date(2005, 3, 20)]
&gt;&gt;&gt; Entry.objects.dates("pub_date", "day", order="DESC")
[datetime.date(2005, 3, 20), datetime.date(2005, 2, 20)]
&gt;&gt;&gt; Entry.objects.filter(headline__contains="Lennon").dates("pub_date", "day")
[datetime.date(2005, 3, 20)]
</pre> </section> <section id="s-datetimes"> <h4 id="datetimes"><code>datetimes()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.datetimes">
<code>datetimes(field_name, kind, order='ASC', tzinfo=None)</code> </dt> 
</dl> <p>Returns a <code>QuerySet</code> that evaluates to a list of <a class="reference external" href="https://docs.python.org/3/library/datetime.html#datetime.datetime" title="(in Python v3.13)"><code>datetime.datetime</code></a> objects representing all available dates of a particular kind within the contents of the <code>QuerySet</code>.</p> <p><code>field_name</code> should be the name of a <code>DateTimeField</code> of your model.</p> <p><code>kind</code> should be either <code>"year"</code>, <code>"month"</code>, <code>"week"</code>, <code>"day"</code>, <code>"hour"</code>, <code>"minute"</code>, or <code>"second"</code>. Each <a class="reference external" href="https://docs.python.org/3/library/datetime.html#datetime.datetime" title="(in Python v3.13)"><code>datetime.datetime</code></a> object in the result list is “truncated” to the given <code>type</code>.</p> <p><code>order</code>, which defaults to <code>'ASC'</code>, should be either <code>'ASC'</code> or <code>'DESC'</code>. This specifies how to order the results.</p> <p><code>tzinfo</code> defines the time zone to which datetimes are converted prior to truncation. Indeed, a given datetime has different representations depending on the time zone in use. This parameter must be a <a class="reference external" href="https://docs.python.org/3/library/datetime.html#datetime.tzinfo" title="(in Python v3.13)"><code>datetime.tzinfo</code></a> object. If it’s <code>None</code>, Django uses the <a class="reference internal" href="../../topics/i18n/timezones.html#default-current-time-zone"><span class="std std-ref">current time zone</span></a>. It has no effect when <a class="reference internal" href="../settings.html#std-setting-USE_TZ"><code>USE_TZ</code></a> is <code>False</code>.</p> <div class="admonition note" id="database-time-zone-definitions"> <p class="admonition-title">Note</p> <p>This function performs time zone conversions directly in the database. As a consequence, your database must be able to interpret the value of <code>tzinfo.tzname(None)</code>. This translates into the following requirements:</p> <ul class="simple"> <li>SQLite: no requirements. Conversions are performed in Python.</li> <li>PostgreSQL: no requirements (see <a class="reference external" href="https://www.postgresql.org/docs/current/datatype-datetime.html#DATATYPE-TIMEZONES">Time Zones</a>).</li> <li>Oracle: no requirements (see <a class="reference external" href="https://docs.oracle.com/en/database/oracle/oracle-database/18/nlspg/datetime-data-types-and-time-zone-support.html#GUID-805AB986-DE12-4FEA-AF56-5AABCD2132DF">Choosing a Time Zone File</a>).</li> <li>MySQL: load the time zone tables with <a class="reference external" href="https://dev.mysql.com/doc/refman/en/mysql-tzinfo-to-sql.html">mysql_tzinfo_to_sql</a>.</li> </ul> </div> </section> <section id="s-none"> <h4 id="none"><code>none()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.none">
<code>none()</code> </dt> 
</dl> <p>Calling <code>none()</code> will create a queryset that never returns any objects and no query will be executed when accessing the results. A <code>qs.none()</code> queryset is an instance of <code>EmptyQuerySet</code>.</p> <p>Examples:</p> <pre data-language="pycon">&gt;&gt;&gt; Entry.objects.none()
&lt;QuerySet []&gt;
&gt;&gt;&gt; from django.db.models.query import EmptyQuerySet
&gt;&gt;&gt; isinstance(Entry.objects.none(), EmptyQuerySet)
True
</pre> </section> <section id="s-all"> <h4 id="all"><code>all()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.all">
<code>all()</code> </dt> 
</dl> <p>Returns a <em>copy</em> of the current <code>QuerySet</code> (or <code>QuerySet</code> subclass). This can be useful in situations where you might want to pass in either a model manager or a <code>QuerySet</code> and do further filtering on the result. After calling <code>all()</code> on either object, you’ll definitely have a <code>QuerySet</code> to work with.</p> <p>When a <code>QuerySet</code> is <a class="reference internal" href="#when-querysets-are-evaluated"><span class="std std-ref">evaluated</span></a>, it typically caches its results. If the data in the database might have changed since a <code>QuerySet</code> was evaluated, you can get updated results for the same query by calling <code>all()</code> on a previously evaluated <code>QuerySet</code>.</p> </section> <section id="s-union"> <h4 id="union"><code>union()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.union">
<code>union(*other_qs, all=False)</code> </dt> 
</dl> <p>Uses SQL’s <code>UNION</code> operator to combine the results of two or more <code>QuerySet</code>s. For example:</p> <pre data-language="python">&gt;&gt;&gt; qs1.union(qs2, qs3)
</pre> <p>The <code>UNION</code> operator selects only distinct values by default. To allow duplicate values, use the <code>all=True</code> argument.</p> <p><code>union()</code>, <code>intersection()</code>, and <code>difference()</code> return model instances of the type of the first <code>QuerySet</code> even if the arguments are <code>QuerySet</code>s of other models. Passing different models works as long as the <code>SELECT</code> list is the same in all <code>QuerySet</code>s (at least the types, the names don’t matter as long as the types are in the same order). In such cases, you must use the column names from the first <code>QuerySet</code> in <code>QuerySet</code> methods applied to the resulting <code>QuerySet</code>. For example:</p> <pre data-language="pycon">&gt;&gt;&gt; qs1 = Author.objects.values_list("name")
&gt;&gt;&gt; qs2 = Entry.objects.values_list("headline")
&gt;&gt;&gt; qs1.union(qs2).order_by("name")
</pre> <p>In addition, only <code>LIMIT</code>, <code>OFFSET</code>, <code>COUNT(*)</code>, <code>ORDER BY</code>, and specifying columns (i.e. slicing, <a class="reference internal" href="#django.db.models.query.QuerySet.count" title="django.db.models.query.QuerySet.count"><code>count()</code></a>, <a class="reference internal" href="#django.db.models.query.QuerySet.exists" title="django.db.models.query.QuerySet.exists"><code>exists()</code></a>, <a class="reference internal" href="#django.db.models.query.QuerySet.order_by" title="django.db.models.query.QuerySet.order_by"><code>order_by()</code></a>, and <a class="reference internal" href="#django.db.models.query.QuerySet.values" title="django.db.models.query.QuerySet.values"><code>values()</code></a>/<a class="reference internal" href="#django.db.models.query.QuerySet.values_list" title="django.db.models.query.QuerySet.values_list"><code>values_list()</code></a>) are allowed on the resulting <code>QuerySet</code>. Further, databases place restrictions on what operations are allowed in the combined queries. For example, most databases don’t allow <code>LIMIT</code> or <code>OFFSET</code> in the combined queries.</p> </section> <section id="s-intersection"> <h4 id="intersection"><code>intersection()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.intersection">
<code>intersection(*other_qs)</code> </dt> 
</dl> <p>Uses SQL’s <code>INTERSECT</code> operator to return the shared elements of two or more <code>QuerySet</code>s. For example:</p> <pre data-language="pycon">&gt;&gt;&gt; qs1.intersection(qs2, qs3)
</pre> <p>See <a class="reference internal" href="#django.db.models.query.QuerySet.union" title="django.db.models.query.QuerySet.union"><code>union()</code></a> for some restrictions.</p> </section> <section id="s-difference"> <h4 id="difference"><code>difference()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.difference">
<code>difference(*other_qs)</code> </dt> 
</dl> <p>Uses SQL’s <code>EXCEPT</code> operator to keep only elements present in the <code>QuerySet</code> but not in some other <code>QuerySet</code>s. For example:</p> <pre data-language="pycon">&gt;&gt;&gt; qs1.difference(qs2, qs3)
</pre> <p>See <a class="reference internal" href="#django.db.models.query.QuerySet.union" title="django.db.models.query.QuerySet.union"><code>union()</code></a> for some restrictions.</p> </section> <section id="s-select-related"> <h4 id="select-related"><code>select_related()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.select_related">
<code>select_related(*fields)</code> </dt> 
</dl> <p>Returns a <code>QuerySet</code> that will “follow” foreign-key relationships, selecting additional related-object data when it executes its query. This is a performance booster which results in a single more complex query but means later use of foreign-key relationships won’t require database queries.</p> <p>The following examples illustrate the difference between plain lookups and <code>select_related()</code> lookups. Here’s standard lookup:</p> <pre data-language="python"># Hits the database.
e = Entry.objects.get(id=5)

# Hits the database again to get the related Blog object.
b = e.blog
</pre> <p>And here’s <code>select_related</code> lookup:</p> <pre data-language="python"># Hits the database.
e = Entry.objects.select_related("blog").get(id=5)

# Doesn't hit the database, because e.blog has been prepopulated
# in the previous query.
b = e.blog
</pre> <p>You can use <code>select_related()</code> with any queryset of objects:</p> <pre data-language="python">from django.utils import timezone

# Find all the blogs with entries scheduled to be published in the future.
blogs = set()

for e in Entry.objects.filter(pub_date__gt=timezone.now()).select_related("blog"):
    # Without select_related(), this would make a database query for each
    # loop iteration in order to fetch the related blog for each entry.
    blogs.add(e.blog)
</pre> <p>The order of <code>filter()</code> and <code>select_related()</code> chaining isn’t important. These querysets are equivalent:</p> <pre data-language="python">Entry.objects.filter(pub_date__gt=timezone.now()).select_related("blog")
Entry.objects.select_related("blog").filter(pub_date__gt=timezone.now())
</pre> <p>You can follow foreign keys in a similar way to querying them. If you have the following models:</p> <pre data-language="python">from django.db import models


class City(models.Model):
    # ...
    pass


class Person(models.Model):
    # ...
    hometown = models.ForeignKey(
        City,
        on_delete=models.SET_NULL,
        blank=True,
        null=True,
    )


class Book(models.Model):
    # ...
    author = models.ForeignKey(Person, on_delete=models.CASCADE)
</pre> <p>… then a call to <code>Book.objects.select_related('author__hometown').get(id=4)</code> will cache the related <code>Person</code> <em>and</em> the related <code>City</code>:</p> <pre data-language="python"># Hits the database with joins to the author and hometown tables.
b = Book.objects.select_related("author__hometown").get(id=4)
p = b.author  # Doesn't hit the database.
c = p.hometown  # Doesn't hit the database.

# Without select_related()...
b = Book.objects.get(id=4)  # Hits the database.
p = b.author  # Hits the database.
c = p.hometown  # Hits the database.
</pre> <p>You can refer to any <a class="reference internal" href="fields.html#django.db.models.ForeignKey" title="django.db.models.ForeignKey"><code>ForeignKey</code></a> or <a class="reference internal" href="fields.html#django.db.models.OneToOneField" title="django.db.models.OneToOneField"><code>OneToOneField</code></a> relation in the list of fields passed to <code>select_related()</code>.</p> <p>You can also refer to the reverse direction of a <a class="reference internal" href="fields.html#django.db.models.OneToOneField" title="django.db.models.OneToOneField"><code>OneToOneField</code></a> in the list of fields passed to <code>select_related</code> — that is, you can traverse a <a class="reference internal" href="fields.html#django.db.models.OneToOneField" title="django.db.models.OneToOneField"><code>OneToOneField</code></a> back to the object on which the field is defined. Instead of specifying the field name, use the <a class="reference internal" href="fields.html#django.db.models.ForeignKey.related_name" title="django.db.models.ForeignKey.related_name"><code>related_name</code></a> for the field on the related object.</p> <p>There may be some situations where you wish to call <code>select_related()</code> with a lot of related objects, or where you don’t know all of the relations. In these cases it is possible to call <code>select_related()</code> with no arguments. This will follow all non-null foreign keys it can find - nullable foreign keys must be specified. This is not recommended in most cases as it is likely to make the underlying query more complex, and return more data, than is actually needed.</p> <p>If you need to clear the list of related fields added by past calls of <code>select_related</code> on a <code>QuerySet</code>, you can pass <code>None</code> as a parameter:</p> <pre data-language="pycon">&gt;&gt;&gt; without_relations = queryset.select_related(None)
</pre> <p>Chaining <code>select_related</code> calls works in a similar way to other methods - that is that <code>select_related('foo', 'bar')</code> is equivalent to <code>select_related('foo').select_related('bar')</code>.</p> </section> <section id="s-prefetch-related"> <h4 id="prefetch-related"><code>prefetch_related()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.prefetch_related">
<code>prefetch_related(*lookups)</code> </dt> 
</dl> <p>Returns a <code>QuerySet</code> that will automatically retrieve, in a single batch, related objects for each of the specified lookups.</p> <p>This has a similar purpose to <code>select_related</code>, in that both are designed to stop the deluge of database queries that is caused by accessing related objects, but the strategy is quite different.</p> <p><code>select_related</code> works by creating an SQL join and including the fields of the related object in the <code>SELECT</code> statement. For this reason, <code>select_related</code> gets the related objects in the same database query. However, to avoid the much larger result set that would result from joining across a ‘many’ relationship, <code>select_related</code> is limited to single-valued relationships - foreign key and one-to-one.</p> <p><code>prefetch_related</code>, on the other hand, does a separate lookup for each relationship, and does the ‘joining’ in Python. This allows it to prefetch many-to-many, many-to-one, and <a class="reference internal" href="../contrib/contenttypes.html#django.contrib.contenttypes.fields.GenericRelation" title="django.contrib.contenttypes.fields.GenericRelation"><code>GenericRelation</code></a> objects which cannot be done using <code>select_related</code>, in addition to the foreign key and one-to-one relationships that are supported by <code>select_related</code>. It also supports prefetching of <a class="reference internal" href="../contrib/contenttypes.html#django.contrib.contenttypes.fields.GenericForeignKey" title="django.contrib.contenttypes.fields.GenericForeignKey"><code>GenericForeignKey</code></a>, however, the queryset for each <code>ContentType</code> must be provided in the <code>querysets</code> parameter of <a class="reference internal" href="../contrib/contenttypes.html#django.contrib.contenttypes.prefetch.GenericPrefetch" title="django.contrib.contenttypes.prefetch.GenericPrefetch"><code>GenericPrefetch</code></a>.</p> <p>For example, suppose you have these models:</p> <pre data-language="python">from django.db import models


class Topping(models.Model):
    name = models.CharField(max_length=30)


class Pizza(models.Model):
    name = models.CharField(max_length=50)
    toppings = models.ManyToManyField(Topping)

    def __str__(self):
        return "%s (%s)" % (
            self.name,
            ", ".join(topping.name for topping in self.toppings.all()),
        )
</pre> <p>and run:</p> <pre data-language="pycon">&gt;&gt;&gt; Pizza.objects.all()
["Hawaiian (ham, pineapple)", "Seafood (prawns, smoked salmon)"...
</pre> <p>The problem with this is that every time <code>Pizza.__str__()</code> asks for <code>self.toppings.all()</code> it has to query the database, so <code>Pizza.objects.all()</code> will run a query on the Toppings table for <strong>every</strong> item in the Pizza <code>QuerySet</code>.</p> <p>We can reduce to just two queries using <code>prefetch_related</code>:</p> <pre data-language="pycon">&gt;&gt;&gt; Pizza.objects.prefetch_related("toppings")
</pre> <p>This implies a <code>self.toppings.all()</code> for each <code>Pizza</code>; now each time <code>self.toppings.all()</code> is called, instead of having to go to the database for the items, it will find them in a prefetched <code>QuerySet</code> cache that was populated in a single query.</p> <p>That is, all the relevant toppings will have been fetched in a single query, and used to make <code>QuerySets</code> that have a pre-filled cache of the relevant results; these <code>QuerySets</code> are then used in the <code>self.toppings.all()</code> calls.</p> <p>The additional queries in <code>prefetch_related()</code> are executed after the <code>QuerySet</code> has begun to be evaluated and the primary query has been executed.</p> <p>Note that there is no mechanism to prevent another database query from altering the items in between the execution of the primary query and the additional queries, which could produce an inconsistent result. For example, if a <code>Pizza</code> is deleted after the primary query has executed, its toppings will not be returned in the additional query, and it will seem like the pizza has no toppings:</p> <pre data-language="pycon">&gt;&gt;&gt; Pizza.objects.prefetch_related("toppings")
#  "Hawaiian" Pizza was deleted in another shell.
&lt;QuerySet [&lt;Pizza: Hawaiian ()&gt;, &lt;Pizza: Seafood (prawns, smoked salmon)&gt;]&gt;
</pre> <p>If you have an iterable of model instances, you can prefetch related attributes on those instances using the <a class="reference internal" href="#django.db.models.prefetch_related_objects" title="django.db.models.prefetch_related_objects"><code>prefetch_related_objects()</code></a> function.</p> <p>Note that the result cache of the primary <code>QuerySet</code> and all specified related objects will then be fully loaded into memory. This changes the typical behavior of <code>QuerySets</code>, which normally try to avoid loading all objects into memory before they are needed, even after a query has been executed in the database.</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>Remember that, as always with <code>QuerySets</code>, any subsequent chained methods which imply a different database query will ignore previously cached results, and retrieve data using a fresh database query. So, if you write the following:</p> <pre data-language="pycon">&gt;&gt;&gt; pizzas = Pizza.objects.prefetch_related("toppings")
&gt;&gt;&gt; [list(pizza.toppings.filter(spicy=True)) for pizza in pizzas]
</pre> <p>…then the fact that <code>pizza.toppings.all()</code> has been prefetched will not help you. The <code>prefetch_related('toppings')</code> implied <code>pizza.toppings.all()</code>, but <code>pizza.toppings.filter()</code> is a new and different query. The prefetched cache can’t help here; in fact it hurts performance, since you have done a database query that you haven’t used. So use this feature with caution!</p> <p>Also, if you call the database-altering methods <a class="reference internal" href="relations.html#django.db.models.fields.related.RelatedManager.add" title="django.db.models.fields.related.RelatedManager.add"><code>add()</code></a>, <a class="reference internal" href="relations.html#django.db.models.fields.related.RelatedManager.create" title="django.db.models.fields.related.RelatedManager.create"><code>create()</code></a>, <a class="reference internal" href="relations.html#django.db.models.fields.related.RelatedManager.remove" title="django.db.models.fields.related.RelatedManager.remove"><code>remove()</code></a>, <a class="reference internal" href="relations.html#django.db.models.fields.related.RelatedManager.clear" title="django.db.models.fields.related.RelatedManager.clear"><code>clear()</code></a> or <a class="reference internal" href="relations.html#django.db.models.fields.related.RelatedManager.set" title="django.db.models.fields.related.RelatedManager.set"><code>set()</code></a>, on <a class="reference internal" href="relations.html#django.db.models.fields.related.RelatedManager" title="django.db.models.fields.related.RelatedManager"><code>related managers</code></a>, any prefetched cache for the relation will be cleared.</p> </div> <p>You can also use the normal join syntax to do related fields of related fields. Suppose we have an additional model to the example above:</p> <pre data-language="python">class Restaurant(models.Model):
    pizzas = models.ManyToManyField(Pizza, related_name="restaurants")
    best_pizza = models.ForeignKey(
        Pizza, related_name="championed_by", on_delete=models.CASCADE
    )
</pre> <p>The following are all legal:</p> <pre data-language="pycon">&gt;&gt;&gt; Restaurant.objects.prefetch_related("pizzas__toppings")
</pre> <p>This will prefetch all pizzas belonging to restaurants, and all toppings belonging to those pizzas. This will result in a total of 3 database queries - one for the restaurants, one for the pizzas, and one for the toppings.</p> <pre data-language="pycon">&gt;&gt;&gt; Restaurant.objects.prefetch_related("best_pizza__toppings")
</pre> <p>This will fetch the best pizza and all the toppings for the best pizza for each restaurant. This will be done in 3 database queries - one for the restaurants, one for the ‘best pizzas’, and one for the toppings.</p> <p>The <code>best_pizza</code> relationship could also be fetched using <code>select_related</code> to reduce the query count to 2:</p> <pre data-language="pycon">&gt;&gt;&gt; Restaurant.objects.select_related("best_pizza").prefetch_related("best_pizza__toppings")
</pre> <p>Since the prefetch is executed after the main query (which includes the joins needed by <code>select_related</code>), it is able to detect that the <code>best_pizza</code> objects have already been fetched, and it will skip fetching them again.</p> <p>Chaining <code>prefetch_related</code> calls will accumulate the lookups that are prefetched. To clear any <code>prefetch_related</code> behavior, pass <code>None</code> as a parameter:</p> <pre data-language="pycon">&gt;&gt;&gt; non_prefetched = qs.prefetch_related(None)
</pre> <p>One difference to note when using <code>prefetch_related</code> is that objects created by a query can be shared between the different objects that they are related to i.e. a single Python model instance can appear at more than one point in the tree of objects that are returned. This will normally happen with foreign key relationships. Typically this behavior will not be a problem, and will in fact save both memory and CPU time.</p> <p>While <code>prefetch_related</code> supports prefetching <code>GenericForeignKey</code> relationships, the number of queries will depend on the data. Since a <code>GenericForeignKey</code> can reference data in multiple tables, one query per table referenced is needed, rather than one query for all the items. There could be additional queries on the <code>ContentType</code> table if the relevant rows have not already been fetched.</p> <p><code>prefetch_related</code> in most cases will be implemented using an SQL query that uses the ‘IN’ operator. This means that for a large <code>QuerySet</code> a large ‘IN’ clause could be generated, which, depending on the database, might have performance problems of its own when it comes to parsing or executing the SQL query. Always profile for your use case!</p> <p>If you use <code>iterator()</code> to run the query, <code>prefetch_related()</code> calls will only be observed if a value for <code>chunk_size</code> is provided.</p> <p>You can use the <a class="reference internal" href="#django.db.models.Prefetch" title="django.db.models.Prefetch"><code>Prefetch</code></a> object to further control the prefetch operation.</p> <p>In its simplest form <code>Prefetch</code> is equivalent to the traditional string based lookups:</p> <pre data-language="pycon">&gt;&gt;&gt; from django.db.models import Prefetch
&gt;&gt;&gt; Restaurant.objects.prefetch_related(Prefetch("pizzas__toppings"))
</pre> <p>You can provide a custom queryset with the optional <code>queryset</code> argument. This can be used to change the default ordering of the queryset:</p> <pre data-language="pycon">&gt;&gt;&gt; Restaurant.objects.prefetch_related(
...     Prefetch("pizzas__toppings", queryset=Toppings.objects.order_by("name"))
... )
</pre> <p>Or to call <a class="reference internal" href="#django.db.models.query.QuerySet.select_related" title="django.db.models.query.QuerySet.select_related"><code>select_related()</code></a> when applicable to reduce the number of queries even further:</p> <pre data-language="pycon">&gt;&gt;&gt; Pizza.objects.prefetch_related(
...     Prefetch("restaurants", queryset=Restaurant.objects.select_related("best_pizza"))
... )
</pre> <p>You can also assign the prefetched result to a custom attribute with the optional <code>to_attr</code> argument. The result will be stored directly in a list.</p> <p>This allows prefetching the same relation multiple times with a different <code>QuerySet</code>; for instance:</p> <pre data-language="pycon">&gt;&gt;&gt; vegetarian_pizzas = Pizza.objects.filter(vegetarian=True)
&gt;&gt;&gt; Restaurant.objects.prefetch_related(
...     Prefetch("pizzas", to_attr="menu"),
...     Prefetch("pizzas", queryset=vegetarian_pizzas, to_attr="vegetarian_menu"),
... )
</pre> <p>Lookups created with custom <code>to_attr</code> can still be traversed as usual by other lookups:</p> <pre data-language="pycon">&gt;&gt;&gt; vegetarian_pizzas = Pizza.objects.filter(vegetarian=True)
&gt;&gt;&gt; Restaurant.objects.prefetch_related(
...     Prefetch("pizzas", queryset=vegetarian_pizzas, to_attr="vegetarian_menu"),
...     "vegetarian_menu__toppings",
... )
</pre> <p>Using <code>to_attr</code> is recommended when filtering down the prefetch result as it is less ambiguous than storing a filtered result in the related manager’s cache:</p> <pre data-language="pycon">&gt;&gt;&gt; queryset = Pizza.objects.filter(vegetarian=True)
&gt;&gt;&gt;
&gt;&gt;&gt; # Recommended:
&gt;&gt;&gt; restaurants = Restaurant.objects.prefetch_related(
...     Prefetch("pizzas", queryset=queryset, to_attr="vegetarian_pizzas")
... )
&gt;&gt;&gt; vegetarian_pizzas = restaurants[0].vegetarian_pizzas
&gt;&gt;&gt;
&gt;&gt;&gt; # Not recommended:
&gt;&gt;&gt; restaurants = Restaurant.objects.prefetch_related(
...     Prefetch("pizzas", queryset=queryset),
... )
&gt;&gt;&gt; vegetarian_pizzas = restaurants[0].pizzas.all()
</pre> <p>Custom prefetching also works with single related relations like forward <code>ForeignKey</code> or <code>OneToOneField</code>. Generally you’ll want to use <a class="reference internal" href="#django.db.models.query.QuerySet.select_related" title="django.db.models.query.QuerySet.select_related"><code>select_related()</code></a> for these relations, but there are a number of cases where prefetching with a custom <code>QuerySet</code> is useful:</p> <ul> <li>You want to use a <code>QuerySet</code> that performs further prefetching on related models.</li> <li>You want to prefetch only a subset of the related objects.</li> <li>
<p>You want to use performance optimization techniques like <a class="reference internal" href="#django.db.models.query.QuerySet.defer" title="django.db.models.query.QuerySet.defer"><code>deferred fields</code></a>:</p> <pre data-language="pycon">&gt;&gt;&gt; queryset = Pizza.objects.only("name")
&gt;&gt;&gt;
&gt;&gt;&gt; restaurants = Restaurant.objects.prefetch_related(
...     Prefetch("best_pizza", queryset=queryset)
... )
</pre> </li> </ul> <p>When using multiple databases, <code>Prefetch</code> will respect your choice of database. If the inner query does not specify a database, it will use the database selected by the outer query. All of the following are valid:</p> <pre data-language="pycon">&gt;&gt;&gt; # Both inner and outer queries will use the 'replica' database
&gt;&gt;&gt; Restaurant.objects.prefetch_related("pizzas__toppings").using("replica")
&gt;&gt;&gt; Restaurant.objects.prefetch_related(
...     Prefetch("pizzas__toppings"),
... ).using("replica")
&gt;&gt;&gt;
&gt;&gt;&gt; # Inner will use the 'replica' database; outer will use 'default' database
&gt;&gt;&gt; Restaurant.objects.prefetch_related(
...     Prefetch("pizzas__toppings", queryset=Toppings.objects.using("replica")),
... )
&gt;&gt;&gt;
&gt;&gt;&gt; # Inner will use 'replica' database; outer will use 'cold-storage' database
&gt;&gt;&gt; Restaurant.objects.prefetch_related(
...     Prefetch("pizzas__toppings", queryset=Toppings.objects.using("replica")),
... ).using("cold-storage")
</pre> <div class="admonition note"> <p class="admonition-title">Note</p> <p>The ordering of lookups matters.</p> <p>Take the following examples:</p> <pre data-language="pycon">&gt;&gt;&gt; prefetch_related("pizzas__toppings", "pizzas")
</pre> <p>This works even though it’s unordered because <code>'pizzas__toppings'</code> already contains all the needed information, therefore the second argument <code>'pizzas'</code> is actually redundant.</p> <pre data-language="pycon">&gt;&gt;&gt; prefetch_related("pizzas__toppings", Prefetch("pizzas", queryset=Pizza.objects.all()))
</pre> <p>This will raise a <code>ValueError</code> because of the attempt to redefine the queryset of a previously seen lookup. Note that an implicit queryset was created to traverse <code>'pizzas'</code> as part of the <code>'pizzas__toppings'</code> lookup.</p> <pre data-language="pycon">&gt;&gt;&gt; prefetch_related("pizza_list__toppings", Prefetch("pizzas", to_attr="pizza_list"))
</pre> <p>This will trigger an <code>AttributeError</code> because <code>'pizza_list'</code> doesn’t exist yet when <code>'pizza_list__toppings'</code> is being processed.</p> <p>This consideration is not limited to the use of <code>Prefetch</code> objects. Some advanced techniques may require that the lookups be performed in a specific order to avoid creating extra queries; therefore it’s recommended to always carefully order <code>prefetch_related</code> arguments.</p> </div> </section> <section id="s-extra"> <h4 id="extra"><code>extra()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.extra">
<code>extra(select=None, where=None, params=None, tables=None, order_by=None, select_params=None)</code> </dt> 
</dl> <p>Sometimes, the Django query syntax by itself can’t easily express a complex <code>WHERE</code> clause. For these edge cases, Django provides the <code>extra()</code> <code>QuerySet</code> modifier — a hook for injecting specific clauses into the SQL generated by a <code>QuerySet</code>.</p> <div class="admonition-use-this-method-as-a-last-resort admonition"> <p class="admonition-title">Use this method as a last resort</p> <p>This is an old API that we aim to deprecate at some point in the future. Use it only if you cannot express your query using other queryset methods. If you do need to use it, please <a class="reference external" href="https://code.djangoproject.com/newticket">file a ticket</a> using the <a class="reference external" href="https://code.djangoproject.com/query?status=assigned&amp;status=new&amp;keywords=~QuerySet.extra">QuerySet.extra keyword</a> with your use case (please check the list of existing tickets first) so that we can enhance the QuerySet API to allow removing <code>extra()</code>. We are no longer improving or fixing bugs for this method.</p> <p>For example, this use of <code>extra()</code>:</p> <pre data-language="pycon">&gt;&gt;&gt; qs.extra(
...     select={"val": "select col from sometable where othercol = %s"},
...     select_params=(someparam,),
... )
</pre> <p>is equivalent to:</p> <pre data-language="pycon">&gt;&gt;&gt; qs.annotate(val=RawSQL("select col from sometable where othercol = %s", (someparam,)))
</pre> <p>The main benefit of using <a class="reference internal" href="expressions.html#django.db.models.expressions.RawSQL" title="django.db.models.expressions.RawSQL"><code>RawSQL</code></a> is that you can set <code>output_field</code> if needed. The main downside is that if you refer to some table alias of the queryset in the raw SQL, then it is possible that Django might change that alias (for example, when the queryset is used as a subquery in yet another query).</p> </div> <div class="admonition warning"> <p class="admonition-title">Warning</p> <p>You should be very careful whenever you use <code>extra()</code>. Every time you use it, you should escape any parameters that the user can control by using <code>params</code> in order to protect against SQL injection attacks.</p> <p>You also must not quote placeholders in the SQL string. This example is vulnerable to SQL injection because of the quotes around <code>%s</code>:</p> <pre data-language="sql">SELECT col FROM sometable WHERE othercol = '%s'  # unsafe!
</pre> <p>You can read more about how Django’s <a class="reference internal" href="../../topics/security.html#sql-injection-protection"><span class="std std-ref">SQL injection protection</span></a> works.</p> </div> <p>By definition, these extra lookups may not be portable to different database engines (because you’re explicitly writing SQL code) and violate the DRY principle, so you should avoid them if possible.</p> <p>Specify one or more of <code>params</code>, <code>select</code>, <code>where</code> or <code>tables</code>. None of the arguments is required, but you should use at least one of them.</p> <ul> <li>
<p><code>select</code></p> <p>The <code>select</code> argument lets you put extra fields in the <code>SELECT</code> clause. It should be a dictionary mapping attribute names to SQL clauses to use to calculate that attribute.</p> <p>Example:</p> <pre data-language="python">Entry.objects.extra(select={"is_recent": "pub_date &gt; '2006-01-01'"})
</pre> <p>As a result, each <code>Entry</code> object will have an extra attribute, <code>is_recent</code>, a boolean representing whether the entry’s <code>pub_date</code> is greater than Jan. 1, 2006.</p> <p>Django inserts the given SQL snippet directly into the <code>SELECT</code> statement, so the resulting SQL of the above example would be something like:</p> <pre data-language="sql">SELECT blog_entry.*, (pub_date &gt; '2006-01-01') AS is_recent
FROM blog_entry;
</pre> <p>The next example is more advanced; it does a subquery to give each resulting <code>Blog</code> object an <code>entry_count</code> attribute, an integer count of associated <code>Entry</code> objects:</p> <pre data-language="python">Blog.objects.extra(
    select={
        "entry_count": "SELECT COUNT(*) FROM blog_entry WHERE blog_entry.blog_id = blog_blog.id"
    },
)
</pre> <p>In this particular case, we’re exploiting the fact that the query will already contain the <code>blog_blog</code> table in its <code>FROM</code> clause.</p> <p>The resulting SQL of the above example would be:</p> <pre data-language="sql">SELECT blog_blog.*, (SELECT COUNT(*) FROM blog_entry WHERE blog_entry.blog_id = blog_blog.id) AS entry_count
FROM blog_blog;
</pre> <p>Note that the parentheses required by most database engines around subqueries are not required in Django’s <code>select</code> clauses.</p> <p>In some rare cases, you might wish to pass parameters to the SQL fragments in <code>extra(select=...)</code>. For this purpose, use the <code>select_params</code> parameter.</p> <p>This will work, for example:</p> <pre data-language="python">Blog.objects.extra(
    select={"a": "%s", "b": "%s"},
    select_params=("one", "two"),
)
</pre> <p>If you need to use a literal <code>%s</code> inside your select string, use the sequence <code>%%s</code>.</p> </li> <li>
<p><code>where</code> / <code>tables</code></p> <p>You can define explicit SQL <code>WHERE</code> clauses — perhaps to perform non-explicit joins — by using <code>where</code>. You can manually add tables to the SQL <code>FROM</code> clause by using <code>tables</code>.</p> <p><code>where</code> and <code>tables</code> both take a list of strings. All <code>where</code> parameters are “AND”ed to any other search criteria.</p> <p>Example:</p> <pre data-language="python">Entry.objects.extra(where=["foo='a' OR bar = 'a'", "baz = 'a'"])
</pre> <p>…translates (roughly) into the following SQL:</p> <pre data-language="sql">SELECT * FROM blog_entry WHERE (foo='a' OR bar='a') AND (baz='a')
</pre> <p>Be careful when using the <code>tables</code> parameter if you’re specifying tables that are already used in the query. When you add extra tables via the <code>tables</code> parameter, Django assumes you want that table included an extra time, if it is already included. That creates a problem, since the table name will then be given an alias. If a table appears multiple times in an SQL statement, the second and subsequent occurrences must use aliases so the database can tell them apart. If you’re referring to the extra table you added in the extra <code>where</code> parameter this is going to cause errors.</p> <p>Normally you’ll only be adding extra tables that don’t already appear in the query. However, if the case outlined above does occur, there are a few solutions. First, see if you can get by without including the extra table and use the one already in the query. If that isn’t possible, put your <code>extra()</code> call at the front of the queryset construction so that your table is the first use of that table. Finally, if all else fails, look at the query produced and rewrite your <code>where</code> addition to use the alias given to your extra table. The alias will be the same each time you construct the queryset in the same way, so you can rely upon the alias name to not change.</p> </li> <li>
<p><code>order_by</code></p> <p>If you need to order the resulting queryset using some of the new fields or tables you have included via <code>extra()</code> use the <code>order_by</code> parameter to <code>extra()</code> and pass in a sequence of strings. These strings should either be model fields (as in the normal <a class="reference internal" href="#django.db.models.query.QuerySet.order_by" title="django.db.models.query.QuerySet.order_by"><code>order_by()</code></a> method on querysets), of the form <code>table_name.column_name</code> or an alias for a column that you specified in the <code>select</code> parameter to <code>extra()</code>.</p> <p>For example:</p> <pre data-language="python">q = Entry.objects.extra(select={"is_recent": "pub_date &gt; '2006-01-01'"})
q = q.extra(order_by=["-is_recent"])
</pre> <p>This would sort all the items for which <code>is_recent</code> is true to the front of the result set (<code>True</code> sorts before <code>False</code> in a descending ordering).</p> <p>This shows, by the way, that you can make multiple calls to <code>extra()</code> and it will behave as you expect (adding new constraints each time).</p> </li> <li>
<p><code>params</code></p> <p>The <code>where</code> parameter described above may use standard Python database string placeholders — <code>'%s'</code> to indicate parameters the database engine should automatically quote. The <code>params</code> argument is a list of any extra parameters to be substituted.</p> <p>Example:</p> <pre data-language="python">Entry.objects.extra(where=["headline=%s"], params=["Lennon"])
</pre> <p>Always use <code>params</code> instead of embedding values directly into <code>where</code> because <code>params</code> will ensure values are quoted correctly according to your particular backend. For example, quotes will be escaped correctly.</p> <p>Bad:</p> <pre data-language="python">Entry.objects.extra(where=["headline='Lennon'"])
</pre> <p>Good:</p> <pre data-language="python">Entry.objects.extra(where=["headline=%s"], params=["Lennon"])
</pre> </li> </ul> <div class="admonition warning"> <p class="admonition-title">Warning</p> <p>If you are performing queries on MySQL, note that MySQL’s silent type coercion may cause unexpected results when mixing types. If you query on a string type column, but with an integer value, MySQL will coerce the types of all values in the table to an integer before performing the comparison. For example, if your table contains the values <code>'abc'</code>, <code>'def'</code> and you query for <code>WHERE mycolumn=0</code>, both rows will match. To prevent this, perform the correct typecasting before using the value in a query.</p> </div> </section> <section id="s-defer"> <h4 id="defer"><code>defer()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.defer">
<code>defer(*fields)</code> </dt> 
</dl> <p>In some complex data-modeling situations, your models might contain a lot of fields, some of which could contain a lot of data (for example, text fields), or require expensive processing to convert them to Python objects. If you are using the results of a queryset in some situation where you don’t know if you need those particular fields when you initially fetch the data, you can tell Django not to retrieve them from the database.</p> <p>This is done by passing the names of the fields to not load to <code>defer()</code>:</p> <pre data-language="python">Entry.objects.defer("headline", "body")
</pre> <p>A queryset that has deferred fields will still return model instances. Each deferred field will be retrieved from the database if you access that field (one at a time, not all the deferred fields at once).</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>Deferred fields will not lazy-load like this from asynchronous code. Instead, you will get a <code>SynchronousOnlyOperation</code> exception. If you are writing asynchronous code, you should not try to access any fields that you <code>defer()</code>.</p> </div> <p>You can make multiple calls to <code>defer()</code>. Each call adds new fields to the deferred set:</p> <pre data-language="python"># Defers both the body and headline fields.
Entry.objects.defer("body").filter(rating=5).defer("headline")
</pre> <p>The order in which fields are added to the deferred set does not matter. Calling <code>defer()</code> with a field name that has already been deferred is harmless (the field will still be deferred).</p> <p>You can defer loading of fields in related models (if the related models are loading via <a class="reference internal" href="#django.db.models.query.QuerySet.select_related" title="django.db.models.query.QuerySet.select_related"><code>select_related()</code></a>) by using the standard double-underscore notation to separate related fields:</p> <pre data-language="python">Blog.objects.select_related().defer("entry__headline", "entry__body")
</pre> <p>If you want to clear the set of deferred fields, pass <code>None</code> as a parameter to <code>defer()</code>:</p> <pre data-language="python"># Load all fields immediately.
my_queryset.defer(None)
</pre> <p>Some fields in a model won’t be deferred, even if you ask for them. You can never defer the loading of the primary key. If you are using <a class="reference internal" href="#django.db.models.query.QuerySet.select_related" title="django.db.models.query.QuerySet.select_related"><code>select_related()</code></a> to retrieve related models, you shouldn’t defer the loading of the field that connects from the primary model to the related one, doing so will result in an error.</p> <p>Similarly, calling <code>defer()</code> (or its counterpart <a class="reference internal" href="#django.db.models.query.QuerySet.only" title="django.db.models.query.QuerySet.only"><code>only()</code></a>) including an argument from an aggregation (e.g. using the result of <a class="reference internal" href="#django.db.models.query.QuerySet.annotate" title="django.db.models.query.QuerySet.annotate"><code>annotate()</code></a>) doesn’t make sense: doing so will raise an exception. The aggregated values will always be fetched into the resulting queryset.</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>The <code>defer()</code> method (and its cousin, <a class="reference internal" href="#django.db.models.query.QuerySet.only" title="django.db.models.query.QuerySet.only"><code>only()</code></a>, below) are only for advanced use-cases. They provide an optimization for when you have analyzed your queries closely and understand <em>exactly</em> what information you need and have measured that the difference between returning the fields you need and the full set of fields for the model will be significant.</p> <p>Even if you think you are in the advanced use-case situation, <strong>only use</strong> <code>defer()</code> <strong>when you cannot, at queryset load time, determine if you will need the extra fields or not</strong>. If you are frequently loading and using a particular subset of your data, the best choice you can make is to normalize your models and put the non-loaded data into a separate model (and database table). If the columns <em>must</em> stay in the one table for some reason, create a model with <code>Meta.managed = False</code> (see the <a class="reference internal" href="options.html#django.db.models.Options.managed" title="django.db.models.Options.managed"><code>managed attribute</code></a> documentation) containing just the fields you normally need to load and use that where you might otherwise call <code>defer()</code>. This makes your code more explicit to the reader, is slightly faster and consumes a little less memory in the Python process.</p> <p>For example, both of these models use the same underlying database table:</p> <pre data-language="python">class CommonlyUsedModel(models.Model):
    f1 = models.CharField(max_length=10)

    class Meta:
        managed = False
        db_table = "app_largetable"


class ManagedModel(models.Model):
    f1 = models.CharField(max_length=10)
    f2 = models.CharField(max_length=10)

    class Meta:
        db_table = "app_largetable"


# Two equivalent QuerySets:
CommonlyUsedModel.objects.all()
ManagedModel.objects.defer("f2")
</pre> <p>If many fields need to be duplicated in the unmanaged model, it may be best to create an abstract model with the shared fields and then have the unmanaged and managed models inherit from the abstract model.</p> </div> <div class="admonition note"> <p class="admonition-title">Note</p> <p>When calling <a class="reference internal" href="instances.html#django.db.models.Model.save" title="django.db.models.Model.save"><code>save()</code></a> for instances with deferred fields, only the loaded fields will be saved. See <a class="reference internal" href="instances.html#django.db.models.Model.save" title="django.db.models.Model.save"><code>save()</code></a> for more details.</p> </div> </section> <section id="s-only"> <h4 id="only"><code>only()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.only">
<code>only(*fields)</code> </dt> 
</dl> <p>The <code>only()</code> method is essentially the opposite of <a class="reference internal" href="#django.db.models.query.QuerySet.defer" title="django.db.models.query.QuerySet.defer"><code>defer()</code></a>. Only the fields passed into this method and that are <em>not</em> already specified as deferred are loaded immediately when the queryset is evaluated.</p> <p>If you have a model where almost all the fields need to be deferred, using <code>only()</code> to specify the complementary set of fields can result in simpler code.</p> <p>Suppose you have a model with fields <code>name</code>, <code>age</code> and <code>biography</code>. The following two querysets are the same, in terms of deferred fields:</p> <pre data-language="python">Person.objects.defer("age", "biography")
Person.objects.only("name")
</pre> <p>Whenever you call <code>only()</code> it <em>replaces</em> the set of fields to load immediately. The method’s name is mnemonic: <strong>only</strong> those fields are loaded immediately; the remainder are deferred. Thus, successive calls to <code>only()</code> result in only the final fields being considered:</p> <pre data-language="python"># This will defer all fields except the headline.
Entry.objects.only("body", "rating").only("headline")
</pre> <p>Since <code>defer()</code> acts incrementally (adding fields to the deferred list), you can combine calls to <code>only()</code> and <code>defer()</code> and things will behave logically:</p> <pre data-language="python"># Final result is that everything except "headline" is deferred.
Entry.objects.only("headline", "body").defer("body")

# Final result loads headline immediately.
Entry.objects.defer("body").only("headline", "body")
</pre> <p>All of the cautions in the note for the <a class="reference internal" href="#django.db.models.query.QuerySet.defer" title="django.db.models.query.QuerySet.defer"><code>defer()</code></a> documentation apply to <code>only()</code> as well. Use it cautiously and only after exhausting your other options.</p> <p>Using <code>only()</code> and omitting a field requested using <a class="reference internal" href="#django.db.models.query.QuerySet.select_related" title="django.db.models.query.QuerySet.select_related"><code>select_related()</code></a> is an error as well. On the other hand, invoking <code>only()</code> without any arguments, will return every field (including annotations) fetched by the queryset.</p> <p>As with <code>defer()</code>, you cannot access the non-loaded fields from asynchronous code and expect them to load. Instead, you will get a <code>SynchronousOnlyOperation</code> exception. Ensure that all fields you might access are in your <code>only()</code> call.</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>When calling <a class="reference internal" href="instances.html#django.db.models.Model.save" title="django.db.models.Model.save"><code>save()</code></a> for instances with deferred fields, only the loaded fields will be saved. See <a class="reference internal" href="instances.html#django.db.models.Model.save" title="django.db.models.Model.save"><code>save()</code></a> for more details.</p> </div> <div class="admonition note"> <p class="admonition-title">Note</p> <p>When using <a class="reference internal" href="#django.db.models.query.QuerySet.defer" title="django.db.models.query.QuerySet.defer"><code>defer()</code></a> after <code>only()</code> the fields in <a class="reference internal" href="#django.db.models.query.QuerySet.defer" title="django.db.models.query.QuerySet.defer"><code>defer()</code></a> will override <code>only()</code> for fields that are listed in both.</p> </div> </section> <section id="s-using"> <h4 id="using"><code>using()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.using">
<code>using(alias)</code> </dt> 
</dl> <p>This method is for controlling which database the <code>QuerySet</code> will be evaluated against if you are using more than one database. The only argument this method takes is the alias of a database, as defined in <a class="reference internal" href="../settings.html#std-setting-DATABASES"><code>DATABASES</code></a>.</p> <p>For example:</p> <pre data-language="pycon"># queries the database with the 'default' alias.
&gt;&gt;&gt; Entry.objects.all()

# queries the database with the 'backup' alias
&gt;&gt;&gt; Entry.objects.using("backup")
</pre> </section> <section id="s-select-for-update"> <h4 id="select-for-update"><code>select_for_update()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.select_for_update">
<code>select_for_update(nowait=False, skip_locked=False, of=(), no_key=False)</code> </dt> 
</dl> <p>Returns a queryset that will lock rows until the end of the transaction, generating a <code>SELECT ... FOR UPDATE</code> SQL statement on supported databases.</p> <p>For example:</p> <pre data-language="python">from django.db import transaction

entries = Entry.objects.select_for_update().filter(author=request.user)
with transaction.atomic():
    for entry in entries:
        ...
</pre> <p>When the queryset is evaluated (<code>for entry in entries</code> in this case), all matched entries will be locked until the end of the transaction block, meaning that other transactions will be prevented from changing or acquiring locks on them.</p> <p>Usually, if another transaction has already acquired a lock on one of the selected rows, the query will block until the lock is released. If this is not the behavior you want, call <code>select_for_update(nowait=True)</code>. This will make the call non-blocking. If a conflicting lock is already acquired by another transaction, <a class="reference internal" href="../exceptions.html#django.db.DatabaseError" title="django.db.DatabaseError"><code>DatabaseError</code></a> will be raised when the queryset is evaluated. You can also ignore locked rows by using <code>select_for_update(skip_locked=True)</code> instead. The <code>nowait</code> and <code>skip_locked</code> are mutually exclusive and attempts to call <code>select_for_update()</code> with both options enabled will result in a <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#ValueError" title="(in Python v3.13)"><code>ValueError</code></a>.</p> <p>By default, <code>select_for_update()</code> locks all rows that are selected by the query. For example, rows of related objects specified in <a class="reference internal" href="#django.db.models.query.QuerySet.select_related" title="django.db.models.query.QuerySet.select_related"><code>select_related()</code></a> are locked in addition to rows of the queryset’s model. If this isn’t desired, specify the related objects you want to lock in <code>select_for_update(of=(...))</code> using the same fields syntax as <a class="reference internal" href="#django.db.models.query.QuerySet.select_related" title="django.db.models.query.QuerySet.select_related"><code>select_related()</code></a>. Use the value <code>'self'</code> to refer to the queryset’s model.</p> <div class="admonition-lock-parents-models-in-select-for-update-of admonition"> <p class="admonition-title">Lock parents models in <code>select_for_update(of=(...))</code></p> <p>If you want to lock parents models when using <a class="reference internal" href="../../topics/db/models.html#multi-table-inheritance"><span class="std std-ref">multi-table inheritance</span></a>, you must specify parent link fields (by default <code>&lt;parent_model_name&gt;_ptr</code>) in the <code>of</code> argument. For example:</p> <pre data-language="python">Restaurant.objects.select_for_update(of=("self", "place_ptr"))
</pre> </div> <div class="admonition-using-select-for-update-of-with-specified-fields admonition"> <p class="admonition-title">Using <code>select_for_update(of=(...))</code> with specified fields</p> <p>If you want to lock models and specify selected fields, e.g. using <a class="reference internal" href="#django.db.models.query.QuerySet.values" title="django.db.models.query.QuerySet.values"><code>values()</code></a>, you must select at least one field from each model in the <code>of</code> argument. Models without selected fields will not be locked.</p> </div> <p>On PostgreSQL only, you can pass <code>no_key=True</code> in order to acquire a weaker lock, that still allows creating rows that merely reference locked rows (through a foreign key, for example) while the lock is in place. The PostgreSQL documentation has more details about <a class="reference external" href="https://www.postgresql.org/docs/current/explicit-locking.html#LOCKING-ROWS">row-level lock modes</a>.</p> <p>You can’t use <code>select_for_update()</code> on nullable relations:</p> <pre data-language="pycon">&gt;&gt;&gt; Person.objects.select_related("hometown").select_for_update()
Traceback (most recent call last):
...
django.db.utils.NotSupportedError: FOR UPDATE cannot be applied to the nullable side of an outer join
</pre> <p>To avoid that restriction, you can exclude null objects if you don’t care about them:</p> <pre data-language="pycon">&gt;&gt;&gt; Person.objects.select_related("hometown").select_for_update().exclude(hometown=None)
&lt;QuerySet [&lt;Person: ...)&gt;, ...]&gt;
</pre> <p>The <code>postgresql</code>, <code>oracle</code>, and <code>mysql</code> database backends support <code>select_for_update()</code>. However, MariaDB only supports the <code>nowait</code> argument, MariaDB 10.6+ also supports the <code>skip_locked</code> argument, and MySQL supports the <code>nowait</code>, <code>skip_locked</code>, and <code>of</code> arguments. The <code>no_key</code> argument is only supported on PostgreSQL.</p> <p>Passing <code>nowait=True</code>, <code>skip_locked=True</code>, <code>no_key=True</code>, or <code>of</code> to <code>select_for_update()</code> using database backends that do not support these options, such as MySQL, raises a <a class="reference internal" href="../exceptions.html#django.db.NotSupportedError" title="django.db.NotSupportedError"><code>NotSupportedError</code></a>. This prevents code from unexpectedly blocking.</p> <p>Evaluating a queryset with <code>select_for_update()</code> in autocommit mode on backends which support <code>SELECT ... FOR UPDATE</code> is a <a class="reference internal" href="../exceptions.html#django.db.transaction.TransactionManagementError" title="django.db.transaction.TransactionManagementError"><code>TransactionManagementError</code></a> error because the rows are not locked in that case. If allowed, this would facilitate data corruption and could easily be caused by calling code that expects to be run in a transaction outside of one.</p> <p>Using <code>select_for_update()</code> on backends which do not support <code>SELECT ... FOR UPDATE</code> (such as SQLite) will have no effect. <code>SELECT ... FOR UPDATE</code> will not be added to the query, and an error isn’t raised if <code>select_for_update()</code> is used in autocommit mode.</p> <div class="admonition warning"> <p class="admonition-title">Warning</p> <p>Although <code>select_for_update()</code> normally fails in autocommit mode, since <a class="reference internal" href="../../topics/testing/tools.html#django.test.TestCase" title="django.test.TestCase"><code>TestCase</code></a> automatically wraps each test in a transaction, calling <code>select_for_update()</code> in a <code>TestCase</code> even outside an <a class="reference internal" href="../../topics/db/transactions.html#django.db.transaction.atomic" title="django.db.transaction.atomic"><code>atomic()</code></a> block will (perhaps unexpectedly) pass without raising a <code>TransactionManagementError</code>. To properly test <code>select_for_update()</code> you should use <a class="reference internal" href="../../topics/testing/tools.html#django.test.TransactionTestCase" title="django.test.TransactionTestCase"><code>TransactionTestCase</code></a>.</p> </div> <div class="admonition-certain-expressions-may-not-be-supported admonition"> <p class="admonition-title">Certain expressions may not be supported</p> <p>PostgreSQL doesn’t support <code>select_for_update()</code> with <a class="reference internal" href="expressions.html#django.db.models.expressions.Window" title="django.db.models.expressions.Window"><code>Window</code></a> expressions.</p> </div> </section> <section id="s-raw"> <h4 id="raw"><code>raw()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.raw">
<code>raw(raw_query, params=(), translations=None, using=None)</code> </dt> 
</dl> <p>Takes a raw SQL query, executes it, and returns a <code>django.db.models.query.RawQuerySet</code> instance. This <code>RawQuerySet</code> instance can be iterated over just like a normal <code>QuerySet</code> to provide object instances.</p> <p>See the <a class="reference internal" href="../../topics/db/sql.html"><span class="doc">Performing raw SQL queries</span></a> for more information.</p> <div class="admonition warning"> <p class="admonition-title">Warning</p> <p><code>raw()</code> always triggers a new query and doesn’t account for previous filtering. As such, it should generally be called from the <code>Manager</code> or from a fresh <code>QuerySet</code> instance.</p> </div> </section> </section> <section id="s-operators-that-return-new-querysets"> <h3 id="operators-that-return-new-querysets">Operators that return new <code>QuerySet</code>s</h3> <p>Combined querysets must use the same model.</p> <section id="s-and"> <h4 id="and">AND (<code>&amp;</code>)</h4> <p>Combines two <code>QuerySet</code>s using the SQL <code>AND</code> operator in a manner similar to chaining filters.</p> <p>The following are equivalent:</p> <pre data-language="python">Model.objects.filter(x=1) &amp; Model.objects.filter(y=2)
Model.objects.filter(x=1).filter(y=2)
</pre> <p>SQL equivalent:</p> <pre data-language="sql">SELECT ... WHERE x=1 AND y=2
</pre> </section> <section id="s-or"> <h4 id="or">OR (<code>|</code>)</h4> <p>Combines two <code>QuerySet</code>s using the SQL <code>OR</code> operator.</p> <p>The following are equivalent:</p> <pre data-language="python">Model.objects.filter(x=1) | Model.objects.filter(y=2)
from django.db.models import Q

Model.objects.filter(Q(x=1) | Q(y=2))
</pre> <p>SQL equivalent:</p> <pre data-language="sql">SELECT ... WHERE x=1 OR y=2
</pre> <p><code>|</code> is not a commutative operation, as different (though equivalent) queries may be generated.</p> </section> <section id="s-xor"> <h4 id="xor">XOR (<code>^</code>)</h4> <p>Combines two <code>QuerySet</code>s using the SQL <code>XOR</code> operator. A <code>XOR</code> expression matches rows that are matched by an odd number of operands.</p> <p>The following are equivalent:</p> <pre data-language="python">Model.objects.filter(x=1) ^ Model.objects.filter(y=2)
from django.db.models import Q

Model.objects.filter(Q(x=1) ^ Q(y=2))
</pre> <p>SQL equivalent:</p> <pre data-language="sql">SELECT ... WHERE x=1 XOR y=2
</pre> <div class="admonition note"> <p class="admonition-title">Note</p> <p><code>XOR</code> is natively supported on MariaDB and MySQL. On other databases, <code>x ^ y ^ ... ^ z</code> is converted to an equivalent:</p> <pre data-language="sql">(x OR y OR ... OR z) AND
1=MOD(
    (CASE WHEN x THEN 1 ELSE 0 END) +
    (CASE WHEN y THEN 1 ELSE 0 END) +
    ...
    (CASE WHEN z THEN 1 ELSE 0 END),
    2
)
</pre> </div> </section> </section> <section id="s-methods-that-do-not-return-querysets"> <h3 id="methods-that-do-not-return-querysets">Methods that do not return <code>QuerySet</code>s</h3> <p>The following <code>QuerySet</code> methods evaluate the <code>QuerySet</code> and return something <em>other than</em> a <code>QuerySet</code>.</p> <p>These methods do not use a cache (see <a class="reference internal" href="../../topics/db/queries.html#caching-and-querysets"><span class="std std-ref">Caching and QuerySets</span></a>). Rather, they query the database each time they’re called.</p> <p>Because these methods evaluate the QuerySet, they are blocking calls, and so their main (synchronous) versions cannot be called from asynchronous code. For this reason, each has a corresponding asynchronous version with an <code>a</code> prefix - for example, rather than <code>get(…)</code> you can <code>await aget(…)</code>.</p> <p>There is usually no difference in behavior apart from their asynchronous nature, but any differences are noted below next to each method.</p> <section id="s-get"> <h4 id="get"><code>get()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.get">
<code>get(*args, **kwargs)</code> </dt> 
</dl> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.aget">
<code>aget(*args, **kwargs)</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>aget()</code></p> <p>Returns the object matching the given lookup parameters, which should be in the format described in <a class="reference internal" href="#id4">Field lookups</a>. You should use lookups that are guaranteed unique, such as the primary key or fields in a unique constraint. For example:</p> <pre data-language="python">Entry.objects.get(id=1)
Entry.objects.get(Q(blog=blog) &amp; Q(entry_number=1))
</pre> <p>If you expect a queryset to already return one row, you can use <code>get()</code> without any arguments to return the object for that row:</p> <pre data-language="python">Entry.objects.filter(pk=1).get()
</pre> <p>If <code>get()</code> doesn’t find any object, it raises a <a class="reference internal" href="class.html#django.db.models.Model.DoesNotExist" title="django.db.models.Model.DoesNotExist"><code>Model.DoesNotExist</code></a> exception:</p> <pre data-language="python">Entry.objects.get(id=-999)  # raises Entry.DoesNotExist
</pre> <p>If <code>get()</code> finds more than one object, it raises a <a class="reference internal" href="class.html#django.db.models.Model.MultipleObjectsReturned" title="django.db.models.Model.MultipleObjectsReturned"><code>Model.MultipleObjectsReturned</code></a> exception:</p> <pre data-language="python">Entry.objects.get(name="A Duplicated Name")  # raises Entry.MultipleObjectsReturned
</pre> <p>Both these exception classes are attributes of the model class, and specific to that model. If you want to handle such exceptions from several <code>get()</code> calls for different models, you can use their generic base classes. For example, you can use <a class="reference internal" href="../exceptions.html#django.core.exceptions.ObjectDoesNotExist" title="django.core.exceptions.ObjectDoesNotExist"><code>django.core.exceptions.ObjectDoesNotExist</code></a> to handle <a class="reference internal" href="class.html#django.db.models.Model.DoesNotExist" title="django.db.models.Model.DoesNotExist"><code>DoesNotExist</code></a> exceptions from multiple models:</p> <pre data-language="python">from django.core.exceptions import ObjectDoesNotExist

try:
    blog = Blog.objects.get(id=1)
    entry = Entry.objects.get(blog=blog, entry_number=1)
except ObjectDoesNotExist:
    print("Either the blog or entry doesn't exist.")
</pre> </section> <section id="s-create"> <h4 id="create"><code>create()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.create">
<code>create(**kwargs)</code> </dt> 
</dl> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.acreate">
<code>acreate(**kwargs)</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>acreate()</code></p> <p>A convenience method for creating an object and saving it all in one step. Thus:</p> <pre data-language="python">p = Person.objects.create(first_name="Bruce", last_name="Springsteen")
</pre> <p>and:</p> <pre data-language="python">p = Person(first_name="Bruce", last_name="Springsteen")
p.save(force_insert=True)
</pre> <p>are equivalent.</p> <p>The <a class="reference internal" href="instances.html#ref-models-force-insert"><span class="std std-ref">force_insert</span></a> parameter is documented elsewhere, but all it means is that a new object will always be created. Normally you won’t need to worry about this. However, if your model contains a manual primary key value that you set and if that value already exists in the database, a call to <code>create()</code> will fail with an <a class="reference internal" href="../exceptions.html#django.db.IntegrityError" title="django.db.IntegrityError"><code>IntegrityError</code></a> since primary keys must be unique. Be prepared to handle the exception if you are using manual primary keys.</p> </section> <section id="s-get-or-create"> <h4 id="get-or-create"><code>get_or_create()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.get_or_create">
<code>get_or_create(defaults=None, **kwargs)</code> </dt> 
</dl> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.aget_or_create">
<code>aget_or_create(defaults=None, **kwargs)</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>aget_or_create()</code></p> <p>A convenience method for looking up an object with the given <code>kwargs</code> (may be empty if your model has defaults for all fields), creating one if necessary.</p> <p>Returns a tuple of <code>(object, created)</code>, where <code>object</code> is the retrieved or created object and <code>created</code> is a boolean specifying whether a new object was created.</p> <p>This is meant to prevent duplicate objects from being created when requests are made in parallel, and as a shortcut to boilerplatish code. For example:</p> <pre data-language="python">try:
    obj = Person.objects.get(first_name="John", last_name="Lennon")
except Person.DoesNotExist:
    obj = Person(first_name="John", last_name="Lennon", birthday=date(1940, 10, 9))
    obj.save()
</pre> <p>Here, with concurrent requests, multiple attempts to save a <code>Person</code> with the same parameters may be made. To avoid this race condition, the above example can be rewritten using <code>get_or_create()</code> like so:</p> <pre data-language="python">obj, created = Person.objects.get_or_create(
    first_name="John",
    last_name="Lennon",
    defaults={"birthday": date(1940, 10, 9)},
)
</pre> <p>Any keyword arguments passed to <code>get_or_create()</code> — <em>except</em> an optional one called <code>defaults</code> — will be used in a <a class="reference internal" href="#django.db.models.query.QuerySet.get" title="django.db.models.query.QuerySet.get"><code>get()</code></a> call. If an object is found, <code>get_or_create()</code> returns a tuple of that object and <code>False</code>.</p> <div class="admonition warning"> <p class="admonition-title">Warning</p> <p>This method is atomic assuming that the database enforces uniqueness of the keyword arguments (see <a class="reference internal" href="fields.html#django.db.models.Field.unique" title="django.db.models.Field.unique"><code>unique</code></a> or <a class="reference internal" href="options.html#django.db.models.Options.unique_together" title="django.db.models.Options.unique_together"><code>unique_together</code></a>). If the fields used in the keyword arguments do not have a uniqueness constraint, concurrent calls to this method may result in multiple rows with the same parameters being inserted.</p> </div> <p>You can specify more complex conditions for the retrieved object by chaining <code>get_or_create()</code> with <code>filter()</code> and using <a class="reference internal" href="#django.db.models.Q" title="django.db.models.Q"><code>Q objects</code></a>. For example, to retrieve Robert or Bob Marley if either exists, and create the latter otherwise:</p> <pre data-language="python">from django.db.models import Q

obj, created = Person.objects.filter(
    Q(first_name="Bob") | Q(first_name="Robert"),
).get_or_create(last_name="Marley", defaults={"first_name": "Bob"})
</pre> <p>If multiple objects are found, <code>get_or_create()</code> raises <a class="reference internal" href="../exceptions.html#django.core.exceptions.MultipleObjectsReturned" title="django.core.exceptions.MultipleObjectsReturned"><code>MultipleObjectsReturned</code></a>. If an object is <em>not</em> found, <code>get_or_create()</code> will instantiate and save a new object, returning a tuple of the new object and <code>True</code>. The new object will be created roughly according to this algorithm:</p> <pre data-language="python">params = {k: v for k, v in kwargs.items() if "__" not in k}
params.update({k: v() if callable(v) else v for k, v in defaults.items()})
obj = self.model(**params)
obj.save()
</pre> <p>In English, that means start with any non-<code>'defaults'</code> keyword argument that doesn’t contain a double underscore (which would indicate a non-exact lookup). Then add the contents of <code>defaults</code>, overriding any keys if necessary, and use the result as the keyword arguments to the model class. If there are any callables in <code>defaults</code>, evaluate them. As hinted at above, this is a simplification of the algorithm that is used, but it contains all the pertinent details. The internal implementation has some more error-checking than this and handles some extra edge-conditions; if you’re interested, read the code.</p> <p>If you have a field named <code>defaults</code> and want to use it as an exact lookup in <code>get_or_create()</code>, use <code>'defaults__exact'</code>, like so:</p> <pre data-language="python">Foo.objects.get_or_create(defaults__exact="bar", defaults={"defaults": "baz"})
</pre> <p>The <code>get_or_create()</code> method has similar error behavior to <a class="reference internal" href="#django.db.models.query.QuerySet.create" title="django.db.models.query.QuerySet.create"><code>create()</code></a> when you’re using manually specified primary keys. If an object needs to be created and the key already exists in the database, an <a class="reference internal" href="../exceptions.html#django.db.IntegrityError" title="django.db.IntegrityError"><code>IntegrityError</code></a> will be raised.</p> <p>Finally, a word on using <code>get_or_create()</code> in Django views. Please make sure to use it only in <code>POST</code> requests unless you have a good reason not to. <code>GET</code> requests shouldn’t have any effect on data. Instead, use <code>POST</code> whenever a request to a page has a side effect on your data. For more, see <a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9110.html#section-9.2.1" id="index-0"><strong>Safe methods</strong></a> in the HTTP spec.</p> <div class="admonition warning"> <p class="admonition-title">Warning</p> <p>You can use <code>get_or_create()</code> through <a class="reference internal" href="fields.html#django.db.models.ManyToManyField" title="django.db.models.ManyToManyField"><code>ManyToManyField</code></a> attributes and reverse relations. In that case you will restrict the queries inside the context of that relation. That could lead you to some integrity problems if you don’t use it consistently.</p> <p>Being the following models:</p> <pre data-language="python">class Chapter(models.Model):
    title = models.CharField(max_length=255, unique=True)


class Book(models.Model):
    title = models.CharField(max_length=256)
    chapters = models.ManyToManyField(Chapter)
</pre> <p>You can use <code>get_or_create()</code> through Book’s chapters field, but it only fetches inside the context of that book:</p> <pre data-language="pycon">&gt;&gt;&gt; book = Book.objects.create(title="Ulysses")
&gt;&gt;&gt; book.chapters.get_or_create(title="Telemachus")
(&lt;Chapter: Telemachus&gt;, True)
&gt;&gt;&gt; book.chapters.get_or_create(title="Telemachus")
(&lt;Chapter: Telemachus&gt;, False)
&gt;&gt;&gt; Chapter.objects.create(title="Chapter 1")
&lt;Chapter: Chapter 1&gt;
&gt;&gt;&gt; book.chapters.get_or_create(title="Chapter 1")
# Raises IntegrityError
</pre> <p>This is happening because it’s trying to get or create “Chapter 1” through the book “Ulysses”, but it can’t do any of them: the relation can’t fetch that chapter because it isn’t related to that book, but it can’t create it either because <code>title</code> field should be unique.</p> </div> </section> <section id="s-update-or-create"> <h4 id="update-or-create"><code>update_or_create()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.update_or_create">
<code>update_or_create(defaults=None, create_defaults=None, **kwargs)</code> </dt> 
</dl> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.aupdate_or_create">
<code>aupdate_or_create(defaults=None, create_defaults=None, **kwargs)</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>aupdate_or_create()</code></p> <p>A convenience method for updating an object with the given <code>kwargs</code>, creating a new one if necessary. Both <code>create_defaults</code> and <code>defaults</code> are dictionaries of (field, value) pairs. The values in both <code>create_defaults</code> and <code>defaults</code> can be callables. <code>defaults</code> is used to update the object while <code>create_defaults</code> are used for the create operation. If <code>create_defaults</code> is not supplied, <code>defaults</code> will be used for the create operation.</p> <p>Returns a tuple of <code>(object, created)</code>, where <code>object</code> is the created or updated object and <code>created</code> is a boolean specifying whether a new object was created.</p> <p>The <code>update_or_create</code> method tries to fetch an object from database based on the given <code>kwargs</code>. If a match is found, it updates the fields passed in the <code>defaults</code> dictionary.</p> <p>This is meant as a shortcut to boilerplatish code. For example:</p> <pre data-language="python">defaults = {"first_name": "Bob"}
create_defaults = {"first_name": "Bob", "birthday": date(1940, 10, 9)}
try:
    obj = Person.objects.get(first_name="John", last_name="Lennon")
    for key, value in defaults.items():
        setattr(obj, key, value)
    obj.save()
except Person.DoesNotExist:
    new_values = {"first_name": "John", "last_name": "Lennon"}
    new_values.update(create_defaults)
    obj = Person(**new_values)
    obj.save()
</pre> <p>This pattern gets quite unwieldy as the number of fields in a model goes up. The above example can be rewritten using <code>update_or_create()</code> like so:</p> <pre data-language="python">obj, created = Person.objects.update_or_create(
    first_name="John",
    last_name="Lennon",
    defaults={"first_name": "Bob"},
    create_defaults={"first_name": "Bob", "birthday": date(1940, 10, 9)},
)
</pre> <p>For a detailed description of how names passed in <code>kwargs</code> are resolved, see <a class="reference internal" href="#django.db.models.query.QuerySet.get_or_create" title="django.db.models.query.QuerySet.get_or_create"><code>get_or_create()</code></a>.</p> <p>As described above in <a class="reference internal" href="#django.db.models.query.QuerySet.get_or_create" title="django.db.models.query.QuerySet.get_or_create"><code>get_or_create()</code></a>, this method is prone to a race-condition which can result in multiple rows being inserted simultaneously if uniqueness is not enforced at the database level.</p> <p>Like <a class="reference internal" href="#django.db.models.query.QuerySet.get_or_create" title="django.db.models.query.QuerySet.get_or_create"><code>get_or_create()</code></a> and <a class="reference internal" href="#django.db.models.query.QuerySet.create" title="django.db.models.query.QuerySet.create"><code>create()</code></a>, if you’re using manually specified primary keys and an object needs to be created but the key already exists in the database, an <a class="reference internal" href="../exceptions.html#django.db.IntegrityError" title="django.db.IntegrityError"><code>IntegrityError</code></a> is raised.</p> </section> <section id="s-bulk-create"> <h4 id="bulk-create"><code>bulk_create()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.bulk_create">
<code>bulk_create(objs, batch_size=None, ignore_conflicts=False, update_conflicts=False, update_fields=None, unique_fields=None)</code> </dt> 
</dl> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.abulk_create">
<code>abulk_create(objs, batch_size=None, ignore_conflicts=False, update_conflicts=False, update_fields=None, unique_fields=None)</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>abulk_create()</code></p> <p>This method inserts the provided list of objects into the database in an efficient manner (generally only 1 query, no matter how many objects there are), and returns created objects as a list, in the same order as provided:</p> <pre data-language="pycon">&gt;&gt;&gt; objs = Entry.objects.bulk_create(
...     [
...         Entry(headline="This is a test"),
...         Entry(headline="This is only a test"),
...     ]
... )
</pre> <p>This has a number of caveats though:</p> <ul> <li>The model’s <code>save()</code> method will not be called, and the <code>pre_save</code> and <code>post_save</code> signals will not be sent.</li> <li>It does not work with child models in a multi-table inheritance scenario.</li> <li>If the model’s primary key is an <a class="reference internal" href="fields.html#django.db.models.AutoField" title="django.db.models.AutoField"><code>AutoField</code></a> and <code>ignore_conflicts</code> is False, the primary key attribute can only be retrieved on certain databases (currently PostgreSQL, MariaDB, and SQLite 3.35+). On other databases, it will not be set.</li> <li>It does not work with many-to-many relationships.</li> <li>
<p>It casts <code>objs</code> to a list, which fully evaluates <code>objs</code> if it’s a generator. The cast allows inspecting all objects so that any objects with a manually set primary key can be inserted first. If you want to insert objects in batches without evaluating the entire generator at once, you can use this technique as long as the objects don’t have any manually set primary keys:</p> <pre data-language="python">from itertools import islice

batch_size = 100
objs = (Entry(headline="Test %s" % i) for i in range(1000))
while True:
    batch = list(islice(objs, batch_size))
    if not batch:
        break
    Entry.objects.bulk_create(batch, batch_size)
</pre> </li> </ul> <p>The <code>batch_size</code> parameter controls how many objects are created in a single query. The default is to create all objects in one batch, except for SQLite where the default is such that at most 999 variables per query are used.</p> <p>On databases that support it (all but Oracle), setting the <code>ignore_conflicts</code> parameter to <code>True</code> tells the database to ignore failure to insert any rows that fail constraints such as duplicate unique values.</p> <p>On databases that support it (all except Oracle), setting the <code>update_conflicts</code> parameter to <code>True</code>, tells the database to update <code>update_fields</code> when a row insertion fails on conflicts. On PostgreSQL and SQLite, in addition to <code>update_fields</code>, a list of <code>unique_fields</code> that may be in conflict must be provided.</p> <p>Enabling the <code>ignore_conflicts</code> parameter disables setting the primary key on each model instance (if the database normally supports it).</p> <div class="admonition warning"> <p class="admonition-title">Warning</p> <p>On MySQL and MariaDB, setting the <code>ignore_conflicts</code> parameter to <code>True</code> turns certain types of errors, other than duplicate key, into warnings. Even with Strict Mode. For example: invalid values or non-nullable violations. See the <a class="reference external" href="https://dev.mysql.com/doc/refman/en/sql-mode.html#ignore-strict-comparison">MySQL documentation</a> and <a class="reference external" href="https://mariadb.com/kb/en/ignore/">MariaDB documentation</a> for more details.</p> </div> </section> <section id="s-bulk-update"> <h4 id="bulk-update"><code>bulk_update()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.bulk_update">
<code>bulk_update(objs, fields, batch_size=None)</code> </dt> 
</dl> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.abulk_update">
<code>abulk_update(objs, fields, batch_size=None)</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>abulk_update()</code></p> <p>This method efficiently updates the given fields on the provided model instances, generally with one query, and returns the number of objects updated:</p> <pre data-language="pycon">&gt;&gt;&gt; objs = [
...     Entry.objects.create(headline="Entry 1"),
...     Entry.objects.create(headline="Entry 2"),
... ]
&gt;&gt;&gt; objs[0].headline = "This is entry 1"
&gt;&gt;&gt; objs[1].headline = "This is entry 2"
&gt;&gt;&gt; Entry.objects.bulk_update(objs, ["headline"])
2
</pre> <p><a class="reference internal" href="#django.db.models.query.QuerySet.update" title="django.db.models.query.QuerySet.update"><code>QuerySet.update()</code></a> is used to save the changes, so this is more efficient than iterating through the list of models and calling <code>save()</code> on each of them, but it has a few caveats:</p> <ul class="simple"> <li>You cannot update the model’s primary key.</li> <li>Each model’s <code>save()</code> method isn’t called, and the <a class="reference internal" href="../signals.html#django.db.models.signals.pre_save" title="django.db.models.signals.pre_save"><code>pre_save</code></a> and <a class="reference internal" href="../signals.html#django.db.models.signals.post_save" title="django.db.models.signals.post_save"><code>post_save</code></a> signals aren’t sent.</li> <li>If updating a large number of columns in a large number of rows, the SQL generated can be very large. Avoid this by specifying a suitable <code>batch_size</code>.</li> <li>Updating fields defined on multi-table inheritance ancestors will incur an extra query per ancestor.</li> <li>When an individual batch contains duplicates, only the first instance in that batch will result in an update.</li> <li>The number of objects updated returned by the function may be fewer than the number of objects passed in. This can be due to duplicate objects passed in which are updated in the same batch or race conditions such that objects are no longer present in the database.</li> </ul> <p>The <code>batch_size</code> parameter controls how many objects are saved in a single query. The default is to update all objects in one batch, except for SQLite and Oracle which have restrictions on the number of variables used in a query.</p> </section> <section id="s-count"> <h4 id="count"><code>count()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.count">
<code>count()</code> </dt> 
</dl> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.acount">
<code>acount()</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>acount()</code></p> <p>Returns an integer representing the number of objects in the database matching the <code>QuerySet</code>.</p> <p>Example:</p> <pre data-language="python"># Returns the total number of entries in the database.
Entry.objects.count()

# Returns the number of entries whose headline contains 'Lennon'
Entry.objects.filter(headline__contains="Lennon").count()
</pre> <p>A <code>count()</code> call performs a <code>SELECT COUNT(*)</code> behind the scenes, so you should always use <code>count()</code> rather than loading all of the record into Python objects and calling <code>len()</code> on the result (unless you need to load the objects into memory anyway, in which case <code>len()</code> will be faster).</p> <p>Note that if you want the number of items in a <code>QuerySet</code> and are also retrieving model instances from it (for example, by iterating over it), it’s probably more efficient to use <code>len(queryset)</code> which won’t cause an extra database query like <code>count()</code> would.</p> <p>If the queryset has already been fully retrieved, <code>count()</code> will use that length rather than perform an extra database query.</p> </section> <section id="s-in-bulk"> <h4 id="in-bulk"><code>in_bulk()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.in_bulk">
<code>in_bulk(id_list=None, *, field_name='pk')</code> </dt> 
</dl> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.ain_bulk">
<code>ain_bulk(id_list=None, *, field_name='pk')</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>ain_bulk()</code></p> <p>Takes a list of field values (<code>id_list</code>) and the <code>field_name</code> for those values, and returns a dictionary mapping each value to an instance of the object with the given field value. No <a class="reference internal" href="../exceptions.html#django.core.exceptions.ObjectDoesNotExist" title="django.core.exceptions.ObjectDoesNotExist"><code>django.core.exceptions.ObjectDoesNotExist</code></a> exceptions will ever be raised by <code>in_bulk</code>; that is, any <code>id_list</code> value not matching any instance will simply be ignored. If <code>id_list</code> isn’t provided, all objects in the queryset are returned. <code>field_name</code> must be a unique field or a distinct field (if there’s only one field specified in <a class="reference internal" href="#django.db.models.query.QuerySet.distinct" title="django.db.models.query.QuerySet.distinct"><code>distinct()</code></a>). <code>field_name</code> defaults to the primary key.</p> <p>Example:</p> <pre data-language="pycon">&gt;&gt;&gt; Blog.objects.in_bulk([1])
{1: &lt;Blog: Beatles Blog&gt;}
&gt;&gt;&gt; Blog.objects.in_bulk([1, 2])
{1: &lt;Blog: Beatles Blog&gt;, 2: &lt;Blog: Cheddar Talk&gt;}
&gt;&gt;&gt; Blog.objects.in_bulk([])
{}
&gt;&gt;&gt; Blog.objects.in_bulk()
{1: &lt;Blog: Beatles Blog&gt;, 2: &lt;Blog: Cheddar Talk&gt;, 3: &lt;Blog: Django Weblog&gt;}
&gt;&gt;&gt; Blog.objects.in_bulk(["beatles_blog"], field_name="slug")
{'beatles_blog': &lt;Blog: Beatles Blog&gt;}
&gt;&gt;&gt; Blog.objects.distinct("name").in_bulk(field_name="name")
{'Beatles Blog': &lt;Blog: Beatles Blog&gt;, 'Cheddar Talk': &lt;Blog: Cheddar Talk&gt;, 'Django Weblog': &lt;Blog: Django Weblog&gt;}
</pre> <p>If you pass <code>in_bulk()</code> an empty list, you’ll get an empty dictionary.</p> </section> <section id="s-iterator"> <h4 id="iterator"><code>iterator()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.iterator">
<code>iterator(chunk_size=None)</code> </dt> 
</dl> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.aiterator">
<code>aiterator(chunk_size=None)</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>aiterator()</code></p> <p>Evaluates the <code>QuerySet</code> (by performing the query) and returns an iterator (see <a class="pep reference external" href="https://peps.python.org/pep-0234/" id="index-1"><strong>PEP 234</strong></a>) over the results, or an asynchronous iterator (see <a class="pep reference external" href="https://peps.python.org/pep-0492/" id="index-2"><strong>PEP 492</strong></a>) if you call its asynchronous version <code>aiterator</code>.</p> <p>A <code>QuerySet</code> typically caches its results internally so that repeated evaluations do not result in additional queries. In contrast, <code>iterator()</code> will read results directly, without doing any caching at the <code>QuerySet</code> level (internally, the default iterator calls <code>iterator()</code> and caches the return value). For a <code>QuerySet</code> which returns a large number of objects that you only need to access once, this can result in better performance and a significant reduction in memory.</p> <p>Note that using <code>iterator()</code> on a <code>QuerySet</code> which has already been evaluated will force it to evaluate again, repeating the query.</p> <p><code>iterator()</code> is compatible with previous calls to <code>prefetch_related()</code> as long as <code>chunk_size</code> is given. Larger values will necessitate fewer queries to accomplish the prefetching at the cost of greater memory usage.</p> <p>On some databases (e.g. Oracle, <a class="reference external" href="https://www.sqlite.org/limits.html#max_variable_number">SQLite</a>), the maximum number of terms in an SQL <code>IN</code> clause might be limited. Hence values below this limit should be used. (In particular, when prefetching across two or more relations, a <code>chunk_size</code> should be small enough that the anticipated number of results for each prefetched relation still falls below the limit.)</p> <p>So long as the QuerySet does not prefetch any related objects, providing no value for <code>chunk_size</code> will result in Django using an implicit default of 2000.</p> <p>Depending on the database backend, query results will either be loaded all at once or streamed from the database using server-side cursors.</p> <section id="s-with-server-side-cursors"> <h5 id="with-server-side-cursors">With server-side cursors</h5> <p>Oracle and <a class="reference internal" href="../databases.html#postgresql-server-side-cursors"><span class="std std-ref">PostgreSQL</span></a> use server-side cursors to stream results from the database without loading the entire result set into memory.</p> <p>The Oracle database driver always uses server-side cursors.</p> <p>With server-side cursors, the <code>chunk_size</code> parameter specifies the number of results to cache at the database driver level. Fetching bigger chunks diminishes the number of round trips between the database driver and the database, at the expense of memory.</p> <p>On PostgreSQL, server-side cursors will only be used when the <a class="reference internal" href="../settings.html#std-setting-DATABASE-DISABLE_SERVER_SIDE_CURSORS"><code>DISABLE_SERVER_SIDE_CURSORS</code></a> setting is <code>False</code>. Read <a class="reference internal" href="../databases.html#transaction-pooling-server-side-cursors"><span class="std std-ref">Transaction pooling and server-side cursors</span></a> if you’re using a connection pooler configured in transaction pooling mode. When server-side cursors are disabled, the behavior is the same as databases that don’t support server-side cursors.</p> </section> <section id="s-without-server-side-cursors"> <h5 id="without-server-side-cursors">Without server-side cursors</h5> <p>MySQL doesn’t support streaming results, hence the Python database driver loads the entire result set into memory. The result set is then transformed into Python row objects by the database adapter using the <code>fetchmany()</code> method defined in <a class="pep reference external" href="https://peps.python.org/pep-0249/" id="index-3"><strong>PEP 249</strong></a>.</p> <p>SQLite can fetch results in batches using <code>fetchmany()</code>, but since SQLite doesn’t provide isolation between queries within a connection, be careful when writing to the table being iterated over. See <a class="reference internal" href="../databases.html#sqlite-isolation"><span class="std std-ref">Isolation when using QuerySet.iterator()</span></a> for more information.</p> <p>The <code>chunk_size</code> parameter controls the size of batches Django retrieves from the database driver. Larger batches decrease the overhead of communicating with the database driver at the expense of a slight increase in memory consumption.</p> <p>So long as the QuerySet does not prefetch any related objects, providing no value for <code>chunk_size</code> will result in Django using an implicit default of 2000, a value derived from <a class="reference external" href="https://www.postgresql.org/message-id/4D2F2C71.8080805%40dndg.it">a calculation on the psycopg mailing list</a>:</p>  <p>Assuming rows of 10-20 columns with a mix of textual and numeric data, 2000 is going to fetch less than 100KB of data, which seems a good compromise between the number of rows transferred and the data discarded if the loop is exited early.</p>  </section> </section> <section id="s-latest"> <h4 id="latest"><code>latest()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.latest">
<code>latest(*fields)</code> </dt> 
</dl> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.alatest">
<code>alatest(*fields)</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>alatest()</code></p> <p>Returns the latest object in the table based on the given field(s).</p> <p>This example returns the latest <code>Entry</code> in the table, according to the <code>pub_date</code> field:</p> <pre data-language="python">Entry.objects.latest("pub_date")
</pre> <p>You can also choose the latest based on several fields. For example, to select the <code>Entry</code> with the earliest <code>expire_date</code> when two entries have the same <code>pub_date</code>:</p> <pre data-language="python">Entry.objects.latest("pub_date", "-expire_date")
</pre> <p>The negative sign in <code>'-expire_date'</code> means to sort <code>expire_date</code> in <em>descending</em> order. Since <code>latest()</code> gets the last result, the <code>Entry</code> with the earliest <code>expire_date</code> is selected.</p> <p>If your model’s <a class="reference internal" href="../../topics/db/models.html#meta-options"><span class="std std-ref">Meta</span></a> specifies <a class="reference internal" href="options.html#django.db.models.Options.get_latest_by" title="django.db.models.Options.get_latest_by"><code>get_latest_by</code></a>, you can omit any arguments to <code>earliest()</code> or <code>latest()</code>. The fields specified in <a class="reference internal" href="options.html#django.db.models.Options.get_latest_by" title="django.db.models.Options.get_latest_by"><code>get_latest_by</code></a> will be used by default.</p> <p>Like <a class="reference internal" href="#django.db.models.query.QuerySet.get" title="django.db.models.query.QuerySet.get"><code>get()</code></a>, <code>earliest()</code> and <code>latest()</code> raise <a class="reference internal" href="class.html#django.db.models.Model.DoesNotExist" title="django.db.models.Model.DoesNotExist"><code>DoesNotExist</code></a> if there is no object with the given parameters.</p> <p>Note that <code>earliest()</code> and <code>latest()</code> exist purely for convenience and readability.</p> <div class="admonition-earliest-and-latest-may-return-instances-with-null-dates admonition"> <p class="admonition-title"><code>earliest()</code> and <code>latest()</code> may return instances with null dates.</p> <p>Since ordering is delegated to the database, results on fields that allow null values may be ordered differently if you use different databases. For example, PostgreSQL and MySQL sort null values as if they are higher than non-null values, while SQLite does the opposite.</p> <p>You may want to filter out null values:</p> <pre data-language="python">Entry.objects.filter(pub_date__isnull=False).latest("pub_date")
</pre> </div> </section> <section id="s-earliest"> <h4 id="earliest"><code>earliest()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.earliest">
<code>earliest(*fields)</code> </dt> 
</dl> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.aearliest">
<code>aearliest(*fields)</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>aearliest()</code></p> <p>Works otherwise like <a class="reference internal" href="#django.db.models.query.QuerySet.latest" title="django.db.models.query.QuerySet.latest"><code>latest()</code></a> except the direction is changed.</p> </section> <section id="s-first"> <h4 id="first"><code>first()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.first">
<code>first()</code> </dt> 
</dl> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.afirst">
<code>afirst()</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>afirst()</code></p> <p>Returns the first object matched by the queryset, or <code>None</code> if there is no matching object. If the <code>QuerySet</code> has no ordering defined, then the queryset is automatically ordered by the primary key. This can affect aggregation results as described in <a class="reference internal" href="../../topics/db/aggregation.html#aggregation-ordering-interaction"><span class="std std-ref">Interaction with order_by()</span></a>.</p> <p>Example:</p> <pre data-language="python">p = Article.objects.order_by("title", "pub_date").first()
</pre> <p>Note that <code>first()</code> is a convenience method, the following code sample is equivalent to the above example:</p> <pre data-language="python">try:
    p = Article.objects.order_by("title", "pub_date")[0]
except IndexError:
    p = None
</pre> </section> <section id="s-last"> <h4 id="last"><code>last()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.last">
<code>last()</code> </dt> 
</dl> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.alast">
<code>alast()</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>alast()</code></p> <p>Works like <a class="reference internal" href="#django.db.models.query.QuerySet.first" title="django.db.models.query.QuerySet.first"><code>first()</code></a>, but returns the last object in the queryset.</p> </section> <section id="s-aggregate"> <h4 id="aggregate"><code>aggregate()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.aggregate">
<code>aggregate(*args, **kwargs)</code> </dt> 
</dl> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.aaggregate">
<code>aaggregate(*args, **kwargs)</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>aaggregate()</code></p> <p>Returns a dictionary of aggregate values (averages, sums, etc.) calculated over the <code>QuerySet</code>. Each argument to <code>aggregate()</code> specifies a value that will be included in the dictionary that is returned.</p> <p>The aggregation functions that are provided by Django are described in <a class="reference internal" href="#id6">Aggregation Functions</a> below. Since aggregates are also <a class="reference internal" href="expressions.html"><span class="doc">query expressions</span></a>, you may combine aggregates with other aggregates or values to create complex aggregates.</p> <p>Aggregates specified using keyword arguments will use the keyword as the name for the annotation. Anonymous arguments will have a name generated for them based upon the name of the aggregate function and the model field that is being aggregated. Complex aggregates cannot use anonymous arguments and must specify a keyword argument as an alias.</p> <p>For example, when you are working with blog entries, you may want to know the number of authors that have contributed blog entries:</p> <pre data-language="pycon">&gt;&gt;&gt; from django.db.models import Count
&gt;&gt;&gt; Blog.objects.aggregate(Count("entry"))
{'entry__count': 16}
</pre> <p>By using a keyword argument to specify the aggregate function, you can control the name of the aggregation value that is returned:</p> <pre data-language="pycon">&gt;&gt;&gt; Blog.objects.aggregate(number_of_entries=Count("entry"))
{'number_of_entries': 16}
</pre> <p>For an in-depth discussion of aggregation, see <a class="reference internal" href="../../topics/db/aggregation.html"><span class="doc">the topic guide on Aggregation</span></a>.</p> </section> <section id="s-exists"> <h4 id="exists"><code>exists()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.exists">
<code>exists()</code> </dt> 
</dl> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.aexists">
<code>aexists()</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>aexists()</code></p> <p>Returns <code>True</code> if the <a class="reference internal" href="#django.db.models.query.QuerySet" title="django.db.models.query.QuerySet"><code>QuerySet</code></a> contains any results, and <code>False</code> if not. This tries to perform the query in the simplest and fastest way possible, but it <em>does</em> execute nearly the same query as a normal <a class="reference internal" href="#django.db.models.query.QuerySet" title="django.db.models.query.QuerySet"><code>QuerySet</code></a> query.</p> <p><a class="reference internal" href="#django.db.models.query.QuerySet.exists" title="django.db.models.query.QuerySet.exists"><code>exists()</code></a> is useful for searches relating to the existence of any objects in a <a class="reference internal" href="#django.db.models.query.QuerySet" title="django.db.models.query.QuerySet"><code>QuerySet</code></a>, particularly in the context of a large <a class="reference internal" href="#django.db.models.query.QuerySet" title="django.db.models.query.QuerySet"><code>QuerySet</code></a>.</p> <p>To find whether a queryset contains any items:</p> <pre data-language="python">if some_queryset.exists():
    print("There is at least one object in some_queryset")
</pre> <p>Which will be faster than:</p> <pre data-language="python">if some_queryset:
    print("There is at least one object in some_queryset")
</pre> <p>… but not by a large degree (hence needing a large queryset for efficiency gains).</p> <p>Additionally, if a <code>some_queryset</code> has not yet been evaluated, but you know that it will be at some point, then using <code>some_queryset.exists()</code> will do more overall work (one query for the existence check plus an extra one to later retrieve the results) than using <code>bool(some_queryset)</code>, which retrieves the results and then checks if any were returned.</p> </section> <section id="s-contains"> <h4 id="contains"><code>contains()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.contains">
<code>contains(obj)</code> </dt> 
</dl> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.acontains">
<code>acontains(obj)</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>acontains()</code></p> <p>Returns <code>True</code> if the <a class="reference internal" href="#django.db.models.query.QuerySet" title="django.db.models.query.QuerySet"><code>QuerySet</code></a> contains <code>obj</code>, and <code>False</code> if not. This tries to perform the query in the simplest and fastest way possible.</p> <p><a class="reference internal" href="#django.db.models.query.QuerySet.contains" title="django.db.models.query.QuerySet.contains"><code>contains()</code></a> is useful for checking an object membership in a <a class="reference internal" href="#django.db.models.query.QuerySet" title="django.db.models.query.QuerySet"><code>QuerySet</code></a>, particularly in the context of a large <a class="reference internal" href="#django.db.models.query.QuerySet" title="django.db.models.query.QuerySet"><code>QuerySet</code></a>.</p> <p>To check whether a queryset contains a specific item:</p> <pre data-language="python">if some_queryset.contains(obj):
    print("Entry contained in queryset")
</pre> <p>This will be faster than the following which requires evaluating and iterating through the entire queryset:</p> <pre data-language="python">if obj in some_queryset:
    print("Entry contained in queryset")
</pre> <p>Like <a class="reference internal" href="#django.db.models.query.QuerySet.exists" title="django.db.models.query.QuerySet.exists"><code>exists()</code></a>, if <code>some_queryset</code> has not yet been evaluated, but you know that it will be at some point, then using <code>some_queryset.contains(obj)</code> will make an additional database query, generally resulting in slower overall performance.</p> </section> <section id="s-update"> <h4 id="update"><code>update()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.update">
<code>update(**kwargs)</code> </dt> 
</dl> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.aupdate">
<code>aupdate(**kwargs)</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>aupdate()</code></p> <p>Performs an SQL update query for the specified fields, and returns the number of rows matched (which may not be equal to the number of rows updated if some rows already have the new value).</p> <p>For example, to turn comments off for all blog entries published in 2010, you could do this:</p> <pre data-language="pycon">&gt;&gt;&gt; Entry.objects.filter(pub_date__year=2010).update(comments_on=False)
</pre> <p>(This assumes your <code>Entry</code> model has fields <code>pub_date</code> and <code>comments_on</code>.)</p> <p>You can update multiple fields — there’s no limit on how many. For example, here we update the <code>comments_on</code> and <code>headline</code> fields:</p> <pre data-language="pycon">&gt;&gt;&gt; Entry.objects.filter(pub_date__year=2010).update(
...     comments_on=False, headline="This is old"
... )
</pre> <p>The <code>update()</code> method is applied instantly, and the only restriction on the <a class="reference internal" href="#django.db.models.query.QuerySet" title="django.db.models.query.QuerySet"><code>QuerySet</code></a> that is updated is that it can only update columns in the model’s main table, not on related models. You can’t do this, for example:</p> <pre data-language="pycon">&gt;&gt;&gt; Entry.objects.update(blog__name="foo")  # Won't work!
</pre> <p>Filtering based on related fields is still possible, though:</p> <pre data-language="pycon">&gt;&gt;&gt; Entry.objects.filter(blog__id=1).update(comments_on=True)
</pre> <p>You cannot call <code>update()</code> on a <a class="reference internal" href="#django.db.models.query.QuerySet" title="django.db.models.query.QuerySet"><code>QuerySet</code></a> that has had a slice taken or can otherwise no longer be filtered.</p> <p>The <code>update()</code> method returns the number of affected rows:</p> <pre data-language="pycon">&gt;&gt;&gt; Entry.objects.filter(id=64).update(comments_on=True)
1

&gt;&gt;&gt; Entry.objects.filter(slug="nonexistent-slug").update(comments_on=True)
0

&gt;&gt;&gt; Entry.objects.filter(pub_date__year=2010).update(comments_on=False)
132
</pre> <p>If you’re just updating a record and don’t need to do anything with the model object, the most efficient approach is to call <code>update()</code>, rather than loading the model object into memory. For example, instead of doing this:</p> <pre data-language="python">e = Entry.objects.get(id=10)
e.comments_on = False
e.save()
</pre> <p>…do this:</p> <pre data-language="python">Entry.objects.filter(id=10).update(comments_on=False)
</pre> <p>Using <code>update()</code> also prevents a race condition wherein something might change in your database in the short period of time between loading the object and calling <code>save()</code>.</p> <p>Finally, realize that <code>update()</code> does an update at the SQL level and, thus, does not call any <code>save()</code> methods on your models, nor does it emit the <a class="reference internal" href="../signals.html#django.db.models.signals.pre_save" title="django.db.models.signals.pre_save"><code>pre_save</code></a> or <a class="reference internal" href="../signals.html#django.db.models.signals.post_save" title="django.db.models.signals.post_save"><code>post_save</code></a> signals (which are a consequence of calling <a class="reference internal" href="instances.html#django.db.models.Model.save" title="django.db.models.Model.save"><code>Model.save()</code></a>). If you want to update a bunch of records for a model that has a custom <a class="reference internal" href="instances.html#django.db.models.Model.save" title="django.db.models.Model.save"><code>save()</code></a> method, loop over them and call <a class="reference internal" href="instances.html#django.db.models.Model.save" title="django.db.models.Model.save"><code>save()</code></a>, like this:</p> <pre data-language="python">for e in Entry.objects.filter(pub_date__year=2010):
    e.comments_on = False
    e.save()
</pre> <section id="s-ordered-queryset"> <h5 id="ordered-queryset">Ordered queryset</h5> <p>Chaining <code>order_by()</code> with <code>update()</code> is supported only on MariaDB and MySQL, and is ignored for different databases. This is useful for updating a unique field in the order that is specified without conflicts. For example:</p> <pre data-language="python">Entry.objects.order_by("-number").update(number=F("number") + 1)
</pre> <div class="admonition note"> <p class="admonition-title">Note</p> <p><code>order_by()</code> clause will be ignored if it contains annotations, inherited fields, or lookups spanning relations.</p> </div> </section> </section> <section id="s-delete"> <h4 id="delete"><code>delete()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.delete">
<code>delete()</code> </dt> 
</dl> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.adelete">
<code>adelete()</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>adelete()</code></p> <p>Performs an SQL delete query on all rows in the <a class="reference internal" href="#django.db.models.query.QuerySet" title="django.db.models.query.QuerySet"><code>QuerySet</code></a> and returns the number of objects deleted and a dictionary with the number of deletions per object type.</p> <p>The <code>delete()</code> is applied instantly. You cannot call <code>delete()</code> on a <a class="reference internal" href="#django.db.models.query.QuerySet" title="django.db.models.query.QuerySet"><code>QuerySet</code></a> that has had a slice taken or can otherwise no longer be filtered.</p> <p>For example, to delete all the entries in a particular blog:</p> <pre data-language="pycon">&gt;&gt;&gt; b = Blog.objects.get(pk=1)

# Delete all the entries belonging to this Blog.
&gt;&gt;&gt; Entry.objects.filter(blog=b).delete()
(4, {'blog.Entry': 2, 'blog.Entry_authors': 2})
</pre> <p>By default, Django’s <a class="reference internal" href="fields.html#django.db.models.ForeignKey" title="django.db.models.ForeignKey"><code>ForeignKey</code></a> emulates the SQL constraint <code>ON DELETE CASCADE</code> — in other words, any objects with foreign keys pointing at the objects to be deleted will be deleted along with them. For example:</p> <pre data-language="pycon">&gt;&gt;&gt; blogs = Blog.objects.all()

# This will delete all Blogs and all of their Entry objects.
&gt;&gt;&gt; blogs.delete()
(5, {'blog.Blog': 1, 'blog.Entry': 2, 'blog.Entry_authors': 2})
</pre> <p>This cascade behavior is customizable via the <a class="reference internal" href="fields.html#django.db.models.ForeignKey.on_delete" title="django.db.models.ForeignKey.on_delete"><code>on_delete</code></a> argument to the <a class="reference internal" href="fields.html#django.db.models.ForeignKey" title="django.db.models.ForeignKey"><code>ForeignKey</code></a>.</p> <p>The <code>delete()</code> method does a bulk delete and does not call any <code>delete()</code> methods on your models. It does, however, emit the <a class="reference internal" href="../signals.html#django.db.models.signals.pre_delete" title="django.db.models.signals.pre_delete"><code>pre_delete</code></a> and <a class="reference internal" href="../signals.html#django.db.models.signals.post_delete" title="django.db.models.signals.post_delete"><code>post_delete</code></a> signals for all deleted objects (including cascaded deletions).</p> <p>Django needs to fetch objects into memory to send signals and handle cascades. However, if there are no cascades and no signals, then Django may take a fast-path and delete objects without fetching into memory. For large deletes this can result in significantly reduced memory usage. The amount of executed queries can be reduced, too.</p> <p>ForeignKeys which are set to <a class="reference internal" href="fields.html#django.db.models.ForeignKey.on_delete" title="django.db.models.ForeignKey.on_delete"><code>on_delete</code></a> <code>DO_NOTHING</code> do not prevent taking the fast-path in deletion.</p> <p>Note that the queries generated in object deletion is an implementation detail subject to change.</p> </section> <section id="s-as-manager"> <h4 id="as-manager"><code>as_manager()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.as_manager">
<code>classmethod as_manager()</code> </dt> 
</dl> <p>Class method that returns an instance of <a class="reference internal" href="../../topics/db/managers.html#django.db.models.Manager" title="django.db.models.Manager"><code>Manager</code></a> with a copy of the <code>QuerySet</code>’s methods. See <a class="reference internal" href="../../topics/db/managers.html#create-manager-with-queryset-methods"><span class="std std-ref">Creating a manager with QuerySet methods</span></a> for more details.</p> <p>Note that unlike the other entries in this section, this does not have an asynchronous variant as it does not execute a query.</p> </section> <section id="s-explain"> <h4 id="explain"><code>explain()</code></h4> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.explain">
<code>explain(format=None, **options)</code> </dt> 
</dl> <dl class="py method"> <dt class="sig sig-object py" id="django.db.models.query.QuerySet.aexplain">
<code>aexplain(format=None, **options)</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>aexplain()</code></p> <p>Returns a string of the <code>QuerySet</code>’s execution plan, which details how the database would execute the query, including any indexes or joins that would be used. Knowing these details may help you improve the performance of slow queries.</p> <p>For example, when using PostgreSQL:</p> <pre data-language="pycon">&gt;&gt;&gt; print(Blog.objects.filter(title="My Blog").explain())
Seq Scan on blog  (cost=0.00..35.50 rows=10 width=12)
  Filter: (title = 'My Blog'::bpchar)
</pre> <p>The output differs significantly between databases.</p> <p><code>explain()</code> is supported by all built-in database backends except Oracle because an implementation there isn’t straightforward.</p> <p>The <code>format</code> parameter changes the output format from the databases’s default, which is usually text-based. PostgreSQL supports <code>'TEXT'</code>, <code>'JSON'</code>, <code>'YAML'</code>, and <code>'XML'</code> formats. MariaDB and MySQL support <code>'TEXT'</code> (also called <code>'TRADITIONAL'</code>) and <code>'JSON'</code> formats. MySQL 8.0.16+ also supports an improved <code>'TREE'</code> format, which is similar to PostgreSQL’s <code>'TEXT'</code> output and is used by default, if supported.</p> <p>Some databases accept flags that can return more information about the query. Pass these flags as keyword arguments. For example, when using PostgreSQL:</p> <pre data-language="pycon">&gt;&gt;&gt; print(Blog.objects.filter(title="My Blog").explain(verbose=True, analyze=True))
Seq Scan on public.blog  (cost=0.00..35.50 rows=10 width=12) (actual time=0.004..0.004 rows=10 loops=1)
  Output: id, title
  Filter: (blog.title = 'My Blog'::bpchar)
Planning time: 0.064 ms
Execution time: 0.058 ms
</pre> <p>On some databases, flags may cause the query to be executed which could have adverse effects on your database. For example, the <code>ANALYZE</code> flag supported by MariaDB, MySQL 8.0.18+, and PostgreSQL could result in changes to data if there are triggers or if a function is called, even for a <code>SELECT</code> query.</p> <div class="versionchanged"> <span class="title">Changed in Django 5.1:</span> <p>Support for the <code>generic_plan</code> option on PostgreSQL 16+ was added.</p> </div> <div class="versionchanged"> <span class="title">Changed in Django 5.2:</span> <p>Support for the <code>memory</code> and <code>serialize</code> options on PostgreSQL 17+ was added.</p> </div> </section> </section> <section id="s-field-lookups"> <h3 id="id4">
<code>Field</code> lookups</h3> <p>Field lookups are how you specify the meat of an SQL <code>WHERE</code> clause. They’re specified as keyword arguments to the <code>QuerySet</code> methods <a class="reference internal" href="#django.db.models.query.QuerySet.filter" title="django.db.models.query.QuerySet.filter"><code>filter()</code></a>, <a class="reference internal" href="#django.db.models.query.QuerySet.exclude" title="django.db.models.query.QuerySet.exclude"><code>exclude()</code></a> and <a class="reference internal" href="#django.db.models.query.QuerySet.get" title="django.db.models.query.QuerySet.get"><code>get()</code></a>.</p> <p>For an introduction, see <a class="reference internal" href="../../topics/db/queries.html#field-lookups-intro"><span class="std std-ref">models and database queries documentation</span></a>.</p> <p>Django’s built-in lookups are listed below. It is also possible to write <a class="reference internal" href="../../howto/custom-lookups.html"><span class="doc">custom lookups</span></a> for model fields.</p> <p>As a convenience when no lookup type is provided (like in <code>Entry.objects.get(id=14)</code>) the lookup type is assumed to be <a class="reference internal" href="#std-fieldlookup-exact"><code>exact</code></a>.</p> <section id="s-exact"> <h4 id="std-fieldlookup-exact"><code>exact</code></h4> <p>Exact match. If the value provided for comparison is <code>None</code>, it will be interpreted as an SQL <code>NULL</code> (see <a class="reference internal" href="#std-fieldlookup-isnull"><code>isnull</code></a> for more details).</p> <p>Examples:</p> <pre data-language="python">Entry.objects.get(id__exact=14)
Entry.objects.get(id__exact=None)
</pre> <p>SQL equivalents:</p> <pre data-language="sql">SELECT ... WHERE id = 14;
SELECT ... WHERE id IS NULL;
</pre> <div class="admonition-mysql-comparisons admonition"> <p class="admonition-title">MySQL comparisons</p> <p>In MySQL, a database table’s “collation” setting determines whether <code>exact</code> comparisons are case-sensitive. This is a database setting, <em>not</em> a Django setting. It’s possible to configure your MySQL tables to use case-sensitive comparisons, but some trade-offs are involved. For more information about this, see the <a class="reference internal" href="../databases.html#mysql-collation"><span class="std std-ref">collation section</span></a> in the <a class="reference internal" href="../databases.html"><span class="doc">databases</span></a> documentation.</p> </div> </section> <section id="s-iexact"> <h4 id="std-fieldlookup-iexact"><code>iexact</code></h4> <p>Case-insensitive exact match. If the value provided for comparison is <code>None</code>, it will be interpreted as an SQL <code>NULL</code> (see <a class="reference internal" href="#std-fieldlookup-isnull"><code>isnull</code></a> for more details).</p> <p>Example:</p> <pre data-language="python">Blog.objects.get(name__iexact="beatles blog")
Blog.objects.get(name__iexact=None)
</pre> <p>SQL equivalents:</p> <pre data-language="sql">SELECT ... WHERE name ILIKE 'beatles blog';
SELECT ... WHERE name IS NULL;
</pre> <p>Note the first query will match <code>'Beatles Blog'</code>, <code>'beatles blog'</code>, <code>'BeAtLes BLoG'</code>, etc.</p> <div class="admonition-sqlite-users admonition"> <p class="admonition-title">SQLite users</p> <p>When using the SQLite backend and non-ASCII strings, bear in mind the <a class="reference internal" href="../databases.html#sqlite-string-matching"><span class="std std-ref">database note</span></a> about string comparisons. SQLite does not do case-insensitive matching for non-ASCII strings.</p> </div> </section> <section id="s-std-fieldlookup-contains"> <h4 id="id5"><code>contains</code></h4> <p>Case-sensitive containment test.</p> <p>Example:</p> <pre data-language="python">Entry.objects.get(headline__contains="Lennon")
</pre> <p>SQL equivalent:</p> <pre data-language="sql">SELECT ... WHERE headline LIKE '%Lennon%';
</pre> <p>Note this will match the headline <code>'Lennon honored today'</code> but not <code>'lennon
honored today'</code>.</p> <div class="admonition-sqlite-users admonition"> <p class="admonition-title">SQLite users</p> <p>SQLite doesn’t support case-sensitive <code>LIKE</code> statements; <code>contains</code> acts like <code>icontains</code> for SQLite. See the <a class="reference internal" href="../databases.html#sqlite-string-matching"><span class="std std-ref">database note</span></a> for more information.</p> </div> </section> <section id="s-icontains"> <h4 id="std-fieldlookup-icontains"><code>icontains</code></h4> <p>Case-insensitive containment test.</p> <p>Example:</p> <pre data-language="python">Entry.objects.get(headline__icontains="Lennon")
</pre> <p>SQL equivalent:</p> <pre data-language="sql">SELECT ... WHERE headline ILIKE '%Lennon%';
</pre> <div class="admonition-sqlite-users admonition"> <p class="admonition-title">SQLite users</p> <p>When using the SQLite backend and non-ASCII strings, bear in mind the <a class="reference internal" href="../databases.html#sqlite-string-matching"><span class="std std-ref">database note</span></a> about string comparisons.</p> </div> </section> <section id="s-in"> <h4 id="std-fieldlookup-in"><code>in</code></h4> <p>In a given iterable; often a list, tuple, or queryset. It’s not a common use case, but strings (being iterables) are accepted.</p> <p>Examples:</p> <pre data-language="python">Entry.objects.filter(id__in=[1, 3, 4])
Entry.objects.filter(headline__in="abc")
</pre> <p>SQL equivalents:</p> <pre data-language="sql">SELECT ... WHERE id IN (1, 3, 4);
SELECT ... WHERE headline IN ('a', 'b', 'c');
</pre> <p>You can also use a queryset to dynamically evaluate the list of values instead of providing a list of literal values:</p> <pre data-language="python">inner_qs = Blog.objects.filter(name__contains="Cheddar")
entries = Entry.objects.filter(blog__in=inner_qs)
</pre> <p>This queryset will be evaluated as subselect statement:</p> <pre data-language="sql">SELECT ... WHERE blog.id IN (SELECT id FROM ... WHERE NAME LIKE '%Cheddar%')
</pre> <p>If you pass in a <code>QuerySet</code> resulting from <code>values()</code> or <code>values_list()</code> as the value to an <code>__in</code> lookup, you need to ensure you are only extracting one field in the result. For example, this will work (filtering on the blog names):</p> <pre data-language="python">inner_qs = Blog.objects.filter(name__contains="Ch").values("name")
entries = Entry.objects.filter(blog__name__in=inner_qs)
</pre> <p>This example will raise an exception, since the inner query is trying to extract two field values, where only one is expected:</p> <pre data-language="python"># Bad code! Will raise a TypeError.
inner_qs = Blog.objects.filter(name__contains="Ch").values("name", "id")
entries = Entry.objects.filter(blog__name__in=inner_qs)
</pre> <div class="admonition-performance-considerations admonition" id="nested-queries-performance"> <p class="admonition-title">Performance considerations</p> <p>Be cautious about using nested queries and understand your database server’s performance characteristics (if in doubt, benchmark!). Some database backends, most notably MySQL, don’t optimize nested queries very well. It is more efficient, in those cases, to extract a list of values and then pass that into the second query. That is, execute two queries instead of one:</p> <pre data-language="python">values = Blog.objects.filter(name__contains="Cheddar").values_list("pk", flat=True)
entries = Entry.objects.filter(blog__in=list(values))
</pre> <p>Note the <code>list()</code> call around the Blog <code>QuerySet</code> to force execution of the first query. Without it, a nested query would be executed, because <a class="reference internal" href="../../topics/db/queries.html#querysets-are-lazy"><span class="std std-ref">QuerySets are lazy</span></a>.</p> </div> </section> <section id="s-gt"> <h4 id="std-fieldlookup-gt"><code>gt</code></h4> <p>Greater than.</p> <p>Example:</p> <pre data-language="python">Entry.objects.filter(id__gt=4)
</pre> <p>SQL equivalent:</p> <pre data-language="sql">SELECT ... WHERE id &gt; 4;
</pre> </section> <section id="s-gte"> <h4 id="std-fieldlookup-gte"><code>gte</code></h4> <p>Greater than or equal to.</p> </section> <section id="s-lt"> <h4 id="std-fieldlookup-lt"><code>lt</code></h4> <p>Less than.</p> </section> <section id="s-lte"> <h4 id="std-fieldlookup-lte"><code>lte</code></h4> <p>Less than or equal to.</p> </section> <section id="s-startswith"> <h4 id="std-fieldlookup-startswith"><code>startswith</code></h4> <p>Case-sensitive starts-with.</p> <p>Example:</p> <pre data-language="python">Entry.objects.filter(headline__startswith="Lennon")
</pre> <p>SQL equivalent:</p> <pre data-language="sql">SELECT ... WHERE headline LIKE 'Lennon%';
</pre> <p>SQLite doesn’t support case-sensitive <code>LIKE</code> statements; <code>startswith</code> acts like <code>istartswith</code> for SQLite.</p> </section> <section id="s-istartswith"> <h4 id="std-fieldlookup-istartswith"><code>istartswith</code></h4> <p>Case-insensitive starts-with.</p> <p>Example:</p> <pre data-language="python">Entry.objects.filter(headline__istartswith="Lennon")
</pre> <p>SQL equivalent:</p> <pre data-language="sql">SELECT ... WHERE headline ILIKE 'Lennon%';
</pre> <div class="admonition-sqlite-users admonition"> <p class="admonition-title">SQLite users</p> <p>When using the SQLite backend and non-ASCII strings, bear in mind the <a class="reference internal" href="../databases.html#sqlite-string-matching"><span class="std std-ref">database note</span></a> about string comparisons.</p> </div> </section> <section id="s-endswith"> <h4 id="std-fieldlookup-endswith"><code>endswith</code></h4> <p>Case-sensitive ends-with.</p> <p>Example:</p> <pre data-language="python">Entry.objects.filter(headline__endswith="Lennon")
</pre> <p>SQL equivalent:</p> <pre data-language="sql">SELECT ... WHERE headline LIKE '%Lennon';
</pre> <div class="admonition-sqlite-users admonition"> <p class="admonition-title">SQLite users</p> <p>SQLite doesn’t support case-sensitive <code>LIKE</code> statements; <code>endswith</code> acts like <code>iendswith</code> for SQLite. Refer to the <a class="reference internal" href="../databases.html#sqlite-string-matching"><span class="std std-ref">database note</span></a> documentation for more.</p> </div> </section> <section id="s-iendswith"> <h4 id="std-fieldlookup-iendswith"><code>iendswith</code></h4> <p>Case-insensitive ends-with.</p> <p>Example:</p> <pre data-language="python">Entry.objects.filter(headline__iendswith="Lennon")
</pre> <p>SQL equivalent:</p> <pre data-language="sql">SELECT ... WHERE headline ILIKE '%Lennon'
</pre> <div class="admonition-sqlite-users admonition"> <p class="admonition-title">SQLite users</p> <p>When using the SQLite backend and non-ASCII strings, bear in mind the <a class="reference internal" href="../databases.html#sqlite-string-matching"><span class="std std-ref">database note</span></a> about string comparisons.</p> </div> </section> <section id="s-range"> <h4 id="std-fieldlookup-range"><code>range</code></h4> <p>Range test (inclusive).</p> <p>Example:</p> <pre data-language="python">import datetime

start_date = datetime.date(2005, 1, 1)
end_date = datetime.date(2005, 3, 31)
Entry.objects.filter(pub_date__range=(start_date, end_date))
</pre> <p>SQL equivalent:</p> <pre data-language="sql">SELECT ... WHERE pub_date BETWEEN '2005-01-01' and '2005-03-31';
</pre> <p>You can use <code>range</code> anywhere you can use <code>BETWEEN</code> in SQL — for dates, numbers and even characters.</p> <div class="admonition warning"> <p class="admonition-title">Warning</p> <p>Filtering a <code>DateTimeField</code> with dates won’t include items on the last day, because the bounds are interpreted as “0am on the given date”. If <code>pub_date</code> was a <code>DateTimeField</code>, the above expression would be turned into this SQL:</p> <pre data-language="sql">SELECT ... WHERE pub_date BETWEEN '2005-01-01 00:00:00' and '2005-03-31 00:00:00';
</pre> <p>Generally speaking, you can’t mix dates and datetimes.</p> </div> </section> <section id="s-date"> <h4 id="std-fieldlookup-date"><code>date</code></h4> <p>For datetime fields, casts the value as date. Allows chaining additional field lookups. Takes a date value.</p> <p>Example:</p> <pre data-language="python">Entry.objects.filter(pub_date__date=datetime.date(2005, 1, 1))
Entry.objects.filter(pub_date__date__gt=datetime.date(2005, 1, 1))
</pre> <p>(No equivalent SQL code fragment is included for this lookup because implementation of the relevant query varies among different database engines.)</p> <p>When <a class="reference internal" href="../settings.html#std-setting-USE_TZ"><code>USE_TZ</code></a> is <code>True</code>, fields are converted to the current time zone before filtering. This requires <a class="reference internal" href="#database-time-zone-definitions"><span class="std std-ref">time zone definitions in the database</span></a>.</p> </section> <section id="s-year"> <h4 id="std-fieldlookup-year"><code>year</code></h4> <p>For date and datetime fields, an exact year match. Allows chaining additional field lookups. Takes an integer year.</p> <p>Example:</p> <pre data-language="python">Entry.objects.filter(pub_date__year=2005)
Entry.objects.filter(pub_date__year__gte=2005)
</pre> <p>SQL equivalent:</p> <pre data-language="sql">SELECT ... WHERE pub_date BETWEEN '2005-01-01' AND '2005-12-31';
SELECT ... WHERE pub_date &gt;= '2005-01-01';
</pre> <p>(The exact SQL syntax varies for each database engine.)</p> <p>When <a class="reference internal" href="../settings.html#std-setting-USE_TZ"><code>USE_TZ</code></a> is <code>True</code>, datetime fields are converted to the current time zone before filtering. This requires <a class="reference internal" href="#database-time-zone-definitions"><span class="std std-ref">time zone definitions in the database</span></a>.</p> </section> <section id="s-iso-year"> <h4 id="std-fieldlookup-iso_year"><code>iso_year</code></h4> <p>For date and datetime fields, an exact ISO 8601 week-numbering year match. Allows chaining additional field lookups. Takes an integer year.</p> <p>Example:</p> <pre data-language="python">Entry.objects.filter(pub_date__iso_year=2005)
Entry.objects.filter(pub_date__iso_year__gte=2005)
</pre> <p>(The exact SQL syntax varies for each database engine.)</p> <p>When <a class="reference internal" href="../settings.html#std-setting-USE_TZ"><code>USE_TZ</code></a> is <code>True</code>, datetime fields are converted to the current time zone before filtering. This requires <a class="reference internal" href="#database-time-zone-definitions"><span class="std std-ref">time zone definitions in the database</span></a>.</p> </section> <section id="s-month"> <h4 id="std-fieldlookup-month"><code>month</code></h4> <p>For date and datetime fields, an exact month match. Allows chaining additional field lookups. Takes an integer 1 (January) through 12 (December).</p> <p>Example:</p> <pre data-language="python">Entry.objects.filter(pub_date__month=12)
Entry.objects.filter(pub_date__month__gte=6)
</pre> <p>SQL equivalent:</p> <pre data-language="sql">SELECT ... WHERE EXTRACT('month' FROM pub_date) = '12';
SELECT ... WHERE EXTRACT('month' FROM pub_date) &gt;= '6';
</pre> <p>(The exact SQL syntax varies for each database engine.)</p> <p>When <a class="reference internal" href="../settings.html#std-setting-USE_TZ"><code>USE_TZ</code></a> is <code>True</code>, datetime fields are converted to the current time zone before filtering. This requires <a class="reference internal" href="#database-time-zone-definitions"><span class="std std-ref">time zone definitions in the database</span></a>.</p> </section> <section id="s-day"> <h4 id="std-fieldlookup-day"><code>day</code></h4> <p>For date and datetime fields, an exact day match. Allows chaining additional field lookups. Takes an integer day.</p> <p>Example:</p> <pre data-language="python">Entry.objects.filter(pub_date__day=3)
Entry.objects.filter(pub_date__day__gte=3)
</pre> <p>SQL equivalent:</p> <pre data-language="sql">SELECT ... WHERE EXTRACT('day' FROM pub_date) = '3';
SELECT ... WHERE EXTRACT('day' FROM pub_date) &gt;= '3';
</pre> <p>(The exact SQL syntax varies for each database engine.)</p> <p>Note this will match any record with a pub_date on the third day of the month, such as January 3, July 3, etc.</p> <p>When <a class="reference internal" href="../settings.html#std-setting-USE_TZ"><code>USE_TZ</code></a> is <code>True</code>, datetime fields are converted to the current time zone before filtering. This requires <a class="reference internal" href="#database-time-zone-definitions"><span class="std std-ref">time zone definitions in the database</span></a>.</p> </section> <section id="s-week"> <h4 id="std-fieldlookup-week"><code>week</code></h4> <p>For date and datetime fields, return the week number (1-52 or 53) according to <a class="reference external" href="https://en.wikipedia.org/wiki/ISO-8601">ISO-8601</a>, i.e., weeks start on a Monday and the first week contains the year’s first Thursday.</p> <p>Example:</p> <pre data-language="python">Entry.objects.filter(pub_date__week=52)
Entry.objects.filter(pub_date__week__gte=32, pub_date__week__lte=38)
</pre> <p>(No equivalent SQL code fragment is included for this lookup because implementation of the relevant query varies among different database engines.)</p> <p>When <a class="reference internal" href="../settings.html#std-setting-USE_TZ"><code>USE_TZ</code></a> is <code>True</code>, datetime fields are converted to the current time zone before filtering. This requires <a class="reference internal" href="#database-time-zone-definitions"><span class="std std-ref">time zone definitions in the database</span></a>.</p> </section> <section id="s-week-day"> <h4 id="std-fieldlookup-week_day"><code>week_day</code></h4> <p>For date and datetime fields, a ‘day of the week’ match. Allows chaining additional field lookups.</p> <p>Takes an integer value representing the day of week from 1 (Sunday) to 7 (Saturday).</p> <p>Example:</p> <pre data-language="python">Entry.objects.filter(pub_date__week_day=2)
Entry.objects.filter(pub_date__week_day__gte=2)
</pre> <p>(No equivalent SQL code fragment is included for this lookup because implementation of the relevant query varies among different database engines.)</p> <p>Note this will match any record with a <code>pub_date</code> that falls on a Monday (day 2 of the week), regardless of the month or year in which it occurs. Week days are indexed with day 1 being Sunday and day 7 being Saturday.</p> <p>When <a class="reference internal" href="../settings.html#std-setting-USE_TZ"><code>USE_TZ</code></a> is <code>True</code>, datetime fields are converted to the current time zone before filtering. This requires <a class="reference internal" href="#database-time-zone-definitions"><span class="std std-ref">time zone definitions in the database</span></a>.</p> </section> <section id="s-iso-week-day"> <h4 id="std-fieldlookup-iso_week_day"><code>iso_week_day</code></h4> <p>For date and datetime fields, an exact ISO 8601 day of the week match. Allows chaining additional field lookups.</p> <p>Takes an integer value representing the day of the week from 1 (Monday) to 7 (Sunday).</p> <p>Example:</p> <pre data-language="python">Entry.objects.filter(pub_date__iso_week_day=1)
Entry.objects.filter(pub_date__iso_week_day__gte=1)
</pre> <p>(No equivalent SQL code fragment is included for this lookup because implementation of the relevant query varies among different database engines.)</p> <p>Note this will match any record with a <code>pub_date</code> that falls on a Monday (day 1 of the week), regardless of the month or year in which it occurs. Week days are indexed with day 1 being Monday and day 7 being Sunday.</p> <p>When <a class="reference internal" href="../settings.html#std-setting-USE_TZ"><code>USE_TZ</code></a> is <code>True</code>, datetime fields are converted to the current time zone before filtering. This requires <a class="reference internal" href="#database-time-zone-definitions"><span class="std std-ref">time zone definitions in the database</span></a>.</p> </section> <section id="s-quarter"> <h4 id="std-fieldlookup-quarter"><code>quarter</code></h4> <p>For date and datetime fields, a ‘quarter of the year’ match. Allows chaining additional field lookups. Takes an integer value between 1 and 4 representing the quarter of the year.</p> <p>Example to retrieve entries in the second quarter (April 1 to June 30):</p> <pre data-language="python">Entry.objects.filter(pub_date__quarter=2)
</pre> <p>(No equivalent SQL code fragment is included for this lookup because implementation of the relevant query varies among different database engines.)</p> <p>When <a class="reference internal" href="../settings.html#std-setting-USE_TZ"><code>USE_TZ</code></a> is <code>True</code>, datetime fields are converted to the current time zone before filtering. This requires <a class="reference internal" href="#database-time-zone-definitions"><span class="std std-ref">time zone definitions in the database</span></a>.</p> </section> <section id="s-time"> <h4 id="std-fieldlookup-time"><code>time</code></h4> <p>For datetime fields, casts the value as time. Allows chaining additional field lookups. Takes a <a class="reference external" href="https://docs.python.org/3/library/datetime.html#datetime.time" title="(in Python v3.13)"><code>datetime.time</code></a> value.</p> <p>Example:</p> <pre data-language="python">Entry.objects.filter(pub_date__time=datetime.time(14, 30))
Entry.objects.filter(pub_date__time__range=(datetime.time(8), datetime.time(17)))
</pre> <p>(No equivalent SQL code fragment is included for this lookup because implementation of the relevant query varies among different database engines.)</p> <p>When <a class="reference internal" href="../settings.html#std-setting-USE_TZ"><code>USE_TZ</code></a> is <code>True</code>, fields are converted to the current time zone before filtering. This requires <a class="reference internal" href="#database-time-zone-definitions"><span class="std std-ref">time zone definitions in the database</span></a>.</p> </section> <section id="s-hour"> <h4 id="std-fieldlookup-hour"><code>hour</code></h4> <p>For datetime and time fields, an exact hour match. Allows chaining additional field lookups. Takes an integer between 0 and 23.</p> <p>Example:</p> <pre data-language="python">Event.objects.filter(timestamp__hour=23)
Event.objects.filter(time__hour=5)
Event.objects.filter(timestamp__hour__gte=12)
</pre> <p>SQL equivalent:</p> <pre data-language="sql">SELECT ... WHERE EXTRACT('hour' FROM timestamp) = '23';
SELECT ... WHERE EXTRACT('hour' FROM time) = '5';
SELECT ... WHERE EXTRACT('hour' FROM timestamp) &gt;= '12';
</pre> <p>(The exact SQL syntax varies for each database engine.)</p> <p>When <a class="reference internal" href="../settings.html#std-setting-USE_TZ"><code>USE_TZ</code></a> is <code>True</code>, datetime fields are converted to the current time zone before filtering. This requires <a class="reference internal" href="#database-time-zone-definitions"><span class="std std-ref">time zone definitions in the database</span></a>.</p> </section> <section id="s-minute"> <h4 id="std-fieldlookup-minute"><code>minute</code></h4> <p>For datetime and time fields, an exact minute match. Allows chaining additional field lookups. Takes an integer between 0 and 59.</p> <p>Example:</p> <pre data-language="python">Event.objects.filter(timestamp__minute=29)
Event.objects.filter(time__minute=46)
Event.objects.filter(timestamp__minute__gte=29)
</pre> <p>SQL equivalent:</p> <pre data-language="sql">SELECT ... WHERE EXTRACT('minute' FROM timestamp) = '29';
SELECT ... WHERE EXTRACT('minute' FROM time) = '46';
SELECT ... WHERE EXTRACT('minute' FROM timestamp) &gt;= '29';
</pre> <p>(The exact SQL syntax varies for each database engine.)</p> <p>When <a class="reference internal" href="../settings.html#std-setting-USE_TZ"><code>USE_TZ</code></a> is <code>True</code>, datetime fields are converted to the current time zone before filtering. This requires <a class="reference internal" href="#database-time-zone-definitions"><span class="std std-ref">time zone definitions in the database</span></a>.</p> </section> <section id="s-second"> <h4 id="std-fieldlookup-second"><code>second</code></h4> <p>For datetime and time fields, an exact second match. Allows chaining additional field lookups. Takes an integer between 0 and 59.</p> <p>Example:</p> <pre data-language="python">Event.objects.filter(timestamp__second=31)
Event.objects.filter(time__second=2)
Event.objects.filter(timestamp__second__gte=31)
</pre> <p>SQL equivalent:</p> <pre data-language="sql">SELECT ... WHERE EXTRACT('second' FROM timestamp) = '31';
SELECT ... WHERE EXTRACT('second' FROM time) = '2';
SELECT ... WHERE EXTRACT('second' FROM timestamp) &gt;= '31';
</pre> <p>(The exact SQL syntax varies for each database engine.)</p> <p>When <a class="reference internal" href="../settings.html#std-setting-USE_TZ"><code>USE_TZ</code></a> is <code>True</code>, datetime fields are converted to the current time zone before filtering. This requires <a class="reference internal" href="#database-time-zone-definitions"><span class="std std-ref">time zone definitions in the database</span></a>.</p> </section> <section id="s-isnull"> <h4 id="std-fieldlookup-isnull"><code>isnull</code></h4> <p>Takes either <code>True</code> or <code>False</code>, which correspond to SQL queries of <code>IS NULL</code> and <code>IS NOT NULL</code>, respectively.</p> <p>Example:</p> <pre data-language="python">Entry.objects.filter(pub_date__isnull=True)
</pre> <p>SQL equivalent:</p> <pre data-language="sql">SELECT ... WHERE pub_date IS NULL;
</pre> </section> <section id="s-regex"> <h4 id="std-fieldlookup-regex"><code>regex</code></h4> <p>Case-sensitive regular expression match.</p> <p>The regular expression syntax is that of the database backend in use. In the case of SQLite, which has no built in regular expression support, this feature is provided by a (Python) user-defined REGEXP function, and the regular expression syntax is therefore that of Python’s <code>re</code> module.</p> <p>Example:</p> <pre data-language="python">Entry.objects.get(title__regex=r"^(An?|The) +")
</pre> <p>SQL equivalents:</p> <pre data-language="sql">SELECT ... WHERE title REGEXP BINARY '^(An?|The) +'; -- MySQL

SELECT ... WHERE REGEXP_LIKE(title, '^(An?|The) +', 'c'); -- Oracle

SELECT ... WHERE title ~ '^(An?|The) +'; -- PostgreSQL

SELECT ... WHERE title REGEXP '^(An?|The) +'; -- SQLite
</pre> <p>Using raw strings (e.g., <code>r'foo'</code> instead of <code>'foo'</code>) for passing in the regular expression syntax is recommended.</p> </section> <section id="s-iregex"> <h4 id="std-fieldlookup-iregex"><code>iregex</code></h4> <p>Case-insensitive regular expression match.</p> <p>Example:</p> <pre data-language="python">Entry.objects.get(title__iregex=r"^(an?|the) +")
</pre> <p>SQL equivalents:</p> <pre data-language="sql">SELECT ... WHERE title REGEXP '^(an?|the) +'; -- MySQL

SELECT ... WHERE REGEXP_LIKE(title, '^(an?|the) +', 'i'); -- Oracle

SELECT ... WHERE title ~* '^(an?|the) +'; -- PostgreSQL

SELECT ... WHERE title REGEXP '(?i)^(an?|the) +'; -- SQLite
</pre> </section> </section> <section id="s-aggregation-functions"> <h3 id="id6">Aggregation functions</h3> <p>Django provides the following aggregation functions in the <code>django.db.models</code> module. For details on how to use these aggregate functions, see <a class="reference internal" href="../../topics/db/aggregation.html"><span class="doc">the topic guide on aggregation</span></a>. See the <a class="reference internal" href="expressions.html#django.db.models.Aggregate" title="django.db.models.Aggregate"><code>Aggregate</code></a> documentation to learn how to create your aggregates.</p> <div class="admonition warning"> <p class="admonition-title">Warning</p> <p>SQLite can’t handle aggregation on date/time fields out of the box. This is because there are no native date/time fields in SQLite and Django currently emulates these features using a text field. Attempts to use aggregation on date/time fields in SQLite will raise <code>NotSupportedError</code>.</p> </div> <div class="admonition-empty-querysets-or-groups admonition"> <p class="admonition-title">Empty querysets or groups</p> <p>Aggregation functions return <code>None</code> when used with an empty <code>QuerySet</code> or group. For example, the <code>Sum</code> aggregation function returns <code>None</code> instead of <code>0</code> if the <code>QuerySet</code> contains no entries or for any empty group in a non-empty <code>QuerySet</code>. To return another value instead, define the <code>default</code> argument. <code>Count</code> is an exception to this behavior; it returns <code>0</code> if the <code>QuerySet</code> is empty since <code>Count</code> does not support the <code>default</code> argument.</p> </div> <p>All aggregates have the following parameters in common:</p> <section id="s-expressions"> <h4 id="expressions"><code>expressions</code></h4> <p>Strings that reference fields on the model, transforms of the field, or <a class="reference internal" href="expressions.html"><span class="doc">query expressions</span></a>.</p> </section> <section id="s-output-field"> <h4 id="output-field"><code>output_field</code></h4> <p>An optional argument that represents the <a class="reference internal" href="fields.html"><span class="doc">model field</span></a> of the return value</p> <div class="admonition note"> <p class="admonition-title">Note</p> <p>When combining multiple field types, Django can only determine the <code>output_field</code> if all fields are of the same type. Otherwise, you must provide the <code>output_field</code> yourself.</p> </div> </section> <section id="s-aggregate-filter"> <h4 id="id7"><code>filter</code></h4> <p>An optional <a class="reference internal" href="#django.db.models.Q" title="django.db.models.Q"><code>Q object</code></a> that’s used to filter the rows that are aggregated.</p> <p>See <a class="reference internal" href="conditional-expressions.html#conditional-aggregation"><span class="std std-ref">Conditional aggregation</span></a> and <a class="reference internal" href="../../topics/db/aggregation.html#filtering-on-annotations"><span class="std std-ref">Filtering on annotations</span></a> for example usage.</p> </section> <section id="s-default"> <h4 id="aggregate-default"><code>default</code></h4> <p>An optional argument that allows specifying a value to use as a default value when the queryset (or grouping) contains no entries.</p> </section> <section id="s-id8"> <h4 id="id8"><code>**extra</code></h4> <p>Keyword arguments that can provide extra context for the SQL generated by the aggregate.</p> </section> <section id="s-avg"> <h4 id="avg"><code>Avg</code></h4> <dl class="py class"> <dt class="sig sig-object py" id="django.db.models.Avg">
<code>class Avg(expression, output_field=None, distinct=False, filter=None, default=None, **extra)</code> <a class="reference external" href="https://github.com/django/django/blob/stable/5.2.x/django/db/models/aggregates.py#L157"><span class="viewcode-link">[source]</span></a>
</dt> <dd>
<p>Returns the mean value of the given expression, which must be numeric unless you specify a different <code>output_field</code>.</p> <ul class="simple"> <li>Default alias: <code>&lt;field&gt;__avg</code>
</li> <li>Return type: <code>float</code> if input is <code>int</code>, otherwise same as input field, or <code>output_field</code> if supplied. If the queryset or grouping is empty, <code>default</code> is returned.</li> </ul> <dl class="py attribute"> <dt class="sig sig-object py" id="django.db.models.Avg.distinct">
<code>distinct</code> </dt> <dd>
<p>Optional. If <code>distinct=True</code>, <code>Avg</code> returns the mean value of unique values. This is the SQL equivalent of <code>AVG(DISTINCT &lt;field&gt;)</code>. The default value is <code>False</code>.</p> </dd>
</dl> </dd>
</dl> </section> <section id="s-id9"> <h4 id="id9"><code>Count</code></h4> <dl class="py class"> <dt class="sig sig-object py" id="django.db.models.Count">
<code>class Count(expression, distinct=False, filter=None, **extra)</code> <a class="reference external" href="https://github.com/django/django/blob/stable/5.2.x/django/db/models/aggregates.py#L164"><span class="viewcode-link">[source]</span></a>
</dt> <dd>
<p>Returns the number of objects that are related through the provided expression. <code>Count('*')</code> is equivalent to the SQL <code>COUNT(*)</code> expression.</p> <ul class="simple"> <li>Default alias: <code>&lt;field&gt;__count</code>
</li> <li>Return type: <code>int</code>
</li> </ul> <dl class="py attribute"> <dt class="sig sig-object py" id="django.db.models.Count.distinct">
<code>distinct</code> </dt> <dd>
<p>Optional. If <code>distinct=True</code>, the count will only include unique instances. This is the SQL equivalent of <code>COUNT(DISTINCT &lt;field&gt;)</code>. The default value is <code>False</code>.</p> </dd>
</dl> <div class="admonition note"> <p class="admonition-title">Note</p> <p>The <code>default</code> argument is not supported.</p> </div> </dd>
</dl> </section> <section id="s-max"> <h4 id="max"><code>Max</code></h4> <dl class="py class"> <dt class="sig sig-object py" id="django.db.models.Max">
<code>class Max(expression, output_field=None, filter=None, default=None, **extra)</code> <a class="reference external" href="https://github.com/django/django/blob/stable/5.2.x/django/db/models/aggregates.py#L197"><span class="viewcode-link">[source]</span></a>
</dt> <dd>
<p>Returns the maximum value of the given expression.</p> <ul class="simple"> <li>Default alias: <code>&lt;field&gt;__max</code>
</li> <li>Return type: same as input field, or <code>output_field</code> if supplied. If the queryset or grouping is empty, <code>default</code> is returned.</li> </ul> </dd>
</dl> </section> <section id="s-min"> <h4 id="min"><code>Min</code></h4> <dl class="py class"> <dt class="sig sig-object py" id="django.db.models.Min">
<code>class Min(expression, output_field=None, filter=None, default=None, **extra)</code> <a class="reference external" href="https://github.com/django/django/blob/stable/5.2.x/django/db/models/aggregates.py#L203"><span class="viewcode-link">[source]</span></a>
</dt> <dd>
<p>Returns the minimum value of the given expression.</p> <ul class="simple"> <li>Default alias: <code>&lt;field&gt;__min</code>
</li> <li>Return type: same as input field, or <code>output_field</code> if supplied. If the queryset or grouping is empty, <code>default</code> is returned.</li> </ul> </dd>
</dl> </section> <section id="s-stddev"> <h4 id="stddev"><code>StdDev</code></h4> <dl class="py class"> <dt class="sig sig-object py" id="django.db.models.StdDev">
<code>class StdDev(expression, output_field=None, sample=False, filter=None, default=None, **extra)</code> <a class="reference external" href="https://github.com/django/django/blob/stable/5.2.x/django/db/models/aggregates.py#L209"><span class="viewcode-link">[source]</span></a>
</dt> <dd>
<p>Returns the standard deviation of the data in the provided expression.</p> <ul class="simple"> <li>Default alias: <code>&lt;field&gt;__stddev</code>
</li> <li>Return type: <code>float</code> if input is <code>int</code>, otherwise same as input field, or <code>output_field</code> if supplied. If the queryset or grouping is empty, <code>default</code> is returned.</li> </ul> <dl class="py attribute"> <dt class="sig sig-object py" id="django.db.models.StdDev.sample">
<code>sample</code> </dt> <dd>
<p>Optional. By default, <code>StdDev</code> returns the population standard deviation. However, if <code>sample=True</code>, the return value will be the sample standard deviation.</p> </dd>
</dl> </dd>
</dl> </section> <section id="s-sum"> <h4 id="sum"><code>Sum</code></h4> <dl class="py class"> <dt class="sig sig-object py" id="django.db.models.Sum">
<code>class Sum(expression, output_field=None, distinct=False, filter=None, default=None, **extra)</code> <a class="reference external" href="https://github.com/django/django/blob/stable/5.2.x/django/db/models/aggregates.py#L221"><span class="viewcode-link">[source]</span></a>
</dt> <dd>
<p>Computes the sum of all values of the given expression.</p> <ul class="simple"> <li>Default alias: <code>&lt;field&gt;__sum</code>
</li> <li>Return type: same as input field, or <code>output_field</code> if supplied. If the queryset or grouping is empty, <code>default</code> is returned.</li> </ul> <dl class="py attribute"> <dt class="sig sig-object py" id="django.db.models.Sum.distinct">
<code>distinct</code> </dt> <dd>
<p>Optional. If <code>distinct=True</code>, <code>Sum</code> returns the sum of unique values. This is the SQL equivalent of <code>SUM(DISTINCT &lt;field&gt;)</code>. The default value is <code>False</code>.</p> </dd>
</dl> </dd>
</dl> </section> <section id="s-variance"> <h4 id="variance"><code>Variance</code></h4> <dl class="py class"> <dt class="sig sig-object py" id="django.db.models.Variance">
<code>class Variance(expression, output_field=None, sample=False, filter=None, default=None, **extra)</code> <a class="reference external" href="https://github.com/django/django/blob/stable/5.2.x/django/db/models/aggregates.py#L228"><span class="viewcode-link">[source]</span></a>
</dt> <dd>
<p>Returns the variance of the data in the provided expression.</p> <ul class="simple"> <li>Default alias: <code>&lt;field&gt;__variance</code>
</li> <li>Return type: <code>float</code> if input is <code>int</code>, otherwise same as input field, or <code>output_field</code> if supplied. If the queryset or grouping is empty, <code>default</code> is returned.</li> </ul> <dl class="py attribute"> <dt class="sig sig-object py" id="django.db.models.Variance.sample">
<code>sample</code> </dt> <dd>
<p>Optional. By default, <code>Variance</code> returns the population variance. However, if <code>sample=True</code>, the return value will be the sample variance.</p> </dd>
</dl> </dd>
</dl> </section> </section> </section> <section id="s-query-related-tools"> <h2 id="query-related-tools">Query-related tools</h2> <p>This section provides reference material for query-related tools not documented elsewhere.</p> <section id="s-q-objects"> <h3 id="q-objects">
<code>Q()</code> objects</h3> <dl class="py class"> <dt class="sig sig-object py" id="django.db.models.Q">
<code>class Q</code> <a class="reference external" href="https://github.com/django/django/blob/stable/5.2.x/django/db/models/query_utils.py#L39"><span class="viewcode-link">[source]</span></a>
</dt> 
</dl> <p>A <code>Q()</code> object represents an SQL condition that can be used in database-related operations. It’s similar to how an <a class="reference internal" href="expressions.html#django.db.models.F" title="django.db.models.F"><code>F()</code></a> object represents the value of a model field or annotation. They make it possible to define and reuse conditions. These can be negated using the <code>~</code> (<code>NOT</code>) operator, and combined using operators such as <code>|</code> (<code>OR</code>), <code>&amp;</code> (<code>AND</code>), and <code>^</code> (<code>XOR</code>). See <a class="reference internal" href="../../topics/db/queries.html#complex-lookups-with-q"><span class="std std-ref">Complex lookups with Q objects</span></a>.</p> </section> <section id="s-prefetch-objects"> <h3 id="prefetch-objects">
<code>Prefetch()</code> objects</h3> <dl class="py class"> <dt class="sig sig-object py" id="django.db.models.Prefetch">
<code>class Prefetch(lookup, queryset=None, to_attr=None)</code> <a class="reference external" href="https://github.com/django/django/blob/stable/5.2.x/django/db/models/query.py#L2196"><span class="viewcode-link">[source]</span></a>
</dt> 
</dl> <p>The <code>Prefetch()</code> object can be used to control the operation of <a class="reference internal" href="#django.db.models.query.QuerySet.prefetch_related" title="django.db.models.query.QuerySet.prefetch_related"><code>prefetch_related()</code></a>.</p> <p>The <code>lookup</code> argument describes the relations to follow and works the same as the string based lookups passed to <a class="reference internal" href="#django.db.models.query.QuerySet.prefetch_related" title="django.db.models.query.QuerySet.prefetch_related"><code>prefetch_related()</code></a>. For example:</p> <pre data-language="pycon">&gt;&gt;&gt; from django.db.models import Prefetch
&gt;&gt;&gt; Question.objects.prefetch_related(Prefetch("choice_set")).get().choice_set.all()
&lt;QuerySet [&lt;Choice: Not much&gt;, &lt;Choice: The sky&gt;, &lt;Choice: Just hacking again&gt;]&gt;
# This will only execute two queries regardless of the number of Question
# and Choice objects.
&gt;&gt;&gt; Question.objects.prefetch_related(Prefetch("choice_set"))
&lt;QuerySet [&lt;Question: What's up?&gt;]&gt;
</pre> <p>The <code>queryset</code> argument supplies a base <code>QuerySet</code> for the given lookup. This is useful to further filter down the prefetch operation, or to call <a class="reference internal" href="#django.db.models.query.QuerySet.select_related" title="django.db.models.query.QuerySet.select_related"><code>select_related()</code></a> from the prefetched relation, hence reducing the number of queries even further:</p> <pre data-language="pycon">&gt;&gt;&gt; voted_choices = Choice.objects.filter(votes__gt=0)
&gt;&gt;&gt; voted_choices
&lt;QuerySet [&lt;Choice: The sky&gt;]&gt;
&gt;&gt;&gt; prefetch = Prefetch("choice_set", queryset=voted_choices)
&gt;&gt;&gt; Question.objects.prefetch_related(prefetch).get().choice_set.all()
&lt;QuerySet [&lt;Choice: The sky&gt;]&gt;
</pre> <p>The <code>to_attr</code> argument sets the result of the prefetch operation to a custom attribute:</p> <pre data-language="pycon">&gt;&gt;&gt; prefetch = Prefetch("choice_set", queryset=voted_choices, to_attr="voted_choices")
&gt;&gt;&gt; Question.objects.prefetch_related(prefetch).get().voted_choices
[&lt;Choice: The sky&gt;]
&gt;&gt;&gt; Question.objects.prefetch_related(prefetch).get().choice_set.all()
&lt;QuerySet [&lt;Choice: Not much&gt;, &lt;Choice: The sky&gt;, &lt;Choice: Just hacking again&gt;]&gt;
</pre> <div class="admonition note"> <p class="admonition-title">Note</p> <p>When using <code>to_attr</code> the prefetched result is stored in a list. This can provide a significant speed improvement over traditional <code>prefetch_related</code> calls which store the cached result within a <code>QuerySet</code> instance.</p> </div> </section> <section id="s-prefetch-related-objects"> <h3 id="prefetch-related-objects"><code>prefetch_related_objects()</code></h3> <dl class="py function"> <dt class="sig sig-object py" id="django.db.models.prefetch_related_objects">
<code>prefetch_related_objects(model_instances, *related_lookups)</code> <a class="reference external" href="https://github.com/django/django/blob/stable/5.2.x/django/db/models/query.py#L2282"><span class="viewcode-link">[source]</span></a>
</dt> 
</dl> <dl class="py function"> <dt class="sig sig-object py" id="django.db.models.aprefetch_related_objects">
<code>aprefetch_related_objects(model_instances, *related_lookups)</code> </dt> 
</dl> <p><em>Asynchronous version</em>: <code>aprefetch_related_objects()</code></p> <p>Prefetches the given lookups on an iterable of model instances. This is useful in code that receives a list of model instances as opposed to a <code>QuerySet</code>; for example, when fetching models from a cache or instantiating them manually.</p> <p>Pass an iterable of model instances (must all be of the same class) and the lookups or <a class="reference internal" href="#django.db.models.Prefetch" title="django.db.models.Prefetch"><code>Prefetch</code></a> objects you want to prefetch for. For example:</p> <pre data-language="pycon">&gt;&gt;&gt; from django.db.models import prefetch_related_objects
&gt;&gt;&gt; restaurants = fetch_top_restaurants_from_cache()  # A list of Restaurants
&gt;&gt;&gt; prefetch_related_objects(restaurants, "pizzas__toppings")
</pre> <p>When using multiple databases with <code>prefetch_related_objects</code>, the prefetch query will use the database associated with the model instance. This can be overridden by using a custom queryset in a related lookup.</p> </section> <section id="s-filteredrelation-objects"> <h3 id="filteredrelation-objects">
<code>FilteredRelation()</code> objects</h3> <dl class="py class"> <dt class="sig sig-object py" id="django.db.models.FilteredRelation">
<code>class FilteredRelation(relation_name, *, condition=Q())</code> <a class="reference external" href="https://github.com/django/django/blob/stable/5.2.x/django/db/models/query_utils.py#L444"><span class="viewcode-link">[source]</span></a>
</dt> <dd>
<dl class="py attribute"> <dt class="sig sig-object py" id="django.db.models.FilteredRelation.relation_name">
<code>relation_name</code> </dt> <dd>
<p>The name of the field on which you’d like to filter the relation.</p> </dd>
</dl> <dl class="py attribute"> <dt class="sig sig-object py" id="django.db.models.FilteredRelation.condition">
<code>condition</code> </dt> <dd>
<p>A <a class="reference internal" href="#django.db.models.Q" title="django.db.models.Q"><code>Q</code></a> object to control the filtering.</p> </dd>
</dl> </dd>
</dl> <p><code>FilteredRelation</code> is used with <a class="reference internal" href="#django.db.models.query.QuerySet.annotate" title="django.db.models.query.QuerySet.annotate"><code>annotate()</code></a> to create an <code>ON</code> clause when a <code>JOIN</code> is performed. It doesn’t act on the default relationship but on the annotation name (<code>pizzas_vegetarian</code> in example below).</p> <p>For example, to find restaurants that have vegetarian pizzas with <code>'mozzarella'</code> in the name:</p> <pre data-language="pycon">&gt;&gt;&gt; from django.db.models import FilteredRelation, Q
&gt;&gt;&gt; Restaurant.objects.annotate(
...     pizzas_vegetarian=FilteredRelation(
...         "pizzas",
...         condition=Q(pizzas__vegetarian=True),
...     ),
... ).filter(pizzas_vegetarian__name__icontains="mozzarella")
</pre> <p>If there are a large number of pizzas, this queryset performs better than:</p> <pre data-language="pycon">&gt;&gt;&gt; Restaurant.objects.filter(
...     pizzas__vegetarian=True,
...     pizzas__name__icontains="mozzarella",
... )
</pre> <p>because the filtering in the <code>WHERE</code> clause of the first queryset will only operate on vegetarian pizzas.</p> <p><code>FilteredRelation</code> doesn’t support:</p> <ul class="simple"> <li>
<a class="reference internal" href="#django.db.models.query.QuerySet.only" title="django.db.models.query.QuerySet.only"><code>QuerySet.only()</code></a> and <a class="reference internal" href="#django.db.models.query.QuerySet.prefetch_related" title="django.db.models.query.QuerySet.prefetch_related"><code>prefetch_related()</code></a>.</li> <li>A <a class="reference internal" href="../contrib/contenttypes.html#django.contrib.contenttypes.fields.GenericForeignKey" title="django.contrib.contenttypes.fields.GenericForeignKey"><code>GenericForeignKey</code></a> inherited from a parent model.</li> </ul> </section> </section> </section><div class="_attribution">
  <p class="_attribution-p">
    &copy; Django Software Foundation and individual contributors<br>Licensed under the BSD License.<br>
    <a href="https://docs.djangoproject.com/en/5.2/ref/models/querysets/" class="_attribution-link">https://docs.djangoproject.com/en/5.2/ref/models/querysets/</a>
  </p>
</div>
