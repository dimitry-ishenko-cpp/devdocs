<h1 data-toc="gradle-compilation-and-caches" id="gradle-compilation-and-caches.md">Compilation and caches in the Kotlin Gradle plugin</h1>
<p id="1ae8bbf5">On this page, you can learn about the following topics:</p>
<ul class="list _bullet" id="6d3a6e42">
<li class="list__item" id="494678cf"><p><a href="#incremental-compilation" id="131e3a09">Incremental compilation</a></p></li>
<li class="list__item" id="345397c"><p><a href="#gradle-build-cache-support" id="8c1cfcde">Gradle build cache support</a></p></li>
<li class="list__item" id="fbd762c1"><p><a href="#gradle-configuration-cache-support" id="97c2f182">Gradle configuration cache support</a></p></li>
<li class="list__item" id="6a943299"><p><a href="#the-kotlin-daemon-and-how-to-use-it-with-gradle" id="ffa017dc">The Kotlin daemon and how to use it with Gradle</a></p></li>
<li class="list__item" id="617f8ca4"><p><a href="#defining-kotlin-compiler-execution-strategy" id="d11163e7">Defining Kotlin compiler execution strategy</a></p></li>
<li class="list__item" id="fee53fcd"><p><a href="#kotlin-compiler-fallback-strategy" id="7d16262d">Kotlin compiler fallback strategy</a></p></li>
<li class="list__item" id="5dcd14b1"><p><a href="#build-reports" id="57c8babc">Build reports</a></p></li>
</ul>
<section class="chapter"><h2 id="incremental-compilation" data-toc="incremental-compilation">Incremental compilation</h2>
<p id="d5d09382">The Kotlin Gradle plugin supports incremental compilation. Incremental compilation tracks changes to source files between builds so that only the files affected by these changes are compiled.</p>
<p id="33efd9b9">Incremental compilation is supported for Kotlin/JVM and Kotlin/JS projects, and is enabled by default.</p>
<p id="f110417e">There are several ways to disable incremental compilation:</p>
<ul class="list _bullet" id="4b5a7d04">
<li class="list__item" id="489c693b"><p id="c7854083">Set <code class="code ">kotlin.incremental=false</code> for Kotlin/JVM.</p></li>
<li class="list__item" id="5d8dff0a"><p id="bfedb40b">Set <code class="code ">kotlin.incremental.js=false</code> for Kotlin/JS projects.</p></li>
<li class="list__item" id="f548b89b">
<p id="90848a5d">Use <code class="code ">-Pkotlin.incremental=false</code> or <code class="code ">-Pkotlin.incremental.js=false</code> as a command line parameter.</p>
<p id="65ba2b06">The parameter should be added to each subsequent build.</p>
</li>
</ul>
<p id="1c89821b">Note: Any build with incremental compilation disabled invalidates incremental caches. The first build is never incremental.</p>
<aside data-type="tip" class="prompt" data-title="" id="e97dbc86"><p id="7a4c70e0">Sometimes problems with incremental compilation become visible several rounds after the failure occurs. Use <a href="#build-reports" id="ee6aa14d">build reports</a> to track the history of changes and compilations. This can help you to provide reproducible bug reports.</p></aside><section class="chapter"><h3 id="a-new-approach-to-incremental-compilation" data-toc="a-new-approach-to-incremental-compilation">A new approach to incremental compilation</h3>
<p id="c80a0772">The new approach to incremental compilation is available since Kotlin 1.7.0 for the JVM backend in the Gradle build system only. Starting from Kotlin 1.8.20, this is enabled by default. This approach supports changes made inside dependent non-Kotlin modules, includes an improved compilation avoidance, and is compatible with the <a href="#gradle-build-cache-support" id="8d885db8">Gradle build cache</a>.</p>
<p id="39a9c8ad">All of these enhancements decrease the number of non-incremental builds, making the overall compilation time faster. You will receive the most benefit if you use the build cache, or, frequently make changes in non-Kotlin Gradle modules.</p>
<p id="ae2491af">To opt out from this new approach, set the following option in your <code class="code ">gradle.properties</code>:</p>
<pre class="code" data-language="none">kotlin.incremental.useClasspathSnapshot=false
</pre>
<p id="3245dcb6">We would appreciate your feedback on this feature in <a href="https://youtrack.jetbrains.com/issue/KT-49682" id="39fd677a" data-external="true" rel="noopener noreferrer">YouTrack</a>.</p>
<p id="27f3b2c9">Learn how the new approach to incremental compilation is implemented under the hood in <a href="https://blog.jetbrains.com/kotlin/2022/07/a-new-approach-to-incremental-compilation-in-kotlin/" id="69017af1" data-external="true" rel="noopener noreferrer">this blog post</a>.</p></section><section class="chapter"><h3 id="precise-backup-of-compilation-tasks-outputs" data-toc="precise-backup-of-compilation-tasks-outputs">Precise backup of compilation tasks' outputs</h3>
<aside data-type="warning" class="prompt" data-title="" id="3ce4192"><p id="b6ad3ae4">Precise backup of compilation tasks' outputs is <a href="components-stability.html#stability-levels-explained" id="b546ad9a">Experimental</a>. We would appreciate your feedback on it in <a href="https://kotl.in/issue/experimental-ic-optimizations" id="47a51458" data-external="true" rel="noopener noreferrer">YouTrack</a>.</p></aside><p id="6988cee8">Starting with Kotlin 1.8.20, you can enable precise backup, whereby only those classes that Kotlin recompiles in the incremental compilation are backed up. Both full and precise backups help to run builds incrementally again after compilation errors. A precise backup takes less build time compared to a full backup. A full backup may take <b id="3909b21a" class="">noticeably</b> more build time in large projects or if many tasks are creating backups, especially if a project is located on a slow HDD.</p>
<p id="4dd46a6b">Enable this optimization by adding the <code class="code ">kotlin.compiler.preciseCompilationResultsBackup</code> Gradle property to the <code class="code ">gradle.properties</code> file:</p>
<pre class="code" data-language="none">kotlin.compiler.preciseCompilationResultsBackup=true
</pre>
<section class="chapter" data-anchors="[23a98539,e4d4b5f2,eb17a193,59415235,f9d631bd,5a62dd06,16febe72,216f5300,e371778b,9c6ebd41,7ab23ec4,a70b6dd6,e0a34ff8,da258d73,example-of-using-precise-backup-at-jetbrains]"><div class="collapse">
<div class="collapse__title"><h4 id="example-of-using-precise-backup-at-jetbrains" data-toc="example-of-using-precise-backup-at-jetbrains">Example of using precise backup at JetBrains</h4></div>
<div class="collapse__content">
<p id="23a98539">In the following charts, you can see examples of using precise backup compared to full backup:</p>
<figure class=" " id="e4d4b5f2"><img alt="Comparison of full and precise backups" title="Comparison of full and precise backups" src="https://kotlinlang.org/docs/images/comparison-of-full-and-precise-backups.png" class=" " width="700" height="236"></figure><p id="eb17a193">The first and second charts show how using precise backup in a Kotlin project affects building the Kotlin Gradle plugin:</p>
<ol class="list _decimal" id="59415235" type="1">
<li class="list__item" id="f9d631bd"><p>After making a small <a href="https://en.wikipedia.org/wiki/Application_binary_interface" id="83b41866" data-external="true" rel="noopener noreferrer">ABI</a> change: adding a new public method to a module that lots of modules depend on.</p></li>
<li class="list__item" id="5a62dd06"><p>After making a small non-ABI change: adding a private function to a module that no other modules depend on.</p></li>
</ol>
<p id="16febe72">The third chart shows how precise backup in the <a href="https://www.jetbrains.com/space/" id="f7ac797" data-external="true" rel="noopener noreferrer">Space</a> project affects building a web frontend after a small non-ABI change: adding a private function to a Kotlin/JS module that lots of modules depend on.</p>
<p id="216f5300">These measurements were performed on a computer with an Apple M1 Max CPU; different computers will yield slightly different results. The factors affecting performance include but are not limited to:</p>
<ul class="list _bullet" id="e371778b">
<li class="list__item" id="9c6ebd41"><p>How warm the <a href="#the-kotlin-daemon-and-how-to-use-it-with-gradle" id="b5ffbf03">Kotlin daemon</a> and the <a href="https://docs.gradle.org/current/userguide/gradle_daemon.html" id="39bbaf49" data-external="true" rel="noopener noreferrer">Gradle daemon</a> are.</p></li>
<li class="list__item" id="7ab23ec4"><p>How fast or slow the disk is.</p></li>
<li class="list__item" id="a70b6dd6"><p>The CPU model and how busy it is.</p></li>
<li class="list__item" id="e0a34ff8"><p>Which modules are affected by the changes and how big these modules are.</p></li>
<li class="list__item" id="da258d73"><p>Whether the changes are ABI or non-ABI.</p></li>
</ul>
</div>
</div></section><section class="chapter" data-anchors="[6b095ad3,be5a2f0f,59778c58,evaluating-optimizations-with-build-reports]"><div class="collapse">
<div class="collapse__title"><h4 id="evaluating-optimizations-with-build-reports" data-toc="evaluating-optimizations-with-build-reports">Evaluating optimizations with build reports</h4></div>
<div class="collapse__content">
<p id="6b095ad3">To estimate the impact of the optimization on your computer for your project and your scenarios, you can use <a href="#build-reports" id="3a63cb15">Kotlin build reports</a>. Enable reports in text file format by adding the following property to your <code class="code ">gradle.properties</code> file:</p>
<p> <code class="code ">kotlin.build.report.output=file</code></p>
<p id="be5a2f0f">Here is an example of a relevant part of the report <b id="40a21033" class="">before</b> enabling precise backup:</p>
<p> <code class="code ">Task ':kotlin-gradle-plugin:compileCommonKotlin' finished in 0.59 s &lt;...&gt; Time metrics: Total Gradle task time: 0.59 s Task action before worker execution: 0.24 s Backup output: 0.22 s // Pay attention to this number &lt;...&gt;</code></p>
<p id="59778c58">And here is an example of a relevant part of the report <b id="a40211f5" class="">after</b> enabling precise backup:</p>
<p> <code class="code ">Task ':kotlin-gradle-plugin:compileCommonKotlin' finished in 0.46 s &lt;...&gt; Time metrics: Total Gradle task time: 0.46 s Task action before worker execution: 0.07 s Backup output: 0.05 s // The time has reduced Run compilation in Gradle worker: 0.32 s Clear jar cache: 0.00 s Precise backup output: 0.00 s // Related to precise backup Cleaning up the backup stash: 0.00 s // Related to precise backup &lt;...&gt;</code></p>
</div>
</div></section></section></section><section class="chapter"><h2 id="gradle-build-cache-support" data-toc="gradle-build-cache-support">Gradle build cache support</h2>
<p id="9cac1462">The Kotlin plugin uses the <a href="https://docs.gradle.org/current/userguide/build_cache.html" id="c9aae7a4" data-external="true" rel="noopener noreferrer">Gradle build cache</a>, which stores the build outputs for reuse in future builds.</p>
<p id="d332105c">To disable caching for all Kotlin tasks, set the system property <code class="code ">kotlin.caching.enabled</code> to <code class="code ">false</code> (run the build with the argument <code class="code ">-Dkotlin.caching.enabled=false</code>).</p></section><section class="chapter"><h2 id="gradle-configuration-cache-support" data-toc="gradle-configuration-cache-support">Gradle configuration cache support</h2>
<aside data-type="note" class="prompt" data-title="" id="1b452fec"><p id="4b6d3429">The Gradle configuration cache is supported only by the following Gradle plugins:</p>
<ul class="list _bullet" id="51b6c8a4">
<li class="list__item" id="bb4c5951"><p><code class="code ">org.jetbrains.kotlin.jvm</code></p></li>
<li class="list__item" id="66447fb6"><p><code class="code ">org.jetbrains.kotlin.js</code></p></li>
<li class="list__item" id="872207e9"><p><code class="code ">org.jetbrains.kotlin.android</code></p></li>
</ul></aside><p id="d048b7ed">The Kotlin plugin uses the <a href="https://docs.gradle.org/current/userguide/configuration_cache.html" id="34fdcfd7" data-external="true" rel="noopener noreferrer">Gradle configuration cache</a>, which speeds up the build process by reusing the results of the configuration phase.</p>
<p id="e5c8bd55">See the <a href="https://docs.gradle.org/current/userguide/configuration_cache.html#config_cache:usage" id="eb6510c7" data-external="true" rel="noopener noreferrer">Gradle documentation</a> to learn how to enable the configuration cache. After you enable this feature, the Kotlin Gradle plugin automatically starts using it.</p></section><section class="chapter"><h2 id="the-kotlin-daemon-and-how-to-use-it-with-gradle" data-toc="the-kotlin-daemon-and-how-to-use-it-with-gradle">The Kotlin daemon and how to use it with Gradle</h2>
<p id="390e1164">The Kotlin daemon:</p>
<ul class="list _bullet" id="fae49206">
<li class="list__item" id="231572f8"><p>Runs with the Gradle daemon to compile the project.</p></li>
<li class="list__item" id="1c755993"><p>Runs separately from the Gradle daemon when you compile the project with an IntelliJ IDEA built-in build system.</p></li>
</ul>
<p id="a0a65080">The Kotlin daemon starts at the Gradle <a href="https://docs.gradle.org/current/userguide/build_lifecycle.html#sec:build_phases" id="9dce8482" data-external="true" rel="noopener noreferrer">execution stage</a> when one of the Kotlin compile tasks starts to compile sources. The Kotlin daemon stops either with the Gradle daemon or after two idle hours with no Kotlin compilation.</p>
<p id="68532c53">The Kotlin daemon uses the same JDK that the Gradle daemon does.</p>
<section class="chapter"><h3 id="setting-kotlin-daemon-s-jvm-arguments" data-toc="setting-kotlin-daemon-s-jvm-arguments">Setting Kotlin daemon's JVM arguments</h3>
<p id="5404ed4f">Each of the following ways to set arguments overrides the ones that came before it:</p>
<ul class="list _bullet" id="4f0a501b">
<li class="list__item" id="4a51c274"><p><a href="#gradle-daemon-arguments-inheritance" id="234d983e">Gradle daemon arguments inheritance</a></p></li>
<li class="list__item" id="1d140800"><p><a href="#kotlin-daemon-jvm-options-system-property" id="cb42ce61"><code class="code ">kotlin.daemon.jvm.options</code> system property</a></p></li>
<li class="list__item" id="238e0275"><p><a href="#kotlin-daemon-jvmargs-property" id="518b2aaa"><code class="code ">kotlin.daemon.jvmargs</code> property</a></p></li>
<li class="list__item" id="65c3cdcf"><p><a href="#kotlin-extension" id="7b75956"><code class="code ">kotlin</code> extension</a></p></li>
<li class="list__item" id="b5c2c96d"><p><a href="#specific-task-definition" id="4597da38">Specific task definition</a></p></li>
</ul>
<section class="chapter"><h4 id="gradle-daemon-arguments-inheritance" data-toc="gradle-daemon-arguments-inheritance">Gradle daemon arguments inheritance</h4>
<p id="c0764be8">If nothing is specified, the Kotlin daemon inherits arguments from the Gradle daemon. For example, in the <code class="code ">gradle.properties</code> file:</p>
<pre class="code" data-language="none">org.gradle.jvmargs=-Xmx1500m -Xms=500m
</pre></section><section class="chapter"><h4 id="kotlin-daemon-jvm-options-system-property" data-toc="kotlin-daemon-jvm-options-system-property">kotlin.daemon.jvm.options system property</h4>
<p id="4fda1c7f">If the Gradle daemon's JVM arguments have the <code class="code ">kotlin.daemon.jvm.options</code> system property – use it in the <code class="code ">gradle.properties</code> file:</p>
<pre class="code" data-language="none">org.gradle.jvmargs=-Dkotlin.daemon.jvm.options=-Xmx1500m,Xms=500m
</pre>
<p id="fbf9e5b3">When passing arguments, follow these rules:</p>
<ul class="list _bullet" id="fba0415d">
<li class="list__item" id="d6783bea"><p>Use the minus sign <code class="code ">-</code> <b id="d453a040" class="">only</b> before the arguments <code class="code ">Xmx</code>, <code class="code ">XX:MaxMetaspaceSize</code>, and <code class="code ">XX:ReservedCodeCacheSize</code>.</p></li>
<li class="list__item" id="16330084"><p>Separate arguments with commas (<code class="code ">,</code>) <em id="ab3efad8" class="">without</em> spaces. Arguments that come after a space will be used for the Gradle daemon, not for the Kotlin daemon.</p></li>
</ul>
<aside data-type="warning" class="prompt" data-title="" id="b31f6350"><p id="476f2aa1">Gradle ignores these properties if all the following conditions are satisfied:</p>
<ul class="list _bullet" id="979d5694">
<li class="list__item" id="7f766623"><p>Gradle is using JDK 1.9 or higher.</p></li>
<li class="list__item" id="5dace9bb"><p>The version of Gradle is between 7.0 and 7.1.1 inclusively.</p></li>
<li class="list__item" id="2442e194"><p>Gradle is compiling Kotlin DSL scripts.</p></li>
<li class="list__item" id="6b704ca7"><p>The Kotlin daemon isn't running.</p></li>
</ul>
<p id="937765ac">To overcome this, upgrade Gradle to the version 7.2 (or higher) or use the <code class="code ">kotlin.daemon.jvmargs</code> property – see the following section.</p></aside></section><section class="chapter"><h4 id="kotlin-daemon-jvmargs-property" data-toc="kotlin-daemon-jvmargs-property">kotlin.daemon.jvmargs property</h4>
<p id="7901386">You can add the <code class="code ">kotlin.daemon.jvmargs</code> property in the <code class="code ">gradle.properties</code> file:</p>
<pre class="code" data-language="none">kotlin.daemon.jvmargs=-Xmx1500m -Xms=500m
</pre></section><section class="chapter"><h4 id="kotlin-extension" data-toc="kotlin-extension">kotlin extension</h4>
<p id="12df5762">You can specify arguments in the <code class="code ">kotlin</code> extension:</p>
<div class="tabs" id="8360162d" data-group="build-script" data-anchors="[e6ae9fa2,7612fa7,7a7deee8,f1385bd9,8360162d]">
<div class="tabs__content" data-gtm="tab" id="e6ae9fa2" data-sync-tabs="kotlin" data-title="Kotlin"><pre class="code" data-language="kotlin">kotlin {
    kotlinDaemonJvmArgs = listOf("-Xmx486m", "-Xms256m", "-XX:+UseParallelGC")
}
</pre></div>
<div class="tabs__content" data-gtm="tab" id="7a7deee8" data-sync-tabs="groovy" data-title="Groovy"><pre class="code" data-language="groovy">kotlin {
    kotlinDaemonJvmArgs = ["-Xmx486m", "-Xms256m", "-XX:+UseParallelGC"]
}
</pre></div>
</div></section><section class="chapter"><h4 id="specific-task-definition" data-toc="specific-task-definition">Specific task definition</h4>
<p id="3f4bbe43">You can specify arguments for a specific task:</p>
<div class="tabs" id="2f40267f" data-group="build-script" data-anchors="[7b9ccf2b,6fa25c55,87649bc9,73f0170f,2f40267f]">
<div class="tabs__content" data-gtm="tab" id="7b9ccf2b" data-sync-tabs="kotlin" data-title="Kotlin"><pre class="code" data-language="kotlin">tasks.withType&lt;CompileUsingKotlinDaemon&gt;().configureEach {
    kotlinDaemonJvmArguments.set(listOf("-Xmx486m", "-Xms256m", "-XX:+UseParallelGC"))
}
</pre></div>
<div class="tabs__content" data-gtm="tab" id="87649bc9" data-sync-tabs="groovy" data-title="Groovy"><pre class="code" data-language="groovy">tasks.withType(CompileUsingKotlinDaemon::class).configureEach { task -&gt;
    task.kotlinDaemonJvmArguments.set(["-Xmx1g", "-Xms512m"])
}
</pre></div>
</div>
<aside data-type="note" class="prompt" data-title="" id="fcacc285"><p id="e721f9a2">In this case a new Kotlin daemon instance can start on task execution. Learn more about <a href="#kotlin-daemon-s-behavior-with-jvm-arguments" id="3d2fca9d">Kotlin daemon's behavior with JVM arguments</a>.</p></aside></section></section><section class="chapter"><h3 id="kotlin-daemon-s-behavior-with-jvm-arguments" data-toc="kotlin-daemon-s-behavior-with-jvm-arguments">Kotlin daemon's behavior with JVM arguments</h3>
<p id="ec18380f">When configuring the Kotlin daemon's JVM arguments, note that:</p>
<ul class="list _bullet" id="659d7418">
<li class="list__item" id="435750d4"><p id="f63b4fda">It is expected to have multiple instances of the Kotlin daemon running at the same time when different subprojects or tasks have different sets of JVM arguments.</p></li>
<li class="list__item" id="bf7abb9d">
<p id="738f90a3">A new Kotlin daemon instance starts only when Gradle runs a related compilation task and existing Kotlin daemons do not have the same set of JVM arguments. Imagine that your project has a lot of subprojects. Most of them require some heap memory for a Kotlin daemon, but one module requires a lot (though it is rarely compiled). In this case, you should provide a different set of JVM arguments for such a module, so a Kotlin daemon with a larger heap size would start only for developers who touch this specific module.</p>
<aside data-type="note" class="prompt" data-title="" id="f8bd9004"><p id="9ad6f434">If you are already running a Kotlin daemon that has enough heap size to handle the compilation request, even if other requested JVM arguments are different, this daemon will be reused instead of starting a new one.</p></aside>
</li>
<li class="list__item" id="4216184e"><p id="6418dc02">If the <code class="code ">Xmx</code> argument is not specified, the Kotlin daemon will inherit it from the Gradle daemon.</p></li>
</ul></section></section><section class="chapter"><h2 id="the-new-kotlin-compiler" data-toc="the-new-kotlin-compiler">The new Kotlin compiler</h2>
<p id="af583f15">The new Kotlin K2 compiler is in <a href="components-stability.html#stability-levels-explained" id="f6e94f86">Alpha</a>. It has basic support for Kotlin JVM, JS, and Native projects.</p>
<p id="27759afb">The new compiler aims to speed up the development of new language features, unify all of the platforms Kotlin supports, bring performance improvements, and provide an API for compiler extensions.</p>
<p id="a319ba6c">The K2 compiler will become the default starting with Kotlin 2.0. To try it in your projects now and check the performance, use the <code class="code ">kotlin.experimental.tryK2=true</code> Gradle property or run the following command:</p>
<pre class="code" data-language="bash">./gradlew assemble -Pkotlin.experimental.tryK2=true
</pre>
<p id="55c05537">This Gradle property automatically sets the default language version to 2.0 and updates the <a href="#build-reports" id="3153b210">build report</a> with the number of Kotlin tasks compiled using the K2 compiler compared to the current compiler.</p>
<aside data-type="tip" class="prompt" data-title="" id="8def8a5a"><p id="4d2e7bd1">Build reports don't provide information about Kotlin/Native tasks yet. Despite that, we still recommend that you use Kotlin 2.0 as the default version.</p></aside><p id="5d55338d">Learn more about the stabilization of the K2 compiler in our <a href="https://blog.jetbrains.com/kotlin/2023/02/k2-kotlin-2-0/" id="5b41939" data-external="true" rel="noopener noreferrer">Kotlin blog</a></p></section><section class="chapter"><h2 id="defining-kotlin-compiler-execution-strategy" data-toc="defining-kotlin-compiler-execution-strategy">Defining Kotlin compiler execution strategy</h2>
<p id="6d1406fe"><em id="33edcc21" class="">Kotlin compiler execution strategy</em> defines where the Kotlin compiler is executed and if incremental compilation is supported in each case.</p>
<p id="47167e86">There are three compiler execution strategies:</p>
<div class="table-wrapper"><table class=" wide" id="2b234230">
<thead><tr class="ijRowHead" id="66b480b1">
<th id="3507e6da"><p>Strategy</p></th>
<th id="449c011d"><p>Where Kotlin compiler is executed</p></th>
<th id="67b17c41"><p>Incremental compilation</p></th>
<th id="643a8e5e"><p>Other characteristics and notes</p></th>
</tr></thead>
<tbody>
<tr class="" id="c5c1ba0c">
<td id="ccaf53c6"><p>Daemon</p></td>
<td id="a8989c69"><p>Inside its own daemon process</p></td>
<td id="3c9bbfc2"><p>Yes</p></td>
<td id="36d90acf"><p><em id="601353b1" class="">The default and fastest strategy</em>. Can be shared between different Gradle daemons and multiple parallel compilations.</p></td>
</tr>
<tr class="" id="eb00dd4c">
<td id="be523053"><p>In process</p></td>
<td id="6983d854"><p>Inside the Gradle daemon process</p></td>
<td id="bbb54a4f"><p>No</p></td>
<td id="aa1f4a6c"><p>May share the heap with the Gradle daemon. The "In process" execution strategy is <em id="d290e45e" class="">slower</em> than the "Daemon" execution strategy. Each <a href="https://docs.gradle.org/current/userguide/worker_api.html" id="ed9a5c36" data-external="true" rel="noopener noreferrer">worker</a> creates a separate Kotlin compiler classloader for each compilation.</p></td>
</tr>
<tr class="" id="924a8914">
<td id="11f32a98"><p>Out of process</p></td>
<td id="7e546e"><p>In a separate process for each compilation</p></td>
<td id="b2f03c15"><p>No</p></td>
<td id="3e457d7f"><p>The slowest execution strategy. Similar to the "In process", but additionally creates a separate Java process within a Gradle worker for each compilation.</p></td>
</tr>
</tbody>
</table></div>
<p id="e04b1da1">To define a Kotlin compiler execution strategy, you can use one of the following properties:</p>
<ul class="list _bullet" id="4f01caf4">
<li class="list__item" id="3b16c065"><p>The <code class="code ">kotlin.compiler.execution.strategy</code> Gradle property.</p></li>
<li class="list__item" id="311e153"><p>The <code class="code ">compilerExecutionStrategy</code> compile task property.</p></li>
</ul>
<p id="f20b2483">The task property <code class="code ">compilerExecutionStrategy</code> takes priority over the Gradle property <code class="code ">kotlin.compiler.execution.strategy</code>.</p>
<p id="a061601c">The available values for the <code class="code ">kotlin.compiler.execution.strategy</code> property are:</p>
<ol class="list _decimal" id="b10d234a" type="1">
<li class="list__item" id="663e7824"><p><code class="code ">daemon</code> (default)</p></li>
<li class="list__item" id="f2ca962"><p><code class="code ">in-process</code></p></li>
<li class="list__item" id="40333ec0"><p><code class="code ">out-of-process</code></p></li>
</ol>
<p id="a12d81a0">Use the Gradle property <code class="code ">kotlin.compiler.execution.strategy</code> in <code class="code ">gradle.properties</code>:</p>
<pre class="code" data-language="none">kotlin.compiler.execution.strategy=out-of-process
</pre>
<p id="e263b98c">The available values for the <code class="code ">compilerExecutionStrategy</code> task property are:</p>
<ol class="list _decimal" id="cf2b7c7a" type="1">
<li class="list__item" id="9af76c2e"><p><code class="code ">org.jetbrains.kotlin.gradle.tasks.KotlinCompilerExecutionStrategy.DAEMON</code> (default)</p></li>
<li class="list__item" id="cbe0ac68"><p><code class="code ">org.jetbrains.kotlin.gradle.tasks.KotlinCompilerExecutionStrategy.IN_PROCESS</code></p></li>
<li class="list__item" id="d1554245"><p><code class="code ">org.jetbrains.kotlin.gradle.tasks.KotlinCompilerExecutionStrategy.OUT_OF_PROCESS</code></p></li>
</ol>
<p id="67ca7a91">Use the task property <code class="code ">compilerExecutionStrategy</code> in your build scripts:</p>
<div class="tabs" id="4ab84177" data-group="build-script" data-anchors="[b78a90cc,2f690b8c,3a4039d1,896ea3c,4ab84177]">
<div class="tabs__content" data-gtm="tab" id="b78a90cc" data-sync-tabs="kotlin" data-title="Kotlin"><pre class="code" data-language="kotlin">import org.jetbrains.kotlin.gradle.tasks.CompileUsingKotlinDaemon
import org.jetbrains.kotlin.gradle.tasks.KotlinCompilerExecutionStrategy

// ...

tasks.withType&lt;CompileUsingKotlinDaemon&gt;().configureEach {
    compilerExecutionStrategy.set(KotlinCompilerExecutionStrategy.IN_PROCESS)
} 
</pre></div>
<div class="tabs__content" data-gtm="tab" id="3a4039d1" data-sync-tabs="groovy" data-title="Groovy"><pre class="code" data-language="groovy">import org.jetbrains.kotlin.gradle.tasks.CompileUsingKotlinDaemon
import org.jetbrains.kotlin.gradle.tasks.KotlinCompilerExecutionStrategy

// ...

tasks.withType(CompileUsingKotlinDaemon)
    .configureEach {
        compilerExecutionStrategy.set(KotlinCompilerExecutionStrategy.IN_PROCESS)
    }
</pre></div>
</div></section><section class="chapter"><h2 id="kotlin-compiler-fallback-strategy" data-toc="kotlin-compiler-fallback-strategy">Kotlin compiler fallback strategy</h2>
<p id="2ba5918c">The Kotlin compiler's fallback strategy is to run a compilation outside a Kotlin daemon if the daemon somehow fails. If the Gradle daemon is on, the compiler uses the <a href="#defining-kotlin-compiler-execution-strategy" id="a2413503">"In process" strategy</a>. If the Gradle daemon is off, the compiler uses the "Out of process" strategy.</p>
<p id="7dd2a2d6">When this fallback happens, you have the following warning lines in your Gradle's build output:</p>
<pre class="code" data-language="none">Failed to compile with Kotlin daemon: java.lang.RuntimeException: Could not connect to Kotlin compile daemon
[exception stacktrace]
Using fallback strategy: Compile without Kotlin daemon
Try ./gradlew --stop if this issue persists.
</pre>
<p id="cdc4f704">However, a silent fallback to another strategy can consume a lot of system resources or lead to non-deterministic builds. Read more about this in this <a href="https://youtrack.jetbrains.com/issue/KT-48843/Add-ability-to-disable-Kotlin-daemon-fallback-strategy" id="23467d56" data-external="true" rel="noopener noreferrer">YouTrack issue</a>. To avoid this, there is a Gradle property <code class="code ">kotlin.daemon.useFallbackStrategy</code>, whose default value is <code class="code ">true</code>. When the value is <code class="code ">false</code>, builds fail on problems with the daemon's startup or communication. Declare this property in <code class="code ">gradle.properties</code>:</p>
<pre class="code" data-language="none">kotlin.daemon.useFallbackStrategy=false
</pre>
<p id="bb5f05cb">There is also a <code class="code ">useDaemonFallbackStrategy</code> property in Kotlin compile tasks, which takes priority over the Gradle property if you use both.</p>
<div class="tabs" id="c516fdee" data-group="build-script" data-anchors="[19a404b1,76eebba5,69ff67e0,83ecbedb,c516fdee]">
<div class="tabs__content" data-gtm="tab" id="19a404b1" data-sync-tabs="kotlin" data-title="Kotlin"><pre class="code" data-language="kotlin">tasks {
    compileKotlin {
        useDaemonFallbackStrategy.set(false)
    }   
}
</pre></div>
<div class="tabs__content" data-gtm="tab" id="69ff67e0" data-sync-tabs="groovy" data-title="Groovy"><pre class="code" data-language="groovy">tasks.named("compileKotlin").configure {
    useDaemonFallbackStrategy = false
}
</pre></div>
</div>
<p id="73bfdfdb">If there is insufficient memory to run the compilation, you can see a message about it in the logs.</p></section><section class="chapter"><h2 id="build-reports" data-toc="build-reports">Build reports</h2>
<aside data-type="warning" class="prompt" data-title="" id="4450018e"><p id="6d43f547">Build reports are <a href="components-stability.html" id="c45bfb3e">Experimental</a>. They may be dropped or changed at any time. Opt-in is required (see details below). Use them only for evaluation purposes. We appreciate your feedback on them in <a href="https://youtrack.jetbrains.com/issues/KT" id="51053e2" data-external="true" rel="noopener noreferrer">YouTrack</a>.</p></aside><p id="a5e41d14">Build reports contain the durations of different compilation phases and any reasons why compilation couldn't be incremental. Use build reports to investigate performance issues when the compilation time is too long or when it differs for the same project.</p>
<p id="6ae08dfe">Kotlin build reports help you to investigate problems with build performance more efficiently than with <a href="https://scans.gradle.com/" id="e9775f38" data-external="true" rel="noopener noreferrer">Gradle build scans</a> that have a single Gradle task as the unit of granularity.</p>
<p id="2716046d">There are two common cases that analyzing build reports for long-running compilations can help you resolve:</p>
<ul class="list _bullet" id="3c3e71ec">
<li class="list__item" id="3410546d"><p>The build wasn't incremental. Analyze the reasons and fix underlying problems.</p></li>
<li class="list__item" id="fe54975"><p>The build was incremental but took too much time. Try reorganizing source files — split big files, save separate classes in different files, refactor large classes, declare top-level functions in different files, and so on.</p></li>
</ul>
<p id="62699c59">Build reports also show the Kotlin version used in the project. In addition, starting with Kotlin 1.9.0, you can see whether the current or the <a href="#the-new-kotlin-compiler" id="1c1819cf">K2 compiler</a> was used to compile the code in your <a href="https://scans.gradle.com/" id="68e98925" data-external="true" rel="noopener noreferrer">Gradle build scans</a>.</p>
<p id="1837ffb5">Learn <a href="https://blog.jetbrains.com/kotlin/2022/06/introducing-kotlin-build-reports/#how_to_read_build_reports" id="f728c1f0" data-external="true" rel="noopener noreferrer">how to read build reports</a> and about <a href="https://blog.jetbrains.com/kotlin/2022/06/introducing-kotlin-build-reports/#how_we_use_build_reports_in_jetbrains" id="a969e" data-external="true" rel="noopener noreferrer">how JetBrains uses build reports</a>.</p>
<section class="chapter"><h3 id="enabling-build-reports" data-toc="enabling-build-reports">Enabling build reports</h3>
<p id="d217bc34">To enable build reports, declare where to save the build report output in <code class="code ">gradle.properties</code>:</p>
<pre class="code" data-language="none">kotlin.build.report.output=file
</pre>
<p id="384102cc">The following values and their combinations are available for the output:</p>
<div class="table-wrapper"><table class=" wide" id="f4f73fba">
<thead><tr class="ijRowHead" id="dbab8758">
<th id="ca2e9053"><p>Option</p></th>
<th id="236163fc"><p>Description</p></th>
</tr></thead>
<tbody>
<tr class="" id="965cafbc">
<td id="475653ac"><p><code class="code ">file</code></p></td>
<td id="3be603e8"><p>Saves build reports in a human-readable format to a local file. By default, it's <code class="code ">${project_folder}/build/reports/kotlin-build/${project_name}-timestamp.txt</code></p></td>
</tr>
<tr class="" id="95058caa">
<td id="ac873ab8"><p><code class="code ">single_file</code></p></td>
<td id="d794da78"><p>Saves build reports in a format of an object to a specified local file</p></td>
</tr>
<tr class="" id="1dc12fde">
<td id="f8089a51"><p><code class="code ">build_scan</code></p></td>
<td id="daf97eaa"><p>Saves build reports in the <code class="code ">custom values</code> section of the <a href="https://scans.gradle.com/" id="931791f7" data-external="true" rel="noopener noreferrer">build scan</a>. Note that the Gradle Enterprise plugin limits the number of custom values and their length. In big projects, some values could be lost</p></td>
<td id="663a845b"></td>
</tr>
<tr class="" id="30be46b0">
<td id="ea64f65b"><p><code class="code ">http</code></p></td>
<td id="b71da764"><p>Posts build reports using HTTP(S). The POST method sends metrics in JSON format. You can see the current version of the sent data in the <a href="https://github.com/JetBrains/kotlin/blob/master/libraries/tools/kotlin-gradle-plugin/src/common/kotlin/org/jetbrains/kotlin/gradle/plugin/statistics/CompileStatisticsData.kt" id="f93c9535" data-external="true" rel="noopener noreferrer">Kotlin repository</a>. You can find samples of HTTP endpoints in <a href="https://blog.jetbrains.com/kotlin/2022/06/introducing-kotlin-build-reports/#enable_build_reports" id="5d5b7314" data-external="true" rel="noopener noreferrer">this blog post</a></p></td>
</tr>
</tbody>
</table></div>
<p id="a978ef1a">Here's a list of available options for <code class="code ">kotlin.build.report</code>:</p>
<pre class="code" data-language="none"># Required outputs. Any combination is allowed
kotlin.build.report.output=file,single_file,http,build_scan

# Mandatory if single_file output is used. Where to put reports 
# Use instead of the deprecated `kotlin.internal.single.build.metrics.file` property
kotlin.build.report.single_file=some_filename

# Optional. Output directory for file-based reports. Default: build/reports/kotlin-build/
kotlin.build.report.file.output_dir=kotlin-reports

# Optional. Label for marking your build report (for example, debug parameters)
kotlin.build.report.label=some_label
</pre>
<p id="3b63fe28">Options, applicable only to HTTP:</p>
<pre class="code" data-language="none"># Mandatory. Where to post HTTP(S)-based reports
kotlin.build.report.http.url=http://127.0.0.1:8080

# Optional. User and password if the HTTP endpoint requires authentication
kotlin.build.report.http.user=someUser
kotlin.build.report.http.password=somePassword

# Optional. Add a Git branch name of a build to a build report
kotlin.build.report.http.include_git_branch.name=true|false

# Optional. Add compiler arguments to a build report
# If a project contains many modules, its compiler arguments in the report can be very heavy and not that helpful
kotlin.build.report.include_compiler_arguments=true|false
</pre></section><section class="chapter"><h3 id="limit-of-custom-values" data-toc="limit-of-custom-values">Limit of custom values</h3>
<p id="340746f">To collect build scans' statistics, Kotlin build reports use <a href="https://docs.gradle.com/enterprise/tutorials/extending-build-scans/" id="321b108c" data-external="true" rel="noopener noreferrer">Gradle's custom values</a>. Both you and different Gradle plugins can write data to custom values. The number of custom values has a limit. See the current maximum custom value count in the <a href="https://docs.gradle.com/enterprise/gradle-plugin/#adding_custom_values" id="5abb8f52" data-external="true" rel="noopener noreferrer">Build scan plugin docs</a>.</p>
<p id="44a685df">If you have a big project, a number of such custom values may be quite big. If this number exceeds the limit, you can see the following message in the logs:</p>
<pre class="code" data-language="plaintext">Maximum number of custom values (1,000) exceeded
</pre>
<p id="79825dd7">To reduce the number of custom values the Kotlin plugin produces, you can use the following property in <code class="code ">gradle.properties</code>:</p>
<pre class="code" data-language="none">kotlin.build.report.build_scan.custom_values_limit=500
</pre></section><section class="chapter"><h3 id="switching-off-collecting-project-and-system-properties" data-toc="switching-off-collecting-project-and-system-properties">Switching off collecting project and system properties</h3>
<p id="215e6ff2">HTTP build statistic logs can contain some project and system properties. These properties can change builds' behavior, so it's useful to log them in build statistics. These properties can store sensitive data, for example, passwords or a project's full path.</p>
<p id="22673f7a">You can disable collection of these statistics by adding the <code class="code ">kotlin.build.report.http.verbose_environment</code> property to your <code class="code ">gradle.properties</code>.</p>
<aside data-type="note" class="prompt" data-title="" id="400cb51c"><p id="1d6241f9">JetBrains doesn't collect these statistics. You choose a place <a href="#enabling-build-reports" id="1fa7c88f">where to store your reports</a>.</p></aside></section></section><section class="chapter"><h2 id="what-s-next" data-toc="what-s-next">What's next?</h2>
<p id="248776d0">Learn more about:</p>
<ul class="list _bullet" id="f7e0dbbd">
<li class="list__item" id="3db0a45c"><p><a href="https://docs.gradle.org/current/userguide/getting_started.html" id="1a083e5d" data-external="true" rel="noopener noreferrer">Gradle basics and specifics</a>.</p></li>
<li class="list__item" id="4e4d13d0"><p><a href="gradle-plugin-variants.html" id="b8ef44cb">Support for Gradle plugin variants</a>.</p></li>
</ul></section><div class="last-modified"> Last modified: 24 July 2023</div>

<div class="navigation-links _bottom"> <a class="navigation-links__prev" href="gradle-compiler-options.html">Compiler options in the Kotlin Gradle plugin</a> <a class="navigation-links__next" href="gradle-plugin-variants.html">Support for Gradle plugin variants</a> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2010&ndash;2023 JetBrains s.r.o. and Kotlin Programming Language contributors<br>Licensed under the Apache License, Version 2.0.<br>
    <a href="https://kotlinlang.org/docs/gradle-compilation-and-caches.html" class="_attribution-link">https://kotlinlang.org/docs/gradle-compilation-and-caches.html</a>
  </p>
</div>
