<h1 data-toc="whatsnew1620" id="whatsnew1620.md">What's new in Kotlin 1.6.20</h1>
<p id="ec2c0d10"><em id="fe2ba687" class=""><a href="releases.html#release-details" id="75645cc0">Released: 4 April 2022</a></em></p>
<p id="5798fec9">Kotlin 1.6.20 reveals previews of the future language features, makes the hierarchical structure the default for multiplatform projects, and brings evolutionary improvements to other components.</p>
<p id="1d5d741f">You can also find a short overview of the changes in this video:</p>

<section class="chapter"><h2 id="language" data-toc="language">Language</h2>
<p id="a4f1edfd">In Kotlin 1.6.20, you can try two new language features:</p>
<ul class="list _bullet" id="7204c75a">
<li class="list__item" id="2af6d7a6"><p><a href="#prototype-of-context-receivers-for-kotlin-jvm" id="78fc53b4">Prototype of context receivers for Kotlin/JVM</a></p></li>
<li class="list__item" id="61989489"><p><a href="#definitely-non-nullable-types" id="cb9b48ff">Definitely non-nullable types</a></p></li>
</ul>
<section class="chapter"><h3 id="prototype-of-context-receivers-for-kotlin-jvm" data-toc="prototype-of-context-receivers-for-kotlin-jvm">Prototype of context receivers for Kotlin/JVM</h3>
<aside data-type="warning" class="prompt" data-title="" id="3094aafb"><p id="fbeef6e2">The feature is a prototype available only for Kotlin/JVM. With <code class="code ">-Xcontext-receivers</code> enabled, the compiler will produce pre-release binaries that cannot be used in production code. Use context receivers only in your toy projects. We appreciate your feedback in <a href="https://youtrack.jetbrains.com/issues/KT" id="fcf6ba00" data-external="true" rel="noopener noreferrer">YouTrack</a>.</p></aside><p id="1e26a66e">With Kotlin 1.6.20, you are no longer limited to having one receiver. If you need more, you can make functions, properties, and classes context-dependent (or <em id="d9b69f0f" class="">contextual</em>) by adding context receivers to their declaration. A contextual declaration does the following:</p>
<ul class="list _bullet" id="fcaad73e">
<li class="list__item" id="f1672e97"><p>It requires all declared context receivers to be present in a caller's scope as implicit receivers.</p></li>
<li class="list__item" id="d27ff4ae"><p>It brings declared context receivers into its body scope as implicit receivers.</p></li>
</ul>
<pre class="code" data-language="kotlin">interface LoggingContext {
    val log: Logger // This context provides a reference to a logger 
}

context(LoggingContext)
fun startBusinessOperation() {
    // You can access the log property since LoggingContext is an implicit receiver
    log.info("Operation has started")
}

fun test(loggingContext: LoggingContext) {
    with(loggingContext) {
        // You need to have LoggingContext in a scope as an implicit receiver
        // to call startBusinessOperation()
        startBusinessOperation()
    }
}
</pre>
<p id="5cf67f1d">To enable context receivers in your project, use the <code class="code ">-Xcontext-receivers</code> compiler option. You can find a detailed description of the feature and its syntax in the <a href="https://github.com/Kotlin/KEEP/blob/master/proposals/context-receivers.md#detailed-design" id="a8f2526a" data-external="true" rel="noopener noreferrer">KEEP</a>.</p>
<p id="ab625742">Please note that the implementation is a prototype:</p>
<ul class="list _bullet" id="7be03bff">
<li class="list__item" id="789efe93"><p>With <code class="code ">-Xcontext-receivers</code> enabled, the compiler will produce pre-release binaries that cannot be used in production code</p></li>
<li class="list__item" id="bee796ec"><p>The IDE support for context receivers is minimal for now</p></li>
</ul>
<p id="fb9a94af">Try the feature in your toy projects and share your thoughts and experience with us in <a href="https://youtrack.jetbrains.com/issue/KT-42435" id="215655aa" data-external="true" rel="noopener noreferrer">this YouTrack issue</a>. If you run into any problems, please <a href="https://kotl.in/issue" id="d562c6c0" data-external="true" rel="noopener noreferrer">file a new issue</a>.</p></section><section class="chapter"><h3 id="definitely-non-nullable-types" data-toc="definitely-non-nullable-types">Definitely non-nullable types</h3>
<aside data-type="warning" class="prompt" data-title="" id="adf55c48"><p id="52dcb2ad">Definitely non-nullable types are in <a href="components-stability.html" id="a2b76b66">Beta</a>. They are almost stable, but migration steps may be required in the future. We'll do our best to minimize any changes you have to make.</p></aside><p id="8ef81d0a">To provide better interoperability when extending generic Java classes and interfaces, Kotlin 1.6.20 allows you to mark a generic type parameter as definitely non-nullable on the use site with the new syntax <code class="code ">T &amp; Any</code>. The syntactic form comes from a notation of <a href="https://en.wikipedia.org/wiki/Intersection_type" id="ce487132" data-external="true" rel="noopener noreferrer">intersection types</a> and is now limited to a type parameter with nullable upper bounds on the left side of <code class="code ">&amp;</code> and non-nullable <code class="code ">Any</code> on the right side:</p>
<pre class="code" data-language="kotlin">fun &lt;T&gt; elvisLike(x: T, y: T &amp; Any): T &amp; Any = x ?: y

fun main() {
    // OK
    elvisLike&lt;String&gt;("", "").length
    // Error: 'null' cannot be a value of a non-null type
    elvisLike&lt;String&gt;("", null).length

    // OK
    elvisLike&lt;String?&gt;(null, "").length
    // Error: 'null' cannot be a value of a non-null type
    elvisLike&lt;String?&gt;(null, null).length
}
</pre>
<p id="f873d871">Set the language version to <code class="code ">1.7</code> to enable the feature:</p>
<div class="tabs" id="98e83b69" data-group="build-script" data-anchors="[e6fc4ceb,d2f8891f,395f89e,495362c7,98e83b69]">
<div class="tabs__content" data-gtm="tab" id="e6fc4ceb" data-sync-tabs="kotlin" data-title="Kotlin"><pre class="code" data-language="kotlin">kotlin {
    sourceSets.all {
        languageSettings.apply {
            languageVersion = "1.7"
        }
    }
}
</pre></div>
<div class="tabs__content" data-gtm="tab" id="395f89e" data-sync-tabs="groovy" data-title="Groovy"><pre class="code" data-language="groovy">kotlin {
    sourceSets.all {
        languageSettings {
            languageVersion = '1.7'
        }
    }
}
</pre></div>
</div>
<p id="5eab7a5d">Learn more about definitely non-nullable types in <a href="https://github.com/Kotlin/KEEP/blob/c72601cf35c1e95a541bb4b230edb474a6d1d1a8/proposals/definitely-non-nullable-types.md" id="300fdc35" data-external="true" rel="noopener noreferrer">the KEEP</a>.</p></section></section><section class="chapter"><h2 id="kotlin-jvm" data-toc="kotlin-jvm">Kotlin/JVM</h2>
<p id="afbe85aa">Kotlin 1.6.20 introduces:</p>
<ul class="list _bullet" id="7267cd06">
<li class="list__item" id="7220843a"><p>Compatibility improvements of default methods in JVM interfaces: <a href="#new-jvmdefaultwithcompatibility-annotation-for-interfaces" id="276abaf4">new <code class="code ">@JvmDefaultWithCompatibility</code> annotation for interfaces</a> and <a href="#compatibility-changes-in-the-xjvm-default-modes" id="64032ff8">compatibility changes in the <code class="code ">-Xjvm-default</code> modes</a></p></li>
<li class="list__item" id="ee607329"><p><a href="#support-for-parallel-compilation-of-a-single-module-in-the-jvm-backend" id="8455e7c8">Support for parallel compilation of a single module in the JVM backend</a></p></li>
<li class="list__item" id="68c7f977"><p><a href="#support-for-callable-references-to-functional-interface-constructors" id="fd5a8d7a">Support for callable references to functional interface constructors</a></p></li>
</ul>
<section class="chapter"><h3 id="new-jvmdefaultwithcompatibility-annotation-for-interfaces" data-toc="new-jvmdefaultwithcompatibility-annotation-for-interfaces">New @JvmDefaultWithCompatibility annotation for interfaces</h3>
<p id="ab800bb2">Kotlin 1.6.20 introduces the new annotation <a href="../api/latest/jvm/stdlib/kotlin.jvm/-jvm-default-with-compatibility/index.html" id="ccc89941" data-external="true" rel="noopener noreferrer"><code class="code ">@JvmDefaultWithCompatibility</code></a>: use it along with the <code class="code ">-Xjvm-default=all</code> compiler option <a href="java-to-kotlin-interop.html#default-methods-in-interfaces" id="5443dd40">to create the default method in JVM interface</a> for any non-abstract member in any Kotlin interface.</p>
<p id="288a5518">If there are clients that use your Kotlin interfaces compiled without the <code class="code ">-Xjvm-default=all</code> option, they may be binary-incompatible with the code compiled with this option. Before Kotlin 1.6.20, to avoid this compatibility issue, the <a href="https://blog.jetbrains.com/kotlin/2020/07/kotlin-1-4-m3-generating-default-methods-in-interfaces/#JvmDefaultWithoutCompatibility" id="ece30410" data-external="true" rel="noopener noreferrer">recommended approach</a> was to use the <code class="code ">-Xjvm-default=all-compatibility</code> mode and also the <code class="code ">@JvmDefaultWithoutCompatibility</code> annotation for interfaces that didn't need this type of compatibility.</p>
<p id="9bf424c4">This approach had some disadvantages:</p>
<ul class="list _bullet" id="2dc3251a">
<li class="list__item" id="e71bf9b0"><p>You could easily forget to add the annotation when a new interface was added.</p></li>
<li class="list__item" id="8a24ded3"><p>Usually there are more interfaces in non-public parts than in the public API, so you end up having this annotation in many places in your code.</p></li>
</ul>
<p id="f12e0595">Now, you can use the <code class="code ">-Xjvm-default=all</code> mode and mark interfaces with the <code class="code ">@JvmDefaultWithCompatibility</code> annotation. This allows you to add this annotation to all interfaces in the public API once, and you won't need to use any annotations for new non-public code.</p>
<p id="966f9138">Leave your feedback about this new annotation in <a href="https://youtrack.jetbrains.com/issue/KT-48217" id="f8b46c38" data-external="true" rel="noopener noreferrer">this YouTrack ticket</a>.</p></section><section class="chapter"><h3 id="compatibility-changes-in-the-xjvm-default-modes" data-toc="compatibility-changes-in-the-xjvm-default-modes">Compatibility changes in the -Xjvm-default modes</h3>
<p id="7bc11413">Kotlin 1.6.20 adds the option to compile modules in the default mode (the <code class="code ">-Xjvm-default=disable</code> compiler option) against modules compiled with the <code class="code ">-Xjvm-default=all</code> or <code class="code ">-Xjvm-default=all-compatibility</code> modes. As before, compilations will also be successful if all modules have the <code class="code ">-Xjvm-default=all</code> or <code class="code ">-Xjvm-default=all-compatibility</code> modes. You can leave your feedback in this <a href="https://youtrack.jetbrains.com/issue/KT-47000" id="ca96fcca" data-external="true" rel="noopener noreferrer">YouTrack issue</a>.</p>
<p id="ec8b7000">Kotlin 1.6.20 deprecates the <code class="code ">compatibility</code> and <code class="code ">enable</code> modes of the compiler option <code class="code ">-Xjvm-default</code>. There are changes in other modes' descriptions regarding the compatibility, but the overall logic remains the same. You can check out the <a href="java-to-kotlin-interop.html#compatibility-modes-for-default-methods" id="45545535">updated descriptions</a>.</p>
<p id="2d1836ff">For more information about default methods in the Java interop, see the <a href="java-to-kotlin-interop.html#default-methods-in-interfaces" id="385ba7e2">interoperability documentation</a> and <a href="https://blog.jetbrains.com/kotlin/2020/07/kotlin-1-4-m3-generating-default-methods-in-interfaces/" id="5bd9ed68" data-external="true" rel="noopener noreferrer">this blog post</a>.</p></section><section class="chapter"><h3 id="support-for-parallel-compilation-of-a-single-module-in-the-jvm-backend" data-toc="support-for-parallel-compilation-of-a-single-module-in-the-jvm-backend">Support for parallel compilation of a single module in the JVM backend</h3>
<aside data-type="warning" class="prompt" data-title="" id="80387e63"><p id="115c024e">Support for parallel compilation of a single module in the JVM backend is <a href="components-stability.html" id="5ffdf8c1">Experimental</a>. It may be dropped or changed at any time. Opt-in is required (see details below), and you should use it only for evaluation purposes. We would appreciate your feedback on it in <a href="https://youtrack.jetbrains.com/issue/KT-46085" id="757a7687" data-external="true" rel="noopener noreferrer">YouTrack</a>.</p></aside><p id="cdb4f69e">We are continuing our work to <a href="https://youtrack.jetbrains.com/issue/KT-46768" id="5b79cbf7" data-external="true" rel="noopener noreferrer">improve the new JVM IR backend compilation time</a>. In Kotlin 1.6.20, we added the experimental JVM IR backend mode to compile all the files in a module in parallel. Parallel compilation can reduce the total compilation time by up to 15%.</p>
<p id="3dbb8d48">Enable the experimental parallel backend mode with the <a href="compiler-reference.html#compiler-options" id="c64553d1">compiler option</a> <code class="code ">-Xbackend-threads</code>. Use the following arguments for this option:</p>
<ul class="list _bullet" id="3dd8069a">
<li class="list__item" id="dc715590"><p><code class="code ">N</code> is the number of threads you want to use. It should not be greater than your number of CPU cores; otherwise, parallelization stops being effective because of switching context between threads</p></li>
<li class="list__item" id="52111c08"><p><code class="code ">0</code> to use a separate thread for each CPU core</p></li>
</ul>
<p id="e9abf471"><a href="gradle.html" id="41f7bdf6">Gradle</a> can run tasks in parallel, but this type of parallelization doesn't help a lot when a project (or a major part of a project) is just one big task from Gradle's perspective. If you have a very big monolithic module, use parallel compilation to compile more quickly. If your project consists of lots of small modules and has a build parallelized by Gradle, adding another layer of parallelization may hurt performance because of context switching.</p>
<aside data-type="note" class="prompt" data-title="" id="b2e675c8"><p id="45e8d699">Parallel compilation has some constraints:</p>
<ul class="list _bullet" id="eac34349">
<li class="list__item" id="7d4e6c32"><p>It doesn't work with <a href="kapt.html" id="2a43041">kapt</a> because kapt disables the IR backend</p></li>
<li class="list__item" id="467cd8c2"><p>It requires more JVM heap by design. The amount of heap is proportional to the number of threads</p></li>
</ul></aside></section><section class="chapter"><h3 id="support-for-callable-references-to-functional-interface-constructors" data-toc="support-for-callable-references-to-functional-interface-constructors">Support for callable references to functional interface constructors</h3>
<aside data-type="warning" class="prompt" data-title="" id="bb43cdfb"><p id="3a7c4980">Support for callable references to functional interface constructors is <a href="components-stability.html" id="c8181e89">Experimental</a>. It may be dropped or changed at any time. Opt-in is required (see details below), and you should use it only for evaluation purposes. We would appreciate your feedback on it in <a href="https://youtrack.jetbrains.com/issue/KT-47939" id="fbc21de3" data-external="true" rel="noopener noreferrer">YouTrack</a>.</p></aside><p id="43a58b3a">Support for <a href="reflection.html#callable-references" id="b49b5273">callable references</a> to functional interface constructors adds a source-compatible way to migrate from an interface with a constructor function to a <a href="fun-interfaces.html" id="b262dbfe">functional interface</a>.</p>
<p id="7d8a7163">Consider the following code:</p>
<pre class="code" data-language="kotlin">interface Printer {
    fun print()
}

fun Printer(block: () -&gt; Unit): Printer = object : Printer { override fun print() = block() }
</pre>
<p id="baa16647">With callable references to functional interface constructors enabled, this code can be replaced with just a functional interface declaration:</p>
<pre class="code" data-language="kotlin">fun interface Printer {
    fun print()
}
</pre>
<p id="88ea4763">Its constructor will be created implicitly, and any code using the <code class="code ">::Printer</code> function reference will compile. For example:</p>
<pre class="code" data-language="kotlin">documentsStorage.addPrinter(::Printer)
</pre>
<p id="c9875e57">Preserve the binary compatibility by marking the legacy function <code class="code ">Printer</code> with the <a href="../api/latest/jvm/stdlib/kotlin/-deprecated/index.html" id="72455bba" data-external="true" rel="noopener noreferrer"><code class="code ">@Deprecated</code></a> annotation with <code class="code ">DeprecationLevel.HIDDEN</code>:</p>
<pre class="code" data-language="kotlin">@Deprecated(message = "Your message about the deprecation", level = DeprecationLevel.HIDDEN)
fun Printer(...) {...}
</pre>
<p id="aa748d58">Use the compiler option <code class="code ">-XXLanguage:+KotlinFunInterfaceConstructorReference</code> to enable this feature.</p></section></section><section class="chapter"><h2 id="kotlin-native" data-toc="kotlin-native">Kotlin/Native</h2>
<p id="ff207549">Kotlin/Native 1.6.20 marks continued development of its new components. We've taken another step toward consistent experience with Kotlin on other platforms:</p>
<ul class="list _bullet" id="44dbf7b9">
<li class="list__item" id="2b19a7bc"><p><a href="#an-update-on-the-new-memory-manager" id="4852ed00">An update on the new memory manager</a></p></li>
<li class="list__item" id="9944567f"><p><a href="#concurrent-implementation-for-the-sweep-phase-in-new-memory-manager" id="b9618058">Concurrent implementation for the sweep phase in new memory manager</a></p></li>
<li class="list__item" id="7fde5f6"><p><a href="#instantiation-of-annotation-classes" id="8dfd8f7">Instantiation of annotation classes</a></p></li>
<li class="list__item" id="2164d633"><p><a href="#interop-with-swift-async-await-returning-void-instead-of-kotlinunit" id="91e1e535">Interop with Swift async/await: returning Swift's Void instead of KotlinUnit</a></p></li>
<li class="list__item" id="2e0e5ebc"><p><a href="#better-stack-traces-with-libbacktrace" id="5927082b">Better stack traces with libbacktrace</a></p></li>
<li class="list__item" id="bb14eb9c"><p><a href="#support-for-standalone-android-executables" id="387c7cc8">Support for standalone Android executables</a></p></li>
<li class="list__item" id="fac82eb1"><p><a href="#performance-improvements" id="bea30b38">Performance improvements</a></p></li>
<li class="list__item" id="aacd3659"><p><a href="#improved-error-handling-during-cinterop-modules-import" id="98282e8e">Improved error handling during cinterop modules import</a></p></li>
<li class="list__item" id="4dc682e9"><p><a href="#support-for-xcode-13-libraries" id="e75b4c06">Support for Xcode 13 libraries</a></p></li>
</ul>
<section class="chapter"><h3 id="an-update-on-the-new-memory-manager" data-toc="an-update-on-the-new-memory-manager">An update on the new memory manager</h3>
<aside data-type="note" class="prompt" data-title="" id="d7177694"><p id="2355f265">The new Kotlin/Native memory manager is in <a href="components-stability.html" id="93c847ac">Alpha</a>. It may change incompatibly and require manual migration in the future. We would appreciate your feedback on it in <a href="https://youtrack.jetbrains.com/issue/KT-48525" id="8b038f3b" data-external="true" rel="noopener noreferrer">YouTrack</a>.</p></aside><p id="e036e364">With Kotlin 1.6.20, you can try the Alpha version of the new Kotlin/Native memory manager. It eliminates the differences between the JVM and Native platforms to provide a consistent developer experience in multiplatform projects. For example, you'll have a much easier time creating new cross-platform mobile applications that work on both Android and iOS.</p>
<p id="806b7119">The new Kotlin/Native memory manager lifts restrictions on object-sharing between threads. It also provides leak-free concurrent programming primitives that are safe and don't require any special management or annotations.</p>
<p id="c39b7f7a">The new memory manager will become the default in future versions, so we encourage you to try it now. Check out our <a href="https://blog.jetbrains.com/kotlin/2021/08/try-the-new-kotlin-native-memory-manager-development-preview/" id="3b0d98f1" data-external="true" rel="noopener noreferrer">blog post</a> to learn more about the new memory manager and explore demo projects, or jump right to the <a href="https://github.com/JetBrains/kotlin/blob/master/kotlin-native/NEW_MM.md" id="7f950373" data-external="true" rel="noopener noreferrer">migration instructions</a> to try it yourself.</p>
<p id="e4ee9a3e">Try using the new memory manager on your projects to see how it works and share feedback in our issue tracker, <a href="https://youtrack.jetbrains.com/issue/KT-48525" id="4fb8864f" data-external="true" rel="noopener noreferrer">YouTrack</a>.</p></section><section class="chapter"><h3 id="concurrent-implementation-for-the-sweep-phase-in-new-memory-manager" data-toc="concurrent-implementation-for-the-sweep-phase-in-new-memory-manager">Concurrent implementation for the sweep phase in new memory manager</h3>
<p id="bae3e8a9">If you have already switched to our new memory manager, which was <a href="whatsnew16.html#preview-of-the-new-memory-manager" id="ba90ebe0">announced in Kotlin 1.6</a>, you might notice a huge execution time improvement: our benchmarks show 35% improvement on average. Starting with 1.6.20, there is also a concurrent implementation for the sweep phase available for the new memory manager. This should also improve the performance and decrease the duration of garbage collector pauses.</p>
<p id="9c74433f">To enable the feature for the new Kotlin/Native memory manager, pass the following compiler option:</p>
<pre class="code" data-language="bash">-Xgc=cms 
</pre>
<p id="617fc07e">Feel free to share your feedback on the new memory manager performance in this <a href="https://youtrack.jetbrains.com/issue/KT-48526" id="f5c90966" data-external="true" rel="noopener noreferrer">YouTrack issue</a>.</p></section><section class="chapter"><h3 id="instantiation-of-annotation-classes" data-toc="instantiation-of-annotation-classes">Instantiation of annotation classes</h3>
<p id="2ef123b7">In Kotlin 1.6.0, instantiation of annotation classes became <a href="components-stability.html" id="627099c5">Stable</a> for Kotlin/JVM and Kotlin/JS. The 1.6.20 version delivers support for Kotlin/Native.</p>
<p id="a9fbeb9d">Learn more about <a href="annotations.html#instantiation" id="ecd5d7bd">instantiation of annotation classes</a>.</p></section><section class="chapter"><h3 id="interop-with-swift-async-await-returning-void-instead-of-kotlinunit" data-toc="interop-with-swift-async-await-returning-void-instead-of-kotlinunit">Interop with Swift async/await: returning Void instead of KotlinUnit</h3>
<aside data-type="warning" class="prompt" data-title="" id="642dc2ff"><p id="f73876af">Concurrency interoperability with Swift async/await is <a href="components-stability.html" id="4ce8f7f4">Experimental</a>. It may be dropped or changed at any time. You should use it only for evaluation purposes. We would appreciate your feedback on it in <a href="https://youtrack.jetbrains.com/issue/KT-47610" id="70ee2b40" data-external="true" rel="noopener noreferrer">YouTrack</a>.</p></aside><p id="25132b07">We've continued working on the <a href="whatsnew1530.html#experimental-interoperability-with-swift-5-5-async-await" id="8aa57f7c">experimental interop with Swift's async/await</a> (available since Swift 5.5). Kotlin 1.6.20 differs from previous versions in the way it works with <code class="code ">suspend</code> functions with the <code class="code ">Unit</code> return type.</p>
<p id="308f7469">Previously, such functions were presented in Swift as <code class="code ">async</code> functions returning <code class="code ">KotlinUnit</code>. However, the proper return type for them is <code class="code ">Void</code>, similar to non-suspending functions.</p>
<p id="4e2e7fbb">To avoid breaking the existing code, we're introducing a Gradle property that makes the compiler translate <code class="code ">Unit</code>-returning suspend functions to <code class="code ">async</code> Swift with the <code class="code ">Void</code> return type:</p>
<pre class="code" data-language="none"># gradle.properties
kotlin.native.binary.unitSuspendFunctionObjCExport=proper
</pre>
<p id="4b649d52">We plan to make this behavior the default in future Kotlin releases.</p></section><section class="chapter"><h3 id="better-stack-traces-with-libbacktrace" data-toc="better-stack-traces-with-libbacktrace">Better stack traces with libbacktrace</h3>
<aside data-type="warning" class="prompt" data-title="" id="7c6dbd38"><p id="80359b23">Using libbacktrace for resolving source locations is <a href="components-stability.html" id="bccbb31">Experimental</a>. It may be dropped or changed at any time. You should use it only for evaluation purposes. We would appreciate your feedback on it in <a href="https://youtrack.jetbrains.com/issue/KT-48424" id="a1d469bf" data-external="true" rel="noopener noreferrer">YouTrack</a>.</p></aside><p id="24f7ca0d">Kotlin/Native is now able to produce detailed stack traces with file locations and line numbers for better debugging of <code class="code ">linux*</code> (except <code class="code ">linuxMips32</code> and <code class="code ">linuxMipsel32</code>) and <code class="code ">androidNative*</code> targets.</p>
<p id="61f1ad85">This feature uses the <a href="https://github.com/ianlancetaylor/libbacktrace" id="f61f271e" data-external="true" rel="noopener noreferrer">libbacktrace</a> library under the hood. Take a look at the following code to see an example of the difference:</p>
<pre class="code" data-language="kotlin">fun main() = bar()
fun bar() = baz()
inline fun baz() {
    error("")
}
</pre>
<ul class="list _bullet" id="d02bb4cc"><li class="list__item" id="122a3c68"><p><b id="363ed705" class="">Before 1.6.20:</b></p></li></ul>
<div class="code-collapse" data-lang="plaintext" data-is-expanded="false" data-anchors="[91fb7c9d]" data-synopsis="Uncaught Kotlin exception: kotlin.IllegalStateException:">Uncaught Kotlin exception: kotlin.IllegalStateException: at 0 example.kexe 0x227190 kfun:kotlin.Throwable#&lt;init&gt;(kotlin.String?){} + 96 at 1 example.kexe 0x221e4c kfun:kotlin.Exception#&lt;init&gt;(kotlin.String?){} + 92 at 2 example.kexe 0x221f4c kfun:kotlin.RuntimeException#&lt;init&gt;(kotlin.String?){} + 92 at 3 example.kexe 0x22234c kfun:kotlin.IllegalStateException#&lt;init&gt;(kotlin.String?){} + 92 at 4 example.kexe 0x25d708 kfun:#bar(){} + 104 at 5 example.kexe 0x25d68c kfun:#main(){} + 12 </div>
<ul class="list _bullet" id="4fea8c02"><li class="list__item" id="dd32d57e"><p><b id="7f9cf409" class="">1.6.20 with libbacktrace:</b></p></li></ul>
<div class="code-collapse" data-lang="plaintext" data-is-expanded="false" data-anchors="[119188e2]" data-synopsis="Uncaught Kotlin exception: kotlin.IllegalStateException:">Uncaught Kotlin exception: kotlin.IllegalStateException: at 0 example.kexe 0x229550 kfun:kotlin.Throwable#&lt;init&gt;(kotlin.String?){} + 96 (/opt/buildAgent/work/c3a91df21e46e2c8/kotlin/kotlin-native/runtime/src/main/kotlin/kotlin/Throwable.kt:24:37) at 1 example.kexe 0x22420c kfun:kotlin.Exception#&lt;init&gt;(kotlin.String?){} + 92 (/opt/buildAgent/work/c3a91df21e46e2c8/kotlin/kotlin-native/runtime/src/main/kotlin/kotlin/Exceptions.kt:23:44) at 2 example.kexe 0x22430c kfun:kotlin.RuntimeException#&lt;init&gt;(kotlin.String?){} + 92 (/opt/buildAgent/work/c3a91df21e46e2c8/kotlin/kotlin-native/runtime/src/main/kotlin/kotlin/Exceptions.kt:34:44) at 3 example.kexe 0x22470c kfun:kotlin.IllegalStateException#&lt;init&gt;(kotlin.String?){} + 92 (/opt/buildAgent/work/c3a91df21e46e2c8/kotlin/kotlin-native/runtime/src/main/kotlin/kotlin/Exceptions.kt:70:44) at 4 example.kexe 0x25fac8 kfun:#bar(){} + 104 [inlined] (/opt/buildAgent/work/c3a91df21e46e2c8/kotlin/libraries/stdlib/src/kotlin/util/Preconditions.kt:143:56) at 5 example.kexe 0x25fac8 kfun:#bar(){} + 104 [inlined] (/private/tmp/backtrace/src/commonMain/kotlin/app.kt:4:5) at 6 example.kexe 0x25fac8 kfun:#bar(){} + 104 (/private/tmp/backtrace/src/commonMain/kotlin/app.kt:2:13) at 7 example.kexe 0x25fa4c kfun:#main(){} + 12 (/private/tmp/backtrace/src/commonMain/kotlin/app.kt:1:14) </div>
<p id="10ba33ec">On Apple targets, which already had file locations and line numbers in stack traces, libbacktrace provides more details for inline function calls:</p>
<ul class="list _bullet" id="de07be8"><li class="list__item" id="a99f5cdb"><p><b id="cc48b405" class="">Before 1.6.20:</b></p></li></ul>
<div class="code-collapse" data-lang="plaintext" data-is-expanded="false" data-anchors="[534d82c3]" data-synopsis="Uncaught Kotlin exception: kotlin.IllegalStateException:">Uncaught Kotlin exception: kotlin.IllegalStateException: at 0 example.kexe 0x10a85a8f8 kfun:kotlin.Throwable#&lt;init&gt;(kotlin.String?){} + 88 (/opt/buildAgent/work/c3a91df21e46e2c8/kotlin/kotlin-native/runtime/src/main/kotlin/kotlin/Throwable.kt:24:37) at 1 example.kexe 0x10a855846 kfun:kotlin.Exception#&lt;init&gt;(kotlin.String?){} + 86 (/opt/buildAgent/work/c3a91df21e46e2c8/kotlin/kotlin-native/runtime/src/main/kotlin/kotlin/Exceptions.kt:23:44) at 2 example.kexe 0x10a855936 kfun:kotlin.RuntimeException#&lt;init&gt;(kotlin.String?){} + 86 (/opt/buildAgent/work/c3a91df21e46e2c8/kotlin/kotlin-native/runtime/src/main/kotlin/kotlin/Exceptions.kt:34:44) at 3 example.kexe 0x10a855c86 kfun:kotlin.IllegalStateException#&lt;init&gt;(kotlin.String?){} + 86 (/opt/buildAgent/work/c3a91df21e46e2c8/kotlin/kotlin-native/runtime/src/main/kotlin/kotlin/Exceptions.kt:70:44) at 4 example.kexe 0x10a8489a5 kfun:#bar(){} + 117 (/private/tmp/backtrace/src/commonMain/kotlin/app.kt:2:1) at 5 example.kexe 0x10a84891c kfun:#main(){} + 12 (/private/tmp/backtrace/src/commonMain/kotlin/app.kt:1:14) ... </div>
<ul class="list _bullet" id="b67d8794"><li class="list__item" id="b0c1bfcd"><p><b id="604bd1b0" class="">1.6.20 with libbacktrace:</b></p></li></ul>
<div class="code-collapse" data-lang="plaintext" data-is-expanded="false" data-anchors="[d45d9ac3]" data-synopsis="Uncaught Kotlin exception: kotlin.IllegalStateException:">Uncaught Kotlin exception: kotlin.IllegalStateException: at 0 example.kexe 0x10669bc88 kfun:kotlin.Throwable#&lt;init&gt;(kotlin.String?){} + 88 (/opt/buildAgent/work/c3a91df21e46e2c8/kotlin/kotlin-native/runtime/src/main/kotlin/kotlin/Throwable.kt:24:37) at 1 example.kexe 0x106696bd6 kfun:kotlin.Exception#&lt;init&gt;(kotlin.String?){} + 86 (/opt/buildAgent/work/c3a91df21e46e2c8/kotlin/kotlin-native/runtime/src/main/kotlin/kotlin/Exceptions.kt:23:44) at 2 example.kexe 0x106696cc6 kfun:kotlin.RuntimeException#&lt;init&gt;(kotlin.String?){} + 86 (/opt/buildAgent/work/c3a91df21e46e2c8/kotlin/kotlin-native/runtime/src/main/kotlin/kotlin/Exceptions.kt:34:44) at 3 example.kexe 0x106697016 kfun:kotlin.IllegalStateException#&lt;init&gt;(kotlin.String?){} + 86 (/opt/buildAgent/work/c3a91df21e46e2c8/kotlin/kotlin-native/runtime/src/main/kotlin/kotlin/Exceptions.kt:70:44) at 4 example.kexe 0x106689d35 kfun:#bar(){} + 117 [inlined] (/opt/buildAgent/work/c3a91df21e46e2c8/kotlin/libraries/stdlib/src/kotlin/util/Preconditions.kt:143:56) &gt;&gt; at 5 example.kexe 0x106689d35 kfun:#bar(){} + 117 [inlined] (/private/tmp/backtrace/src/commonMain/kotlin/app.kt:4:5) at 6 example.kexe 0x106689d35 kfun:#bar(){} + 117 (/private/tmp/backtrace/src/commonMain/kotlin/app.kt:2:13) at 7 example.kexe 0x106689cac kfun:#main(){} + 12 (/private/tmp/backtrace/src/commonMain/kotlin/app.kt:1:14) ... </div>
<p id="918ff9d">To produce better stack traces with libbacktrace, add the following line to <code class="code ">gradle.properties</code>:</p>
<pre class="code" data-language="none"># gradle.properties
kotlin.native.binary.sourceInfoType=libbacktrace
</pre>
<p id="59e162d8">Please tell us how debugging Kotlin/Native with libbacktrace works for you in <a href="https://youtrack.jetbrains.com/issue/KT-48424" id="ac86b6f1" data-external="true" rel="noopener noreferrer">this YouTrack issue</a>.</p></section><section class="chapter"><h3 id="support-for-standalone-android-executables" data-toc="support-for-standalone-android-executables">Support for standalone Android executables</h3>
<p id="a1a66c1b">Previously, Android Native executables in Kotlin/Native were not actually executables but shared libraries that you could use as a NativeActivity. Now there's an option to generate standard executables for Android Native targets.</p>
<p id="18d5a4ef">For that, in the <code class="code ">build.gradle(.kts)</code> part of your project, configure the executable block of your <code class="code ">androidNative</code> target. Add the following binary option:</p>
<pre class="code" data-language="kotlin">kotlin {
    androidNativeX64("android") {
        binaries {
            executable {
                binaryOptions["androidProgramType"] = "standalone"
            }
        }
    }
}
</pre>
<p id="3899983">Note that this feature will become the default in Kotlin 1.7.0. If you want to preserve the current behavior, use the following setting:</p>
<pre class="code" data-language="kotlin">binaryOptions["androidProgramType"] = "nativeActivity"
</pre>
<p id="69f85e3">Thanks to Mattia Iavarone for the <a href="https://github.com/jetbrains/kotlin/pull/4624" id="946e44f5" data-external="true" rel="noopener noreferrer">implementation</a>!</p></section><section class="chapter"><h3 id="performance-improvements" data-toc="performance-improvements">Performance improvements</h3>
<p id="729921e9">We are working hard on Kotlin/Native to <a href="https://youtrack.jetbrains.com/issue/KT-42294" id="6055b92b" data-external="true" rel="noopener noreferrer">speed up the compilation process</a> and improve your developing experience.</p>
<p id="1d976fbc">Kotlin 1.6.20 brings some performance updates and bug fixes that affect the LLVM IR that Kotlin generates. According to the benchmarks on our internal projects, we achieved the following performance boosts on average:</p>
<ul class="list _bullet" id="cad01a31">
<li class="list__item" id="8973db4f"><p>15% reduction in execution time</p></li>
<li class="list__item" id="594eb7f"><p>20% reduction in the code size of both release and debug binaries</p></li>
<li class="list__item" id="d5b6865d"><p>26% reduction in the compilation time of release binaries</p></li>
</ul>
<p id="38c27734">These changes also provide a 10% reduction in compilation time for a debug binary on a large internal project.</p>
<p id="aa6f9a2d">To achieve this, we've implemented static initialization for some of the compiler-generated synthetic objects, improved the way we structure LLVM IR for every function, and optimized the compiler caches.</p></section><section class="chapter"><h3 id="improved-error-handling-during-cinterop-modules-import" data-toc="improved-error-handling-during-cinterop-modules-import">Improved error handling during cinterop modules import</h3>
<p id="cd78932a">This release introduces improved error handling for cases where you import an Objective-C module using the <code class="code ">cinterop</code> tool (as is typical for CocoaPods pods). Previously, if you got an error while trying to work with an Objective-C module (for instance, when dealing with a compilation error in a header), you received an uninformative error message, such as <code class="code ">fatal error: could not build module $name</code>. We expanded upon this part of the <code class="code ">cinterop</code> tool, so you'll get an error message with an extended description.</p></section><section class="chapter"><h3 id="support-for-xcode-13-libraries" data-toc="support-for-xcode-13-libraries">Support for Xcode 13 libraries</h3>
<p id="8eb26811">Libraries delivered with Xcode 13 have full support as of this release. Feel free to access them from anywhere in your Kotlin code.</p></section></section><section class="chapter"><h2 id="kotlin-multiplatform" data-toc="kotlin-multiplatform">Kotlin Multiplatform</h2>
<p id="ef108a75">1.6.20 brings the following notable updates to Kotlin Multiplatform:</p>
<ul class="list _bullet" id="add5d704">
<li class="list__item" id="40941610"><p><a href="#hierarchical-structure-support-for-multiplatform-projects" id="60de9eba">Hierarchical structure support is now default for all new multiplatform projects</a></p></li>
<li class="list__item" id="a2f6edd8"><p><a href="#kotlin-cocoapods-gradle-plugin" id="6fe7f1b6">Kotlin CocoaPods Gradle plugin received several useful features for CocoaPods integration</a></p></li>
</ul>
<section class="chapter"><h3 id="hierarchical-structure-support-for-multiplatform-projects" data-toc="hierarchical-structure-support-for-multiplatform-projects">Hierarchical structure support for multiplatform projects</h3>
<p id="d8fe6e67">Kotlin 1.6.20 comes with hierarchical structure support enabled by default. Since <a href="whatsnew14.html#sharing-code-in-several-targets-with-the-hierarchical-project-structure" id="e189cafb">introducing it in Kotlin 1.4.0</a>, we've significantly improved the frontend and made IDE import stable.</p>
<p id="aa1b04e4">Previously, there were two ways to add code in a multiplatform project. The first was to insert it in a platform-specific source set, which is limited to one target and can't be reused by other platforms. The second is to use a common source set shared across all the platforms that are currently supported by Kotlin.</p>
<p id="4daaf663">Now you can <a href="#better-code-sharing-in-your-project" id="3bb1e927">share source code</a> among several similar native targets that reuse a lot of the common logic and third-party APIs. The technology will provide the correct default dependencies and find the exact API available in the shared code. This eliminates a complex build setup and having to use workarounds to get IDE support for sharing source sets among native targets. It also helps prevent unsafe API usages meant for a different target.</p>
<p id="9ba5b9f3">The technology will come in handy for <a href="#more-opportunities-for-library-authors" id="1fdbe4ff">library authors</a>, too, as a hierarchical project structure allows them to publish and consume libraries with common APIs for a subset of targets.</p>
<p id="e57abc46">By default, libraries published with the hierarchical project structure are compatible only with hierarchical structure projects.</p>
<section class="chapter"><h4 id="better-code-sharing-in-your-project" data-toc="better-code-sharing-in-your-project">Better code-sharing in your project</h4>
<p id="8409c802">Without hierarchical structure support, there is no straightforward way to share code across <em id="251d773e" class="">some</em> but not <em id="74f9f989" class="">all</em> <a href="multiplatform-dsl-reference.html#targets" id="29968ba5">Kotlin targets</a>. One popular example is sharing code across all iOS targets and having access to iOS-specific <a href="multiplatform-share-on-platforms.html#connect-platform-specific-libraries" id="d28156ce">dependencies</a>, like Foundation.</p>
<p id="1487f164">Thanks to the hierarchical project structure support, you can now achieve this out of the box. In the new structure, source sets form a hierarchy. You can use platform-specific language features and dependencies available for each target that a given source set compiles to.</p>
<p id="bf574140">For example, consider a typical multiplatform project with two targets — <code class="code ">iosArm64</code> and <code class="code ">iosX64</code> for iOS devices and simulators. The Kotlin tooling understands that both targets have the same function and allows you to access that function from the intermediate source set, <code class="code ">iosMain</code>.</p>
<figure class=" " id="7de7427a"><img alt="iOS hierarchy example" title="iOS hierarchy example" src="https://kotlinlang.org/docs/images/ios-hierarchy-example.jpg" class=" " width="700" height="312"></figure><p id="65b37de6">The Kotlin toolchain provides the correct default dependencies, like Kotlin/Native stdlib or native libraries. Moreover, Kotlin tooling will try its best to find exactly the API surface area available in the shared code. This prevents such cases as, for example, the use of a macOS-specific function in code shared for Windows.</p></section><section class="chapter"><h4 id="more-opportunities-for-library-authors" data-toc="more-opportunities-for-library-authors">More opportunities for library authors</h4>
<p id="653827f3">When a multiplatform library is published, the API of its intermediate source sets is now properly published alongside it, making it available for consumers. Again, the Kotlin toolchain will automatically figure out the API available in the consumer source set while carefully watching out for unsafe usages, like using an API meant for the JVM in JS code. Learn more about <a href="multiplatform-share-on-platforms.html#share-code-in-libraries" id="d9a446a4">sharing code in libraries</a>.</p></section><section class="chapter"><h4 id="configuration-and-setup" data-toc="configuration-and-setup">Configuration and setup</h4>
<p id="eeff5a8b">Starting with Kotlin 1.6.20, all your new multiplatform projects will have a hierarchical project structure. No additional setup is required.</p>
<ul class="list _bullet" id="c9093a21">
<li class="list__item" id="a716e125">
<p id="37280975">If you've already <a href="multiplatform-share-on-platforms.html#share-code-on-similar-platforms" id="deb6e2df">turned it on manually</a>, you can remove the deprecated options from <code class="code ">gradle.properties</code>:</p>
<pre class="code" data-language="none"># gradle.properties
kotlin.mpp.enableGranularSourceSetsMetadata=true
kotlin.native.enableDependencyPropagation=false // or 'true', depending on your previous setup
</pre>
</li>
<li class="list__item" id="97b5090d"><p id="901abe5e">For Kotlin 1.6.20, we recommend using <a href="https://developer.android.com/studio" id="110ca787" data-external="true" rel="noopener noreferrer">Android Studio 2021.1.1</a> (Bumblebee) or later to get the best experience.</p></li>
<li class="list__item" id="28ec0e0c">
<p id="d3267f34">You can also opt out. To disable hierarchical structure support, set the following options in <code class="code ">gradle.properties</code>:</p>
<pre class="code" data-language="none"># gradle.properties
kotlin.mpp.hierarchicalStructureSupport=false
</pre>
</li>
</ul></section><section class="chapter"><h4 id="leave-your-feedback" data-toc="leave-your-feedback">Leave your feedback</h4>
<p id="5b27771">This is a significant change to the whole ecosystem. We would appreciate your feedback to help make it even better.</p>
<p id="2db92baf">Try it now and report any difficulties you encounter to <a href="https://kotl.in/issue" id="284d13c5" data-external="true" rel="noopener noreferrer">our issue tracker</a>.</p></section></section><section class="chapter"><h3 id="kotlin-cocoapods-gradle-plugin" data-toc="kotlin-cocoapods-gradle-plugin">Kotlin CocoaPods Gradle plugin</h3>
<p id="fb5d2a41">To simplify CocoaPods integration, Kotlin 1.6.20 delivers the following features:</p>
<ul class="list _bullet" id="665afbc9">
<li class="list__item" id="57f74fc2">
<p id="8c4d421b">The CocoaPods plugin now has tasks that build XCFrameworks with all registered targets and generate the Podspec file. This can be useful when you don't want to integrate with Xcode directly, but you want to build artifacts and deploy them to your local CocoaPods repository.</p>
<p id="9850937e">Learn more about <a href="multiplatform-build-native-binaries.html#build-xcframeworks" id="78bf5d95">building XCFrameworks</a>.</p>
</li>
<li class="list__item" id="966a5df5">
<p id="88c1ca1d">If you use <a href="native-cocoapods.html" id="b9a9e47d">CocoaPods integration</a> in your projects, you're used to specifying the required Pod version for the entire Gradle project. Now you have more options:</p>
<ul class="list _bullet" id="bfc9f599">
<li class="list__item" id="a651621b"><p>Specify the Pod version directly in the <code class="code ">cocoapods</code> block</p></li>
<li class="list__item" id="59eca021"><p>Continue using a Gradle project version</p></li>
</ul>
<p id="74384dab">If none of these properties is configured, you'll get an error.</p>
</li>
<li class="list__item" id="5b07658f"><p id="41ffe3b6">You can now configure the CocoaPod name in the <code class="code ">cocoapods</code> block instead of changing the name of the whole Gradle project.</p></li>
<li class="list__item" id="516c14cd"><p id="e8b553c0">The CocoaPods plugin introduces a new <code class="code ">extraSpecAttributes</code> property, which you can use to configure properties in a Podspec file that were previously hard-coded, like <code class="code ">libraries</code> or <code class="code ">vendored_frameworks</code>.</p></li>
</ul>
<pre class="code" data-language="kotlin">kotlin {
    cocoapods {
        version = "1.0"
        name = "MyCocoaPod"
        extraSpecAttributes["social_media_url"] = 'https://twitter.com/kotlin'
        extraSpecAttributes["vendored_frameworks"] = 'CustomFramework.xcframework'
        extraSpecAttributes["libraries"] = 'xml'
    }
}
</pre>
<p id="38e5e056">See the full Kotlin CocoaPods Gradle plugin <a href="native-cocoapods-dsl-reference.html" id="7fae5233">DSL reference</a>.</p></section></section><section class="chapter"><h2 id="kotlin-js" data-toc="kotlin-js">Kotlin/JS</h2>
<p id="d5bd6f4c">Kotlin/JS improvements in 1.6.20 mainly affect the IR compiler:</p>
<ul class="list _bullet" id="72144538">
<li class="list__item" id="60a66b65"><p><a href="#incremental-compilation-for-development-binaries-with-ir-compiler" id="e5b0235b">Incremental compilation for development binaries (IR)</a></p></li>
<li class="list__item" id="d737e0ae"><p><a href="#lazy-initialization-of-top-level-properties-by-default-with-ir-compiler" id="dd07a5cf">Lazy initialization of top-level properties by default (IR)</a></p></li>
<li class="list__item" id="b64877b5"><p><a href="#separate-js-files-for-project-modules-by-default-with-ir-compiler" id="5862d81">Separate JS files for project modules by default (IR)</a></p></li>
<li class="list__item" id="30e69610"><p><a href="#char-class-optimization" id="18d3b68b">Char class optimization (IR)</a></p></li>
<li class="list__item" id="39cee834"><p><a href="#improvements-to-export-and-typescript-declaration-generation" id="40fd02cb">Export improvements (both IR and legacy backends)</a></p></li>
<li class="list__item" id="16b9712e"><p><a href="#aftertest-guarantees-for-asynchronous-tests" id="f6f351a6">@AfterTest guarantees for asynchronous tests</a></p></li>
</ul>
<section class="chapter"><h3 id="incremental-compilation-for-development-binaries-with-ir-compiler" data-toc="incremental-compilation-for-development-binaries-with-ir-compiler">Incremental compilation for development binaries with IR compiler</h3>
<p id="74be23ff">To make Kotlin/JS development with the IR compiler more efficient, we're introducing a new <em id="f7d7f0fb" class="">incremental compilation</em> mode.</p>
<p id="fca163a5">When building <b id="b6c073c5" class="">development binaries</b> with the <code class="code ">compileDevelopmentExecutableKotlinJs</code> Gradle task in this mode, the compiler caches the results of previous compilations on the module level. It uses the cached compilation results for unchanged source files during subsequent compilations, making them complete more quickly, especially with small changes. Note that this improvement exclusively targets the development process (shortening the edit-build-debug cycle) and doesn't affect the building of production artifacts.</p>
<p id="85cf7515">To enable incremental compilation for development binaries, add the following line to the project's <code class="code ">gradle.properties</code>:</p>
<pre class="code" data-language="none"># gradle.properties
kotlin.incremental.js.ir=true // false by default
</pre>
<p id="57617c55">In our test projects, the new mode made incremental compilation up to 30% faster. However, the clean build in this mode became slower because of the need to create and populate the caches.</p>
<p id="a990c544">Please tell us what you think of using incremental compilation with your Kotlin/JS projects in <a href="https://youtrack.jetbrains.com/issue/KT-50203" id="5791aad" data-external="true" rel="noopener noreferrer">this YouTrack issue</a>.</p></section><section class="chapter"><h3 id="lazy-initialization-of-top-level-properties-by-default-with-ir-compiler" data-toc="lazy-initialization-of-top-level-properties-by-default-with-ir-compiler">Lazy initialization of top-level properties by default with IR compiler</h3>
<p id="36c29179">In Kotlin 1.4.30, we presented a prototype of <a href="whatsnew1430.html#lazy-initialization-of-top-level-properties" id="5d70fd9b">lazy initialization of top-level properties</a> in the JS IR compiler. By eliminating the need to initialize all properties when the application launches, lazy initialization reduces the startup time. Our measurements showed about a 10% speed-up on a real-life Kotlin/JS application.</p>
<p id="df1194fd">Now, having polished and properly tested this mechanism, we're making lazy initialization the default for top-level properties in the IR compiler.</p>
<pre class="code" data-language="kotlin">// lazy initialization
val a = run {
    val result = // intensive computations
        println(result)
    result
} // run is executed upon the first usage of the variable
</pre>
<p id="828ca001">If for some reason you need to initialize a property eagerly (upon the application start), mark it with the <a href="../api/latest/jvm/stdlib/kotlin.native/-eager-initialization/index.html" id="43945f4c" data-external="true" rel="noopener noreferrer"><code class="code ">@EagerInitialization</code></a> annotation.</p></section><section class="chapter"><h3 id="separate-js-files-for-project-modules-by-default-with-ir-compiler" data-toc="separate-js-files-for-project-modules-by-default-with-ir-compiler">Separate JS files for project modules by default with IR compiler</h3>
<p id="2b7fd45e">Previously, the JS IR compiler offered an <a href="https://youtrack.jetbrains.com/issue/KT-44319" id="2164793b" data-external="true" rel="noopener noreferrer">ability to generate separate <code class="code ">.js</code> files</a> for project modules. This was an alternative to the default option – a single <code class="code ">.js</code> file for the whole project. This file might be too large and inconvenient to use, because whenever you want to use a function from your project, you have to include the entire JS file as a dependency. Having multiple files adds flexibility and decreases the size of such dependencies. This feature was available with the <code class="code ">-Xir-per-module</code> compiler option.</p>
<p id="51f7d4cf">Starting from 1.6.20, the JS IR compiler generates separate <code class="code ">.js</code> files for project modules by default.</p>
<p id="cf592149">Compiling the project into a single <code class="code ">.js</code> file is now available with the following Gradle property:</p>
<pre class="code" data-language="none"># gradle.properties
kotlin.js.ir.output.granularity=whole-program // `per-module` is the default
</pre>
<p id="c43043b0">In previous releases, the experimental per-module mode (available via the <code class="code ">-Xir-per-module=true</code> flag) invoked <code class="code ">main()</code> functions in each module. This is inconsistent with the regular single <code class="code ">.js</code> mode. Starting with 1.6.20, the <code class="code ">main()</code> function will be invoked in the main module only in both cases. If you do need to run some code when a module is loaded, you can use top-level properties annotated with the <code class="code ">@EagerInitialization</code> annotation. See <a href="#lazy-initialization-of-top-level-properties-by-default-with-ir-compiler" id="d98aac76">Lazy initialization of top-level properties by default (IR)</a>.</p></section><section class="chapter"><h3 id="char-class-optimization" data-toc="char-class-optimization">Char class optimization</h3>
<p id="529cb153">The <code class="code ">Char</code> class is now handled by the Kotlin/JS compiler without introducing boxing (similar to <a href="inline-classes.html" id="419628ca">inline classes</a>). This speeds up operations on chars in Kotlin/JS code.</p>
<p id="e53a39ab">Aside from the performance improvement, this changes the way <code class="code ">Char</code> is exported to JavaScript: it's now translated to <code class="code ">Number</code>.</p></section><section class="chapter"><h3 id="improvements-to-export-and-typescript-declaration-generation" data-toc="improvements-to-export-and-typescript-declaration-generation">Improvements to export and TypeScript declaration generation</h3>
<p id="958b2781">Kotlin 1.6.20 is bringing multiple fixes and improvements to the export mechanism (the <a href="../api/latest/jvm/stdlib/kotlin.js/-js-export/index.html" id="1de870ab" data-external="true" rel="noopener noreferrer"><code class="code ">@JsExport</code></a> annotation), including the <a href="js-ir-compiler.html#preview-generation-of-typescript-declaration-files-d-ts" id="a20cd1d8">generation of TypeScript declarations (<code class="code ">.d.ts</code>)</a>. We've added the ability to export interfaces and enums, and we've fixed the export behavior in some corner cases that were reported to us previously. For more details, see the <a href="https://youtrack.jetbrains.com/issues?q=Project:%20Kotlin%20issue%20id:%20KT-45434,%20KT-44494,%20KT-37916,%20KT-43191,%20KT-46961,%20KT-40236" id="88ccef69" data-external="true" rel="noopener noreferrer">list of export improvements in YouTrack</a>.</p>
<p id="ed338089">Learn more about <a href="js-to-kotlin-interop.html" id="d74509e6">using Kotlin code from JavaScript</a>.</p></section><section class="chapter"><h3 id="aftertest-guarantees-for-asynchronous-tests" data-toc="aftertest-guarantees-for-asynchronous-tests">@AfterTest guarantees for asynchronous tests</h3>
<p id="cff704a1">Kotlin 1.6.20 makes <a href="https://kotlinlang.org/api/latest/kotlin.test/kotlin.test/-after-test/" id="8e89029" data-external="true" rel="noopener noreferrer"><code class="code ">@AfterTest</code></a> functions work properly with asynchronous tests on Kotlin/JS. If a test function's return type is statically resolved to <a href="../api/latest/jvm/stdlib/kotlin.js/-promise/index.html" id="5b3bb7b7" data-external="true" rel="noopener noreferrer"><code class="code ">Promise</code></a>, the compiler now schedules the execution of the <code class="code ">@AfterTest</code> function to the corresponding <a href="../api/latest/jvm/stdlib/kotlin.js/-promise/then.html" id="9f9479f7" data-external="true" rel="noopener noreferrer"><code class="code ">then()</code></a> callback.</p></section></section><section class="chapter"><h2 id="security" data-toc="security">Security</h2>
<p id="aecc1c1e">Kotlin 1.6.20 introduces a couple of features to improve the security of your code:</p>
<ul class="list _bullet" id="c086be87">
<li class="list__item" id="bbc9cc58"><p><a href="#using-relative-paths-in-klibs" id="a4ff62b9">Using relative paths in klibs</a></p></li>
<li class="list__item" id="4d3cd18c"><p><a href="#persisting-yarn-lock-for-kotlin-js-gradle-projects" id="c30edaf8">Persisting yarn.lock for Kotlin/JS Gradle projects</a></p></li>
<li class="list__item" id="a8613bc7"><p><a href="#installation-of-npm-dependencies-with-ignore-scripts-by-default" id="b34f21dd">Installation of npm dependencies with <code class="code ">--ignore-scripts</code> by default</a></p></li>
</ul>
<section class="chapter"><h3 id="using-relative-paths-in-klibs" data-toc="using-relative-paths-in-klibs">Using relative paths in klibs</h3>
<p id="de55acf4">A library in <code class="code ">klib</code> format <a href="native-libraries.html#library-format" id="bd0a46d5">contains</a> a serialized IR representation of source files, which also includes their paths for generating proper debug information. Before Kotlin 1.6.20, stored file paths were absolute. Since the library author may not want to share absolute paths, the 1.6.20 version comes with an alternative option.</p>
<p id="a1698b49">If you are publishing a <code class="code ">klib</code> and want to use only relative paths of source files in the artifact, you can now pass the <code class="code ">-Xklib-relative-path-base</code> compiler option with one or multiple base paths of source files:</p>
<div class="tabs" id="f32ed68a" data-group="build-script" data-anchors="[7ceb191,3c41a8b1,ace9a51,5d68a436,f32ed68a]">
<div class="tabs__content" data-gtm="tab" id="7ceb191" data-sync-tabs="kotlin" data-title="Kotlin"><pre class="code" data-language="kotlin">tasks.withType(org.jetbrains.kotlin.gradle.dsl.KotlinCompile::class).configureEach {
    // $base is a base path of source files
    kotlinOptions.freeCompilerArgs += "-Xklib-relative-path-base=$base"
}
</pre></div>
<div class="tabs__content" data-gtm="tab" id="ace9a51" data-sync-tabs="groovy" data-title="Groovy"><pre class="code" data-language="groovy">tasks.withType(org.jetbrains.kotlin.gradle.dsl.KotlinCompile).configureEach {
    kotlinOptions {
        // $base is a base path of source files
        freeCompilerArgs += "-Xklib-relative-path-base=$base"
    }
}
</pre></div>
</div></section><section class="chapter"><h3 id="persisting-yarn-lock-for-kotlin-js-gradle-projects" data-toc="persisting-yarn-lock-for-kotlin-js-gradle-projects">Persisting yarn.lock for Kotlin/JS Gradle projects</h3>
<aside data-type="note" class="prompt" data-title="" id="d43681e7"><p id="2450d86e">The feature was backported to Kotlin 1.6.10.</p></aside><p id="35f788ce">The Kotlin/JS Gradle plugin now provides an ability to persist the <code class="code ">yarn.lock</code> file, making it possible to lock the versions of the npm dependencies for your project without additional Gradle configuration. The feature brings changes to the default project structure by adding the auto-generated <code class="code ">kotlin-js-store</code> directory to the project root. It holds the <code class="code ">yarn.lock</code> file inside.</p>
<p id="c3b5225f">We strongly recommend committing the <code class="code ">kotlin-js-store</code> directory and its contents to your version control system. Committing lockfiles to your version control system is a <a href="https://classic.yarnpkg.com/blog/2016/11/24/lockfiles-for-all/" id="43651def" data-external="true" rel="noopener noreferrer">recommended practice</a> because it ensures your application is being built with the exact same dependency tree on all machines, regardless of whether those are development environments on other machines or CI/CD services. Lockfiles also prevent your npm dependencies from being silently updated when a project is checked out on a new machine, which is a security concern.</p>
<p id="d6956789">Tools like <a href="https://github.com/dependabot" id="f50a9a8f" data-external="true" rel="noopener noreferrer">Dependabot</a> can also parse the <code class="code ">yarn.lock</code> files of your Kotlin/JS projects, and provide you with warnings if any npm package you depend on is compromised.</p>
<p id="5a8b188a">If needed, you can change both directory and lockfile names in the build script:</p>
<div class="tabs" id="1cb0f088" data-group="build-script" data-anchors="[c7071aec,e0f48775,aa8430f,b96441f9,1cb0f088]">
<div class="tabs__content" data-gtm="tab" id="c7071aec" data-sync-tabs="kotlin" data-title="Kotlin"><pre class="code" data-language="kotlin">rootProject.plugins.withType&lt;org.jetbrains.kotlin.gradle.targets.js.yarn.YarnPlugin&gt; {
    rootProject.the&lt;org.jetbrains.kotlin.gradle.targets.js.yarn.YarnRootExtension&gt;().lockFileDirectory =
        project.rootDir.resolve("my-kotlin-js-store")
    rootProject.the&lt;org.jetbrains.kotlin.gradle.targets.js.yarn.YarnRootExtension&gt;().lockFileName = "my-yarn.lock"
}
</pre></div>
<div class="tabs__content" data-gtm="tab" id="aa8430f" data-sync-tabs="groovy" data-title="Groovy"><pre class="code" data-language="groovy">rootProject.plugins.withType(org.jetbrains.kotlin.gradle.targets.js.yarn.YarnPlugin) {
    rootProject.extensions.getByType(org.jetbrains.kotlin.gradle.targets.js.yarn.YarnRootExtension).lockFileDirectory =
        file("my-kotlin-js-store")
    rootProject.extensions.getByType(org.jetbrains.kotlin.gradle.targets.js.yarn.YarnRootExtension).lockFileName = 'my-yarn.lock'
}
</pre></div>
</div>
<aside data-type="warning" class="prompt" data-title="" id="499a3ac7"><p id="7e1ccb2a">Changing the name of the lockfile may cause dependency inspection tools to no longer pick up the file.</p></aside></section><section class="chapter"><h3 id="installation-of-npm-dependencies-with-ignore-scripts-by-default" data-toc="installation-of-npm-dependencies-with-ignore-scripts-by-default">Installation of npm dependencies with --ignore-scripts by default</h3>
<aside data-type="note" class="prompt" data-title="" id="41045546"><p id="4acad608">The feature was backported to Kotlin 1.6.10.</p></aside><p id="edd1af37">The Kotlin/JS Gradle plugin now prevents the execution of <a href="https://docs.npmjs.com/cli/v8/using-npm/scripts#life-cycle-scripts" id="269d012c" data-external="true" rel="noopener noreferrer">lifecycle scripts</a> during the installation of npm dependencies by default. The change is aimed at reducing the likelihood of executing malicious code from compromised npm packages.</p>
<p id="e583109a">To roll back to the old configuration, you can explicitly enable lifecycle scripts execution by adding the following lines to <code class="code ">build.gradle(.kts)</code>:</p>
<div class="tabs" id="b8f37764" data-group="build-script" data-anchors="[d7d0f771,3f9b0ffb,810368a7,97580901,b8f37764]">
<div class="tabs__content" data-gtm="tab" id="d7d0f771" data-sync-tabs="kotlin" data-title="Kotlin"><pre class="code" data-language="kotlin">rootProject.plugins.withType&lt;org.jetbrains.kotlin.gradle.targets.js.yarn.YarnPlugin&gt; {
    rootProject.the&lt;org.jetbrains.kotlin.gradle.targets.js.yarn.YarnRootExtension&gt;().ignoreScripts = false
}
</pre></div>
<div class="tabs__content" data-gtm="tab" id="810368a7" data-sync-tabs="groovy" data-title="Groovy"><pre class="code" data-language="groovy">rootProject.plugins.withType(org.jetbrains.kotlin.gradle.targets.js.yarn.YarnPlugin) {
    rootProject.extensions.getByType(org.jetbrains.kotlin.gradle.targets.js.yarn.YarnRootExtension).ignoreScripts = false
}
</pre></div>
</div>
<p id="2cf190db">Learn more about <a href="js-project-setup.html#npm-dependencies" id="f90f3206">npm dependencies of a Kotlin/JS Gradle project</a>.</p></section></section><section class="chapter"><h2 id="gradle" data-toc="gradle">Gradle</h2>
<p id="22895706">Kotlin 1.6.20 brings the following changes for the Kotlin Gradle Plugin:</p>
<ul class="list _bullet" id="d61c411a">
<li class="list__item" id="fad860a9"><p>New <a href="#properties-for-defining-kotlin-compiler-execution-strategy" id="14d20162">properties <code class="code ">kotlin.compiler.execution.strategy</code> and <code class="code ">compilerExecutionStrategy</code></a> for defining a Kotlin compiler execution strategy</p></li>
<li class="list__item" id="e29d092f"><p><a href="#deprecation-of-build-options-for-kapt-and-coroutines" id="250cbf6c">Deprecation of the options <code class="code ">kapt.use.worker.api</code>, <code class="code ">kotlin.experimental.coroutines</code>, and <code class="code ">kotlin.coroutines</code></a></p></li>
<li class="list__item" id="8eb9f515"><p><a href="#removal-of-the-kotlin-parallel-tasks-in-project-build-option" id="e5c4ec">Removal of the <code class="code ">kotlin.parallel.tasks.in.project</code> build option</a></p></li>
</ul>
<section class="chapter"><h3 id="properties-for-defining-kotlin-compiler-execution-strategy" data-toc="properties-for-defining-kotlin-compiler-execution-strategy">Properties for defining Kotlin compiler execution strategy</h3>
<p id="d1c280d">Before Kotlin 1.6.20, you used the system property <code class="code ">-Dkotlin.compiler.execution.strategy</code> to define a Kotlin compiler execution strategy. This property might have been inconvenient in some cases. Kotlin 1.6.20 introduces a Gradle property with the same name, <code class="code ">kotlin.compiler.execution.strategy</code>, and the compile task property <code class="code ">compilerExecutionStrategy</code>.</p>
<p id="5fb3003f">The system property still works, but it will be removed in future releases.</p>
<p id="1163c216">The current priority of properties is the following:</p>
<ul class="list _bullet" id="82852c99">
<li class="list__item" id="d61c791e"><p>The task property <code class="code ">compilerExecutionStrategy</code> takes priority over the system property and the Gradle property <code class="code ">kotlin.compiler.execution.strategy</code>.</p></li>
<li class="list__item" id="64f1a028"><p>The Gradle property takes priority over the system property.</p></li>
</ul>
<p id="79d2bbcb">There are three compiler execution strategies that you can assign to these properties:</p>
<div class="table-wrapper"><table class=" wide" id="a854e66b">
<thead><tr class="ijRowHead" id="1f68d349">
<th id="d8bd6a73"><p>Strategy</p></th>
<th id="3c9ab23e"><p>Where Kotlin compiler is executed</p></th>
<th id="8bdde7f0"><p>Incremental compilation</p></th>
<th id="a250689f"><p>Other characteristics</p></th>
</tr></thead>
<tbody>
<tr class="" id="5adedb9b">
<td id="29f6f5b3"><p>Daemon</p></td>
<td id="a086ee22"><p>Inside its own daemon process</p></td>
<td id="facc3ff5"><p>Yes</p></td>
<td id="8807b4f1"><p><em id="86d290de" class="">The default strategy</em>. Can be shared between different Gradle daemons</p></td>
</tr>
<tr class="" id="776cf33f">
<td id="b2004546"><p>In process</p></td>
<td id="c09482cb"><p>Inside the Gradle daemon process</p></td>
<td id="508eb730"><p>No</p></td>
<td id="61a06b2b"><p>May share the heap with the Gradle daemon</p></td>
</tr>
<tr class="" id="3ab67447">
<td id="da373f9b"><p>Out of process</p></td>
<td id="df9e2c58"><p>In a separate process for each call</p></td>
<td id="3100eea9"><p>No</p></td>
<td id="56a77585"><p>—</p></td>
</tr>
</tbody>
</table></div>
<p id="9240943d">Accordingly, the available values for <code class="code ">kotlin.compiler.execution.strategy</code> properties (both system and Gradle's) are:</p>
<ol class="list _decimal" id="244be5c5" type="1">
<li class="list__item" id="80cd69ce"><p><code class="code ">daemon</code> (default)</p></li>
<li class="list__item" id="fc5c8208"><p><code class="code ">in-process</code></p></li>
<li class="list__item" id="278d87d0"><p><code class="code ">out-of-process</code></p></li>
</ol>
<p id="4b541256">Use the Gradle property <code class="code ">kotlin.compiler.execution.strategy</code> in <code class="code ">gradle.properties</code>:</p>
<pre class="code" data-language="none"># gradle.properties
kotlin.compiler.execution.strategy=out-of-process
</pre>
<p id="b2feb1d0">The available values for the <code class="code ">compilerExecutionStrategy</code> task property are:</p>
<ol class="list _decimal" id="8ec35abd" type="1">
<li class="list__item" id="a2022a94"><p><code class="code ">org.jetbrains.kotlin.gradle.tasks.KotlinCompilerExecutionStrategy.DAEMON</code> (default)</p></li>
<li class="list__item" id="d06369df"><p><code class="code ">org.jetbrains.kotlin.gradle.tasks.KotlinCompilerExecutionStrategy.IN_PROCESS</code></p></li>
<li class="list__item" id="5fcc98b1"><p><code class="code ">org.jetbrains.kotlin.gradle.tasks.KotlinCompilerExecutionStrategy.OUT_OF_PROCESS</code></p></li>
</ol>
<p id="2538f90f">Use the task property <code class="code ">compilerExecutionStrategy</code> in the <code class="code ">build.gradle.kts</code> build script:</p>
<pre class="code" data-language="kotlin">import org.jetbrains.kotlin.gradle.dsl.KotlinCompile
import org.jetbrains.kotlin.gradle.tasks.KotlinCompilerExecutionStrategy

// ...

tasks.withType&lt;KotlinCompile&gt;().configureEach {
    compilerExecutionStrategy.set(KotlinCompilerExecutionStrategy.IN_PROCESS)
}
</pre>
<p id="602e089c">Please leave your feedback in <a href="https://youtrack.jetbrains.com/issue/KT-49299" id="b7da3ca6" data-external="true" rel="noopener noreferrer">this YouTrack task</a>.</p></section><section class="chapter"><h3 id="deprecation-of-build-options-for-kapt-and-coroutines" data-toc="deprecation-of-build-options-for-kapt-and-coroutines">Deprecation of build options for kapt and coroutines</h3>
<p id="b4cf787d">In Kotlin 1.6.20, we changed deprecation levels of the properties:</p>
<ul class="list _bullet" id="904ca6bf">
<li class="list__item" id="5d5b970">
<p id="48262088">We deprecated the ability to run <a href="kapt.html" id="47d7884f">kapt</a> via the Kotlin daemon with <code class="code ">kapt.use.worker.api</code> – now it produces a warning to Gradle's output. By default, <a href="kapt.html#running-kapt-tasks-in-parallel" id="bf991464">kapt has been using Gradle workers</a> since the 1.3.70 release, and we recommend sticking to this method.</p>
<p id="4be63bf7">We are going to remove the option <code class="code ">kapt.use.worker.api</code> in future releases.</p>
</li>
<li class="list__item" id="a49358bd">
<p id="de0651f5">We deprecated the <code class="code ">kotlin.experimental.coroutines</code> Gradle DSL option and the <code class="code ">kotlin.coroutines</code> property used in <code class="code ">gradle.properties</code>. Just use <em id="6aa06937" class="">suspending functions</em> or <a href="gradle-configure-project.html#set-a-dependency-on-a-kotlinx-library" id="a7933eaa">add the <code class="code ">kotlinx.coroutines</code> dependency</a> to your <code class="code ">build.gradle(.kts)</code> file.</p>
<p id="5aa41a09">Learn more about coroutines in the <a href="coroutines-guide.html" id="2586166">Coroutines guide</a>.</p>
</li>
</ul></section><section class="chapter"><h3 id="removal-of-the-kotlin-parallel-tasks-in-project-build-option" data-toc="removal-of-the-kotlin-parallel-tasks-in-project-build-option">Removal of the kotlin.parallel.tasks.in.project build option</h3>
<p id="d8a65c5a">In Kotlin 1.5.20, we announced <a href="whatsnew1520.html#deprecation-of-the-kotlin-parallel-tasks-in-project-build-property" id="fa858f1">the deprecation of the build option <code class="code ">kotlin.parallel.tasks.in.project</code></a>. This option has been removed in Kotlin 1.6.20.</p>
<p id="f870b128">Depending on the project, parallel compilation in the Kotlin daemon may require more memory. To reduce memory consumption, <a href="gradle-compilation-and-caches.html#setting-kotlin-daemon-s-jvm-arguments" id="57981db2">increase the heap size for the Kotlin daemon</a>.</p>
<p id="7e171afa">Learn more about the <a href="gradle-compiler-options.html" id="9cc7afca">currently supported compiler options</a> in the Kotlin Gradle plugin.</p></section></section><div class="last-modified"> Last modified: 25 May 2023</div>

<div class="navigation-links _bottom"> <a class="navigation-links__prev" href="whatsnew17.html">What's new in Kotlin 1.7.0</a> <a class="navigation-links__next" href="whatsnew16.html">What's new in Kotlin 1.6.0</a> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2010&ndash;2023 JetBrains s.r.o. and Kotlin Programming Language contributors<br>Licensed under the Apache License, Version 2.0.<br>
    <a href="https://kotlinlang.org/docs/whatsnew1620.html" class="_attribution-link">https://kotlinlang.org/docs/whatsnew1620.html</a>
  </p>
</div>
