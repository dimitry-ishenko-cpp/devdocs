<h1 id="twig-internals">Twig Internals</h1> <p>Twig is very extensible and you can hack it. Keep in mind that you should probably try to create an extension before hacking the core, as most features and enhancements can be handled with extensions. This chapter is also useful for people who want to understand how Twig works under the hood.</p>  <h2 id="how-does-twig-work">How does Twig work?</h2> <p>The rendering of a Twig template can be summarized into four key steps:</p> <ul class="simple"> <li>
<strong>Load</strong> the template: If the template is already compiled, load it and go to the <em>evaluation</em> step, otherwise:<ul> <li>First, the <strong>lexer</strong> tokenizes the template source code into small pieces for easier processing;</li> <li>Then, the <strong>parser</strong> converts the token stream into a meaningful tree of nodes (the Abstract Syntax Tree);</li> <li>Finally, the <em>compiler</em> transforms the AST into PHP code.</li> </ul> </li> <li>
<strong>Evaluate</strong> the template: It means calling the <code class="docutils literal notranslate"><span class="pre">display()</span></code> method of the compiled template and passing it the context.</li> </ul>   <h2 id="the-lexer">The Lexer</h2> <p>The lexer tokenizes a template source code into a token stream (each token is an instance of <code class="docutils literal notranslate"><span class="pre">\Twig\Token</span></code>, and the stream is an instance of <code class="docutils literal notranslate"><span class="pre">\Twig\TokenStream</span></code>). The default lexer recognizes 13 different token types:</p> <ul class="simple"> <li>
<code class="docutils literal notranslate"><span class="pre">\Twig\Token::BLOCK_START_TYPE</span></code>, <code class="docutils literal notranslate"><span class="pre">\Twig\Token::BLOCK_END_TYPE</span></code>: Delimiters for blocks (<code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">%}</span></code>)</li> <li>
<code class="docutils literal notranslate"><span class="pre">\Twig\Token::VAR_START_TYPE</span></code>, <code class="docutils literal notranslate"><span class="pre">\Twig\Token::VAR_END_TYPE</span></code>: Delimiters for variables (<code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">}}</span></code>)</li> <li>
<code class="docutils literal notranslate"><span class="pre">\Twig\Token::TEXT_TYPE</span></code>: A text outside an expression;</li> <li>
<code class="docutils literal notranslate"><span class="pre">\Twig\Token::NAME_TYPE</span></code>: A name in an expression;</li> <li>
<code class="docutils literal notranslate"><span class="pre">\Twig\Token::NUMBER_TYPE</span></code>: A number in an expression;</li> <li>
<code class="docutils literal notranslate"><span class="pre">\Twig\Token::STRING_TYPE</span></code>: A string in an expression;</li> <li>
<code class="docutils literal notranslate"><span class="pre">\Twig\Token::OPERATOR_TYPE</span></code>: An operator;</li> <li>
<code class="docutils literal notranslate"><span class="pre">\Twig\Token::PUNCTUATION_TYPE</span></code>: A punctuation sign;</li> <li>
<code class="docutils literal notranslate"><span class="pre">\Twig\Token::INTERPOLATION_START_TYPE</span></code>, <code class="docutils literal notranslate"><span class="pre">\Twig\Token::INTERPOLATION_END_TYPE</span></code>: Delimiters for string interpolation;</li> <li>
<code class="docutils literal notranslate"><span class="pre">\Twig\Token::EOF_TYPE</span></code>: Ends of template.</li> </ul> <p>You can manually convert a source code into a token stream by calling the <code class="docutils literal notranslate"><span class="pre">tokenize()</span></code> method of an environment:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="nv">$stream</span> <span class="o">=</span> <span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">tokenize</span><span class="p">(</span><span class="k">new</span> <span class="nx">\Twig\Source</span><span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="nv">$identifier</span><span class="p">));</span>
</pre></div> </div> <p>As the stream has a <code class="docutils literal notranslate"><span class="pre">__toString()</span></code> method, you can have a textual representation of it by echoing the object:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="k">echo</span> <span class="nv">$stream</span><span class="o">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
</pre></div> </div> <p>Here is the output for the <code class="docutils literal notranslate"><span class="pre">Hello</span> <span class="pre">{{</span> <span class="pre">name</span> <span class="pre">}}</span></code> template:</p> <div class="highlight-text notranslate"><pre data-language="php" class="highlight">TEXT_TYPE(Hello )
VAR_START_TYPE()
NAME_TYPE(name)
VAR_END_TYPE()
EOF_TYPE()
</pre></div> <div class="admonition note"> <p class="first admonition-title">Note</p> <p>The default lexer (<code class="docutils literal notranslate"><span class="pre">\Twig\Lexer</span></code>) can be changed by calling the <code class="docutils literal notranslate"><span class="pre">setLexer()</span></code> method:</p> <div class="last highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">setLexer</span><span class="p">(</span><span class="nv">$lexer</span><span class="p">);</span>
</pre></div> </div> </div>   <h2 id="the-parser">The Parser</h2> <p>The parser converts the token stream into an AST (Abstract Syntax Tree), or a node tree (an instance of <code class="docutils literal notranslate"><span class="pre">\Twig\Node\ModuleNode</span></code>). The core extension defines the basic nodes like: <code class="docutils literal notranslate"><span class="pre">for</span></code>, <code class="docutils literal notranslate"><span class="pre">if</span></code>, … and the expression nodes.</p> <p>You can manually convert a token stream into a node tree by calling the <code class="docutils literal notranslate"><span class="pre">parse()</span></code> method of an environment:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="nv">$nodes</span> <span class="o">=</span> <span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">parse</span><span class="p">(</span><span class="nv">$stream</span><span class="p">);</span>
</pre></div> </div> <p>Echoing the node object gives you a nice representation of the tree:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="k">echo</span> <span class="nv">$nodes</span><span class="o">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
</pre></div> </div> <p>Here is the output for the <code class="docutils literal notranslate"><span class="pre">Hello</span> <span class="pre">{{</span> <span class="pre">name</span> <span class="pre">}}</span></code> template:</p> <div class="highlight-text notranslate"><pre data-language="php" class="highlight">\Twig\Node\ModuleNode(
  \Twig\Node\TextNode(Hello )
  \Twig\Node\PrintNode(
    \Twig\Node\Expression\NameExpression(name)
  )
)
</pre></div> <div class="admonition note"> <p class="first admonition-title">Note</p> <p>The default parser (<code class="docutils literal notranslate"><span class="pre">\Twig\TokenParser\AbstractTokenParser</span></code>) can be changed by calling the <code class="docutils literal notranslate"><span class="pre">setParser()</span></code> method:</p> <div class="last highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">setParser</span><span class="p">(</span><span class="nv">$parser</span><span class="p">);</span>
</pre></div> </div> </div>   <h2 id="the-compiler">The Compiler</h2> <p>The last step is done by the compiler. It takes a node tree as an input and generates PHP code usable for runtime execution of the template.</p> <p>You can manually compile a node tree to PHP code with the <code class="docutils literal notranslate"><span class="pre">compile()</span></code> method of an environment:</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="nv">$php</span> <span class="o">=</span> <span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">compile</span><span class="p">(</span><span class="nv">$nodes</span><span class="p">);</span>
</pre></div> </div> <p>The generated template for a <code class="docutils literal notranslate"><span class="pre">Hello</span> <span class="pre">{{</span> <span class="pre">name</span> <span class="pre">}}</span></code> template reads as follows (the actual output can differ depending on the version of Twig you are using):</p> <div class="highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="cm">/* Hello {{ name }} */</span>
<span class="k">class</span> <span class="nc">__TwigTemplate_1121b6f109fe93ebe8c6e22e3712bceb</span> <span class="k">extends</span> <span class="nx">Template</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">doDisplay</span><span class="p">(</span><span class="k">array</span> <span class="nv">$context</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$blocks</span> <span class="o">=</span> <span class="p">[])</span>
    <span class="p">{</span>
        <span class="c1">// line 1</span>
        <span class="k">echo</span> <span class="s2">"Hello "</span><span class="p">;</span>
        <span class="k">echo</span> <span class="nx">twig_escape_filter</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">env</span><span class="p">,</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$context</span><span class="p">[</span><span class="s2">"name"</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$context</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">:</span> <span class="k">null</span><span class="p">),</span> <span class="s2">"html"</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// some more code</span>
<span class="p">}</span>
</pre></div> </div> <div class="admonition note"> <p class="first admonition-title">Note</p> <p>The default compiler (<code class="docutils literal notranslate"><span class="pre">\Twig\Compiler</span></code>) can be changed by calling the <code class="docutils literal notranslate"><span class="pre">setCompiler()</span></code> method:</p> <div class="last highlight-php notranslate">
<div class="highlight"><pre data-language="php" class="highlight"><span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">setCompiler</span><span class="p">(</span><span class="nv">$compiler</span><span class="p">);</span>
</pre></div> </div> </div>    <div class="navigation" style="text-align: center"> <a accesskey="P" title="Extending Twig" href="advanced.html"> « Extending Twig </a> <span class="separator">|</span> <a accesskey="N" title="Deprecated Features" href="https://twig.symfony.com/doc/3.x/deprecated.html"> Deprecated Features » </a> </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2009&ndash;2018 by the Twig Team<br>Licensed under the three clause BSD license.<br>The Twig logo is &copy; 2010&ndash;2020 Symfony<br>
    <a href="https://twig.symfony.com/doc/3.x/internals.html" class="_attribution-link">https://twig.symfony.com/doc/3.x/internals.html</a>
  </p>
</div>
