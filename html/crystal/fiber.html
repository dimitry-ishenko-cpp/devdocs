<h1 class="type-name"> class Fiber </h1> <ul class="superclass-hierarchy">
<li class="superclass"><a href="fiber.html">Fiber</a></li>
<li class="superclass"><a href="reference.html">Reference</a></li>
<li class="superclass"><a href="object.html">Object</a></li>
</ul> <h2>  Overview </h2> <p>A <code><a href="fiber.html">Fiber</a></code> is a light-weight execution unit managed by the Crystal runtime.</p> <p>It is conceptually similar to an operating system thread but with less overhead and completely internal to the Crystal process. The runtime includes a scheduler which schedules execution of fibers.</p> <p>A <code><a href="fiber.html">Fiber</a></code> has a stack size of <code>8 MiB</code> which is usually also assigned to an operating system thread. But only <code>4KiB</code> are actually allocated at first so the memory footprint is very small.</p> <p>Communication between fibers is usually passed through <code><a href="channel.html">Channel</a></code>.</p> <h2>
Cooperative</h2> <p>Fibers are cooperative. That means execution can only be drawn from a fiber when it offers it. It can't be interrupted in its execution at random. In order to make concurrency work, fibers must make sure to occasionally provide hooks for the scheduler to swap in other fibers. IO operations like reading from a file descriptor are natural implementations for this and the developer does not need to take further action on that. When IO access can't be served immediately by a buffer, the fiber will automatically wait and yield execution. When IO is ready it's going to be resumed through the event loop.</p> <p>When a computation-intensive task has none or only rare IO operations, a fiber should explicitly offer to yield execution from time to time using <code><a href="fiber.html#yield%3ANil-class-method">Fiber.yield</a></code> to break up tight loops. The frequency of this call depends on the application and concurrency model.</p> <h2>
Event loop</h2> <p>The event loop is responsible for keeping track of sleeping fibers waiting for notifications that IO is ready or a timeout reached. When a fiber can be woken, the event loop enqueues it in the scheduler</p> <h2>  Defined in: </h2> <a href="https://github.com/crystal-lang/crystal/blob/0aa30372c/src/fiber.cr#L46" target="_blank"> fiber.cr </a> <br> <a href="https://github.com/crystal-lang/crystal/blob/0aa30372c/src/fiber/context.cr#L1" target="_blank"> fiber/context.cr </a> <br> <a href="https://github.com/crystal-lang/crystal/blob/0aa30372c/src/fiber/context/x86_64-sysv.cr#L3" target="_blank"> fiber/context/x86_64-sysv.cr </a> <br> <a href="https://github.com/crystal-lang/crystal/blob/0aa30372c/src/fiber/stack_pool.cr#L3" target="_blank"> fiber/stack_pool.cr </a> <br> <a href="https://github.com/crystal-lang/crystal/blob/0aa30372c/src/log/metadata.cr#L225" target="_blank"> log/metadata.cr </a> <br> <h2>  Constructors </h2> <ul class="list-summary"> <li class="entry-summary"> <a href="#current%3AFiber-class-method" class="signature"><strong>.current</strong> : Fiber</a> <div class="summary"><p>Returns the current fiber.</p></div> </li> <li class="entry-summary"> <a href="#new%28name%3AString%7CNil%3Dnil%2C%26proc%3A-%3E%29-class-method" class="signature"><strong>.new</strong>(name : String | Nil = nil, &amp;proc : -&gt; )</a> <div class="summary"><p>Creates a new <code><a href="fiber.html">Fiber</a></code> instance.</p></div> </li> </ul> <h2>  Class Method Summary </h2> <ul class="list-summary"> <li class="entry-summary"> <a href="#cancel_timeout%3ANil-class-method" class="signature"><strong>.cancel_timeout</strong> : Nil</a> </li> <li class="entry-summary"> <a href="#timeout%28timeout%3ATime%3A%3ASpan%7CNil%2Cselect_action%3AChannel%3A%3ATimeoutAction%7CNil%3Dnil%29%3ANil-class-method" class="signature"><strong>.timeout</strong>(timeout : Time::Span | Nil, select_action : Channel::TimeoutAction | Nil = nil) : Nil</a> <div class="summary"><p>The current fiber will resume after a period of time.</p></div> </li> <li class="entry-summary"> <a href="#yield%3ANil-class-method" class="signature"><strong>.yield</strong> : Nil</a> <div class="summary"><p>Yields to the scheduler and allows it to swap execution to other waiting fibers.</p></div> </li> </ul> <h2>  Instance Method Summary </h2> <ul class="list-summary"> <li class="entry-summary"> <a href="#dead%3F%3ABool-instance-method" class="signature"><strong>#dead?</strong> : Bool</a> <div class="summary"><p>The fiber's proc has terminated, and the fiber is now considered dead.</p></div> </li> <li class="entry-summary"> <a href="#enqueue%3ANil-instance-method" class="signature"><strong>#enqueue</strong> : Nil</a> <div class="summary"><p>Adds this fiber to the scheduler's runnables queue for the current thread.</p></div> </li> <li class="entry-summary"> <a href="#inspect%28io%3AIO%29%3ANil-instance-method" class="signature"><strong>#inspect</strong>(io : IO) : Nil</a> <div class="summary"><p>Appends a String representation of this object which includes its class name, its object address and the values of all instance variables.</p></div> </li> <li class="entry-summary"> <a href="#name%3AString%7CNil-instance-method" class="signature"><strong>#name</strong> : String | Nil</a> <div class="summary"><p>The name of the fiber, used as internal reference.</p></div> </li> <li class="entry-summary"> <a href="#name%3D%28name%3AString%7CNil%29-instance-method" class="signature"><strong>#name=</strong>(name : String | Nil)</a> <div class="summary"><p>The name of the fiber, used as internal reference.</p></div> </li> <li class="entry-summary"> <a href="#resumable%3F%3ABool-instance-method" class="signature"><strong>#resumable?</strong> : Bool</a> <div class="summary"><p>The fiber's proc is currently not running and fully saved its context.</p></div> </li> <li class="entry-summary"> <a href="#resume%3ANil-instance-method" class="signature"><strong>#resume</strong> : Nil</a> <div class="summary"><p>Immediately resumes execution of this fiber.</p></div> </li> <li class="entry-summary"> <a href="#running%3F%3ABool-instance-method" class="signature"><strong>#running?</strong> : Bool</a> <div class="summary"><p>The fiber's proc is currently running or didn't fully save its context.</p></div> </li> <li class="entry-summary"> <a href="#to_s%28io%3AIO%29%3ANil-instance-method" class="signature"><strong>#to_s</strong>(io : IO) : Nil</a> <div class="summary"><p>Appends a short String representation of this object which includes its class name and its object address.</p></div> </li> </ul> <div class="methods-inherited"> <h3>Instance methods inherited from class <code><a href="reference.html">Reference</a></code>
</h3> <a href="reference.html#%3D%3D%28other%3Aself%29-instance-method" class="tooltip"> ==(other : self)<br>==(other : JSON::Any)<br>==(other : YAML::Any)<br>==(other) ==</a>, <a href="reference.html#dup-instance-method" class="tooltip"> dup dup</a>, <a href="reference.html#hash%28hasher%29-instance-method" class="tooltip"> hash(hasher) hash</a>, <a href="reference.html#initialize-instance-method" class="tooltip"> initialize initialize</a>, <a href="reference.html#inspect%28io%3AIO%29%3ANil-instance-method" class="tooltip"> inspect(io : IO) : Nil inspect</a>, <a href="reference.html#object_id%3AUInt64-instance-method" class="tooltip"> object_id : UInt64 object_id</a>, <a href="reference.html#pretty_print%28pp%29%3ANil-instance-method" class="tooltip"> pretty_print(pp) : Nil pretty_print</a>, <a href="reference.html#same%3F%28other%3AReference%29%3ABool-instance-method" class="tooltip"> same?(other : Reference) : Bool<br>same?(other : Nil) same?</a>, <a href="reference.html#to_s%28io%3AIO%29%3ANil-instance-method" class="tooltip"> to_s(io : IO) : Nil to_s</a> <h3>Constructor methods inherited from class <code><a href="reference.html">Reference</a></code>
</h3> <a href="reference.html#new-class-method" class="tooltip"> new new</a>, <a href="reference.html#unsafe_construct%28address%3APointer%2C%2Aargs%2C%2A%2Aopts%29%3Aself-class-method" class="tooltip"> unsafe_construct(address : Pointer, *args, **opts) : self unsafe_construct</a> <h3>Class methods inherited from class <code><a href="reference.html">Reference</a></code>
</h3> <a href="reference.html#pre_initialize%28address%3APointer%29-class-method" class="tooltip"> pre_initialize(address : Pointer) pre_initialize</a> <h3>Instance methods inherited from class <code><a href="object.html">Object</a></code>
</h3> <a href="object.html#%21%3ABool-instance-method" class="tooltip"> ! : Bool !</a>, <a href="object.html#%21%3D%28other%29-instance-method" class="tooltip"> !=(other) !=</a>, <a href="object.html#%21~%28other%29-instance-method" class="tooltip"> !~(other) !~</a>, <a href="object.html#%3D%3D%28other%29-instance-method" class="tooltip"> ==(other) ==</a>, <a href="object.html#%3D%3D%3D%28other%3AJSON%3A%3AAny%29-instance-method" class="tooltip"> ===(other : JSON::Any)<br>===(other : YAML::Any)<br>===(other) ===</a>, <a href="object.html#%3D~%28other%29-instance-method" class="tooltip"> =~(other) =~</a>, <a href="object.html#as%28type%3AClass%29-instance-method" class="tooltip"> as(type : Class) as</a>, <a href="object.html#as%3F%28type%3AClass%29-instance-method" class="tooltip"> as?(type : Class) as?</a>, <a href="object.html#class-instance-method" class="tooltip"> class class</a>, <a href="object.html#dup-instance-method" class="tooltip"> dup dup</a>, <a href="object.html#hash%28hasher%29-instance-method" class="tooltip"> hash(hasher)<br>hash hash</a>, <a href="object.html#in%3F%28collection%3AObject%29%3ABool-instance-method" class="tooltip"> in?(collection : Object) : Bool<br>in?(*values : Object) : Bool in?</a>, <a href="object.html#inspect%28io%3AIO%29%3ANil-instance-method" class="tooltip"> inspect(io : IO) : Nil<br>inspect : String inspect</a>, <a href="object.html#is_a%3F%28type%3AClass%29%3ABool-instance-method" class="tooltip"> is_a?(type : Class) : Bool is_a?</a>, <a href="object.html#itself-instance-method" class="tooltip"> itself itself</a>, <a href="object.html#nil%3F%3ABool-instance-method" class="tooltip"> nil? : Bool nil?</a>, <a href="object.html#not_nil%21%28message%29-instance-method" class="tooltip"> not_nil!(message)<br>not_nil! not_nil!</a>, <a href="object.html#pretty_inspect%28width%3D79%2Cnewline%3D%22%5Cn%22%2Cindent%3D0%29%3AString-instance-method" class="tooltip"> pretty_inspect(width = 79, newline = "\n", indent = 0) : String pretty_inspect</a>, <a href="object.html#pretty_print%28pp%3APrettyPrint%29%3ANil-instance-method" class="tooltip"> pretty_print(pp : PrettyPrint) : Nil pretty_print</a>, <a href="object.html#responds_to%3F%28name%3ASymbol%29%3ABool-instance-method" class="tooltip"> responds_to?(name : Symbol) : Bool responds_to?</a>, <a href="object.html#tap%28%26%29-instance-method" class="tooltip"> tap(&amp;) tap</a>, <a href="object.html#to_json%28io%3AIO%29%3ANil-instance-method" class="tooltip"> to_json(io : IO) : Nil<br>to_json : String to_json</a>, <a href="object.html#to_pretty_json%28indent%3AString%3D%22%22%29%3AString-instance-method" class="tooltip"> to_pretty_json(indent : String = " ") : String<br>to_pretty_json(io : IO, indent : String = " ") : Nil to_pretty_json</a>, <a href="object.html#to_s%28io%3AIO%29%3ANil-instance-method" class="tooltip"> to_s(io : IO) : Nil<br>to_s : String to_s</a>, <a href="object.html#to_yaml%28io%3AIO%29%3ANil-instance-method" class="tooltip"> to_yaml(io : IO) : Nil<br>to_yaml : String to_yaml</a>, <a href="object.html#try%28%26%29-instance-method" class="tooltip"> try(&amp;) try</a>, <a href="object.html#unsafe_as%28type%3AT.class%29forallT-instance-method" class="tooltip"> unsafe_as(type : T.class) forall T unsafe_as</a> <h3>Class methods inherited from class <code><a href="object.html">Object</a></code>
</h3> <a href="object.html#from_json%28string_or_io%2Croot%3AString%29-class-method" class="tooltip"> from_json(string_or_io, root : String)<br>from_json(string_or_io) from_json</a>, <a href="object.html#from_yaml%28string_or_io%3AString%7CIO%29-class-method" class="tooltip"> from_yaml(string_or_io : String | IO) from_yaml</a> <h3>Macros inherited from class <code><a href="object.html">Object</a></code>
</h3> <a href="object.html#class_getter%28%2Anames%2C%26block%29-macro" class="tooltip"> class_getter(*names, &amp;block) class_getter</a>, <a href="object.html#class_getter%21%28%2Anames%29-macro" class="tooltip"> class_getter!(*names) class_getter!</a>, <a href="object.html#class_getter%3F%28%2Anames%2C%26block%29-macro" class="tooltip"> class_getter?(*names, &amp;block) class_getter?</a>, <a href="object.html#class_property%28%2Anames%2C%26block%29-macro" class="tooltip"> class_property(*names, &amp;block) class_property</a>, <a href="object.html#class_property%21%28%2Anames%29-macro" class="tooltip"> class_property!(*names) class_property!</a>, <a href="object.html#class_property%3F%28%2Anames%2C%26block%29-macro" class="tooltip"> class_property?(*names, &amp;block) class_property?</a>, <a href="object.html#class_setter%28%2Anames%29-macro" class="tooltip"> class_setter(*names) class_setter</a>, <a href="object.html#def_clone-macro" class="tooltip"> def_clone def_clone</a>, <a href="object.html#def_equals%28%2Afields%29-macro" class="tooltip"> def_equals(*fields) def_equals</a>, <a href="object.html#def_equals_and_hash%28%2Afields%29-macro" class="tooltip"> def_equals_and_hash(*fields) def_equals_and_hash</a>, <a href="object.html#def_hash%28%2Afields%29-macro" class="tooltip"> def_hash(*fields) def_hash</a>, <a href="object.html#delegate%28%2Amethods%2Ctoobject%29-macro" class="tooltip"> delegate(*methods, to object) delegate</a>, <a href="object.html#forward_missing_to%28delegate%29-macro" class="tooltip"> forward_missing_to(delegate) forward_missing_to</a>, <a href="object.html#getter%28%2Anames%2C%26block%29-macro" class="tooltip"> getter(*names, &amp;block) getter</a>, <a href="object.html#getter%21%28%2Anames%29-macro" class="tooltip"> getter!(*names) getter!</a>, <a href="object.html#getter%3F%28%2Anames%2C%26block%29-macro" class="tooltip"> getter?(*names, &amp;block) getter?</a>, <a href="object.html#property%28%2Anames%2C%26block%29-macro" class="tooltip"> property(*names, &amp;block) property</a>, <a href="object.html#property%21%28%2Anames%29-macro" class="tooltip"> property!(*names) property!</a>, <a href="object.html#property%3F%28%2Anames%2C%26block%29-macro" class="tooltip"> property?(*names, &amp;block) property?</a>, <a href="object.html#setter%28%2Anames%29-macro" class="tooltip"> setter(*names) setter</a> </div> <h2>  Constructor Detail </h2> <div class="entry-detail" id="current:Fiber-class-method"> <h3 class="signature">def self.<strong>current</strong> : <a href="fiber.html">Fiber</a><a href="https://github.com/crystal-lang/crystal/blob/0aa30372c/src/fiber.cr#L177" target="_blank" class="view-source">Source</a>
</h3> <div class="doc"> <p>Returns the current fiber.</p> </div>   </div> <div class="entry-detail" id="new(name:String|Nil=nil,&amp;proc:-&gt;)-class-method"> <h3 class="signature">def self.<strong>new</strong>(name : <a href="string.html">String</a> | <a href="nil.html">Nil</a> = nil, &amp;proc : -&gt; )<a href="https://github.com/crystal-lang/crystal/blob/0aa30372c/src/fiber.cr#L88" target="_blank" class="view-source">Source</a>
</h3> <div class="doc"> <p>Creates a new <code><a href="fiber.html">Fiber</a></code> instance.</p> <p>When the fiber is executed, it runs <em>proc</em> in its context.</p> <p><em>name</em> is an optional and used only as an internal reference.</p> </div>   </div> <h2>  Class Method Detail </h2> <div class="entry-detail" id="cancel_timeout:Nil-class-method"> <h3 class="signature">def self.<strong>cancel_timeout</strong> : <a href="nil.html">Nil</a><a href="https://github.com/crystal-lang/crystal/blob/0aa30372c/src/fiber.cr#L254" target="_blank" class="view-source">Source</a>
</h3>   </div> <div class="entry-detail" id="timeout(timeout:Time::Span|Nil,select_action:Channel::TimeoutAction|Nil=nil):Nil-class-method"> <h3 class="signature">def self.<strong>timeout</strong>(timeout : <a href="time/span.html">Time::Span</a> | <a href="nil.html">Nil</a>, select_action : Channel::TimeoutAction | <a href="nil.html">Nil</a> = nil) : <a href="nil.html">Nil</a><a href="https://github.com/crystal-lang/crystal/blob/0aa30372c/src/fiber.cr#L250" target="_blank" class="view-source">Source</a>
</h3> <div class="doc"> <p>The current fiber will resume after a period of time. The timeout can be cancelled with <code><a href="fiber.html#cancel_timeout%3ANil-class-method">.cancel_timeout</a></code></p> </div>   </div> <div class="entry-detail" id="yield:Nil-class-method"> <h3 class="signature">def self.<strong>yield</strong> : <a href="nil.html">Nil</a><a href="https://github.com/crystal-lang/crystal/blob/0aa30372c/src/fiber.cr#L286" target="_blank" class="view-source">Source</a>
</h3> <div class="doc"> <p>Yields to the scheduler and allows it to swap execution to other waiting fibers.</p> <p>This is equivalent to <code>sleep 0.seconds</code>. It gives the scheduler an option to interrupt the current fiber's execution. If no other fibers are ready to be resumed, it immediately resumes the current fiber.</p> <p>This method is particularly useful to break up tight loops which are only computation intensive and don't offer natural opportunities for swapping fibers as with IO operations.</p> <pre data-language="crystal">counter = 0
spawn name: "status" do
  loop do
    puts "Status: #{counter}"
    sleep(2.seconds)
  end
end

while counter &lt; Int32::MAX
  counter += 1
  if counter % 1_000_000 == 0
    # Without this, there would never be an opportunity to resume the status fiber
    Fiber.yield
  end
end</pre> </div>   </div> <h2>  Instance Method Detail </h2> <div class="entry-detail" id="dead?:Bool-instance-method"> <h3 class="signature">def <strong>dead?</strong> : <a href="bool.html">Bool</a><a href="https://github.com/crystal-lang/crystal/blob/0aa30372c/src/fiber.cr#L195" target="_blank" class="view-source">Source</a>
</h3> <div class="doc"> <p>The fiber's proc has terminated, and the fiber is now considered dead. The fiber is impossible to resume, ever.</p> </div>   </div> <div class="entry-detail" id="enqueue:Nil-instance-method"> <h3 class="signature">def <strong>enqueue</strong> : <a href="nil.html">Nil</a><a href="https://github.com/crystal-lang/crystal/blob/0aa30372c/src/fiber.cr#L222" target="_blank" class="view-source">Source</a>
</h3> <div class="doc"> <p>Adds this fiber to the scheduler's runnables queue for the current thread.</p> <p>This signals to the scheduler that the fiber is eligible for being resumed the next time it has the opportunity to reschedule to another fiber. There are no guarantees when that will happen.</p> </div>   </div> <div class="entry-detail" id="inspect(io:IO):Nil-instance-method"> <h3 class="signature">def <strong>inspect</strong>(io : <a href="io.html">IO</a>) : <a href="nil.html">Nil</a><a href="https://github.com/crystal-lang/crystal/blob/0aa30372c/src/fiber.cr#L299" target="_blank" class="view-source">Source</a>
</h3> <div class="doc"> <div class="doc-inherited"> Description copied from class <a href="reference.html">Reference</a> </div> <p>Appends a String representation of this object which includes its class name, its object address and the values of all instance variables.</p> <pre data-language="crystal">class Person
  def initialize(@name : String, @age : Int32)
  end
end

Person.new("John", 32).inspect # =&gt; #&lt;Person:0x10fd31f20 @name="John", @age=32&gt;</pre> </div>   </div> <div class="entry-detail" id="name:String|Nil-instance-method"> <h3 class="signature">def <strong>name</strong> : <a href="string.html">String</a> | <a href="nil.html">Nil</a><a href="https://github.com/crystal-lang/crystal/blob/0aa30372c/src/fiber.cr#L62" target="_blank" class="view-source">Source</a>
</h3> <div class="doc"> <p>The name of the fiber, used as internal reference.</p> </div>   </div> <div class="entry-detail" id="name=(name:String|Nil)-instance-method"> <h3 class="signature">def <strong>name=</strong>(name : <a href="string.html">String</a> | <a href="nil.html">Nil</a>)<a href="https://github.com/crystal-lang/crystal/blob/0aa30372c/src/fiber.cr#L62" target="_blank" class="view-source">Source</a>
</h3> <div class="doc"> <p>The name of the fiber, used as internal reference.</p> </div>   </div> <div class="entry-detail" id="resumable?:Bool-instance-method"> <h3 class="signature">def <strong>resumable?</strong> : <a href="bool.html">Bool</a><a href="https://github.com/crystal-lang/crystal/blob/0aa30372c/src/fiber.cr#L189" target="_blank" class="view-source">Source</a>
</h3> <div class="doc"> <p>The fiber's proc is currently not running and fully saved its context. The fiber can be resumed safely.</p> </div>   </div> <div class="entry-detail" id="resume:Nil-instance-method"> <h3 class="signature">def <strong>resume</strong> : <a href="nil.html">Nil</a><a href="https://github.com/crystal-lang/crystal/blob/0aa30372c/src/fiber.cr#L213" target="_blank" class="view-source">Source</a>
</h3> <div class="doc"> <p>Immediately resumes execution of this fiber.</p> <p>There are no provisions for resuming the current fiber (where this method is called). Unless it is explicitly added for rescheduling (for example using <code><a href="fiber.html#enqueue%3ANil-instance-method">#enqueue</a></code>) the current fiber won't ever reach any instructions after the call to this method.</p> <pre data-language="crystal">fiber = Fiber.new do
  puts "in fiber"
end
fiber.resume
puts "never reached"</pre> </div>   </div> <div class="entry-detail" id="running?:Bool-instance-method"> <h3 class="signature">def <strong>running?</strong> : <a href="bool.html">Bool</a><a href="https://github.com/crystal-lang/crystal/blob/0aa30372c/src/fiber.cr#L183" target="_blank" class="view-source">Source</a>
</h3> <div class="doc"> <p>The fiber's proc is currently running or didn't fully save its context. The fiber can't be resumed.</p> </div>   </div> <div class="entry-detail" id="to_s(io:IO):Nil-instance-method"> <h3 class="signature">def <strong>to_s</strong>(io : <a href="io.html">IO</a>) : <a href="nil.html">Nil</a><a href="https://github.com/crystal-lang/crystal/blob/0aa30372c/src/fiber.cr#L290" target="_blank" class="view-source">Source</a>
</h3> <div class="doc"> <div class="doc-inherited"> Description copied from class <a href="reference.html">Reference</a> </div> <p>Appends a short String representation of this object which includes its class name and its object address.</p> <pre data-language="crystal">class Person
  def initialize(@name : String, @age : Int32)
  end
end

Person.new("John", 32).to_s # =&gt; #&lt;Person:0x10a199f20&gt;</pre> </div>   </div><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2012&ndash;2024 Manas Technology Solutions.<br>Licensed under the Apache License, Version 2.0.<br>
    <a href="https://crystal-lang.org/api/1.11.1/Fiber.html" class="_attribution-link">https://crystal-lang.org/api/1.11.1/Fiber.html</a>
  </p>
</div>
