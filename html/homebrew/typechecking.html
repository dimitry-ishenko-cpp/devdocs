<h1 id="type-checking-with-sorbet">Type Checking With Sorbet</h1> <p>The majority of the code in Homebrew is written in Ruby which is a dynamic language. To avail the benefits of static type checking, we have set up Sorbet in our codebase which provides the benefits of static type checking to dynamic languages like Ruby.</p> <p>The <a href="https://sorbet.org/docs/overview">Sorbet Documentation</a> is a good place to get started if you want to dive deeper into Sorbet and it’s abilities.</p> <h2 id="sorbet-in-the-homebrew-codebase">Sorbet in the Homebrew Codebase</h2> <h3 id="inline-type-annotations">Inline Type Annotations</h3> <p>To add type annotations to a class or module, we need to first extend it with the <code class="language-plaintext highlighter-rouge">T::Sig</code> module (read this as <code class="language-plaintext highlighter-rouge">Type::Signature</code>). This adds the <code class="language-plaintext highlighter-rouge">sig</code> method which is used to annotate method signatures. Here’s a simple example:</p> <pre data-language="ruby">class MyClass
  extend T::Sig

  sig { params(name: String).returns(String) }
  def my_method(name)
    "Hello, #{name}!"
  end
end</pre> <p>With <code class="language-plaintext highlighter-rouge">params</code>, we specify that we have a parameter <code class="language-plaintext highlighter-rouge">name</code> which must be a <code class="language-plaintext highlighter-rouge">String</code> and with <code class="language-plaintext highlighter-rouge">returns</code>, we specify that this method always returns a <code class="language-plaintext highlighter-rouge">String</code>.</p> <p>For more information on how to express more complex types, refer to the official documentation:</p> <ul> <li><a href="https://sorbet.org/docs/sigs">Method Signatures</a></li> <li><a href="https://sorbet.org/docs/class-types">Class Types</a></li> <li><a href="https://sorbet.org/docs/nilable-types">Nilable Types</a></li> <li><a href="https://sorbet.org/docs/union-types">Union Types</a></li> </ul> <h3 id="ruby-interface-files-rbi">Ruby Interface Files (<code class="language-plaintext highlighter-rouge">.rbi</code>)</h3> <p>RBI files help Sorbet learn about constants, ancestors and methods defined in ways it doesn’t understand natively. We can also create a RBI file to help Sorbet understand dynamic definitions.</p> <p>Sometimes it is necessary to explicitly include the <code class="language-plaintext highlighter-rouge">Kernel</code> module in order for Sorbet to know that methods such as <code class="language-plaintext highlighter-rouge">puts</code> are available in a given context. This is mostly necessary for modules since they can be used in both <code class="language-plaintext highlighter-rouge">BasicObject</code>s (which don’t include <code class="language-plaintext highlighter-rouge">Kernel</code>) and <code class="language-plaintext highlighter-rouge">Object</code>s (which include <code class="language-plaintext highlighter-rouge">Kernel</code> by default). In this case, it is necessary to create an <code class="language-plaintext highlighter-rouge">.rbi</code> file (<a href="https://github.com/Homebrew/brew/blob/61b79318ed089b5010501e2cbf163fd8e48e2dfc/Library/Homebrew/global.rbi">example</a>) since re-including the <code class="language-plaintext highlighter-rouge">Kernel</code> module in actual code can break things.</p> <p>Read more about RBI files <a href="https://sorbet.org/docs/rbi">here</a>.</p> <h3 id="the-libraryhomebrewsorbet-directory">The <a href="https://github.com/Homebrew/brew/tree/master/Library/Homebrew/sorbet"><code class="language-plaintext highlighter-rouge">Library/Homebrew/sorbet</code></a> Directory</h3> <ul> <li> <p>The <code class="language-plaintext highlighter-rouge">rbi</code> directory contains all Ruby Interface (<code class="language-plaintext highlighter-rouge">.rbi</code>) files auto-generated by running <code class="language-plaintext highlighter-rouge">brew typecheck --update</code>:</p> <ul> <li>RBI files for all gems are generated using <a href="https://github.com/Shopify/tapioca#tapioca">Tapioca</a>.</li> <li>Definitions for dynamic code (i.e. meta-programming) are generated using <code class="language-plaintext highlighter-rouge">srb rbi hidden-definitions</code>.</li> <li>Definitions for missing constants are generated using <code class="language-plaintext highlighter-rouge">srb rbi todo</code>.</li> </ul> </li> <li> <p>The <code class="language-plaintext highlighter-rouge">config</code> file is a newline-separated list of arguments to pass to <code class="language-plaintext highlighter-rouge">srb tc</code>, the same as if they’d been passed at the command-line. Arguments in the config file are always passed first, followed by arguments provided on the command-line. We use it to ignore Gem directories which we do not wish to type check.</p> </li> <li> <p>Every Ruby file in the codebase has a magic <code class="language-plaintext highlighter-rouge"># typed: &lt;level&gt;</code> comment at the top, where <code class="language-plaintext highlighter-rouge">&lt;level&gt;</code> is one of <a href="https://sorbet.org/docs/static#file-level-granularity-strictness-levels">Sorbet’s strictness levels</a>, usually <code class="language-plaintext highlighter-rouge">false</code>, <code class="language-plaintext highlighter-rouge">true</code> or <code class="language-plaintext highlighter-rouge">strict</code>. The <code class="language-plaintext highlighter-rouge">false</code> files only report errors related to the syntax, constant resolution and correctness of the method signatures, but no type errors. Our long-term goal is to move all <code class="language-plaintext highlighter-rouge">false</code> files to <code class="language-plaintext highlighter-rouge">true</code> and start reporting type errors on those files as well. Therefore, when adding new files, you should ideally mark it with <code class="language-plaintext highlighter-rouge"># typed: true</code> and work out any resulting type errors.</p> </li> </ul> <h2 id="using-brew-typecheck">Using <code class="language-plaintext highlighter-rouge">brew typecheck</code>
</h2> <p>When run without any arguments, <code class="language-plaintext highlighter-rouge">brew typecheck</code>, will run considering the strictness levels set in each of the individual Ruby files in the core Homebrew codebase. However, when it is run on a specific file or directory, more errors may show up since Sorbet cannot resolve constants defined outside the scope of the specified file. These problems can be solved with RBI files. Currently <code class="language-plaintext highlighter-rouge">brew typecheck</code> provides <code class="language-plaintext highlighter-rouge">--quiet</code>, <code class="language-plaintext highlighter-rouge">--file</code>, <code class="language-plaintext highlighter-rouge">--dir</code> and <code class="language-plaintext highlighter-rouge">--ignore</code> options but you can explore more options with <code class="language-plaintext highlighter-rouge">srb tc --help</code> and passing them with <code class="language-plaintext highlighter-rouge">srb tc</code>.</p> <h2 id="resolving-type-errors">Resolving Type Errors</h2> <p>Sorbet reports type errors along with an error reference code, which can be used to look up more information on how to debug the error, or what causes the error in the <a href="https://sorbet.org/docs/overview">Sorbet Documentation</a>. Here is how to debug some common type errors:</p> <ul> <li> <p>Using <code class="language-plaintext highlighter-rouge">T.reveal_type</code>. In files which are <code class="language-plaintext highlighter-rouge">true</code> or higher, if we wrap a variable or method call in <code class="language-plaintext highlighter-rouge">T.reveal_type</code>, Sorbet will show us what type it thinks that variable has in the output of <code class="language-plaintext highlighter-rouge">srb tc</code>. This is particularly useful when writing <a href="https://sorbet.org/docs/sigs">method signatures</a> and debugging. Make sure to remove this line from your code before committing your changes, since this is just a debugging tool.</p> </li> <li> <p>One of the most frequent errors that we’ve encountered is: <code class="language-plaintext highlighter-rouge">7003: Method does not exist.</code> Since Ruby is a very dynamic language, methods can be defined in ways Sorbet cannot see statically. In such cases, check if the method exists at runtime, if not, then Sorbet has caught a future bug! But, it is also possible that even though a method exists at runtime, Sorbet cannot see it. In such cases, we use <a href="#ruby-interface-files-rbi"><code class="language-plaintext highlighter-rouge">.rbi</code> files</a>.</p> </li> <li> <p>Since Sorbet does not automatically assume that Kernel is to be included in Modules, we may encounter many errors while trying to use methods like <code class="language-plaintext highlighter-rouge">puts</code>, <code class="language-plaintext highlighter-rouge">ohai</code>, <code class="language-plaintext highlighter-rouge">odebug</code> et cetera. A simple workaround for this would be to add an extra <code class="language-plaintext highlighter-rouge">include Kernel</code> line in the respective RBI file.</p> </li> <li> <p>The tips above are very generic and apply to lots of cases. For some common gotchas when using Sorbet, refer to the <a href="https://sorbet.org/docs/error-reference">Sorbet Error Reference</a> and <a href="https://sorbet.org/docs/faq">FAQ</a>.</p> </li> </ul><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2009&ndash;present Homebrew contributors<br>Licensed under the BSD 2-Clause License.<br>
    <a href="https://docs.brew.sh/Typechecking" class="_attribution-link">https://docs.brew.sh/Typechecking</a>
  </p>
</div>
