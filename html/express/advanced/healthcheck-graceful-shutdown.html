<h1 id="health-checks-and-graceful-shutdown" data-level="6">Health Checks and Graceful Shutdown</h1> <h2 id="graceful-shutdown">Graceful shutdown</h2> <p>When you deploy a new version of your application, you must replace the previous version. The <a href="pm.html">process manager</a> you’re using will first send a SIGTERM signal to the application to notify it that it will be killed. Once the application gets this signal, it should stop accepting new requests, finish all the ongoing requests, clean up the resources it used, including database connections and file locks then exit.</p> <h3 id="example-graceful-shutdown">Example Graceful Shutdown</h3> <pre data-language="js">const server = app.listen(port)

process.on('SIGTERM', () =&gt; {
  debug('SIGTERM signal received: closing HTTP server')
  server.close(() =&gt; {
    debug('HTTP server closed')
  })
})
</pre> <h2 id="health-checks">Health checks</h2> <p>A load balancer uses health checks to determine if an application instance is healthy and can accept requests. For example, <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">Kubernetes has two health checks</a>:</p> <ul> <li>
<code>liveness</code>, that determines when to restart a container.</li> <li>
<code>readiness</code>, that determines when a container is ready to start accepting traffic. When a pod is not ready, it is removed from the service load balancers.</li> </ul> <h2 id="third-party-solutions">Third-party solutions</h2> <div class="doc-box doc-warn"> <p><b>Warning</b>: This information refers to third-party sites, products, or modules that are not maintained by the Expressjs team. Listing here does not constitute an endorsement or recommendation from the Expressjs project team.</p> </div> <h3 id="terminus">Terminus</h3> <p><a href="https://github.com/godaddy/terminus">Terminus</a> is an open-source project that adds health checks and graceful shutdown to your application to eliminate the need to write boilerplate code. You just provide the cleanup logic for graceful shutdowns and the health check logic for health checks, and terminus handles the rest.</p> <p>Install terminus as follows:</p> <pre data-language="console">$ npm i @godaddy/terminus --save
</pre> <p>Here’s a basic template that illustrates using terminus. For more information, see <a href="https://github.com/godaddy/terminus">https://github.com/godaddy/terminus</a>.</p> <pre data-language="js">const http = require('http')
const express = require('express')
const { createTerminus } = require('@godaddy/terminus')

const app = express()

app.get('/', (req, res) =&gt; {
  res.send('ok')
})

const server = http.createServer(app)

function onSignal () {
  console.log('server is starting cleanup')
  // start cleanup of resource, like databases or file descriptors
}

async function onHealthCheck () {
  // checks if the system is healthy, like the db connection is live
  // resolves, if health, rejects if not
}

createTerminus(server, {
  signal: 'SIGINT',
  healthChecks: { '/healthcheck': onHealthCheck },
  onSignal
})

server.listen(3000)
</pre> <h3 id="lightship">Lightship</h3> <p><a href="https://github.com/gajus/lightship">Lightship</a> is an open-source project that adds health, readiness and liveness checks to your application. Lightship is a standalone HTTP-service that runs as a separate HTTP service; this allows having health-readiness-liveness HTTP endpoints without exposing them on the public interface.</p> <p>Install Lightship as follows:</p> <pre data-language="console">$ npm install lightship
</pre> <p>Basic template that illustrates using Lightship:</p> <pre data-language="js">const http = require('http')
const express = require('express')
const {
  createLightship
} = require('lightship')

// Lightship will start a HTTP service on port 9000.
const lightship = createLightship()

const app = express()

app.get('/', (req, res) =&gt; {
  res.send('ok')
})

app.listen(3000, () =&gt; {
  lightship.signalReady()
})

// You can signal that the service is not ready using `lightship.signalNotReady()`.
</pre> <p><a href="https://github.com/gajus/lightship">Lightship documentation</a> provides examples of the corresponding <a href="https://github.com/gajus/lightship#lightship-usage-kubernetes-container-probe-configuration">Kubernetes configuration</a> and a complete example of integration with <a href="https://github.com/gajus/lightship#using-with-expressjs">Express.js</a>.</p> <h3 id="http-terminator">http-terminator</h3> <p><a href="https://github.com/gajus/http-terminator">http-terminator</a> implements logic for gracefully terminating an express.js server.</p> <p>Terminating a HTTP server in Node.js requires keeping track of all open connections and signaling them that the server is shutting down. http-terminator implements the logic for tracking all connections and their termination upon a timeout. http-terminator also ensures graceful communication of the server intention to shutdown to any clients that are currently receiving response from this server.</p> <p>Install http-terminator as follows:</p> <pre data-language="console">$ npm install http-terminator
</pre> <p>Basic template that illustrates using http-terminator:</p> <pre data-language="js">const express = require('express')
const { createHttpTerminator } = require('http-terminator')

const app = express()

const server = app.listen(3000)

const httpTerminator = createHttpTerminator({ server })

app.get('/', (req, res) =&gt; {
  res.send('ok')
})

// A server will terminate after invoking `httpTerminator.terminate()`.
// Note: Timeout is used for illustration of delayed termination purposes only.
setTimeout(() =&gt; {
  httpTerminator.terminate()
}, 1000)
</pre> <p><a href="https://github.com/gajus/http-terminator">http-terminator documentation</a> provides API documentation and comparison to other existing third-party solutions.</p> <h3 id="express-actuator">express-actuator</h3> <p><a href="https://github.com/rcruzper/express-actuator">express-actuator</a> is a middleware to add endpoints to help you monitor and manage applications.</p> <p>Install express-actuator as follows:</p> <pre data-language="console">$ npm install --save express-actuator
</pre> <p>Basic template that illustrates using express-actuator:</p> <pre data-language="js">const express = require('express')
const actuator = require('express-actuator')

const app = express()

app.use(actuator())

app.listen(3000)
</pre> <p>The <a href="https://github.com/rcruzper/express-actuator">express-actuator documentation</a> provides different options for customization.</p><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2017 StrongLoop, IBM, and other expressjs.com contributors.<br>Licensed under the Creative Commons Attribution-ShareAlike License v3.0.<br>
    <a href="https://expressjs.com/en/advanced/healthcheck-graceful-shutdown.html" class="_attribution-link">https://expressjs.com/en/advanced/healthcheck-graceful-shutdown.html</a>
  </p>
</div>
