<h1 id="writing-middleware-for-use-in-express-apps" data-level="2">Writing middleware for use in Express apps</h1> <h2>Overview</h2> <p><em>Middleware</em> functions are functions that have access to the <a href="../index.html#req">request object</a> (<code class="language-plaintext highlighter-rouge">req</code>), the <a href="../index.html#res">response object</a> (<code class="language-plaintext highlighter-rouge">res</code>), and the <code class="language-plaintext highlighter-rouge">next</code> function in the application’s request-response cycle. The <code class="language-plaintext highlighter-rouge">next</code> function is a function in the Express router which, when invoked, executes the middleware succeeding the current middleware.</p> <p>Middleware functions can perform the following tasks:</p> <ul> <li>Execute any code.</li> <li>Make changes to the request and the response objects.</li> <li>End the request-response cycle.</li> <li>Call the next middleware in the stack.</li> </ul> <p>If the current middleware function does not end the request-response cycle, it must call <code class="language-plaintext highlighter-rouge">next()</code> to pass control to the next middleware function. Otherwise, the request will be left hanging.</p> <p>The following figure shows the elements of a middleware function call:</p> <table id="mw-fig"> <tr>
<td id="mw-fig-imgcell"> <img src="data:image/png;base64,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" id="mw-fig-img"> </td> <td class="mw-fig-callouts"> <div class="callout" id="callout1">HTTP method for which the middleware function applies.</div> <div class="callout" id="callout2">Path (route) for which the middleware function applies.</div> <div class="callout" id="callout3">The middleware function.</div> <div class="callout" id="callout4">Callback argument to the middleware function, called "next" by convention.</div> <div class="callout" id="callout5">HTTP <a href="../index.html#res">response</a> argument to the middleware function, called "res" by convention.</div> <div class="callout" id="callout6">HTTP <a href="../index.html#req">request</a> argument to the middleware function, called "req" by convention.</div> </td>
</tr> </table> <p>Starting with Express 5, middleware functions that return a Promise will call <code class="language-plaintext highlighter-rouge">next(value)</code> when they reject or throw an error. <code class="language-plaintext highlighter-rouge">next</code> will be called with either the rejected value or the thrown Error.</p> <h2>Example</h2> <p>Here is an example of a simple “Hello World” Express application. The remainder of this article will define and add three middleware functions to the application: one called <code class="language-plaintext highlighter-rouge">myLogger</code> that prints a simple log message, one called <code class="language-plaintext highlighter-rouge">requestTime</code> that displays the timestamp of the HTTP request, and one called <code class="language-plaintext highlighter-rouge">validateCookies</code> that validates incoming cookies.</p> <div class="highlight"><pre class="highlight">const express = require('express')
const app = express()

app.get('/', (req, res) =&gt; {
  res.send('Hello World!')
})

app.listen(3000)
</pre></div> <h3>Middleware function myLogger</h3> <p>Here is a simple example of a middleware function called “myLogger”. This function just prints “LOGGED” when a request to the app passes through it. The middleware function is assigned to a variable named <code class="language-plaintext highlighter-rouge">myLogger</code>.</p> <div class="highlight"><pre class="highlight">const myLogger = function (req, res, next) {
  console.log('LOGGED')
  next()
}
</pre></div> <div class="doc-box doc-notice"> <p>Notice the call above to <code class="language-plaintext highlighter-rouge">next()</code>. Calling this function invokes the next middleware function in the app. The <code class="language-plaintext highlighter-rouge">next()</code> function is not a part of the Node.js or Express API, but is the third argument that is passed to the middleware function. The <code class="language-plaintext highlighter-rouge">next()</code> function could be named anything, but by convention it is always named “next”. To avoid confusion, always use this convention.</p> </div> <p>To load the middleware function, call <code class="language-plaintext highlighter-rouge">app.use()</code>, specifying the middleware function. For example, the following code loads the <code class="language-plaintext highlighter-rouge">myLogger</code> middleware function before the route to the root path (/).</p> <div class="highlight"><pre class="highlight">const express = require('express')
const app = express()

const myLogger = function (req, res, next) {
  console.log('LOGGED')
  next()
}

app.use(myLogger)

app.get('/', (req, res) =&gt; {
  res.send('Hello World!')
})

app.listen(3000)
</pre></div> <p>Every time the app receives a request, it prints the message “LOGGED” to the terminal.</p> <p>The order of middleware loading is important: middleware functions that are loaded first are also executed first.</p> <p>If <code class="language-plaintext highlighter-rouge">myLogger</code> is loaded after the route to the root path, the request never reaches it and the app doesn’t print “LOGGED”, because the route handler of the root path terminates the request-response cycle.</p> <p>The middleware function <code class="language-plaintext highlighter-rouge">myLogger</code> simply prints a message, then passes on the request to the next middleware function in the stack by calling the <code class="language-plaintext highlighter-rouge">next()</code> function.</p> <h3>Middleware function requestTime</h3> <p>Next, we’ll create a middleware function called “requestTime” and add a property called <code class="language-plaintext highlighter-rouge">requestTime</code> to the request object.</p> <div class="highlight"><pre class="highlight">const requestTime = function (req, res, next) {
  req.requestTime = Date.now()
  next()
}
</pre></div> <p>The app now uses the <code class="language-plaintext highlighter-rouge">requestTime</code> middleware function. Also, the callback function of the root path route uses the property that the middleware function adds to <code class="language-plaintext highlighter-rouge">req</code> (the request object).</p> <div class="highlight"><pre class="highlight">const express = require('express')
const app = express()

const requestTime = function (req, res, next) {
  req.requestTime = Date.now()
  next()
}

app.use(requestTime)

app.get('/', (req, res) =&gt; {
  let responseText = 'Hello World!&lt;br&gt;'
  responseText += `&lt;small&gt;Requested at: ${req.requestTime}&lt;/small&gt;`
  res.send(responseText)
})

app.listen(3000)
</pre></div> <p>When you make a request to the root of the app, the app now displays the timestamp of your request in the browser.</p> <h3>Middleware function validateCookies</h3> <p>Finally, we’ll create a middleware function that validates incoming cookies and sends a 400 response if cookies are invalid.</p> <p>Here’s an example function that validates cookies with an external async service.</p> <div class="highlight"><pre class="highlight">async function cookieValidator (cookies) {
  try {
    await externallyValidateCookie(cookies.testCookie)
  } catch {
    throw new Error('Invalid cookies')
  }
}
</pre></div> <p>Here, we use the <a href="https://expressjs.com/resources/middleware/cookie-parser.html"><code class="language-plaintext highlighter-rouge">cookie-parser</code></a> middleware to parse incoming cookies off the <code class="language-plaintext highlighter-rouge">req</code> object and pass them to our <code class="language-plaintext highlighter-rouge">cookieValidator</code> function. The <code class="language-plaintext highlighter-rouge">validateCookies</code> middleware returns a Promise that upon rejection will automatically trigger our error handler.</p> <div class="highlight"><pre class="highlight">const express = require('express')
const cookieParser = require('cookie-parser')
const cookieValidator = require('./cookieValidator')

const app = express()

async function validateCookies (req, res, next) {
  await cookieValidator(req.cookies)
  next()
}

app.use(cookieParser())

app.use(validateCookies)

// error handler
app.use((err, req, res, next) =&gt; {
  res.status(400).send(err.message)
})

app.listen(3000)
</pre></div> <div class="doc-box doc-notice"> <p>Note how <code class="language-plaintext highlighter-rouge">next()</code> is called after <code class="language-plaintext highlighter-rouge">await cookieValidator(req.cookies)</code>. This ensures that if <code class="language-plaintext highlighter-rouge">cookieValidator</code> resolves, the next middleware in the stack will get called. If you pass anything to the <code class="language-plaintext highlighter-rouge">next()</code> function (except the string <code class="language-plaintext highlighter-rouge">'route'</code> or <code class="language-plaintext highlighter-rouge">'router'</code>), Express regards the current request as being an error and will skip any remaining non-error handling routing and middleware functions.</p> </div> <p>Because you have access to the request object, the response object, the next middleware function in the stack, and the whole Node.js API, the possibilities with middleware functions are endless.</p> <p>For more information about Express middleware, see: <a href="using-middleware.html">Using Express middleware</a>.</p> <h2>Configurable middleware</h2> <p>If you need your middleware to be configurable, export a function which accepts an options object or other parameters, which, then returns the middleware implementation based on the input parameters.</p> <p>File: <code class="language-plaintext highlighter-rouge">my-middleware.js</code></p> <div class="highlight"><pre class="highlight">module.exports = function (options) {
  return function (req, res, next) {
    // Implement the middleware function based on the options object
    next()
  }
}
</pre></div> <p>The middleware can now be used as shown below.</p> <div class="highlight"><pre class="highlight">const mw = require('./my-middleware.js')

app.use(mw({ option1: '1', option2: '2' }))
</pre></div> <p>Refer to <a href="https://github.com/expressjs/cookie-session">cookie-session</a> and <a href="https://github.com/expressjs/compression">compression</a> for examples of configurable middleware.</p><div class="_attribution">
  <p class="_attribution-p">
    &copy; 2017 StrongLoop, IBM, and other expressjs.com contributors.<br>Licensed under the Creative Commons Attribution-ShareAlike License v3.0.<br>
    <a href="https://expressjs.com/en/guide/writing-middleware.html" class="_attribution-link">https://expressjs.com/en/guide/writing-middleware.html</a>
  </p>
</div>
