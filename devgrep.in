#!/usr/bin/env python3

import json
from pathlib import Path
from subprocess import call, check_output
from sys import argv

root_path = Path("@DEVDOCS_INSTALL_DIR@")
html_path = root_path / "html"

index = sorted([ path.name for path in html_path.iterdir() ])

def find_doc(name):
    if name in index: return name
    for doc in index:
        if doc.startswith(name): return doc
    return None

def grep_all():
    grep_item_all("")

def grep_doc(name):
    doc = find_doc(name)
    if doc:
        grep_item(doc, "")
    else: grep_item_all(name)

def get_items(doc, mark=""):
    doc_path = html_path / doc
    with open(doc_path / "index.json") as fp:
        doc_index = json.load(fp)
    return { (mark + item): (doc_path / path) for item, path in doc_index.items() }

def open_item(find, item):
    try:
        input = "\n".join(find.keys())
        item = check_output(["fzf", "-q", item], input=input, encoding="utf8").rstrip()
        call(["w3m", find[item]])
    except:
        pass

def grep_item_all(item):
    find = { }
    for doc in index:
        find.update(get_items(doc, doc + " â€¢ "))
    open_item(find, item)

def grep_item(name, item):
    doc = find_doc(name)
    if doc:
        find = get_items(doc)
        open_item(find, item)

####################
if len(argv) == 1:
    grep_all()

elif len(argv) == 2:
    _, name = argv
    grep_doc(name)

elif len(argv) == 3:
    _, name, item = argv
    grep_item_all(item) if name == "?" else grep_item(name, item)
