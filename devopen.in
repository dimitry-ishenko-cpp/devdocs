#!/usr/bin/env python3

import json
from pathlib import Path
from subprocess import call, check_output
from sys import argv

root_path = Path("@DEVDOCS_INSTALL_DIR@")
html_path = root_path / "html"

index = sorted([ path.name for path in html_path.iterdir() ])

def find_doc(name):
    if name in index: return name
    for doc in index:
        if doc.startswith(name): return doc
    return None

def open_index_all():
    try:
        input = "\n".join(index)
        doc = check_output(["fzf", "+s"], input=input, encoding="utf8").rstrip()
        open_index(doc)
    except:
        pass

def open_index(name):
    doc = find_doc(name)
    if doc:
        path = html_path / doc / "index.html"
        if path.exists(): call(["w3m", path])
    else: open_item_all(name)

def get_path(doc, item):
    doc_path = html_path / doc
    with open(doc_path / "index.json") as fp:
        doc_index = json.load(fp)
    return doc_path, doc_index.get(item)

def open_item(name, item):
    doc = find_doc(name)
    if doc:
        doc_path, item_path = get_path(doc, item)
        if item_path: call(["w3m", doc_path / item_path])

def open_item_all(item):
    find = { }
    for doc in index:
        doc_path, item_path = get_path(doc, item)
        if item_path: find[f"{doc} â€¢ {item}"] = doc_path / item_path

    if len(find) > 1:
        try:
            input = "\n".join(find.keys())
            item = check_output(["fzf", "+s"], input=input, encoding="utf8").rstrip()
            call(["w3m", find[item]])
        except:
            pass

    elif len(find) == 1:
        call(["w3m", next(iter( find.values() ))])

####################
if len(argv) == 1:
    open_index_all()

elif len(argv) == 2:
    _, name = argv
    open_index(name)

elif len(argv) == 3:
    _, name, item = argv
    open_item_all(item) if name == "?" else open_item(name, item)
