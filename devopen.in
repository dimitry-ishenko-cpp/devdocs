#!/usr/bin/env python3

import json
from pathlib import Path
from subprocess import call, check_output
from sys import argv

root_path = Path("@DEVDOCS_INSTALL_DIR@")
html_path = root_path / "html"

index = sorted([ path.name for path in html_path.iterdir() ])

def open_index_all():
    try:
        input = "\n".join(index)
        doc = check_output(["fzf", "+s"], input=input, encoding="utf8").rstrip()
        open_index(doc)
    except:
        pass

def open_index(doc):
    if doc in index:
        path = html_path / doc / "index.html"
        if path.exists(): call(["w3m", path])

    else: open_item_all(name)

def open_item(doc, item):
    if doc in index:
        doc_path = html_path / doc
        with open(doc_path / "index.json") as fp:
            doc_index = json.load(fp)

        item_path = doc_index.get(item)
        if item_path: call(["w3m", doc_path / item_path])

def open_item_all(item):
    path = None
    find = { }
    for doc in index:
        doc_path = html_path / doc
        with open(doc_path / "index.json") as fp:
            doc_index = json.load(fp)

        item_path = doc_index.get(item)
        if item_path:
            path = doc_path / item_path
            find[f"{doc} â€¢ {item}"] = path

    if len(find) > 1:
        try:
            input = "\n".join(find.keys())
            item = check_output(["fzf", "+s"], input=input, encoding="utf8").rstrip()
            path = find[item]
        except:
            return

    if path: call(["w3m", path])

####################
if len(argv) == 1:
    open_index_all()

elif len(argv) == 2:
    _, doc = argv
    open_index(doc)

elif len(argv) == 3:
    _, doc, item = argv
    open_item_all(item) if doc == "?" else open_item(doc, item)
